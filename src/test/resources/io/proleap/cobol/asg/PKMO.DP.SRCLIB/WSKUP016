000100 IDENTIFICATION DIVISION.                                         00020001
000200 PROGRAM-ID.         WSKUP016.                                    00030001
000300 AUTHOR.             PATRICK BURKE.                               00040001
000400 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00050001
000500 DATE-WRITTEN.       APRIL 2007.                                  00060001
000600                                                                  00070001
000700****************************************************************  00080001
000800* This program will format a message in XML and put a stop        00100001
000900*  message on the queue.                                          00110001
000910*                                                                         
000920* 2011-01-18 Christine Twiehaus WR38972                                   
000930*            Change select to a cursor and order by                       
000940*            que_nm descending. Use 1st fetch.                            
000950*                                                                         
001000****************************************************************  00120001
001100 ENVIRONMENT DIVISION.                                            00130001
001200******************************************************************00140001
001300 CONFIGURATION SECTION.                                           00150001
001400 SOURCE-COMPUTER.        IBM-3090.                                00160001
001500 OBJECT-COMPUTER.        IBM-3090.                                00170001
001600                                                                  00180001
001700 INPUT-OUTPUT SECTION.                                            00190001
001800 FILE-CONTROL.                                                    00200001
001900     SELECT CONTROL-CARD-1                                        00210002
002000            ASSIGN TO INP01.                                      00220002
002100                                                                  00230001
002200     SELECT CONTROL-CARD-2                                        00210002
002300            ASSIGN TO INP02.                                      00220002
002400                                                                  00230001
002500     SELECT ERROR-REPORTING-FILE                                  00240001
002600         ASSIGN TO OUT04.                                         00250001
002700                                                                  00260001
002800                                                                  00270001
002900****************************************************************  00280001
003000 DATA DIVISION.                                                   00290001
003100****************************************************************  00300001
003200 FILE SECTION.                                                    00310001
003300                                                                  00320001
003400 FD  CONTROL-CARD-1                                               00330002
003500     RECORDING MODE F                                             00340002
003600     BLOCK CONTAINS 0 RECORDS                                     00350002
003700     LABEL RECORDS ARE OMITTED                                    00360002
003800     DATA RECORD IS CONTROL-CARD-1-RECORD.                        00370002
003900 01  CONTROL-CARD-1-RECORD           PIC X(080).                  00380002
004000                                                                  00390001
004100 FD  CONTROL-CARD-2                                               00330002
004200     RECORDING MODE F                                             00340002
004300     BLOCK CONTAINS 0 RECORDS                                     00350002
004400     LABEL RECORDS ARE OMITTED                                    00360002
004500     DATA RECORD IS CONTROL-CARD-2-RECORD.                        00370002
004600 01  CONTROL-CARD-2-RECORD           PIC X(080).                  00380002
004700                                                                  00400001
004800 FD  ERROR-REPORTING-FILE                                         00410001
004900     RECORDING MODE IS F                                          00420001
005000     LABEL RECORDS ARE STANDARD                                   00430001
005100     BLOCK CONTAINS 0 RECORDS.                                    00440001
005200 01  ERROR-REPORTING-REC               PIC X(80).                 00450001
005300                                                                  00460001
005400 WORKING-STORAGE SECTION.                                         00470001
005500                                                                  00480001
005600 01  PS-PROGRAM-SWITCHES.                                         00490001
005700     05  PS-MQPUT-SUCCESSFUL-IND     PIC X(01) VALUE SPACES.      00500001
005800         88  PS-MQPUT-SUCCESSFUL               VALUE 'Y'.         00510001
005900 01  PA-PROGRAM-ACCUMULATORS.                                     00520001
006000     05  PA-CNTL-READ                PIC S9(9) VALUE +0 COMP-3.   00530001
006100     05  PA-XFER-READ                PIC S9(9) VALUE +0 COMP-3.   00540001
006200     05  PA-TOTAL-MQ-MSGS-SENT       PIC S9(9) VALUE +0 COMP-3.   00550001
006300                                                                  00560001
006400 01  PV-PROGRAM-VARIABLES.                                        00570001
006500     05  N                           PIC 9(05) VALUE ZEROES.      00580001
006600     05  PV-ITEM-CNT                 PIC 99     VALUE 10.         00590001
006700     05  PC-MQPUT-RETRY-COUNTER      PIC 9(3)  VALUE ZERO.        00600001
006800     05  PV-RETRY-COUNTER            PIC S9(4) VALUE +0 COMP SYNC.00610001
006900     05  PV-PARAGRAPH                PIC X(48) VALUE SPACES.      00620001
007000     05  PV-MSG-LENGTH               PIC S9(9) BINARY.            00630001
007100     05  PV-MSG-LENGTH-DISPLAY       PIC S9(9).                   00640001
007200     05  PV-HOLD-COMPLETION-CODE     PIC S9(9) BINARY.            00650001
007300     05  PV-HOLD-REASON              PIC S9(9) BINARY.            00660001
007400     05  PV-HOLD-PROCESS-TYPE        PIC X(16) VALUE SPACES.      00670001
007500     05  PV-SAVE-PROCESS-TYPE        PIC X(16).                   00680001
007600     05  PV-HOLD-GROUP-PROCESS-ID    PIC 9(18) VALUE ZEROES.      00690001
007700     05  PV-CURR-GROUP-PROCESS-ID    PIC 9(18) VALUE ZEROES.      00700001
007800     05  PV-INTGRTN-TYP-CDE          PIC X(10) VALUE SPACES.      00701002
007900                                                                  00710001
008000******************************************************************00711002
008100**CONTROL CARD 1 RECORD LAYOUT                                    00712002
008200******************************************************************00713002
008300 01  CC-CONTROL-CARD-1-LAYOUT.                                    00714002
008400     05  CC-QUEUE-NAME              PIC X(48)   VALUE SPACES.     00715002
008500     05  FILLER                     PIC X(32)   VALUE SPACES.     00716002
008600 01  CC-CONTROL-CARD-2-LAYOUT.                                    00714002
008700     05  CC-DEBUG-SWITCH            PIC X(03)   VALUE SPACES.     00715002
008800     05  FILLER                     PIC X(77)   VALUE SPACES.     00716002
008900******************************************************************00716202
009000** CURRENT TIME INFORMATION                                       00716302
009100******************************************************************00716402
009200 01  PV-CURRENT-TMST                PIC X(26)  VALUE SPACES.      00716502
009300 01  FILLER REDEFINES                                             00716602
009400     PV-CURRENT-TMST.                                             00716702
009500     05  PV-TMST-CCYY-MM-DD         PIC X(10).                    00716802
009600     05  FILLER                     PIC X(01).                    00716902
009700     05  PV-TMST-HH-MM-SS           PIC 9(08).                    00717002
009800     05  FILLER                     PIC X(01).                    00717102
009900     05  PV-TMST-LAST6              PIC 9(06).                    00717202
010000                                                                  00717302
010100******************************************************************00717402
010200                                                                  00718002
010300 01  PV-ABEND-VARIABLES.                                          00720001
010400     05  PV-SQLCODE                  PIC S9(9).                   00730001
010500     05  PV-DISPLAY-SQLCODE          PIC -------999.              00740001
010600     05  PV-ABEND-PROGRAM            PIC X(08) VALUE 'WSKUP004'.  00750001
010700     05  PV-ABEND-PARAGRAPH          PIC X(25) VALUE SPACES.      00760001
010800     05  PV-ABEND-OPERATION          PIC X(20) VALUE SPACES.      00770001
010900     05  PV-ABEND-STRUCTURE-1        PIC X(08) VALUE SPACES.      00780001
011000     05  PV-DB2-OPERATION-MESSAGE-1  PIC X(79) VALUE SPACES.      00790001
011100     05  PV-ABEND-CODE               PIC S9(4) VALUE +0 COMP SYNC.00800001
011200 01  PV-HOLD-MSGBUFFER.                                           00810001
011300     05  PV-MSGBUFFER-CHAR OCCURS 999999 TIMES                    00820001
011400                                     PIC X(01).                   00830001
011500                                                                  00840001
011600 01  PV-MSG.                                                      00850001
011700     05  PV-MQC-CONTROL-RECORD.                                   00860001
011800         10  PV-MQC-PROCESS-TYPE     PIC X(10) VALUE SPACES.      00870001
011900         10  PV-MQC-GROUP-ID-X       PIC X(06) VALUE SPACES.      00880001
012000         10  PV-MQC-GROUP-ID     REDEFINES                        00890001
012100             PV-MQC-GROUP-ID-X       PIC 9(06).                   00900001
012200         10  PV-MQC-STR-NBR-X        PIC X(04) VALUE SPACES.      00910001
012300         10  PV-MQC-STR-NBR      REDEFINES                        00920001
012400             PV-MQC-STR-NBR-X        PIC 9(04).                   00930001
012500     05  PV-DTL                      PIC X(10) VALUE SPACES.      00940001
012600******************************************************************00950001
012700 01  PE-MQ-ABEND-VARIABLES.                                       00960001
012800     05  PE-MQ-QMANAGER              PIC X(05) VALUE SPACES.      00970001
012900     05  PE-MQ-QMANAGER-REMOTE       PIC X(30) VALUE SPACES.      00980001
013000     05  PE-MQ-QNAME                 PIC X(48) VALUE SPACES.      00990001
013100     05  PE-MQ-COMPLETION-CODE       PIC 9(04) VALUE ZEROES.      01000001
013200     05  PE-MQ-REASON-CODE           PIC 9(04) VALUE ZEROES.      01010001
013300                                                                  01020001
013400******************************************************************01030001
013500 01  PV-XML-FIELDS.                                               01040001
013600     05  PV-XML-BANNER               PIC X(39) VALUE              01050001
013700*        '<?xml version="1.0" encoding="UTF-8" ?>'.               01060001
013800         '<?xml version="1.0"                  ?>'.               01070001
013900                                                                  01080001
014000                                                                  01090001
014100******************************************************************01100001
014200* PIX Layout                                                      01110001
014300******************************************************************01120001
014400*PIX                                                              01130001
014500     COPY WSRD028.                                                01140001
014600*PIX                                                              01150001
014700*    COPY WSRD032.                                                01160001
014800                                                                  01170001
014900***************************************************************   01180001
015000* The field names specified will be used as the tag names in      01190001
015100* the generated XML and the case will be used.                    01200001
015200*                                                                 01210001
015300* Note that redefines and FILLER are ignored in generating        01220001
015400* the XML.                                                        01230001
015500***************************************************************   01240001
015600*                                                                 01250001
015700**** This is how big the incoming XML field can be.  Try to choose01260001
015800**** a more realistic size to prevent allocating too much memory. 01270001
015900*01  PV-XML                      PIC X(16777215) VALUE SPACES.    01280001
016000 01  PV-XML                      PIC X(50000)    VALUE SPACES.    01290001
016100 01  PV-BEFORE                   PIC X(99999).                    01300001
016200 01  PV-AFTER                    PIC X(99999).                    01310001
016300 01  PV-BEFORE-CNT               PIC 9(09)       VALUE ZERO.      01320001
016400 01  PV-AFTER-CNT                PIC 9(09)       VALUE ZERO.      01330001
016500                                                                  01340001
016600 01  PV-DESC                     PIC X(132)      VALUE SPACES.    01350001
016700 01  PV-DISPLAY                  PIC X(132)      VALUE SPACES.    01360001
016800                                                                  01370001
016900 01  IN-XML                      PIC X(80)       VALUE SPACES.    01380001
017000 01  IN-EOF-SW                   PIC X           VALUE 'N'.       01390001
017100     88  IN-EOF                                  VALUE 'Y'.       01400001
017101                                                                  01410001
017110* CLT 2011-01-18 WR38972 start                                            
017111 01 PS-SWITCHES.                                                          
017120     05  PS-END-OF-MQCUR-SW              PIC X(01) VALUE 'N'.             
017130         88  PS-END-OF-MQCUR-YES                   VALUE 'Y'.             
017140         88  PS-END-OF-MQCUR-NO                    VALUE 'N'.             
017150* CLT 2011-01-18 WR38972 END                                              
017200                                                                  01410001
017300 01  XML-LENGTH                  PIC 9(7)    COMP.                01420001
017400                                                                  01430001
017500 01  ABEND-CODE                  PIC S9(04)  VALUE +0             01440001
017600                                             COMP SYNC.           01450001
017700                                                                  01460001
017800     COPY ISWS007.                                                01470001
017900     COPY ISWS008.                                                01480001
018000     COPY ISWS009.                                                01490001
018100                                                                  01500001
018200******************************************************************01510001
018300*  DB2 FORMATTED MESSAGE AREA                                     01520001
018400******************************************************************01530001
018500     COPY DPWS004.                                                01540001
018600                                                                  01550001
018700******************************************************************01560001
018800*  COMMUNICATIONS AREA FOR DB2                                    01570001
018900******************************************************************01580001
019000     EXEC SQL                                                     01590001
019100          INCLUDE SQLCA                                           01600001
019200     END-EXEC.                                                    01610001
019300                                                                  01620001
019400******************************************************************01630001
019500*  DB2 DECLARATION - WMOS - PROVIDER QUEUE INFORMATION (PUT/WRITE)01640001
019600*      TABLE (WSV_PRVDR_QUE)                                      01650001
019700******************************************************************01660001
019800     EXEC SQL                                                     01670001
019900         INCLUDE WSV00005                                         01680001
020000     END-EXEC.                                                    01690001
020100                                                                  01700001
020200                                                                  01710001
020300****************************************************************  01720001
020400**                                                            **  01730001
020500**     M Q   S E R I E S    W O R K I N G   S T O R A G E     **  01740001
020600**                                                            **  01750001
020700**                  M  Q    C O P Y B O O K S                 **  01760001
020800**                                                            **  01770001
020900****************************************************************  01780001
021000 01  MQM-OBJECT-DESCRIPTOR.                                       01790001
021100     COPY CMQODV.                                                 01800001
021200                                                                  01810001
021300 01  MQM-MESSAGE-DESCRIPTOR.                                      01820001
021400     COPY CMQMDV.                                                 01830001
021500                                                                  01840001
021600 01  MQM-PUT-MESSAGE-OPTIONS.                                     01850001
021700     COPY CMQPMOV.                                                01860001
021800                                                                  01870001
021900 01  MQM-GET-MESSAGE-OPTIONS.                                     01880001
022000     COPY CMQGMOV.                                                01890001
022100                                                                  01900001
022200 01  MQM-CONSTANTS.                                               01910001
022300     COPY CMQV.                                                   01920001
022400                                                                  01930001
022500****************************************************************  01940001
022600** CONTROL CARDS FOR QUEUE MANAGER AND QUEUE NAME                 01950001
022700****************************************************************  01960001
022800 01  CC-CONTROL-CARD-1.                                           01970001
022900     05  CC-QMGR-NAME-REMOTE         PIC X(50).                   01980001
023000                                                                  01990001
023100 01  CC-CONTROL-CARD-2.                                           02000001
023200     05  CC-TRANS-QUEUE-NAME         PIC X(50).                   02010001
023300                                                                  02020001
023400 01  CC-CONTROL-CARD-3.                                           02030001
023500     05  CC-DC-NBR                   PIC S9(9) COMP.              02040001
023600                                                                  02050001
023700 01  CC-CONTROL-CARD-4.                                           02060001
023800     05  CC-QMGR-NAME                PIC X(50).                   02070001
023900                                                                  02080001
024000****************************************************************  02090001
024100** MQ SERIES CONSTANTS FOR CALLING MODULES SUCH AS GET AND    **  02100001
024200*  OPEN, CONNECT, DISCONNECT.                                     02110001
024300****************************************************************  02120001
024400 01  MQ-WORKING-STORAGE.                                          02130001
024500     05  PC-CURRENT-PROGRAM-NAME     PIC X(08) VALUE 'WSKUP016'.  02140001
024600     05  PC-MQCONN                   PIC X(08) VALUE 'CSQBCONN'.  02150001
024700     05  PC-MQOPEN                   PIC X(08) VALUE 'CSQBOPEN'.  02160001
024800     05  PC-MQINQ                    PIC X(08) VALUE 'CSQBINQ'.   02170001
024900     05  PC-MQPUT                    PIC X(08) VALUE 'CSQBPUT'.   02180001
025000     05  PC-MQGET                    PIC X(08) VALUE 'CSQBGET'.   02190001
025100     05  PC-MQCMIT                   PIC X(08) VALUE 'CSQBCOMM'.  02200001
025200     05  PC-MQBACK                   PIC X(08) VALUE 'CSQBBACK'.  02210001
025300     05  PC-MQCLOSE                  PIC X(08) VALUE 'CSQBCLOS'.  02220001
025400     05  PC-MQDISC                   PIC X(08) VALUE 'CSQBDISC'.  02230001
025500     05  PC-QMGR-NAME                PIC X(04) VALUE SPACES.      02240001
025600         88  PC-PROD-QMGR-NAME                 VALUE 'QKSP'.      02250001
025700         88  PC-ACCEPT-QMGR-NAME               VALUE 'QKSQ'.      02260001
025800         88  PC-TEST-QMGR-NAME                 VALUE 'QKST'.      02270001
025900     05  PC-TRANS-QNAME              PIC X(48) VALUE SPACES.      02280001
026000     05  PC-DELAY-INTERVAL.                                       02290001
026100         10  FILLER                  PIC X(2)  VALUE SPACES.      02300001
026200         10  PC-DELAY-TIME           PIC 9(8)  VALUE 3000.        02310001
026300                                                                  02320001
026400****************************************************************  02330001
026500** QUEUE MANAGER HANDLE                                           02340001
026600*  QUEUE HANDLE                                                   02350001
026700****************************************************************  02360001
026800 01 PV-MQ-PROGRAM-HANDLES.                                        02370001
026900     05  PV-QM-NAME                  PIC X(48).                   02380001
027000     05  PV-QM-NAME-REMOTE           PIC X(48).                   02390001
027100     05  PV-HCONN                    PIC S9(9) BINARY VALUE 0.    02400001
027200     05  PV-PQ-HANDLE                PIC S9(9) BINARY VALUE 0.    02410001
027300                                                                  02420001
027400****************************************************************  02430001
027500* ERROR PROCESSING VARIABLES                                      02440001
027600* CODES FROM CALLS ARE STORED HERE                                02450001
027700****************************************************************  02460001
027800 01 PV-MQ-PROGRAM-VARIABLES.                                      02470001
027900     05  PV-COMPLETION-CODE          PIC S9(9) BINARY.            02480001
028000     05  PV-REASON                   PIC S9(9) BINARY.            02490001
028100     05  PV-CON-REASON               PIC S9(9) BINARY.            02500001
028200     05  PV-MQCHECK                  PIC X(08) VALUE 'MQR2C'.     02510001
028300     05  PV-ERROR-MESSAGE            PIC X(48) VALUE SPACES.      02520001
028400     05  PV-OPEN-OPTIONS             PIC S9(9) BINARY.            02530001
028500     05  PV-MQ-REASON-TEXT           PIC X(30) VALUE SPACES.      02540001
028600*    05  PV-MSGBUFFER                PIC X(999999) VALUE SPACES.  02550001
028700     05  PV-MSGBUFFER.                                            02560001
028800         10  PV-MSGBUFFER-banner     PIC X(39) VALUE SPACES.      02570001
028900         10  PV-MSGBUFFER-data       PIC X(999999) VALUE SPACES.  02580001
029000                                                                  02590001
029100****************************************************************  02600001
029200* RETURN CODES ARE EVALUATED AND THIS SWITCH IS USED TO           02610001
029300* INDICATE ANY ERRORS (FROM WHAT I'VE SEEN THIS SWITCH IS         02620001
029400* USELESS SINCE THE PROGRAM ABENDS BEFORE IT IS USED ANYWHERE) *  02630001
029500****************************************************************  02640001
029600 01 PV-MQ-PROGRAM-SWITCHES.                                       02650001
029700     05  PS-MQ-ERROR-SW              PIC X(01) VALUE 'N'.         02660001
029800         88  PS-NO-MQ-ERROR                    VALUE 'N'.         02670001
029900         88  PS-MQ-ERROR                       VALUE 'Y'.         02680001
029901                                                                          
029998* CLT 2011-01-18 WR38972 start                                            
029998*     There are two cubiscan queues and we want                           
029998*     to use WS.OUTBOUND.WMOS.CUBISCN.                                    
029998*     That is why ORDER BY QUE_NM  DESC   and                             
029998*     only one fetch                                                      
029998* CLT 2011-03-12                                                          
029998*     Replace hardcoding with PV-INTGRTN-TYP-CDE                          
029920************************************************                          
029930*  DB2  MQCUR CURSOR                                                      
029940************************************************                          
029950                                                                          
029960     EXEC SQL                                                             
029970          DECLARE MQCUR  CURSOR FOR                                       
029980          SELECT LCL_QUE_MGR                                              
029990                ,QUE_NM                                                   
029991            FROM WSV_PRVDR_QUE                                            
029992           WHERE APPL_FUNC_DESC  = 'PIXQUEUE'                             
029993             AND INTGRTN_TYP_CDE = :PV-INTGRTN-TYP-CDE                    
029994          ORDER BY QUE_NM  DESC                                           
029995          WITH UR                                                         
029996     END-EXEC.                                                            
029997                                                                          
029998* CLT 2011-01-18 WR38972 end                                              
030000****************************************************************  02690001
030100**                     E N D   O F   M Q                      **  02700001
030200****************************************************************  02710001
030300                                                                  02720001
030400 PROCEDURE DIVISION.                                              02730001
030500                                                                  02740001
030600 0000-MAINLINE.                                                   02750001
030800                                                                  02770001
030900     PERFORM 1000-INITIALIZE.                                     02780001
031000     PERFORM 3030-FILL-PIX-INFO.                                  02790001
031100     PERFORM 4030-GENERATE-XML-PIX.                               02800001
031200     PERFORM 5200-CREATE-MSGS.                                    02810001
031300                                                                  02820001
031400*CLOSE THE TRANSACTION QUEUE.                                     02830001
031500     PERFORM 1500-MQ-QUEUE-CLOSE.                                 02840001
031600                                                                  02850001
031700*DISCONNECT FROM THE QMGR.                                        02860001
031800     PERFORM 1600-DISCONNECT-QMGR.                                02870001
031900                                                                  02880001
032000     GOBACK.                                                      02890001
032100******************************************************************02900001
032200*                                                                *02910001
032300*           1 0 0 0 - I N I T I A L I Z A T I O N                *02920001
032400*                                                                *02930001
032500******************************************************************02940001
032600 1000-INITIALIZE.                                                 02950001
032700                                                                  02960001
032800     EXEC SQL                                                     02960102
032900          SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                02960202
033000     END-EXEC                                                     02960302
033100                                                                  02960402
033200     OPEN INPUT CONTROL-CARD-2.                                   02961002
033300     READ CONTROL-CARD-2 INTO CC-CONTROL-CARD-2-LAYOUT.           07876002
033400     IF  CC-DEBUG-SWITCH  =  SPACES                               02961202
033500         MOVE 'N  '            TO CC-DEBUG-SWITCH                 02961402
033600     END-IF.                                                      02962002
033700                                                                  02963002
033800     OPEN INPUT  CONTROL-CARD-1.                                  02961002
033900     PERFORM 8500-READ-CONTROL-CARD-1.                            02961102
034000     IF  CC-QUEUE-NAME    =  SPACES                               02961202
034100         DISPLAY 'EMPTY CONTROL CARD'                             02961402
034200         DISPLAY 'QUEUE NAME    ' CC-QUEUE-NAME                   02961503
034300         PERFORM 9200-MQ-ABEND                                    02961702
034400     ELSE                                                         02961802
034500         MOVE CC-QUEUE-NAME TO PV-INTGRTN-TYP-CDE                 02961902
034600     END-IF.                                                      02962002
034700                                                                  02963002
034800*READ MQ CONTROL CARDS.                                           02970001
034900     PERFORM 1200-GET-MQ-QUEUE-INFO.                              02980001
035000                                                                  02990001
035100*CONNECT TO QUEUE MANAGER                                         03000001
035200     PERFORM 1300-MQ-CONNECT-TO-QMGR.                             03010001
035300                                                                  03020001
035400*OPEN THE QUEUE FOR PUTS                                          03030001
035500     PERFORM 1400-MQ-QUEUE-OPEN.                                  03040001
035600                                                                  03050001
035700****************************************************************  03060001
035800* GET MQ INFORMATION FROM DB2 TABLES.                             03070001
035900****************************************************************  03080001
036000 1200-GET-MQ-QUEUE-INFO.                                          03090001
036100* PIXCUBISCN -  cubiscan queue                                    03100001
036200* PIXFASHION -  fashion sales queue                               03110001
036500* PIXTRLRUPD -  rc/su queue                                       03140001
036600                                                                  03150001
036700* CLT 2011-01-18 WR38972 start                                    03160001
036800                                                                  03170001
036900     PERFORM 1110-OPEN-MQCUR.                                     03180001
037000     PERFORM 1120-FETCH-MQCUR.                                    03190001
037100     PERFORM 1130-CLOSE-MQCUR.                                    03200001
037200                                                                  03210001
037300 1110-OPEN-MQCUR.                                                 03220001
037400     EXEC SQL                                                     03230001
037500         OPEN MQCUR                                               03240001
037600     END-EXEC.                                                    03250002
037700                                                                  03260001
037800     EVALUATE TRUE                                                03270001
037810         WHEN SQLCODE = ZERO                                      03270001
037820            CONTINUE                                              03270001
037830         WHEN OTHER                                               03270001
037840            MOVE '1110-OPEN-MQCUR'        TO PV-ABEND-PARAGRAPH   03270001
037850            MOVE SQLCODE                  TO PV-ABEND-OPERATION   03270001
037860            PERFORM 9900-DB2-ABEND                                03270001
037870     END-EVALUATE.                                                03270001
037880                                                                  03270001
037890 1120-FETCH-MQCUR.                                                03270001
037891     EXEC SQL                                                     03270001
037892         FETCH MQCUR                                              03270001
037893          INTO :CC-QMGR-NAME                                      03270001
037894              ,:CC-TRANS-QUEUE-NAME                               03270001
037895     END-EXEC.                                                    03270001
037896                                                                  03270001
037897* CLT 2011-01-18 WR38972 end                                      03270001
037901                                                                  03270001
037910     EVALUATE TRUE                                                03280001
038000       WHEN SQLCODE = ZERO                                        03290001
038100           DISPLAY 'CC2 (QUEUE NAME)    : ' CC-TRANS-QUEUE-NAME   03300001
038200           DISPLAY 'CC4 (QUEUE MANAGER) : ' CC-QMGR-NAME          03310001
038300                                                                  03320001
038400       WHEN OTHER                                                 03330001
038500           MOVE '1200-GET-MQ-QUEUE-INFO' TO PV-ABEND-PARAGRAPH    03340001
038600           MOVE 'SELECT WST 8/9/10'      TO PV-ABEND-OPERATION    03350001
038700           PERFORM 9900-DB2-ABEND                                 03360001
038800     END-EVALUATE.                                                03370001
038801                                                                          
038810* CLT 2011-01-18 WR38972 start                                            
038820 1130-CLOSE-MQCUR.                                                        
038830                                                                          
038840     EXEC SQL                                                             
038850         CLOSE MQCUR                                                      
038860     END-EXEC.                                                            
038870                                                                          
038880     EVALUATE TRUE                                                        
038890         WHEN SQLCODE = ZERO                                              
038891            CONTINUE                                                      
038892         WHEN OTHER                                                       
038893            MOVE '1130-CLOSE-MQCUR' TO PV-ABEND-PARAGRAPH                 
038894            DISPLAY SQLCODE ' SQLCODE'                                    
038895            PERFORM 9900-DB2-ABEND                                        
038896     END-EVALUATE.                                                        
038897                                                                          
038898* CLT 2011-01-18 WR38972 end                                              
038900                                                                  03380001
039000****************************************************************  03390001
039100** CONNECT TO THE QUEUE MANAGER                                   03400001
039200** GET THE HANDLE TO THE QUEUE MANAGER - PV-HCONN                 03410001
039300****************************************************************  03420001
039400 1300-MQ-CONNECT-TO-QMGR.                                         03430001
039500     MOVE '1300-MQ-CONNECT-TO-QMGR' TO PV-PARAGRAPH.              03440001
039600                                                                  03450001
039700* CONNECT TO THE QUEUE                                            03460001
039800* CONTROL CARD 1 - QMGR NAME                                      03470001
039900     MOVE CC-QMGR-NAME TO PC-QMGR-NAME                            03480001
040000     MOVE PC-QMGR-NAME TO PV-QM-NAME.                             03490001
040100                                                                  03500001
040200     CALL PC-MQCONN USING PV-QM-NAME                              03510001
040300                          PV-HCONN                                03520001
040400                          PV-COMPLETION-CODE                      03530001
040500                          PV-REASON.                              03540001
040600                                                                  03550001
040700*    IF CONNECTION FAILED, DISPLAY ERROR MESSAGE AND EXIT         03560001
040800     MOVE PV-REASON TO PV-CON-REASON.                             03570001
040900     IF PV-COMPLETION-CODE = MQCC-OK                              03580001
041000         CONTINUE                                                 03590001
041100     ELSE                                                         03600001
041200         CALL PV-MQCHECK USING PV-REASON                          03610001
041300                               PV-MQ-REASON-TEXT                  03620001
041400         MOVE PV-QM-NAME           TO PE-MQ-QMANAGER              03630001
041500         MOVE PV-COMPLETION-CODE   TO PE-MQ-COMPLETION-CODE       03640001
041600         MOVE PV-REASON            TO PE-MQ-REASON-CODE           03650001
041700         MOVE '1300-MQ-CONNECT-TO-QMGR'                           03660001
041800                                   TO PV-ERROR-MESSAGE            03670001
041900         PERFORM 9200-MQ-ABEND                                    03680001
042000     END-IF.                                                      03690001
042100                                                                  03700001
042200****************************************************************  03710001
042300** OPEN THE QUEUE FOR 'PUT'                                       03720001
042400*  NOTE !!! IF YOU WANT TO WRITE TO A LOCAL QUEUE FOR TESTING     03730001
042500*  PURPOSES, YOU MUST MOVE THE NAME OF THE LOCAL QUEUE QMGR TO    03740001
042600*  MQOD-OBJECTQMGRNAME IN THIS OPEN CALL (INSTEAD OF MOVING THE   03750001
042700*  NAME OF THE UNIX BOX). THIS SINGLE CHANGE IS THE DIFFERENCE    03760001
042800*  BETWEEN WRITING TO THE LOCAL QUEUE AS OPPOSED TO WRITING OUT   03770001
042900*  TO THE REMOTE QUEUE (REMOTE QUEUE HAS A DIFFERENT QMGR).       03780001
043000****************************************************************  03790001
043100 1400-MQ-QUEUE-OPEN.                                              03800001
043200     MOVE '1400-MQ-QUEUE-OPEN' TO PV-PARAGRAPH.                   03810001
043300                                                                  03820001
043400* CONTROL CARD 2 - QUEUE NAME                                     03830001
043500     MOVE CC-TRANS-QUEUE-NAME  TO PC-TRANS-QNAME.                 03840001
043600     COMPUTE PV-OPEN-OPTIONS = MQOO-OUTPUT                        03850001
043700                             + MQOO-SET-IDENTITY-CONTEXT          03860001
043800                             + MQOO-FAIL-IF-QUIESCING.            03870001
043900     MOVE PC-TRANS-QNAME       TO MQOD-OBJECTNAME.                03880001
044000                                                                  03890001
044100* CONTROL CARD 3 - REMOTE QMGR NAME                               03900001
044200*                                                                 03910001
044300*THIS IS THE NAME OF THE UNIX BOX (TO WRITE TO REMOTE QUEUE)      03920001
044400*LEAVE BOTH LINES UNCOMMENTED TO WRITE TO REMOTE QUEUE.           03930001
044500*COMMENT OUT THE LINE BELOW (PV-QM-NAME).                         03940001
044600*    MOVE CC-QMGR-NAME-REMOTE  TO PV-QM-NAME-REMOTE.              03950001
044700*    MOVE PV-QM-NAME-REMOTE    TO MQOD-OBJECTQMGRNAME.            03960001
044800                                                                  03970001
044900******************************************************************03980001
045000*REPLACE REMOTE QMGR NAME WITH LOCAL QMGR NAME TO WRITE TO LOCAL Q03990001
045100******************************************************************04000001
045200*TO WRITE TO A LOCAL QUEUE, UNCOMMENT THE LINE BELOW,             04010001
045300*AND COMMENT OUT THE ABOVE TWO LINES.                             04020001
045400     MOVE PV-QM-NAME           TO MQOD-OBJECTQMGRNAME.            04030001
045500                                                                  04040001
045600     CALL PC-MQOPEN USING PV-HCONN                                04050001
045700                          MQM-OBJECT-DESCRIPTOR                   04060001
045800                          PV-OPEN-OPTIONS                         04070001
045900                          PV-PQ-HANDLE                            04080001
046000                          PV-COMPLETION-CODE                      04090001
046100                          PV-REASON.                              04100001
046200                                                                  04110001
046300     IF PV-COMPLETION-CODE = MQCC-OK THEN                         04120001
046400         CONTINUE                                                 04130001
046500     ELSE                                                         04140001
046600         CALL PV-MQCHECK USING PV-REASON                          04150001
046700                               PV-MQ-REASON-TEXT                  04160001
046800         MOVE PV-QM-NAME-REMOTE    TO PE-MQ-QMANAGER-REMOTE       04170001
046900         MOVE PC-TRANS-QNAME       TO PE-MQ-QNAME                 04180001
047000         MOVE PV-COMPLETION-CODE   TO PE-MQ-COMPLETION-CODE       04190001
047100         MOVE PV-REASON            TO PE-MQ-REASON-CODE           04200001
047200         MOVE '1400-MQ-QUEUE-OPEN' TO PV-ERROR-MESSAGE            04210001
047300         PERFORM 9200-MQ-ABEND                                    04220001
047400     END-IF.                                                      04230001
047500                                                                  04240001
047600****************************************************************  04250001
047700** CLOSES THE MQ QUEUE.                                           04260001
047800****************************************************************  04270001
047900 1500-MQ-QUEUE-CLOSE.                                             04280001
048000     MOVE '1500-MQ-QUEUE-CLOSE' TO PV-PARAGRAPH.                  04290001
048100                                                                  04300001
048200     CALL PC-MQCLOSE USING PV-HCONN                               04310001
048300                           PV-PQ-HANDLE                           04320001
048400                           MQCO-NONE                              04330001
048500                           PV-COMPLETION-CODE                     04340001
048600                           PV-REASON.                             04350001
048700                                                                  04360001
048800     IF PV-COMPLETION-CODE = MQCC-OK                              04370001
048900         CONTINUE                                                 04380001
049000     ELSE                                                         04390001
049100         CALL PV-MQCHECK USING PV-REASON                          04400001
049200                               PV-MQ-REASON-TEXT                  04410001
049300         MOVE PV-QM-NAME           TO PE-MQ-QMANAGER              04420001
049400         MOVE PC-TRANS-QNAME       TO PE-MQ-QNAME                 04430001
049500         MOVE PV-COMPLETION-CODE   TO PE-MQ-COMPLETION-CODE       04440001
049600         MOVE PV-REASON            TO PE-MQ-REASON-CODE           04450001
049700         MOVE 'PE-MQ-CLOSE'        TO PV-ERROR-MESSAGE            04460001
049800         PERFORM 9200-MQ-ABEND                                    04470001
049900     END-IF.                                                      04480001
050000                                                                  04490001
050100****************************************************************  04500001
050200** DISCONNECT FROM THE QUEUE MANAGER                              04510001
050300****************************************************************  04520001
050400 1600-DISCONNECT-QMGR.                                            04530001
050500     MOVE '1600-DISCONNECT-QMGR' TO PV-PARAGRAPH.                 04540001
050600                                                                  04550001
050700     CALL PC-MQDISC USING PV-HCONN                                04560001
050800                          PV-COMPLETION-CODE                      04570001
050900                          PV-REASON                               04580001
051000                                                                  04590001
051100     IF PV-COMPLETION-CODE = MQCC-OK                              04600001
051200        CONTINUE                                                  04610001
051300     ELSE                                                         04620001
051400        CALL PV-MQCHECK USING PV-REASON                           04630001
051500                              PV-MQ-REASON-TEXT                   04640001
051600        MOVE PV-QM-NAME             TO PE-MQ-QMANAGER             04650001
051700        MOVE PC-TRANS-QNAME         TO PE-MQ-QNAME                04660001
051800        MOVE PV-COMPLETION-CODE     TO PE-MQ-COMPLETION-CODE      04670001
051900        MOVE PV-REASON              TO PE-MQ-REASON-CODE          04680001
052000        MOVE '1600-DISCONNECT-QMGR' TO PV-ERROR-MESSAGE           04690001
052100        PERFORM 9200-MQ-ABEND                                     04700001
052200     END-IF.                                                      04710001
052300                                                                  04720001
052400******************************************************************04730001
052500*  COMMIT MQ PROCESSING SINCE THE POINT OF THE LAST COMMIT        04740001
052600******************************************************************04750001
052700 2300-MQ-COMMIT.                                                  04760001
052800                                                                  04770001
052900     CALL PC-MQCMIT USING PV-HCONN                                04780001
053000                          PV-COMPLETION-CODE                      04790001
053100                          PV-REASON.                              04800001
053200                                                                  04810001
053300     IF (PV-COMPLETION-CODE NOT = MQCC-OK)                        04820001
053400        CALL PV-MQCHECK USING PV-REASON                           04830001
053500                              PV-MQ-REASON-TEXT                   04840001
053600        MOVE '2300-COMMIT-MQ'   TO PV-PARAGRAPH                   04850001
053700        MOVE 'MQCMIT ERROR'     TO PV-ERROR-MESSAGE               04860001
053800        MOVE PV-COMPLETION-CODE TO PV-HOLD-COMPLETION-CODE        04870001
053900                                   PE-MQ-COMPLETION-CODE          04880001
054000        MOVE PV-REASON          TO PV-HOLD-REASON                 04890001
054100                                   PE-MQ-REASON-CODE              04900001
054200        PERFORM 5100-BACK-OUT-MQ                                  04910001
054300        MOVE PV-HOLD-COMPLETION-CODE TO PV-COMPLETION-CODE        04920001
054400        MOVE PV-HOLD-REASON          TO PV-REASON                 04930001
054500        PERFORM 9200-MQ-ABEND                                     04940001
054600     END-IF.                                                      04950001
054700                                                                  04960001
054800                                                                  04970001
054900                                                                  04980001
055000 3030-FILL-PIX-INFO.                                              04990001
055100                                                                  05000001
055200     MOVE '999'                       TO  TransactionType.        05010001
055300*    MOVE '00 '                       TO  TRANSACTIONCODE.        05020001
055400     MOVE CC-DEBUG-SWITCH             TO  TransactionCode.        05020001
055500     MOVE 111111111                   TO  TransactionNumber.      05030001
055600     MOVE 123456789                   TO  SequenceNUmber.         05040001
055700     MOVE '88637500'                  TO  StyleSuffix.            05050001
055800     MOVE '2007-04-30T11:07:22'       TO  DateCreated.            05060001
055900     MOVE '000129260040261234'        TO  CaseNumber.             05070001
056000     MOVE '4'                         TO  InvAdjustmentQty.       05080001
056100     MOVE 'A'                         TO  InvAdjustmentType.      05090001
056200     MOVE '870'                       TO  Warehouse.              05100001
056300     MOVE '0870'                      TO  DCNumber.               05110001
056400***DM -  DAMAGE                                                   05120001
056500     MOVE 'DM'                        TO  TransReasonCode.        05130001
056600     MOVE 'WSKUP016       '           TO  As400UserID.            05140001
056700     MOVE 'RC1'                       TO  ReferenceCode1.         05150001
056800     MOVE '873               '        TO  Reference1.             05160001
056900     MOVE 'RC2'                       TO  ReferenceCode2.         05170001
057000     MOVE 'K075582316          '      to  Reference2.             05180001
057100     MOVE 'RC3'                       TO  ReferenceCode3.         05190001
057200     MOVE 'P                '         TO  Reference3.             05200001
057300     MOVE 'RC4'                       TO  ReferenceCode4.         05210001
057400     MOVE '4533651          '         to  Reference4.             05220001
057500     MOVE 'RC5'                       TO  ReferenceCode5.         05230001
057600     MOVE '10               '         TO  Reference5.             05240001
057700     MOVE 'RC6'                       TO  ReferenceCode6.         05250001
057800     MOVE 'Reference field 6'         to  ReferenceField6.        05260001
057900     MOVE 'RC7'                       TO  ReferenceCode7.         05270001
058000     MOVE 'TA650199         '         TO  ReferenceField7.        05280001
058100     MOVE 'RC8'                       TO  ReferenceCode8.         05290001
058200     MOVE 'SCNN'                      to  ReferenceField8.        05300001
058300     MOVE 'RC9'                       TO  ReferenceCode9.         05310001
058400     MOVE 'D001'                      TO  ReferenceField9.        05320001
058500     MOVE 'RC10'                      TO  ReferenceCode10.        05330001
058600     MOVE 'Reference field 10'        to  ReferenceField10.       05340001
058700     MOVE '99'                        to  ActionCode.             05350001
058800                                                                  05360001
058900*3030-FILL-PIX-INFO.                                              05370001
059000*                                                                 05380001
059100*    MOVE '606'                       TO  TransactionType.        05390001
059200*    MOVE '03 '                       TO  TransactionCode.        05400001
059300*    MOVE 123456789                   TO  TransactionNumber.      05410001
059400*    MOVE 123456789                   TO  SequenceNUmber.         05420001
059500*    MOVE  '01'                       to  Company.                05430001
059600*    MOVE  '01'                       to  Divisio1.               05440001
059700*    MOVE '88404622'                  TO  StyleSuffix.            05450001
059800*    MOVE  '1212121212'               to  SkuID.                  05460001
059900*    MOVE   '2323232323'              TO  InventoryType.          05470001
060000*    MOVE   '11111111'                to  ProductStatus.          05480001
060100*    MOVE   '99999999'                to  BatchNumber.            05490001
060200*    MOVE   '00000001'                to  SKUAttribute1.          05500001
060300*    MOVE   '00000001'                to  SKUAttribute2.          05510001
060400*    MOVE   '00000001'                to  SKUAttribute3.          05520001
060500*    MOVE   '00000001'                to  SKUAttribute4.          05530001
060600*    MOVE   '00000001'                to  SKUAttribute5.          05540001
060700*    MOVE   '77777777'                to  CountryOfOrgin.         05550001
060800*    MOVE '2007-03-28T11:07:22'       TO  DateCreated.            05560001
060900*    MOVE '2082405'                   TO  CaseNumber.             05570001
061000*    MOVE '9'                         TO  InvAdjustmentQty.       05580001
061100*    MOVE   'UM'                      to UnitOfMeasure.           05590001
061200*    MOVE 'A'                         TO  InvAdjustmentType.      05600001
061300*    MOVE '870'                       TO  Warehouse.              05610001
061400*    MOVE '0870'                      TO  DCNumber.               05620001
061500*    MOVE 'DM'                        TO  TransReasonCode.        05630001
061600*    MOVE 'RC1'                       TO  ReferenceCode1.         05640001
061700*    MOVE '456234562345623456'        TO  Reference1.             05650001
061800*    MOVE 'RC2'                       TO  ReferenceCode2.         05660001
061900*    MOVE '45623456234562345623'      to  Reference2.             05670001
062000*    MOVE 'RC3'                       TO  ReferenceCode3.         05680001
062100*    MOVE 'P                '         TO  Reference3.             05690001
062200*    MOVE 'RC4'                       TO  ReferenceCode4.         05700001
062300*    MOVE '55556664         '         to  Reference4.             05710001
062400*    MOVE 'RC5'                       TO  ReferenceCode5.         05720001
062500*    MOVE '123855           '         TO  Reference5.             05730001
062600*    MOVE 'RC6'                       TO  ReferenceCode6.         05740001
062700*    MOVE 'Reference field 6'         to  ReferenceField6.        05750001
062800*    MOVE 'RC7'                       TO  ReferenceCode7.         05760001
062900*    MOVE 'TRUCK5           '         TO  ReferenceField7.        05770001
063000*    MOVE 'RC8'                       TO  ReferenceCode8.         05780001
063100*    MOVE 'YZAB'                      to  ReferenceField8.        05790001
063200*    MOVE 'RC9'                       TO  ReferenceCode9.         05800001
063300*    MOVE '9966'                      TO  ReferenceField9.        05810001
063400*    MOVE 'RC10'                      TO  ReferenceCode10.        05820001
063500*    MOVE 'Reference field 10'        to  ReferenceField10.       05830001
063600*    MOVE '05'                        to  ActionCode.             05840001
063700*    MOVE   'Y'                       to ReceivedFrom.            05850001
063800*    MOVE   '810'                     to ReferenceWhse.           05860001
063900*    MOVE   'R'                       to ReceiptsVariance.        05870001
064000*    MOVE   'lb'                      to Weight.                  05880001
064100*    MOVE   'C'                       to ReceiptsCompleted.       05890001
064200*    MOVE   3000                      to CasesShipped.            05900001
064300*    MOVE   6000                      to UnitsShipped.            05910001
064400*    MOVE   100                       to CasesReceived.           05920001
064500*    MOVE   10000                     to UnitsReceived.           05930001
064600*    MOVE   'CustomReferencetxt'      to CustomReference          05940001
064700*    MOVE   'ErrorCommenttxt'         to ErrorComment.            05950001
064800*    MOVE    55555                    to WeightAdjustmentQuantity.05960001
064900*    MOVE    'A'                      to WeightAdjustmentType.    05970001
065000                                                                  05980001
065100 4030-GENERATE-XML-PIX.                                           05990001
065200                                                                  06000001
065300     MOVE SPACES TO PV-XML.                                       06010001
065400                                                                  06020001
065500     XML GENERATE PV-XML                                          06030001
065600         FROM PIXBridge                                           06040001
065700         COUNT IN XML-LENGTH                                      06050001
065800         ON EXCEPTION                                             06060001
065900             PERFORM 5000-XML-ERROR                               06070001
066000         NOT ON EXCEPTION                                         06080001
066100             PERFORM 5100-XML-SUCCESS                             06090001
066200     END-XML.                                                     06100001
066300                                                                  06110001
066400                                                                  06120001
066500                                                                  06130001
066600                                                                  06140001
066700 5000-XML-ERROR.                                                  06150001
066800                                                                  06160001
066900     PERFORM 9000-EXPLAIN-XML-RESPONSE                            06170001
067000     PERFORM  VARYING XML-LINE-IDX FROM 1 BY 1                    06180001
067100                UNTIL XML-LINE-IDX > XML-RESPONSE-LINES           06190001
067200         DISPLAY XML-MSG(XML-LINE-IDX)                            06200001
067300     END-PERFORM.                                                 06210001
067400     MOVE +4018         TO ABEND-CODE.                            06220001
067500     CALL 'ILBOABN0' USING ABEND-CODE.                            06230001
067600                                                                  06240001
067700                                                                  06250001
067800 5100-XML-SUCCESS.                                                06260001
067900                                                                  06270001
068000* This code makes the CR-MI field optional.                       06280001
068100* The XML Generator will create a tag even if the field is blank. 06290001
068200* This will strip it out.                                         06300001
068300     UNSTRING PV-XML(1:XML-LENGTH)                                06310001
068400       DELIMITED BY '<CR-MI> </CR-MI>'                            06320001
068500               INTO PV-BEFORE COUNT PV-BEFORE-CNT                 06330001
068600                    PV-AFTER  COUNT PV-AFTER-CNT.                 06340001
068700     STRING PV-BEFORE(1:PV-BEFORE-CNT) PV-AFTER                   06350001
068800       DELIMITED BY SIZE INTO PV-XML.                             06360001
068900     COMPUTE XML-LENGTH = PV-BEFORE-CNT + PV-AFTER-CNT.           06370001
069000                                                                  06380001
069100     DISPLAY 'XML document was successfully generated'.           06390001
069200     DISPLAY ' '.                                                 06400001
069300     DISPLAY 'The generated XML is ' XML-LENGTH                   06410001
069400             ' characters long.'.                                 06420001
069500     DISPLAY ' '.                                                 06430001
069600     DISPLAY PV-XML(1:XML-LENGTH).                                06440001
069700                                                                  06450001
069800     DISPLAY ' '.                                                 06460001
069900     DISPLAY 'FORMATTED:'.                                        06470001
070000     DISPLAY PV-XML-BANNER.                                       06480001
070100     MOVE PV-XML(1:XML-LENGTH) TO XML-UNFORMATTED-MSG             06490001
070200     PERFORM 9554-DISPLAY-FORMATTED-XML.                          06500001
070300                                                                  06510001
070400                                                                  06520001
070500     COPY ISPD007.                                                06530001
070600     COPY ISPD008.                                                06540001
070700     COPY ISPD009.                                                06550001
070800                                                                  06560001
070900******************************************************************06570001
071000                                                                  06580001
071100                                                                  06590001
071200******************************************************************06600001
071300 5200-CREATE-MSGS.                                                06610001
071400                                                                  06620001
071500                                                                  06630001
071600     MOVE 'PIXPROCESS'               TO PV-MQC-PROCESS-TYPE.      06640001
071700     MOVE PV-HOLD-GROUP-PROCESS-ID   TO PV-MQC-GROUP-ID.          06650001
071800*    MOVE PV-CURR-STR-NBR            TO PV-MQC-STR-NBR.           06660001
071900     MOVE PV-XML-BANNER              TO PV-MSGBUFFER-banner.      06670001
072000     MOVE PV-XML(1:XML-LENGTH)       TO PV-MSGBUFFER-data.        06680001
072100     COMPUTE PV-MSG-LENGTH = XML-LENGTH                           06690001
072200                           + LENGTH OF PV-XML-BANNER.             06700001
072300     MOVE PV-MSG-LENGTH TO PV-MSG-LENGTH-DISPLAY.                 06710001
072400     DISPLAY 'MQ MSG-LENGTH = ' PV-MSG-LENGTH-DISPLAY.            06720001
072500     MOVE PV-MQC-CONTROL-RECORD      TO MQMD-APPLIDENTITYDATA.    06730001
072600*    MOVE PV-HOLD-GROUP-PROCESS-ID   TO MQMD-CORRELID.            06740001
072700                                                                  06750001
072800     INITIALIZE PS-MQPUT-SUCCESSFUL-IND                           06760001
072900                PC-MQPUT-RETRY-COUNTER.                           06770001
073000     PERFORM 5100-MQ-PUT-TO-QUEUE                                 06780001
073100       UNTIL PS-MQPUT-SUCCESSFUL.                                 06790001
073200                                                                  06800001
073300                                                                  06810001
073400                                                                  06820001
073500******************************************************************06830001
073600*                                                                *06840001
073700*             5 0 0 0 - P U T   M Q   M E S S A G E              *06850001
073800*                                                                *06860001
073900******************************************************************06870001
074000 5100-MQ-PUT-TO-QUEUE.                                            06880001
074100***  DISPLAY '5100-MQ-PUT-TO-QUEUE'.                              06890001
074200                                                                  06900001
074300     MOVE MQMI-NONE    TO MQMD-MSGID.                             06910001
074400     MOVE MQCI-NONE    TO MQMD-CORRELID.                          06920001
074500     MOVE MQFMT-STRING TO MQMD-FORMAT.                            06930001
074600                                                                  06940001
074700*    DEBUG CONTROL SHOULD GO TO THE TOP OF THE HEAP                       
074800     IF  CC-DEBUG-SWITCH  =  'Y  ' OR 'N  '                       02961202
074900         MOVE '9'            TO MQMD-PRIORITY                     02961402
075000     END-IF.                                                      02962002
075100                                                                          
075200     MOVE MQPER-PERSISTENT TO MQMD-PERSISTENCE.                   06950001
075300     COMPUTE MQPMO-OPTIONS  = MQPMO-SYNCPOINT                     06960001
075400                            + MQPMO-SET-IDENTITY-CONTEXT.         06970001
075500     PERFORM 5010-LOW-VALUES.                                     06980001
075600     DISPLAY '  CORRELID = ' MQMD-CORRELID.                       06990001
075700     DISPLAY '  APPLIDENTITYDATA = ' MQMD-APPLIDENTITYDATA.       07000001
075800                                                                  07010001
075900     CALL PC-MQPUT USING PV-HCONN                                 07020001
076000                         PV-PQ-HANDLE                             07030001
076100                         MQM-MESSAGE-DESCRIPTOR                   07040001
076200                         MQM-PUT-MESSAGE-OPTIONS                  07050001
076300                         PV-MSG-LENGTH                            07060001
076400                         PV-MSGBUFFER                             07070001
076500                         PV-COMPLETION-CODE                       07080001
076600                         PV-REASON.                               07090001
076700                                                                  07100001
076800*IF PUT FAILED THEN DISPLAY ERROR MESSAGE                         07110001
076900     IF (PV-COMPLETION-CODE NOT = MQCC-OK)                        07120001
077000         IF (PV-REASON NOT = MQRC-PAGESET-FULL                    07130001
077100           AND PV-REASON NOT = MQRC-Q-FULL                        07140001
077200           AND PV-REASON NOT = MQRC-Q-SPACE-NOT-AVAILABLE )       07150001
077300             CALL PV-MQCHECK USING PV-REASON                      07160001
077400                                   PV-MQ-REASON-TEXT              07170001
077500             DISPLAY 'MQ MESSAGE = ' PV-MSGBUFFER                 07180001
077600             MOVE '5100-MQ-PUT-TO-QUEUE'  TO PV-PARAGRAPH         07190001
077700             MOVE 'MQPUT FAILED'          TO PV-ERROR-MESSAGE     07200001
077800             MOVE PV-COMPLETION-CODE  TO PV-HOLD-COMPLETION-CODE  07210001
077900                                         PE-MQ-COMPLETION-CODE    07220001
078000             MOVE PV-REASON               TO PV-HOLD-REASON       07230001
078100                                             PE-MQ-REASON-CODE    07240001
078200             PERFORM 5100-BACK-OUT-MQ                             07250001
078300             MOVE PV-HOLD-COMPLETION-CODE TO PV-COMPLETION-CODE   07260001
078400             MOVE PV-HOLD-REASON          TO PV-REASON            07270001
078500             PERFORM 9200-MQ-ABEND                                07280001
078600         ELSE                                                     07290001
078700             ADD 1 TO PC-MQPUT-RETRY-COUNTER                      07300001
078800             IF PC-MQPUT-RETRY-COUNTER >= 60                      07310001
078900                 DISPLAY 'MQ MESSAGE = ' PV-MSGBUFFER             07320001
079000                 MOVE '5100-MQ-PUT-TO-QUEUE' TO PV-PARAGRAPH      07330001
079100                 MOVE 'MQPUT ERROR- RETRY > 60 '                  07340001
079200                      TO PV-ERROR-MESSAGE                         07350001
079300                 MOVE PV-COMPLETION-CODE                          07360001
079400                      TO PV-HOLD-COMPLETION-CODE                  07370001
079500                 MOVE PV-REASON TO PV-HOLD-REASON                 07380001
079600                 PERFORM 5100-BACK-OUT-MQ                         07390001
079700                 MOVE PV-HOLD-COMPLETION-CODE                     07400001
079800                      TO PV-COMPLETION-CODE                       07410001
079900                 MOVE PV-HOLD-REASON TO PV-REASON                 07420001
080000                 PERFORM 9200-MQ-ABEND                            07430001
080100             ELSE                                                 07440001
080200*WAIT FOR 30 SECONDS AND TRY AGAIN                                07450001
080300                 CALL 'SYSWAIT' USING PC-DELAY-INTERVAL           07460001
080400             END-IF                                               07470001
080500         END-IF                                                   07480001
080600     ELSE                                                         07490001
080700         ADD 1 TO PA-TOTAL-MQ-MSGS-SENT                           07500001
080800         SET PS-MQPUT-SUCCESSFUL TO TRUE                          07510001
080900     END-IF.                                                      07520001
081000                                                                  07530001
081100******************************************************************07540001
081200 5010-LOW-VALUES.                                                 07550001
081300                                                                  07560001
081400     MOVE PV-MSGBUFFER TO PV-HOLD-MSGBUFFER.                      07570001
081500                                                                  07580001
081600     PERFORM                                                      07590001
081700       VARYING N FROM 1 BY 1                                      07600001
081800         UNTIL N > PV-MSG-LENGTH                                  07610001
081900                                                                  07620001
082000         IF PV-MSGBUFFER-CHAR (N) = LOW-VALUES                    07630001
082100             MOVE SPACES TO PV-MSGBUFFER-CHAR (N)                 07640001
082200         END-IF                                                   07650001
082300                                                                  07660001
082400     END-PERFORM.                                                 07670001
082500                                                                  07680001
082600     MOVE PV-HOLD-MSGBUFFER TO PV-MSGBUFFER.                      07690001
082700                                                                  07700001
082800******************************************************************07710001
082900* BACK OUT MQ PROCESSING SINCE THE POINT OF THE LAST COMMIT       07720001
083000******************************************************************07730001
083100 5100-BACK-OUT-MQ.                                                07740001
083200                                                                  07750001
083300     CALL PC-MQBACK USING PV-HCONN                                07760001
083400                          PV-COMPLETION-CODE                      07770001
083500                          PV-REASON.                              07780001
083600                                                                  07790001
083700     IF (PV-COMPLETION-CODE NOT = MQCC-OK)                        07800001
083800        CALL PV-MQCHECK USING PV-REASON                           07810001
083900                              PV-MQ-REASON-TEXT                   07820001
084000        MOVE '5100-BACK-OUT-MQ'  TO PV-PARAGRAPH                  07830001
084100        MOVE 'MQBACK ERROR'    TO PV-ERROR-MESSAGE                07840001
084200        PERFORM 9200-MQ-ABEND                                     07850001
084300     END-IF.                                                      07860001
084400                                                                  07870001
084500***************************************************************** 07871002
084600**READ CONTROL CARD 1                                             07872002
084700***************************************************************** 07873002
084800 8500-READ-CONTROL-CARD-1.                                        07874002
084900                                                                  07875002
085000     READ CONTROL-CARD-1 INTO CC-CONTROL-CARD-1-LAYOUT.           07876002
085100                                                                  07877002
085200******************************************************************07880001
085300* DISPLAY STATISTICS FOR THE PROGRAM                              07890001
085400******************************************************************07900001
085500 9000-EOJ-ROUTINE.                                                07910001
085600                                                                  07920001
085700     DISPLAY ' '                                                  07930001
085800     DISPLAY ' ********************************************'      07940001
085900     DISPLAY '     * WSKUP016 SUMMARY STATISTICS *         '      07950002
086000     DISPLAY ' '                                                  07960001
086100     DISPLAY '   CONTROL CARD : ' CC-QUEUE-NAME                   07980002
086200     DISPLAY '   CURRENT TIMESTAMP : '                            08000002
086300                                    PV-CURRENT-TMST               08010003
086400     DISPLAY ' '                                                  08020001
086500     DISPLAY '   TOTAL MQ MESSAGES SENT:   '                      08030001
086600                                    PA-TOTAL-MQ-MSGS-SENT         08040001
086700     DISPLAY ' '                                                  08050001
086800     DISPLAY ' ********************************************'.     08060001
086900                                                                  08070001
087000****************************************************************  08080001
087100** PERFORM MQ-SERIES ABEND PROCESSING                             08090001
087200****************************************************************  08100001
087300 9200-MQ-ABEND.                                                   08110001
087400                                                                  08120001
087500     DISPLAY '****************** A B E N D ******************'.   08130001
087600     DISPLAY '** MQSERIES ERROR **'.                              08140001
087700     DISPLAY '** PROGRAM:    ', PC-CURRENT-PROGRAM-NAME.          08150001
087800     DISPLAY '** ABEND CODE: ', PV-ABEND-CODE.                    08160001
087900     DISPLAY '** PARAGRAPH:  ', PV-PARAGRAPH.                     08170001
088000     DISPLAY '** MESSAGE:    ', PV-ERROR-MESSAGE.                 08180001
088100     DISPLAY '** COMP CODE:  ', PE-MQ-COMPLETION-CODE.            08190001
088200     DISPLAY '** RSN CODE:   ', PE-MQ-REASON-CODE.                08200001
088300     DISPLAY '** RSN TEXT:   ', PV-MQ-REASON-TEXT.                08210001
088400     DISPLAY '***********************************************'.   08220001
088500     MOVE +4013 TO ABEND-CODE.                                    08230001
088600     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         08240001
088700                                                                  08250001
088800******************************************************************08260001
088900* 9900-DB2-ABEND - PERFORMS THE ABEND FOR THE PROGRAM IN THE      08270001
089000* EVENT THAT AN SQL ERROR OR WARNING CODE OCCURS.                 08280001
089100******************************************************************08290001
089200 9900-DB2-ABEND.                                                  08300001
089300                                                                  08310001
089400     MOVE SQLCODE    TO PV-SQLCODE.                               08320001
089500     MOVE PV-SQLCODE TO PV-DISPLAY-SQLCODE.                       08330001
089600     DISPLAY '*** DB2 ERROR ***'.                                 08340001
089700     DISPLAY '*** SQLCODE   = ' PV-DISPLAY-SQLCODE.               08350001
089800     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                 08360001
089900     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               08370001
090000     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               08380001
090100     DISPLAY '*** MESSAGE   = ' PV-DB2-OPERATION-MESSAGE-1.       08390001
090200     DISPLAY '*** TABLE 1   = ' PV-ABEND-STRUCTURE-1.             08400001
090300                                                                  08410001
090400******************************************************************08420001
090500* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    08430001
090600* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         08440001
090700* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     08450001
090800* FORMAT.                                                         08460001
090900******************************************************************08470001
091000     COPY DPPD004.                                                08480001
091100                                                                  08490001
091200     IF SQLCODE NOT = -911                                        08500001
091300         EXEC SQL                                                 08510001
091400             ROLLBACK                                             08520001
091500         END-EXEC                                                 08530001
091600     END-IF.                                                      08540001
091700                                                                  08550001
091800     MOVE +4013         TO PV-ABEND-CODE.                         08560001
091900     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         08570001
092000******************************************************************08580001
092100******************************************************************08590001
092200******************************************************************08600001
