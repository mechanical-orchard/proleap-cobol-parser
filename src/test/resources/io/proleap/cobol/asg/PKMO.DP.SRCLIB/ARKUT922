000100*-----------------------*                                                 
000200 IDENTIFICATION DIVISION.                                                 
000300*-----------------------*                                                 
000400 PROGRAM-ID.    ARKUT922.                                                 
000500 AUTHOR.        BOB MCASEY.                                               
000600 DATE-WRITTEN.  FEB 2024.                                                 
000700                                                                          
000800*---------------------------------------------------------------*         
001100*    QUERY ART-EMP-DISC                                         *         
001200*                                                               *         
001900*                                                               *         
002000*---------------------------------------------------------------*         
002100*                                                               *         
002200* DB2 TABLES:                                                   *         
002300*  1. ART_EMP_DISC                                              *         
002400*                                                               *         
004200*---------------------------------------------------------------*         
004400                                                                          
004500 ENVIRONMENT DIVISION.                                                    
004600 CONFIGURATION SECTION.                                                   
004700 SOURCE-COMPUTER. IBM-3090.                                               
004800 OBJECT-COMPUTER. IBM-3090.                                               
004900                                                                          
005000*                                                                         
005100 INPUT-OUTPUT SECTION.                                                    
005200 FILE-CONTROL.                                                            
005300                                                                          
           SELECT EMP-INPUT-FILE                                                
               ASSIGN TO INP01.                                                 
           SELECT EMP-OUTPUT-FILE                                               
               ASSIGN TO OUT01.                                                 
005700                                                                          
005800 DATA DIVISION.                                                           
005900 FILE SECTION.                                                            
006000                                                                          
       FD  EMP-INPUT-FILE                                                       
           RECORDING MODE IS F                                                  
           BLOCK CONTAINS 0 RECORDS.                                            
       01  SD-INPUT-RECORD         PIC X(25).                                   
      *                                                                         
       FD  EMP-OUTPUT-FILE                                                      
           RECORDING MODE IS F                                                  
           BLOCK CONTAINS 0 RECORDS.                                            
       01  SD-OUTPUT-RECORD        PIC X(80).                                   
007100                                                                          
007900                                                                          
008100 WORKING-STORAGE SECTION.                                                 
008200                                                                          
008300 01  PC-PROGRAM-CONSTANTS.                                                
008400     05  PC-PROGRAM-NAME         PIC  X(08)  VALUE 'ARKUT922'.            
008400     05  PC-WS-PROGRAM           PIC  X(40)  VALUE                        
008500         '**** WORKING STORAGE ** ARKUT922 ****'.                         
           05  PC-SQL-MAX-RETRIES          PIC  9(01) VALUE 5.                  
011800                                                                          
011900 01  PV-PROGRAM-VARIABLES.                                                
012000     05  PV-CURRENT-PARAGRAPH    PIC X(35).                               
           05  PV-INPUT-LEN            PIC  9(09) VALUE ZEROES.                 
012100*    05  PV-NULL-IND             PIC S9(4)     VALUE ZERO                 
012200*                                              COMP SYNC.                 
012500     05  PV-INPUT-COUNT        PIC S9(9)     VALUE ZEROS                  
012600                                               COMP.                      
012500     05  PV-TOTAL-LTD-COUNT    PIC S9(9)     VALUE ZEROS                  
012600                                               COMP.                      
012500     05  PV-OUTPUT-COUNT       PIC S9(9)     VALUE ZEROS                  
012600                                               COMP.                      
012500     05  PV-EMP-COUNT          PIC S9(9)     VALUE ZEROS                  
012600                                               COMP.                      
012500     05  PV-NO-DISC-ROW-COUNT PIC S9(9)     VALUE ZEROS                   
012600                                               COMP.                      
012500     05  PV-NO-LTD-ROW-COUNT PIC S9(9)     VALUE ZEROS                    
012600                                               COMP.                      
012500     05  PV-NO-REG-ROW-COUNT PIC S9(9)     VALUE ZEROS                    
012600                                               COMP.                      
012500     05  PV-NO-ROW-COUNT      PIC S9(9)     VALUE ZEROS                   
012600                                               COMP.                      
           05  AB-ABEND-CODE                   PIC S9(04) VALUE ZERO            
                                                             COMP SYNC.         
               88 ABEND-4003-CTRL-CARD-ERROR      VALUE +4003.                  
               88 ABEND-4005-FILE-OPEN-ERROR      VALUE +4005.                  
               88 ABEND-4006-FILE-CLOSE-ERROR     VALUE +4006.                  
               88 ABEND-4013-DB2-ERROR            VALUE +4013.                  
               88 ABEND-4019-CAL-SUB-ERROR        VALUE +4019.                  
           05  PV-ACTUAL-LEN          PIC S9(03) COMP-3 VALUE ZEROES.           
           05  PV-ACCT-NBR-12.                                                  
               10  PV-ACCT-NBR-10            PIC  X(10) VALUE SPACES.           
               10  FILLER                    PIC  X(02) VALUE '00'.             
           05  PV-ART-ACCT-NBR    PIC S9(10)V USAGE COMP-3.                     
                                                                                
       01  PV-INPUT-DATA-LAYOUT.                                                
           05  PV-EMP-ID             PIC X(09).                                 
           05  FILLER                PIC X(01).                                 
           05  PV-ACCT-NBR           PIC 9(10).                                 
           05  FILLER                PIC X(02).                                 
012900                                                                          
017300                                                                          
017400 01  PS-PROGRAM-SWITCHES.                                                 
017500     05  PS-EOF-INPUT-SW          PIC X(01) VALUE ' '.                    
017600         88  PS-END-OF-INPUT-FILE           VALUE 'Y'.                    
017700         88  PS-NOT-END-OF-INPUT-FILE       VALUE 'N'.                    
           05  PS-ACCT-SSN                PIC X(08)  VALUE SPACES.              
               88  PS-ACCT-NBR                       VALUE 'ACCT NBR'.          
               88  PS-SSN-NBR                        VALUE 'SSN NBR'.           
018100                                                                          
         05  PV-SQL-RETRY-LOGIC.                                                
             10  PV-SQL-SUB                PIC  9(01) VALUE ZERO.               
019500                                                                          
      ******************************************************************        
      * LAYOUT THAT DEFINES THE PARAMETERS NEEDED TO INVOKE PROTEGRITY *        
      * MODULE                                                         *        
      ******************************************************************        
           COPY PTYCCSIP.                                                       
                                                                                
      ******************************************************************        
      * LAYOUT THAT DEFINES THE WORKING VARIABLES TO INVOKE PROTEGRITY *        
      * MODULE                                                         *        
      ******************************************************************        
           COPY DPWS031.                                                        
                                                                                
      ******************************************************************        
      * LAYOUT THAT DEFINES THE WORKING VARIABLES TO CONVERT FROM BASE64        
      * TO BINARY & VICE VERSA                                                  
      ******************************************************************        
           COPY DPWS022.                                                        
                                                                                
      ******************************************************************        
      * LAYOUT THAT DEFINES THE WORKING VARIABLES TO CONVERT FROM EBCDIC        
      * TO ASCII & VICE VERSA                                                   
      ******************************************************************        
           COPY DPWS053.                                                        
      ******************************************************************        
                                                                                
041508*-----------------------------------------------------------              
041508* DB2 TABLE ART_EMP_DISC                                                  
041508*-----------------------------------------------------------              
020000     EXEC SQL                                                             
020100         INCLUDE ART00001                                                 
020200     END-EXEC.                                                            
020400*                                                                         
020400*                                                                         
020500*    SQL COMMUNICATIONS AREA DCLGEN                                       
020600*                                                                         
020700     EXEC SQL                                                             
020800         INCLUDE SQLCA                                                    
020900     END-EXEC.                                                            
022400/                                                                         
022500*----------------------------------------------------------------         
022600*  ABEND DATA AREAS                                                       
022700*----------------------------------------------------------------         
       01  AB-ABEND-FIELDS.                                                     
           05  AB-PARAGRAPH-NAME           PIC  X(30) VALUE SPACES.             
           05  AB-DB2-OPERATION            PIC  X(40) VALUE SPACES.             
           05  AB-MSG-OPERATION            PIC  X(40) VALUE SPACES.             
           05  AB-STATUS-CODE              PIC  X(02) VALUE SPACES.             
                                                                                
022800 01  ABEND-CODE                  PIC S9(04)  VALUE ZEROS                  
022900                                             COMP SYNC.                   
023000     88  AC-BAD-DATA                         VALUE +4003.                 
023100     88  AC-DB2-ERROR                        VALUE +4013.                 
023200                                                                          
025900 01  OUTPUT-LINE-1               PIC X(54)   VALUE                        
026000     '  UPDATE DB2PDBA.ART_EMP_DISC SET DISC_STAT_CDE = ''N'','.          
025900 01  OUTPUT-LINE-2.                                                       
           05  FILLER                  PIC X(30) VALUE SPACES.                  
           05  FILLER                  PIC X(31) VALUE                          
026000        '  LAST_UPD_DTE  = CURRENT DATE,'.                                
025900 01  OUTPUT-LINE-3.                                                       
           05  FILLER                  PIC X(30) VALUE SPACES.                  
           05  FILLER                  PIC X(40) VALUE                          
026000        '  CMNT_TXT = ''FISERV EMP DISC SYNC'' '.                         
025900 01  OUTPUT-LINE-4.                                                       
           05  FILLER                  PIC X(02) VALUE SPACES.                  
           05  FILLER                  PIC X(18) VALUE                          
026000        '  WHERE EMP_ID = '''.                                            
           05  OL4-EMP                 PIC X(07).                               
026000     05  FILLER                  PIC X(02) VALUE ''''.                    
025900 01  OUTPUT-LINE-5.                                                       
           05  FILLER                  PIC X(02) VALUE SPACES.                  
           05  FILLER                  PIC X(18) VALUE                          
026000        '  AND ACCT_NBR = '.                                              
           05  OL5-ACCT                PIC 9(10).                               
026000     05  FILLER                  PIC X(02) VALUE ';'.                     
026100*----------------------------------------------------------------         
026200*  SQLCA FORMATTED MESSAGE AREA                                           
026300*----------------------------------------------------------------         
026400     COPY DPWS004.                                                        
026500*                                                                         
026700 01  FILLER                      PIC  X(35)  VALUE                        
026800     '**** END OF W/S ** ARKUT922 ****'.                                  
027000 PROCEDURE DIVISION.                                                      
027100                                                                          
027200     PERFORM 1000-MAINLINE.                                               
027300     GOBACK.                                                              
027400                                                                          
027600 1000-MAINLINE.                                                           
027700                                                                          
027800     MOVE '1000-MAINLINE' TO PV-CURRENT-PARAGRAPH.                        
027900                                                                          
035700     DISPLAY '** BEGINNING OF PROGRAM ARKUT922 **'.                       
028000     PERFORM 1100-INITIALIZE.                                             
028100                                                                          
028200     PERFORM 2000-PROCESS-EXTRACT-FILE                                    
028300         UNTIL PS-END-OF-INPUT-FILE.                                      
028400                                                                          
028500     PERFORM 9000-END-OF-PROGRAM.                                         
028600                                                                          
028800*----------------------------------------------------------------         
028900*    INITIALIZATION PROCESSING.                                           
029000*----------------------------------------------------------------         
029100 1100-INITIALIZE.                                                         
029200                                                                          
029300     MOVE '1100-INITIALIZE' TO PV-CURRENT-PARAGRAPH.                      
029400                                                                          
030000     OPEN INPUT  EMP-INPUT-FILE.                                          
030000     OPEN OUTPUT EMP-OUTPUT-FILE.                                         
030200                                                                          
           SET PS-NOT-END-OF-INPUT-FILE  TO TRUE.                               
                                                                                
028800*----------------------------------------------------------------         
028900*    PROCESS EXTRATCT                                                     
029000*----------------------------------------------------------------         
032800 2000-PROCESS-EXTRACT-FILE.                                               
032900                                                                          
033000     MOVE '2000-PROCESS-EXTRACT-FILE' TO                                  
033100                             PV-CURRENT-PARAGRAPH.                        
033200                                                                          
034200     PERFORM 7000-READ-INPUT-FILE.                                        
           IF PS-NOT-END-OF-INPUT-FILE                                          
      ***  TOKENIZE ACCT NBR                                                    
**TEMP         INITIALIZE PV-ACCT-NBR-12                                        
**TEMP                    PV-INPUT-LEN                                          
**TEMP*        DISPLAY 'PV-ACCT-NBR ' PV-ACCT-NBR                               
**TEMP         MOVE PV-ACCT-NBR  TO PV-ACCT-NBR-10                              
**TEMP         SET PS-ACCT-NBR TO TRUE                                          
**TEMP         PERFORM 3000-TOKENIZE-DATA                                       
               PERFORM 8000-SELECT-EMP-INFO                                     
           END-IF.                                                              
                                                                                
      ******************************************************************        
      * 3000-TOKENIZE-DATA                                                      
      *    TOKENIZE SSN NUMBERS                                                 
      ******************************************************************        
       3000-TOKENIZE-DATA.                                                      
                                                                                
           INITIALIZE CSI-PARAMETERS                                            
                      DP031-PROTEG-PGM-PARAMETERS.                              
                                                                                
           EVALUATE TRUE                                                        
              WHEN PS-ACCT-NBR                                                  
                MOVE 'ACCT-NBR'         TO DP031-FIELD                          
                MOVE PV-ACCT-NBR-12     TO DP031-CLEAR-TEXT                     
                MOVE 12                 TO DP031-INPUT-LEN                      
                SET DP031-ACCTNBR       TO TRUE                                 
           END-EVALUATE.                                                        
                                                                                
           SET CSI-ENCRYPT-FUNCTION     TO TRUE.                                
           PERFORM DP031-0000-PROTG-TOKEN-DETOKEN.                              
                                                                                
           IF CSI-RETURN-CODE = ZERO                                            
              IF PS-ACCT-NBR                                                    
                 MOVE DP031-CIPHER-TEXT TO PV-ACCT-NBR-12                       
                 MOVE PV-ACCT-NBR-10    TO OL5-ACCT                             
**TEMP*          DISPLAY 'PV-ACCT-NBR-10 ' PV-ACCT-NBR-10                       
              ELSE                                                              
                 DISPLAY ' WE HAVE AN ISSUE IN PROTEGRITY'                      
                             PV-INPUT-DATA-LAYOUT                               
              END-IF                                                            
           ELSE                                                                 
              DISPLAY 'ISSUE IN RECORD# : ' PV-INPUT-COUNT                      
              PERFORM DP031-9999-ABEND                                          
           END-IF.                                                              
                                                                                
050400*----------------------------------------------------------------         
050500*    WRITES OUTPUT FILE                                                   
050600*----------------------------------------------------------------         
050700 4000-WRITE-OUTPUT-FILE.                                                  
050800                                                                          
050900     MOVE '4000-WRITE-OUTPUT-FILE' TO                                     
051000           PV-CURRENT-PARAGRAPH.                                          
051100                                                                          
051200     WRITE SD-OUTPUT-RECORD  FROM OUTPUT-LINE-1.                          
051200     WRITE SD-OUTPUT-RECORD  FROM OUTPUT-LINE-2.                          
051200     WRITE SD-OUTPUT-RECORD  FROM OUTPUT-LINE-3.                          
           MOVE  PV-EMP-ID TO OL4-EMP.                                          
051200     WRITE SD-OUTPUT-RECORD  FROM OUTPUT-LINE-4.                          
051200     WRITE SD-OUTPUT-RECORD  FROM OUTPUT-LINE-5.                          
051300     ADD +1 TO PV-OUTPUT-COUNT.                                           
051400                                                                          
058200                                                                          
050400*----------------------------------------------------------------         
050500*    READ INPUT FILE                                                      
050600*----------------------------------------------------------------         
       7000-READ-INPUT-FILE.                                                    
                                                                                
           READ EMP-INPUT-FILE                                                  
             INTO PV-INPUT-DATA-LAYOUT                                          
               AT END                                                           
                 SET PS-END-OF-INPUT-FILE TO TRUE.                              
                                                                                
           IF PS-NOT-END-OF-INPUT-FILE                                          
             ADD +1 TO PV-INPUT-COUNT                                           
**TEMP*      DISPLAY '7000 INPUT LAYOUT '  PV-ESL-INPUT-LAYOUT                  
           END-IF.                                                              
                                                                                
                                                                                
050400*----------------------------------------------------------------         
050500*    SELECT STYLE DATA                                                    
050600*----------------------------------------------------------------         
       8000-SELECT-EMP-INFO.                                                    
**TEMP*    DISPLAY '8000-SELECT-EMP-INFO'.                                      
                                                                                
           MOVE 0 TO PV-EMP-COUNT                                               
           MOVE PV-ACCT-NBR-10  TO PV-ART-ACCT-NBR.                             
                                                                                
**TEMP        EXEC SQL                                                          
**TEMP           SELECT COUNT(*)                                                
**TEMP           INTO    :PV-EMP-COUNT                                          
**TEMP           FROM    ART_EMP_DISC                                           
**TEMP           WHERE   EMP_ID  = :PV-EMP-ID                                   
**TEMP            AND   ACCT_NBR = :PV-ART-ACCT-NBR                             
**TEMP            AND   DISC_STAT_CDE = 'L'                                     
**TEMP           WITH UR                                                        
**TEMP        END-EXEC.                                                         
                                                                                
            EVALUATE TRUE                                                       
                                                                                
                WHEN SQLCODE = +0                                               
**TEMP            IF PV-EMP-COUNT = 0                                           
**TEMP                DISPLAY 'NO LTD REC FOUND FOR  ' PV-EMP-ID                
**TEMP                        ' ' PV-ACCT-NBR-10                                
**TEMP                ADD +1 TO PV-NO-DISC-ROW-COUNT                            
**TEMP            ELSE                                                          
**TEMP                DISPLAY 'LTD REC FOUND FOR  ' PV-EMP-ID                   
**TEMP                        ' ' PV-ACCT-NBR-10                                
**TEMP                PERFORM 4000-WRITE-OUTPUT-FILE                            
**TEMP            END-IF                                                        
                WHEN SQLCODE = +100                                             
**TEMP                DISPLAY 'EMP INFO NOT FOUND ' PV-EMP-ID                   
                      ADD 1 TO PV-NO-DISC-ROW-COUNT                             
              WHEN OTHER                                                        
                 MOVE '8000-SELECT-EMP-INFO' TO AB-PARAGRAPH-NAME               
                 MOVE 'EMP_ID'                   TO PV-EMP-ID                   
                 SET ABEND-4013-DB2-ERROR        TO TRUE                        
                 PERFORM 9990-DB2-ABEND                                         
              END-EVALUATE.                                                     
                                                                                
           MOVE 0 TO PV-EMP-COUNT.                                              
                                                                                
034500*----------------------------------------------------------------         
034600*    END OF PROGRAM.                                                      
034700*----------------------------------------------------------------         
034800 9000-END-OF-PROGRAM.                                                     
034900                                                                          
035200                                                                          
035300     DISPLAY '** COUNTS FOR ARKUT922 **'.                                 
035500     DISPLAY 'NBR OF RECORDS READ   = ' PV-INPUT-COUNT.                   
035500     DISPLAY 'NBR OF RECS NOT FOUND       = ' PV-NO-DISC-ROW-COUNT.       
035500     DISPLAY 'NBR OF RECS WRITTEN         = ' PV-OUTPUT-COUNT.            
035700     DISPLAY '** END OF PROGRAM ARKUT922 **'.                             
035800                                                                          
036200     CLOSE EMP-INPUT-FILE                                                 
050200           EMP-OUTPUT-FILE.                                               
058400*----------------------------------------------------------------         
058500*    ABEND ROUTINE FOR DB2 ERRORS.                                        
058600*----------------------------------------------------------------         
058700 9990-DB2-ABEND.                                                          
058800                                                                          
           DISPLAY ' '.                                                         
           DISPLAY '** ABEND     **'.                                           
           DISPLAY '** PROGRAM   ** = ' PC-PROGRAM-NAME.                        
           DISPLAY '** PARAGRAPH ** = ' AB-PARAGRAPH-NAME.                      
           DISPLAY '** OPERATION ** = ' AB-DB2-OPERATION.                       
           DISPLAY 'NBR OF RECORES READ    = ' PV-INPUT-COUNT.                  
                                                                                
           COPY DPPD004.                                                        
           SET ABEND-4013-DB2-ERROR TO TRUE.                                    
           CALL 'ILBOABN0' USING AB-ABEND-CODE.                                 
                                                                                
      ******************************************************************        
      *    COPY MEMBER DPPD031 CONTAINS STATEMENTS NEEDED TO INVOKE             
      *    PROTEGRITY MODULE FOR PROTECTION/UNPROTECTION                        
      ******************************************************************        
           COPY DPPD031.                                                        
                                                                                
