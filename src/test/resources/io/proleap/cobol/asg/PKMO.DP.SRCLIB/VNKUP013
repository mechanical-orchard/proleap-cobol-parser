000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.     VNKUP013.                                        00020000
000300 AUTHOR.         NANCY EILBES.                                    00030000
000400 DATE-WRITTEN.   APRIL 2001.                                      00040000
000500*************************************************************     00050000
000600*    COBOL 2 WITH SQL                                       *     00060000
000700*                                                           *     00070000
000710*    MAINTAIN VENDOR AGREEMENT SERVICE ROWS FOR EDI PO      *     00071000
000720*                                                           *     00072000
000800* THIS PROGRAM READS THE EDI TRADING PARTNER TABLES TO FIND *     00080000
000900* ALL VENDORS THAT ARE SET UP FOR EDI PO (850) AND MAKES    *     00090000
001000* SURE THAT THE SERVICE ROW EXISTS ON TVNDAGR FOR EACH DEPT *     00100000
001100* THAT IS SET UP ON TVNDDPT FOR EACH ENT_ID RETURNED.  THE  *     00110000
001200* PROD/TEST INDICATOR WILL ALSO BE MAINTAINED ON THESE ROWS.*     00120000
001800*                                                           *     00180000
001900*************************************************************     00190000
002000*                                                           *     00200000
002100* DB2 TABLES:                                               *     00210000
002200*  1. TRADING PARTNER TABLE            (TTRDPRT)            *     00220000
002300*  2. TRADING PARTNER TRANSACTION TABLE(TTRDTRN)            *     00230000
002310*  3. VENDOR DEPARTMENT TABLE          (TVNDDPT)            *     00231000
002400*                                                           *     00240000
002500* OUTPUT:                                                   *     00250000
002600*  1. VENDOR AGREEMENT TABLE           (TVNDAGR)            *     00260000
002700*                                                           *     00270000
002800*************************************************************     00280000
002900* CHANGE LOG:                                               *     00290000
003000*                                                           *     00300000
003100* 99/99/99    XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX*     00310000
003200*                                                           *     00320000
003300*                                                           *     00330000
003400*************************************************************     00340000
003500                                                                  00350000
003600 ENVIRONMENT DIVISION.                                            00360000
003700                                                                  00370000
003800 INPUT-OUTPUT SECTION.                                            00380000
003900                                                                  00390000
004000 FILE-CONTROL.                                                    00400000
004100*                                                                 00410000
004200                                                                  00420000
004300 DATA DIVISION.                                                   00430000
004400                                                                  00440000
004500 FILE SECTION.                                                    00450000
004600*                                                                 00460000
004700                                                                  00470000
004800/                                                                 00480000
004900 WORKING-STORAGE SECTION.                                         00490000
005000                                                                  00500000
005100 01  FILLER                        PIC X(25)  VALUE               00510000
005200                             'WS FOR VNKUP013 BEGINS==>'.         00520000
005300                                                                  00530000
005400 01  WS-RETRY-COUNTER              PIC S9(4)  COMP VALUE ZERO.    00540000
005500 01  WS-RETRY-MAX                  PIC S9(4)  COMP VALUE 3.       00550000
005600                                                                  00560000
005700 01  WS-SWITCH-AREA.                                              00570000
005800     05  WS-FOUND-EDIPO-ROWS-SW   PIC X(03)  VALUE 'NO '.         00580001
005900         88  WS-NEW-EDIPO-ROWS               VALUE 'NO '.         00590001
006000         88  WS-FOUND-EDIPO-ROWS             VALUE 'YES'.         00600001
006100     05  WS-EDIPO-CSR-END-SW        PIC X(03)  VALUE 'NO '.       00610001
006200         88  WS-END-OF-EDIPO-CSR               VALUE 'YES'.       00620001
006300         88  WS-NOT-END-OF-EDIPO-CSR           VALUE 'NO '.       00630001
006400         88  WS-EMPTY-EDIPO-CSR                VALUE 'EMP'.       00640001
006500     05  WS-FOUND-VNDAGR-ROWS-SW  PIC X(01)  VALUE 'N'.           00650002
006600         88  VNDAGR-FOUND                    VALUE 'Y'.           00660002
006700         88  VNDAGR-NOT-FOUND                VALUE 'N'.           00670002
006800     05  WS-VNDAGR-CSR-END-SW       PIC X(03)  VALUE 'NO '.       00680001
006900         88  WS-END-OF-VNDAGR-CSR              VALUE 'YES'.       00690001
007000         88  WS-NOT-END-OF-VNDAGR-CSR          VALUE 'NO '.       00700001
007100         88  WS-EMPTY-VNDAGR-CSR               VALUE 'EMP'.       00710001
007200                                                                  00720000
007300*                                                                 00730000
007400 01  WS-PROGRAM-COUNTERS.                                         00740000
007500     05  WS-EDIPO-ROWS-FETCHED     PIC  9(09) VALUE ZEROS.        00750001
007700     05  WS-VNDAGR-INSERT-WRITTEN  PIC  9(09) VALUE ZEROS.        00770000
007800                                                                  00780000
007900 01  DISPLAY-ENT-ID                PIC 9(06) VALUE ZEROS.         00790005
008000                                                                  00800000
008300 01  PV-PROGRAM-VARIABLES.                                        00830000
008400     05  PV-MAX-SEQ-NBR            PIC S9(04) VALUE +0            00840000
008500                                                 COMP.            00850000
008600     05  PV-NEXT-SEQ-NBR           PIC S9(04) VALUE +0            00860000
008700                                                 COMP.            00870000
008800     COPY DPWS004.                                                00880006
008900                                                                  00890000
009000                                                                  00900000
009100 01  WS-ABEND-FIELDS.                                             00910000
009200     05  WS-ABEND-PROGRAM          PIC X(8)   VALUE 'VNKUP013'.   00920000
009300     05  WS-ABEND-PARAGRAPH        PIC X(50)  VALUE SPACES.       00930000
009400     05  WS-ABEND-OPERATION        PIC X(50)  VALUE SPACES.       00940000
009500     05  WS-ABEND-STRUCTURE-1      PIC X(8)   VALUE SPACES.       00950000
009600     05  WS-ABEND-STRUCTURE-2      PIC X(8)   VALUE SPACES.       00960000
009700     05  WS-ABEND-STATUS           PIC XX     VALUE SPACES.       00970000
009800                                                                  00980000
009900 01  ABEND-CODE                    PIC S9(4)  COMP SYNC           00990000
010000                                              VALUE ZEROS.        01000000
010100     88 AP-TABLE-FULL              VALUE +4004.                   01010000
010200     88 AP-EMPTY-FILE              VALUE +4005.                   01020000
010300     88 AP-DB2-ERROR               VALUE +4013.                   01030000
010400                                                                  01040000
010500******************************************************************01050000
010600*  COMMUNICATIONS AREA2 FOR DB2                                   01060000
010700******************************************************************01070000
010800     COPY SQLCA2.                                                 01080006
010900                                                                  01090000
011000     EXEC SQL                                                     01100000
011100          INCLUDE SQLCA                                           01110000
011200     END-EXEC.                                                    01120000
011300                                                                  01130000
011400     EXEC SQL                                                     01140000
011500          INCLUDE TTRDPRT                                         01150000
011600     END-EXEC.                                                    01160000
011700                                                                  01170000
011710     EXEC SQL                                                     01171000
011720          INCLUDE TTRDTRN                                         01172000
011730     END-EXEC.                                                    01173000
011740                                                                  01174000
011800     EXEC SQL                                                     01180000
011900          INCLUDE TVNDDPT                                         01190000
012000     END-EXEC.                                                    01200000
012100                                                                  01210000
012200     EXEC SQL                                                     01220000
012300          INCLUDE TVNDAGR                                         01230000
012400     END-EXEC.                                                    01240000
012500                                                                  01250000
012600                                                                  01260000
012700****************************************************************  01270000
012800**  THIS IS THE CURSOR THAT WILL RETRIEVE ALL ENT-ID/DEPT     **  01280000
012900**  COMBINATIONS THAT NEED TO BE SET UP FOR EDI-PO SERVICE    **  01290000
012910**  ON TVNDAGR.                                               **  01291000
013000****************************************************************  01300000
013100*                                                                 01310000
013200     EXEC SQL                                                     01320000
013300        DECLARE EDIPO_CSR CURSOR FOR                              01330000
013400         SELECT C.ENT_ID                                          01340000
013600               ,C.DEPT_NBR                                        01360000
013800               ,B.PROD_TEST_IND                                   01380000
014550           FROM TTRDPRT A                                         01455004
014560              , TTRDTRN B                                         01456004
014570              , TVNDDPT C                                         01457004
014580          WHERE A.INACTV_DTE = '9999-09-09'                       01458000
014590            AND A.TP_DKEY = B.TP_DKEY                             01459000
014591            AND B.INACTV_DTE = '9999-09-09'                       01459100
014592            AND B.TRAN_SET_CDE = '850'                            01459200
014594            AND A.ENT_ID = C.ENT_ID                               01459400
014595       ORDER BY C.ENT_ID,                                         01459500
014596                C.DEPT_NBR                                        01459600
014597     END-EXEC.                                                    01459700
014600****                                                              01460000
014700                                                                  01470000
016200                                                                  01620000
016300****                                                              01630000
016400                                                                  01640000
016500 01  FILLER                        PIC X(25) VALUE                01650000
016600          '<====WS FOR VNKUP013 ENDS'.                            01660000
016700                                                                  01670000
017100 PROCEDURE DIVISION.                                              01710000
017200                                                                  01720000
017300*                                                                 01730000
017400***************************************************************** 01740000
017500*  MAIN DRIVER FOR THE PROGRAM.                                   01750000
017600***************************************************************** 01760000
017700*                                                                 01770000
017800 A100-MAINLINE.                                                   01780000
017900                                                                  01790000
018000     PERFORM B100-HOUSEKEEPING.                                   01800000
018100                                                                  01810000
018200     PERFORM B200-PROCESS-EDIPO-CSR                               01820002
018300       UNTIL WS-END-OF-EDIPO-CSR.                                 01830002
018400                                                                  01840000
018700     PERFORM B300-END-OF-JOB.                                     01870002
018800                                                                  01880000
018900     GOBACK.                                                      01890000
019000        EJECT                                                     01900000
019100                                                                  01910000
019200*                                                                 01920000
019300***************************************************************** 01930000
019400*  INITIALIZATION AND THE FETCH OF THE EDIPO CURSOR.              01940001
019500***************************************************************** 01950000
019600*                                                                 01960000
019700 B100-HOUSEKEEPING.                                               01970000
019800                                                                  01980000
019900     INITIALIZE DCLTTRDPRT                                        01990001
019910                DCLTTRDTRN                                        01991001
019920                DCLTVNDDPT                                        01992001
019930                DCLTVNDAGR.                                       01993001
020000                                                                  02000000
020100     PERFORM Y700-OPEN-EDIPO-CURSOR.                              02010001
020200                                                                  02020000
020300     PERFORM R100-FETCH-EDIPO.                                    02030001
020400                                                                  02040000
020500     IF WS-EMPTY-EDIPO-CSR                                        02050001
020600        DISPLAY '**********************************'              02060000
020700        DISPLAY '*   EMPTY  EDIPO CURSOR          *'              02070001
020800        DISPLAY '*   PROGRAM ** = VNKUP013        *'              02080000
020900        DISPLAY '**********************************'              02090000
021000        MOVE 'B100-HOUSEKEEPING               '                   02100000
021100                      TO WS-ABEND-PARAGRAPH                       02110000
021200        MOVE 'NO ROWS WERE SELECTED     '                         02120000
021300                      TO WS-ABEND-OPERATION                       02130000
021400        MOVE 'TTRDPRT ' TO WS-ABEND-STRUCTURE-1                   02140001
021500        MOVE 'TTRDTRN ' TO WS-ABEND-STRUCTURE-2                   02150001
021600        PERFORM Z999-SQL-ERROR                                    02160000
021700     END-IF.                                                      02170000
021800                                                                  02180000
021810*                                                                 02181002
021820***************************************************************** 02182002
021830*  PROCESS EDIPO CURSOR RESULTS.                                  02183002
021840***************************************************************** 02184002
021850*                                                                 02185002
021860 B200-PROCESS-EDIPO-CSR.                                          02186002
021870                                                                  02187002
021893                                                                  02189302
021894     PERFORM R200-SELECT-VNDAGR.                                  02189402
021895                                                                  02189502
021896     IF  VNDAGR-NOT-FOUND                                         02189602
021897         PERFORM I100-TVNDAGR-INSERT                              02189702
021898     END-IF.                                                      02189802
021899                                                                  02189902
021900     PERFORM R100-FETCH-EDIPO.                                    02190002
021901                                                                  02190102
021910                                                                  02191000
022000*                                                                 02200000
022100***************************************************************** 02210000
022200*  END OF PROGRAM PROCESSING.                                     02220000
022300***************************************************************** 02230000
022400*                                                                 02240000
022500 B300-END-OF-JOB.                                                 02250002
022600                                                                  02260000
022700     DISPLAY 'EDIPO ROWS FETCHED       = '                        02270001
022800                                      WS-EDIPO-ROWS-FETCHED.      02280001
023100     DISPLAY 'TVNDAGR ROWS INSERTED      = '                      02310000
023200                                      WS-VNDAGR-INSERT-WRITTEN.   02320000
023300                                                                  02330000
023310     PERFORM Y800-CLOSE-EDIPO-CURSOR.                             02331002
023400                                                                  02340000
026900*                                                                 02690000
027000*----------------------------------------------------------------*02700000
027100*  INSERTS ROW ONTO TVNDAGR                                       02710000
027200*----------------------------------------------------------------*02720000
027300*                                                                 02730000
027400 I100-TVNDAGR-INSERT.                                             02740000
027500                                                                  02750000
027710     MOVE VNDDPT-ENT-ID           TO VNDAGR-ENT-ID.               02771005
027720     MOVE VNDDPT-DEPT-NBR         TO VNDAGR-DEPT-NBR.             02772005
027800     MOVE '4'                     TO VNDAGR-AGRMT-TYP-ID.         02780001
027900     PERFORM S600-GET-MAX-SEQ-NBR.                                02790000
028000     MOVE PV-NEXT-SEQ-NBR         TO VNDAGR-SEQ-NBR.              02800000
028100     MOVE 5                       TO VNDAGR-TYP-CDE.              02810000
028200***  MOVE '2001-01-16'            TO VNDAGR-EFFECTIVE-DATE        02820002
028300     MOVE '9999-12-31'            TO VNDAGR-EXPIRATION-DATE       02830000
028400     MOVE TRDTRN-PROD-TEST-IND    TO VNDAGR-PROD-STATUS-IND       02840003
029200                                                                  02920000
029300     PERFORM WITH TEST AFTER                                      02930000
029400        VARYING WS-RETRY-COUNTER FROM 1 BY 1                      02940000
029500        UNTIL   WS-RETRY-COUNTER > WS-RETRY-MAX OR                02950000
029600                SQLCODE = ZERO OR                                 02960000
029700                SQLCODE = +100                                    02970000
029800                                                                  02980000
029900         EXEC SQL                                                 02990000
030000              INSERT INTO TVNDAGR                                 03000000
030100                     ( ENT_ID                                     03010000
030200                      ,DEPT_NBR                                   03020000
030300                      ,AGRMT_TYP_ID                               03030000
030400                      ,SEQ_NBR                                    03040000
030500                      ,TYP_CDE                                    03050000
030600                      ,EFFECTIVE_DATE                             03060000
030700                      ,EXPIRATION_DATE                            03070000
030800                      ,PROD_STATUS_IND                            03080001
030900                      ,LAST_UPD_ID )                              03090000
031000              VALUES ( :VNDAGR-ENT-ID                             03100000
031100                      ,:VNDAGR-DEPT-NBR                           03110000
031200                      ,:VNDAGR-AGRMT-TYP-ID                       03120000
031300                      ,:VNDAGR-SEQ-NBR                            03130000
031400                      ,:VNDAGR-TYP-CDE                            03140000
031500                      ,CURRENT DATE                               03150003
031600                      ,:VNDAGR-EXPIRATION-DATE                    03160000
031700                      ,:VNDAGR-PROD-STATUS-IND                    03170001
031800                      ,'VNKUP013' )                               03180000
031900         END-EXEC                                                 03190000
032000     END-PERFORM.                                                 03200000
032100                                                                  03210000
032200     EVALUATE TRUE                                                03220000
032300         WHEN SQLCODE = ZERO                                      03230000
032400             ADD +1              TO WS-VNDAGR-INSERT-WRITTEN      03240000
032410              MOVE VNDDPT-ENT-ID TO DISPLAY-ENT-ID                03241005
032411              DISPLAY 'ADDING ENT ID = ' DISPLAY-ENT-ID           03241105
032420                      ' DEPT # = ' VNDDPT-DEPT-NBR                03242005
032500             CONTINUE                                             03250000
032600                                                                  03260000
032700         WHEN SQLWARN0 NOT = SPACES                               03270000
032800         WHEN SQLCODE  NOT = ZERO                                 03280000
032810              MOVE VNDDPT-ENT-ID TO DISPLAY-ENT-ID                03281005
032900              DISPLAY 'ENT ID = ' DISPLAY-ENT-ID                  03290005
033000              DISPLAY 'DEPT # = ' VNDDPT-DEPT-NBR                 03300000
033100              MOVE 'I100-TVNDAGR-INSERT              '            03310000
033200                           TO WS-ABEND-PARAGRAPH                  03320000
033300              MOVE 'UNSUCCESSFUL INSERT                 '         03330000
033400                            TO WS-ABEND-OPERATION                 03340000
033500              MOVE 'TVNDAGR ' TO WS-ABEND-STRUCTURE-1             03350000
033600              MOVE '        ' TO WS-ABEND-STRUCTURE-2             03360000
033700              PERFORM Z999-SQL-ERROR                              03370000
033800     END-EVALUATE.                                                03380000
033900*                                                                 03390000
034000***************************************************************** 03400000
034100*  FETCH THE VENDOR ENT ID.                                       03410000
034200***************************************************************** 03420000
034300*                                                                 03430000
034400 R100-FETCH-EDIPO.                                                03440001
034500                                                                  03450000
034600     PERFORM WITH TEST AFTER                                      03460000
034700        VARYING WS-RETRY-COUNTER FROM 1 BY 1                      03470000
034800        UNTIL   WS-RETRY-COUNTER > WS-RETRY-MAX OR                03480000
034900                SQLCODE = ZERO OR                                 03490000
035000                SQLCODE = +100                                    03500000
035100                                                                  03510000
035200        EXEC SQL                                                  03520000
035300            FETCH EDIPO_CSR                                       03530001
035400            INTO :VNDDPT-ENT-ID                                   03540001
035500                ,:VNDDPT-DEPT-NBR                                 03550001
035600                ,:TRDTRN-PROD-TEST-IND                            03560003
035700        END-EXEC                                                  03570000
035800                                                                  03580000
035900        EVALUATE TRUE                                             03590000
036000            WHEN SQLCODE = ZERO                                   03600000
036100                 ADD 1 TO WS-EDIPO-ROWS-FETCHED                   03610001
036200                 SET WS-FOUND-EDIPO-ROWS TO TRUE                  03620001
036300            WHEN SQLCODE = +100                                   03630000
036400              IF WS-FOUND-EDIPO-ROWS                              03640001
036500                  SET WS-END-OF-EDIPO-CSR TO TRUE                 03650001
036600              ELSE                                                03660000
036700                  SET WS-EMPTY-EDIPO-CSR TO TRUE                  03670001
036800              END-IF                                              03680000
036900            WHEN SQLCODE = -904                                   03690000
037000            WHEN SQLCODE = -913                                   03700000
037100              CONTINUE                                            03710000
037200            WHEN SQLWARN0 NOT = SPACES                            03720000
037300            WHEN SQLCODE  NOT = ZERO                              03730000
037400              MOVE 'R100-FETCH-EDIPO             '                03740001
037500                            TO WS-ABEND-PARAGRAPH                 03750000
037600              MOVE 'UNSUCCESSFUL FETCH  EDIPO'                    03760001
037700                            TO WS-ABEND-OPERATION                 03770000
037800              MOVE 'TTRDPRT ' TO WS-ABEND-STRUCTURE-1             03780001
037900              MOVE 'TTRDTRN ' TO WS-ABEND-STRUCTURE-2             03790001
038000              PERFORM Z999-SQL-ERROR                              03800000
038100           END-EVALUATE                                           03810000
038200     END-PERFORM.                                                 03820000
038300                                                                  03830000
038400     IF WS-RETRY-COUNTER > WS-RETRY-MAX                           03840000
038500         MOVE 'R100-FETCH-EDIPO             '                     03850001
038600                       TO WS-ABEND-PARAGRAPH                      03860000
038700         MOVE 'MAX RETRIES EXCEEDED ON FETCH  EDIPO'              03870001
038800                         TO WS-ABEND-OPERATION                    03880000
038900         PERFORM Z999-SQL-ERROR                                   03890000
039000     END-IF.                                                      03900000
039100*                                                                 03910000
039200***************************************************************** 03920000
039300*  SELECT THE VENDOR AGREEMENT ROW TO SEE IF IT ALREADY EXISTS    03930002
039310*  OR IF IT WILL NEED TO BE INSERTED.                             03931002
039400***************************************************************** 03940000
039500*                                                                 03950000
039600 R200-SELECT-VNDAGR.                                              03960002
039700                                                                  03970000
040310     EXEC SQL                                                     04031002
040320         SELECT ENT_ID                                            04032002
040330           INTO :VNDAGR-ENT-ID                                    04033002
040340           FROM TVNDAGR                                           04034002
040350          WHERE ENT_ID           = :VNDDPT-ENT-ID                 04035002
040351            AND DEPT_NBR         = :VNDDPT-DEPT-NBR               04035102
040360            AND AGRMT_TYP_ID     = '4'                            04036002
040370            AND TYP_CDE          = 5                              04037002
040380            AND EFFECTIVE_DATE   <= CURRENT DATE                  04038002
040390            AND EXPIRATION_DATE  >  CURRENT DATE                  04039002
040391     END-EXEC.                                                    04039102
040800                                                                  04080000
040900     EVALUATE TRUE                                                04090002
041000         WHEN SQLCODE = ZERO                                      04100002
041200              SET VNDAGR-FOUND TO TRUE                            04120002
041300         WHEN SQLCODE = +100                                      04130002
041500              SET VNDAGR-NOT-FOUND TO TRUE                        04150002
042200         WHEN SQLWARN0 NOT = SPACES                               04220002
042300         WHEN SQLCODE  NOT = ZERO                                 04230002
042310           DISPLAY 'ENT ID BEING PROCESSED = ' VNDDPT-ENT-ID      04231002
042320           DISPLAY 'DEPT BEING PROCESSED = ' VNDDPT-DEPT-NBR      04232002
042400           MOVE 'R200-SELECT-VNDAGR             '                 04240002
042500                         TO WS-ABEND-PARAGRAPH                    04250002
042600           MOVE 'UNSUCCESSFUL SELECT TVNDAGR'                     04260002
042700                         TO WS-ABEND-OPERATION                    04270002
042800           MOVE 'TVNDAGR ' TO WS-ABEND-STRUCTURE-1                04280002
042900           MOVE '        ' TO WS-ABEND-STRUCTURE-2                04290002
043000           PERFORM Z999-SQL-ERROR                                 04300002
043100        END-EVALUATE.                                             04310002
044100                                                                  04410000
044200*----------------------------------------------------------------*04420000
044300*    FIND THE ROW WITH THE HIGHEST SEQUENCE NUMBER WITHIN A TYPE  04430000
044400*----------------------------------------------------------------*04440000
044500                                                                  04450000
044600 S600-GET-MAX-SEQ-NBR.                                            04460000
044700                                                                  04470000
044800     PERFORM                                                      04480000
044900         WITH TEST AFTER                                          04490000
045000         VARYING WS-RETRY-COUNTER                                 04500000
045100         FROM 1 BY 1                                              04510000
045200         UNTIL ((WS-RETRY-COUNTER > WS-RETRY-MAX)                 04520000
045300             OR (SQLCODE = +0)                                    04530000
045400             OR (SQLCODE = -305))                                 04540000
045500                                                                  04550000
045600         EXEC SQL                                                 04560000
045700              SELECT MAX(SEQ_NBR)                                 04570000
045800                INTO :PV-MAX-SEQ-NBR                              04580000
045900                FROM TVNDAGR                                      04590000
046000               WHERE ENT_ID            = :VNDAGR-ENT-ID           04600000
046100                 AND DEPT_NBR          = :VNDAGR-DEPT-NBR         04610000
046200                 AND AGRMT_TYP_ID      = :VNDAGR-AGRMT-TYP-ID     04620000
046300         END-EXEC                                                 04630000
046400                                                                  04640000
046500         EVALUATE TRUE                                            04650000
046600             WHEN SQLCODE = +0                                    04660000
046700                  COMPUTE PV-NEXT-SEQ-NBR =                       04670000
046800                          PV-MAX-SEQ-NBR + 1                      04680000
046900             WHEN SQLCODE = -305                                  04690000
047000                  MOVE +1         TO PV-NEXT-SEQ-NBR              04700000
047100                                                                  04710000
047200             WHEN SQLCODE = -904                                  04720000
047300             WHEN SQLCODE = -913                                  04730000
047400                  CONTINUE                                        04740000
047500                                                                  04750000
047600             WHEN SQLWARN0 NOT = SPACES                           04760000
047700             WHEN SQLCODE < +0                                    04770000
047800             WHEN SQLCODE > +0                                    04780000
047900                  MOVE 'S600-GET-MAX-SEQ-NBR'                     04790000
048000                                  TO WS-ABEND-PARAGRAPH           04800000
048100                  MOVE 'UNSUCCESSFUL SELECT MAX SEQ NBR'          04810000
048200                                  TO WS-ABEND-OPERATION           04820000
048300                  MOVE 'TVNDAGR ' TO WS-ABEND-STRUCTURE-1         04830000
048400                  MOVE SPACE      TO WS-ABEND-STRUCTURE-2         04840000
048500                  PERFORM Z999-SQL-ERROR                          04850000
048600         END-EVALUATE                                             04860000
048700     END-PERFORM.                                                 04870000
048800                                                                  04880000
048900     IF  WS-RETRY-COUNTER > WS-RETRY-MAX                          04890000
049000         MOVE 'S600-GET-MAX-SEQ-NBR'                              04900000
049100                                  TO WS-ABEND-PARAGRAPH           04910000
049200         MOVE 'MAX RETRIES EXCEEDED ON SELECT MAX SEQ NBR'        04920000
049300                                  TO WS-ABEND-OPERATION           04930000
049400         MOVE 'TVNDAGR '          TO WS-ABEND-STRUCTURE-1         04940000
049500         MOVE SPACE               TO WS-ABEND-STRUCTURE-2         04950000
049600         PERFORM Z999-SQL-ERROR                                   04960000
049700     END-IF.                                                      04970000
049800                                                                  04980000
049900*                                                                 04990000
050000***************************************************************** 05000000
050100*  OPEN EDIPO CURSOR                                              05010001
050200***************************************************************** 05020000
050300*                                                                 05030000
050400 Y700-OPEN-EDIPO-CURSOR.                                          05040001
050500                                                                  05050000
050600     PERFORM WITH TEST AFTER                                      05060000
050700             VARYING WS-RETRY-COUNTER FROM 1 BY 1                 05070000
050800             UNTIL   WS-RETRY-COUNTER > WS-RETRY-MAX OR           05080000
050900                     SQLCODE = ZERO                               05090000
051000                                                                  05100000
051100             EXEC SQL                                             05110000
051200                OPEN EDIPO_CSR                                    05120001
051300             END-EXEC                                             05130000
051400                                                                  05140000
051500             EVALUATE TRUE                                        05150000
051600                 WHEN SQLCODE = ZERO                              05160000
051700                      SET WS-NEW-EDIPO-ROWS TO TRUE               05170001
051800                      SET WS-NOT-END-OF-EDIPO-CSR TO TRUE         05180001
051900                      CONTINUE                                    05190000
052000                 WHEN SQLCODE = -904                              05200000
052100                 WHEN SQLCODE = -913                              05210000
052200                      CONTINUE                                    05220000
052300                                                                  05230000
052400                 WHEN SQLWARN0 NOT = SPACES                       05240000
052500                 WHEN SQLCODE  NOT = ZERO                         05250000
052600                      MOVE 'Y700-OPEN-EDIPO-CURSOR         '      05260001
052700                                    TO WS-ABEND-PARAGRAPH         05270000
052800                      MOVE 'UNSUCCESSFUL OPEN   EDIPO'            05280001
052900                                    TO WS-ABEND-OPERATION         05290000
053000                      MOVE 'TTRDPRT ' TO WS-ABEND-STRUCTURE-1     05300001
053100                      MOVE 'TTRDTRN ' TO WS-ABEND-STRUCTURE-2     05310001
053200                      PERFORM Z999-SQL-ERROR                      05320000
053300             END-EVALUATE                                         05330000
053400     END-PERFORM.                                                 05340000
053500                                                                  05350000
053600     IF WS-RETRY-COUNTER > WS-RETRY-MAX                           05360000
053700         MOVE 'Y700-OPEN-EDIPO-CURSOR         '                   05370001
053800                       TO WS-ABEND-PARAGRAPH                      05380000
053900         MOVE 'MAX RETRIES EXCEEDED ON OPEN   EDIPO'              05390001
054000                         TO WS-ABEND-OPERATION                    05400000
054100         PERFORM Z999-SQL-ERROR.                                  05410000
054200                                                                  05420000
054300                                                                  05430000
054400*                                                                 05440000
054500***************************************************************** 05450000
054600*  CLOSE EDIPO CURSOR                                             05460001
054700***************************************************************** 05470000
054800*                                                                 05480000
054900 Y800-CLOSE-EDIPO-CURSOR.                                         05490001
055000                                                                  05500000
055100     PERFORM WITH TEST AFTER                                      05510000
055200             VARYING WS-RETRY-COUNTER FROM 1 BY 1                 05520000
055300             UNTIL   WS-RETRY-COUNTER > WS-RETRY-MAX OR           05530000
055400                     SQLCODE = ZERO                               05540000
055500                                                                  05550000
055600             EXEC SQL                                             05560000
055700                CLOSE EDIPO_CSR                                   05570001
055800             END-EXEC                                             05580000
055900                                                                  05590000
056000             EVALUATE TRUE                                        05600000
056100                 WHEN SQLCODE = ZERO                              05610000
056200                 WHEN SQLCODE = -904                              05620000
056300                 WHEN SQLCODE = -913                              05630000
056400                      CONTINUE                                    05640000
056500                                                                  05650000
056600                 WHEN SQLWARN0 NOT = SPACES                       05660000
056700                 WHEN SQLCODE  NOT = ZERO                         05670000
056800                      MOVE 'Y800-CLOSE-EDIPO-CURSOR         '     05680001
056900                                    TO WS-ABEND-PARAGRAPH         05690000
057000                      MOVE 'UNSUCCESSFUL CLOSE  EDIPO'            05700001
057100                                    TO WS-ABEND-OPERATION         05710000
057200                      MOVE 'TTRDPRT ' TO WS-ABEND-STRUCTURE-1     05720001
057300                      MOVE 'TTRDTRN ' TO WS-ABEND-STRUCTURE-2     05730001
057400                      PERFORM Z999-SQL-ERROR                      05740000
057500             END-EVALUATE                                         05750000
057600     END-PERFORM.                                                 05760000
057700                                                                  05770000
057800     IF WS-RETRY-COUNTER > WS-RETRY-MAX                           05780000
057900         MOVE 'Y800-CLOSE-EDIPO-CURSOR         '                  05790001
058000                       TO WS-ABEND-PARAGRAPH                      05800000
058100         MOVE 'MAX RETRIES EXCEEDED ON CLOSE  EDIPO'              05810001
058200                         TO WS-ABEND-OPERATION                    05820000
058300         PERFORM Z999-SQL-ERROR.                                  05830000
058400                                                                  05840000
067200*                                                                 06720000
067300***************************************************************** 06730000
067400*  PROCESS DB2 ABENDS.                                            06740000
067500***************************************************************** 06750000
067600*                                                                 06760000
067700 Z999-SQL-ERROR.                                                  06770000
067800                                                                  06780000
067900     DISPLAY '*** DB2 ERROR '.                                    06790000
068000     DISPLAY '*** PROGRAM   = ' WS-ABEND-PROGRAM.                 06800000
068100     DISPLAY '*** PARAGRAPH = ' WS-ABEND-PARAGRAPH.               06810000
068200     DISPLAY '*** OPERATION = ' WS-ABEND-OPERATION.               06820000
068300     DISPLAY '*** TABLE 1   = ' WS-ABEND-STRUCTURE-1.             06830000
068400     IF WS-ABEND-STRUCTURE-2 > SPACES                             06840000
068500         DISPLAY '*** TABLE 2   = ' WS-ABEND-STRUCTURE-2.         06850000
068600                                                                  06860000
068700     SET AP-DB2-ERROR              TO TRUE.                       06870000
068800                                                                  06880000
068900     COPY DPPD004.                                                06890006
069000     CALL 'ILBOABN0' USING ABEND-CODE.                            06900000
069100                                                                  06910000
