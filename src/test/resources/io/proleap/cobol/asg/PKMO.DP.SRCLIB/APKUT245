000010*----------------------------*                                    00001000
000100 IDENTIFICATION DIVISION.                                         00010000
000110*----------------------------*                                    00011000
000200 PROGRAM-ID.         APKUT245.                                    00020000
000300 AUTHOR.             CHRIS BOEHNLEIN.                             00030000
000400 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00040000
000500 DATE-WRITTEN.       04-21-98.                                    00050000
000600                                                                  00060000
000610******************************************************************00061000
000620* COBOL II WITH SQL                                              *00062000
000630*----------------------------------------------------------------*00063000
000640* CREATE MONTHLY DETAIL IMPORT REPORTS                           *00064008
000650*----------------------------------------------------------------*00065000
000660* THIS PROGRAM PERFORMS DB2 CALLS AGAINST THE LEGACY SYSTEM TO   *00066000
000670* DETERMINE WHAT ENTRIES WERE MADE FOR THE IMPORT PURCHASE       *00067000
000680* ORDERS FROM THE ADJUSTMENT JOURNAL FOR THE PREVIOUS FISCAL     *00068000
000690* MONTH.  THIS PROGRAM FOCUSES SPECIFICALLY ON ACCOUNT 10303.    *00069000
000691*----------------------------------------------------------------*00069100
000692* DB2 TABLES:                                                    *00069200
000693*   1. INVOICE TABLE                         (TINVOIC)           *00069300
000694*   2. MERCHANDISE INVOICE TABLE             (TMDINVC)           *00069400
000695*   3. AP CHARGE TYPE TABLE                  (TACCTYP)           *00069500
000696*   4. VENDOR/DEPARTMENT TABLE               (TVNDDPT)           *00069600
000697*   5. PURCHASE ORDER HEADER TABLE           (TPURCHS)           *00069700
000698*   6. EXTERNAL ENTERPRISE TABLE             (TEXTENT)           *00069800
000699*   7. AP PAYMENT CONTROL TABLE              (TAPCNTL)           *00069900
000700*                                                                *00070000
000701* INPUT:                                                         *00070100
000702*   1. DETAIL IMPORT FILE                    (APRD047)           *00070200
000703*   2. DETAIL ACCOUNT IMPORT FILE            (APRD047)           *00070300
000704*                                                                *00070400
000705* OUTPUT:                                                        *00070500
000706*   1. IMPORT PURCHASE ORDERS FILE                               *00070600
000707*----------------------------------------------------------------*00070700
000708* PROGRAM CHANGES:                                               *00070800
000709*                                                                *00070900
000710* DATE 08/2005                                                   *00071000
000711*    CHANGE MADE: INTIAL IMPLEMENTATION                          *00071101
000715*    MADE BY: KRYSTEN LEARY                 WR/IR: WR24554       *00071500
000716*                                                                 00071609
000717* DATE 09/2018                                                   *00071709
000718*   CHANGE MADE: REMOVE COPYBOOK PJRNLEXT. REPLACE REFERENCE     *00071809
000719*                TO PJR-DETAIL-PONUM WITH PV-DISPLAY-PONUM IN    *00071909
000720*                PARAGRAPH S800-READ-DUNNS-NBR                   *00072009
000721*   MADE BY: GERMAN BANDA                    WR/IR: CHG0209715   *00072110
000722******************************************************************00072200
000723                                                                  00072300
000730 ENVIRONMENT DIVISION.                                            00073000
000800 CONFIGURATION SECTION.                                           00080000
000900 SOURCE-COMPUTER.    IBM-3090.                                    00090000
001000 OBJECT-COMPUTER.    IBM-3090.                                    00100000
001100                                                                  00110000
001200 INPUT-OUTPUT SECTION.                                            00120000
001300 FILE-CONTROL.                                                    00130000
001400                                                                  00140000
001500     SELECT DETAIL-IMPORT-FILE-PJ      ASSIGN TO INP01.           00150000
001700     SELECT DETAIL-ACCT-IMPORT-FILE-PJ ASSIGN TO INP02.           00170000
001900     SELECT WORK-REPORT-FILE           ASSIGN TO OUT01.           00190000
002100                                                                  00210000
002200 DATA DIVISION.                                                   00220000
002400 FILE SECTION.                                                    00240000
002500                                                                  00250000
002600 FD  DETAIL-IMPORT-FILE-PJ                                        00260000
002700     RECORDING MODE IS F                                          00270000
002800     LABEL RECORDS ARE STANDARD                                   00280000
002900     RECORD CONTAINS 170 CHARACTERS                               00290000
003000     BLOCK CONTAINS 0  RECORDS                                    00300000
003100     DATA RECORD IS DR-DETAIL-IMPORT-RECORD-PJ.                   00310000
003200 01  DR-IMPORT-RECORD-PJ          PIC X(170).                     00320000
003300                                                                  00330000
003400 FD  DETAIL-ACCT-IMPORT-FILE-PJ                                   00340000
003500     RECORDING MODE IS F                                          00350000
003600     LABEL RECORDS ARE STANDARD                                   00360000
003700     RECORD CONTAINS 170 CHARACTERS                               00370000
003800     BLOCK CONTAINS 0  RECORDS                                    00380000
003900     DATA RECORD IS DR-ACCT-IMPORT-RECORD-PJ.                     00390000
004000 01  DR-ACCT-IMPORT-RECORD-PJ      PIC X(170).                    00400000
004100                                                                  00410000
004200 FD  WORK-REPORT-FILE                                             00420000
004300     RECORDING MODE IS F                                          00430000
004400     LABEL RECORDS ARE STANDARD                                   00440000
004500     RECORD CONTAINS 168 CHARACTERS                               00450000
004600     BLOCK CONTAINS 0  RECORDS                                    00460000
004700     DATA RECORD IS WR-WORK-REPORT-RECORD.                        00470000
004800 01  WR-WORK-REPORT-RECORD         PIC X(168).                    00480000
004900                                                                  00490000
005100 WORKING-STORAGE SECTION.                                         00510000
005200*----------------------------------------------------------------*00520000
005210* GL EXTRACT FILE LAYOUT (INPUT)                                 *00521000
005220*----------------------------------------------------------------*00522000
005300     COPY APRD047.                                                00530000
005310                                                                  00531000
005420*----------------------------------------------------------------*00542000
005430* WORKING STORAGE FOR DATE ROUTINE                               *00543000
005440*----------------------------------------------------------------*00544000
005500     COPY DPWS500.                                                00550000
005510                                                                  00551000
005520*----------------------------------------------------------------*00552000
005530* SQLCA FORMATTED MESSAGE AREA                                   *00553000
005540*----------------------------------------------------------------*00554000
005600     COPY DPWS004.                                                00560000
005700                                                                  00570000
005800*----------------------------------------------------------------*00580000
005900* DB2 COMMUNICATIONS                                             *00590000
006000*----------------------------------------------------------------*00600000
006010     COPY SQLCA2.                                                 00601000
006020                                                                  00602000
016200 01  PROGRAM-CONSTANTS.                                           01620000
016300     05  PC-PROGRAM-NAME           PIC X(08)  VALUE 'APKUT245'.   01630000
016310     05  PC-MAX-RETRIES            PIC 9(02)  VALUE 3.            01631000
016400                                                                  01640000
016401 01  PROGRAM-COUNTERS.                                            01640100
016402     05  PV-ACCT-READ-CNT          PIC 9(08)  VALUE ZERO.         01640200
016403     05  PV-IMPORT-READ-CNT        PIC 9(08)  VALUE ZERO.         01640300
016404     05  PV-WRITTEN-CNT            PIC 9(08)  VALUE ZERO.         01640400
016405                                                                  01640500
016410 01  PROGRAM-SWITCHES.                                            01641000
016411     05  END-OF-FILE-IMPORT-PJ     PIC X(01)  VALUE 'N'.          01641100
016412         88 END-OF-FILE-IMPORT                VALUE 'Y'.          01641200
016413     05  PS-MORE-TINVOIC           PIC X(01)  VALUE 'N'.          01641300
016414         88 PS-NO-MORE-TINVOIC                VALUE 'Y'.          01641400
016416     05  END-OF-FILE-NO-ACCT       PIC X(01)  VALUE 'N'.          01641600
016417         88 END-OF-FILE-ACCT                  VALUE 'Y'.          01641700
016418                                                                  01641800
016420 01  PROGRAM-VARIABLES.                                           01642000
016430     05  PV-RETRY-COUNTER          PIC 9(02)  VALUE ZEROS.        01643000
016431     05  PV-FIRST-FISCAL-DATE      PIC X(10)  VALUE SPACES.       01643100
016432     05  PV-LAST-FISCAL-DATE       PIC X(10)  VALUE SPACES.       01643200
016433     05  PV-DISPLAY-PONUM          PIC X(09)  VALUE SPACES.       01643309
016440                                                                  01644000
016500 01  ACCOUNT-TABLE.                                               01650000
016600     05 ACCT-TABLE OCCURS 100000 TIMES INDEXED BY X1.             01660000
016700        10 ACCT-PO                 PIC X(09)  VALUE SPACES.       01670000
016900        10 ACCT-DATE               PIC X(10)  VALUE SPACES.       01690000
017000                                                                  01700000
018000 01 WS-WORKING-STORAGE.                                           01800000
018100    05  WS-DB2-ACCOUNT.                                           01810000
018300        10  WS-DB2-ACCT       PIC X(05)     VALUE SPACES.         01830000
018400    05  WS-DB2-ACCOUNT2       PIC X(07)     VALUE SPACES.         01840000
018500    05  WS-DETAIL-PONUM       PIC 9(09)     VALUE ZERO.           01850000
018510    05  WS-DUNNS-NUMBER       PIC X(9)      VALUE SPACES.         01851000
018520    05  WS-DT-PONUM           PIC S9(9)     COMP.                 01852000
018530    05  WS-DM-TOTAL           PIC S9(11)V99 COMP-3 VALUE ZERO.    01853000
018550    05  WS-CM-TOTAL           PIC S9(11)V99 VALUE ZERO COMP-3.    01855000
018560    05  WS-JN-DATE            PIC X(10)     VALUE SPACES.         01856000
018570    05  WS-HD-PO              PIC 9(09)     VALUE ZEROS.          01857000
018580    05  WS-HD-DATE            PIC X(10)     VALUE SPACES.         01858000
018590    05  WS-INVOIC-PO-NBR      PIC S9(9)     COMP.                 01859000
018591    05  WS-REQ-ENTR-TRMNL-ID  PIC X(04)     VALUE SPACES.         01859100
018592    05  WS-HOLD-ACCT          PIC X(06)     VALUE SPACES.         01859200
021900                                                                  02190000
023400 01 DH-DETAIL-LINE1.                                              02340000
023500    05  FILLER                PIC X(02)     VALUE SPACES.         02350000
023600    05  DH-ACCOUNT            PIC X(07)     VALUE SPACES.         02360000
023700    05  FILLER                PIC X(02)     VALUE SPACES.         02370000
023800    05  DH-PO-DUNNS           PIC X(09)     VALUE SPACES.         02380000
023900    05  FILLER                PIC X(02)     VALUE SPACES.         02390000
024000    05  DH-PO-NUMBER          PIC X(10)     VALUE SPACES.         02400000
024100    05  FILLER                PIC X(04)     VALUE SPACES.         02410000
024200    05  DH-PO-INV             PIC X(10)     VALUE SPACES.         02420000
024300    05  FILLER                PIC X(04)     VALUE SPACES.         02430000
024400    05  DH-PJ-SOURCE          PIC X(02)     VALUE SPACES.         02440000
024500    05  FILLER                PIC X(02)     VALUE SPACES.         02450000
024600    05  DH-PJ-TERM            PIC X(04)     VALUE SPACES.         02460000
024700    05  FILLER                PIC X(02)     VALUE SPACES.         02470000
024800    05  DH-DEBIT-TOTAL        PIC ---,---,---.99.                 02480000
024900    05  FILLER                PIC X(02)     VALUE SPACES.         02490000
025000    05  DH-DM-MONTH           PIC 9(02)     VALUE ZEROS.          02500000
025100    05  FILLER                PIC X(01)     VALUE '-'.            02510000
025200    05  DH-DM-DAY             PIC 9(02)     VALUE ZEROS.          02520000
025300    05  FILLER                PIC X(01)     VALUE '-'.            02530000
025400    05  DH-DM-YEAR            PIC 9(02)     VALUE ZEROS.          02540000
025500    05  FILLER                PIC X(06)     VALUE SPACES.         02550000
025600    05  DH-CREDIT-TOTAL       PIC ---,---,---.99.                 02560000
025700    05  FILLER                PIC X(03)     VALUE SPACES.         02570000
025800    05  DH-CM-MONTH           PIC 9(02)     VALUE ZEROS.          02580000
025900    05  FILLER                PIC X(01)     VALUE '-'.            02590000
026000    05  DH-CM-DAY             PIC 9(02)     VALUE ZEROS.          02600000
026100    05  FILLER                PIC X(01)     VALUE '-'.            02610000
026200    05  DH-CM-YEAR            PIC 9(02)     VALUE ZEROS.          02620000
026300    05  FILLER                PIC X(05)     VALUE SPACES.         02630000
026400    05  DH-JN-MONTH           PIC 9(02)     VALUE ZEROS.          02640000
026500    05  FILLER                PIC X(01)     VALUE '-'.            02650000
026600    05  DH-JN-DAY             PIC 9(02)     VALUE ZEROS.          02660000
026700    05  FILLER                PIC X(01)     VALUE '-'.            02670000
026800    05  DH-JN-YEAR            PIC 9(02)     VALUE ZEROS.          02680000
026900    05  FILLER                PIC X(02)     VALUE SPACES.         02690000
027000    05  DH-INV                PIC ---,---,---.99.                 02700000
027100    05  FILLER                PIC X(02)     VALUE SPACES.         02710000
027200    05  DH-PPR                PIC ---,---,---.99.                 02720000
027300                                                                  02730000
027410*----------------------------------------------------------------*02741000
027420* ABEND CODE AREA                                                *02742000
027430*----------------------------------------------------------------*02743000
027440 01  ABEND-CODE                  PIC S9(04)  VALUE ZERO.          02744000
027450     88  AC-BAD-DATA                         VALUE +4003.         02745000
027460     88  AC-DB2-ERROR                        VALUE +4013.         02746000
027470                                                                  02747000
027480 01  ABEND-AREAS.                                                 02748000
027490     05  AA-ABEND-LIT            PIC X(40)   VALUE                02749000
027491           '*****       ABEND'.                                   02749100
027492     05  AA-PROGRAM-LIT          PIC X(40)   VALUE                02749200
027493             '*****   PROGRAM:         '.                         02749300
027494     05  AA-PARAGRAPH-LIT.                                        02749400
027495         10  FILLER              PIC X(17)   VALUE                02749500
027496             '***** PARAGRAPH: '.                                 02749600
027497         10  AA-PARAGRAPH-NAME   PIC X(35)   VALUE SPACES.        02749700
027498     05  AA-MESSAGE-LINE.                                         02749800
027499         10  FILLER              PIC X(06)   VALUE '*****'.       02749900
027500         10  AA-MESSAGE          PIC X(127)  VALUE SPACES.        02750000
027501     05  AA-DB2-ERROR-LIT        PIC X(40)   VALUE                02750100
027502             '*****    DB2 ERROR'.                                02750200
027503     05  AA-DB2-OPERATION-LIT.                                    02750300
027504         10  FILLER              PIC X(17)   VALUE                02750400
027505             '***** OPERATION: '.                                 02750500
027506         10  AA-DB2-OPERATION.                                    02750600
027507             15  AA-DB2-OP-1     PIC X(25)   VALUE SPACES.        02750700
027508             15  AA-DB2-OP-2     PIC X(25)   VALUE SPACES.        02750800
027509     05  AA-DB2-TABLE-1          PIC X(08)   VALUE SPACES.        02750900
027510     05  AA-DB2-TABLE-2          PIC X(08)   VALUE SPACES.        02751000
027511     05  AA-DB2-TABLE-3          PIC X(08)   VALUE SPACES.        02751100
027512     05  AA-DB2-TABLE-4          PIC X(08)   VALUE SPACES.        02751200
027513                                                                  02751300
027514*----------------------------------------------------------------*02751400
027515* EXTERNAL ENTERPRISE TABLE                                      *02751500
027516*----------------------------------------------------------------*02751600
027517     EXEC SQL                                                     02751700
027518        INCLUDE TEXTENT                                           02751800
027519     END-EXEC.                                                    02751900
027520                                                                  02752000
027521*----------------------------------------------------------------*02752100
027522* AP PAYMENT CONTROL TABLE                                       *02752200
027523*----------------------------------------------------------------*02752300
027524     EXEC SQL                                                     02752400
027525        INCLUDE TAPCNTL                                           02752500
027526     END-EXEC.                                                    02752600
027527                                                                  02752700
027528*----------------------------------------------------------------*02752800
027529* PURCHASE ORDER HEADER TABLE                                    *02752900
027530*----------------------------------------------------------------*02753000
027531     EXEC SQL                                                     02753100
027532        INCLUDE TPURCHS                                           02753200
027533     END-EXEC.                                                    02753300
027534                                                                  02753400
027535*----------------------------------------------------------------*02753500
027536* INVOICE TABLE                                                  *02753600
027537*----------------------------------------------------------------*02753700
027540     EXEC SQL                                                     02754000
027550        INCLUDE TINVOIC                                           02755000
027560     END-EXEC.                                                    02756000
027570                                                                  02757000
027571*----------------------------------------------------------------*02757100
027572* AP CHARGE TYPE TABLE                                           *02757200
027573*----------------------------------------------------------------*02757300
027580     EXEC SQL                                                     02758000
027590        INCLUDE TACCTYP                                           02759000
027600     END-EXEC.                                                    02760000
027700                                                                  02770000
027710*----------------------------------------------------------------*02771000
027720* MERCHANDISE INVOICE TABLE                                      *02772000
027730*----------------------------------------------------------------*02773000
027800     EXEC SQL                                                     02780000
027900        INCLUDE TMDINVC                                           02790000
028000     END-EXEC.                                                    02800000
028100                                                                  02810000
028110*----------------------------------------------------------------*02811000
028120* VENDOR/DEPARTMENT TABLE                                        *02812000
028130*----------------------------------------------------------------*02813000
028200     EXEC SQL                                                     02820000
028300        INCLUDE TVNDDPT                                           02830000
028400     END-EXEC.                                                    02840000
028500                                                                  02850000
028501*----------------------------------------------------------------*02850100
028502* DB2 COMMUNCIATIONS                                             *02850200
028503*----------------------------------------------------------------*02850300
028510     EXEC SQL                                                     02851000
028520        INCLUDE SQLCA                                             02852000
028530     END-EXEC.                                                    02853000
028540                                                                  02854000
028600*----------------------------------------------------------------*02860000
028700* CURSOR DECLARATIONS                                            *02870000
028800*----------------------------------------------------------------*02880000
028900     EXEC SQL                                                     02890000
029000         DECLARE INVOICE_CSR CURSOR FOR                           02900000
029100              SELECT                                              02910000
029200                   I.PO_NBR                                       02920000
029300                  ,I.GRO_COST_AMT                                 02930000
029400                  ,'      '                                       02940000
029500                  ,I.INVC_ID                                      02950000
029600                  ,I.PPD_RVRSL_IND                                02960000
029700              FROM TINVOIC I                                      02970000
029800                  ,TMDINVC A                                      02980000
029900                  ,TACCTYP T                                      02990000
030300              WHERE A.IMPRT_CHRG_PRC_CDE = T.ALW_CHRG_CDE         03030000
030310                AND A.PO_NBR = I.PO_NBR                           03031000
030320                AND A.INVC_ID = I.INVC_ID                         03032000
030400                AND I.INVC_TYP_CDE = 'MI'                         03040000
030500                AND I.STATUS_CDE ^= 'DE'                          03050000
030510                AND I.STATUS_CDE ^= 'PR'                          03051000
030810                AND I.CRE_DTE  >= :PV-FIRST-FISCAL-DATE           03081007
030820                AND I.CRE_DTE  <= :PV-LAST-FISCAL-DATE            03082007
030830                AND T.GL_ACCT_NBR = :WS-DB2-ACCOUNT2              03083002
030900              ORDER BY I.PO_NBR                                   03090000
031000     END-EXEC.                                                    03100000
031100                                                                  03110000
031200*-----------------------*                                         03120000
031300 PROCEDURE DIVISION.                                              03130000
031400*-----------------------*                                         03140000
031500 0000-MAINLINE-PROCESSING.                                        03150000
031600                                                                  03160000
031700     PERFORM B100-INITIALIZATION.                                 03170000
031800     PERFORM B200-PROCESS-EXTRACT                                 03180000
031900             UNTIL END-OF-FILE-IMPORT AND                         03190000
032000                   PS-NO-MORE-TINVOIC.                            03200000
032010     PERFORM B300-TERMINATION.                                    03201000
032500     STOP RUN.                                                    03250000
032600                                                                  03260000
032610*----------------------------------------------------------------*03261000
032620* INITIALIZATION PROCESSING                                      *03262000
032630*----------------------------------------------------------------*03263000
032700 B100-INITIALIZATION.                                             03270000
032800                                                                  03280000
032900     OPEN INPUT  DETAIL-IMPORT-FILE-PJ                            03290000
033000                 DETAIL-ACCT-IMPORT-FILE-PJ                       03300000
033100          OUTPUT WORK-REPORT-FILE.                                03310000
033110                                                                  03311000
033120     INITIALIZE DCLTEXTENT                                        03312000
033130                DCLTVNDDPT                                        03313000
033140                DCLTPURCHS                                        03314000
033150                DCLTINVOIC                                        03315000
033160                DCLTMDINVC                                        03316000
033170                DCLTACCTYP                                        03317000
033180                DCLTAPCNTL.                                       03318000
033190                                                                  03319000
033192     PERFORM S100-SELECT-PREV-FISCAL-DATA.                        03319207
033193     PERFORM S200-GET-FIRST-LAST-FISCAL-DT.                       03319307
033200     PERFORM S300-GET-ACCT-IMPORT-DATA.                           03320000
033400     PERFORM R100-READ-IMPORT-FILE-PJ.                            03340000
033600     MOVE AP047-GL-ACCT-NBR     TO WS-HOLD-ACCT.                  03360000
033700     MOVE WS-HOLD-ACCT          TO WS-DB2-ACCT.                   03370000
035100     MOVE WS-DB2-ACCOUNT        TO WS-DB2-ACCOUNT2.               03510000
035200     PERFORM Y100-OPEN-INVOICE-CSR.                               03520000
035300     PERFORM S400-FETCH-INVOICE-CSR.                              03530000
035400                                                                  03540000
035410*----------------------------------------------------------------*03541000
035420* THIS ROUTINE HOLDS THE MAIN LOGIC FOR PROCESSING THE OUTPUT    *03542000
035430*----------------------------------------------------------------*03543000
035500 B200-PROCESS-EXTRACT.                                            03550000
035600                                                                  03560000
035700     DISPLAY 'PO - ' AP047-ENT-NME-DESC (1:9).                    03570000
035900     EVALUATE TRUE                                                03590000
036000     WHEN INVOIC-PO-NBR = WS-DETAIL-PONUM                         03600000
036100        INITIALIZE DH-DETAIL-LINE1                                03610000
036200        MOVE INVOIC-PO-NBR              TO WS-DT-PONUM            03620000
036300        PERFORM S800-READ-DUNNS-NBR                               03630000
036400        MOVE WS-DUNNS-NUMBER            TO DH-PO-DUNNS            03640000
036600        MOVE AP047-DOC-NBR              TO DH-PO-INV              03660000
036700        MOVE WS-HOLD-ACCT               TO DH-ACCOUNT             03670000
036800        MOVE INVOIC-PO-NBR              TO DH-PO-NUMBER           03680000
036900        MOVE INVOIC-GRO-COST-AMT        TO DH-INV                 03690000
037000        MOVE WS-REQ-ENTR-TRMNL-ID       TO DH-PJ-TERM             03700000
037100        PERFORM W100-WRITE-WORK-REPORT-FILE                       03710000
037200        MOVE ZEROS                      TO DH-INV                 03720000
037600        IF AP047-AP-TRN-CDE   = '68' OR '73'                      03760000
037900           MOVE AP047-GRO-COST-AMT      TO DH-DEBIT-TOTAL         03790000
038000           ADD AP047-GRO-COST-AMT       TO WS-DM-TOTAL            03800000
038100        ELSE                                                      03810000
038200           MOVE INVOIC-PO-NBR           TO WS-INVOIC-PO-NBR       03820000
038410           IF INVOIC-PPD-RVRSL-IND = 'Y'                          03841000
038420              MOVE AP047-GRO-COST-AMT   TO DH-PPR                 03842000
038430           END-IF                                                 03843000
038700           MOVE AP047-GRO-COST-AMT      TO DH-CREDIT-TOTAL        03870000
038800           ADD AP047-GRO-COST-AMT       TO WS-CM-TOTAL            03880000
038900        END-IF                                                    03890000
039000        PERFORM S500-GET-DATE-ACTUAL                              03900000
039100        IF AP047-GL-ACCT-NBR NOT EQUAL '10301 '                   03910000
039200           PERFORM S600-GET-JRNL-DATE                             03920000
039300        END-IF                                                    03930000
039600        MOVE AP047-AP-TRN-CDE           TO DH-PJ-SOURCE           03960000
039700        PERFORM W100-WRITE-WORK-REPORT-FILE                       03970000
039800        PERFORM R100-READ-IMPORT-FILE-PJ                          03980000
039900        PERFORM S400-FETCH-INVOICE-CSR                            03990000
040000      WHEN INVOIC-PO-NBR > WS-DETAIL-PONUM                        04000000
040100        INITIALIZE DH-DETAIL-LINE1                                04010000
040300        IF AP047-ENT-NME-DESC (1:9) = SPACES                      04030000
040400           MOVE ZEROS                   TO DH-PO-NUMBER           04040000
040500         ELSE                                                     04050000
040600           MOVE WS-DETAIL-PONUM         TO DH-PO-NUMBER           04060000
040700        END-IF                                                    04070000
040900        IF AP047-GL-ACCT-NBR NOT EQUAL '10301 '                   04090000
041000           PERFORM S600-GET-JRNL-DATE                             04100000
041100        END-IF                                                    04110000
041200        PERFORM S500-GET-DATE-ACTUAL                              04120000
041600        MOVE AP047-DOC-NBR              TO DH-PO-INV              04160000
041700        MOVE AP047-AP-TRN-CDE           TO DH-PJ-SOURCE           04170000
041800        MOVE WS-HOLD-ACCT               TO DH-ACCOUNT             04180000
042200        IF AP047-AP-TRN-CDE = '68' OR '73'                        04220000
042500           MOVE AP047-GRO-COST-AMT      TO DH-DEBIT-TOTAL         04250000
042600           ADD AP047-GRO-COST-AMT       TO WS-DM-TOTAL            04260000
042700        ELSE                                                      04270000
042800           MOVE WS-DETAIL-PONUM         TO WS-INVOIC-PO-NBR       04280000
043010           IF INVOIC-PPD-RVRSL-IND = 'Y'                          04301000
043020              MOVE AP047-GRO-COST-AMT   TO DH-PPR                 04302000
043030           END-IF                                                 04303000
043300           MOVE AP047-GRO-COST-AMT      TO DH-CREDIT-TOTAL        04330000
043400           ADD AP047-GRO-COST-AMT       TO WS-CM-TOTAL            04340000
043500        END-IF                                                    04350000
043700        MOVE AP047-ENT-NME-DESC (1:9)   TO WS-DT-PONUM            04370000
043800        PERFORM S800-READ-DUNNS-NBR                               04380000
043900        MOVE WS-DUNNS-NUMBER            TO DH-PO-DUNNS            04390000
044000        PERFORM W100-WRITE-WORK-REPORT-FILE                       04400000
044100        PERFORM R100-READ-IMPORT-FILE-PJ                          04410000
044200      WHEN INVOIC-PO-NBR < WS-DETAIL-PONUM                        04420000
044300        MOVE INVOIC-PO-NBR              TO WS-DT-PONUM            04430000
044400        INITIALIZE DH-DETAIL-LINE1                                04440000
044500        PERFORM S800-READ-DUNNS-NBR                               04450000
044600        MOVE WS-DUNNS-NUMBER            TO DH-PO-DUNNS            04460000
044700        MOVE INVOIC-INVC-ID             TO DH-PO-INV              04470000
044710        IF INVOIC-PPD-RVRSL-IND = 'Y'                             04471000
044720           MOVE AP047-GRO-COST-AMT      TO DH-PPR                 04472000
044730        END-IF                                                    04473000
044800        MOVE INVOIC-PO-NBR              TO DH-PO-NUMBER           04480000
044900        MOVE WS-HOLD-ACCT               TO DH-ACCOUNT             04490000
045000        MOVE WS-REQ-ENTR-TRMNL-ID       TO DH-PJ-TERM             04500000
045100        MOVE INVOIC-GRO-COST-AMT        TO DH-INV                 04510000
045200        MOVE INVOIC-PO-NBR              TO WS-INVOIC-PO-NBR       04520000
045410        IF INVOIC-PPD-RVRSL-IND = 'Y'                             04541000
045420           MOVE AP047-GRO-COST-AMT      TO DH-PPR                 04542000
045430        END-IF                                                    04543000
045500        PERFORM W100-WRITE-WORK-REPORT-FILE                       04550000
045600        PERFORM S400-FETCH-INVOICE-CSR                            04560000
045700      END-EVALUATE.                                               04570000
045710                                                                  04571000
045711*----------------------------------------------------------------*04571100
045712* END OF PROGRAM PROCESSING                                      *04571200
045713*----------------------------------------------------------------*04571300
045714 B300-TERMINATION.                                                04571400
045715                                                                  04571500
045716     DISPLAY '************************************************'.  04571600
045717     DISPLAY '**         APKUT245 RECORD COUNTS             **'.  04571700
045718     DISPLAY '************************************************'.  04571800
045719     DISPLAY 'TOTAL IMPORT RECORDS READ = ' PV-IMPORT-READ-CNT.   04571900
045720     DISPLAY 'TOTAL ACCT RECORDS READ   = ' PV-ACCT-READ-CNT.     04572000
045721     DISPLAY 'TOTAL RECORDS WRITTEN     = ' PV-WRITTEN-CNT.       04572100
045722     DISPLAY '************************************************'.  04572200
045723     DISPLAY '************************************************'.  04572300
045724                                                                  04572400
045725     PERFORM Y200-CLOSE-INVOICE-CSR.                              04572500
045726     CLOSE DETAIL-IMPORT-FILE-PJ                                  04572600
045727           DETAIL-ACCT-IMPORT-FILE-PJ                             04572700
045728           WORK-REPORT-FILE.                                      04572800
045729                                                                  04572900
045730*----------------------------------------------------------------*04573000
045731* READS THE INPUT FILE                                           *04573100
045740*----------------------------------------------------------------*04574000
045750 R100-READ-IMPORT-FILE-PJ.                                        04575000
045760                                                                  04576000
045770     READ DETAIL-IMPORT-FILE-PJ INTO AP047-GL-EXTRACT-FILE        04577000
045780          AT END                                                  04578000
045790             SET END-OF-FILE-IMPORT TO TRUE                       04579000
045800             MOVE '9999999'         TO AP047-ENT-NME-DESC (1:9)   04580000
045900          NOT AT END                                              04590000
046000             ADD 1                  TO PV-IMPORT-READ-CNT.        04600000
046100                                                                  04610000
046200     MOVE AP047-ENT-NME-DESC (1:9)  TO WS-DETAIL-PONUM.           04620000
046400     IF END-OF-FILE-IMPORT                                        04640000
046500        MOVE 999999999              TO WS-DETAIL-PONUM            04650000
046600     END-IF.                                                      04660000
046700                                                                  04670000
058210*----------------------------------------------------------------*05821000
058220* READS THE INPUT FILE CONTAINING ACCOUNT DATA                   *05822000
058230*----------------------------------------------------------------*05823000
058300 R200-READ-ACCT-IMPORT-FILE.                                      05830000
058400                                                                  05840000
058600     READ DETAIL-ACCT-IMPORT-FILE-PJ INTO AP047-GL-EXTRACT-FILE   05860000
058700          AT END                                                  05870000
058800             SET END-OF-FILE-ACCT    TO TRUE                      05880000
058900          NOT AT END                                              05890000
059000             ADD 1                   TO PV-ACCT-READ-CNT.         05900000
059010                                                                  05901000
059100     MOVE AP047-ENT-NME-DESC (1:9)   TO ACCT-PO (X1).             05910000
059200     MOVE AP047-ENT-NME-DESC (10:10) TO ACCT-DATE (X1).           05920000
059300                                                                  05930000
059400*----------------------------------------------------------------*05940000
059500* SELECT THE PREVIOUS FISCAL PERIOD AND YEAR FROM THE TAPCNTL    *05950000
059510* TABLE.                                                         *05951000
059600*----------------------------------------------------------------*05960000
059700 S100-SELECT-PREV-FISCAL-DATA.                                    05970000
059800                                                                  05980000
059900     EXEC SQL                                                     05990000
059910        SELECT PREV_PSTG_FYR_NBR                                  05991000
059920             , PREV_PSTG_FMN_NBR                                  05992000
059930          INTO :APCNTL-PREV-PSTG-FYR-NBR                          05993000
059940             , :APCNTL-PREV-PSTG-FMN-NBR                          05994000
059950          FROM TAPCNTL                                            05995000
060000     END-EXEC.                                                    06000000
060100                                                                  06010000
060200     EVALUATE TRUE                                                06020000
060300       WHEN SQLCODE = ZERO                                        06030000
060400         CONTINUE                                                 06040000
060500       WHEN SQLWARN0 NOT = SPACES                                 06050000
060510       WHEN SQLCODE NOT = ZERO                                    06051000
060520         MOVE 'S100-SELECT-PREV-FISCAL-DATA'                      06052000
060530                                      TO AA-PARAGRAPH-NAME        06053000
060540         MOVE 'UNSUCCESSFUL SELECT'   TO AA-DB2-OPERATION         06054000
060550         MOVE 'TAPCNTL'               TO AA-DB2-TABLE-1           06055000
060560         MOVE SPACES                  TO AA-DB2-TABLE-2           06056000
060570                                         AA-DB2-TABLE-3           06057000
060580                                         AA-DB2-TABLE-4           06058000
060590         PERFORM Z999-DB2-ABEND                                   06059000
060591     END-EVALUATE.                                                06059100
060592                                                                  06059200
060593*----------------------------------------------------------------*06059300
060594* USE THE KOHLS CALENDAR ROUTINE TO GET THE FIRST AND LAST       *06059400
060595* FISCAL DATE OF THE PREVIOUS PERIOD.                            *06059500
060596*----------------------------------------------------------------*06059600
060597 S200-GET-FIRST-LAST-FISCAL-DT.                                   06059700
060598                                                                  06059800
060599     INITIALIZE DPG51, DPG52, DPG53, DPG54, DPG55, DPG56.         06059900
060600                                                                  06060000
060601     SET DPG51-FISCAL-454-CALENDAR    TO TRUE.                    06060100
060602     SET DPG52-LK-DTE-FISC-PRD-CC     TO TRUE.                    06060200
060604     MOVE APCNTL-PREV-PSTG-FYR-NBR    TO DPG52-FISCAL-CC-PRD-YR.  06060400
060605     MOVE APCNTL-PREV-PSTG-FMN-NBR    TO DPG52-FISCAL-CC-PRD-PP.  06060500
060606                                                                  06060600
060607     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    06060700
060608                                             DPG54 DPG55 DPG56.   06060800
060609                                                                  06060900
060610     IF DPG54-NO-ERROR                                            06061000
060611        DISPLAY 'PERIOD START DATE: ' DPG56-FIRST-FP-DB2-ISO-FMT  06061100
060612        DISPLAY 'PERIOD END DATE: ' DPG56-LAST-FP-DB2-ISO-FMT     06061200
060613        MOVE DPG56-FIRST-FP-DB2-ISO-FMT  TO PV-FIRST-FISCAL-DATE  06061300
060614        MOVE DPG56-LAST-FP-DB2-ISO-FMT   TO PV-LAST-FISCAL-DATE   06061400
060615     ELSE                                                         06061500
060616        MOVE 'S200-GET-FIRST-LAST-FISCAL-DT'                      06061600
060617                                         TO AA-PARAGRAPH-NAME     06061700
060618        MOVE DPG54-ERROR-MESSAGE         TO AA-MESSAGE            06061800
060619        SET AC-BAD-DATA                  TO TRUE                  06061900
060620        PERFORM Z999-DB2-ABEND                                    06062000
060621     END-IF.                                                      06062100
060622                                                                  06062200
060630*----------------------------------------------------------------*06063000
060700* STORES THE ACCOUNT IMPORT DATA INTO INTERNAL TABLE             *06070000
060800*----------------------------------------------------------------*06080000
060900 S300-GET-ACCT-IMPORT-DATA.                                       06090000
061000                                                                  06100000
061100     SET X1 TO 1.                                                 06110000
061200     PERFORM R200-READ-ACCT-IMPORT-FILE                           06120000
061300             VARYING X1 FROM 1 BY 1                               06130000
061400             UNTIL END-OF-FILE-ACCT.                              06140000
061500     MOVE WS-HD-PO         TO ACCT-PO (X1).                       06150000
061600     MOVE WS-HD-DATE       TO ACCT-DATE (X1).                     06160000
061700     INITIALIZE AP047-GL-EXTRACT-FILE.                            06170000
061800                                                                  06180000
065510*----------------------------------------------------------------*06551000
065520* FETCH THE INVOICE_CSR CURSOR                                   *06552000
065530*----------------------------------------------------------------*06553000
065600 S400-FETCH-INVOICE-CSR.                                          06560000
065700                                                                  06570000
066300     PERFORM WITH TEST AFTER                                      06630000
066400        VARYING PV-RETRY-COUNTER FROM 1 BY 1                      06640000
066500        UNTIL   PV-RETRY-COUNTER > PC-MAX-RETRIES OR              06650000
066600                SQLCODE = ZERO OR                                 06660000
066700                SQLCODE = +100                                    06670000
066800        EXEC SQL                                                  06680000
066900           FETCH INVOICE_CSR                                      06690000
067000               INTO                                               06700000
067100                      :INVOIC-PO-NBR                              06710000
067200                    , :INVOIC-GRO-COST-AMT                        06720000
067300                    , :WS-REQ-ENTR-TRMNL-ID                       06730000
067400                    , :INVOIC-INVC-ID                             06740000
067410                    , :INVOIC-PPD-RVRSL-IND                       06741000
067500        END-EXEC                                                  06750000
067600                                                                  06760000
067700        EVALUATE TRUE                                             06770000
067800            WHEN SQLCODE = ZERO                                   06780000
067900            WHEN SQLCODE = -904                                   06790000
068000            WHEN SQLCODE = -913                                   06800000
068100                 CONTINUE                                         06810000
068200            WHEN SQLCODE = +100                                   06820000
068300                 SET PS-NO-MORE-TINVOIC    TO TRUE                06830000
068400                 MOVE 999999999            TO INVOIC-PO-NBR       06840000
068500            WHEN SQLWARN0 NOT = SPACES                            06850000
068600            WHEN SQLCODE  NOT = ZERO                              06860000
068700                 MOVE '9100-FETCH-INVOICE-CURSOR'                 06870000
068800                                           TO AA-PARAGRAPH-NAME   06880000
068900                 MOVE 'UNSUCCESSFUL FETCH' TO AA-DB2-OPERATION    06890000
069100                 MOVE 'TINVOIC'            TO AA-DB2-TABLE-1      06910000
069200                 MOVE 'TMDINVC'            TO AA-DB2-TABLE-2      06920000
069210                 MOVE 'TACCTYP'            TO AA-DB2-TABLE-3      06921000
069220                 MOVE SPACES               TO AA-DB2-TABLE-4      06922000
069300                 PERFORM Z999-DB2-ABEND                           06930000
069400        END-EVALUATE                                              06940000
069500     END-PERFORM.                                                 06950000
069600                                                                  06960000
069700     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         06970000
069800         MOVE '9100-FETCH-INVOICE-CURSOR' TO AA-PARAGRAPH-NAME    06980000
070000         MOVE 'MAX RETRIES EXCEEDED ON FETCH TINVOIC'             07000000
070100                                          TO AA-DB2-OPERATION     07010000
070200         PERFORM Z999-DB2-ABEND                                   07020000
070300     END-IF.                                                      07030000
070400                                                                  07040000
070500     EVALUATE TRUE                                                07050000
070600        WHEN SQLCODE = ZEROS                                      07060000
070700        WHEN SQLCODE = +100                                       07070000
070800             CONTINUE                                             07080000
070900        WHEN OTHER                                                07090000
071000             MOVE '9100-FETCH-INVOICE-CURSOR' TO AA-PARAGRAPH-NAME07100000
071200             MOVE 'UNSUCCESSFUL FETCH'        TO AA-DB2-OPERATION 07120000
071400             MOVE 'TINVOIC'                   TO AA-DB2-TABLE-1   07140000
071500             MOVE 'TMDINVC'                   TO AA-DB2-TABLE-2   07150000
071510             MOVE 'TACCTYP'                   TO AA-DB2-TABLE-3   07151000
071520             MOVE SPACES                      TO AA-DB2-TABLE-4   07152000
071600             PERFORM Z999-DB2-ABEND                               07160000
071700     END-EVALUATE.                                                07170000
071800                                                                  07180000
071801*----------------------------------------------------------------*07180100
071802* GET DEBIT, CREDIT, OR JOURNAL DATE                             *07180200
071803*----------------------------------------------------------------*07180300
071804 S500-GET-DATE-ACTUAL.                                            07180400
071805                                                                  07180500
071806     IF AP047-AP-TRN-CDE = '68' OR '73'                           07180600
071807        MOVE AP047-ENT-NME-DESC(15:2)    TO DH-DM-MONTH           07180700
071808        MOVE AP047-ENT-NME-DESC(18:2)    TO DH-DM-DAY             07180800
071809        MOVE AP047-ENT-NME-DESC(12:2)    TO DH-DM-YEAR            07180900
071810        IF AP047-GL-ACCT-NBR = '10301 '                           07181000
071811           MOVE AP047-ENT-NME-DESC(15:2) TO DH-JN-MONTH           07181100
071812           MOVE AP047-ENT-NME-DESC(18:2) TO DH-JN-DAY             07181200
071813           MOVE AP047-ENT-NME-DESC(12:2) TO DH-JN-YEAR            07181300
071814        END-IF                                                    07181400
071815     ELSE                                                         07181500
071816        MOVE AP047-ENT-NME-DESC(15:2)    TO DH-CM-MONTH           07181600
071817        MOVE AP047-ENT-NME-DESC(18:2)    TO DH-CM-DAY             07181700
071818        MOVE AP047-ENT-NME-DESC(12:2)    TO DH-CM-YEAR            07181800
071819     END-IF.                                                      07181900
071820                                                                  07182000
071821*----------------------------------------------------------------*07182100
071822* GET THE JOURNAL DATE                                           *07182200
071823*----------------------------------------------------------------*07182300
071824 S600-GET-JRNL-DATE.                                              07182400
071825                                                                  07182500
071826     PERFORM S700-SEARCH-ACCT-TABLE.                              07182600
071828     MOVE WS-JN-DATE (6:2)        TO DH-JN-MONTH.                 07182800
071829     MOVE WS-JN-DATE (9:2)        TO DH-JN-DAY.                   07182900
071830     MOVE WS-JN-DATE (3:2)        TO DH-JN-YEAR.                  07183000
071831                                                                  07183100
071832*----------------------------------------------------------------*07183200
071833* SEARCHES THE INTERNAL ACCOUNT TABLE                            *07183300
071834*----------------------------------------------------------------*07183400
071835 S700-SEARCH-ACCT-TABLE.                                          07183500
071836                                                                  07183600
071837     SET X1 TO 1.                                                 07183700
071838     SEARCH ACCT-TABLE                                            07183800
071839         AT END                                                   07183900
071840            MOVE '0000-00-00'          TO WS-JN-DATE              07184000
071841         WHEN AP047-ENT-NME-DESC (1:9) = ACCT-PO(X1)              07184100
071842             MOVE ACCT-DATE(X1)        TO  WS-JN-DATE             07184200
071843     END-SEARCH.                                                  07184300
071844                                                                  07184400
071845*----------------------------------------------------------------*07184500
071846* GET THE DUNN NUMBER FROM THE TVNDDPT, TPURCHS, AND TEXTENT     *07184600
071847* TABLES.                                                        *07184700
071848*----------------------------------------------------------------*07184800
071849 S800-READ-DUNNS-NBR.                                             07184900
071850                                                                  07185000
071855     EXEC SQL                                                     07185500
071856        SELECT C.DUN_NBR                                          07185600
071857        INTO :WS-DUNNS-NUMBER                                     07185700
071858        FROM TVNDDPT A                                            07185800
071859           , TPURCHS B                                            07185900
071860           , TEXTENT C                                            07186000
071861        WHERE A.ENT_ID = B.ENT_ID                                 07186100
071862          AND B.ENT_ID = C.ENT_ID                                 07186200
071863          AND B.PO_NBR = :WS-DT-PONUM                             07186300
071864          AND VER_STATUS_CDE = 'A'                                07186400
071865          AND A.DEPT_NBR = B.DEPT_NBR                             07186500
071866     END-EXEC.                                                    07186600
071867                                                                  07186700
071868     EVALUATE TRUE                                                07186800
071869         WHEN SQLCODE = ZERO                                      07186900
071870              CONTINUE                                            07187000
071871         WHEN SQLCODE = +100                                      07187100
071872              CONTINUE                                            07187200
071873         WHEN SQLWARN0 NOT = SPACES                               07187300
071874         WHEN SQLCODE  NOT = ZERO                                 07187400
071875             MOVE WS-DT-PONUM  TO PV-DISPLAY-PONUM                07187509
071876             DISPLAY 'WS-DT-PONUM ' PV-DISPLAY-PONUM              07187609
071878             MOVE 'S800-READ-DUNNS-NBR'  TO AA-PARAGRAPH-NAME     07187800
071879             MOVE 'UNSUCCESSFUL SELECT'  TO AA-DB2-OPERATION      07187900
071880             MOVE 'TVNDDPT'              TO AA-DB2-TABLE-1        07188000
071881             MOVE 'TPURCHS'              TO AA-DB2-TABLE-2        07188100
071882             MOVE 'TEXTENT'              TO AA-DB2-TABLE-3        07188200
071883             MOVE SPACES                 TO AA-DB2-TABLE-4        07188300
071884             PERFORM Z999-DB2-ABEND                               07188400
071885     END-EVALUATE.                                                07188500
071886                                                                  07188600
071887*----------------------------------------------------------------*07188700
071888* WRITE RECORD TO EXTRACT FILE                                   *07188800
071889*----------------------------------------------------------------*07188900
071890 W100-WRITE-WORK-REPORT-FILE.                                     07189000
071891                                                                  07189100
071892     WRITE WR-WORK-REPORT-RECORD FROM DH-DETAIL-LINE1 AFTER 1.    07189200
071893     ADD 1                       TO PV-WRITTEN-CNT.               07189300
071894                                                                  07189400
071901*----------------------------------------------------------------*07190100
071902* OPENS THE INVOICE_CSR CURSOR                                   *07190200
071903*----------------------------------------------------------------*07190300
071910 Y100-OPEN-INVOICE-CSR.                                           07191000
072000                                                                  07200000
072100     PERFORM WITH TEST AFTER                                      07210000
072200        VARYING PV-RETRY-COUNTER FROM 1 BY 1                      07220000
072300        UNTIL   PV-RETRY-COUNTER > PC-MAX-RETRIES OR              07230000
072400                SQLCODE = ZERO                                    07240000
072500        EXEC SQL                                                  07250000
072600            OPEN INVOICE_CSR                                      07260000
072700        END-EXEC                                                  07270000
072800                                                                  07280000
072900        EVALUATE TRUE                                             07290000
073000            WHEN SQLCODE = ZERO                                   07300000
073100            WHEN SQLCODE = -904                                   07310000
073200            WHEN SQLCODE = -913                                   07320000
073300                 CONTINUE                                         07330000
073400            WHEN SQLWARN0 NOT = SPACES                            07340000
073500            WHEN SQLCODE  NOT = ZERO                              07350000
073600                 MOVE 'Y100-OPEN-INVOICE-CSR' TO AA-PARAGRAPH-NAME07360000
073800                 MOVE 'UNSUCCESSFUL OPEN'     TO AA-DB2-OPERATION 07380000
074000                 MOVE 'TINVOIC'               TO AA-DB2-TABLE-1   07400000
074100                 MOVE 'TMDINVC'               TO AA-DB2-TABLE-2   07410000
074110                 MOVE 'TACCTYP'               TO AA-DB2-TABLE-3   07411000
074120                 MOVE SPACES                  TO AA-DB2-TABLE-4   07412000
074200                 PERFORM Z999-DB2-ABEND                           07420000
074300        END-EVALUATE                                              07430000
074400     END-PERFORM.                                                 07440000
074500                                                                  07450000
074600     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         07460000
074700         MOVE 'Y100-OPEN-INVOICE-CSR' TO AA-PARAGRAPH-NAME        07470000
074900         MOVE 'MAX RETRIES EXCEEDED ON OPEN TINVOIC'              07490000
075000                                      TO AA-DB2-OPERATION         07500000
075100         PERFORM Z999-DB2-ABEND                                   07510000
075200     END-IF.                                                      07520000
075300                                                                  07530000
075400     EVALUATE TRUE                                                07540000
075500        WHEN SQLCODE = ZEROS                                      07550000
075600             CONTINUE                                             07560000
075700        WHEN OTHER                                                07570000
075800             MOVE 'Y100-OPEN-INVOICE-CSR' TO AA-PARAGRAPH-NAME    07580000
076000             MOVE 'UNSUCCESSFUL OPEN'     TO AA-DB2-OPERATION     07600000
076200             MOVE 'TINVOIC'               TO AA-DB2-TABLE-1       07620000
076300             MOVE 'TMDINVC'               TO AA-DB2-TABLE-2       07630000
076310             MOVE 'TACCTYP'               TO AA-DB2-TABLE-3       07631000
076320             MOVE SPACES                  TO AA-DB2-TABLE-4       07632000
076400             PERFORM Z999-DB2-ABEND                               07640000
076500     END-EVALUATE.                                                07650000
076600                                                                  07660000
076610*----------------------------------------------------------------*07661000
076620* CLOSES THE INVOICE_CSR CURSOR                                  *07662000
076630*----------------------------------------------------------------*07663000
076700 Y200-CLOSE-INVOICE-CSR.                                          07670000
076800                                                                  07680000
076900     PERFORM WITH TEST AFTER                                      07690000
077000        VARYING PV-RETRY-COUNTER FROM 1 BY 1                      07700000
077100        UNTIL   PV-RETRY-COUNTER > PC-MAX-RETRIES OR              07710000
077200                SQLCODE = ZERO                                    07720000
077300         EXEC SQL                                                 07730000
077400             CLOSE INVOICE_CSR                                    07740000
077500         END-EXEC                                                 07750000
077600                                                                  07760000
077700         EVALUATE TRUE                                            07770000
077800             WHEN SQLCODE = ZERO                                  07780000
077900             WHEN SQLCODE = -904                                  07790000
078000             WHEN SQLCODE = -913                                  07800000
078100                  CONTINUE                                        07810000
078200             WHEN SQLWARN0 NOT = SPACES                           07820000
078300             WHEN SQLCODE  NOT = ZERO                             07830000
078400                  MOVE 'Y200-CLOSE-INVOICE-CURSOR'                07840000
078500                                            TO AA-PARAGRAPH-NAME  07850000
078600                  MOVE 'UNSUCCESSFUL CLOSE' TO AA-DB2-OPERATION   07860000
078800                  MOVE 'TINVOIC'            TO AA-DB2-TABLE-1     07880000
078900                  MOVE 'TMDINVC'            TO AA-DB2-TABLE-2     07890000
078910                  MOVE 'TACCTYP'            TO AA-DB2-TABLE-3     07891000
078920                  MOVE SPACES               TO AA-DB2-TABLE-4     07892000
079000                  PERFORM Z999-DB2-ABEND                          07900000
079100         END-EVALUATE                                             07910000
079200     END-PERFORM.                                                 07920000
079300                                                                  07930000
079400     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         07940000
079500         MOVE 'Y200-CLOSE-INVOICE-CURSOR' TO AA-PARAGRAPH-NAME    07950000
079700         MOVE 'MAX RETRIES EXCEEDED ON CLOSE TINVOIC'             07970000
079800                                          TO AA-DB2-OPERATION     07980000
079900         PERFORM Z999-DB2-ABEND                                   07990000
080000     END-IF.                                                      08000000
080100                                                                  08010000
080200     EVALUATE TRUE                                                08020000
080300        WHEN SQLCODE = ZEROS                                      08030000
080400             CONTINUE                                             08040000
080500        WHEN OTHER                                                08050000
080600             MOVE 'Y200-CLOSE-INVOICE-CURSOR'                     08060000
080700                                       TO AA-PARAGRAPH-NAME       08070000
080800             MOVE 'UNSUCCESSFUL CLOSE' TO AA-DB2-OPERATION        08080000
081000             MOVE 'TINVOIC'            TO AA-DB2-TABLE-1          08100000
081100             MOVE 'TMDINVC'            TO AA-DB2-TABLE-2          08110000
081110             MOVE 'TACCTYP'            TO AA-DB2-TABLE-3          08111000
081120             MOVE SPACES               TO AA-DB2-TABLE-4          08112000
081200             PERFORM Z999-DB2-ABEND                               08120000
081300     END-EVALUATE.                                                08130000
081301                                                                  08130100
081310*----------------------------------------------------------------*08131000
081320* DB2 ABEND ROUTINE                                              *08132000
081330*----------------------------------------------------------------*08133000
081400 Z999-DB2-ABEND.                                                  08140000
081500                                                                  08150000
081600     DISPLAY AA-ABEND-LIT.                                        08160000
081700     DISPLAY AA-DB2-ERROR-LIT.                                    08170000
081800     DISPLAY AA-PROGRAM-LIT.                                      08180000
081900     DISPLAY AA-PARAGRAPH-LIT.                                    08190000
082000     DISPLAY AA-DB2-OPERATION-LIT.                                08200000
082100     DISPLAY AA-DB2-TABLE-1.                                      08210000
082200     DISPLAY AA-DB2-TABLE-2.                                      08220000
082210     DISPLAY AA-DB2-TABLE-3.                                      08221000
082220     DISPLAY AA-DB2-TABLE-4.                                      08222000
082300     SET AC-DB2-ERROR TO TRUE.                                    08230000
082400                                                                  08240000
082500     COPY DPPD004.                                                08250000
082700     CALL 'ILBOABN0' USING ABEND-CODE.                            08270000
