000100 TITLE 'DELETE SE ROWS'.                                                  
000200 IDENTIFICATION DIVISION.                                                 
000300 PROGRAM-ID.    PCKUP016.                                                 
000400 AUTHOR.        DENNIS STEFFEN.                                           
000500 DATE-WRITTEN.  SEPTEMBER, 2005.                                          
000600                                                                          
000700                                                                          
000800 ENVIRONMENT DIVISION.                                                    
000900 INPUT-OUTPUT SECTION.                                                    
001000 FILE-CONTROL.                                                            
001100     SELECT STORE-EXPECTED-EXTRACT-FILE                                   
001200         ASSIGN TO INP01.                                                 
001300                                                                          
001400 DATA DIVISION.                                                           
001500 FILE SECTION.                                                            
001600                                                                          
001700 FD  STORE-EXPECTED-EXTRACT-FILE                                          
001800     RECORDING MODE IS F                                                  
001900     LABEL RECORDS ARE STANDARD                                           
002000     BLOCK CONTAINS 0 RECORDS.                                            
002100                                                                          
002200 01  STORE-EXPECTED-RECORD               PIC  X(34).                      
002300                                                                          
002400/                                                                         
002500 WORKING-STORAGE SECTION.                                                 
002600                                                                          
002700 01  PS-PROGRAM-SWITCHES.                                                 
002800     05  PS-END-OF-FILE-SW               PIC  X(01)  VALUE 'N'.           
002900         88  PS-END-OF-FILE-YES                      VALUE 'Y'.           
003000 01  ABEND-CODE                          PIC S9(04)  VALUE ZERO           
003100                                                     COMP SYNC.           
003200 01  PV-PROGRAM-VARIABLES.                                                
003300     05  PV-ABEND-PARAGRAPH              PIC  X(30)  VALUE SPACE.         
003400     05  PV-DB2-OPERATION-ATTEMPTED      PIC  X(30)  VALUE SPACE.         
003500                                                                          
003600     05  PV-CKPT-JOB-NAME             PIC X(08) VALUE SPACES.             
003700     05 PV-COMMIT-COUNTER             PIC S9(05) COMP-3                   
003800                                                 VALUE ZERO.              
003900                                                                          
004000     05 PV-NUMBER-OF-COMMITS          PIC S9(09) COMP-3                   
004100                                                 VALUE ZERO.              
004200                                                                          
004300     05 PV-TRAN-INSERT-COUNTER        PIC S9(09) COMP-3                   
004400                                              VALUE ZERO.                 
004500     05 PV-TRAN-DUP-IN-COUNTER        PIC S9(09) COMP-3                   
004600                                              VALUE ZERO.                 
004700     05 PV-READ-COUNTER               PIC S9(09) COMP-3                   
004800                                              VALUE ZERO.                 
004900     05 PV-DISP-NBR                   PIC ZZZ,ZZZ,ZZ9.                    
005000                                                                          
005100     05 PV-DISP-LOC                   PIC ZZZ9.                           
005200                                                                          
005300     05 PV-QTY-UPDATE-COUNTER         PIC S9(09) COMP-3                   
005400                                              VALUE ZERO.                 
005500     05 PV-QTY-INSERT-COUNTER         PIC S9(09) COMP-3                   
005600                                              VALUE ZERO.                 
005700     05 PV-TRAN-DELETE-COUNTER        PIC S9(09) COMP-3                   
005800                                              VALUE ZERO.                 
005900     05  PV-DISP-CONTROL              PIC S9(09) COMP-3                   
006000                                              VALUE ZERO.                 
006100     05  PV-TIME                      PIC X(08) VALUE SPACES.             
006200     05  PV-SQL-CODE                  PIC  9(04) VALUE ZERO.              
006300     05  PV-COMP10                    PIC S9(10) COMP                     
006400                                              VALUE ZERO.                 
006500                                                                          
006600 01  PV-DISP-KEY-MSG.                                                     
006700     05  FILLER                      PIC X(14) VALUE                      
006800         'INTR-UPC-ID = '.                                                
006900     05  PV-KEY-INTR-UPC-ID          PIC 9(10) VALUE ZEROES.              
007000                                                                          
007100     05  FILLER                      PIC X(12) VALUE                      
007200         '; LOC-NBR = '.                                                  
007300     05  PV-KEY-LOC-NBR              PIC 9(04) VALUE ZEROES.              
007400     05  FILLER                      PIC X(11) VALUE                      
007500         '; PO-NBR = '.                                                   
007600     05  PV-KEY-PO-NBR               PIC 9(09) VALUE ZEROES.              
007700     05  FILLER                      PIC X(09) VALUE                      
007800         '; RCVR = '.                                                     
007900     05  PV-KEY-RCVR-SEQ-NBR         PIC 9(09) VALUE ZEROES.              
008000                                                                          
008100 01  PV-REFORMAT-UPC.                                                     
008200     10  PV-DETAIL-INNER-UPC          PIC S9(10)  VALUE ZEROES            
008300                                                      COMP.               
008400     10  FILLER REDEFINES PV-DETAIL-INNER-UPC.                            
008500         15  FILLER                   PIC X(04).                          
008600         15  PV-DET-UPC-ID-4          PIC X(04).                          
008700         15  PV-DET-UPC-SPC REDEFINES PV-DET-UPC-ID-4                     
008800                                      PIC S9(9) COMP.                     
008900                                                                          
009000 01  PC-PROGRAM-CONSTANTS.                                                
009100     05  PC-CKPT-PLAN-NAME            PIC X(08) VALUE 'PCKUP016'.         
009200     05  PC-CURRENT-PROGRAM-NAME      PIC X(08)  VALUE                    
009300         'PCKUP016'.                                                      
009400     05  PC-OPEN-FUNC                PIC X(05)     VALUE 'OPEN '.         
009500     05  PC-TRANS-FUNC               PIC X(05)     VALUE 'TRANS'.         
009600     05  PC-CLOSE-FUNC               PIC X(05)     VALUE 'CLOSE'.         
009700     05  PC-RSTRT-FUNC               PIC X(05)     VALUE 'RSTRT'.         
009800                                                                          
009900* TRANSACTION PRESENTATION MODULE PARAMETERS                              
260107     COPY DPWS991.                                                        
010000                                                                          
010000     COPY DPLS001.                                                        
010100         05  WORK-STRG-AREA          PIC X(150).                          
010200                                                                          
010300*    PURGE RECORDS                                                        
010400     COPY PCRD050.                                                        
010500                                                                          
010600                                                                          
010700 01  PT-TOT-TABLE.                                                        
010800     05  PT-TOT-ELEMENT OCCURS 9999 TIMES INDEXED BY PT-TOT-IDX.          
010900         10  PT-LOC                   PIC S9(04) COMP.                    
011000         10  PT-DEL-TOT               PIC S9(11) COMP.                    
011100/                                                                         
011200*  IN-TRANSIT DETAIL TABLE                                                
011300*                                                                         
011400     EXEC SQL                                                             
011500          INCLUDE PCT00015                                                
011600     END-EXEC.                                                            
011700                                                                          
011800     COPY DPWS004.                                                        
011900                                                                          
012000     EXEC SQL                                                             
012100         INCLUDE SQLCA                                                    
012200     END-EXEC.                                                            
012300     COPY SQLCA2.                                                         
012400/                                                                         
012500 PROCEDURE DIVISION.                                                      
012600                                                                          
012700     PERFORM 1000-INITIALIZE.                                             
012800                                                                          
012900     PERFORM 2000-PROCESS                                                 
013000             UNTIL PS-END-OF-FILE-YES                                     
013100                                                                          
013200     PERFORM 9000-QUIT.                                                   
013300                                                                          
013400     GOBACK.                                                              
013500                                                                          
013600 1000-INITIALIZE.                                                         
013700                                                                          
013800     MOVE ZERO                        TO PV-COMMIT-COUNTER                
013900                                         PV-NUMBER-OF-COMMITS             
014000     INITIALIZE PT-TOT-TABLE.                                             
014100                                                                          
014200     ACCEPT PV-CKPT-JOB-NAME FROM SYSIN.                                  
014300     MOVE PC-OPEN-FUNC           TO DP001-FUNC-CODE.                      
014400                                                                          
014500     PERFORM 8000-READ-EXTRACT-FILE.                                      
014600                                                                          
014700     MOVE PC-TRANS-FUNC          TO DP001-FUNC-CODE.                      
014800                                                                          
014900     IF PS-END-OF-FILE-YES                                                
015000         DISPLAY ' INP01 FILE IS EMPTY'                                   
015100     END-IF.                                                              
015200                                                                          
015300 2000-PROCESS.                                                            
015400                                                                          
015500     PERFORM 7000-DELETE-DTL                                              
015600                                                                          
015700     PERFORM 8000-READ-EXTRACT-FILE.                                      
015800                                                                          
015900                                                                          
016000 7000-DELETE-DTL.                                                         
016100                                                                          
016200      MOVE '7000-DELETE-DTL'            TO PV-ABEND-PARAGRAPH.            
016300                                                                          
016400      EXEC SQL                                                            
016500         DELETE                                                           
016600             FROM PCT_TRN_CLSN_DTL                                        
016700         WHERE                                                            
016800                INTR_UPC_ID        =  :PC050-INTR-UPC-ID                  
016900            AND LOC_NBR            =  :PC050-LOC-NBR                      
017000            AND TRN_CLSN_CDE       =  'SE'                                
017100            AND PO_NBR             =  :PC050-PO-NBR                       
017200            AND RCVR_SEQ_NBR       =  :PC050-RCVR-SEQ-NBR                 
017300     END-EXEC                                                             
017400                                                                          
017500     EVALUATE TRUE                                                        
017600         WHEN SQLCODE = ZERO                                              
017700             ADD SQLERRD(3)           TO PT-DEL-TOT                       
017800                                         (PC050-LOC-NBR)                  
017900         WHEN SQLCODE = +100                                              
018000             ADD +1                   TO PV-TRAN-DELETE-COUNTER           
018100         WHEN SQLCODE = -904                                              
018200         WHEN SQLCODE = -911                                              
018300         WHEN SQLCODE = -913                                              
018400             CONTINUE                                                     
018500                                                                          
018600         WHEN SQLCODE < ZERO                                              
018700             DISPLAY '**************************************'             
018800             DISPLAY 'ERROR ISSUED'                                       
018900             DISPLAY 'INSERT PCT_TRN_CLSN_DTL               '             
019000             DISPLAY PV-DISP-KEY-MSG                                      
019100             DISPLAY '**************************************'             
019200             PERFORM 9100-SQL-ABEND                                       
019300     END-EVALUATE.                                                        
019400/                                                                         
019500 8000-READ-EXTRACT-FILE.                                                  
019600     MOVE LENGTH OF PC050-SE-SUMMARY-REC                                  
019700                                     TO DP001-WORK-STRG-LENGTH.           
019800     MOVE PV-CKPT-JOB-NAME           TO DP001-JOB-NAME.                   
019900     MOVE PC-CKPT-PLAN-NAME          TO DP001-PLAN-NAME.                  
020000                                                                          
020100     PERFORM Z900-CALL-TRANS-PRES-MODULE.                                 
020200                                                                          
020300     MOVE DP001-TRANS-RECORD  TO PC050-SE-SUMMARY-REC                     
020400                                                                          
020500     IF DP001-PREP-TRANS-EOF                                              
020600         SET PS-END-OF-FILE-YES       TO TRUE                             
020700     ELSE                                                                 
020800         ADD 1                        TO PV-READ-COUNTER                  
020900                                         PV-DISP-CONTROL                  
021000         MOVE PC050-LOC-NBR           TO PT-LOC                           
021100                                        (PC050-LOC-NBR)                   
021200                                                                          
021300*        DISPLAY EVERY 100,000 RECORD NBR PROCESSED                       
021400         IF PV-DISP-CONTROL > 99999                                       
021500             EXEC SQL                                                     
021600                 SELECT CURRENT TIME                                      
021700                 INTO :PV-TIME                                            
021800                 FROM SYSIBM.SYSDUMMY1                                    
021900             END-EXEC                                                     
022000                                                                          
022100             MOVE PC050-INTR-UPC-ID   TO PV-COMP10                        
022200             MOVE PV-COMP10           TO PV-KEY-INTR-UPC-ID               
022300             MOVE PC050-LOC-NBR       TO PV-KEY-LOC-NBR                   
022400             MOVE PC050-PO-NBR        TO PV-KEY-PO-NBR                    
022500             MOVE PC050-RCVR-SEQ-NBR  TO PV-KEY-RCVR-SEQ-NBR              
022600                                                                          
022700             MOVE PV-READ-COUNTER     TO PV-DISP-NBR                      
022800             DISPLAY PV-TIME                                              
022900             ' REC # ' PV-DISP-NBR                                        
023000             ' / '     PV-DISP-KEY-MSG                                    
023100             MOVE ZERO                TO PV-DISP-CONTROL                  
023200         END-IF                                                           
023300                                                                          
023400     END-IF.                                                              
023500/                                                                         
023600 9000-QUIT.                                                               
023700                                                                          
023800*    CLOSE STORE-EXPECTED-EXTRACT-FILE.                                   
023900     MOVE PC-CLOSE-FUNC               TO DP001-FUNC-CODE.                 
024000     PERFORM 8000-READ-EXTRACT-FILE.                                      
024100                                                                          
024200     MOVE PV-READ-COUNTER             TO PV-DISP-NBR                      
024300     DISPLAY 'RECORDS READ               = ' PV-DISP-NBR                  
024400                                                                          
024500     MOVE PV-TRAN-DELETE-COUNTER      TO PV-DISP-NBR                      
024600     DISPLAY ' DELETES NOT FOUND         = '  PV-DISP-NBR.                
024700                                                                          
024800     MOVE PV-NUMBER-OF-COMMITS        TO PV-DISP-NBR                      
024900     DISPLAY 'NUMBER OF COMMITS TAKEN    = '  PV-DISP-NBR.                
025000     PERFORM 9001-TOTALS.                                                 
025100                                                                          
025200 9001-TOTALS.                                                             
025300     DISPLAY ' LOC        DELETED'                                        
025400     PERFORM VARYING PT-TOT-IDX FROM 1 BY 1                               
025500             UNTIL PT-TOT-IDX > 9999                                      
025600         IF PT-LOC(PT-TOT-IDX) > ZERO                                     
025700             MOVE PT-LOC(PT-TOT-IDX) TO PV-DISP-LOC                       
025800             MOVE PT-DEL-TOT (PT-TOT-IDX) TO PV-DISP-NBR                  
025900             DISPLAY PV-DISP-LOC  '   '                                   
026000                     PV-DISP-NBR '   '                                    
026100         END-IF                                                           
026200     END-PERFORM.                                                         
026300/                                                                         
026400 9100-SQL-ABEND.                                                          
026500******************************************************************        
026600*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL            
026700*  ERROR OR WARNING CODE OCCURS.                                          
026800******************************************************************        
026900     DISPLAY '9100-SQL-ABEND'.                                            
027000     DISPLAY '** ABEND     **'.                                           
027100     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.                
027200     DISPLAY '** PARAGRAPH ** = ' PV-ABEND-PARAGRAPH.                     
027300     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.             
027400     DISPLAY '** INTR-UPC-ID  = ' PV-KEY-INTR-UPC-ID                      
027500     DISPLAY '** LOC-NBR      ** = ' PV-KEY-LOC-NBR                       
027600     DISPLAY '** TRIP-ID      ** = ' PCT00015-OTBND-TRIP-ID               
027700     DISPLAY '**              ** = '                                      
027800     MOVE SQLCODE TO PV-SQL-CODE.                                         
027900     DISPLAY '** SQL CODE  ** = ' PV-SQL-CODE.                            
028000     MOVE +4013 TO ABEND-CODE.                                            
028100     CALL 'ILBOABN0' USING ABEND-CODE.                                    
028200/                                                                         
028300*    PRESENTATION MODULE (CHECKPOINT RESTART)                             
028400     COPY DPPD001.                                                        
