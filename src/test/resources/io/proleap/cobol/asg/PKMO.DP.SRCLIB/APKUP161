000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.     APKUP161.                                        00020000
000300 AUTHOR.         ELENA MOZNAIM.                                   00030000
000400*DATE-WRITTEN.   MAR 19,2019.                                     00040000
000500*DATE-COMPILED.                                                   00050000
000600******************************************************************00060000
000700*    COBOL 2  WITH SQL                                           *00070000
000800*    THIS PROGRAM IS A SLIGHTLY MODIFIED VERSION OF APKUP137.    *00080000
000810*    THIS PROGRAM REPLACES APKUP137 AFTER ERP/KFS GOES LIVE.     *00081000
000820******************************************************************00082000
000830*    ADJUSTMENT EXTRACT FOR LEDGER INTERFACES                    *00083000
000840*                                                                *00084000
000850*    THE PURPOSE OF THIS PROGRAM IS TO EXTRACT THE DATA          *00085000
000860*    FROM THE ADJUSTMENT JOURNAL DATABASE BASED ON A             *00086000
000870*    PARAMETER WHICH WILL INDICATE WHICH TIMEFRAME TO            *00087000
000880*    EXTRACT.  TWO EXTRACTS WILL BE CREATED.  THE FIRST          *00088000
000890*    WILL CONTAIN ALL TRANSACTIONS WHICH NEED TO BE              *00089000
000900*    INTERFACED TO THE MERCHANDISE LEDGER AND APPEAR ON          *00090000
001000*    THE ADJUSTMENT JOURNAL REPORT.  THE SECOND WILL             *00100000
001100*    CONTAIN ALL TRANSACTIONS THAT NEED TO BE INTERFACED TO      *00110000
001200*    THE GENERAL LEDGER.  AS EACH ADJUSTMENT DOCUMENT IS         *00120000
001300*    BEING COPIED TO THE EXTRACT FILE(S), THE DATABASE WILL      *00130000
001400*    BE UPDATED TO INDICATE THAT THAT ROW HAS BEEN               *00140000
001500*    EXTRACTED.  THIS WILL PREVENT DATA FROM BEING               *00150000
001600*    EXTRACTED MORE THAN ONCE.                                   *00160000
001700*                                                                *00170000
001800******************************************************************00180000
001900*                                                                *00190000
002000* INPUT:                                                         *00200000
002100*    TAPCNTL - AP CONTROL TABLE                                  *00210000
002200*    TADJRNL - ADJUSTMENT JOURNAL TABLE                          *00220000
002300*    TADJDIS - ADJUSTMENT JOURNAL TABLE                          *00230000
002400*    TTRNCDE - TRANCODE TABLE                                    *00240000
002500*    TMDSEAR - MERCHANDISE AREA TABLE                            *00250000
002600*    TRSPBAR - RESPONSIBILITY TABLE                              *00260000
002700*    TENTNME - EXTERNAL ENTERPRISE NAME TABLE                    *00270000
002800*    TINVPAR - INVENTORY PARMS TABLE                             *00280000
002900*                                                                *00290000
003000*                                                                *00300000
003100* OUTPUT:                                                        *00310000
003200*    ADJUSTMENTS TO FEED ML, APRD046, WRITTEN TO TOUTAPG         *00320000
003300*    ADJUSTMENTS TO FEED GL, APRD047, WRITTEN TO TOUTAPH         *00330000
003400*    ERROR RECORDS         , APRD041, WRITTEN TO TOUTAPF         *00340000
003410*                                                                *00341000
003420*                                                                *00342000
003430******************************************************************00343000
003440******************************************************************00344000
003450**  CHANGE LOG FOR APKUP161                                       00345000
003460******************************************************************00346000
003470**  PROD DATE     INITIALS     DESCRIPTION                       *00347000
003480**  ----------    --------     ----------------------------------*00348000
003490**  03/28/2019      EVM        CHG0220043 - NEW PROGRAM          *00349000
003491**                             MODIFIED LINES ARE MARKED WITH    *00349100
003492**                             220043                            *00349200
003493***************************************************************** 00349300
003494* CHANGE LOG FOR APKUP137                                        *00349400
003495*                                                                *00349500
003496* 01/18/99  INITIAL VERSION                                      *00349600
003497*                                                                *00349700
003498* 10/05/1999  JILL JUEL                                          *00349800
003499*    ADDED CODE TO WRITE ANY ERRORS TO THE TOUTAPF TABLE.        *00349900
003500*    PARAGRAGHS ADDED C300-BUILD-AP041-RECORD                    *00350000
003600*                     U600-INSERT-OUTAPF-RECORDS                 *00360000
003700*                                                                *00370000
003800* 10/11/1999 CHANGE DATE-INVALID TO WARNING-ERROR IN DATE        *00380000
003900*        ROUTINE CHECKING                                        *00390000
004000*        BY: L SCHALLHORN                           WR 06041     *00400000
004100*                                                                *00410000
004200* 12/06/1999 ADDED CODE SO THAT IF THE ADJUSTMENT CURSOR         *00420000
004300*        COMES UP EMPTY ON THE FIRST FETCH, THE PROGRAM WILL     *00430000
004400*        NOT ABEND.  IT WILL CLOSE THE CURSOR AND DO A           *00440000
004500*        GOBACK TO END NORMALLY.                                 *00450000
004600*        BY: MIKE BESKE                           IR 332208      *00460000
004700*                                                                *00470000
004800* 05/16/2002                                                     *00480000
004900*    CHANGE MADE:  NI-SKU CHANGES.  THE 3 BYTE SKU-SEQ           *00490000
005000*    FIELD IS REPLACED WITH A NUMERIC 8 BYTE SKU FIELD.          *00500000
005100*    CHANGES MADE TO CURSOR AND PARAGRAPHS C100 AND R100.        *00510000
005200* BY: KEVIN CATLIN                          WR#: 21278           *00520000
005300*                                                                *00530000
005400* 02/09/2005                                                     *00540000
005500*    CHANGE MADE:  ADDED LOGIC TO CORRECT 2 PROBLEMS. THE PRIMARY*00550000
005600*    CHANGE IS TO ADD A VALIDATION OF THE DEPT/SUBCLASS ON THE   *00560000
005700*    TRANSACTION.  IF NOT VALID, THE SMALLEST VALID CLASS FOR    *00570000
005800*    THE DEPT IS SELECTED AND USED ON THE EXTRACT AND THE TADJDIS*00580000
005900*    TABLE IS UPDATED TO CHANGE THE CLASS TO THE SAME VALUE.     *00590000
006000*    THE SECONDARY CHANGE IS TO ENHANCE THE HANDLING OF INVALID  *00600000
006100*    DEPTS - THEY WERE ALREADY BEING WRITTEN TO THE ERROR REPORT *00610000
006200*    AND NOT BEING WRITTEN TO THE ML EXTRACT.  ADDITIONAL LOGIC  *00620000
006300*    WAS ADDED TO PREVENT THEM FROM BEING WRITTEN TO THE GL      *00630000
006400*    EXTRACT AND TO PREVENT THE DATABASE FROM BEING UPDATED TO   *00640000
006500*    INDICATE THAT THE TRANSACTION HAD BEEN EXTRACTED.           *00650000
006600* BY: NANCY EILBES                        PITS#: P000735788      *00660000
006700*                                                                *00670000
006800* 03/03/2005                                                     *00680000
006900*    CHANGE MADE:  CORRECTED END OF CURSOR LOGIC WHEN CURSOR IS  *00690000
007000*    EMPTY.                                                      *00700000
007100* BY: L SCHALLHORN                        PITS#: P000742580      *00710000
007200*                                                                *00720000
007300* 11/20/2009                                                     *00730000
007400*    CHANGE MADE:  GOT THE CUTOFF DATE FOR ADJUSTMENTS FROM THE  *00740000
007500*    INVENTORY LEDGER INSTEAD OF THE ADJUSTMENT JOURNAL TABLE.   *00750000
007600* BY: BARB SCHULTZ                          WR#: WR37487         *00760000
007700*                                                                *00770000
007800* DATE  03/17/2010                                               *00780000
007900*     CHANGE MADE:  ADDED CODE IN PARA R100- WHENEVER ADJRNL_STR_*00790000
008000*     NBR AND ADJDIS_STR_NBR ARE 809 THEN 873 WILL BE MOVED TO   *00800000
008100*     THOSE FIELDS.  THIS IS TEMPORARY UNTIL THE ORDER MANAGEMENT*00810000
008200*     SYSTEM IS PUT INTO PRODUCTION LATER ON.  THIS CHANGE ONLY  *00820000
008300*     AFFECTS THE DATA THAT IS IN THE ML AND GL EXTRACT FILES.   *00830000
008400*     MADE BY:  MIKE BESKE             WR/IR #: WR38216          *00840000
008500*                                                                *00850000
008600* DATE  03/31/2010                                               *00860000
008700*     CHANGE MADE:  ADDED 3 ADDITIONAL TEMPORARY TRANSLATIONS IN *00870000
008800*     PARA R100- AS FOLLOWS: 806 TO 870, 807 TO 871, 808 TO 872. *00880000
008900*     MADE BY:  MIKE BESKE             WR/IR #: WR38216          *00890000
009000*                                                                *00900000
009100* DATE  10/27/2010                                               *00910000
009200*     CHANGE MADE:  TOOK OUT THE CODE IN PARA R100- THAT MIKE PUT*00920000
009300*     IN FOR THE OMS PROJECT.                                    *00930000
009400*     MADE BY:  BARB SCHULTZ           WR/IR #: WR38972          *00940000
009500*                                                                *00950000
009600* DATE  02/22/2012                                               *00960000
009700*     CHANGE MADE:  MODIFIED LOGIC REPLACING INVENTORY CUTOFF    *00970000
009800*     DATE TO USE THE APCNTL-PREV-WK-END-DTE IF THE PLANNED      *00980000
009900*     INVENTORY DATE FALLS DURING CLOSE WEEK. CHANGE MADE IN     *00990000
010000*     Y400-FETCH-INVPAR-CSR.                                     *01000000
010100*     MADE BY:  NANCY EILBES          WR/IR #: CRQ000000020758   *01010000
010200*                                                                *01020003
010300* DATE  10/12/2014                                               *01030000
010400*     CHANGE MADE:  MODIFIED OCCURENCE OF PV-STR-NBR FROM 5000   *01040000
010410*     TO 7000.                                                   *01041003
010420*     MADE BY:  JAVED (COGNIZANT)     WR/IR #: CRQ000000095567   *01042000
010430*                                                                *01043003
010440* DATE  03/12/2015                                               *01044003
010450*     CHANGE MADE:  MODIFIED THE  CALL TO TMDSEAR TO RETRIEVE THE*01045000
010460*     MIN SUB_CL_NBR ALONG WITH MIN MAJ_CL_NBR.                  *01046000
010470*     MADE BY:  PARTHI (COGNIZANT)    WR/IR #: CHG0107045        *01047003
010480*                                                                *01048003
010490* DATE  10/22/2019                                               *01049003
010500*     CHANGE MADE: CHANGES MADE TO THE S500-VALIDATE-DEPT-CLASS  *01050000
010501*     TO FETCH THE VALID SUB CLASS FROM IMT_RECLS TABLE WHEN     *01050100
010502*     INVALID-DEPT-CLASS FOUND.                                  *01050200
010503*     MADE BY:  PARTHI (COGNIZANT)    WR/IR #: CHG0117275        *01050300
010504*                                                                *01050403
010506* DATE  03/28/2019                                               *01050603
010507*     CHANGE MADE: PROGRAM RENAMED TO APKUP161 FOR ERP CUTOVER.  *01050703
010509*     MADE BY:  ELENA MOZNAIM         WR/IR #: CHG0220043        *01050903
010510*                                                                *01051003
010511* DATE  10/22/2019                                               *01051103
010512*     CHANGE MADE: ADDED LOGIC TO ASSIGN THE CLEARING ACCOUNT    *01051203
010513*     AS THE OFFSET ACCOUNT FOR A LIST OF TRANCODES THAT         *01051303
010514*     ORIGINATE IN THE AP MERCHANDISE MATCH.  THIS LIST IS CODED *01051403
010515*     IN WORKING-STORAGE UNDER 88 LEVEL PV-CLEARING-ACCT-CDE.    *01051503
010516*     MADE BY:  NANCY EILBES          WR/IR #: CHG0234141        *01051603
010517*                                                                *01051706
010518* DATE  06/12/2020                                               *01051806
010519*     CHANGE MADE: MODIFIED LOGIC IN Y400-FETCH-INVPAR-CSR TO    *01051906
010520*     CHECK IF THE INVENTORY DATE IS GREATER THAN THE CURRENT    *01052006
010521*     WEEK ENDING DATE WHEN PROCESSING A WEEKLY EXTRACT. STORES  *01052106
010522*     WITH INVENTORY SCHEDULED ON A SUNDAY WERE GETTING CUTOFF   *01052206
010523*     DATE OUTSIDE CURRENT FISCAL WEEK ASSIGNED AND RECORDS WERE *01052306
010524*     REJECTED BY ML FOR INVALID DATES.                          *01052406
010525*     MADE BY:  NANCY EILBES          WR/IR #: CHG0245053        *01052506
010517*                                                                *01052607
010518* DATE  05/11/2021                                               *01052708
010519*     CHANGE MADE: ADD SEPHORA TRAN CODES TO PV-CLEARING-ACCT-CDE*01052807
010519*     SO THEY GO TO THE CLEARING ACCT 20115 AS THEIR OFFSET      *01052907
010525*     MADE BY:  JEAN KURK             CHG0256545                 *01053408
010517*                                                                *01053532
010518* DATE  03/14/2022                                               *01053632
010519*     CHANGE MADE: CORRECT HOW ADJUSTMENT EXTRACT FOR ML UPDATES *01053732
010519*     RECLASSED SKU'S.  CHECK FOR A CHANGE IN BOTH DEPT & CLASS  *01053832
010525*     MADE BY:  JEAN KURK             CHG0267648                 *01053932
010526******************************************************************01054006
010527                                                                  01054106
010528 ENVIRONMENT DIVISION.                                            01054206
010529 CONFIGURATION SECTION.                                           01054306
010530 SOURCE-COMPUTER. IBM-3090.                                       01054406
010531 OBJECT-COMPUTER. IBM-3090.                                       01054506
010532                                                                  01054606
010533 INPUT-OUTPUT SECTION.                                            01054706
010534 FILE-CONTROL.                                                    01054806
010540 DATA DIVISION.                                                   01054900
010550 FILE SECTION.                                                    01055000
010560                                                                  01056000
010570 WORKING-STORAGE SECTION.                                         01057000
010580                                                                  01058000
010590 01  FILLER                        PIC X(25) VALUE                01059000
010600                             'WS FOR APKUP161 BEGINS==>'.         01060000
010700 01  ABEND-CODE                    PIC S9(4) COMP SYNC            01070000
010800                                             VALUE ZEROS.         01080000
010900     88 AP-EMPTY-FILE              VALUE +4005.                   01090000
011000     88 AP-DB2-ERROR               VALUE +4013.                   01100000
011100                                                                  01110000
011200 01  PROGRAM-CONSTANTS.                                           01120000
011300     05  PC-RETRY-MAX             PIC S9(04)    VALUE +3  COMP.   01130000
011400     05  PC-IN-PROCESS-CODE       PIC X(01)     VALUE '9'.        01140000
011500     05  PC-RUN-COMPLETE-CODE     PIC X(01)     VALUE '0'.        01150000
011600     05  PC-RETRY-COUNT           PIC S9(04)    VALUE ZEROS.      01160000
011700     05  PC-PROGRAM-NAME          PIC X(08)     VALUE 'APKUP161'. 01170000
011800                                                                  01180000
011900 01  CONTROL-CARD.                                                01190000
012000     05  CC-PROC-PERIOD-CDE   PIC X(01).                          01200000
012100         88  PROCESS-WEEKLY-EXTRACT      VALUE 'W'.               01210000
012200         88  PROCESS-MONTHLY-EXTRACT     VALUE 'M'.               01220000
012300         88  VALID-PROC-PERIOD           VALUES 'W', 'M'.         01230000
012400                                                                  01240000
012500 01  PV-ABEND-FIELDS.                                             01250000
012600     05  PV-ABEND-PROGRAM             PIC X(8)  VALUE 'APKUP161'. 01260000
012700     05  PV-ABEND-SQLCODE             PIC X(4)  VALUE SPACES.     01270000
012800     05  PV-ABEND-PARAGRAPH           PIC X(50) VALUE SPACES.     01280000
012900     05  PV-ABEND-OPERATION           PIC X(50) VALUE SPACES.     01290000
013000     05  PV-ABEND-STRUCTURE-1         PIC X(8)  VALUE SPACES.     01300000
013100     05  PV-ABEND-STRUCTURE-2         PIC X(8)  VALUE SPACES.     01310000
013200     05  PV-ABEND-STRUCTURE-3         PIC X(8)  VALUE SPACES.     01320000
013300     05  PV-ABEND-STRUCTURE-4         PIC X(8)  VALUE SPACES.     01330000
013400     05  PV-ABEND-STRUCTURE-5         PIC X(8)  VALUE SPACES.     01340000
013500     05  PV-ABEND-STATUS              PIC XX    VALUE SPACES.     01350000
013600     05  AA-PARAGRAPH-NAME            PIC X(50) VALUE SPACES.     01360000
013700                                                                  01370000
013800 01  PV-RECORD-COUNTER.                                           01380000
013900     05  PV-ADJSTMNT-INPUT-CNT        PIC S9(09) COMP-3 VALUE +0. 01390000
014000     05  PV-INVPAR-CNT                PIC S9(09) COMP-3 VALUE +0. 01400000
014100     05  PV-RECORDS-WRITTEN           PIC S9(09) COMP-3 VALUE +0. 01410000
014200     05  PV-ADJSTMNT-CNT              PIC S9(09) COMP   VALUE +0. 01420000
014300     05  PV-TOUTAPG-CNTR              PIC S9(09) COMP   VALUE +0. 01430000
014400     05  PV-TOUTAPH-CNTR              PIC S9(09) COMP   VALUE +0. 01440000
014500     05  PV-TOUTAPF-ERROR-CNT         PIC S9(09) COMP-3 VALUE +0. 01450000
014500     05  PV-TADJRNL-UPD-CNT           PIC S9(09) COMP-3 VALUE +0. 01451025
014500     05  PV-TADJDIS-UPD-CNT           PIC S9(09) COMP-3 VALUE +0. 01452025
014600                                                                  01460000
014700 01  PV-WORK-AREA.                                                01470000
014800     05  PV-CKPT-STAT-CODE            PIC X(01)  VALUE SPACE.     01480000
014900     05  PV-RETRY-COUNT               PIC S9(04) VALUE ZEROS      01490000
015000                                                 COMP.            01500000
015100     05  PV-HOLD-VND-NBR              PIC X(09)  VALUE SPACES.    01510000
015200     05  PV-HOLD-DOC-NBR              PIC X(16)  VALUE SPACES.    01520000
015300     05  PV-HOLD-DOC-DTE              PIC X(10)  VALUE SPACES.    01530000
015400     05  PV-HOLD-TRN-CDE              PIC X(02)  VALUE SPACES.    01540000
015500     05  PV-USE-MAJ-CL-NBR            PIC X(02)  VALUE SPACES.    01550000
015600     05  PV-USE-SUB-CL-NBR            PIC X(02)  VALUE SPACES.    01560000
015600     05  PV-USE-DEPT-NBR              PIC X(03)  VALUE SPACES.    01561020
015600     05  PV-NEW-SUB-CL-NBR            PIC X(02)  VALUE SPACES.    01562020
015600     05  PV-NEW-DEPT-NBR              PIC X(03)  VALUE SPACES.    01563020
015700*PRB52368 START                                                   01570000
015800     05  PV-HOLD-SUB-CL-NBR           PIC 9(02)  VALUE ZEROS.     01580000
015900     05  PV-IMT-MAJ-CL-NBR            PIC 9(02)  VALUE ZEROS.     01590000
016000     05  PV-IMT-SUB-CL-NBR            PIC 9(02)  VALUE ZEROS.     01600000
016000     05  PV-IMT-DEPT-NBR              PIC 9(03)  VALUE ZEROS.     01601024
016100*PRB52368 END                                                     01610000
016200     05  PV-HOLD-CL-NBR               PIC X(02)  VALUE SPACES.    01620000
016300     05  PV-HOLD-MCL-NBR.                                         01630000
016400         10  PV-MAJ-CL-HOLDER         PIC X(01)  VALUE SPACES.    01640000
016500         10  PV-MAJ-CONSTANT          PIC X(01)  VALUE '0'.       01650000
016600     05  HOLD-DMA-NBR                 PIC X(02)  VALUE SPACES.    01660000
016700     05  HOLD-DEPT-NBR                PIC X(03)  VALUE SPACES.    01670000
016800     05  PV-HOLD-ENT-ID               PIC S9(09) VALUE ZEROS      01680000
016900                                                 COMP.            01690000
017000     05  PV-ENTR-DATE                 PIC X(10)  VALUE SPACES.    01700000
017100     05  PV-HOLD-DEPT-NBR             PIC X(03)  VALUE SPACES.    01710000
017200     05  PV-HOLD-DMA-NBR              PIC X(02)  VALUE SPACES.    01720000
017300                                                                  01730000
017400     05  PV-LOW-FISCAL-WEEK           PIC X(02)  VALUE SPACES.    01740000
017500     05  PV-HIGH-FISCAL-WEEK          PIC X(09)  VALUE SPACES.    01750000
017600                                                                  01760000
017700     05  PV-MO-LAST-DAY               PIC X(10)  VALUE SPACES.    01770000
017800     05  PV-FISCAL-YEAR               PIC X(04)  VALUE SPACES.    01780000
017900     05  PV-FISCAL-MONTH              PIC X(02)  VALUE SPACES.    01790000
018000                                                                  01800000
018100     05  PV-AP046-RECORDS-WRITTEN     PIC S9(09) COMP-3 VALUE +0. 01810000
018200     05  PV-AP047-RECORDS-WRITTEN     PIC S9(09) COMP-3 VALUE +0. 01820000
018300     05  PV-ONE                       PIC X(01).                  01830000
018400     05  PV-STR-NBR                   PIC 9(04)  VALUE ZEROES.    01840000
018410     05  PV-OFFSET-ACCT-CDE           PIC X(02).                  01841001
018420         88  PV-CLEARING-ACCT-CDE                VALUE            01842001
018500            '0E', '28', '29', '2A', '2B', '2C', '2E',             01850001
018510            'QT', 'QU', 'QV', 'QW', 'QX',                         01851007
018510            '5A', '6C', '6K', '71', '7A', '7B'.                   01852007
018600* HOLDS CUTOFF DATES FOR STORES                                   01860000
018700 01  PV-INVDATE-TABLE.                                            01870000
018800     05  PV-INVDATE-TBL OCCURS 7000 TIMES INDEXED BY PV-STR-IDX.  01880000
018900         10  PV-LOC-NBR               PIC 9(04)  VALUE ZEROES.    01890000
019000         10  PV-INV-DTE               PIC X(10)  VALUE SPACES.    01900000
019100*                                                                 01910000
019200 01  PV-SWITCHES.                                                 01920000
019300     05  END-OF-ADJSTMNT-CSR-SW       PIC X(01)  VALUE ' '.       01930000
019400         88  NOT-END-OF-ADJSTMNT-CSR             VALUE ' '.       01940000
019500         88  END-OF-ADJSTMNT-CSR                 VALUE 'Y'.       01950000
019600     05  END-OF-INVPAR-CSR-SW         PIC X(01)  VALUE ' '.       01960000
019700         88  NOT-END-OF-INVPAR-CSR               VALUE ' '.       01970000
019800         88  END-OF-INVPAR-CSR                   VALUE 'Y'.       01980000
019900     05  CR-CKPT-STAT-CODE            PIC X(01)  VALUE ' '.       01990000
020000         88  NORMAL-RUN                          VALUE '0'.       02000000
020100         88  RESTART-RUN                         VALUE '9'.       02010000
020200     05  PS-COMMITS-SW                PIC X(01)  VALUE ' '.       02020000
020300         88  NO-COMMITS-TAKEN                    VALUE 'N'.       02030000
020400         88  COMMITS-TAKEN                       VALUE 'Y'.       02040000
020500     05  PS-INVALID-DMA-NBR-SW        PIC X(01)  VALUE ' '.       02050000
020600         88  VALID-DMA-NBR                       VALUE 'N'.       02060000
020700         88  INVALID-DMA-NBR                     VALUE 'Y'.       02070000
020800     05  PS-VALID-DEPT-CLASS-SW       PIC X(01)  VALUE ' '.       02080000
020900         88  VALID-DEPT-CLASS                    VALUE 'N'.       02090000
021000         88  INVALID-DEPT-CLASS                  VALUE 'Y'.       02100000
020800     05  PS-VALID-DEPT-SW             PIC X(01)  VALUE ' '.       02101020
020900         88  VALID-DEPT                          VALUE 'N'.       02102020
021000         88  INVALID-DEPT                        VALUE 'Y'.       02103020
020800     05  PS-TADJRNL-UPD-SW            PIC X(01)  VALUE ' '.       02104028
020900         88  TADJRNL-UPD-READY                   VALUE 'N'.       02105028
021000         88  TADJRNL-UPD-DONE                    VALUE 'Y'.       02106028
021100     05  PS-NO-DATA-FOUND-SW          PIC X(01)  VALUE ' '.       02110000
021200         88  DATA-FOUND                          VALUE 'N'.       02120000
021300         88  NO-DATA-FOUND                       VALUE 'Y'.       02130000
021400                                                                  02140000
021500 01  PV-PREV-FISCAL.                                              02150000
021600     05  PV-PREV-PSTG-FYR-NBR         PIC X(04)  VALUE SPACES.    02160000
021700     05  PV-PREV-PSTG-FMN-NBR         PIC X(02)  VALUE SPACES.    02170000
021800                                                                  02180000
021900 01  CR-CKPT-RESTART-INFO.                                        02190000
022000     05  CR-VND-NBR                   PIC  X(09) VALUE SPACES.    02200000
022100     05  CR-DOC-NBR                   PIC  X(16) VALUE SPACES.    02210000
022200     05  CR-DOC-DTE                   PIC  X(10) VALUE SPACES.    02220000
022300     05  CR-AP-TRN-CDE                PIC  X(02) VALUE SPACES.    02230000
022400     05  CR-INVALID-DMA-SW            PIC  X(01) VALUE SPACES.    02240000
022500     05  CR-AP046-RECORDS-WRITTEN     PIC  S9(09) COMP-3 VALUE +0.02250000
022600     05  CR-AP047-RECORDS-WRITTEN     PIC  S9(09) COMP-3 VALUE +0.02260000
022700     05  CR-ADJSTMNT-CNT              PIC  S9(09) COMP-3 VALUE +0.02270000
022800                                                                  02280000
022900 01  CKPT-RESTART-TMST.                                           02290000
023000     05  CR-CURR-TMST                 PIC X(26)  VALUE SPACES.    02300000
023100     05  CR-NEXT-TMST                 PIC X(26)  VALUE SPACES.    02310000
023200*                                                                 02320000
023300 01  FILLER                          PIC X(35)  VALUE             02330000
023400     'BEGINNING OF AP WORK RECORD AREA **'.                       02340000
023500     COPY APRD046.                                                02350000
023600                                                                  02360000
023700     COPY APRD047.                                                02370000
023800                                                                  02380000
023900     COPY APRD041.                                                02390000
024000                                                                  02400000
024100     COPY DPWS004.                                                02410000
024200                                                                  02420000
024300*----------------------------------------------------------------*02430000
024400*  WORKING STORAGE AREA FOR DPKUT500, DATE MANIPULATION ROUTINE  *02440000
024500*----------------------------------------------------------------*02450000
024600     COPY DPWS500.                                                02460000
024700 01  FILLER                          PIC X(35)  VALUE             02470000
024800     'END OF AP WORK RECORD AREA       **'.                       02480000
024900                                                                  02490000
025000******************************************************************02500000
025100*  COMMUNICATIONS AREA2 FOR DB2                                   02510000
025200******************************************************************02520000
025300     COPY SQLCA2.                                                 02530000
025400                                                                  02540000
025500     EXEC SQL                                                     02550000
025600          INCLUDE SQLCA                                           02560000
025700     END-EXEC.                                                    02570000
025800                                                                  02580000
025900*----------------------------------------------------------------*02590000
026000*      TAPCNTL TABLE LAYOUT                                       02600000
026100*----------------------------------------------------------------*02610000
026200*                                                                 02620000
026300     EXEC SQL                                                     02630000
026400          INCLUDE TAPCNTL                                         02640000
026500     END-EXEC.                                                    02650000
026600                                                                  02660000
026700*----------------------------------------------------------------*02670000
026800*      TADJRNL TABLE LAYOUT                                       02680000
026900*----------------------------------------------------------------*02690000
027000*                                                                 02700000
027100     EXEC SQL                                                     02710000
027200          INCLUDE TADJRNL                                         02720000
027300     END-EXEC.                                                    02730000
027400                                                                  02740000
027500*----------------------------------------------------------------*02750000
027600*      TADJDIS TABLE LAYOUT                                       02760000
027700*----------------------------------------------------------------*02770000
027800*                                                                 02780000
027900     EXEC SQL                                                     02790000
028000          INCLUDE TADJDIS                                         02800000
028100     END-EXEC.                                                    02810000
028200                                                                  02820000
028300*----------------------------------------------------------------*02830000
028400*      TTRNCDE TABLE LAYOUT                                       02840000
028500*----------------------------------------------------------------*02850000
028600     EXEC SQL                                                     02860000
028700          INCLUDE TTRNCDE                                         02870000
028800     END-EXEC.                                                    02880000
028900                                                                  02890000
029000*----------------------------------------------------------------*02900000
029100*      TMDSEAR TABLE LAYOUT                                       02910000
029200*----------------------------------------------------------------*02920000
029300     EXEC SQL                                                     02930000
029400          INCLUDE TMDSEAR                                         02940000
029500     END-EXEC.                                                    02950000
029600                                                                  02960000
029700*----------------------------------------------------------------*02970000
029800* APPLICATION AVAILABILITY TABLE                                  02980000
029900*----------------------------------------------------------------*02990000
030000                                                                  03000000
030100     EXEC SQL                                                     03010000
030200         INCLUDE TAPLAVL                                          03020000
030300     END-EXEC.                                                    03030000
030400*----------------------------------------------------------------*03040000
030500*      TRSPBAR TABLE LAYOUT                                       03050000
030600*----------------------------------------------------------------*03060000
030700     EXEC SQL                                                     03070000
030800          INCLUDE TRSPBAR                                         03080000
030900     END-EXEC.                                                    03090000
031000                                                                  03100000
031100*----------------------------------------------------------------*03110000
031200*      TENTNME TABLE LAYOUT                                       03120000
031300*----------------------------------------------------------------*03130000
031400     EXEC SQL                                                     03140000
031500          INCLUDE TENTNME                                         03150000
031600     END-EXEC.                                                    03160000
031700                                                                  03170000
031800*----------------------------------------------------------------*03180000
031900*      TOUTAPH TABLE LAYOUT                                       03190000
032000*----------------------------------------------------------------*03200000
032100     EXEC SQL                                                     03210000
032200          INCLUDE TOUTAPH                                         03220000
032300     END-EXEC.                                                    03230000
032400                                                                  03240000
032500*----------------------------------------------------------------*03250000
032600*      TOUTAPG TABLE LAYOUT                                       03260000
032700*----------------------------------------------------------------*03270000
032800     EXEC SQL                                                     03280000
032900          INCLUDE TOUTAPG                                         03290000
033000     END-EXEC.                                                    03300000
033100                                                                  03310000
033200*----------------------------------------------------------------*03320000
033300*      TCKRSTCNTL TABLE LAYOUT                                    03330000
033400*----------------------------------------------------------------*03340000
033500         EXEC SQL                                                 03350000
033600             INCLUDE TCKRSTCN                                     03360000
033700         END-EXEC.                                                03370000
033800                                                                  03380000
033900*----------------------------------------------------------------*03390000
034000*      TCKRSTINF TABLE LAYOUT                                     03400000
034100*----------------------------------------------------------------*03410000
034200         EXEC SQL                                                 03420000
034300             INCLUDE TCKRSTIN                                     03430000
034400         END-EXEC.                                                03440000
034500*----------------------------------------------------------------*03450000
034600*      TOUTAPF TABLE LAYOUT                                      *03460000
034700*----------------------------------------------------------------*03470000
034800        EXEC SQL                                                  03480000
034900            INCLUDE TOUTAPF                                       03490000
035000        END-EXEC.                                                 03500000
035100*----------------------------------------------------------------*03510000
035200*      TINVPAR TABLE LAYOUT                                      *03520000
035300*----------------------------------------------------------------*03530000
035400        EXEC SQL                                                  03540000
035500            INCLUDE TINVPAR                                       03550000
035600        END-EXEC.                                                 03560000
035700*----------------------------------------------------------------*03570000
035800*      IMT_RECLS TABLE LAYOUT                                    *03580000
035900*----------------------------------------------------------------*03590000
036000        EXEC SQL                                                  03600000
036100            INCLUDE IMT00015                                      03610000
036200        END-EXEC.                                                 03620000
036201*---------------------------------------------------------------* 03620100
036202*    DB2 AREA FOR SYSDUMMY1                                     * 03620200
036203*---------------------------------------------------------------* 03620300
036204     EXEC SQL                                                     03620400
036205          INCLUDE SYSDUMMY                                        03620500
036206     END-EXEC.                                                    03620600
036207*----------------------------------------------------------------*03620700
036208* ADJSTMNT_CSR GETS ALL ADJUSTMENT TRANSACTIONS                  *03620800
036209*----------------------------------------------------------------*03620900
036210     EXEC SQL                                                     03621000
036220       DECLARE ADJSTMNT_CSR  CURSOR WITH HOLD FOR                 03622000
036230         SELECT                                                   03623000
036240             AJ.VND_NBR                                           03624000
036250           , AJ.DOC_NBR                                           03625000
036260           , AJ.DOC_DTE                                           03626000
036270           , AJ.AP_TRN_CDE                                        03627000
036280           , AJ.PO_NBR                                            03628000
036290           , AJ.DEPT_NBR                                          03629000
036300           , AJ.STR_NBR                                           03630000
036400           , AJ.GL_ACCT_NBR                                       03640000
036500           , DATE(AJ.ENTR_TMST)                                   03650000
036600           , AJ.PSTG_FYR_NBR                                      03660000
036700           , AJ.PSTG_FMN_NBR                                      03670000
036800           , AJ.PSTG_FWK_NBR                                      03680000
036900           , AJ.INV_CTOFF_DTE                                     03690000
037000           , AJ.ENT_ID                                            03700000
037100           , TR.PSTG_TYP_CDE                                      03710000
037200           , TR.TRN_TYP_CDE                                       03720000
037300           , TR.TRN_SHRT_DESC                                     03730000
037400           , TR.GL_PSTG_IND                                       03740000
037500           , TR.ML_PSTG_IND                                       03750000
037600           , TR.AP_PSTG_IND                                       03760000
037610           , TR.BTCH_SRC_CDE                                      03761001
037700           , AD.STR_NBR                                           03770000
037800           , AD.CL_NBR                                            03780000
037900           , AD.SKU_NBR                                           03790000
038000           , AD.GRO_COST_AMT                                      03800000
038100           , AD.RTL_AMT                                           03810000
038200           , AD.FRGT_AMT                                          03820000
038210           , AD.MISC_CHRG_AMT                                     03821000
038220           , AD.DISC_AMT                                          03822000
038230           , AD.NET_COST_AMT                                      03823000
038240           , AD.DISTRB_SEQ_NBR                                    03824000
038250         FROM                                                     03825000
038260             TADJRNL AJ                                           03826000
038270           , TADJDIS AD                                           03827000
038280           , TTRNCDE TR                                           03828000
038290         WHERE                                                    03829000
038300               AJ.AP_TRN_CDE       = AD.AP_TRN_CDE                03830000
038400           AND AJ.AP_TRN_CDE       = TR.AP_TRN_CDE                03840000
038500           AND AJ.VND_NBR          = AD.VND_NBR                   03850000
038600           AND AJ.DOC_NBR          = AD.DOC_NBR                   03860000
038700           AND AJ.DOC_DTE          = AD.DOC_DTE                   03870000
038800           AND TR.EFF_STRT_DTE    <= :APCNTL-BTCH-PRC-DTE         03880000
038900           AND TR.EFF_END_DTE     >  :APCNTL-BTCH-PRC-DTE         03890000
039000           AND (TR.GL_PSTG_IND     = 'Y'                          03900000
039100                OR TR.ML_PSTG_IND  = 'Y')                         03910000
039200           AND AJ.PSTG_FYR_NBR     = :PV-FISCAL-YEAR              03920000
039300           AND AJ.PSTG_FMN_NBR     = :PV-FISCAL-MONTH             03930000
039400           AND AJ.PSTG_FWK_NBR BETWEEN :PV-LOW-FISCAL-WEEK        03940000
039500                               AND     :PV-HIGH-FISCAL-WEEK       03950000
039600           AND AJ.DOC_EXTR_IND     = 'N'                          03960000
039700           AND AJ.PS_PSTG_IND      = 'Y'                          03970000
039800         ORDER BY                                                 03980000
039900             AJ.VND_NBR                                           03990000
040000           , AJ.DOC_NBR                                           04000000
040100           , AJ.DOC_DTE                                           04010000
040200           , AJ.AP_TRN_CDE                                        04020000
040300     END-EXEC.                                                    04030000
040400                                                                  04040000
040500*----------------------------------------------------------------*04050000
040600* INVPAR_CSR GETS ALL THE CUTOFF DATES FOR STORES                *04060000
040700*----------------------------------------------------------------*04070000
040800     EXEC SQL                                                     04080000
040900       DECLARE INVPAR_CSR CURSOR FOR                              04090000
041000         SELECT                                                   04100000
041100             PLND_INV_DTE                                         04110000
041200           , LOC_NBR                                              04120000
041300         FROM TINVPAR                                             04130000
041400         WHERE LOC_INV_STAT_CDE  = 'IN'                           04140000
041500           AND CURRENT DATE     >= PLND_INV_DTE                   04150000
041600           AND ACTL_FIN_BK_DTE   = '9999-09-09'                   04160000
041700           AND SCHD_PHY_CNT_CDE <> 'EI'                           04170000
041800         ORDER BY                                                 04180000
041900             LOC_NBR                                              04190000
042000           , PLND_INV_DTE                                         04200000
042100     END-EXEC.                                                    04210000
042200                                                                  04220000
042300*----------------------------------------------------------------*04230000
042400 01  FILLER                        PIC X(38) VALUE                04240000
042500          '<====WORKING STORAGE FOR APKUP161 ENDS'.               04250000
042600                                                                  04260000
042700                                                                  04270000
042800 PROCEDURE DIVISION.                                              04280000
042900                                                                  04290000
043000 A100-MAINLINE.                                                   04300000
043100                                                                  04310000
043200     PERFORM B100-INITIALIZATION.                                 04320000
043300                                                                  04330000
043400     PERFORM B200-PROCESSING                                      04340000
043500        UNTIL END-OF-ADJSTMNT-CSR.                                04350000
043600                                                                  04360000
043700     IF NO-DATA-FOUND                                             04370000
043800        CONTINUE                                                  04380000
043900     ELSE                                                         04390000
044000        PERFORM B300-END-JOB                                      04400000
044100     END-IF.                                                      04410000
044200                                                                  04420000
044300     GOBACK.                                                      04430000
044400        EJECT                                                     04440000
044500                                                                  04450000
044600                                                                  04460000
044700                                                                  04470000
044800*---------------------------------------------------------------* 04480000
044900*    INITIALIZATION                                               04490000
045000*---------------------------------------------------------------* 04500000
045100 B100-INITIALIZATION.                                             04510000
045200                                                                  04520000
045300     MOVE 'B100-INITIALIZATION' TO PV-ABEND-PARAGRAPH.            04530000
045400                                                                  04540000
045500     INITIALIZE DCLTAPCNTL                                        04550000
045600                DCLTADJRNL                                        04560000
045700                DCLTADJDIS                                        04570000
045800                DCLTTRNCDE                                        04580000
045900                DCLTMDSEAR                                        04590000
046000                DCLTRSPBAR                                        04600000
046100                DCLTENTNME                                        04610000
046200                AP046-EXTRACT-FILE                                04620000
046300                AP047-GL-EXTRACT-FILE.                            04630000
046400                                                                  04640000
046500     ACCEPT CONTROL-CARD.                                         04650000
046600     DISPLAY 'CONTROL CARD VALUE = ' CONTROL-CARD.                04660000
046700     SET DATA-FOUND TO TRUE.                                      04670000
046800                                                                  04680000
046900     IF VALID-PROC-PERIOD                                         04690000
047000        CONTINUE                                                  04700000
047100     ELSE                                                         04710000
047200        MOVE 'INVALID PROCESSING PERIOD IN CONTROL CARD '         04720000
047300                                 TO PV-ABEND-OPERATION            04730000
047400        PERFORM Z998-ABEND                                        04740000
047500     END-IF.                                                      04750000
047600                                                                  04760000
047700     IF PROCESS-WEEKLY-EXTRACT                                    04770000
047800        PERFORM S100-APCNTL-CURR-PROC-DTE                         04780000
047900        MOVE APCNTL-CURR-PSTG-FWK-NBR TO PV-LOW-FISCAL-WEEK       04790000
048000                                         PV-HIGH-FISCAL-WEEK      04800000
048100        MOVE APCNTL-CURR-PSTG-FYR-NBR TO PV-FISCAL-YEAR           04810000
048200        MOVE APCNTL-CURR-PSTG-FMN-NBR TO PV-FISCAL-MONTH          04820000
048300        DISPLAY 'CURR-PSTG-FYR-NBR-PROC = '                       04830000
048400                                         APCNTL-CURR-PSTG-FYR-NBR 04840000
048500        DISPLAY 'CURR-PSTG-FMN-NBR-PROC = '                       04850000
048600                                         APCNTL-CURR-PSTG-FMN-NBR 04860000
048700        DISPLAY 'CURR-PSTG-FWK-NBR-PROC = '                       04870000
048800                                         APCNTL-CURR-PSTG-FWK-NBR 04880000
048900     ELSE                                                         04890000
049000        IF PROCESS-MONTHLY-EXTRACT                                04900000
049100           PERFORM S200-APCNTL-PREV-PROC-DTE                      04910000
049200           MOVE ZEROS TO PV-LOW-FISCAL-WEEK                       04920000
049300           MOVE 9     TO PV-HIGH-FISCAL-WEEK                      04930000
049400           MOVE APCNTL-PREV-PSTG-FYR-NBR TO PV-FISCAL-YEAR        04940000
049500           MOVE APCNTL-PREV-PSTG-FMN-NBR TO PV-FISCAL-MONTH       04950000
049600           PERFORM D100-DATE-ROUTINE                              04960000
049700           DISPLAY 'PREV-PSTG-FYR-NBRP-PROC = '                   04970000
049800                                         APCNTL-PREV-PSTG-FYR-NBR 04980000
049900           DISPLAY 'PREV-PSTG-FMN-NBRP-PROC = '                   04990000
050000                                         APCNTL-PREV-PSTG-FMN-NBR 05000000
050100           DISPLAY 'PREV-PSTG-FWK-NBRP-PROC = '                   05010000
050200                                         APCNTL-PREV-PSTG-FWK-NBR 05020000
050300        END-IF                                                    05030000
050400     END-IF.                                                      05040000
050500                                                                  05050000
050600     PERFORM Y100-OPEN-ADJSTMNT-CSR.                              05060000
050700                                                                  05070000
050800     PERFORM R200-GET-CHECKPOINT-CNTL.                            05080000
050900     MOVE PV-CKPT-STAT-CODE TO CR-CKPT-STAT-CODE.                 05090000
051000                                                                  05100000
051100     IF RESTART-RUN                                               05110000
051200        PERFORM H200-CHECKPOINT-RESTART                           05120000
051300     ELSE                                                         05130000
051400        SET NOT-END-OF-ADJSTMNT-CSR TO TRUE                       05140000
051500        PERFORM R100-FETCH-ADJSTMNT-CSR                           05150000
051600        IF END-OF-ADJSTMNT-CSR                                    05160000
051700           DISPLAY '**********************************'           05170000
051800           DISPLAY '**                              **'           05180000
051900           DISPLAY '** WARNING:  NO DATA TO EXTRACT **'           05190000
052000           DISPLAY '**                              **'           05200000
052100           DISPLAY '**********************************'           05210000
052200           SET NO-DATA-FOUND TO TRUE                              05220000
052300        END-IF                                                    05230000
052400     END-IF.                                                      05240000
052500                                                                  05250000
052600     MOVE ADJRNL-VND-NBR    TO PV-HOLD-VND-NBR.                   05260000
052700     MOVE ADJRNL-DOC-NBR    TO PV-HOLD-DOC-NBR.                   05270000
052800     MOVE ADJRNL-DOC-DTE    TO PV-HOLD-DOC-DTE.                   05280000
052900     MOVE ADJRNL-AP-TRN-CDE TO PV-HOLD-TRN-CDE.                   05290000
053000                                                                  05300000
053100     DISPLAY 'PROGRAM NAME = ' PC-PROGRAM-NAME                    05310000
053200     DISPLAY 'BATCH PROCESS DATE = ' APCNTL-BTCH-PRC-DTE.         05320000
053300                                                                  05330000
053400     IF END-OF-ADJSTMNT-CSR                                       05340000
053500        PERFORM Y200-CLOSE-ADJSTMNT-CSR                           05350000
053600     END-IF.                                                      05360000
053700                                                                  05370000
053800     PERFORM Y300-OPEN-INVPAR-CSR.                                05380000
053900     INITIALIZE PV-INVDATE-TABLE.                                 05390000
054000     PERFORM Y400-FETCH-INVPAR-CSR                                05400000
054100        VARYING PV-STR-IDX FROM 1 BY 1                            05410000
054200        UNTIL PV-STR-IDX >= 7000 OR                               05420000
054300              END-OF-INVPAR-CSR.                                  05430000
054400     PERFORM Y500-CLOSE-INVPAR-CSR.                               05440000
054500                                                                  05450000
054600***************************************************************** 05460000
054700*     PROCESS EACH PO FETCHED FROM CURSOR                         05470000
054800***************************************************************** 05480000
054900 B200-PROCESSING.                                                 05490000
055000                                                                  05500000
055100     MOVE 'B200-PROCESSING  '     TO PV-ABEND-PARAGRAPH.          05510000
055200                                                                  05520000
055300     IF  ADJRNL-VND-NBR    = PV-HOLD-VND-NBR                      05530000
055400     AND ADJRNL-DOC-NBR    = PV-HOLD-DOC-NBR                      05540000
055500     AND ADJRNL-DOC-DTE    = PV-HOLD-DOC-DTE                      05550000
055600     AND ADJRNL-AP-TRN-CDE = PV-HOLD-TRN-CDE                      05560000
055700         CONTINUE                                                 05570000
055800     ELSE                                                         05580000
055900         IF  VALID-DMA-NBR                                        05590000
056000             PERFORM U300-UPDATE-ADJSTMNT-HDR                     05600000
056100         END-IF                                                   05610000
056200         PERFORM H100-CHECKPOINT-COMMIT                           05620000
056300         MOVE ADJRNL-VND-NBR    TO PV-HOLD-VND-NBR                05630000
056400         MOVE ADJRNL-DOC-NBR    TO PV-HOLD-DOC-NBR                05640000
056500         MOVE ADJRNL-DOC-DTE    TO PV-HOLD-DOC-DTE                05650000
056600         MOVE ADJRNL-AP-TRN-CDE TO PV-HOLD-TRN-CDE                05660000
056600         SET TADJRNL-UPD-READY  TO TRUE                           05661028
056700     END-IF.                                                      05670000
056800                                                                  05680000
056900     IF  TRNCDE-ML-PSTG-IND = 'Y'                                 05690000
057000         PERFORM C100-BUILD-AP046-EXTRACT                         05700000
057100     ELSE                                                         05710000
057200         SET VALID-DMA-NBR      TO TRUE                           05720000
057300         SET VALID-DEPT-CLASS   TO TRUE                           05730000
057300         SET VALID-DEPT         TO TRUE                           05731020
057400     END-IF.                                                      05740000
057500                                                                  05750000
057600     IF  TRNCDE-GL-PSTG-IND = 'Y' AND VALID-DMA-NBR               05760000
057700         PERFORM C200-BUILD-AP047-EXTRACT                         05770000
057800     END-IF.                                                      05780000
057900                                                                  05790000
058000     PERFORM R100-FETCH-ADJSTMNT-CSR.                             05800000
058100                                                                  05810000
058200 EJECT                                                            05820000
058300 B300-END-JOB.                                                    05830000
058400*                                                                 05840000
058500***************************************************************** 05850000
058600*  PERFORM FINAL UPDATE OF EXTRACT INDICATOR AND FINAL COMMIT,    05860000
058700*  CLOSE ALL FILES, DISPLAY RUN TOTALS.                           05870000
058800***************************************************************** 05880000
058900*                                                                 05890000
059000     MOVE 'B300-END-JOB  ' TO PV-ABEND-PARAGRAPH.                 05900000
059100                                                                  05910000
059200     IF VALID-DMA-NBR                                             05920000
059300        PERFORM U300-UPDATE-ADJSTMNT-HDR                          05930000
059400     END-IF.                                                      05940000
059500                                                                  05950000
059600     MOVE PC-RUN-COMPLETE-CODE TO PV-CKPT-STAT-CODE.              05960000
059700     MOVE ZEROS                TO CR-CKPT-RESTART-INFO.           05970000
059800                                                                  05980000
059900                                                                  05990000
060000     DISPLAY '************************************************'.  06000000
060100     DISPLAY 'TOTAL ADJSTMNT ROWS FETCHED    = '                  06010000
060200              PV-ADJSTMNT-CNT.                                    06020000
060300     DISPLAY '************************************************'.  06030000
060400     DISPLAY 'TOTAL AP046 RECORDS WRITTEN    = '                  06040000
060500              PV-AP046-RECORDS-WRITTEN                            06050000
060600     DISPLAY '************************************************'.  06060000
060700     DISPLAY 'TOTAL AP047 RECORDS WRITTEN    = '                  06070000
060800              PV-AP047-RECORDS-WRITTEN                            06080000
060900     DISPLAY '************************************************'.  06090000
061000     DISPLAY 'PROGRAM NAME                   = '                  06100000
061100              PC-PROGRAM-NAME.                                    06110000
061200     DISPLAY '************************************************'.  06120000
061300     DISPLAY 'BTCH-PRC-DTE                   = '                  06130000
061400              APCNTL-BTCH-PRC-DTE.                                06140000
061500     DISPLAY '************************************************'.  06150000
061600     DISPLAY 'TOTAL ERROR RECORDS WRITTEN    = '                  06160000
061700              PV-TOUTAPF-ERROR-CNT.                               06170000
061800     DISPLAY '************************************************'.  06180000
061600     DISPLAY 'TOTAL TADJRNL ROWS UPDATED     = '                  06181025
061700              PV-TADJRNL-UPD-CNT.                                 06182025
061800     DISPLAY '************************************************'.  06183025
061600     DISPLAY 'TOTAL TADJDIS ROWS UPDATED     = '                  06184025
061700              PV-TADJDIS-UPD-CNT.                                 06185025
061800     DISPLAY '************************************************'.  06186025
061900                                                                  06190000
062000     PERFORM U400-UPDATE-TCKRSTCNTL.                              06200000
062100     PERFORM U500-UPDATE-TCKRSTINF.                               06210000
062200     PERFORM Z100-COMMIT.                                         06220000
062300     PERFORM Y200-CLOSE-ADJSTMNT-CSR.                             06230000
062400                                                                  06240000
062500                                                                  06250000
062600 C100-BUILD-AP046-EXTRACT.                                        06260000
062700*                                                                 06270000
062800************************************************************      06280000
062900*     UPDATE THE INFORMATION FED TO THE MERCHANDISE LEDGER        06290000
063000************************************************************      06300000
063100*                                                                 06310000
063200     MOVE 'C100-BUILD-AP046-EXTRACT'    TO PV-ABEND-PARAGRAPH.    06320000
063300                                                                  06330000
063400     MOVE ZEROES  TO AP046-RETL-AMT.                              06340000
063500     MOVE ZEROES  TO AP046-GRO-COST-AMT.                          06350000
063600     MOVE ZEROES  TO AP046-FRGT-AMT.                              06360000
063700     MOVE ZEROES  TO AP046-MISC-CHRG-AMT.                         06370000
063800     MOVE ZEROES  TO AP046-NET-COST-AMT.                          06380000
063900     MOVE ZEROES  TO AP046-DISC-AMT.                              06390000
064000                                                                  06400000
064100*    MOVE ADJRNL-DEPT-NBR TO AP046-DEPT-NBR.                      06410019
064200                                                                  06420000
064300     IF  ADJRNL-DEPT-NBR = PV-HOLD-DEPT-NBR                       06430000
064400         MOVE MDSEAR-DMA-NBR TO AP046-DMA-NBR                     06440000
064500         IF  ADJDIS-CL-NBR = PV-HOLD-CL-NBR                       06450000
064600             CONTINUE                                             06460000
064700         ELSE                                                     06470000
064800             IF VALID-DMA-NBR                                     06480000
064900                MOVE ADJDIS-CL-NBR TO PV-HOLD-CL-NBR              06490000
065000                STRING '0'           DELIMITED BY SIZE            06500000
065100                       ADJDIS-CL-NBR DELIMITED BY SIZE            06510000
065200                  INTO MDSEAR-SUB-CL-NBR                          06520000
065300                PERFORM S500-VALIDATE-DEPT-CLASS                  06530000
065400            END-IF                                                06540000
065500         END-IF                                                   06550000
065600     ELSE                                                         06560000
065700         IF  ADJRNL-DEPT-NBR NOT = SPACES                         06570000
065800*            MOVE AP046-DEPT-NBR TO PV-HOLD-DEPT-NBR              06580019
065800             MOVE ADJRNL-DEPT-NBR TO PV-HOLD-DEPT-NBR             06581019
065900         ELSE                                                     06590000
066000             MOVE ZEROES         TO PV-HOLD-DEPT-NBR              06600000
066100         END-IF                                                   06610000
066100         MOVE ZERO               TO PV-USE-DEPT-NBR               06611026
066200         PERFORM S400-SELECT-DIVISION-NBR                         06620000
066300         MOVE MDSEAR-DMA-NBR TO AP046-DMA-NBR                     06630000
066400         MOVE ADJDIS-CL-NBR TO PV-HOLD-CL-NBR                     06640000
066500         IF VALID-DMA-NBR                                         06650000
066600            STRING '0'           DELIMITED BY SIZE                06660000
066700                   ADJDIS-CL-NBR DELIMITED BY SIZE                06670000
066800              INTO MDSEAR-SUB-CL-NBR                              06680000
066900            PERFORM S500-VALIDATE-DEPT-CLASS                      06690000
067000         END-IF                                                   06700000
067100     END-IF.                                                      06710000
067200                                                                  06720000
064100     IF PV-USE-DEPT-NBR NOT = ZERO AND                            06721026
064100        ADJRNL-DEPT-NBR NOT = PV-USE-DEPT-NBR                     06721126
064100         MOVE PV-USE-DEPT-NBR TO AP046-DEPT-NBR                   06722019
064100         SET INVALID-DEPT     TO TRUE                             06722120
064100     ELSE                                                         06723019
064100         MOVE ADJRNL-DEPT-NBR TO AP046-DEPT-NBR                   06724019
064100     END-IF.                                                      06725019
064100                                                                  06726019
067300     MOVE PV-USE-MAJ-CL-NBR      TO AP046-MAJ-CL-NBR.             06730000
067400     MOVE PV-USE-SUB-CL-NBR      TO AP046-CL-NBR.                 06740000
067500     MOVE ADJDIS-SKU-NBR         TO AP046-SKU-NBR.                06750000
067600     MOVE ADJRNL-VND-NBR         TO AP046-VND-NBR.                06760000
067700     MOVE ADJRNL-PO-NBR          TO AP046-PO-NBR.                 06770000
067800     MOVE ADJRNL-STR-NBR         TO AP046-HDR-STR-NBR.            06780000
067900     MOVE ADJDIS-STR-NBR         TO AP046-STR-NBR.                06790000
068000     MOVE ADJRNL-DOC-NBR         TO AP046-DOC-NBR.                06800000
068100     MOVE ADJRNL-DOC-DTE         TO AP046-DOC-DTE.                06810000
068200     MOVE ADJRNL-AP-TRN-CDE      TO AP046-AP-TRN-CDE.             06820000
068300     MOVE TRNCDE-TRN-SHRT-DESC   TO AP046-TRN-SHRT-DESC.          06830000
068400                                                                  06840000
068500     IF ADJRNL-ENT-ID = PV-HOLD-ENT-ID                            06850000
068600        MOVE ENTNME-ENT-NAME-DESC TO AP046-ENT-NME-DESC           06860000
068700     ELSE                                                         06870000
068800        PERFORM S300-GET-VENDOR-NAME                              06880000
068900        MOVE ENTNME-ENT-NAME-DESC TO AP046-ENT-NME-DESC           06890000
069000        MOVE ENTNME-ENT-ID        TO PV-HOLD-ENT-ID               06900000
069100     END-IF.                                                      06910000
069200                                                                  06920000
069300     MOVE TRNCDE-PSTG-TYP-CDE    TO AP046-PSTG-TYP-CDE.           06930000
069400     MOVE ADJRNL-PSTG-FYR-NBR    TO AP046-PSTG-FYR-NBR.           06940000
069500     MOVE ADJRNL-PSTG-FMN-NBR    TO AP046-PSTG-FMN-NBR.           06950000
069600     MOVE ADJRNL-PSTG-FWK-NBR    TO AP046-PSTG-FWK-NBR.           06960000
069700     MOVE ADJDIS-STR-NBR         TO PV-STR-NBR.                   06970000
069800                                                                  06980000
069900     IF  PV-LOC-NBR(PV-STR-NBR) > ZERO                            06990000
070000     AND PV-LOC-NBR(PV-STR-NBR) = ADJDIS-STR-NBR                  07000000
070100     AND ADJRNL-DOC-DTE <= PV-INV-DTE(PV-STR-NBR)                 07010000
070200         MOVE PV-INV-DTE(PV-STR-NBR) TO AP046-INV-CUTOFF-DTE      07020000
070300     ELSE                                                         07030000
070400         MOVE ADJRNL-INV-CTOFF-DTE   TO AP046-INV-CUTOFF-DTE      07040000
070500     END-IF.                                                      07050000
070600                                                                  07060000
070700     MOVE ADJDIS-RTL-AMT         TO AP046-RETL-AMT.               07070000
070800     MOVE ADJDIS-GRO-COST-AMT    TO AP046-GRO-COST-AMT.           07080000
070900     MOVE ADJDIS-FRGT-AMT        TO AP046-FRGT-AMT.               07090000
071000     MOVE ADJDIS-MISC-CHRG-AMT   TO AP046-MISC-CHRG-AMT.          07100000
071100     MOVE ADJDIS-NET-COST-AMT    TO AP046-NET-COST-AMT.           07110000
071200     MOVE ADJDIS-DISC-AMT        TO AP046-DISC-AMT.               07120000
071300     MOVE ADJRNL-ENTR-TMST       TO AP046-ENTR-DTE.               07130000
071400                                                                  07140000
071500*    MOVE AP046-EXTRACT-FILE    TO OUTAPG-ADJ-ML-EXTR-ODR.        07150000
071600*    PERFORM U200-INSERT-OUTAPG-RECORDS.                          07160000
071700*    ADD 1 TO PV-AP046-RECORDS-WRITTEN.                           07170000
071800     IF VALID-DMA-NBR                                             07180000
071900         MOVE AP046-EXTRACT-FILE TO OUTAPG-ADJ-ML-EXTR-ODR        07190000
072000         PERFORM U200-INSERT-OUTAPG-RECORDS                       07200000
072100         ADD 1 TO PV-AP046-RECORDS-WRITTEN                        07210000
072200         IF  INVALID-DEPT-CLASS                                   07220000
072200          OR INVALID-DEPT                                         07221020
072300             PERFORM U350-UPDATE-CLASS-ON-DISTRIB                 07230000
072400         END-IF                                                   07240000
072200         IF  INVALID-DEPT                                         07242020
072200         AND TADJRNL-UPD-READY                                    07242128
072300             PERFORM U355-UPDATE-DEPT-ON-DISTRIB                  07243023
072400         END-IF                                                   07244020
072500     ELSE                                                         07250000
072600         PERFORM C300-BUILD-AP041-RECORD                          07260000
072700     END-IF.                                                      07270000
072800                                                                  07280000
072900                                                                  07290000
073000 C200-BUILD-AP047-EXTRACT.                                        07300000
073100*                                                                 07310000
073200************************************************************      07320000
073300*     UPDATES THE INFORMATION FED TO THE GENERAL LEDGER           07330000
073400************************************************************      07340000
073500*                                                                 07350000
073600     MOVE 'C200-BUILD-AP047-EXTRACT'    TO PV-ABEND-PARAGRAPH.    07360000
073700                                                                  07370000
073800     MOVE ZEROES  TO  AP047-GRO-COST-AMT.                         07380000
073900     MOVE ZEROES  TO  AP047-FRGT-AMT.                             07390000
074000     MOVE ZEROES  TO  AP047-MISC-CHRG-AMT.                        07400000
074100     MOVE ZEROES  TO  AP047-NET-COST-AMT.                         07410000
074200     MOVE ZEROES  TO  AP047-DISC-AMT.                             07420000
074300                                                                  07430000
074310     MOVE ADJRNL-AP-TRN-CDE TO PV-OFFSET-ACCT-CDE.                07431001
074320                                                                  07432001
074330     IF TRNCDE-BTCH-SRC-CDE = 'MDS'                               07433001
074340     AND PV-CLEARING-ACCT-CDE                                     07434001
074350        SET OFFSET-AP-CLEARING TO TRUE                            07435002
074360     ELSE                                                         07436001
074400        IF TRNCDE-TRN-TYP-CDE = 'EXP'                             07440001
074600           SET OFFSET-AP-TRADE         TO TRUE                    07460001
074700        ELSE                                                      07470001
074800           IF TRNCDE-TRN-TYP-CDE = 'MDS'                          07480001
075000              IF TRNCDE-AP-PSTG-IND = 'Y'                         07500001
075100                 SET OFFSET-AP-CLEARING TO TRUE                   07510001
075200              ELSE                                                07520001
075300                 SET OFFSET-AP-TRADE    TO TRUE                   07530001
075400              END-IF                                              07540001
075500           END-IF                                                 07550001
075600        END-IF                                                    07560001
075610     END-IF.                                                      07561001
075611                                                                  07561101
075620     IF TRNCDE-TRN-TYP-CDE = 'EXP'                                07562001
075630        MOVE ADJRNL-GL-ACCT-NBR     TO AP047-GL-ACCT-NBR          07563001
075650     ELSE                                                         07565001
075660        IF TRNCDE-TRN-TYP-CDE = 'MDS'                             07566001
075670           MOVE '50000'             TO AP047-GL-ACCT-NBR          07567001
075680        END-IF                                                    07568001
075690     END-IF.                                                      07569001
075700                                                                  07570000
075800     MOVE ADJDIS-STR-NBR            TO AP047-STR-NBR.             07580000
075900     MOVE ADJRNL-VND-NBR            TO AP047-VND-NBR.             07590000
076000     MOVE ADJRNL-DOC-NBR            TO AP047-DOC-NBR.             07600000
076100     MOVE ADJRNL-DOC-DTE            TO AP047-DOC-DTE.             07610000
076200     MOVE ADJRNL-AP-TRN-CDE         TO AP047-AP-TRN-CDE.          07620000
076300     MOVE TRNCDE-PSTG-TYP-CDE       TO AP047-PSTG-TYP-CDE.        07630000
076400     MOVE TRNCDE-TRN-TYP-CDE        TO AP047-TRN-TYP-CDE.         07640000
076500     MOVE ADJRNL-PSTG-FYR-NBR       TO AP047-PSTG-FYR-NBR.        07650000
076600     MOVE ADJRNL-PSTG-FMN-NBR       TO AP047-PSTG-FMN-NBR.        07660000
076700     MOVE ADJRNL-PSTG-FWK-NBR       TO AP047-PSTG-FWK-NBR.        07670000
076800                                                                  07680000
076900     IF PROCESS-WEEKLY-EXTRACT                                    07690000
077000        MOVE APCNTL-BTCH-PRC-DTE    TO AP047-PSTG-DTE             07700000
077100     ELSE                                                         07710000
077200        MOVE PV-MO-LAST-DAY         TO AP047-PSTG-DTE             07720000
077300     END-IF.                                                      07730000
077400                                                                  07740000
077500     IF ADJRNL-ENT-ID = PV-HOLD-ENT-ID                            07750000
077600        MOVE ENTNME-ENT-NAME-DESC   TO AP047-ENT-NME-DESC         07760000
077700     ELSE                                                         07770000
077800        PERFORM S300-GET-VENDOR-NAME                              07780000
077900        MOVE ENTNME-ENT-NAME-DESC   TO AP047-ENT-NME-DESC         07790000
078000        MOVE ENTNME-ENT-ID          TO PV-HOLD-ENT-ID             07800000
078100     END-IF.                                                      07810000
078200                                                                  07820000
078300     MOVE ADJDIS-GRO-COST-AMT       TO AP047-GRO-COST-AMT.        07830000
078400     MOVE ADJDIS-FRGT-AMT           TO AP047-FRGT-AMT.            07840000
078500     MOVE ADJDIS-MISC-CHRG-AMT      TO AP047-MISC-CHRG-AMT.       07850000
078600     MOVE ADJDIS-NET-COST-AMT       TO AP047-NET-COST-AMT.        07860000
078700     MOVE ADJDIS-DISC-AMT           TO AP047-DISC-AMT.            07870000
078800                                                                  07880000
078900     MOVE AP047-GL-EXTRACT-FILE TO OUTAPH-ADJ-GL-EXTR-ODR.        07890000
079000     PERFORM U100-INSERT-OUTAPH-RECORDS.                          07900000
079100     ADD 1 TO PV-AP047-RECORDS-WRITTEN.                           07910000
079200                                                                  07920000
079300************************************************************      07930000
079400*  UPDATES THE TOUTAPF FILE WITH ERROR RECORDS             *      07940000
079500************************************************************      07950000
079600 C300-BUILD-AP041-RECORD.                                         07960000
079700                                                                  07970000
079800      MOVE ADJRNL-VND-NBR       TO AP041-VENDOR-NBR.              07980000
079900      MOVE ADJRNL-DOC-NBR       TO AP041-DOC-NBR.                 07990000
080000      MOVE ADJRNL-DOC-DTE       TO AP041-DOC-DTE.                 08000000
080100      MOVE ADJRNL-AP-TRN-CDE    TO AP041-AP-TRN-CDE.              08010000
080200      MOVE ENTNME-ENT-NAME-DESC TO AP041-VENDOR-NAME.             08020000
080300      SET AP041-DMA-NBR-NOT-FOUND TO TRUE.                        08030000
080400      SET AP041-OB-NOT-FOUND TO TRUE.                             08040000
080500                                                                  08050000
080600      MOVE AP041-RECORD TO OUTAPF-ADJ-ERR-RPT-ODR.                08060000
080700      PERFORM U600-INSERT-OUTAPF-RECORDS.                         08070000
080800 EJECT                                                            08080000
080900                                                                  08090000
081000 D100-DATE-ROUTINE.                                               08100000
081100*                                                                 08110000
081200************************************************************      08120000
081300*     DETERMINE FISCAL DATES FROM DATE ROUTINE                    08130000
081400************************************************************      08140000
081500*                                                                 08150000
081600     MOVE 'D100-DATE-ROUTINE '   TO PV-ABEND-PARAGRAPH.           08160000
081700                                                                  08170000
081800     SET DPG51-FISCAL-454-CALENDAR   TO TRUE.                     08180000
081900     SET DPG51-DO-NOT-INCR-DECR-DATE TO TRUE.                     08190000
082000     SET DPG52-LK-DTE-FISC-PRD-CC    TO TRUE.                     08200000
082100                                                                  08210000
082200     MOVE APCNTL-PREV-PSTG-FYR-NBR   TO PV-PREV-PSTG-FYR-NBR.     08220000
082300     MOVE APCNTL-PREV-PSTG-FMN-NBR   TO PV-PREV-PSTG-FMN-NBR.     08230000
082400     MOVE PV-PREV-FISCAL             TO DPG52-LK-DATE-INPUT.      08240000
082500     CALL DP500-KOHLS-CALENDAR-ROUTINE                            08250000
082600                              USING  DPG51 DPG52 DPG53            08260000
082700                                     DPG54 DPG55 DPG56.           08270000
082800     IF (DPG54-SEVERE-ERROR OR                                    08280000
082900         DPG54-WARNING-ERROR)                                     08290000
083000        DISPLAY 'LK-DATE         ' DPG52-LK-DATE-INPUT            08300000
083100        DISPLAY 'CALENDAR-TYPE   ' DPG54-CALENDAR-TYPE-IND        08310000
083200        DISPLAY 'DATE-VALID      ' DPG54-DATE-VALID-IND           08320000
083300        DISPLAY 'ERROR-IND       ' DPG54-ERROR-IND                08330000
083400        DISPLAY                    DPG54-ERROR-MESSAGE            08340000
083500                                                                  08350000
083600        MOVE 'B100-PROCESS -'        TO PV-ABEND-PARAGRAPH        08360000
083700        MOVE 'UNSUCCESSFUL DATE CONVERSION CONTROL  DATE  '       08370000
083800            TO PV-ABEND-OPERATION                                 08380000
083900        PERFORM Z998-ABEND                                        08390000
084000     ELSE                                                         08400000
084100        MOVE DPG56-LAST-FP-DB2-ISO-FMT TO PV-MO-LAST-DAY          08410000
084200                                                                  08420000
084300       DISPLAY 'LAST DAY OF MONTH    = ' DPG56-LAST-FP-DB2-ISO-FMT08430000
084400     END-IF.                                                      08440000
084500                                                                  08450000
084600                                                                  08460000
084700 EJECT                                                            08470000
084800*----------------------------------------------------------------*08480000
084900*    DO THE CHECKPOINT RESTART AND THE COMMIT.                   *08490000
085000*----------------------------------------------------------------*08500000
085100 H100-CHECKPOINT-COMMIT.                                          08510000
085200                                                                  08520000
085300     MOVE 'H100-CHECKPOINT-COMMIT' TO PV-ABEND-PARAGRAPH.         08530000
085400                                                                  08540000
085500     EXEC SQL                                                     08550000
085600       SET :CR-CURR-TMST = CURRENT TIMESTAMP                      08560000
085700     END-EXEC.                                                    08570000
085800                                                                  08580000
085900     EVALUATE TRUE                                                08590000
086000         WHEN SQLCODE = ZERO                                      08600000
086100              CONTINUE                                            08610000
086200                                                                  08620000
086300        WHEN SQLWARN0 NOT = SPACES                                08630000
086400        WHEN SQLCODE  NOT = ZERO                                  08640000
086500            MOVE 'UNSUCCESSFUL SET TMST'                          08650000
086600                                TO PV-ABEND-OPERATION             08660000
086700            PERFORM Z999-DB2-ABEND                                08670000
086800     END-EVALUATE.                                                08680000
086900                                                                  08690000
087000     IF CR-CURR-TMST > CR-NEXT-TMST                               08700000
087100        MOVE PC-IN-PROCESS-CODE      TO PV-CKPT-STAT-CODE         08710000
087200        PERFORM U400-UPDATE-TCKRSTCNTL                            08720000
087300        PERFORM U500-UPDATE-TCKRSTINF                             08730000
087400        PERFORM Z100-COMMIT                                       08740000
087500                                                                  08750000
087600        EXEC SQL                                                  08760000
087700         SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)     08770000
087800          INTO :CR-NEXT-TMST                                      08780000
087900          FROM TCKRSTCNTL                                         08790000
088000          WHERE PLAN_NAME = :PC-PROGRAM-NAME                      08800000
088100        END-EXEC                                                  08810000
088200                                                                  08820000
088300          EVALUATE TRUE                                           08830000
088400              WHEN SQLCODE = ZERO                                 08840000
088500                   CONTINUE                                       08850000
088600                                                                  08860000
088700          WHEN SQLWARN0 NOT = SPACES                              08870000
088800          WHEN SQLCODE  NOT = ZERO                                08880000
088900              MOVE 'UNSUCCESSFUL NEXT TMST'                       08890000
089000                                  TO PV-ABEND-OPERATION           08900000
089100              PERFORM Z999-DB2-ABEND                              08910000
089200       END-EVALUATE                                               08920000
089300     END-IF.                                                      08930000
089400                                                                  08940000
089500                                                                  08950000
089600*----------------------------------------------------------------*08960000
089700*    GET THE RESTART INFO.                                       *08970000
089800*----------------------------------------------------------------*08980000
089900 H200-CHECKPOINT-RESTART.                                         08990000
090000                                                                  09000000
090100     MOVE 'H200-CHECKPOINT-RESTART' TO PV-ABEND-PARAGRAPH.        09010000
090200                                                                  09020000
090300     PERFORM R300-GET-CHECKPOINT-INFO.                            09030000
090400     MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO CR-CKPT-RESTART-INFO.  09040000
090500                                                                  09050000
090600     DISPLAY '***********************************************'.   09060000
090700     DISPLAY '******** APKUP161 CHECKPOINT RESTART **********'    09070000
090800     DISPLAY '** VENDOR NUMBER ON RESTART      = ' CR-VND-NBR.    09080000
090900     DISPLAY '** DOC NUMBER ON RESTART         = ' CR-DOC-NBR.    09090000
091000     DISPLAY '** DOC DATE ON RESTART           = ' CR-DOC-DTE.    09100000
091100     DISPLAY '** AP TRAN CODE ON RESTART       = ' CR-AP-TRN-CDE. 09110000
091200     DISPLAY '** AP046 RECORDS WRITTEN ON RESTART = '             09120000
091300                                       CR-AP046-RECORDS-WRITTEN   09130000
091400     DISPLAY '** AP047 RECORDS WRITTEN ON RESTART = '             09140000
091500                                       CR-AP047-RECORDS-WRITTEN   09150000
091600     DISPLAY '** RECORDS FETCHED ON RESTART = '                   09160000
091700                                       CR-ADJSTMNT-CNT            09170000
091800     DISPLAY '***********************************************'.   09180000
091900                                                                  09190000
092000     PERFORM R100-FETCH-ADJSTMNT-CSR                              09200000
092100        WITH TEST AFTER                                           09210000
092200             UNTIL END-OF-ADJSTMNT-CSR                            09220000
092300               OR (ADJRNL-VND-NBR    = CR-VND-NBR                 09230000
092400              AND  ADJRNL-DOC-NBR    = CR-DOC-NBR                 09240000
092500              AND  ADJRNL-DOC-DTE    = CR-DOC-DTE                 09250000
092600              AND  ADJRNL-AP-TRN-CDE = CR-AP-TRN-CDE).            09260000
092700                                                                  09270000
092800     MOVE ZEROS      TO PV-ADJSTMNT-CNT.                          09280000
092900     MOVE ZEROS      TO PV-AP046-RECORDS-WRITTEN.                 09290000
093000     MOVE ZEROS      TO PV-AP047-RECORDS-WRITTEN.                 09300000
093100                                                                  09310000
093200     MOVE CR-INVALID-DMA-SW        TO PS-INVALID-DMA-NBR-SW.      09320000
093300     MOVE CR-ADJSTMNT-CNT          TO PV-ADJSTMNT-CNT.            09330000
093400     MOVE CR-AP046-RECORDS-WRITTEN TO PV-AP046-RECORDS-WRITTEN.   09340000
093500     MOVE CR-AP047-RECORDS-WRITTEN TO PV-AP047-RECORDS-WRITTEN.   09350000
093600                                                                  09360000
093700                                                                  09370000
093800 R100-FETCH-ADJSTMNT-CSR.                                         09380000
093900*                                                                 09390000
094000***************************************************************** 09400000
094100*     FETCH THE ADJSTMNT CURSOR                                   09410000
094200***************************************************************** 09420000
094300*                                                                 09430000
094400     MOVE 'R100-ADJSTMNT-CSR ' TO PV-ABEND-PARAGRAPH.             09440000
094500                                                                  09450000
094600     EXEC SQL                                                     09460000
094700         FETCH ADJSTMNT_CSR                                       09470000
094800         INTO                                                     09480000
094900            :ADJRNL-VND-NBR                                       09490000
095000           ,:ADJRNL-DOC-NBR                                       09500000
095100           ,:ADJRNL-DOC-DTE                                       09510000
095200           ,:ADJRNL-AP-TRN-CDE                                    09520000
095300           ,:ADJRNL-PO-NBR                                        09530000
095400           ,:ADJRNL-DEPT-NBR                                      09540000
095500           ,:ADJRNL-STR-NBR                                       09550000
095600           ,:ADJRNL-GL-ACCT-NBR                                   09560000
095700           ,:ADJRNL-ENTR-TMST                                     09570000
095800           ,:ADJRNL-PSTG-FYR-NBR                                  09580000
095900           ,:ADJRNL-PSTG-FMN-NBR                                  09590000
096000           ,:ADJRNL-PSTG-FWK-NBR                                  09600000
096100           ,:ADJRNL-INV-CTOFF-DTE                                 09610000
096200           ,:ADJRNL-ENT-ID                                        09620000
096300           ,:TRNCDE-PSTG-TYP-CDE                                  09630000
096400           ,:TRNCDE-TRN-TYP-CDE                                   09640000
096500           ,:TRNCDE-TRN-SHRT-DESC                                 09650000
096600           ,:TRNCDE-GL-PSTG-IND                                   09660000
096700           ,:TRNCDE-ML-PSTG-IND                                   09670000
096800           ,:TRNCDE-AP-PSTG-IND                                   09680000
096810           ,:TRNCDE-BTCH-SRC-CDE                                  09681001
096900           ,:ADJDIS-STR-NBR                                       09690000
097000           ,:ADJDIS-CL-NBR                                        09700000
097100           ,:ADJDIS-SKU-NBR                                       09710000
097200           ,:ADJDIS-GRO-COST-AMT                                  09720000
097300           ,:ADJDIS-RTL-AMT                                       09730000
097400           ,:ADJDIS-FRGT-AMT                                      09740000
097500           ,:ADJDIS-MISC-CHRG-AMT                                 09750000
097600           ,:ADJDIS-DISC-AMT                                      09760000
097700           ,:ADJDIS-NET-COST-AMT                                  09770000
097800           ,:ADJDIS-DISTRB-SEQ-NBR                                09780000
097900     END-EXEC.                                                    09790000
098000                                                                  09800000
098100     EVALUATE TRUE                                                09810000
098200         WHEN SQLCODE = ZERO                                      09820000
098300              ADD 1 TO PV-ADJSTMNT-CNT                            09830000
098400                                                                  09840000
098500         WHEN SQLCODE = +100                                      09850000
098600              SET END-OF-ADJSTMNT-CSR TO TRUE                     09860000
098700                                                                  09870000
098800         WHEN SQLWARN0 NOT = SPACES                               09880000
098900         WHEN SQLCODE  NOT = ZERO                                 09890000
099000             MOVE 'UNSUCCESSFUL FETCH FOR EXTRACT '               09900000
099100                                 TO PV-ABEND-OPERATION            09910000
099200             MOVE 'TADJRNL'      TO PV-ABEND-STRUCTURE-1          09920000
099300             MOVE 'TAJPSINT'     TO PV-ABEND-STRUCTURE-2          09930000
099400             MOVE 'TTRNCDE'      TO PV-ABEND-STRUCTURE-3          09940000
099500             MOVE SPACES         TO PV-ABEND-STRUCTURE-4          09950000
099600             PERFORM Z999-DB2-ABEND                               09960000
099700     END-EVALUATE.                                                09970000
099800                                                                  09980000
099900                                                                  09990000
100000 EJECT                                                            10000000
100100*----------------------------------------------------------------*10010000
100200*    SELECT CHECKPOINT RESTART CONTROL INFO.                     *10020000
100300*----------------------------------------------------------------*10030000
100400 R200-GET-CHECKPOINT-CNTL.                                        10040000
100500                                                                  10050000
100600     MOVE 'R200-GET-CHECKPOINT-CNTL' TO PV-ABEND-PARAGRAPH.       10060000
100700                                                                  10070000
100800     PERFORM WITH TEST AFTER                                      10080000
100900             VARYING PC-RETRY-COUNT FROM 1 BY 1                   10090000
101000             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             10100000
101100                     SQLCODE = ZERO                               10110000
101200                                                                  10120000
101300             EXEC SQL                                             10130000
101400              SELECT CKPT_STAT_CODE                               10140000
101500               INTO :PV-CKPT-STAT-CODE                            10150000
101600               FROM TCKRSTCNTL                                    10160000
101700               WHERE PLAN_NAME = :PC-PROGRAM-NAME                 10170000
101800             END-EXEC                                             10180000
101900                                                                  10190000
102000             EVALUATE TRUE                                        10200000
102100                 WHEN SQLCODE = ZERO                              10210000
102200                 WHEN SQLCODE = -904                              10220000
102300                 WHEN SQLCODE = -913                              10230000
102400                      CONTINUE                                    10240000
102500                                                                  10250000
102600                 WHEN SQLWARN0 NOT = SPACES                       10260000
102700                 WHEN SQLCODE  NOT = ZERO                         10270000
102800                     MOVE PV-ABEND-PARAGRAPH                      10280000
102900                                         TO AA-PARAGRAPH-NAME     10290000
103000                     DISPLAY '******** PLAN_NAME:'                10300000
103100                              PC-PROGRAM-NAME                     10310000
103200                     MOVE 'UNSUCCESSFUL SELECT'                   10320000
103300                                         TO PV-ABEND-OPERATION    10330000
103400                     MOVE 'TCKRSTCNTL'   TO PV-ABEND-STRUCTURE-1  10340000
103500                     MOVE SPACES         TO PV-ABEND-STRUCTURE-2  10350000
103600                                            PV-ABEND-STRUCTURE-3  10360000
103700                     PERFORM Z999-DB2-ABEND                       10370000
103800             END-EVALUATE                                         10380000
103900     END-PERFORM.                                                 10390000
104000                                                                  10400000
104100     IF PC-RETRY-COUNT > PC-RETRY-MAX                             10410000
104200         MOVE PV-ABEND-PARAGRAPH                                  10420000
104300                             TO AA-PARAGRAPH-NAME                 10430000
104400         DISPLAY '******** PLAN_NAME:'                            10440000
104500                  PC-PROGRAM-NAME                                 10450000
104600         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    10460000
104700                             TO PV-ABEND-OPERATION                10470000
104800         MOVE 'TCKRSTCNTL'   TO PV-ABEND-STRUCTURE-1              10480000
104900         PERFORM Z999-DB2-ABEND                                   10490000
105000     END-IF.                                                      10500000
105100                                                                  10510000
105200                                                                  10520000
105300 EJECT                                                            10530000
105400*----------------------------------------------------------------*10540000
105500*    SELECT CHECKPOINT RESTART WORKING STORAGE DESCRIPTION INFO.  10550000
105600*----------------------------------------------------------------*10560000
105700 R300-GET-CHECKPOINT-INFO.                                        10570000
105800                                                                  10580000
105900     MOVE 'R300-GET-CHECKPOINT-INFO' TO PV-ABEND-PARAGRAPH.       10590000
106000                                                                  10600000
106100     PERFORM WITH TEST AFTER                                      10610000
106200             VARYING PC-RETRY-COUNT FROM 1 BY 1                   10620000
106300             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             10630000
106400                     SQLCODE = ZERO                               10640000
106500                                                                  10650000
106600             EXEC SQL                                             10660000
106700              SELECT WORK_STRG_DESC                               10670000
106800               INTO :TCKRSTINF-WORK-STRG-DESC                     10680000
106900               FROM TCKRSTINF                                     10690000
107000               WHERE PLAN_NAME = :PC-PROGRAM-NAME                 10700000
107100             END-EXEC                                             10710000
107200                                                                  10720000
107300             EVALUATE TRUE                                        10730000
107400                 WHEN SQLCODE = ZERO                              10740000
107500                 WHEN SQLCODE = -904                              10750000
107600                 WHEN SQLCODE = -913                              10760000
107700                      CONTINUE                                    10770000
107800                                                                  10780000
107900                 WHEN SQLWARN0 NOT = SPACES                       10790000
108000                 WHEN SQLCODE  NOT = ZERO                         10800000
108100                     MOVE PV-ABEND-PARAGRAPH                      10810000
108200                                         TO AA-PARAGRAPH-NAME     10820000
108300                     DISPLAY '******** PLAN_NAME:'                10830000
108400                              PC-PROGRAM-NAME                     10840000
108500                     MOVE 'UNSUCCESSFUL SELECT'                   10850000
108600                                         TO PV-ABEND-STRUCTURE-1  10860000
108700                     MOVE 'TCKRSTINF'    TO PV-ABEND-STRUCTURE-2  10870000
108800                     MOVE SPACES         TO PV-ABEND-STRUCTURE-3  10880000
108900                                            PV-ABEND-STRUCTURE-1  10890000
109000                     PERFORM Z999-DB2-ABEND                       10900000
109100             END-EVALUATE                                         10910000
109200     END-PERFORM.                                                 10920000
109300                                                                  10930000
109400     IF PC-RETRY-COUNT > PC-RETRY-MAX                             10940000
109500         MOVE PV-ABEND-PARAGRAPH                                  10950000
109600                             TO AA-PARAGRAPH-NAME                 10960000
109700         DISPLAY '******** PLAN_NAME:'                            10970000
109800                  PC-PROGRAM-NAME                                 10980000
109900         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    10990000
110000                             TO PV-ABEND-OPERATION                11000000
110100         MOVE 'TCKRSTINF'    TO PV-ABEND-STRUCTURE-1              11010000
110200         MOVE SPACES         TO PV-ABEND-STRUCTURE-2              11020000
110300                                PV-ABEND-STRUCTURE-3              11030000
110400         PERFORM Z999-DB2-ABEND                                   11040000
110500     END-IF.                                                      11050000
110600                                                                  11060000
110700                                                                  11070000
110800 S100-APCNTL-CURR-PROC-DTE.                                       11080000
110900*-----------------------------------------------------------      11090000
111000*  RETRIEVES CURRENT DATES FOR WEEKLY PROCESSING.                 11100000
111100*-----------------------------------------------------------      11110000
111200     MOVE 'S100-APCNTL-CURR-PROC-DTE' TO PV-ABEND-PARAGRAPH.      11120000
111300                                                                  11130000
111400     EXEC SQL                                                     11140000
111500         SELECT                                                   11150000
111600              BTCH_PRC_DTE                                        11160000
111700            , CURR_PSTG_FYR_NBR                                   11170000
111800            , CURR_PSTG_FMN_NBR                                   11180000
111900            , CURR_PSTG_FWK_NBR                                   11190000
111910            , CURR_WK_END_DTE                                     11191005
112000         INTO                                                     11200000
112100             :APCNTL-BTCH-PRC-DTE                                 11210000
112200            ,:APCNTL-CURR-PSTG-FYR-NBR                            11220000
112300            ,:APCNTL-CURR-PSTG-FMN-NBR                            11230000
112400            ,:APCNTL-CURR-PSTG-FWK-NBR                            11240000
112410            ,:APCNTL-CURR-WK-END-DTE                              11241005
112500         FROM TAPCNTL                                             11250000
112600     END-EXEC.                                                    11260000
112700                                                                  11270000
112800     EVALUATE TRUE                                                11280000
112900         WHEN SQLCODE = ZERO                                      11290000
113000              CONTINUE                                            11300000
113100                                                                  11310000
113200         WHEN SQLWARN0 = SPACES                                   11320000
113300         WHEN SQLCODE NOT = ZERO                                  11330000
113400           MOVE 'B100-INITIALIZATION' TO PV-ABEND-PARAGRAPH       11340000
113500           MOVE 'UNSUCCESSFUL SELECT' TO PV-ABEND-OPERATION       11350000
113600           MOVE 'TAPCNTL'             TO PV-ABEND-STRUCTURE-1     11360000
113700           MOVE SPACES                TO PV-ABEND-STRUCTURE-2     11370000
113800           PERFORM Z999-DB2-ABEND                                 11380000
113900     END-EVALUATE.                                                11390000
114000                                                                  11400000
114100                                                                  11410000
114200 S200-APCNTL-PREV-PROC-DTE.                                       11420000
114300*-----------------------------------------------------------      11430000
114400*  RETRIEVES PREVIOUS DATES FOR MONTHLY PROCESSING.               11440000
114500*-----------------------------------------------------------      11450000
114600     MOVE 'S200-APCNTL-PREV-PROC-DTE' TO PV-ABEND-PARAGRAPH       11460000
114700                                                                  11470000
114800     EXEC SQL                                                     11480000
114900         SELECT                                                   11490000
115000              BTCH_PRC_DTE                                        11500000
115100            , PREV_PSTG_FYR_NBR                                   11510000
115200            , PREV_PSTG_FMN_NBR                                   11520000
115300            , PREV_PSTG_FWK_NBR                                   11530000
115400            , PREV_WK_END_DTE                                     11540000
115500            , CURR_WK_END_DTE                                     11550000
115600         INTO                                                     11560000
115700             :APCNTL-BTCH-PRC-DTE                                 11570000
115800            ,:APCNTL-PREV-PSTG-FYR-NBR                            11580000
115900            ,:APCNTL-PREV-PSTG-FMN-NBR                            11590000
116000            ,:APCNTL-PREV-PSTG-FWK-NBR                            11600000
116100            ,:APCNTL-PREV-WK-END-DTE                              11610000
116200            ,:APCNTL-CURR-WK-END-DTE                              11620000
116300         FROM TAPCNTL                                             11630000
116400     END-EXEC.                                                    11640000
116500                                                                  11650000
116600     EVALUATE TRUE                                                11660000
116700         WHEN SQLCODE = ZERO                                      11670000
116800              CONTINUE                                            11680000
116900                                                                  11690000
117000         WHEN SQLWARN0 = SPACES                                   11700000
117100         WHEN SQLCODE NOT = ZERO                                  11710000
117200           MOVE 'B100-INITIALIZATION' TO PV-ABEND-PARAGRAPH       11720000
117300           MOVE 'UNSUCCESSFUL SELECT' TO PV-ABEND-OPERATION       11730000
117400           MOVE 'TAPCNTL'             TO PV-ABEND-STRUCTURE-1     11740000
117500           MOVE SPACES                TO PV-ABEND-STRUCTURE-2     11750000
117600           PERFORM Z999-DB2-ABEND                                 11760000
117700     END-EVALUATE.                                                11770000
117800                                                                  11780000
117900                                                                  11790000
118000 S300-GET-VENDOR-NAME.                                            11800000
118100*-----------------------------------------------------------      11810000
118200*  RETRIEVES VENDOR NAME FOR PO BEING PROCESSED.                  11820000
118300*-----------------------------------------------------------      11830000
118400     MOVE 'S300-GET-VENDOR-NAME' TO PV-ABEND-PARAGRAPH.           11840000
118500                                                                  11850000
118600     EXEC SQL                                                     11860000
118700         SELECT  NM.ENT_NAME_DESC                                 11870000
118800         INTO    :ENTNME-ENT-NAME-DESC                            11880000
118900         FROM    TENTNME NM                                       11890000
119000         WHERE   ENT_ID       = :ADJRNL-ENT-ID                    11900000
119100           AND   TYPE_CDE     = '01'                              11910000
119200     END-EXEC.                                                    11920000
119300                                                                  11930000
119400     EVALUATE TRUE                                                11940000
119500         WHEN SQLCODE = ZERO                                      11950000
119600             CONTINUE                                             11960000
119700                                                                  11970000
119800         WHEN SQLCODE = +100                                      11980000
119900             MOVE 'NO VENDOR PRIMARY NAME FOUND  '                11990000
120000                                 TO ENTNME-ENT-NAME-DESC          12000000
120100                                                                  12010000
120200         WHEN SQLWARN0 NOT = SPACES                               12020000
120300         WHEN SQLCODE  NOT = ZERO                                 12030000
120400             MOVE 'UNSUCCESSFUL SELECT'                           12040000
120500                                 TO PV-ABEND-OPERATION            12050000
120600             MOVE 'TENTNME'               TO PV-ABEND-STRUCTURE-1 12060000
120700             MOVE SPACES                  TO PV-ABEND-STRUCTURE-2 12070000
120800             MOVE SPACES                  TO PV-ABEND-STRUCTURE-3 12080000
120900             MOVE SPACES                  TO PV-ABEND-STRUCTURE-4 12090000
121000             PERFORM Z999-DB2-ABEND                               12100000
121100     END-EVALUATE.                                                12110000
121200                                                                  12120000
121300                                                                  12130000
121400 S400-SELECT-DIVISION-NBR.                                        12140000
121500*-----------------------------------------------------------      12150000
121600*  RETRIEVES DIVISION NUMBER FOR DEPARTMENT PROCESSED.            12160000
121700*-----------------------------------------------------------      12170000
121800     MOVE 'S400-SELECT-DIVISION-NBR ' TO PV-ABEND-PARAGRAPH.      12180000
121900                                                                  12190000
122000     EXEC SQL                                                     12200000
122100         SELECT  DMA_NBR                                          12210000
122200         INTO    :MDSEAR-DMA-NBR                                  12220000
122300         FROM    TMDSEAR                                          12230000
122400         WHERE   OPERCO_NBR  = '03'                               12240000
122500           AND   DEPT_NBR    = :PV-HOLD-DEPT-NBR                  12250000
122600           AND   MDSELV_CDE  = 'DPT'                              12260000
122700           AND   :APCNTL-BTCH-PRC-DTE BETWEEN STRT_DTE            12270000
122800                 AND END_DTE                                      12280000
122900     END-EXEC.                                                    12290000
123000                                                                  12300000
123100     EVALUATE TRUE                                                12310000
123200         WHEN SQLCODE = ZERO                                      12320000
123300             SET VALID-DMA-NBR TO TRUE                            12330000
123400                                                                  12340000
123500         WHEN SQLCODE = +100                                      12350000
123600             SET INVALID-DMA-NBR TO TRUE                          12360000
123700*            MOVE 'NO DIVISION NUMBER FOUND      '                12370000
123800*                                TO MDSEAR-DMA-NBR                12380000
123900                                                                  12390000
124000         WHEN SQLWARN0 NOT = SPACES                               12400000
124100         WHEN SQLCODE  NOT = ZERO                                 12410000
124200             MOVE 'UNSUCCESSFUL SELECT'                           12420000
124300                                 TO PV-ABEND-OPERATION            12430000
124400             MOVE 'TMDSEAR'               TO PV-ABEND-STRUCTURE-1 12440000
124500             MOVE SPACES                  TO PV-ABEND-STRUCTURE-2 12450000
124600             MOVE SPACES                  TO PV-ABEND-STRUCTURE-3 12460000
124700             MOVE SPACES                  TO PV-ABEND-STRUCTURE-4 12470000
124800             PERFORM Z999-DB2-ABEND                               12480000
124900     END-EVALUATE.                                                12490000
125000                                                                  12500000
125100                                                                  12510000
125200 EJECT                                                            12520000
125300*-----------------------------------------------------------      12530000
125400*  RETRIEVES DIVISION NUMBER FOR DEPARTMENT PROCESSED.            12540000
125500*-----------------------------------------------------------      12550000
125600 S500-VALIDATE-DEPT-CLASS.                                        12560000
125700                                                                  12570000
125800     MOVE 'S500-VALIDATE-DEPT-CLASS ' TO PV-ABEND-PARAGRAPH.      12580000
125900                                                                  12590000
126000     EXEC SQL                                                     12600000
126100          SELECT '1'                                              12610000
126200            INTO :PV-ONE                                          12620000
126300            FROM SYSIBM.SYSDUMMY1 X                               12630000
126400           WHERE EXISTS                                           12640000
126500                (SELECT 1                                         12650000
126600                   FROM TMDSEAR                                   12660000
126700                  WHERE DEPT_NBR   = :PV-HOLD-DEPT-NBR            12670000
126800                    AND SUB_CL_NBR = :MDSEAR-SUB-CL-NBR           12680000
126900                    AND MDSELV_CDE = 'SCL'                        12690000
127000                    AND OPERCO_NBR = '03'                         12700000
127100                    AND :APCNTL-BTCH-PRC-DTE BETWEEN STRT_DTE     12710000
127200                          AND END_DTE                             12720000
127300                    AND X.IBMREQD = X.IBMREQD)                    12730000
127400     END-EXEC.                                                    12740000
127500                                                                  12750000
127600     EVALUATE TRUE                                                12760000
127700         WHEN SQLCODE = ZERO                                      12770000
127800             SET VALID-DEPT-CLASS TO TRUE                         12780000
127800             SET VALID-DEPT       TO TRUE                         12781025
127900             MOVE ADJDIS-CL-NBR  TO PV-MAJ-CL-HOLDER              12790000
128000             MOVE PV-HOLD-MCL-NBR TO PV-USE-MAJ-CL-NBR            12800000
128100             MOVE ADJDIS-CL-NBR  TO PV-USE-SUB-CL-NBR             12810000
128200                                                                  12820000
128300         WHEN SQLCODE = +100                                      12830000
128400             SET INVALID-DEPT-CLASS TO TRUE                       12840000
128500             DISPLAY 'INVALID DEPT/CLASS FOUND-SUBSTITUTING VALID'12850000
128600                     ' CLASS FOR DEPT = ' PV-HOLD-DEPT-NBR        12860000
128700                     ' SUBCLASS = ' ADJDIS-CL-NBR                 12870000
128800                     ' PO = ' ADJRNL-PO-NBR                       12880000
128900         WHEN SQLWARN0 NOT = SPACES                               12890000
129000         WHEN SQLCODE  NOT = ZERO                                 12900000
129100             DISPLAY 'DEPT = ' PV-HOLD-DEPT-NBR                   12910000
129200             DISPLAY 'SUBCLASS = ' MDSEAR-SUB-CL-NBR              12920000
129300             MOVE 'UNSUCCESSFUL SELECT'                           12930000
129400                                 TO PV-ABEND-OPERATION            12940000
129500             MOVE 'TMDSEAR'               TO PV-ABEND-STRUCTURE-1 12950000
129600             MOVE SPACES                  TO PV-ABEND-STRUCTURE-2 12960000
129700             MOVE SPACES                  TO PV-ABEND-STRUCTURE-3 12970000
129800             MOVE SPACES                  TO PV-ABEND-STRUCTURE-4 12980000
129900             PERFORM Z999-DB2-ABEND                               12990000
130000     END-EVALUATE.                                                13000000
130100                                                                  13010000
130200     IF  INVALID-DEPT-CLASS                                       13020000
130300*PRB52368 START                                                   13030000
130400         EXEC SQL                                                 13040000
130500            SELECT A.NW_MAJ_CL_NBR                                13050000
130600                 , A.NW_SUB_CL_NBR                                13060000
130600                 , A.NW_DEPT_NBR                                  13061009
130700              INTO :IMT00015-NW-MAJ-CL-NBR                        13070000
130800                 , :IMT00015-NW-SUB-CL-NBR                        13080000
130800                 , :IMT00015-NW-DEPT-NBR                          13081009
130900              FROM IMT_RECLS A                                    13090000
131000             WHERE A.SKU_NBR = :ADJDIS-SKU-NBR                    13100000
131100               AND A.RECLS_TMST =                                 13110000
131200                    (SELECT MAX(B.RECLS_TMST)                     13120000
131300                       FROM IMT_RECLS B                           13130000
131400                      WHERE A.SKU_NBR = B.SKU_NBR)                13140000
131500         END-EXEC                                                 13150000
131600                                                                  13160000
131700         EVALUATE TRUE                                            13170000
131800             WHEN SQLCODE = ZERO                                  13180000
131900                  MOVE IMT00015-NW-MAJ-CL-NBR TO PV-IMT-MAJ-CL-NBR13190000
132000                  MOVE IMT00015-NW-SUB-CL-NBR TO PV-IMT-SUB-CL-NBR13200000
132000                  MOVE IMT00015-NW-DEPT-NBR   TO PV-IMT-DEPT-NBR  13201009
132100                  MOVE PV-IMT-MAJ-CL-NBR      TO PV-USE-MAJ-CL-NBR13210000
132200                  MOVE PV-IMT-SUB-CL-NBR      TO PV-USE-SUB-CL-NBR13220000
132200                  MOVE PV-IMT-DEPT-NBR        TO PV-USE-DEPT-NBR  13221009
132300             WHEN SQLCODE = +100                                  13230000
132400                  DISPLAY 'WARNING!! NO RECLASS FOUND FOR '       13240000
132500                         'DEPT = ' PV-HOLD-DEPT-NBR               13250000
132600                        ' SKU  = ' ADJDIS-SKU-NBR                 13260010
132600*                        'SKU  = ' ADJDIS-SKU-NBR                 13261010
132700                 PERFORM T100-GET-MIN-CLASS                       13270000
132800             WHEN SQLWARN0 NOT = SPACES                           13280000
132900             WHEN SQLCODE  NOT = ZERO                             13290000
133000                 DISPLAY 'DEPT = ' PV-HOLD-DEPT-NBR               13300000
133100                 DISPLAY 'SKU  = ' ADJDIS-SKU-NBR                 13311010
133200                 MOVE 'UNSUCCESSFUL SELECT'                       13320000
133300                                     TO PV-ABEND-OPERATION        13330000
133400                 MOVE 'IMT_RECLS'    TO PV-ABEND-STRUCTURE-1      13340000
133500                 PERFORM Z999-DB2-ABEND                           13350000
133600         END-EVALUATE                                             13360000
133700     END-IF.                                                      13370000
133800*PRB52368 END                                                     13380000
133900 EJECT                                                            13390000
134000*                                                                 13400000
134100*-----------------------------------------------------------      13410000
134200*  RETRIEVES MIN(MAJ_CL_NBR) AND MIN(SUB_CL_NBR) FROM TMDSEAR     13420000
134300*-----------------------------------------------------------      13430000
134400*PRB52368 START                                                   13440000
134500 T100-GET-MIN-CLASS.                                              13450000
134600                                                                  13460000
134700     MOVE ' T100-GET-MIN-CLASS '  TO PV-ABEND-PARAGRAPH.          13470000
134701                                                                  13470100
134702     EXEC SQL                                                     13470200
134703          SELECT MIN(B.MAJ_CL_NBR)                                13470300
134704               , MIN(B.SUB_CL_NBR)                                13470400
134705            INTO :MDSEAR-MAJ-CL-NBR                               13470500
134706               , :MDSEAR-SUB-CL-NBR                               13470600
134707            FROM TMDSEAR B                                        13470700
134708           WHERE B.OPERCO_NBR = '03'                              13470800
134709             AND B.DEPT_NBR = :PV-HOLD-DEPT-NBR                   13470900
134710             AND B.MDSELV_CDE = 'SCL'                             13471000
134711             AND :APCNTL-BTCH-PRC-DTE BETWEEN B.STRT_DTE          13471100
134712                                          AND B.END_DTE           13471200
134713             AND EXISTS                                           13471300
134714                 (SELECT 1                                        13471400
134715                    FROM TAPLAVL A                                13471500
134716                   WHERE A.APLSYS_CDE = 'ML'                      13471600
134717                     AND A.MDSEAR_DKEY = B.MDSEAR_DKEY            13471700
134718                     AND CURRENT DATE BETWEEN A.MDSEAR_STRT_DTE   13471800
134719                                          AND A.MDSEAR_END_DTE    13471900
134720                     AND A.OPERCO_NBR = B.OPERCO_NBR)             13472000
134730     END-EXEC.                                                    13473000
134740                                                                  13474000
134750     EVALUATE TRUE                                                13475000
134760         WHEN SQLCODE = ZERO                                      13476000
134770              MOVE MDSEAR-MAJ-CL-NBR TO PV-USE-MAJ-CL-NBR         13477000
134780              MOVE MDSEAR-SUB-CL-NBR TO PV-HOLD-SUB-CL-NBR        13478000
134790              MOVE PV-HOLD-SUB-CL-NBR TO PV-USE-SUB-CL-NBR        13479000
134800         WHEN SQLCODE = -305                                      13480000
134900              MOVE ZEROES            TO PV-USE-MAJ-CL-NBR         13490000
135000                                        PV-USE-SUB-CL-NBR         13500000
135100              DISPLAY 'WARNING!! NO MAJOR CLASS FOUND FOR '       13510000
135200                     'DEPT = ' PV-HOLD-DEPT-NBR                   13520000
135300         WHEN SQLWARN0 NOT = SPACES                               13530000
135400         WHEN SQLCODE  NOT = ZERO                                 13540000
135500             DISPLAY 'DEPT = ' PV-HOLD-DEPT-NBR                   13550000
135600             DISPLAY 'SUBCLASS = ' MDSEAR-SUB-CL-NBR              13560000
135700             MOVE 'UNSUCCESSFUL SELECT'                           13570000
135800                                 TO PV-ABEND-OPERATION            13580000
135900             MOVE 'TMDSEAR'      TO PV-ABEND-STRUCTURE-1          13590000
136000             MOVE 'TAPLAVL'      TO PV-ABEND-STRUCTURE-2          13600000
136100             PERFORM Z999-DB2-ABEND                               13610000
136200     END-EVALUATE.                                                13620000
136300*PRB52368 END                                                     13630000
136400 EJECT                                                            13640000
136500*---------------------------------------------------------------- 13650000
136600*  INSERT AP TRANSACTION RECORD INTO TOUTAPH                      13660000
136700*---------------------------------------------------------------- 13670000
136800 U100-INSERT-OUTAPH-RECORDS.                                      13680000
136900     MOVE 'U100-INSERT-OUTAPH-RECORDS' TO PV-ABEND-PARAGRAPH.     13690000
137000                                                                  13700000
137100     EXEC SQL                                                     13710000
137200         INSERT INTO TOUTAPH                                      13720000
137300                 (ADJ_GL_EXTR_ODR)                                13730000
137400         VALUES  (:OUTAPH-ADJ-GL-EXTR-ODR)                        13740000
137500     END-EXEC.                                                    13750000
137600                                                                  13760000
137700     EVALUATE TRUE                                                13770000
137800         WHEN SQLCODE = ZERO                                      13780000
137900              ADD 1 TO PV-TOUTAPH-CNTR                            13790000
138000         WHEN SQLWARN0 NOT = SPACES                               13800000
138100         WHEN SQLCODE  NOT = ZERO                                 13810000
138200             MOVE 'UNSUCCESSFUL INSERT'                           13820000
138300                                 TO PV-ABEND-OPERATION            13830000
138400             MOVE 'TOUTAPH'      TO PV-ABEND-STRUCTURE-1          13840000
138500             MOVE SPACES         TO PV-ABEND-STRUCTURE-2          13850000
138600                                    PV-ABEND-STRUCTURE-3          13860000
138700                                    PV-ABEND-STRUCTURE-4          13870000
138800             PERFORM Z999-DB2-ABEND                               13880000
138900     END-EVALUATE.                                                13890000
139000 EJECT                                                            13900000
139100*---------------------------------------------------------------- 13910000
139200*  INSERT AP TRANSACTION RECORD INTO TOUTAPG                      13920000
139300*---------------------------------------------------------------- 13930000
139400 U200-INSERT-OUTAPG-RECORDS.                                      13940000
139500                                                                  13950000
139600     MOVE 'U200-INSERT-OUTAPG-RECORDS' TO PV-ABEND-PARAGRAPH.     13960000
139700                                                                  13970000
139800     EXEC SQL                                                     13980000
139900         INSERT INTO TOUTAPG                                      13990000
140000                 (ADJ_ML_EXTR_ODR)                                14000000
140100         VALUES  (:OUTAPG-ADJ-ML-EXTR-ODR)                        14010000
140200     END-EXEC.                                                    14020000
140300                                                                  14030000
140400     EVALUATE TRUE                                                14040000
140500         WHEN SQLCODE = ZERO                                      14050000
140600              ADD 1 TO PV-TOUTAPG-CNTR                            14060000
140700              CONTINUE                                            14070000
140800         WHEN SQLWARN0 NOT = SPACES                               14080000
140900         WHEN SQLCODE  NOT = ZERO                                 14090000
141000             MOVE 'UNSUCCESSFUL INSERT'                           14100000
141100                                 TO PV-ABEND-OPERATION            14110000
141200             MOVE 'TOUTAPG'      TO PV-ABEND-STRUCTURE-1          14120000
141300             MOVE SPACES         TO PV-ABEND-STRUCTURE-2          14130000
141400                                    PV-ABEND-STRUCTURE-3          14140000
141500                                    PV-ABEND-STRUCTURE-4          14150000
141600             PERFORM Z999-DB2-ABEND                               14160000
141700     END-EVALUATE.                                                14170000
141800                                                                  14180000
141900                                                                  14190000
142000*----------------------------------------------------------------*14200000
142100*    UPDATES THE TADJRNL TABLE WHEN THERE IS A BREAK ON THE      *14210000
142200*    VND_NBR, DOC_NBR, DOC_DTE OR AP_TRN-CDE.                    *14220000
142300*----------------------------------------------------------------*14230000
142400 U300-UPDATE-ADJSTMNT-HDR.                                        14240000
142500                                                                  14250000
142600     MOVE 'U300-UPDATE-ADJSTMNT-HDR   ' TO PV-ABEND-PARAGRAPH.    14260000
142700                                                                  14270000
142800     EXEC SQL                                                     14280000
142900         UPDATE TADJRNL                                           14290000
143000         SET    DOC_EXTR_IND   = 'Y'                              14300000
143100              , DOC_EXTR_DTE   = :APCNTL-BTCH-PRC-DTE             14310000
143200         WHERE  VND_NBR        = :PV-HOLD-VND-NBR                 14320000
143300           AND  DOC_NBR        = :PV-HOLD-DOC-NBR                 14330000
143400           AND  DOC_DTE        = :PV-HOLD-DOC-DTE                 14340000
143500           AND  AP_TRN_CDE     = :PV-HOLD-TRN-CDE                 14350000
143600     END-EXEC.                                                    14360000
143700                                                                  14370000
143800     EVALUATE TRUE                                                14380000
143900         WHEN SQLCODE = ZERO                                      14390000
144000              CONTINUE                                            14400000
144100                                                                  14410000
144200         WHEN SQLWARN0 NOT = SPACES                               14420000
144300         WHEN SQLCODE  NOT = ZERO                                 14430000
144400             MOVE 'UNSUCCESSFUL UPDATE ON TADJRNL '               14440000
144500                                 TO PV-ABEND-OPERATION            14450000
144600             MOVE 'TADJRNL   '   TO PV-ABEND-STRUCTURE-1          14460000
144700             MOVE SPACES         TO PV-ABEND-STRUCTURE-2          14470000
144800                                    PV-ABEND-STRUCTURE-3          14480000
144900                                    PV-ABEND-STRUCTURE-4          14490000
145000             PERFORM Z999-DB2-ABEND                               14500000
145100     END-EVALUATE.                                                14510000
145200                                                                  14520000
145300 EJECT                                                            14530000
145400*----------------------------------------------------------------*14540000
145500*    UPDATES THE TADJDIS TABLE WHEN THERE IS AN INVALID DEPT/    *14550000
145600*    CLASS FOUND TO CHANGE THE DEPT/CLASS TO AGREE WITH THE ONE  *14560020
145700*    USED ON THE EXTRACT FILE.                                   *14570020
145800*----------------------------------------------------------------*14580000
145900 U350-UPDATE-CLASS-ON-DISTRIB.                                    14590000
146000                                                                  14600000
146100     MOVE 'U350-UPDATE-CLASS-ON-DISTRIB' TO PV-ABEND-PARAGRAPH.   14610000
146200                                                                  14620000
146200     IF INVALID-DEPT-CLASS                                        14621020
146200         MOVE PV-USE-SUB-CL-NBR TO PV-NEW-SUB-CL-NBR              14622020
146200     ELSE                                                         14623020
146200         MOVE ADJDIS-CL-NBR     TO PV-NEW-SUB-CL-NBR              14623120
146200     END-IF.                                                      14623220
146200                                                                  14624020
146200     IF INVALID-DEPT                                              14624120
146200         MOVE PV-USE-DEPT-NBR   TO PV-NEW-DEPT-NBR                14624220
146200     ELSE                                                         14624320
146200         MOVE ADJRNL-DEPT-NBR   TO PV-NEW-DEPT-NBR                14624420
146200     END-IF.                                                      14624520
146200                                                                  14625020
146300     EXEC SQL                                                     14630000
146400         UPDATE TADJDIS                                           14640000
146500            SET CL_NBR         = :PV-NEW-SUB-CL-NBR               14650020
146500              , DEPT_NBR       = :PV-NEW-DEPT-NBR                 14650122
146500*           SET CL_NBR         = :PV-USE-SUB-CL-NBR               14651020
146600          WHERE VND_NBR        = :PV-HOLD-VND-NBR                 14660000
146700            AND DOC_NBR        = :PV-HOLD-DOC-NBR                 14670000
146800            AND DOC_DTE        = :PV-HOLD-DOC-DTE                 14680000
146900            AND AP_TRN_CDE     = :PV-HOLD-TRN-CDE                 14690000
147000            AND DISTRB_SEQ_NBR = :ADJDIS-DISTRB-SEQ-NBR           14700000
147100     END-EXEC.                                                    14710000
147200                                                                  14720000
147300     EVALUATE TRUE                                                14730000
147400         WHEN SQLCODE = ZERO                                      14740000
147500              ADD 1              TO PV-TADJDIS-UPD-CNT            14750025
147500              CONTINUE                                            14751025
147600         WHEN SQLWARN0 NOT = SPACES                               14760000
147700         WHEN SQLCODE  NOT = ZERO                                 14770000
147800             MOVE 'UNSUCCESSFUL UPDATE '                          14780000
147900                                 TO PV-ABEND-OPERATION            14790000
148000             MOVE 'TADJDIS   '   TO PV-ABEND-STRUCTURE-1          14800000
148100             PERFORM Z999-DB2-ABEND                               14810000
148200     END-EVALUATE.                                                14820000
148300                                                                  14830000
148400                                                                  14840000
145400*----------------------------------------------------------------*14841020
145500*    UPDATES THE TADJRNL TABLE WHEN THERE IS AN INVALID DEPT     *14842020
145600*    FOUND TO CHANGE THE DEPT TO AGREE WITH THE ONE USED         *14843020
145700*    ON THE EXTRACT FILE.                                        *14844020
145800*----------------------------------------------------------------*14845020
145900 U355-UPDATE-DEPT-ON-DISTRIB.                                     14846020
146000                                                                  14847020
146100     MOVE 'U355-UPDATE-DEPT-ON-DISTRIB' TO PV-ABEND-PARAGRAPH.    14848020
146200                                                                  14849120
146300     EXEC SQL                                                     14850420
146400         UPDATE TADJRNL                                           14850520
146500            SET DEPT_NBR       = :PV-USE-DEPT-NBR                 14850722
146600          WHERE VND_NBR        = :PV-HOLD-VND-NBR                 14850920
146700            AND DOC_NBR        = :PV-HOLD-DOC-NBR                 14851020
146800            AND DOC_DTE        = :PV-HOLD-DOC-DTE                 14851120
146900            AND AP_TRN_CDE     = :PV-HOLD-TRN-CDE                 14851220
147100     END-EXEC.                                                    14851420
147200                                                                  14851520
147300     EVALUATE TRUE                                                14851620
147400         WHEN SQLCODE = ZERO                                      14851720
147500              ADD 1                TO PV-TADJRNL-UPD-CNT          14851828
147500              SET TADJRNL-UPD-DONE TO TRUE                        14851928
147500              CONTINUE                                            14852027
147600         WHEN SQLWARN0 NOT = SPACES                               14852127
147700         WHEN SQLCODE  NOT = ZERO                                 14852227
147800             MOVE 'UNSUCCESSFUL UPDATE '                          14852327
147900                                 TO PV-ABEND-OPERATION            14852427
148000             MOVE 'TADJRNL   '   TO PV-ABEND-STRUCTURE-1          14852527
148100             PERFORM Z999-DB2-ABEND                               14852627
148200     END-EVALUATE.                                                14852727
148300                                                                  14852827
148400                                                                  14852927
148500 EJECT                                                            14853000
148600*----------------------------------------------------------------*14860000
148700*    UPDATES THE CHECKPOINT RESTART CONTROL TABLE.  THE STATUS   *14870000
148800*    CODE IS SET TO '9' (RUN IN PROGRESS) OR '0' (RUN COMPLETE). *14880000
148900*----------------------------------------------------------------*14890000
149000 U400-UPDATE-TCKRSTCNTL.                                          14900000
149100                                                                  14910000
149200     MOVE 'U400-UPDATE-TCKRSTCNTL' TO PV-ABEND-PARAGRAPH.         14920000
149300                                                                  14930000
149400     PERFORM WITH TEST AFTER                                      14940000
149500             VARYING PC-RETRY-COUNT FROM 1 BY 1                   14950000
149600             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             14960000
149700                     SQLCODE = ZERO                               14970000
149800                                                                  14980000
149900             EXEC SQL                                             14990000
150000                 UPDATE TCKRSTCNTL                                15000000
150100                 SET CKPT_STAT_CODE = :PV-CKPT-STAT-CODE          15010000
150200                 WHERE PLAN_NAME      = :PC-PROGRAM-NAME          15020000
150300             END-EXEC                                             15030000
150400                                                                  15040000
150500             EVALUATE TRUE                                        15050000
150600                 WHEN SQLCODE = ZERO                              15060000
150700                 WHEN SQLCODE = -904                              15070000
150800                 WHEN SQLCODE = -913                              15080000
150900                      CONTINUE                                    15090000
151000                                                                  15100000
151100                 WHEN SQLWARN0 NOT = SPACES                       15110000
151200                 WHEN SQLCODE  NOT = ZERO                         15120000
151300                     MOVE PV-ABEND-PARAGRAPH                      15130000
151400                                         TO AA-PARAGRAPH-NAME     15140000
151500                     DISPLAY '******** PLAN_NAME:'                15150000
151600                              PC-PROGRAM-NAME                     15160000
151700                     MOVE 'UNSUCCESSFUL UPDATE'                   15170000
151800                                         TO PV-ABEND-OPERATION    15180000
151900                     MOVE 'TCKRSTCNTL'   TO PV-ABEND-STRUCTURE-1  15190000
152000                     MOVE SPACES         TO PV-ABEND-STRUCTURE-2  15200000
152100                                            PV-ABEND-STRUCTURE-3  15210000
152200                     PERFORM Z999-DB2-ABEND                       15220000
152300             END-EVALUATE                                         15230000
152400     END-PERFORM.                                                 15240000
152500                                                                  15250000
152600     IF PC-RETRY-COUNT > PC-RETRY-MAX                             15260000
152700         MOVE PV-ABEND-PARAGRAPH                                  15270000
152800                             TO AA-PARAGRAPH-NAME                 15280000
152900         DISPLAY '******** PLAN_NAME:'                            15290000
153000                  PC-PROGRAM-NAME                                 15300000
153100         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    15310000
153200                             TO PV-ABEND-OPERATION                15320000
153300         MOVE 'TCKRSTCNTL'   TO PV-ABEND-STRUCTURE-1              15330000
153400         MOVE SPACES         TO PV-ABEND-STRUCTURE-2              15340000
153500                                PV-ABEND-STRUCTURE-3              15350000
153600         PERFORM Z999-DB2-ABEND                                   15360000
153700     END-IF.                                                      15370000
153800                                                                  15380000
153900     EJECT                                                        15390000
154000*----------------------------------------------------------------*15400000
154100*    UPDATES THE CHECKPOINT RESTART INFO TABLE.  THE WORKING     *15410000
154200*    STORAGE DESCRIPTION FIELD IS UPDATED WITH THE CURRENT INPUT *15420000
154300*    FILE RECORD COUNTS AND THE FILE PROCESSOR INDICATOR.        *15430000
154400*----------------------------------------------------------------*15440000
154500 U500-UPDATE-TCKRSTINF.                                           15450000
154600                                                                  15460000
154700     MOVE 'U500-UPDATE-TCKRSTINF' TO PV-ABEND-PARAGRAPH.          15470000
154800                                                                  15480000
154900     MOVE ADJRNL-VND-NBR           TO CR-VND-NBR.                 15490000
155000     MOVE ADJRNL-DOC-NBR           TO CR-DOC-NBR.                 15500000
155100     MOVE ADJRNL-DOC-DTE           TO CR-DOC-DTE.                 15510000
155200     MOVE ADJRNL-AP-TRN-CDE        TO CR-AP-TRN-CDE.              15520000
155300     MOVE PS-INVALID-DMA-NBR-SW    TO CR-INVALID-DMA-SW.          15530000
155400     MOVE PV-AP046-RECORDS-WRITTEN TO CR-AP046-RECORDS-WRITTEN.   15540000
155500     MOVE PV-AP047-RECORDS-WRITTEN TO CR-AP047-RECORDS-WRITTEN.   15550000
155600     MOVE PV-ADJSTMNT-CNT          TO CR-ADJSTMNT-CNT.            15560000
155700     MOVE CR-CKPT-RESTART-INFO  TO TCKRSTINF-WORK-STRG-DESC-TEXT. 15570000
155800     MOVE 4022                  TO TCKRSTINF-WORK-STRG-DESC-LEN.  15580000
155900                                                                  15590000
156000     PERFORM WITH TEST AFTER                                      15600000
156100             VARYING PC-RETRY-COUNT FROM 1 BY 1                   15610000
156200             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             15620000
156300                     SQLCODE = ZERO                               15630000
156400                                                                  15640000
156500             EXEC SQL                                             15650000
156600                 UPDATE TCKRSTINF                                 15660000
156700                 SET WORK_STRG_DESC   = :TCKRSTINF-WORK-STRG-DESC 15670000
156800                 WHERE PLAN_NAME      = :PC-PROGRAM-NAME          15680000
156900             END-EXEC                                             15690000
157000                                                                  15700000
157100             EVALUATE TRUE                                        15710000
157200                 WHEN SQLCODE = ZERO                              15720000
157300                 WHEN SQLCODE = -904                              15730000
157400                 WHEN SQLCODE = -913                              15740000
157500                      CONTINUE                                    15750000
157600                                                                  15760000
157700                 WHEN SQLWARN0 NOT = SPACES                       15770000
157800                 WHEN SQLCODE  NOT = ZERO                         15780000
157900                     MOVE PV-ABEND-PARAGRAPH                      15790000
158000                                         TO AA-PARAGRAPH-NAME     15800000
158100                     DISPLAY '******** PLAN_NAME:'                15810000
158200                              PC-PROGRAM-NAME                     15820000
158300                     MOVE 'UNSUCCESSFUL UPDATE'                   15830000
158400                                         TO PV-ABEND-OPERATION    15840000
158500                     MOVE 'TCKRSTINF'    TO PV-ABEND-STRUCTURE-1  15850000
158600                     MOVE SPACES         TO PV-ABEND-STRUCTURE-2  15860000
158700                                            PV-ABEND-STRUCTURE-3  15870000
158800                     PERFORM Z999-DB2-ABEND                       15880000
158900             END-EVALUATE                                         15890000
159000     END-PERFORM.                                                 15900000
159100                                                                  15910000
159200     IF PC-RETRY-COUNT > PC-RETRY-MAX                             15920000
159300         MOVE PV-ABEND-PARAGRAPH                                  15930000
159400                             TO AA-PARAGRAPH-NAME                 15940000
159500         DISPLAY '******** PLAN_NAME:'                            15950000
159600                  PC-PROGRAM-NAME                                 15960000
159700         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    15970000
159800                             TO PV-ABEND-OPERATION                15980000
159900         MOVE 'TCKRSTINF'    TO PV-ABEND-STRUCTURE-1              15990000
160000         MOVE SPACES         TO PV-ABEND-STRUCTURE-2              16000000
160100                                PV-ABEND-STRUCTURE-3              16010000
160200         PERFORM Z999-DB2-ABEND                                   16020000
160300     END-IF.                                                      16030000
160400                                                                  16040000
160500*----------------------------------------------------------------*16050000
160600*  INSERT ERROR RECORDS INTO TOUTAPF                             *16060000
160700*----------------------------------------------------------------*16070000
160800 U600-INSERT-OUTAPF-RECORDS.                                      16080000
160900     MOVE 'U600-INSERT-OUTAPF-RECORDS' TO PV-ABEND-PARAGRAPH.     16090000
161000                                                                  16100000
161100     EXEC SQL                                                     16110000
161200         INSERT INTO TOUTAPF                                      16120000
161300                 (ADJ_ERR_RPT_ODR)                                16130000
161400         VALUES  (:OUTAPF-ADJ-ERR-RPT-ODR)                        16140000
161500     END-EXEC                                                     16150000
161600     EVALUATE TRUE                                                16160000
161700         WHEN SQLCODE = ZERO                                      16170000
161800              ADD 1 TO PV-TOUTAPF-ERROR-CNT                       16180000
161900         WHEN SQLWARN0 NOT = SPACES                               16190000
162000         WHEN SQLCODE  NOT = ZERO                                 16200000
162100             MOVE 'UNSUCCESSFUL INSERT'                           16210000
162200                                 TO PV-ABEND-OPERATION            16220000
162300             MOVE 'TOUTAPF'      TO PV-ABEND-STRUCTURE-1          16230000
162400             MOVE SPACES         TO PV-ABEND-STRUCTURE-2          16240000
162500                                    PV-ABEND-STRUCTURE-3          16250000
162600                                    PV-ABEND-STRUCTURE-4          16260000
162700             PERFORM Z999-DB2-ABEND                               16270000
162800     END-EVALUATE.                                                16280000
162900                                                                  16290000
163000                                                                  16300000
163100*----------------------------------------------------------------*16310000
163200*    OPENS THE ADJSTMNT CURSOR.                                  *16320000
163300*----------------------------------------------------------------*16330000
163400 Y100-OPEN-ADJSTMNT-CSR.                                          16340000
163500                                                                  16350000
163600     MOVE 'Y100-OPEN-ADJSTMNT-CSR' TO PV-ABEND-PARAGRAPH.         16360000
163700                                                                  16370000
163800     EXEC SQL                                                     16380000
163900         OPEN ADJSTMNT_CSR                                        16390000
164000     END-EXEC.                                                    16400000
164100                                                                  16410000
164200     EVALUATE TRUE                                                16420000
164300         WHEN SQLCODE = ZERO                                      16430000
164400              CONTINUE                                            16440000
164500                                                                  16450000
164600         WHEN SQLWARN0 NOT = SPACES                               16460000
164700         WHEN SQLCODE  NOT = ZERO                                 16470000
164800             MOVE 'UNSUCCESSFUL OPEN ON ADJSTMNT_CSR'             16480000
164900                                 TO PV-ABEND-OPERATION            16490000
165000             MOVE 'TADJRNL'      TO PV-ABEND-STRUCTURE-1          16500000
165100             MOVE 'TAJSPINT'     TO PV-ABEND-STRUCTURE-2          16510000
165200             MOVE 'TTRNCDE '     TO PV-ABEND-STRUCTURE-3          16520000
165300             MOVE SPACES         TO PV-ABEND-STRUCTURE-4          16530000
165400             PERFORM Z999-DB2-ABEND                               16540000
165500     END-EVALUATE.                                                16550000
165600                                                                  16560000
165700                                                                  16570000
165800*----------------------------------------------------------------*16580000
165900*    CLOSES THE ADJSTMNT CURSOR.                                  16590000
166000*----------------------------------------------------------------*16600000
166100 Y200-CLOSE-ADJSTMNT-CSR.                                         16610000
166200                                                                  16620000
166300     MOVE 'Y200-CLOSE-ADJSTMNT-CSR' TO PV-ABEND-PARAGRAPH.        16630000
166400                                                                  16640000
166500     EXEC SQL                                                     16650000
166600         CLOSE ADJSTMNT_CSR                                       16660000
166700     END-EXEC.                                                    16670000
166800                                                                  16680000
166900     EVALUATE TRUE                                                16690000
167000         WHEN SQLCODE = ZERO                                      16700000
167100              CONTINUE                                            16710000
167200                                                                  16720000
167300         WHEN SQLWARN0 NOT = SPACES                               16730000
167400         WHEN SQLCODE  NOT = ZERO                                 16740000
167500             MOVE 'UNSUCCESSFUL CLOSE ON ADJSTMNT_CSR'            16750000
167600                                 TO PV-ABEND-OPERATION            16760000
167700             MOVE 'TADJRNL'      TO PV-ABEND-STRUCTURE-1          16770000
167800             MOVE 'TAJPSINT'     TO PV-ABEND-STRUCTURE-2          16780000
167900             MOVE 'TTRNCDE'      TO PV-ABEND-STRUCTURE-3          16790000
168000             MOVE SPACES         TO PV-ABEND-STRUCTURE-4          16800000
168100             PERFORM Z999-DB2-ABEND                               16810000
168200     END-EVALUATE.                                                16820000
168300                                                                  16830000
168400*----------------------------------------------------------------*16840000
168500*    OPENS THE INVENTORY PARAMETERS TABLE                        *16850000
168600*----------------------------------------------------------------*16860000
168700 Y300-OPEN-INVPAR-CSR.                                            16870000
168800                                                                  16880000
168900     MOVE 'Y300-OPEN-INVPAR-CSR' TO PV-ABEND-PARAGRAPH.           16890000
169000                                                                  16900000
169100     EXEC SQL                                                     16910000
169200         OPEN INVPAR_CSR                                          16920000
169300     END-EXEC.                                                    16930000
169400                                                                  16940000
169500     EVALUATE TRUE                                                16950000
169600         WHEN SQLCODE = ZERO                                      16960000
169700              CONTINUE                                            16970000
169800                                                                  16980000
169900         WHEN SQLWARN0 NOT = SPACES                               16990000
170000         WHEN SQLCODE  NOT = ZERO                                 17000000
170100             MOVE 'UNSUCCESSFUL OPEN ON INVPAR_CSR'               17010000
170200                                 TO PV-ABEND-OPERATION            17020000
170300             MOVE SPACES         TO PV-ABEND-STRUCTURE-1          17030000
170400                                    PV-ABEND-STRUCTURE-2          17040000
170500                                    PV-ABEND-STRUCTURE-3          17050000
170600                                    PV-ABEND-STRUCTURE-4          17060000
170700             PERFORM Z999-DB2-ABEND                               17070000
170800     END-EVALUATE.                                                17080000
170900                                                                  17090000
171000***************************************************************** 17100000
171100*     FETCH THE ADJSTMNT CURSOR                                   17110000
171200***************************************************************** 17120000
171300 Y400-FETCH-INVPAR-CSR.                                           17130000
171400*                                                                 17140000
171500     MOVE 'Y400-FETCH-INVPAR-CSR ' TO PV-ABEND-PARAGRAPH.         17150000
171600                                                                  17160000
171700     EXEC SQL                                                     17170000
171800         FETCH INVPAR_CSR                                         17180000
171900         INTO                                                     17190000
172000            :INVPAR-PLND-INV-DTE                                  17200000
172100           ,:INVPAR-LOC-NBR                                       17210000
172200     END-EXEC.                                                    17220000
172300                                                                  17230000
172400     EVALUATE TRUE                                                17240000
172500         WHEN SQLCODE = ZERO                                      17250000
172600              ADD 1 TO PV-INVPAR-CNT                              17260000
172700              MOVE INVPAR-LOC-NBR      TO PV-STR-NBR              17270000
172800                                          PV-LOC-NBR(PV-STR-NBR)  17280000
172900              IF  PROCESS-MONTHLY-EXTRACT                         17290000
173000                 IF  INVPAR-PLND-INV-DTE > APCNTL-PREV-WK-END-DTE 17300005
173100                 AND INVPAR-PLND-INV-DTE <= APCNTL-CURR-WK-END-DTE17310005
173200                     MOVE APCNTL-PREV-WK-END-DTE                  17320005
173300                       TO PV-INV-DTE(PV-STR-NBR)                  17330005
173310                 ELSE                                             17331005
173320                     MOVE INVPAR-PLND-INV-DTE                     17332005
173330                       TO PV-INV-DTE(PV-STR-NBR)                  17333005
173340                 END-IF                                           17334005
173400              ELSE                                                17340000
173401**** THIS PATH WILL APPLY TO PROCESS-WEEKLY-EXTRACT               17340105
173410                 IF INVPAR-PLND-INV-DTE > APCNTL-CURR-WK-END-DTE  17341005
173420                    MOVE APCNTL-CURR-WK-END-DTE                   17342005
173430                      TO PV-INV-DTE(PV-STR-NBR)                   17343005
173440                 ELSE                                             17344005
173500                     MOVE INVPAR-PLND-INV-DTE                     17350005
173600                       TO PV-INV-DTE(PV-STR-NBR)                  17360005
173700                 END-IF                                           17370005
173710              END-IF                                              17371004
173800         WHEN SQLCODE = +100                                      17380000
173900              SET END-OF-INVPAR-CSR TO TRUE                       17390000
174000                                                                  17400000
174100         WHEN SQLWARN0 NOT = SPACES                               17410000
174200         WHEN SQLCODE  NOT = ZERO                                 17420000
174300             MOVE 'UNSUCCESSFUL FETCH FOR INVPAR '                17430000
174400                                 TO PV-ABEND-OPERATION            17440000
174500             MOVE SPACES         TO PV-ABEND-STRUCTURE-1          17450000
174600                                    PV-ABEND-STRUCTURE-2          17460000
174700                                    PV-ABEND-STRUCTURE-3          17470000
174800                                    PV-ABEND-STRUCTURE-4          17480000
174900             PERFORM Z999-DB2-ABEND                               17490000
175000     END-EVALUATE.                                                17500000
175100                                                                  17510000
175200*----------------------------------------------------------------*17520000
175300*    CLOSES THE INVENTORY PARAMETER CURSOR                        17530000
175400*----------------------------------------------------------------*17540000
175500 Y500-CLOSE-INVPAR-CSR.                                           17550000
175600                                                                  17560000
175700     MOVE 'Y500-CLOSE-INVPAR-CSR' TO PV-ABEND-PARAGRAPH.          17570000
175800                                                                  17580000
175900     EXEC SQL                                                     17590000
176000         CLOSE INVPAR_CSR                                         17600000
176100     END-EXEC.                                                    17610000
176200                                                                  17620000
176300     EVALUATE TRUE                                                17630000
176400         WHEN SQLCODE = ZERO                                      17640000
176500              CONTINUE                                            17650000
176600                                                                  17660000
176700         WHEN SQLWARN0 NOT = SPACES                               17670000
176800         WHEN SQLCODE  NOT = ZERO                                 17680000
176900             MOVE 'UNSUCCESSFUL CLOSE ON INVPAR_CSR'              17690000
177000                                 TO PV-ABEND-OPERATION            17700000
177100             MOVE SPACES         TO PV-ABEND-STRUCTURE-1          17710000
177200                                    PV-ABEND-STRUCTURE-2          17720000
177300                                    PV-ABEND-STRUCTURE-3          17730000
177400                                    PV-ABEND-STRUCTURE-4          17740000
177500             PERFORM Z999-DB2-ABEND                               17750000
177600     END-EVALUATE.                                                17760000
177700                                                                  17770000
177800*----------------------------------------------------------------*17780000
177900*    ISSUES AN SQL COMMIT WORK AFTER A LUW HAS BEEN COMPLETED.   *17790000
178000*----------------------------------------------------------------*17800000
178100 Z100-COMMIT.                                                     17810000
178200                                                                  17820000
178300     MOVE 'Z100-COMMIT'    TO PV-ABEND-PARAGRAPH.                 17830000
178400                                                                  17840000
178500     EXEC SQL                                                     17850000
178600         COMMIT                                                   17860000
178700     END-EXEC.                                                    17870000
178800                                                                  17880000
178900     EVALUATE TRUE                                                17890000
179000         WHEN SQLCODE = ZEROS                                     17900000
179100             CONTINUE                                             17910000
179200         WHEN OTHER                                               17920000
179300             MOVE 'UNSUCCESSFUL COMMIT'                           17930000
179400                                 TO PV-ABEND-OPERATION            17940000
179500             MOVE SPACES         TO PV-ABEND-STRUCTURE-1          17950000
179600             PERFORM Z999-DB2-ABEND                               17960000
179700     END-EVALUATE.                                                17970000
179800                                                                  17980000
179900 Z998-ABEND.                                                      17990000
180000*                                                                 18000000
180100******************************************************************18010000
180200*     ABEND ROUTINE                                               18020000
180300******************************************************************18030000
180400                                                                  18040000
180500     DISPLAY PV-ABEND-PROGRAM.                                    18050000
180600     DISPLAY PV-ABEND-SQLCODE.                                    18060000
180700     DISPLAY PV-ABEND-PARAGRAPH.                                  18070000
180800     DISPLAY PV-ABEND-OPERATION.                                  18080000
180900     DISPLAY PV-ABEND-STRUCTURE-1.                                18090000
181000     DISPLAY PV-ABEND-STRUCTURE-2.                                18100000
181100     DISPLAY PV-ABEND-STRUCTURE-3.                                18110000
181200     DISPLAY PV-ABEND-STRUCTURE-4.                                18120000
181300     DISPLAY PV-ABEND-STRUCTURE-5.                                18130000
181400     DISPLAY PV-ABEND-STATUS.                                     18140000
181500     DISPLAY PV-ABEND-OPERATION.                                  18150000
181600     CALL 'ILBOABN0' USING ABEND-CODE.                            18160000
181700                                                                  18170000
181800                                                                  18180000
181900 Z999-DB2-ABEND.                                                  18190000
182000*                                                                 18200000
182100***************************************************************** 18210000
182200*     PROCESS DB2 ABENDS                                          18220000
182300***************************************************************** 18230000
182400*                                                                 18240000
182500                                                                  18250000
182600     DISPLAY 'VENDOR BEING PROCESSED = ' ADJRNL-VND-NBR.          18260000
182700     DISPLAY 'DOC NUMBER = ' ADJRNL-DOC-NBR.                      18270000
182800     DISPLAY 'DOC DATE = ' ADJRNL-DOC-DTE.                        18280000
182900     DISPLAY 'AP TRANCODE = ' ADJRNL-AP-TRN-CDE.                  18290000
183000     DISPLAY '*** DB2 ERROR '.                                    18300000
183100     DISPLAY '*** SQL CODE = '  PV-ABEND-SQLCODE.                 18310000
183200     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                 18320000
183300     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               18330000
183400     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               18340000
183500     DISPLAY '*** TABLE 1   = ' PV-ABEND-STRUCTURE-1.             18350000
183600     IF PV-ABEND-STRUCTURE-2 > SPACES                             18360000
183700         DISPLAY '*** TABLE 2   = ' PV-ABEND-STRUCTURE-2.         18370000
183800     IF PV-ABEND-STRUCTURE-3 > SPACES                             18380000
183900         DISPLAY '*** TABLE 3   = ' PV-ABEND-STRUCTURE-3.         18390000
184000     IF PV-ABEND-STRUCTURE-4 > SPACES                             18400000
184100         DISPLAY '*** TABLE 4   = ' PV-ABEND-STRUCTURE-4.         18410000
184200                                                                  18420000
184300     COPY DPPD004.                                                18430000
184400                                                                  18440000
184500     MOVE +4013                    TO ABEND-CODE.                 18450000
184600                                                                  18460000
184700     CALL 'ILBOABN0' USING ABEND-CODE.                            18470000
