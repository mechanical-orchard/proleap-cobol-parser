000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400                                                                  00040000
000500 PROGRAM-ID.    DLKUP034.                                         00050000
000600 AUTHOR.        RON KRIER.                                        00060000
000700 INSTALLATION.  KOHLS.                                            00070000
000800 DATE-WRITTEN   NOVEMBER, 2009.                                   00080000
000900 DATE-COMPILED.                                                   00090000
001000                                                                  00100000
001100******************************************************************00110000
001200*  THIS PROGRAM UPDATES ROWS ON THE PCT_BUS_EVNT_EXPRT TABLE      00120000
001300*  TO INDICATE THAT CERTAIN SHIPPING EVENTS ARE NOT READY TO      00130000
001310*  BE EXTRACTED AND SENT TO THE DLX LABOR SYSTEM.                 00131000
001320*  INPUT FILE FOR THIS PROGRAM WAS CREATED OUT OF DLKUT034.       00132000
001330******************************************************************00133000
001340                                                                  00134000
001350******************************************************************00135000
001360 ENVIRONMENT DIVISION.                                            00136000
001370******************************************************************00137000
001380                                                                  00138000
001390 CONFIGURATION SECTION.                                           00139000
001400                                                                  00140000
001500 SOURCE-COMPUTER.        IBM-3090.                                00150000
001600 OBJECT-COMPUTER.        IBM-3090.                                00160000
001700                                                                  00170000
001800 INPUT-OUTPUT SECTION.                                            00180000
001900                                                                  00190000
002000 FILE-CONTROL.                                                    00200000
002100                                                                  00210000
002200     SELECT EXPORT-KEY-FILE                                       00220000
002300         ASSIGN TO INP01.                                         00230000
002400                                                                  00240000
002500******************************************************************00250000
002600 DATA DIVISION.                                                   00260000
002700******************************************************************00270000
002800                                                                  00280000
002900 FILE SECTION.                                                    00290000
003000                                                                  00300000
003100 FD  EXPORT-KEY-FILE                                              00310000
003200     RECORDING MODE IS F                                          00320000
003300     LABEL RECORDS ARE STANDARD                                   00330000
003400     BLOCK CONTAINS 0 RECORDS.                                    00340000
003500                                                                  00350000
003600 01  EXPORT-KEY-RECORD                PIC X(080).                 00360000
003700                                                                  00370000
003800*                                                                 00380000
003900******************************************************************00390000
004000 WORKING-STORAGE SECTION.                                         00400000
004100******************************************************************00410000
004200*                                                                 00420000
004300******************************************************************00430000
004400*  RECORD LAYOUT FOR THE EXPORT KEY FILE                          00440000
004500******************************************************************00450000
004600     COPY DLRD015.                                                00460000
004700*                                                                 00470000
004800******************************************************************00480000
004900*  DB2 FORMATTED MESSAGE AREA                                     00490000
005000******************************************************************00500000
005100     COPY DPWS004.                                                00510000
005200*                                                                 00520000
005300*                                                                 00530000
005400     COPY SQLCA2.                                                 00540000
005500*                                                                 00550000
005600******************************************************************00560000
005700*  COMMUNICATIONS AREA FOR DB2                                    00570000
005800******************************************************************00580000
005900*                                                                 00590000
006000     EXEC SQL                                                     00600000
006100          INCLUDE SQLCA                                           00610000
006200     END-EXEC.                                                    00620000
006300*                                                                 00630000
006400*                                                                 00640000
007300******************************************************************00730000
007400*  COBOL DECLARATION AND DCLGEN MEMBER FOR THE PC APPLICATION     00740000
007500*  ID BUSINESS EVENT EXPORT TABLE                                 00750000
007600******************************************************************00760000
007700     EXEC SQL                                                     00770000
007800          INCLUDE PCT00011                                        00780000
007900     END-EXEC.                                                    00790000
008000*                                                                 00800000
008100 01  ABEND-CODE                      PIC S9(04)    VALUE +0       00810000
008200                                                   COMP SYNC.     00820000
008300                                                                  00830000
008400 01  DATABASE-KEYS.                                               00840000
008500     05  DK-EVNT-EXPRT-ID            PIC S9(09)    COMP.          00850000
008600                                                                  00860000
008700 01  PS-PROGRAM-SWITCHES.                                         00870000
008800     05  PS-EOF-SW                   PIC  X(01)    VALUE 'N'.     00880000
008900         88  PS-EOF                                VALUE 'Y'.     00890000
009000         88  PS-NOT-EOF                            VALUE 'N'.     00900000
009010     05  PS-UPDATE-SUCCESSFUL-SW     PIC  X(01)    VALUE 'N'.     00901000
009020         88  PS-UPDATE-SUCCESSFUL                  VALUE 'Y'.     00902000
009030         88  PS-UPDATE-NOT-SUCCESSFUL              VALUE 'N'.     00903000
009040                                                                  00904000
009050 01  PC-PROGRAM-CONSTANTS.                                        00905000
009060     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          00906000
009070         'DLKUP034'.                                              00907000
009080                                                                  00908000
009090     05  PC-COMMIT-HOLD              PIC 9(3)      VALUE 010.     00909000
009100     05  PC-C                        PIC X(1)      VALUE 'C'.     00910000
009200     05  PC-X                        PIC X(1)      VALUE 'X'.     00920000
009400     05  PC-MAX-RETRIES              PIC S9(03) VALUE 3 COMP-3.   00940000
009500                                                                  00950000
009600 01  PV-PROGRAM-VARIABLES.                                        00960000
009700     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.  00970000
009800     05  PV-DB2-OPERATION-ATTEMPTED  PIC  X(30)    VALUE SPACES.  00980000
009900     05  PV-DISPLAY-COUNT            PIC ZZZ,ZZZ,ZZ9.             00990000
010000     05  PV-SQLCODE                  PIC  9(4)     VALUE  0.      01000000
010100     05  PV-TIMESTAMP                PIC X(26)   VALUE SPACES.    01010000
010200     05  PV-NOTFND-COUNT             PIC S9(09)  VALUE +0         01020000
010300                                                    COMP-3.       01030000
010400     05  PV-PC-NOTFND-COUNT          PIC S9(09)  VALUE +0         01040000
010500                                                    COMP-3.       01050000
010600     05  PV-SU-NOTFND-COUNT          PIC S9(09)  VALUE +0         01060000
010700                                                    COMP-3.       01070000
010800     05  PV-READ-COUNT               PIC S9(09)  VALUE +0         01080000
010900                                                    COMP-3.       01090000
011130     05  PV-UPDATE-COUNT             PIC S9(09)  VALUE +0         01113000
011140                                                    COMP-3.       01114000
011190     05  PV-COMMIT-COUNT             PIC S9(09)  VALUE +0         01119000
011200                                                    COMP-3.       01120000
011300     05  PV-COMMIT-COUNTER           PIC 9(03)     VALUE ZERO.    01130000
011400     05  PV-RETRY-COUNTER            PIC S9(4) VALUE +0 COMP.     01140000
011500                                                                  01150000
011600 01  PV-COMMIT-INFO.                                              01160000
011700     05  FILLER                      PIC X(30) VALUE              01170000
011800        ' EXPORT KEY-RECORD NUMBER: '.                            01180000
011900     05  PV-COMMIT-KEY.                                           01190000
012000         10  PV-COMMIT-KEY-NBR       PIC 9999999999.              01200000
012100         10  FILLER                  PIC X(01) VALUE SPACE.       01210000
012200         10  PV-COMMIT-RECD-NBR      PIC ZZZ,ZZ9.                 01220000
012300         10  FILLER                  PIC X(01) VALUE SPACE.       01230000
012400     05  FILLER                      PIC X(24) VALUE SPACE.       01240000
012500     05  FILLER                      PIC X(22) VALUE              01250000
012600        ' # RECS UPDATED     : '.                                 01260000
012700     05  PV-RECS-UPDATED-COUNT       PIC 9(7)  VALUE 0.           01270000
012800*                                                                 01280000
012900*                                                                 01290000
013000******************************************************************01300000
013100 PROCEDURE DIVISION.                                              01310000
013200******************************************************************01320000
013300                                                                  01330000
013400 0000-PROGRAM-MAINLINE.                                           01340000
013500******************************************************************01350000
013600* 0000-PROGRAM-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE     01360000
013700*      PROGRAM.                                                   01370000
013800******************************************************************01380000
013900                                                                  01390000
014000     PERFORM 1000-INITIALIZE.                                     01400000
014100     PERFORM 2000-PROCESS-INPUT                                   01410000
014200       UNTIL PS-EOF.                                              01420000
014300     PERFORM 9000-EOJ-ROUTINE.                                    01430000
014400                                                                  01440000
014500     STOP RUN.                                                    01450000
014600*                                                                 01460000
014700 1000-INITIALIZE.                                                 01470000
014800******************************************************************01480000
014900*  DO FIRST TIME PROGRAM INITIALIZATION TASKS.                    01490000
015000******************************************************************01500000
015100                                                                  01510000
015200     OPEN INPUT  EXPORT-KEY-FILE.                                 01520000
015300                                                                  01530000
015400     MOVE +0 TO PV-COMMIT-COUNTER                                 01540000
015500                                                                  01550000
015600     EXEC SQL                                                     01560000
015700          SET :PV-TIMESTAMP = CURRENT TIMESTAMP                   01570000
015800     END-EXEC.                                                    01580000
015900                                                                  01590000
016000     PERFORM 7000-READ-INPUT.                                     01600000
016100                                                                  01610000
016200 2000-PROCESS-INPUT.                                              01620000
016300******************************************************************01630000
016400*  PROCESS THE INPUT FILE AND UPDATE THE EXPRT_STAT_CDE ON THE    01640000
016500*  PCT_BUS_EVNT_EXPRT TABLE TO A VALUE OF "C" WHICH INDICATES     01650000
016600*  THAT THE ROW IS READY TO BE EXTRACTED AND PUBLISHED TO THE     01660000
016700*  DLX APPLICATION.                                               01670000
016800******************************************************************01680000
016900                                                                  01690000
017200     PERFORM 8100-UPDATE-PC-EXPORT-TABLE.                         01720000
017365                                                                  01736500
017366     ADD +1 TO PV-COMMIT-COUNTER.                                 01736600
017367                                                                  01736700
017368     IF PV-COMMIT-COUNTER > PC-COMMIT-HOLD                        01736800
017369         EXEC SQL                                                 01736900
017370            COMMIT                                                01737000
017380         END-EXEC                                                 01738000
017390                                                                  01739000
017400         IF SQLCODE NOT = +0                                      01740000
017500             DISPLAY '### COMMIT FAILED ! ###'                    01750000
017600             PERFORM 9100-SQL-ABEND                               01760000
017700         END-IF                                                   01770000
017800                                                                  01780000
017900         ADD PV-COMMIT-COUNTER           TO PV-COMMIT-COUNT       01790000
018000         MOVE DK-EVNT-EXPRT-ID           TO PV-COMMIT-KEY-NBR     01800000
018100                                                                  01810000
018200         MOVE PV-COMMIT-COUNT    TO PV-RECS-UPDATED-COUNT         01820000
018300         DISPLAY 'COMMIT TAKEN: ' PV-COMMIT-INFO                  01830000
018400                                                                  01840000
018500         MOVE +0 TO PV-COMMIT-COUNTER                             01850000
018600     END-IF.                                                      01860000
018700                                                                  01870000
018800     PERFORM 7000-READ-INPUT.                                     01880000
018900                                                                  01890000
019000 7000-READ-INPUT.                                                 01900000
019100******************************************************************01910000
019200*  READ   THE INPUT FILE                                          01920000
019300******************************************************************01930000
019400     READ EXPORT-KEY-FILE INTO                                    01940000
019500          DL015-EAI-KEY-RECORD-LAYOUT                             01950000
019600          AT END SET PS-EOF  TO TRUE.                             01960000
019700                                                                  01970000
019800     IF PS-NOT-EOF                                                01980000
019900         ADD +1  TO PV-READ-COUNT                                 01990000
020000         MOVE DL015-EVNT-EXPRT-ID TO DK-EVNT-EXPRT-ID             02000000
020100     END-IF.                                                      02010000
020200*                                                                 02020000
020300                                                                  02030000
020400 8100-UPDATE-PC-EXPORT-TABLE.                                     02040000
020500                                                                  02050000
020600     PERFORM WITH TEST AFTER                                      02060000
020700             VARYING PV-RETRY-COUNTER FROM 1 BY 1                 02070000
020800             UNTIL   PV-RETRY-COUNTER > PC-MAX-RETRIES OR         02080000
020900                     (SQLCODE = ZERO OR SQLCODE = +100)           02090000
021000                                                                  02100000
021100         EXEC SQL                                                 02110000
021200             UPDATE PCT_BUS_EVNT_EXPRT                            02120000
021300                SET EXPRT_STAT_CDE = 'C'                          02130000
021500             WHERE EVNT_EXPRT_ID = :DK-EVNT-EXPRT-ID              02150000
021600         END-EXEC                                                 02160000
021700                                                                  02170000
021800         EVALUATE TRUE                                            02180000
021900             WHEN SQLCODE = ZERO                                  02190000
022000                 ADD +1           TO PV-UPDATE-COUNT              02200000
022200             WHEN SQLCODE = +100                                  02220000
022300                 ADD +1           TO PV-NOTFND-COUNT              02230000
022500             WHEN SQLCODE = -904                                  02250000
022600             WHEN SQLCODE = -911                                  02260000
022700             WHEN SQLCODE = -913                                  02270000
022800                 CONTINUE                                         02280000
022900         WHEN SQLCODE < ZERO                                      02290000
023000         WHEN SQLCODE > ZERO                                      02300000
023100         WHEN SQLWARN0 = 'W'                                      02310000
023200                 MOVE '8100-UPDATE-PC-EXPORT-TABLE'               02320000
023300                                  TO PV-PARAGRAPH-NAME            02330000
023400                 MOVE 'UPDATE OF PCT_BUS_EVNT_EXPRT'              02340000
023500                                  TO PV-DB2-OPERATION-ATTEMPTED   02350000
023600                 MOVE SQLCODE     TO PV-SQLCODE                   02360000
023700                 PERFORM 9100-SQL-ABEND                           02370000
023800         END-EVALUATE                                             02380000
023900     END-PERFORM.                                                 02390000
024000                                                                  02400000
024100     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES AND                    02410000
024200         (SQLCODE NOT = ZERO AND SQLCODE NOT = +100)              02420000
024300             MOVE '8100-UPDATE-PC-EXPORT-TABLE'                   02430000
024400                              TO PV-PARAGRAPH-NAME                02440000
024410             MOVE 'DEADLOCK * UPDATE PCT_BUS_EVNT_EXPRT'          02441000
024420                              TO PV-DB2-OPERATION-ATTEMPTED       02442000
024430             MOVE SQLCODE     TO PV-SQLCODE                       02443000
024440             PERFORM 9100-SQL-ABEND                               02444000
024450     END-IF.                                                      02445000
024460                                                                  02446000
026416 9000-EOJ-ROUTINE.                                                02641600
026417******************************************************************02641700
026418*  CLOSE OUTPUT FILE.  DISPLAY RECORD COUNTS                      02641800
026419******************************************************************02641900
026420     CLOSE EXPORT-KEY-FILE.                                       02642000
026430     MOVE PV-READ-COUNT    TO PV-DISPLAY-COUNT.                   02643000
026440     DISPLAY 'TOTAL RECORDS READ        : '  PV-DISPLAY-COUNT.    02644000
026490     MOVE PV-UPDATE-COUNT TO PV-DISPLAY-COUNT.                    02649000
026500     DISPLAY 'TOTAL RECORDS UPDATED     : '  PV-DISPLAY-COUNT.    02650000
027000     MOVE PV-NOTFND-COUNT TO PV-DISPLAY-COUNT.                    02700000
027100     DISPLAY 'TOTAL RECORDS NOT FOUND   : '  PV-DISPLAY-COUNT.    02710000
027600*                                                                 02760000
027700 9100-SQL-ABEND.                                                  02770000
027800******************************************************************02780000
027900*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    02790000
028000*  ERROR OR WARNING CODE OCCURS.                                  02800000
028100******************************************************************02810000
028200     DISPLAY '9100-SQL-ABEND'.                                    02820000
028300     DISPLAY '** ABEND     **'.                                   02830000
028400     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        02840000
028500     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              02850000
028600     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.     02860000
028700     DISPLAY '** SQLCODE   ** = ' PV-SQLCODE.                     02870000
028800     DISPLAY '***'                                                02880000
028900     DISPLAY '*** LAST COMMIT TAKEN **' PV-COMMIT-INFO            02890000
029000     DISPLAY '***'                                                02900000
029100     DISPLAY '*** COMMITTED UPDATE COUNTS FOLLOW: ***'            02910000
029200     DISPLAY '***'                                                02920000
029300     EXEC SQL                                                     02930000
029400          ROLLBACK                                                02940000
029500     END-EXEC.                                                    02950000
029600******************************************************************02960000
029700* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    02970000
029800* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         02980000
029900* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     02990000
030000* FORMAT.                                                         03000000
030100******************************************************************03010000
030200     COPY DPPD004.                                                03020000
030300                                                                  03030000
030400     MOVE +4013                  TO ABEND-CODE.                   03040000
030500     CALL 'ILBOABN0' USING ABEND-CODE.                            03050000
