000100 IDENTIFICATION DIVISION.                                         00010001
000200 PROGRAM-ID.      APKUT223.                                       00020001
000300 AUTHOR.          ALEXIS KEIKER.                                  00030001
000400 INSTALLATION.    KOHLS DEPARTMENT STORES.                        00040001
000500 DATE-WRITTEN.    07/13/01.                                       00050022
000600*----------------------------------------------------------------*00060099
000700*   REPLACE IMPORT INVOICE WITH ADJUSTMENT FOR JOURNALIZED PO    *00070099
000800*----------------------------------------------------------------*00080099
000900*                  COBOL390 WITH DB2 SQL                         *00090099
001000*----------------------------------------------------------------*00100099
001100*                                                                *00110099
001200* THIS PROGRAM WILL READ ALL OF THE EDITED 210 INVOICES TO       *00120099
001300* DETERMINE IF ALL THE OTHER INVOICES FOR THAT PO NUMBER HAVE    *00130099
001400* ALREADY BEEN JOURNALIZED.  IF THEY HAVE, THE INVOICE NEEDS     *00140099
001500* TO BE ENTERED INTO THE SYSTEM AS AN ADJUSTMENT INSTEAD OF      *00150099
001600* BEING ENTERED AS AN INVOICE.  THIS PROGRAM WILL CREATE         *00160099
001700* ADJUSTMENT JOURNAL TRANSACTIONS FOR THOSE INVOICES WHERE       *00170099
001800* THE PO IS ALREADY JOURNALIZED, AND IT WILL REWRITE THE         *00180099
001900* INVOICE RECORDS FOR THOSE PO NUMBERS THAT ARE NOT. AFTER       *00190099
002000* THIS PROGRAM RUNS, THE ADJUSTMENT JOURNAL TRANSACTIONS WILL    *00200099
002100* BE LOADED INTO THE ADJUSTMENT JOURNAL DATABASE AND THE INVOICE *00210099
002200* RECORDS WILL BE LOADED INTO THE INVOICE DATABASE.              *00220099
002300*                                                                *00230099
002400*----------------------------------------------------------------*00240099
002500*                                                                *00250099
002600* DB2 TABLES:                                                    *00260099
002700*  1. INVOICE TABLE                   (TINVOIC TABLE)            *00270099
002800*  2. PURCHASE ORDER TABLE            (TPURCHS TABLE)            *00280099
002900*  3. TRANSACTION CODE TABLE          (TTRNCDE TABLE)            *00290099
003000*  4. EXTERNAL ENTERPRISE TABLE       (TEXTENT TABLE)            *00300099
003100*  5. EXTERNAL ENTERPRISE NAME TABLE  (TENTNME TABLE)            *00310099
003200*  6. PURCHASE ORDER ITEM TABLE       (TPURITM TABLE)            *00320099
003300*  7. ACCOUNTS PAYABLE CONTROL TABLE  (TAPCNTL TABLE)            *00330099
003400*                                                                *00340099
003500* INPUT FILE:                                                    *00350099
003600*  1. EDITED EDI 210 INVOICES         (COPYBOOK APRD016)         *00360099
003700*                                                                *00370099
003800* OUTPUT FILE:                                                   *00380099
003900*  1. INVOICES READY TO LOAD          (COPYBOOK APRD016)         *00390099
004000*  2. ADJUSTMENT DETAILS              (COPYBOOK APRD045)         *00400099
004100*                                                                *00410099
004200*----------------------------------------------------------------*00420099
004300* CHANGE LOG:                                                    *00430099
004400*                                                                *00440099
004500* 05/16/2002                                                     *00450099
004600*   CHANGE MADE:  NI-SKU CHANGES.  RECOMPILE FROM PRODUCTION     *00460099
004700*   TO INCORPORATE CHANGES TO COPYBOOK APRD045.                  *00470099
004800* MADE BY:  KEVIN CATLIN                   WR/IR #: 21278        *00480099
004900*                                                                *00490099
005000* 06/16/2002                                                     *00500099
005100*    ARK PO PROJECT PHASE 1.  RECOMPILE FROM PRODUCTION.         *00510099
005200* MADE BY: KEVIN CATLIN                    WR# 23500             *00520099
005300*                                                                *00530099
005400* 06/18/2002                                                     *00540099
005500*    REMOVED TABLE TPAYREQ; REPLACED ALL COLUMN REFERENCES WITH  *00550099
005600*    CORRESPONDING TINVOIC COLUMN.                               *00560099
005700* MADE BY: NANCY EILBES                    WR# 23500             *00570099
005800*                                                                *00580099
005900* 09/17/2002                                                     *00590099
006000*    ADDED BTCH_PRC_DTE - 1 DAY FROM TAPCNTL TO BE MOVED INTO    *00600099
006100*    AP045-ENTR-DTE.  PARAGRAPHS MODIFIED ARE D200 AND S400.     *00610099
006200* MADE BY: KEVIN CATLIN                  PITS #: 494629          *00620099
006300*                                                                *00630099
006400* 09/23/2002                                                     *00640099
006500*    CORRECTED TO BTCH_PRC_DTE + 1 DAY TO BE MOVED INTO          *00650099
006600*    AP045-ENTR-DTE.  PARAGRAPH MODIFIED IS S400.                *00660099
006700* MADE BY: KEVIN CATLIN                  PITS #: 494629          *00670099
006800*                                                                *00680099
006900*  DATE  09/17/2003                                              *00690099
007000*      CHANGE MADE: ADDED EFFECTIVE DATE CHECKING FOR TTRNCDE IN *00700099
007100*      THE TRANCODE_CSR CURSOR.                                  *00710099
007200*      MADE BY: MIKE BESKE              WR/IR #: WR21316         *00720099
007300*                                                                *00730099
007400*  DATE  04/22/2004                                              *00740099
007500*      CHANGE MADE: REMOVED LEADING 0 FROM THE HARDCODED STORE   *00750099
007600*      NUMBER IN PARA D200-.                                     *00760099
007700*      MADE BY: MIKE BESKE              WR/IR #: WR25805         *00770099
007800*                                                                *00780099
007900*  DATE  10/12/2005                                              *00790099
008000*      CHANGE MADE: ADDED CODE TO CHECK FOR PREVIOUS VENDOR      *00800099
008100*      NUMBER IN PARA B200-.  VENDOR NUMBER IS PART OF THE SORT  *00810099
008200*      KEYS OF THE INPUT FILE (PO/VENDOR NBRS).  THIS CORRECTS A *00820099
008300*      PROD PROBLEM WHERE 210 INVOICES BEING PROCESSED IN THE    *00830099
008400*      FILE WITH THE SAME PO NBR BUT DIFFERENT VENDOR NUMBERS    *00840099
008500*      WERE NOT GETTING THE CORRECT VENDOR NAME IN THE OUTPUT    *00850099
008600*      FILES.                                                    *00860099
008700*      MADE BY: MIKE BESKE              WR/IR #: P000811514      *00870099
008800*                                                                *00880099
008900*  DATE  03/11/2007                                              *00890099
009000*      CHANGE MADE: MBDC PROJECT - RECOMPILE                     *00900099
009100*      MADE BY: GREG WISIALOWSKI        WR/IR #: WR21578         *00910099
009200*                                                                *00920099
009300*  DATE  03/16/2009                                              *00930099
009400*      CHANGE MADE: UPDATE TRANCODES FOR EDI 210 ADJUSTMENTS.    *00940099
009500*      MODIFY THE PROCESS THAT GENERATES ADJUSTMENTS IN PLACE    *00950099
009600*      OF INVOICES TO USE SPECIFIC TRANCODES BASED ON THE CHARGE *00960099
009700*      TYPE RATHER THAN USE GENERIC IMPORT ADJUSTMENTS TRANCODE  *00970099
009800*      FOR ALL.  ADD ADDITIONAL TRAN CODES TO WHERE CLAUSE IN    *00980099
009900*      TRANCODE_CSR.  REMOVED CONDITIONAL LOGIC FOR EXPEDITORS.  *00990099
010000*      CHANGES MADE IN PARAGRAPHS C200 AND D100.                 *01000099
010100*      MADE BY: KEVIN CATLIN            WR/IR #: WR35138         *01010099
010200*                                                                *01020099
010300*  DATE  03/30/2009                                              *01030099
010400*      CHANGE MADE:  IN PARAGRAPH D200, MODIFIED HOW THE INVOICE *01040099
010500*      NUMBER IS CREATED FOR ADJUSTMENTS.  THE INVOICE NUMBER    *01050099
010600*      WILL STRING WITH THE TRAN CODE TO CREATE A UNIQUE INVOICE *01060099
010700*      NUMBER FOR EVENTUAL INTERFACE INTO PEOPLESOFT.  THIS WILL *01070099
010800*      PREVENT RECYCLING FOR MULTIPLE ADJUSTMENT RECORDS CREATED *01080099
010900*      FOR THE SAME VENDOR/INVOICE NUMBER COMBINATION.           *01090099
011000*      MADE BY: KEVIN CATLIN            WR/IR #: INC000000751411 *01100099
011001*                                                                 01100199
011010*  DATE  10/20/2009                                              *01101099
011020*      CHANGE MADE:  RECOMPILE FOR 310 EDI PROJECT.              *01102099
011030*      COPYBOOK APRD016 WENT FROM 335 TO 361 BYTES.              *01103099
011040*      MADE BY: PAUL STROEDE            WR/IR #: WR23145         *01104099
011050*                                                                 01105099
011060*  DATE  01/12/2010                                              *01106099
011070*      CHANGE MADE:  UPDATED CODE IN PARAGRAPH D200 IN WRITE THE *01107099
011080*      DATA FROM THE TWO NEW TEXINVC COLUMNS TO AP045-RSN-TXT.   *01108099
011090*      MADE BY: PAUL STROEDE            WR/IR #: WR23145         *01109099
011091*                                                                 01109199
011092*  DATE  07/01/2015                                               01109299
011093*        CHANGES MADE: UPDATED TO HANDLE THE NEW MPF MANAGEMENT  *01109399
011094*        FEES FOR GROUPED PO INVOICES WITH CHARGE CODE AS 'BSS'. *01109499
011095*        MADE BY: MEENAKSHI MITTAL        WR/IR #: CHG112172     *01109599
011096*                                                                 01109699
011097*  DATE  02/13/2020                                               01109799
011098*        CHANGES MADE: CHANGED THE ACCOUNT NUMBER FROM 10306 TO  *01109899
011099*        20281 AS PART OF REQUEST INC8763715.                    *01109999
011100*        MADE BY: COGNIZANT               WR/IR #: CHG0239465    *01110099
011101*                                                                 01110199
011102*  DATE  05/21/2020                                               01110299
011103*        CHANGES MADE: CHANGED THE ACCOUNT NUMBER FROM 20281 TO  *01110399
011104*        10375                                                   *01110499
011105*        MADE BY: NANCY EILBES            WR/IR #: CHG0244277    *01110599
011110*----------------------------------------------------------------*01111099
011200                                                                  01120022
011300 ENVIRONMENT DIVISION.                                            01130001
011400                                                                  01140022
011500 CONFIGURATION SECTION.                                           01150001
011600 SOURCE-COMPUTER. IBM-3090.                                       01160001
011700 OBJECT-COMPUTER. IBM-3090.                                       01170001
011800                                                                  01180022
011900 INPUT-OUTPUT SECTION.                                            01190001
012000 FILE-CONTROL.                                                    01200001
012100     SELECT EDITED-EXP-INV-FILE ASSIGN TO INP01.                  01210099
012200     SELECT INVOICE-LOAD-FILE ASSIGN TO OUT01.                    01220099
012300     SELECT ADJUST-JRNL-FILE ASSIGN TO OUT02.                     01230099
012400                                                                  01240022
012500 DATA DIVISION.                                                   01250001
012600                                                                  01260022
012700 FILE SECTION.                                                    01270001
012800                                                                  01280022
012900 FD  EDITED-EXP-INV-FILE                                          01290099
013000     RECORDING MODE IS F                                          01300001
013100     LABEL RECORDS ARE STANDARD                                   01310001
013200     BLOCK CONTAINS 0 RECORDS                                     01320099
013300     DATA RECORD IS INPUT-EXP-INV-RECORD.                         01330099
013400                                                                  01340099
013500 01  EDITED-EXP-INV-RECORD      PIC X(476).                       01350099
013600                                                                  01360022
013700 FD  INVOICE-LOAD-FILE                                            01370099
013800     RECORDING MODE F                                             01380001
013900     LABEL RECORDS ARE STANDARD                                   01390001
014000     DATA RECORD IS OUTPUT-INVC-RECORD.                           01400099
014100 01  INVOICE-LOAD-RECORD       PIC X(476).                        01410099
014200                                                                  01420022
014300 FD  ADJUST-JRNL-FILE                                             01430099
014400     RECORDING MODE F                                             01440003
014500     LABEL RECORDS ARE STANDARD                                   01450003
014600     DATA RECORD IS ADJUST-JRNL-RECORD.                           01460099
014700 01  ADJUST-JRNL-RECORD         PIC X(500).                       01470099
014800                                                                  01480010
014900                                                                  01490022
015000 WORKING-STORAGE SECTION.                                         01500001
015100                                                                  01510001
015200 01  WS-RETRY-COUNTER                 PIC S9(4) COMP VALUE +0.    01520099
015300 01  WS-RETRY-MAX                     PIC S9(4) COMP VALUE +3.    01530099
015400                                                                  01540099
015500 01  DISPLAY-PO-NBR                   PIC 9(9).                   01550099
015600                                                                  01560070
015700 01  PV-PROGRAM-VARIABLES.                                        01570010
015800     05  PV-PREV-PO-NBR             PIC S9(9) COMP VALUE +0.      01580099
015900     05  PV-PREV-REMIT-TO-DUN-NBR   PIC X(09) VALUE SPACES.       01590099
016000     05  PV-CURR-TMST               PIC X(26) VALUE SPACES.       01600099
016100     05  PV-ENTR-DTE                PIC X(10) VALUE SPACES.       01610099
016200***  05  PV-EXPEDITORS              PIC X(9)  VALUE '009207259'.  01620099
016300     05  PV-HOLD-TRANCODE           PIC X(2)  VALUE SPACES.       01630099
016400     05  PV-INVC-ID                 PIC X(25)  VALUE SPACES.      01640099
016500     05  PV-CL-NBR                  PIC X(2)  VALUE SPACES.       01650099
016600     05  PV-CHANGE-CL-NBR REDEFINES PV-CL-NBR.                    01660017
016700         10  PV-FIRST-CL-NBR        PIC X(1).                     01670099
016800         10  PV-SEC-CL-NBR          PIC X(1).                     01680099
016900     05  PV-NET-COST                PIC S9(8)V99 COMP-3 VALUE +0. 01690099
017000     05  PV-DUTY-TOTAL              PIC S9(8)V99 COMP-3 VALUE +0. 01700099
017100     05  PV-OCNAIR-FRGT-TOTAL       PIC S9(8)V99 COMP-3 VALUE +0. 01710099
017200     05  PV-ROYAL-COMM-TOTAL        PIC S9(8)V99 COMP-3 VALUE +0. 01720099
017300     05  PV-DRAY-DECON-TOTAL        PIC S9(8)V99 COMP-3 VALUE +0. 01730099
017400     05  PV-BROKR-CHG-TOTAL         PIC S9(8)V99 COMP-3 VALUE +0. 01740099
017500     05  PV-OVSEA-CONS-TOTAL        PIC S9(8)V99 COMP-3 VALUE +0. 01750099
017510     05  PV-MPF-TOTAL               PIC S9(8)V99 COMP-3 VALUE +0. 01751099
017600     05  PV-MISC-TOTAL              PIC S9(8)V99 COMP-3 VALUE +0. 01760099
017700**** 05  PV-NONDUTY-TOTAL           PIC S9(8)V99 COMP-3 VALUE +0. 01770099
017800     05  PV-RVRS-CHRG-AMT           PIC S9(8)V99 COMP-3 VALUE +0. 01780099
017900     05  PV-START                   PIC S9(04)   COMP VALUE +0.   01790099
017910     05  PV-COMM-POS                PIC 9(03)    VALUE ZEROS.     01791099
018000                                                                  01800011
018100 01  PROGRAM-COUNTERS.                                            01810099
018200     05  COUNT-INVOIC-ROWS            PIC S9(04) COMP VALUE +0.   01820099
018300     05  AP-PRC-J-COUNT               PIC S9(04)      VALUE +0.   01830099
018400     05  AP-PRC-SPACE-COUNT           PIC S9(04)      VALUE +0.   01840099
018500     05  INPUT-COUNT                  PIC 9(09) VALUE 0.          01850099
018600     05  OUT-INVOICE-COUNT            PIC 9(09) VALUE 0.          01860099
018700     05  OUT-ADJUSTMENT-COUNT         PIC 9(09) VALUE 0.          01870099
018800                                                                  01880083
018900 01  TRAN-CDE-AREA.                                               01890080
019000     05  TRAN-CDE-TABLE OCCURS 10 TIMES INDEXED BY PV-TRAN-IDX.   01900099
019100         10  PV-AP-TRN-CDE            PIC X(02).                  01910080
019200         10  PV-PSTG-TYP-CDE          PIC X(02).                  01920080
019300         10  PV-TRN-TYP-CDE           PIC X(03).                  01930080
019400                                                                  01940061
019500 01  PS-PROGRAM-SWITCHES.                                         01950001
019600     05  INVOICE-CURSOR-SW            PIC X(01)      VALUE 'N'.   01960099
019700         88  END-OF-INVOICE-CSR                      VALUE 'Y'.   01970099
019800     05  TRANCODE-CSR-SW              PIC X(01)      VALUE 'N'.   01980099
019900         88  END-OF-TRANCODE-CSR                     VALUE 'Y'.   01990099
020000     05  PS-EMPTY-INVOIC-CSR          PIC X(01)      VALUE ' '.   02000099
020100         88  EMPTY-INVOIC-CSR                        VALUE 'Y'.   02010099
020200     05  PS-INVOICE-EOF               PIC X(01)      VALUE 'N'.   02020001
020300         88  INVOICE-EOF                             VALUE 'Y'.   02030001
020400     05  PS-OUTPUT-IND                PIC X(01)      VALUE ' '.   02040099
020500         88  PS-OUTPUT-INVOICE                       VALUE 'I'.   02050099
020600         88  PS-OUTPUT-ADJUST                        VALUE 'A'.   02060099
020700                                                                  02070014
020800 01  WS-ABEND-FIELDS.                                             02080010
020900     05  WS-ABEND-LITERAL          PIC  X(40)   VALUE             02090099
021000             '*****       ABEND'.                                 02100099
021100     05  WS-ABEND-PROGRAM-MSG.                                    02110099
021200         10  FILLER                PIC X(17)    VALUE             02120099
021300             '*****   PROGRAM: '.                                 02130099
021400         10  WS-ABEND-PROGRAM      PIC X(8)   VALUE 'APKUT223'.   02140099
021500     05  WS-ABEND-PARAGRAPH-MSG.                                  02150099
021600         10  FILLER                PIC  X(17)   VALUE             02160099
021700             '***** PARAGRAPH: '.                                 02170099
021800         10  WS-ABEND-PARAGRAPH    PIC X(35)  VALUE SPACES.       02180099
021900     05  WS-ABEND-OPERATION-MSG.                                  02190099
022000         10  FILLER                PIC  X(17)   VALUE             02200099
022100             '***** OPERATION: '.                                 02210099
022200         10  WS-ABEND-OPERATION    PIC X(50)  VALUE SPACES.       02220099
022300     05  WS-ABEND-TABLE1-MSG.                                     02230099
022400         10  FILLER                PIC  X(15)   VALUE             02240099
022500             '***** TABLE 1: '.                                   02250099
022600         10  WS-ABEND-STRUCTURE-1  PIC X(8)   VALUE SPACES.       02260099
022700     05  WS-ABEND-TABLE2-MSG.                                     02270099
022800         10  FILLER                PIC  X(15)   VALUE             02280099
022900             '***** TABLE 2: '.                                   02290099
023000         10  WS-ABEND-STRUCTURE-2  PIC X(8)   VALUE SPACES.       02300099
023100     05  WS-ABEND-STATUS           PIC XX     VALUE SPACES.       02310010
023200     05  WS-MESSAGE-LINE-1.                                       02320099
023300         10  FILLER                PIC  X(06)   VALUE '*****'.    02330099
023400         10  WS-MESSAGE-1          PIC  X(80)   VALUE SPACES.     02340099
023500     05  WS-MESSAGE-LINE-2.                                       02350099
023600         10  FILLER                PIC  X(06)   VALUE '*****'.    02360099
023700         10  WS-MESSAGE-2          PIC  X(80)   VALUE SPACES.     02370099
023800                                                                  02380099
023900 01  ABEND-CODE                    PIC S9(4)  COMP SYNC           02390010
024000                                              VALUE ZEROS.        02400010
024100     88 AP-TABLE-FULL              VALUE +4004.                   02410010
024200     88 AP-EMPTY-FILE              VALUE +4005.                   02420010
024300     88 AP-TABLE-NOTFND            VALUE +4006.                   02430099
024400     88 AP-DB2-ERROR               VALUE +4013.                   02440010
024500                                                                  02450022
024600                                                                  02460022
024700*----------------------------------------------------------------*02470099
024800* DB2 SQL ERROR MESSAGE FORMAT AREA                               02480023
024900*----------------------------------------------------------------*02490099
025000                                                                  02500023
025100     COPY DPWS004.                                                02510001
025200                                                                  02520022
025300*----------------------------------------------------------------*02530099
025400* INVOICE AND IMPORT EXPENSE INVOICES FILE LAYOUT                 02540021
025500*----------------------------------------------------------------*02550099
025600                                                                  02560023
025700     COPY APRD016.                                                02570004
025800                                                                  02580022
025900*----------------------------------------------------------------*02590099
026000* ADJUSTMENT JOURNAL DETAIL TRANSACTION RESULTS FILE LAYOUT       02600004
026100*----------------------------------------------------------------*02610099
026200                                                                  02620023
026300     COPY APRD045.                                                02630004
026400                                                                  02640021
026500*----------------------------------------------------------------*02650099
026600* INVOICE TABLE                                                   02660001
026700*----------------------------------------------------------------*02670099
026800                                                                  02680023
026900     EXEC SQL                                                     02690001
027000         INCLUDE TINVOIC                                          02700001
027100     END-EXEC.                                                    02710001
027200                                                                  02720010
027300*----------------------------------------------------------------*02730099
027400* PURCHASE ORDER TABLE                                            02740021
027500*----------------------------------------------------------------*02750099
027600                                                                  02760023
027700     EXEC SQL                                                     02770001
027800         INCLUDE TPURCHS                                          02780021
027900     END-EXEC.                                                    02790001
028000                                                                  02800010
028100*----------------------------------------------------------------*02810099
028200* TRANSACTION CODE TABLE                                          02820021
028300*----------------------------------------------------------------*02830099
028400                                                                  02840023
028500     EXEC SQL                                                     02850001
028600         INCLUDE TTRNCDE                                          02860021
028700     END-EXEC.                                                    02870001
028800                                                                  02880010
028900*----------------------------------------------------------------*02890099
029000* EXTERNAL ENTERPRISE TABLE                                       02900021
029100*----------------------------------------------------------------*02910099
029200                                                                  02920023
029300     EXEC SQL                                                     02930001
029400         INCLUDE TEXTENT                                          02940021
029500     END-EXEC.                                                    02950001
029600                                                                  02960010
029700*----------------------------------------------------------------*02970099
029800* EXTERNAL ENTERPRISE NAME TABLE                                  02980021
029900*----------------------------------------------------------------*02990099
030000                                                                  03000023
030100     EXEC SQL                                                     03010021
030200         INCLUDE TENTNME                                          03020021
030300     END-EXEC.                                                    03030021
030400                                                                  03040021
030500*----------------------------------------------------------------*03050099
030600* PURCHASE ORDER ITEM TABLE                                       03060021
030700*----------------------------------------------------------------*03070099
030800                                                                  03080023
030900     EXEC SQL                                                     03090021
031000         INCLUDE TPURITM                                          03100021
031100     END-EXEC.                                                    03110021
031200                                                                  03120021
031300*----------------------------------------------------------------*03130099
031400* ACCOUNTS PAYABLE CONTROL TABLE                                  03140021
031500*----------------------------------------------------------------*03150099
031600                                                                  03160023
031700     EXEC SQL                                                     03170021
031800         INCLUDE TAPCNTL                                          03180021
031900     END-EXEC.                                                    03190021
032000                                                                  03200021
032100*----------------------------------------------------------------*03210099
032200* DB2 COMMUNICATION AREA                                          03220001
032300*----------------------------------------------------------------*03230099
032400                                                                  03240022
032500     EXEC SQL                                                     03250001
032600         INCLUDE SQLCA                                            03260001
032700     END-EXEC.                                                    03270001
032800                                                                  03280010
032900*----------------------------------------------------------------*03290099
033000* DB2 COMMUNICATION AREA2                                         03300001
033100*----------------------------------------------------------------*03310099
033200                                                                  03320022
033300     COPY SQLCA2.                                                 03330001
033400                                                                  03340010
033500*----------------------------------------------------------------*03350099
033600*  INVOICE CURSOR SELECTS THE AP PROCESS CODE AND COUNTS HOW      03360017
033700*  MANY RECORDS ARE EITHER 'J' (FOR JOURNALIZED RECORDS) OR ' '   03370017
033800*  (FOR UNJOURNALIZED RECORDS).                                   03380017
033900*----------------------------------------------------------------*03390099
034000                                                                  03400023
034100     EXEC SQL                                                     03410001
034200       DECLARE INVOIC_CSR CURSOR FOR                              03420001
034300         SELECT   AP_PRC_CDE                                      03430099
034400                , COUNT(*)                                        03440017
034500         FROM     TINVOIC                                         03450099
034600         WHERE    PO_NBR = :AP016-PO-NBR                          03460099
034700                  AND STATUS_CDE <> 'DE'                          03470099
034800         GROUP BY AP_PRC_CDE                                      03480099
034900     END-EXEC.                                                    03490001
035000                                                                  03500010
035100*----------------------------------------------------------------*03510099
035200*  TRAN INFO CURSOR SELECTS THE POSTING TYPE CODE, THE            03520078
035300*  TRANSACTION TYPE CODE, AND THE TRANCODE FROM THE TTRNCDE TABLE.03530078
035400*  IT ONLY SELECTS THE POSTING TYPE CODES AND THE TRANSACTION     03540078
035500*  TYPE CODES IF THE TRANCODE IS A '38','44','5C' OR '78'.        03550099
035600*----------------------------------------------------------------*03560099
035700                                                                  03570077
035800     EXEC SQL                                                     03580077
035900       DECLARE TRANCODE_CSR CURSOR FOR                            03590099
036000         SELECT   PSTG_TYP_CDE                                    03600078
036100                , TRN_TYP_CDE                                     03610078
036200                , AP_TRN_CDE                                      03620078
036300         FROM     TTRNCDE                                         03630078
036400         WHERE    AP_TRN_CDE IN ('38','44','78','3A','5C'         03640099
036500                                ,'3B','3C','3D','3E')             03650099
036600           AND CURRENT DATE  BETWEEN EFF_STRT_DTE AND             03660099
036700                                     EFF_END_DTE                  03670099
036800     END-EXEC.                                                    03680077
036900                                                                  03690077
037000 PROCEDURE DIVISION.                                              03700001
037100                                                                  03710075
037200 A100-PROGRAM-MAINLINE.                                           03720010
037300                                                                  03730001
037400     PERFORM B100-HOUSEKEEPING.                                   03740010
037500                                                                  03750001
037600     PERFORM B200-PROCESS-INVOICE-REC                             03760074
037700         UNTIL INVOICE-EOF.                                       03770001
037800                                                                  03780001
037900     PERFORM B300-END-OF-JOB.                                     03790074
038000                                                                  03800001
038100     GOBACK.                                                      03810001
038200                                                                  03820022
038300*----------------------------------------------------------------*03830099
038400*  B100-HOUSEKEEPING  OPEN FILES, INITIALIZE THE NECESSARY        03840017
038500*  FIELDS, PROCESS THE INVOICE FILE FOR THE FIRST RECORD, AND     03850017
038600*  OPENS THE CURSOR FOR THE FIRST RECORD.                         03860017
038700*----------------------------------------------------------------*03870099
038800                                                                  03880042
038900 B100-HOUSEKEEPING.                                               03890010
039000                                                                  03900001
039100     OPEN INPUT  EDITED-EXP-INV-FILE                              03910099
039200          OUTPUT INVOICE-LOAD-FILE                                03920099
039300                 ADJUST-JRNL-FILE.                                03930099
039400                                                                  03940014
039500     INITIALIZE AP016-INVOICE-LOAD-RECORD                         03950014
039600                AP045-TRANSACTION-FILE.                           03960014
039700                                                                  03970022
039800     PERFORM S400-SELECT-DATES.                                   03980017
039900     PERFORM S500-SET-CURRENT-TMST.                               03990084
040000                                                                  04000001
040100     SET PV-TRAN-IDX TO 1.                                        04010080
040200                                                                  04020096
040300     PERFORM Y300-OPEN-TRANCODE-CSR.                              04030099
040400     PERFORM R300-FETCH-TRANCODE-CSR.                             04040099
040500                                                                  04050099
040600     PERFORM UNTIL END-OF-TRANCODE-CSR                            04060099
040700       OR PV-TRAN-IDX > 10                                        04070099
040800          MOVE TRNCDE-AP-TRN-CDE TO PV-AP-TRN-CDE(PV-TRAN-IDX)    04080099
040900          MOVE TRNCDE-PSTG-TYP-CDE TO PV-PSTG-TYP-CDE(PV-TRAN-IDX)04090099
041000          MOVE TRNCDE-TRN-TYP-CDE TO PV-TRN-TYP-CDE(PV-TRAN-IDX)  04100099
041100          SET PV-TRAN-IDX UP BY 1                                 04110099
041200          PERFORM R300-FETCH-TRANCODE-CSR                         04120099
041300     END-PERFORM.                                                 04130099
041400                                                                  04140096
041500     IF PV-TRAN-IDX > 10                                          04150099
041600        SET AP-TABLE-FULL TO TRUE                                 04160099
041700        MOVE 'B100-HOUSEKEEPING ' TO WS-ABEND-PARAGRAPH           04170099
041800        MOVE 'OVERFLOW ON TRANCODE TABLE ' TO WS-MESSAGE-1        04180099
041900        MOVE 'MORE TRANCODES SELECTED THAN OCCURS IN ARRAY'       04190099
042000                                  TO WS-MESSAGE-2                 04200099
042100        PERFORM Z998-ABEND                                        04210099
042200     END-IF.                                                      04220099
042300                                                                  04230099
042400     PERFORM Y400-CLOSE-TRANCODE-CSR.                             04240099
042500                                                                  04250099
042600     PERFORM R100-READ-EDITED-EXP-INV-FILE.                       04260099
042700                                                                  04270022
042800*---------------------------------------------------------------* 04280099
042900*  B200-PROCESS-INVOICE-REC                                     * 04290099
043000*  PROCESSES RECORDS FROM THE INVOICE FILE.                     * 04300099
043100*---------------------------------------------------------------* 04310099
043200                                                                  04320075
043300 B200-PROCESS-INVOICE-REC.                                        04330075
043400                                                                  04340099
043500     IF (AP016-PO-NBR NOT = PV-PREV-PO-NBR) OR                    04350099
043600        (AP016-REMIT-TO-DUN-NBR NOT = PV-PREV-REMIT-TO-DUN-NBR)   04360099
043700        MOVE AP016-PO-NBR TO PV-PREV-PO-NBR                       04370075
043800        MOVE AP016-REMIT-TO-DUN-NBR TO PV-PREV-REMIT-TO-DUN-NBR   04380099
043900        PERFORM C100-SET-OUTPUT-DESTINATION                       04390099
044000        IF PS-OUTPUT-ADJUST                                       04400099
044100           PERFORM S100-SELECT-DEPT                               04410099
044200           PERFORM S200-SELECT-CLASS-NBR                          04420099
044300           PERFORM S300-SELECT-ENT-ID                             04430099
044400        END-IF                                                    04440099
044500     END-IF.                                                      04450099
044600                                                                  04460099
044700     PERFORM C200-PROCESS-OUTPUT-RECORDS.                         04470099
044800                                                                  04480099
044900     PERFORM R100-READ-EDITED-EXP-INV-FILE.                       04490099
045000                                                                  04500099
045100*---------------------------------------------------------------* 04510099
045200*  B300-END-OF-JOB  CLOSES THE INPUT FILE AND THE TWO OUTPUT      04520099
045300*  FILES.                                                         04530099
045400*---------------------------------------------------------------* 04540099
045500                                                                  04550099
045600 B300-END-OF-JOB.                                                 04560099
045700                                                                  04570099
045800     CLOSE EDITED-EXP-INV-FILE                                    04580099
045900           INVOICE-LOAD-FILE                                      04590099
046000           ADJUST-JRNL-FILE.                                      04600099
046100                                                                  04610099
046200     DISPLAY 'INVOICE RECORDS READ = ' INPUT-COUNT.               04620099
046300     DISPLAY 'INVOICE LOAD RECORDS WRITTEN = ' OUT-INVOICE-COUNT. 04630099
046400     DISPLAY 'ADJUSTMENT RECORDS WRITTEN = ' OUT-ADJUSTMENT-COUNT.04640099
046500                                                                  04650099
046600*----------------------------------------------------------------*04660099
046700*  C100-SET-OUTPUT-DESTINATION OPENS THE INVOICE CURSOR AND      *04670099
046800*  FETCHES THROUGH IT UNTIL END.  BASED ON WHAT DATA IS OR IS    *04680099
046900*  NOT FOUND ON THE CURSOR, SWITCHES ARE SET TO SHOW WHICH FILE  *04690099
047000*  THE INVOICES FOR THIS PO BELONG ON - THE INVOICE LOAD OR THE  *04700099
047100*  ADJUSTMENT FILE.  IF NO INVOICES ARE FOUND, OR ANY OF THE     *04710099
047200*  INVOICE FOUND HAVE NOT BEEN PROCESSED (AP-PRC-CDE = ' '),     *04720099
047300*  THE INVOICES GO ON THE INVOICE LOAD FILE.  IF ALL OF THE      *04730099
047400*  INVOICES FOUND HAVE BEEN PROCESSED (AP-PRC-CDE = 'J') THEN    *04740099
047500*  THE INVOICES (EXCEPT THOSE IN PENDING REVIEW STATUS) WILL BE  *04750099
047600*  CONVERTED INTO ADJUSTMENT RECORDS.                            *04760099
047700*----------------------------------------------------------------*04770099
047800                                                                  04780099
047900 C100-SET-OUTPUT-DESTINATION.                                     04790099
048000                                                                  04800099
048100     INITIALIZE COUNT-INVOIC-ROWS                                 04810099
048200                INVOICE-CURSOR-SW                                 04820099
048300                PS-EMPTY-INVOIC-CSR                               04830099
048400                AP-PRC-J-COUNT                                    04840099
048500                AP-PRC-SPACE-COUNT                                04850099
048600                PS-OUTPUT-IND.                                    04860099
048700                                                                  04870099
048800     PERFORM Y100-OPEN-INVOIC-CSR.                                04880099
048900                                                                  04890099
049000     PERFORM R200-FETCH-INVOIC-CSR.                               04900099
049100                                                                  04910099
049200     IF END-OF-INVOICE-CSR                                        04920099
049300        SET EMPTY-INVOIC-CSR TO TRUE                              04930099
049400     ELSE                                                         04940099
049500        PERFORM UNTIL END-OF-INVOICE-CSR                          04950099
049600          EVALUATE INVOIC-AP-PRC-CDE                              04960099
049700            WHEN 'J'                                              04970099
049800              MOVE COUNT-INVOIC-ROWS TO AP-PRC-J-COUNT            04980099
049900            WHEN ' '                                              04990099
050000              MOVE COUNT-INVOIC-ROWS TO AP-PRC-SPACE-COUNT        05000099
050100            WHEN OTHER                                            05010099
050200              ADD  COUNT-INVOIC-ROWS TO AP-PRC-J-COUNT            05020099
050300          END-EVALUATE                                            05030099
050400          PERFORM R200-FETCH-INVOIC-CSR                           05040099
050500        END-PERFORM                                               05050099
050600     END-IF.                                                      05060099
050700                                                                  05070099
050800     PERFORM Y200-CLOSE-INVOIC-CSR.                               05080099
050900                                                                  05090099
051000     IF EMPTY-INVOIC-CSR                                          05100099
051100     OR AP-PRC-SPACE-COUNT > 0                                    05110099
051200        SET PS-OUTPUT-INVOICE TO TRUE                             05120099
051300     ELSE                                                         05130099
051400        IF AP-PRC-SPACE-COUNT = 0                                 05140099
051500        AND AP-PRC-J-COUNT > 0                                    05150099
051600           SET PS-OUTPUT-ADJUST TO TRUE                           05160099
051700        END-IF                                                    05170099
051800     END-IF.                                                      05180099
051900                                                                  05190099
052000                                                                  05200099
052100*---------------------------------------------------------------* 05210099
052200*  C200-PROCESS-OUTPUT-RECORDS                                  * 05220099
052300*  CHECKS THE OUTPUT DESTINATION FLAG AND OTHER INFORMATION TO  * 05230099
052400*  ENSURE THAT THE RECORD(S) ARE WRITTEN TO THE CORRECT FILE.   * 05240099
052500*  WHEN THE STATUS CODE ON AN INPUT RECORD IS 'PR', THE RECORD  * 05250099
052600*  WILL BE WRITTEN TO THE INVOICE-LOAD FILE EVEN IF THE OUTPUT  * 05260099
052700*  DESTINATION FOR THAT PO WAS DETERMINED TO BE 'ADJUSTMENT'.   * 05270099
052800*                                                               * 05280099
052900*  IF ADJUSTMENTS ARE BEING WRITTEN, EXAMINE EACH NEW TOTAL     * 05290099
053000*  FIELD FOR CHARGES AND CREATE THE APPROPRIATE TRAN CODE FOR   * 05300099
053100*  THE ADJUSTMENTS.                                             * 05310099
053200*---------------------------------------------------------------* 05320099
053300                                                                  05330099
053400 C200-PROCESS-OUTPUT-RECORDS.                                     05340099
053500                                                                  05350099
053600     IF PS-OUTPUT-INVOICE                                         05360099
053700     OR AP016-STATUS-CDE = 'PR'                                   05370099
053800        PERFORM W100-WRITE-INVOICE-LOAD-RECD                      05380099
053900     ELSE                                                         05390099
054000        IF PS-OUTPUT-ADJUST                                       05400099
054100****       IF AP016-REMIT-TO-DUN-NBR = PV-EXPEDITORS              05410099
054200****          IF PV-NONDUTY-TOTAL > 0                             05420099
054300              PERFORM D100-ACCUM-CHARGES                          05430099
054400              IF PV-MISC-TOTAL > 0                                05440099
054500                  MOVE '38'       TO PV-HOLD-TRANCODE             05450099
054600                  MOVE PV-MISC-TOTAL TO PV-NET-COST               05460099
054700                  PERFORM D200-FORMAT-ADJJRNL-RECORD              05470099
054800                  PERFORM W200-WRITE-OUTPUT-JRNL-REC              05480099
054900              END-IF                                              05490099
055000              IF PV-OCNAIR-FRGT-TOTAL > 0                         05500099
055100                  MOVE '3A'       TO PV-HOLD-TRANCODE             05510099
055200                  MOVE PV-OCNAIR-FRGT-TOTAL TO PV-NET-COST        05520099
055300                  PERFORM D200-FORMAT-ADJJRNL-RECORD              05530099
055400                  PERFORM W200-WRITE-OUTPUT-JRNL-REC              05540099
055500              END-IF                                              05550099
055600              IF PV-ROYAL-COMM-TOTAL > 0                          05560099
055700                  MOVE '3B'       TO PV-HOLD-TRANCODE             05570099
055800                  MOVE PV-ROYAL-COMM-TOTAL TO PV-NET-COST         05580099
055900                  PERFORM D200-FORMAT-ADJJRNL-RECORD              05590099
056000                  PERFORM W200-WRITE-OUTPUT-JRNL-REC              05600099
056100              END-IF                                              05610099
056200              IF PV-DRAY-DECON-TOTAL > 0                          05620099
056300                  MOVE '3C'       TO PV-HOLD-TRANCODE             05630099
056400                  MOVE PV-DRAY-DECON-TOTAL TO PV-NET-COST         05640099
056500                  PERFORM D200-FORMAT-ADJJRNL-RECORD              05650099
056600                  PERFORM W200-WRITE-OUTPUT-JRNL-REC              05660099
056700              END-IF                                              05670099
056800              IF PV-BROKR-CHG-TOTAL > 0                           05680099
056900                  MOVE '3D'       TO PV-HOLD-TRANCODE             05690099
057000                  MOVE PV-BROKR-CHG-TOTAL TO PV-NET-COST          05700099
057100                  PERFORM D200-FORMAT-ADJJRNL-RECORD              05710099
057200                  PERFORM W200-WRITE-OUTPUT-JRNL-REC              05720099
057300              END-IF                                              05730099
057400              IF PV-OVSEA-CONS-TOTAL > 0                          05740099
057500                  MOVE '3E'       TO PV-HOLD-TRANCODE             05750099
057600                  MOVE PV-OVSEA-CONS-TOTAL TO PV-NET-COST         05760099
057700                  PERFORM D200-FORMAT-ADJJRNL-RECORD              05770099
057800                  PERFORM W200-WRITE-OUTPUT-JRNL-REC              05780099
057900              END-IF                                              05790099
058000              IF PV-DUTY-TOTAL > 0                                05800099
058100                 MOVE '44' TO PV-HOLD-TRANCODE                    05810099
058200                 MOVE PV-DUTY-TOTAL TO PV-NET-COST                05820099
058300                 PERFORM D200-FORMAT-ADJJRNL-RECORD               05830099
058400                 PERFORM W200-WRITE-OUTPUT-JRNL-REC               05840099
058500                                                                  05850099
058600                 MOVE '78' TO PV-HOLD-TRANCODE                    05860099
058700                 MULTIPLY -1 BY PV-DUTY-TOTAL                     05870099
058800                     GIVING PV-RVRS-CHRG-AMT                      05880099
058900                 MOVE PV-RVRS-CHRG-AMT TO PV-NET-COST             05890099
059000                 PERFORM D200-FORMAT-ADJJRNL-RECORD               05900099
059100                 PERFORM W200-WRITE-OUTPUT-JRNL-REC               05910099
059200              END-IF                                              05920099
059210              IF PV-MPF-TOTAL > 0                                 05921099
059220                 MOVE '5C' TO PV-HOLD-TRANCODE                    05922099
059230                 MOVE PV-MPF-TOTAL TO PV-NET-COST                 05923099
059240                 PERFORM D200-FORMAT-ADJJRNL-RECORD               05924099
059250                 PERFORM W200-WRITE-OUTPUT-JRNL-REC               05925099
059260              END-IF                                              05926099
059300****       ELSE                                                   05930099
059400****           MOVE '38' TO PV-HOLD-TRANCODE                      05940099
059500****           MOVE AP016-INVC-NET-COST-AMT TO PV-NET-COST        05950099
059600****           PERFORM D200-FORMAT-ADJJRNL-RECORD                 05960099
059700****           PERFORM W200-WRITE-OUTPUT-JRNL-REC                 05970099
059800****       END-IF                                                 05980099
059900        END-IF                                                    05990099
060000     END-IF.                                                      06000099
060100                                                                  06010099
060200*----------------------------------------------------------------*06020099
060300* D100-ACCUM-CHARGES                                             *06030099
060400*  READS THE CHARGE CODES AND AMOUNTS IN THE TABLE.  LOGIC       *06040099
060500*  ACCUMULATES CHARGES SEPARATELY BASED ON THE VALUE OF THE      *06050099
060600*  CHARGE CODE.                                                  *06060099
060700*----------------------------------------------------------------*06070099
060800 D100-ACCUM-CHARGES.                                              06080099
060900                                                                  06090099
061000     INITIALIZE PV-DUTY-TOTAL                                     06100099
061100***             PV-NONDUTY-TOTAL                                  06110099
061200                PV-OCNAIR-FRGT-TOTAL                              06120099
061300                PV-ROYAL-COMM-TOTAL                               06130099
061400                PV-DRAY-DECON-TOTAL                               06140099
061500                PV-BROKR-CHG-TOTAL                                06150099
061600                PV-OVSEA-CONS-TOTAL                               06160099
061700                PV-MISC-TOTAL                                     06170099
061710                PV-MPF-TOTAL                                      06171099
061800                PV-RVRS-CHRG-AMT.                                 06180099
061900                                                                  06190099
062000     PERFORM VARYING TALCHRG-INDEX FROM 1 BY 1                    06200099
062100       UNTIL TALCHRG-INDEX > 20                                   06210099
062200          OR AP016-ALW-CHRG-CDE(TALCHRG-INDEX) = SPACES           06220099
062300****         IF AP016-ALW-CHRG-CDE(TALCHRG-INDEX) = 'DUT'         06230099
062400             EVALUATE TRUE                                        06240099
062500               WHEN AP016-ALW-CHRG-CDE(TALCHRG-INDEX) = 'DUT'     06250099
062600                      ADD AP016-ALW-CHRG-AMT(TALCHRG-INDEX)       06260099
062700                                         TO PV-DUTY-TOTAL         06270099
062800               WHEN AP016-ALW-CHRG-CDE(TALCHRG-INDEX) = 'OAF'     06280099
062900                      ADD AP016-ALW-CHRG-AMT(TALCHRG-INDEX)       06290099
063000                                         TO PV-OCNAIR-FRGT-TOTAL  06300099
063100               WHEN AP016-ALW-CHRG-CDE(TALCHRG-INDEX) = 'IAC' OR  06310099
063200                    'LCC' OR 'ROY'                                06320099
063300                      ADD AP016-ALW-CHRG-AMT(TALCHRG-INDEX)       06330099
063400                                         TO PV-ROYAL-COMM-TOTAL   06340099
063500               WHEN AP016-ALW-CHRG-CDE(TALCHRG-INDEX) = 'DDF' OR  06350099
063600                    'DRA'                                         06360099
063700                      ADD AP016-ALW-CHRG-AMT(TALCHRG-INDEX)       06370099
063800                                         TO PV-DRAY-DECON-TOTAL   06380099
063900               WHEN AP016-ALW-CHRG-CDE(TALCHRG-INDEX) = 'DUP' OR  06390099
064000                    'EIC' OR 'ENT'                                06400099
064100                      ADD AP016-ALW-CHRG-AMT(TALCHRG-INDEX)       06410099
064200                                         TO PV-BROKR-CHG-TOTAL    06420099
064300               WHEN AP016-ALW-CHRG-CDE(TALCHRG-INDEX) = 'OCF'     06430099
064400                      ADD AP016-ALW-CHRG-AMT(TALCHRG-INDEX)       06440099
064500                                         TO PV-OVSEA-CONS-TOTAL   06450099
064510               WHEN AP016-ALW-CHRG-CDE(TALCHRG-INDEX) = 'BSS'     06451099
064520                      ADD AP016-ALW-CHRG-AMT(TALCHRG-INDEX)       06452099
064530                                         TO PV-MPF-TOTAL          06453099
064600               WHEN OTHER                                         06460099
064700                      ADD AP016-ALW-CHRG-AMT(TALCHRG-INDEX)       06470099
064800                                         TO PV-MISC-TOTAL         06480099
064900             END-EVALUATE                                         06490099
065000****         END-IF                                               06500099
065100     END-PERFORM.                                                 06510099
065200                                                                  06520099
065300                                                                  06530099
065400*----------------------------------------------------------------*06540099
065500*  D200-FORMAT-ADJJRNL-RECORD                                    *06550099
065600*  POPULATES THE KEY, COMMON AND DETAIL FIELDS IN THE APRD045    *06560099
065700*  COPYBOOK.                                                     *06570099
065800*----------------------------------------------------------------*06580099
065900                                                                  06590099
066000 D200-FORMAT-ADJJRNL-RECORD.                                      06600099
066100                                                                  06610099
066200     INITIALIZE AP045-KEY-FIELDS                                  06620099
066300                AP045-COMMON-FIELDS                               06630099
066400                AP045-DETAIL-FIELDS.                              06640099
066500                                                                  06650099
066600     PERFORM VARYING PV-TRAN-IDX FROM 1 BY 1                      06660099
066700       UNTIL PV-AP-TRN-CDE(PV-TRAN-IDX) = PV-HOLD-TRANCODE        06670099
066800          OR PV-TRAN-IDX > 10                                     06680099
066900     END-PERFORM.                                                 06690099
067000                                                                  06700099
067100     IF PV-TRAN-IDX > 10                                          06710099
067200        SET AP-TABLE-NOTFND TO TRUE                               06720099
067300        DISPLAY 'TRANCODE BEING PROCESSED = ' PV-HOLD-TRANCODE    06730099
067400        MOVE 'D200-FORMAT-ADJJRNL-RECORD' TO WS-ABEND-PARAGRAPH   06740099
067500        MOVE 'ENTRY NOT FOUND ON TRANCODE TABLE' TO WS-MESSAGE-1  06750099
067600        PERFORM Z998-ABEND                                        06760099
067700     END-IF.                                                      06770099
067800                                                                  06780099
067900     IF PV-TRN-TYP-CDE(PV-TRAN-IDX) = 'MDS'                       06790099
068000        MOVE PURCHS-DEPT-NBR       TO AP045-DEPT-NBR              06800099
068100        MOVE PURITM-CL-NBR         TO PV-CL-NBR                   06810099
068200        IF PV-SEC-CL-NBR NOT = 0                                  06820099
068300           MOVE 0 TO PV-SEC-CL-NBR                                06830099
068400        END-IF                                                    06840099
068500        MOVE PV-CL-NBR             TO AP045-CL-NBR                06850099
068600        MOVE 85                    TO AP045-STR-NBR               06860099
068700     ELSE                                                         06870099
068800        MOVE '10375'               TO AP045-GL-ACCT-NBR           06880099
068900        MOVE 90                    TO AP045-STR-NBR               06890099
069000     END-IF.                                                      06900099
069100                                                                  06910099
069200     MOVE AP016-REMIT-TO-DUN-NBR   TO AP045-VND-NBR.              06920099
069300                                                                  06930099
069400     STRING AP016-INVC-ID DELIMITED BY ' '                        06940099
069500            '-' DELIMITED BY SIZE                                 06950099
069600            PV-HOLD-TRANCODE DELIMITED BY SIZE                    06960099
069700            INTO PV-INVC-ID.                                      06970099
069800                                                                  06980099
069900     MOVE LENGTH OF PV-INVC-ID   TO PV-START.                     06990099
070000     PERFORM                                                      07000099
070100         UNTIL PV-INVC-ID (PV-START:1) > SPACES OR                07010099
070200               PV-START = +0                                      07020099
070300         COMPUTE PV-START = PV-START - 1                          07030099
070400     END-PERFORM.                                                 07040099
070500     IF PV-START < 16                                             07050099
070600         MOVE +1 TO PV-START                                      07060099
070700     ELSE                                                         07070099
070800         SUBTRACT +15 FROM PV-START                               07080099
070900     END-IF.                                                      07090099
071000                                                                  07100099
071100     MOVE PV-INVC-ID(PV-START:16)  TO AP045-DOC-NBR.              07110099
071200***  MOVE AP016-INVC-ID            TO AP045-DOC-NBR.              07120099
071300     MOVE AP016-INVC-DTE           TO AP045-DOC-DTE.              07130099
071400                                                                  07140099
071500     SET  AP045-DETAIL-RECORD      TO TRUE.                       07150099
071600                                                                  07160099
071700     MOVE AP016-PO-NBR             TO AP045-PO-NBR.               07170099
071800     MOVE PV-TRN-TYP-CDE(PV-TRAN-IDX)                             07180099
071900                                   TO AP045-TRN-TYP-CDE.          07190099
072000     MOVE PV-PSTG-TYP-CDE(PV-TRAN-IDX)                            07200099
072100                                   TO AP045-PSTG-TYP-CDE.         07210099
072200     MOVE PV-HOLD-TRANCODE         TO AP045-AP-TRN-CDE.           07220099
072300     MOVE PV-CURR-TMST             TO AP045-ENTR-TMST.            07230099
072400     MOVE PV-ENTR-DTE              TO AP045-ENTR-DTE.             07240099
072500     MOVE 'APKUT223'               TO AP045-ENTR-ID.              07250099
072600     SET  AP045-ORGN-ADJUST        TO TRUE.                       07260099
072700     MOVE APCNTL-BTCH-PRC-DTE      TO AP045-INV-CUTOFF-DTE        07270099
072800                                      AP045-PS-BTCH-DTE.          07280099
072900     MOVE 'EDI'                    TO AP045-PS-BTCH-SRC-CDE.      07290099
073000     MOVE '00'                     TO AP045-PS-BTCH-SEQ-NBR.      07300099
073100                                                                  07310099
073200     MOVE EXTENT-ENT-ID            TO AP045-ENT-ID.               07320099
073300     MOVE ENTNME-ENT-NAME-DESC     TO AP045-ENT-NME-DESC.         07330099
073400                                                                  07340099
075300                                                                  07530099
075310     MOVE SPACES TO AP045-RSN-TXT.                                07531099
075320     MOVE +1 TO PV-COMM-POS.                                      07532099
075330                                                                  07533099
075340     IF AP016-CONTAINER-NBR NOT = SPACES                          07534099
075350         MOVE 'CONTAINER: ' TO AP045-RSN-TXT(PV-COMM-POS:11)      07535099
075360         ADD +11 TO PV-COMM-POS                                   07536099
075370         MOVE AP016-CONTAINER-NBR TO                              07537099
075380                        AP045-RSN-TXT(PV-COMM-POS:12)             07538099
075390         ADD +13 TO PV-COMM-POS                                   07539099
075391     END-IF.                                                      07539199
075392                                                                  07539299
075393     IF AP016-IMPRT-BOL-ID NOT = SPACES                           07539399
075394         MOVE 'BOL: ' TO AP045-RSN-TXT(PV-COMM-POS:5)             07539499
075395         ADD +5 TO PV-COMM-POS                                    07539599
075396         MOVE AP016-IMPRT-BOL-ID TO                               07539699
075397                        AP045-RSN-TXT(PV-COMM-POS:30)             07539799
075398         ADD +31 TO PV-COMM-POS                                   07539899
075399     END-IF.                                                      07539999
075400                                                                  07540099
075401     IF AP016-IMPRT-ENTR-NBR NOT = SPACES                         07540199
075402         MOVE 'ENT NBR: ' TO AP045-RSN-TXT(PV-COMM-POS:9)         07540299
075403         ADD +9 TO PV-COMM-POS                                    07540399
075404         MOVE AP016-IMPRT-ENTR-NBR TO                             07540499
075405                        AP045-RSN-TXT(PV-COMM-POS:16)             07540599
075406         ADD +17 TO PV-COMM-POS                                   07540699
075407     END-IF.                                                      07540799
075408                                                                  07540899
075409     IF AP016-BKR-REF-NBR NOT = SPACES                            07540999
075410         MOVE 'REF NBR: ' TO AP045-RSN-TXT(PV-COMM-POS:9)         07541099
075411         ADD +9 TO PV-COMM-POS                                    07541199
075412         MOVE AP016-BKR-REF-NBR TO                                07541299
075413                        AP045-RSN-TXT(PV-COMM-POS:15)             07541399
075414         ADD +16 TO PV-COMM-POS                                   07541499
075415     END-IF.                                                      07541599
075416                                                                  07541699
075420     MOVE APCNTL-CURR-PSTG-FYR-NBR TO AP045-PSTG-FYR-NBR.         07542099
075500     MOVE APCNTL-CURR-PSTG-FMN-NBR TO AP045-PSTG-FMN-NBR.         07550099
075600     MOVE APCNTL-CURR-PSTG-FWK-NBR TO AP045-PSTG-FWK-NBR.         07560099
075700     MOVE PV-NET-COST              TO AP045-GRO-COST-AMT.         07570099
075800     MOVE PV-NET-COST              TO AP045-NET-COST-AMT.         07580099
075900                                                                  07590099
076000     INITIALIZE PV-HOLD-TRANCODE                                  07600099
076100                PV-INVC-ID                                        07610099
076200                PV-START                                          07620099
076300                PV-NET-COST.                                      07630099
076400                                                                  07640099
076500*----------------------------------------------------------------*07650099
076600*  R100-READ-EDITED-EXP-INV-FILE                                 *07660099
076700*  READS THE INPUT INVOICE FILE INTO THE APRD016 COPY BOOK.      *07670099
076800*----------------------------------------------------------------*07680099
076900                                                                  07690099
077000 R100-READ-EDITED-EXP-INV-FILE.                                   07700099
077100                                                                  07710099
077200     READ EDITED-EXP-INV-FILE INTO AP016-INVOICE-LOAD-RECORD      07720099
077300         AT END                                                   07730099
077400            SET INVOICE-EOF TO TRUE.                              07740099
077500                                                                  07750099
077600     IF NOT INVOICE-EOF                                           07760099
077700        ADD 1 TO INPUT-COUNT                                      07770099
077800     END-IF.                                                      07780099
077900                                                                  07790099
078000*----------------------------------------------------------------*07800099
078100*  R200-FETCH-INVOIC-CSR                                         *07810099
078200*  FETCHES ROWS FROM THE INVOICE CURSOR.                         *07820099
078300*----------------------------------------------------------------*07830099
078400                                                                  07840099
078500 R200-FETCH-INVOIC-CSR.                                           07850099
078600                                                                  07860099
078700     EXEC SQL                                                     07870099
078800        FETCH INVOIC_CSR                                          07880099
078900         INTO :INVOIC-AP-PRC-CDE                                  07890099
079000            , :COUNT-INVOIC-ROWS                                  07900099
079100     END-EXEC.                                                    07910099
079200                                                                  07920099
079300     EVALUATE TRUE                                                07930099
079400         WHEN SQLCODE = +0                                        07940099
079500              CONTINUE                                            07950099
079600         WHEN SQLCODE = +100                                      07960099
079700              SET END-OF-INVOICE-CSR TO TRUE                      07970099
079800         WHEN OTHER                                               07980099
079900              MOVE 'R200-FETCH-INVOIC-CSR' TO WS-ABEND-PARAGRAPH  07990099
080000              MOVE 'UNSUCCESSFUL FETCH ON INVOIC_CSR'             08000099
080100                                           TO WS-ABEND-OPERATION  08010099
080200              MOVE 'TINVOIC'               TO WS-ABEND-STRUCTURE-108020099
080300              PERFORM Z999-SQL-ERROR                              08030099
080400     END-EVALUATE.                                                08040099
080500                                                                  08050099
080600*----------------------------------------------------------------*08060099
080700*  R300-FETCH-TRANCODE-CSR                                       *08070099
080800*  FETCHES ROWS FROM THE TRANCODE CURSOR.                        *08080099
080900*----------------------------------------------------------------*08090099
081000                                                                  08100099
081100 R300-FETCH-TRANCODE-CSR.                                         08110099
081200                                                                  08120099
081300                                                                  08130099
081400     EXEC SQL                                                     08140099
081500         FETCH TRANCODE_CSR                                       08150099
081600         INTO  :TRNCDE-PSTG-TYP-CDE                               08160099
081700             , :TRNCDE-TRN-TYP-CDE                                08170099
081800             , :TRNCDE-AP-TRN-CDE                                 08180099
081900     END-EXEC                                                     08190099
082000                                                                  08200099
082100     EVALUATE TRUE                                                08210099
082200         WHEN SQLCODE = +0                                        08220099
082300              CONTINUE                                            08230099
082400         WHEN SQLCODE = +100                                      08240099
082500              SET END-OF-TRANCODE-CSR TO TRUE                     08250099
082600         WHEN OTHER                                               08260099
082700              MOVE 'R300-FETCH-TRANCODE-CSR' TO WS-ABEND-PARAGRAPH08270099
082800              MOVE 'UNSUCCESSFUL FETCH WITH TRANCODE_CSR'         08280099
082900                                          TO WS-ABEND-OPERATION   08290099
083000              MOVE 'TTRNCDE'              TO WS-ABEND-STRUCTURE-1 08300099
083100              MOVE SPACES                 TO WS-ABEND-STRUCTURE-2 08310099
083200              PERFORM Z999-SQL-ERROR                              08320099
083300     END-EVALUATE.                                                08330099
083400                                                                  08340099
083500                                                                  08350099
083600*----------------------------------------------------------------*08360099
083700*  S100-SELECT-DEPT                                              *08370099
083800*  SELECT THE DEPARTMENT NUMBER FROM THE TPURCHS TABLE FOR THE   *08380099
083900*  PO BEING PROCESSED.                                           *08390099
084000*----------------------------------------------------------------*08400099
084100                                                                  08410099
084200 S100-SELECT-DEPT.                                                08420099
084300                                                                  08430099
084400     PERFORM                                                      08440099
084500         WITH TEST AFTER                                          08450099
084600         VARYING WS-RETRY-COUNTER                                 08460099
084700         FROM 1 BY 1                                              08470099
084800         UNTIL ((WS-RETRY-COUNTER > WS-RETRY-MAX)                 08480099
084900               OR (SQLCODE = +0))                                 08490099
085000                                                                  08500099
085100          EXEC SQL                                                08510099
085200               SELECT DEPT_NBR                                    08520099
085300               INTO   :PURCHS-DEPT-NBR                            08530099
085400               FROM   TPURCHS                                     08540099
085500               WHERE  PO_NBR = :AP016-PO-NBR                      08550099
085600                      AND VER_STATUS_CDE = 'A'                    08560099
085700          END-EXEC                                                08570099
085800                                                                  08580099
085900          EVALUATE TRUE                                           08590099
086000              WHEN SQLCODE = +0                                   08600099
086100              WHEN SQLCODE = -904                                 08610099
086200              WHEN SQLCODE = -913                                 08620099
086300                   CONTINUE                                       08630099
086400                                                                  08640099
086500              WHEN SQLWARN0 NOT = SPACES                          08650099
086600              WHEN SQLCODE < +0                                   08660099
086700              WHEN SQLCODE > +0                                   08670099
086800                   MOVE 'S100-SELECT-DEPT'                        08680099
086900                                     TO WS-ABEND-PARAGRAPH        08690099
087000                   MOVE 'UNSUCCESSFUL SELECT DEPARTMENT'          08700099
087100                                     TO WS-ABEND-OPERATION        08710099
087200                   MOVE 'TPURCHS '   TO WS-ABEND-STRUCTURE-1      08720099
087300                   MOVE SPACES       TO WS-ABEND-STRUCTURE-2      08730099
087400                   PERFORM Z999-SQL-ERROR                         08740099
087500          END-EVALUATE                                            08750099
087600      END-PERFORM.                                                08760099
087700                                                                  08770099
087800      IF WS-RETRY-COUNTER > WS-RETRY-MAX                          08780099
087900         MOVE 'S100-SELECT-DEPT'                                  08790099
088000                               TO WS-ABEND-PARAGRAPH              08800099
088100         MOVE 'MAX RETRIES EXCEEDED ON SELECT DEPT'               08810099
088200                               TO WS-ABEND-OPERATION              08820099
088300         MOVE 'TPURCHS'        TO WS-ABEND-STRUCTURE-1            08830099
088400         MOVE SPACE            TO WS-ABEND-STRUCTURE-2            08840099
088500         PERFORM Z999-SQL-ERROR                                   08850099
088600      END-IF.                                                     08860099
088700                                                                  08870099
088800*----------------------------------------------------------------*08880099
088900*  S200-SELECT-CLASS-NBR                                         *08890099
089000*  SELECTS THE CLASS NUMBER FROM THE TPURITM TABLE.              *08900099
089100*----------------------------------------------------------------*08910099
089200                                                                  08920099
089300 S200-SELECT-CLASS-NBR.                                           08930099
089400                                                                  08940099
089500     PERFORM                                                      08950099
089600         WITH TEST AFTER                                          08960099
089700         VARYING WS-RETRY-COUNTER                                 08970099
089800         FROM 1 BY 1                                              08980099
089900         UNTIL ((WS-RETRY-COUNTER > WS-RETRY-MAX)                 08990099
090000               OR (SQLCODE = +0)                                  09000099
090100               OR (SQLCODE = -811))                               09010099
090200                                                                  09020099
090300         EXEC SQL                                                 09030099
090400              SELECT DISTINCT(CL_NBR)                             09040099
090500              INTO   :PURITM-CL-NBR                               09050099
090600              FROM   TPURITM                                      09060099
090700              WHERE  PO_NBR = :AP016-PO-NBR                       09070099
090800                     AND VER_STATUS_CDE = 'A'                     09080099
090900         END-EXEC                                                 09090099
091000                                                                  09100099
091100         EVALUATE TRUE                                            09110099
091200             WHEN SQLCODE = +0                                    09120099
091300             WHEN SQLCODE = -811                                  09130099
091400                  CONTINUE                                        09140099
091500             WHEN SQLCODE = -904                                  09150099
091600             WHEN SQLCODE = -913                                  09160099
091700                  CONTINUE                                        09170099
091800                                                                  09180099
091900             WHEN SQLWARN0 NOT = SPACES                           09190099
092000             WHEN SQLCODE < +0                                    09200099
092100             WHEN SQLCODE > +0                                    09210099
092200                  MOVE 'S200-SELECT-CLASS-NBR'                    09220099
092300                                    TO WS-ABEND-PARAGRAPH         09230099
092400                  MOVE 'UNSUCCESSFUL SELECT CLASS INFO'           09240099
092500                                    TO WS-ABEND-OPERATION         09250099
092600                  MOVE 'TPURITM '   TO WS-ABEND-STRUCTURE-1       09260099
092700                  MOVE SPACES       TO WS-ABEND-STRUCTURE-2       09270099
092800                  PERFORM Z999-SQL-ERROR                          09280099
092900         END-EVALUATE                                             09290099
093000     END-PERFORM.                                                 09300099
093100                                                                  09310099
093200     IF WS-RETRY-COUNTER > WS-RETRY-MAX                           09320099
093300        MOVE 'S200-SELECT-DEPT'                                   09330099
093400                              TO WS-ABEND-PARAGRAPH               09340099
093500        MOVE 'MAX RETRIES EXCEEDED ON SELECT DEPT'                09350099
093600                              TO WS-ABEND-OPERATION               09360099
093700        MOVE 'TPURCHS'        TO WS-ABEND-STRUCTURE-1             09370099
093800        MOVE SPACE            TO WS-ABEND-STRUCTURE-2             09380099
093900        PERFORM Z999-SQL-ERROR                                    09390099
094000     END-IF.                                                      09400099
094100                                                                  09410099
094200*----------------------------------------------------------------*09420099
094300*  S300-SELECT-ENT-ID                                            *09430099
094400*  SELECT ENTITY ID AND THE ENTITY NAME DESCRIPTION FROM A JOIN  *09440099
094500*  OF TEXTENT AND TENTNME TABLES.                                *09450099
094600*----------------------------------------------------------------*09460099
094700                                                                  09470099
094800 S300-SELECT-ENT-ID.                                              09480099
094900                                                                  09490099
095000     PERFORM                                                      09500099
095100         WITH TEST AFTER                                          09510099
095200         VARYING WS-RETRY-COUNTER                                 09520099
095300         FROM 1 BY 1                                              09530099
095400         UNTIL ((WS-RETRY-COUNTER > WS-RETRY-MAX)                 09540099
095500               OR (SQLCODE = +0))                                 09550099
095600                                                                  09560099
095700         EXEC SQL                                                 09570099
095800              SELECT A.ENT_ID                                     09580099
095900                   , A.ENT_NAME_DESC                              09590099
096000              INTO   :EXTENT-ENT-ID                               09600099
096100                   , :ENTNME-ENT-NAME-DESC                        09610099
096200              FROM   TENTNME A                                    09620099
096300                   , TEXTENT B                                    09630099
096400              WHERE  A.ENT_ID = B.ENT_ID                          09640099
096500                     AND B.DUN_NBR = :AP016-REMIT-TO-DUN-NBR      09650099
096600                     AND A.TYPE_CDE = '01'                        09660099
096700         END-EXEC                                                 09670099
096800                                                                  09680099
096900         EVALUATE TRUE                                            09690099
097000             WHEN SQLCODE = +0                                    09700099
097100                  IF ENTNME-ENT-NAME-DESC = SPACE                 09710099
097200                     MOVE 'NO VENDOR PRIMARY NAME FOUND  '        09720099
097300                                   TO ENTNME-ENT-NAME-DESC        09730099
097400                  END-IF                                          09740099
097500             WHEN SQLCODE = -904                                  09750099
097600             WHEN SQLCODE = -913                                  09760099
097700                  CONTINUE                                        09770099
097800                                                                  09780099
097900             WHEN SQLWARN0 NOT = SPACES                           09790099
098000             WHEN SQLCODE < +0                                    09800099
098100             WHEN SQLCODE > +0                                    09810099
098200                  MOVE 'S300-SELECT-ENT-ID'                       09820099
098300                                    TO WS-ABEND-PARAGRAPH         09830099
098400                  MOVE 'UNSUCCESSFUL SELECT ENT ID'               09840099
098500                                    TO WS-ABEND-OPERATION         09850099
098600                  MOVE 'TEXTENT '   TO WS-ABEND-STRUCTURE-1       09860099
098700                  MOVE 'TENTNME '   TO WS-ABEND-STRUCTURE-2       09870099
098800                  PERFORM Z999-SQL-ERROR                          09880099
098900         END-EVALUATE                                             09890099
099000     END-PERFORM.                                                 09900099
099100                                                                  09910099
099200     IF WS-RETRY-COUNTER > WS-RETRY-MAX                           09920099
099300        MOVE 'S300-SELECT-ENT-ID'                                 09930099
099400                              TO WS-ABEND-PARAGRAPH               09940099
099500        MOVE 'MAX RETRIES EXCEEDED ON SELECT ENT ID'              09950099
099600                              TO WS-ABEND-OPERATION               09960099
099700        MOVE 'TEXTENT'        TO WS-ABEND-STRUCTURE-1             09970099
099800        MOVE 'TENTNME'        TO WS-ABEND-STRUCTURE-2             09980099
099900        PERFORM Z999-SQL-ERROR                                    09990099
100000     END-IF.                                                      10000099
100100                                                                  10010099
100200*----------------------------------------------------------------*10020099
100300*  S400-SELECT-DATES                                             *10030099
100400*  SELECT BATCH PROCESS DATE, CURRENT POSTING FISCAL YEAR,       *10040099
100500*  CURRENT POSTING FISCAL MONTH, AND CURRENT POSTING FISCAL WEEK *10050099
100600*  FROM THE TAPCNTL TABLE.                                       *10060099
100700*----------------------------------------------------------------*10070099
100800                                                                  10080099
100900 S400-SELECT-DATES.                                               10090099
101000                                                                  10100099
101100     PERFORM                                                      10110099
101200         WITH TEST AFTER                                          10120099
101300         VARYING WS-RETRY-COUNTER                                 10130099
101400         FROM 1 BY 1                                              10140099
101500         UNTIL ((WS-RETRY-COUNTER > WS-RETRY-MAX)                 10150099
101600               OR (SQLCODE = +0))                                 10160099
101700                                                                  10170099
101800         EXEC SQL                                                 10180099
101900              SELECT BTCH_PRC_DTE                                 10190099
102000                   , (BTCH_PRC_DTE + 1 DAY)                       10200099
102100                   , CURR_PSTG_FYR_NBR                            10210099
102200                   , CURR_PSTG_FMN_NBR                            10220099
102300                   , CURR_PSTG_FWK_NBR                            10230099
102400              INTO   :APCNTL-BTCH-PRC-DTE                         10240099
102500                   , :PV-ENTR-DTE                                 10250099
102600                   , :APCNTL-CURR-PSTG-FYR-NBR                    10260099
102700                   , :APCNTL-CURR-PSTG-FMN-NBR                    10270099
102800                   , :APCNTL-CURR-PSTG-FWK-NBR                    10280099
102900              FROM   TAPCNTL                                      10290099
103000         END-EXEC                                                 10300099
103100                                                                  10310099
103200         EVALUATE TRUE                                            10320099
103300             WHEN SQLCODE = +0                                    10330099
103400             WHEN SQLCODE = -904                                  10340099
103500             WHEN SQLCODE = -913                                  10350099
103600                  CONTINUE                                        10360099
103700                                                                  10370099
103800             WHEN SQLWARN0 NOT = SPACES                           10380099
103900             WHEN SQLCODE < +0                                    10390099
104000             WHEN SQLCODE > +0                                    10400099
104100                  MOVE 'S400-SELECT-DATES'                        10410099
104200                                    TO WS-ABEND-PARAGRAPH         10420099
104300                  MOVE 'UNSUCCESSFUL SELECT DATES'                10430099
104400                                    TO WS-ABEND-OPERATION         10440099
104500                  MOVE 'TAPCNTL '   TO WS-ABEND-STRUCTURE-1       10450099
104600                  MOVE SPACE        TO WS-ABEND-STRUCTURE-2       10460099
104700                  PERFORM Z999-SQL-ERROR                          10470099
104800         END-EVALUATE                                             10480099
104900     END-PERFORM.                                                 10490099
105000                                                                  10500099
105100     IF WS-RETRY-COUNTER > WS-RETRY-MAX                           10510099
105200        MOVE 'S400-SELECT-DATES'                                  10520099
105300                              TO WS-ABEND-PARAGRAPH               10530099
105400        MOVE 'MAX RETRIES EXCEEDED ON SELECT DATES'               10540099
105500                              TO WS-ABEND-OPERATION               10550099
105600        MOVE 'TAPCNTL'        TO WS-ABEND-STRUCTURE-1             10560099
105700        MOVE SPACE            TO WS-ABEND-STRUCTURE-2             10570099
105800        PERFORM Z999-SQL-ERROR                                    10580099
105900     END-IF.                                                      10590099
106000                                                                  10600099
106100*----------------------------------------------------------------*10610099
106200*  S500-SET-CURENT-TMST  GETS THE CURRENT TIMESTAMP FROM DB2.    *10620099
106300*----------------------------------------------------------------*10630099
106400                                                                  10640099
106500 S500-SET-CURRENT-TMST.                                           10650099
106600                                                                  10660099
106700     PERFORM                                                      10670099
106800         WITH TEST AFTER                                          10680099
106900         VARYING WS-RETRY-COUNTER                                 10690099
107000         FROM 1 BY 1                                              10700099
107100         UNTIL ((WS-RETRY-COUNTER > WS-RETRY-MAX)                 10710099
107200               OR (SQLCODE = +0))                                 10720099
107300                                                                  10730099
107400         EXEC SQL                                                 10740099
107500              SET :PV-CURR-TMST = CURRENT TIMESTAMP               10750099
107600         END-EXEC                                                 10760099
107700                                                                  10770099
107800         EVALUATE TRUE                                            10780099
107900             WHEN SQLCODE = +0                                    10790099
108000             WHEN SQLCODE = -904                                  10800099
108100             WHEN SQLCODE = -913                                  10810099
108200                  CONTINUE                                        10820099
108300                                                                  10830099
108400             WHEN SQLWARN0 NOT = SPACES                           10840099
108500             WHEN SQLCODE < +0                                    10850099
108600             WHEN SQLCODE > +0                                    10860099
108700                  MOVE 'S500-SET-CURRENT-TMST'                    10870099
108800                                         TO WS-ABEND-PARAGRAPH    10880099
108900                  MOVE 'UNSUCCESSFUL SET TMST'                    10890099
109000                                         TO WS-ABEND-OPERATION    10900099
109100                  MOVE SPACES            TO WS-ABEND-STRUCTURE-1  10910099
109200                                            WS-ABEND-STRUCTURE-2  10920099
109300                  PERFORM Z999-SQL-ERROR                          10930099
109400         END-EVALUATE                                             10940099
109500     END-PERFORM.                                                 10950099
109600                                                                  10960099
109700     IF WS-RETRY-COUNTER > WS-RETRY-MAX                           10970099
109800        MOVE 'S500-SELECT-CODES'                                  10980099
109900                              TO WS-ABEND-PARAGRAPH               10990099
110000        MOVE 'MAX RETRIES EXCEEDED ON SELECT CODES'               11000099
110100                              TO WS-ABEND-OPERATION               11010099
110200        MOVE SPACE            TO WS-ABEND-STRUCTURE-1             11020099
110300        MOVE SPACE            TO WS-ABEND-STRUCTURE-2             11030099
110400        PERFORM Z999-SQL-ERROR                                    11040099
110500     END-IF.                                                      11050099
110600                                                                  11060099
110700                                                                  11070099
110800                                                                  11080099
110900*----------------------------------------------------------------*11090099
111000*  W100-WRITE-INVOICE-LOAD-RECD                                  *11100099
111100*  WRITES TO THE INVOICE LOAD OUTPUT FILE.                       *11110099
111200*----------------------------------------------------------------*11120099
111300                                                                  11130099
111400 W100-WRITE-INVOICE-LOAD-RECD.                                    11140099
111500                                                                  11150099
111600     WRITE INVOICE-LOAD-RECORD FROM AP016-INVOICE-LOAD-RECORD.    11160099
111700                                                                  11170099
111800     INITIALIZE AP016-INVOICE-LOAD-RECORD.                        11180099
111900                                                                  11190099
112000     ADD 1 TO OUT-INVOICE-COUNT.                                  11200099
112100                                                                  11210099
112200*----------------------------------------------------------------*11220099
112300*  W200-WRITE-OUTPUT-JRNL-REC                                    *11230099
112400*  WRITES TO THE JOURNALIZED OUTPUT FILE.                        *11240099
112500*----------------------------------------------------------------*11250099
112600                                                                  11260099
112700 W200-WRITE-OUTPUT-JRNL-REC.                                      11270099
112800                                                                  11280099
112900     WRITE ADJUST-JRNL-RECORD FROM AP045-TRANSACTION-FILE.        11290099
113000                                                                  11300099
113100     ADD 1 TO OUT-ADJUSTMENT-COUNT.                               11310099
113200                                                                  11320099
113300*----------------------------------------------------------------*11330099
113400*  Y100-OPEN-INVOIC-CURSOR                                       *11340099
113500*----------------------------------------------------------------*11350099
113600                                                                  11360099
113700 Y100-OPEN-INVOIC-CSR.                                            11370099
113800                                                                  11380099
113900     PERFORM                                                      11390099
114000         WITH TEST AFTER                                          11400099
114100         VARYING WS-RETRY-COUNTER                                 11410099
114200         FROM 1 BY 1                                              11420099
114300         UNTIL ((WS-RETRY-COUNTER > WS-RETRY-MAX)                 11430099
114400               OR (SQLCODE = +0))                                 11440099
114500                                                                  11450099
114600         EXEC SQL                                                 11460099
114700            OPEN INVOIC_CSR                                       11470099
114800         END-EXEC                                                 11480099
114900                                                                  11490099
115000         EVALUATE TRUE                                            11500099
115100             WHEN SQLCODE = +0                                    11510099
115200             WHEN SQLCODE = -904                                  11520099
115300             WHEN SQLCODE = -913                                  11530099
115400                  CONTINUE                                        11540099
115500                                                                  11550099
115600             WHEN SQLWARN0 NOT = SPACES                           11560099
115700             WHEN SQLCODE NOT = +0                                11570099
115800                  MOVE 'Y100-OPEN-INVOIC-CSR        '             11580099
115900                                  TO WS-ABEND-PARAGRAPH           11590099
116000                  MOVE 'UNSUCCESSFUL OPEN INVOIC'                 11600099
116100                                  TO WS-ABEND-OPERATION           11610099
116200                  MOVE 'TINVOIC ' TO WS-ABEND-STRUCTURE-1         11620099
116300                  PERFORM Z999-SQL-ERROR                          11630099
116400         END-EVALUATE                                             11640099
116500     END-PERFORM.                                                 11650099
116600                                                                  11660099
116700     IF WS-RETRY-COUNTER > WS-RETRY-MAX                           11670099
116800        MOVE 'Y100-OPEN-INVOIC-CURSOR        '                    11680099
116900                              TO WS-ABEND-PARAGRAPH               11690099
117000        MOVE 'MAX RETRIES EXCEEDED ON OPEN CSR  '                 11700099
117100                              TO WS-ABEND-OPERATION               11710099
117200        PERFORM Z999-SQL-ERROR                                    11720099
117300     END-IF.                                                      11730099
117400                                                                  11740099
117500*----------------------------------------------------------------*11750099
117600*  Y200-CLOSE-INVOIC-CSR                                         *11760099
117700*----------------------------------------------------------------*11770099
117800                                                                  11780099
117900 Y200-CLOSE-INVOIC-CSR.                                           11790099
118000                                                                  11800099
118100     PERFORM                                                      11810099
118200         WITH TEST AFTER                                          11820099
118300         VARYING WS-RETRY-COUNTER                                 11830099
118400         FROM 1 BY 1                                              11840099
118500         UNTIL ((WS-RETRY-COUNTER > WS-RETRY-MAX)                 11850099
118600               OR (SQLCODE = +0))                                 11860099
118700                                                                  11870099
118800         EXEC SQL                                                 11880099
118900            CLOSE INVOIC_CSR                                      11890099
119000         END-EXEC                                                 11900099
119100                                                                  11910099
119200         EVALUATE TRUE                                            11920099
119300             WHEN SQLCODE = +0                                    11930099
119400             WHEN SQLCODE = -904                                  11940099
119500             WHEN SQLCODE = -913                                  11950099
119600                  CONTINUE                                        11960099
119700                                                                  11970099
119800             WHEN SQLWARN0 NOT = SPACES                           11980099
119900             WHEN SQLCODE  NOT = +0                               11990099
120000                  MOVE 'Y200-CLOSE-INVOIC-CSR '                   12000099
120100                                   TO WS-ABEND-PARAGRAPH          12010099
120200                  MOVE 'UNSUCCESSFUL CLOSE TINVOIC'               12020099
120300                                   TO WS-ABEND-OPERATION          12030099
120400                  MOVE 'TINVOIC '  TO WS-ABEND-STRUCTURE-1        12040099
120500                  PERFORM Z999-SQL-ERROR                          12050099
120600         END-EVALUATE                                             12060099
120700     END-PERFORM.                                                 12070099
120800                                                                  12080099
120900     IF WS-RETRY-COUNTER > WS-RETRY-MAX                           12090099
121000        MOVE 'Y200-CLOSE-INVOIC-CURSOR        '                   12100099
121100                              TO WS-ABEND-PARAGRAPH               12110099
121200        MOVE 'MAX RETRIES EXCEEDED ON CLOSE CSR  '                12120099
121300                              TO WS-ABEND-OPERATION               12130099
121400        PERFORM Z999-SQL-ERROR                                    12140099
121500     END-IF.                                                      12150099
121600                                                                  12160099
121700*----------------------------------------------------------------*12170099
121800*  Y300-OPEN-TRANCODE-CURSOR                                     *12180099
121900*----------------------------------------------------------------*12190099
122000                                                                  12200099
122100 Y300-OPEN-TRANCODE-CSR.                                          12210099
122200                                                                  12220099
122300     PERFORM                                                      12230099
122400         WITH TEST AFTER                                          12240099
122500         VARYING WS-RETRY-COUNTER                                 12250099
122600         FROM 1 BY 1                                              12260099
122700         UNTIL ((WS-RETRY-COUNTER > WS-RETRY-MAX)                 12270099
122800               OR (SQLCODE = +0))                                 12280099
122900                                                                  12290099
123000         EXEC SQL                                                 12300099
123100            OPEN TRANCODE_CSR                                     12310099
123200         END-EXEC                                                 12320099
123300                                                                  12330099
123400         EVALUATE TRUE                                            12340099
123500             WHEN SQLCODE = +0                                    12350099
123600             WHEN SQLCODE = -904                                  12360099
123700             WHEN SQLCODE = -913                                  12370099
123800                  CONTINUE                                        12380099
123900                                                                  12390099
124000             WHEN SQLWARN0 NOT = SPACES                           12400099
124100             WHEN SQLCODE NOT = +0                                12410099
124200                  MOVE 'Y300-OPEN-TRANCODE-CSR        '           12420099
124300                                  TO WS-ABEND-PARAGRAPH           12430099
124400                  MOVE 'UNSUCCESSFUL OPEN TRANS'                  12440099
124500                                  TO WS-ABEND-OPERATION           12450099
124600                  MOVE 'TTRNCDE ' TO WS-ABEND-STRUCTURE-1         12460099
124700                  MOVE SPACES     TO WS-ABEND-STRUCTURE-2         12470099
124800                  PERFORM Z999-SQL-ERROR                          12480099
124900         END-EVALUATE                                             12490099
125000     END-PERFORM.                                                 12500099
125100                                                                  12510099
125200     IF WS-RETRY-COUNTER > WS-RETRY-MAX                           12520099
125300        MOVE 'Y300-OPEN-TRANCODE-CURSOR        '                  12530099
125400                              TO WS-ABEND-PARAGRAPH               12540099
125500        MOVE 'MAX RETRIES EXCEEDED ON OPEN CSR  '                 12550099
125600                              TO WS-ABEND-OPERATION               12560099
125700        PERFORM Z999-SQL-ERROR                                    12570099
125800     END-IF.                                                      12580099
125900                                                                  12590099
126000*----------------------------------------------------------------*12600099
126100*  Y400-CLOSE-TRANCODE-CSR                                       *12610099
126200*----------------------------------------------------------------*12620099
126300                                                                  12630099
126400 Y400-CLOSE-TRANCODE-CSR.                                         12640099
126500                                                                  12650099
126600     PERFORM                                                      12660099
126700         WITH TEST AFTER                                          12670099
126800         VARYING WS-RETRY-COUNTER                                 12680099
126900         FROM 1 BY 1                                              12690099
127000         UNTIL ((WS-RETRY-COUNTER > WS-RETRY-MAX)                 12700099
127100               OR (SQLCODE = +0))                                 12710099
127200                                                                  12720099
127300         EXEC SQL                                                 12730099
127400            CLOSE TRANCODE_CSR                                    12740099
127500         END-EXEC                                                 12750099
127600                                                                  12760099
127700         EVALUATE TRUE                                            12770099
127800             WHEN SQLCODE = +0                                    12780099
127900             WHEN SQLCODE = -904                                  12790099
128000             WHEN SQLCODE = -913                                  12800099
128100                  CONTINUE                                        12810099
128200                                                                  12820099
128300             WHEN SQLWARN0 NOT = SPACES                           12830099
128400             WHEN SQLCODE  NOT = +0                               12840099
128500                  MOVE 'Y400-CLOSE-TRANCODE-CSR '                 12850099
128600                                   TO WS-ABEND-PARAGRAPH          12860099
128700                  MOVE 'UNSUCCESSFUL CLOSE TRANS  '               12870099
128800                                   TO WS-ABEND-OPERATION          12880099
128900                  MOVE 'TTRNCDE '  TO WS-ABEND-STRUCTURE-1        12890099
129000                  MOVE SPACES      TO WS-ABEND-STRUCTURE-2        12900099
129100                  PERFORM Z999-SQL-ERROR                          12910099
129200         END-EVALUATE                                             12920099
129300     END-PERFORM.                                                 12930099
129400                                                                  12940099
129500     IF WS-RETRY-COUNTER > WS-RETRY-MAX                           12950099
129600        MOVE 'Y400-CLOSE-TRANCODE-CURSOR        '                 12960099
129700                              TO WS-ABEND-PARAGRAPH               12970099
129800        MOVE 'MAX RETRIES EXCEEDED ON CLOSE CSR  '                12980099
129900                              TO WS-ABEND-OPERATION               12990099
130000        PERFORM Z999-SQL-ERROR                                    13000099
130100     END-IF.                                                      13010099
130200                                                                  13020099
130300*----------------------------------------------------------------*13030099
130400* Z998-ABEND                                                     *13040099
130500*  ABEND ROUTINE.                                                *13050099
130600*----------------------------------------------------------------*13060099
130700 Z998-ABEND.                                                      13070099
130800                                                                  13080099
130900     DISPLAY WS-ABEND-LITERAL.                                    13090099
131000     DISPLAY WS-ABEND-PROGRAM-MSG.                                13100099
131100     DISPLAY WS-ABEND-PARAGRAPH-MSG.                              13110099
131200     DISPLAY WS-MESSAGE-LINE-1.                                   13120099
131300     DISPLAY WS-MESSAGE-LINE-2.                                   13130099
131400                                                                  13140099
131500     CALL 'ILBOABN0' USING ABEND-CODE.                            13150099
131600                                                                  13160099
131700*----------------------------------------------------------------*13170099
131800*  PROCESS DB2 ABENDS.                                           *13180099
131900*----------------------------------------------------------------*13190099
132000                                                                  13200099
132100 Z999-SQL-ERROR.                                                  13210099
132200                                                                  13220099
132300     MOVE AP016-PO-NBR TO DISPLAY-PO-NBR.                         13230099
132400     DISPLAY 'PO NUMBER  : ' DISPLAY-PO-NBR.                      13240099
132500     DISPLAY '*** DB2 ERROR '.                                    13250099
132600     DISPLAY WS-ABEND-PROGRAM-MSG.                                13260099
132700     DISPLAY WS-ABEND-PARAGRAPH-MSG.                              13270099
132800     DISPLAY WS-ABEND-OPERATION-MSG.                              13280099
132900     DISPLAY WS-ABEND-TABLE1-MSG.                                 13290099
133000     IF WS-ABEND-STRUCTURE-2 > SPACES                             13300099
133100         DISPLAY WS-ABEND-TABLE2-MSG.                             13310099
133200                                                                  13320099
133300     SET AP-DB2-ERROR              TO TRUE.                       13330099
133400                                                                  13340099
133500     COPY DPPD004.                                                13350099
133600     CALL 'ILBOABN0' USING ABEND-CODE.                            13360099
