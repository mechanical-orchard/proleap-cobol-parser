000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400 PROGRAM-ID.                SVKUP900.                             00040099
000500 AUTHOR.                    COGNIZANT.                            00050099
000600 INSTALLATION.              KOHLS DEPARTMENT STORES.              00060000
000700 DATE-WRITTEN.              05-10-2017.                           00070099
000800 DATE-COMPILED.                                                   00080000
000900                                                                  00090000
001000******************************************************************00100000
001100*  BATCH PROGRAM - SVKUP900                                      *00110099
001400*                                                                *00120000
001500*  THIS PROGRAM WILL INSERT SVT_KOHLS_CRD_TXN                     00130000
001600*  FOR ADHOC ACTIVITY.                                            00140000
001700*                                                                *00150000
001800******************************************************************00160000
001900*  05/10/2017  INTIAL VERSION.                                    00170000
002000*                                                                 00180000
002100*  MADE BY: COGNIZANT                                             00190099
002101******************************************************************00200000
002102                                                                  00210000
002103 ENVIRONMENT DIVISION.                                            00220000
002104******************************************************************00230000
002105                                                                  00240000
002200 CONFIGURATION SECTION.                                           00250000
002300                                                                  00260000
002400 SOURCE-COMPUTER.    IBM-3090.                                    00270000
002500 OBJECT-COMPUTER.    IBM-3090.                                    00280000
002600                                                                  00290000
002700 INPUT-OUTPUT SECTION.                                            00300000
002800                                                                  00310000
002900 FILE-CONTROL.                                                    00320000
003000                                                                  00330000
003100     SELECT POS-INPUT-FILE                                        00340099
003200         ASSIGN TO INP01.                                         00350000
003201                                                                  00360099
003202     SELECT POS-ERROR-FILE                                        00370099
003203         ASSIGN TO OUT01.                                         00380099
003300                                                                  00390000
003400******************************************************************00400000
003500 DATA DIVISION.                                                   00410000
003600******************************************************************00420000
003700                                                                  00430000
003800 FILE SECTION.                                                    00440000
003900                                                                  00450000
004000 FD  POS-INPUT-FILE                                               00460099
004100     RECORDING MODE IS F                                          00470000
004200     BLOCK CONTAINS 0 RECORDS                                     00480000
004300     LABEL RECORDS ARE STANDARD.                                  00490000
004400                                                                  00500000
004500 01  POS-INPUT-RECORD            PIC X(80).                       00510099
004501                                                                  00520099
004502 FD  POS-ERROR-FILE                                               00530099
004503     RECORDING MODE IS F                                          00540099
004504     BLOCK CONTAINS 0 RECORDS                                     00550099
004505     LABEL RECORDS ARE STANDARD.                                  00560099
004506                                                                  00570099
004507 01  POS-ERROR-RECORD      PIC X(80).                             00580099
004600                                                                  00590000
004700 WORKING-STORAGE SECTION.                                         00600000
004800                                                                  00610000
004900 01  FILLER                            PIC X(50)  VALUE           00620000
005000     ' *** WORKING STORAGE STARTS HERE FOR SVKUP900 *** '.        00630099
005100                                                                  00640000
005200******************************************************************00650000
005300*  RECORD LAYOUT FOR INPUT DATE CARD (POS DATE)                   00660000
005400******************************************************************00670000
005800                                                                  00680000
005900 01  PS-PROGRAM-SWITCHES.                                         00690000
006400     05  PS-END-OF-INPUT-FILE-SW    PIC  X(01)       VALUE 'N'.   00700099
006500         88  PS-END-OF-INPUT-FILE                    VALUE 'Y'.   00710099
007500                                                                  00720000
007600 01  PC-PROGRAM-CONSTANTS.                                        00730000
007700     05  PC-PROGRAM-NAME         PIC X(8)     VALUE 'SVKUP900'.   00740099
008300                                                                  00800000
008400 01  PV-PROGRAM-VARIABLES.                                        00810000
008600     05  PV-PARAGRAPH-NAME       PIC X(30)         VALUE SPACE.   00830000
008700     05  PV-DB2-OPERATION        PIC X(30)         VALUE SPACE.   00840000
011200     05  PV-RECORDS-READ         PIC 9(06)         VALUE ZEROS.   01090099
011200     05  PV-ERROR-COUNT          PIC 9(06)         VALUE ZEROS.   01091099
011200     05  PV-ACTIVATE-COUNT       PIC 9(06)         VALUE ZEROS.   01092099
V11300                                                                  01100099
011400 01  AC-ABEND-CODE               PIC S9(04)        VALUE ZERO     01110000
011500                                                   COMP SYNC.     01120000
011600     88  AC-CONTROL-CARD-ERROR                     VALUE +4003.   01130000
011700     88  AC-DB2-ERROR                              VALUE +4013.   01140000
011701                                                                  01150099
011702 01  ABEND-CODE                  PIC S9(04)        VALUE +0 COMP. 01160099
       01  PV-INPUT-RECORD.                                             01170099
           05  PV-INPUT-CARD-NBR       PIC 9(19).                       01180099
           05  FILLER                  PIC X(01).                       01190099
           05  PV-INPUT-SAL-DATE       PIC X(10).                       01200099
           05  FILLER                  PIC X(01).                       01210099
           05  PV-INPUT-STORE-NBR      PIC 9(4).                        01220099
           05  FILLER                  PIC X(01).                       01230099
           05  PV-INPUT-REG-ID         PIC 9(3).                        01240099
           05  FILLER                  PIC X(01).                       01250099
           05  PV-INPUT-TRN-NBR        PIC 9(04).                       01260099
           05  FILLER                  PIC X(01).                       01270099
           05   PV-INPUT-AMT           PIC 99999.99.                    01280099
           05  FILLER                  PIC X(01).                       01290099
       01  PV-ERROR-RECORD.                                             01291099
           05  PV-ERROR-CARD-NBR       PIC 9(19).                       01292099
           05  FILLER                  PIC X(01).                       01293099
           05  PV-ERROR-SAL-DATE       PIC X(10).                       01294099
           05  FILLER                  PIC X(01).                       01295099
           05  PV-ERROR-STORE-NBR      PIC 9(4).                        01296099
           05  FILLER                  PIC X(01).                       01297099
           05  PV-ERROR-REG-ID         PIC 9(3).                        01298099
           05  FILLER                  PIC X(01).                       01299099
           05  PV-ERROR-TRN-NBR        PIC 9(04).                       01299199
           05  FILLER                  PIC X(01).                       01299299
           05  PV-ERROR-REASON         PIC X(30).                       01299399
           05  FILLER                  PIC X(01).                       01299499
012300**********************************************************        01360000
012400*  WS FIELDS FOR SQLCA MESSAGE ROUTINE                            01370000
012500**********************************************************        01380000
012600     COPY DPWS004.                                                01390000
026200******************************************************************01400099
026300** WORKING STORAGE FOR CONVERSION TO CARD NUMBER                 *01410099
026400******************************************************************01420099
026500     COPY SVWS007.                                                01430099
014700******************************************************************01680000
014800*  KOHL'S STORED VALUE TABLE                                     *01690000
014900******************************************************************01700000
015000                                                                  01710000
015100     EXEC SQL                                                     01720000
015200         INCLUDE SVT00001                                         01730000
015300     END-EXEC.                                                    01740000
015400                                                                  01750000
015500******************************************************************01760000
015600*  KOHL'S STORED VALUE TRANSACTION TABLE                         *01770000
015700******************************************************************01780000
015800                                                                  01790000
015900     EXEC SQL                                                     01800000
016000         INCLUDE SVT00002                                         01810000
016100     END-EXEC.                                                    01820000
016200                                                                  01830000
016300******************************************************************01840000
016400*  KOHL'S DOMAIN LOCATION TABLE                                  *01850000
016500******************************************************************01860000
016600                                                                  01870000
016700     EXEC SQL                                                     01880000
016800         INCLUDE XST00001                                         01890000
016900     END-EXEC.                                                    01900000
017000                                                                  01910000
017800                                                                  01920000
029300*  STANDARD LAYPUT FOR THE SQL COMMUNICATION AREA.                01930000
029400                                                                  01940000
029500     EXEC SQL                                                     01950000
029600         INCLUDE SQLCA                                            01960000
029700     END-EXEC.                                                    01970000
029800                                                                  01980000
029900******************************************************************01990000
030000 PROCEDURE DIVISION.                                              02000000
030100******************************************************************02010000
030200                                                                  02020000
030300 0000-MAINLINE.                                                   02030000
030400                                                                  02040000
030500     PERFORM 1000-INITIALIZE.                                     02050000
030800                                                                  02060000
030900     PERFORM 2000-PROCESS-INPUT                                   02070099
031000             UNTIL  PS-END-OF-INPUT-FILE.                         02080099
                                                                        02080199
           PERFORM 9000-COMMIT.                                         02081099
                                                                        02082099
           PERFORM 9999-END-OF-PROGRAM.                                 02090099
                                                                        02100099
034108     GOBACK.                                                      02170000
034109                                                                  02180000
034110******************************************************************02190000
034111* 1000-INITIALIZE-PROGRAM                                         02200000
034112* GET CONTROL CARD                                                02210000
034113******************************************************************02220000
034114 1000-INITIALIZE.                                                 02230000
                                                                        02231099
034115     INITIALIZE PV-RECORDS-READ PV-ERROR-COUNT PV-ACTIVATE-COUNT  02240099
           PS-END-OF-INPUT-FILE-SW.                                     02241099
                                                                        02242099
034116     OPEN INPUT  POS-INPUT-FILE.                                  02250099
                                                                        02251099
034117     OPEN OUTPUT POS-ERROR-FILE.                                  02260099
                                                                        02270099
034119     PERFORM 1500-READ-INPUT-FILE.                                02280099
                                                                        02281099
034120***************************************************************** 02290099
034121*1500-READ-INPUT-FILE.                                            02300099
034122******************************************************************02310099
034123 1500-READ-INPUT-FILE.                                            02320099
                                                                        02321099
034124     INITIALIZE PV-INPUT-RECORD.                                  02330099
                                                                        02331099
034125     READ POS-INPUT-FILE INTO PV-INPUT-RECORD                     02340099
034126        AT END                                                    02350099
034127           SET PS-END-OF-INPUT-FILE TO TRUE.                      02360099
                                                                        02360199
           IF NOT PS-END-OF-INPUT-FILE                                  02361099
                ADD 1 TO PV-RECORDS-READ                                02370099
           END-IF.                                                      02380099
047100******************************************************************02740000
047200* 2000-PROCESS-INPUT.                                             02750099
047300******************************************************************02760000
047400 2000-PROCESS-INPUT.                                              02770099
                                                                        02770199
047410     PERFORM 2100-FIND-CARD-LENGHT.                               02780099
           PERFORM 2200-VALIDATE-CARD.                                  02790099
049100     PERFORM 1500-READ-INPUT-FILE.                                02900000
090713******************************************************************02920099
       2100-FIND-CARD-LENGHT.                                           02920199
           MOVE 0  TO SV007-CARD-NUMBER-LENGTH.                         02920299
           MOVE PV-INPUT-CARD-NBR TO SV007-CARD-NUMBER-IN.              02920399
           PERFORM SV007-FORMAT-CARD.                                   02920499
           MOVE SV007-CARD-NBR     TO SVT00001-CRD-NBR.                 02920599
090713******************************************************************02921099
090714 2200-VALIDATE-CARD.                                              02930099
090715                                                                  02940099
090716     EXEC SQL                                                     02950099
090717         SELECT CRD_NBR INTO : SVT00002-CRD-NBR                   02951099
090719           FROM SVT_KOHLS_CRD_ACCT                                02952099
090720          WHERE CRD_NBR       = :SVT00001-CRD-NBR                 02953099
090721            WITH UR                                               02954099
090722     END-EXEC.                                                    02955099
090723                                                                  02956099
090724     EVALUATE TRUE                                                02957099
090725         WHEN SQLCODE = 0                                         02958099
090726             PERFORM 2300-VALIDATE-ACTIVATE                       02959099
090727         WHEN SQLCODE = +100                                      02959199
                   MOVE 'CARD IS INVALID' TO PV-ERROR-REASON            02959399
090728             PERFORM 8000-WRITE-ERROR-FILE                        02959499
090729         WHEN OTHER                                               02959599
090730             MOVE '2200-VALIDATE-CARD' TO PV-PARAGRAPH-NAME       02959699
090731             MOVE 'ERROR ON SELECT OF SVT_KOHLS_CRD_ACCT'         02959799
090732                                            TO PV-DB2-OPERATION   02959899
090800             PERFORM 9100-SQL-ABEND                               02959999
090900     END-EVALUATE.                                                02960099
090910**************************************************************    02960199
090714 2300-VALIDATE-ACTIVATE.                                          02961099
090715                                                                  02962099
090716     EXEC SQL                                                     02963099
090717         SELECT DISTINCT CRD_NBR INTO : SVT00001-CRD-NBR          02964099
090719           FROM SVT_KOHLS_CRD_TXN                                 02965099
090720          WHERE CRD_NBR       = :SVT00002-CRD-NBR                 02966099
090721            WITH UR                                               02967099
090722     END-EXEC.                                                    02968099
090723                                                                  02969099
090724     EVALUATE TRUE                                                02969199
090725         WHEN SQLCODE = +100                                      02969299
090726             PERFORM 2400-FIND-ST-CDE                             02969399
090727         WHEN SQLCODE = 0                                         02969499
                   MOVE 'CARD WAS ACTIVATED ALREADY' TO PV-ERROR-REASON 02969699
090728             PERFORM 8000-WRITE-ERROR-FILE                        02969799
090729         WHEN OTHER                                               02969899
090730             MOVE '2300-VALIDATE-ACTIVAT' TO PV-PARAGRAPH-NAME    02969999
090731             MOVE 'ERROR ON SELECT OF SVT_KOHLS_CRD_ACCT'         02970099
090732                                            TO PV-DB2-OPERATION   02970199
090800             PERFORM 9100-SQL-ABEND                               02971099
090900     END-EVALUATE.                                                02972099
090910**************************************************************    02972199
090714 2400-FIND-ST-CDE.                                                02972299
090715                                                                  02972399
           MOVE PV-INPUT-STORE-NBR TO XST00001-LOC-NBR.                 02972499
                                                                        02972599
090716     EXEC SQL                                                     02972699
090717         SELECT ST_CDE INTO :XST00001-ST-CDE                      02972799
090719           FROM XST_LOC                                           02972899
090720          WHERE LOC_NBR       = :XST00001-LOC-NBR                 02972999
090721            WITH UR                                               02973099
090722     END-EXEC.                                                    02973199
090723                                                                  02973299
090724     EVALUATE TRUE                                                02973399
090725         WHEN SQLCODE = 0                                         02973499
090726                 PERFORM 2500-ACTIVATE-CARD                       02973599
090729         WHEN OTHER                                               02973999
090730             MOVE '2400-FIND-ST-CDE'      TO PV-PARAGRAPH-NAME    02974099
090731             MOVE 'ERROR ON SELECT OF XST_LOC'                    02974199
090732                                            TO PV-DB2-OPERATION   02974299
090800             PERFORM 9100-SQL-ABEND                               02974399
090900     END-EVALUATE.                                                02974499
090910**************************************************************    02975099
051100 2500-ACTIVATE-CARD.                                              02980099
                                                                        02981099
056600     MOVE SPACE                   TO SVT00002-DRV-LIC-NBR.        03000099
054900     MOVE 0                       TO SVT00002-TRN-RVRSL-CDE.      03010099
056400     MOVE 'N'                     TO SVT00002-TRN-VOID-IND.       03020099
053300     MOVE 2                       TO SVT00002-ACTVY-TYP-CDE.      03210099
055900     MOVE PV-INPUT-SAL-DATE       TO SVT00002-POS-DTE.            03220099
056100     MOVE PV-INPUT-STORE-NBR      TO SVT00002-STR-NBR.            03230099
056200     MOVE PV-INPUT-REG-ID         TO SVT00002-POS-TRMNL-NBR.      03240099
056300     MOVE PV-INPUT-TRN-NBR        TO SVT00002-POS-TRN-NBR.        03250099
054200     MOVE PV-INPUT-AMT            TO SVT00002-APP-AUTH-AMT.       03300099
056600     MOVE 0                       TO SVT00002-POS-OPRT-ID.        03301099
056700     MOVE 'SVKUP900'              TO SVT00002-APVL-USR-ID.        03550099
056800     MOVE 3                       TO SVT00002-ACTVY-STAT-CDE.     03560099
054200     MOVE PV-INPUT-AMT            TO SVT00002-ORIG-AUTH-AMT       03570099
054200     MOVE XST00001-ST-CDE         TO SVT00002-ST-CDE.             03580099
076300     EXEC SQL INSERT                                              04680099
076400              INTO SVT_KOHLS_CRD_TXN                              04690099
076500                  (CRD_NBR                                        04700099
076600                  ,TRN_AUTH_TMST                                  04710099
076700                  ,DRV_LIC_NBR                                    04720099
076800                  ,TRN_RVRSL_CDE                                  04730099
076900                  ,TRN_VOID_IND                                   04740099
077000                  ,ACTVY_TYP_CDE                                  04750099
077100                  ,POS_DTE                                        04760099
077200                  ,STR_NBR                                        04770099
077300                  ,POS_TRMNL_NBR                                  04780099
077400                  ,POS_TRN_NBR                                    04790099
077500                  ,TRN_PSTD_TMST                                  04800099
077600                  ,APP_AUTH_AMT                                   04810099
077700                  ,POS_OPRT_ID                                    04820099
077800                  ,APVL_USR_ID                                    04830099
077900                  ,ACTVY_STAT_CDE                                 04840099
078000                  ,ORIG_AUTH_AMT                                  04850099
078100                  ,ST_CDE)                                        04860099
078200           VALUES                                                 04870099
078300              (:SVT00002-CRD-NBR                                  04880099
078400              ,CURRENT TIMESTAMP                                  04890099
078500              ,:SVT00002-DRV-LIC-NBR                              04900099
078600              ,:SVT00002-TRN-RVRSL-CDE                            04910099
078700              ,:SVT00002-TRN-VOID-IND                             04920099
078800              ,:SVT00002-ACTVY-TYP-CDE                            04930099
078900              ,:SVT00002-POS-DTE                                  04940099
079000              ,:SVT00002-STR-NBR                                  04950099
079100              ,:SVT00002-POS-TRMNL-NBR                            04960099
079200              ,:SVT00002-POS-TRN-NBR                              04970099
079300              ,CURRENT TIMESTAMP                                  04980099
079400              ,:SVT00002-APP-AUTH-AMT                             04990099
079500              ,:SVT00002-POS-OPRT-ID                              05000099
079600              ,:SVT00002-APVL-USR-ID                              05010099
079700              ,:SVT00002-ACTVY-STAT-CDE                           05020099
079800              ,:SVT00002-ORIG-AUTH-AMT                            05030099
079900              ,:SVT00002-ST-CDE)                                  05040099
080000     END-EXEC.                                                    05050099
080100                                                                  05060000
080200     EVALUATE TRUE                                                05070000
080300         WHEN SQLCODE = ZERO                                      05080000
080400             ADD +1 TO PV-ACTIVATE-COUNT                          05090099
090400         WHEN OTHER                                               05100000
090700                                                                  05140000
090703             MOVE '2500-ACTIVATE-CARD'                            05150099
090704                                            TO PV-PARAGRAPH-NAME  05160000
090705             MOVE 'ERROR ON INSERT OF SVT_KOHLS_CRD_TXN'          05170000
090706                                            TO PV-DB2-OPERATION   05180000
090707             PERFORM 9100-SQL-ABEND                               05190099
090708     END-EVALUATE.                                                05200000
090709                                                                  05210000
090920**8000-WRITE-ERROR-FILE                                           05481099
090930**************************************************************    05490099
090940 8000-WRITE-ERROR-FILE.                                           05500099
                                                                        05501099
           MOVE PV-INPUT-CARD-NBR  TO PV-ERROR-CARD-NBR.                05510099
           MOVE PV-INPUT-SAL-DATE  TO PV-ERROR-SAL-DATE.                05512099
           MOVE PV-INPUT-STORE-NBR TO PV-ERROR-STORE-NBR.               05514099
           MOVE PV-INPUT-REG-ID    TO PV-ERROR-REG-ID.                  05516099
           MOVE PV-INPUT-TRN-NBR   TO PV-ERROR-TRN-NBR.                 05518099
           ADD 1 TO PV-ERROR-COUNT.                                     05519099
091010     WRITE POS-ERROR-RECORD FROM                                  05530099
091020                            PV-ERROR-RECORD.                      05540099
091500***************************************************************** 05590000
091600*    COMMIT DB2 UPDATES                                           05600000
091700***************************************************************** 05610000
091800 9000-COMMIT.                                                     05620000
091900     EXEC SQL                                                     05630000
092000        COMMIT                                                    05640000
092100     END-EXEC.                                                    05650000
092200                                                                  05660000
092300     EVALUATE TRUE                                                05670000
092400        WHEN SQLCODE = 0                                          05680000
092500            CONTINUE                                              05690000
092600        WHEN OTHER                                                05700000
092700            MOVE '9000-COMMIT' TO PV-PARAGRAPH-NAME               05710000
092800            MOVE 'COMMIT FAILED' TO PV-DB2-OPERATION              05720000
092900            PERFORM 9100-SQL-ABEND                                05730000
093000     END-EVALUATE.                                                05740000
093100                                                                  05750000
093200******************************************************************05760000
093300* 9100-SQL-ABEND - PERFORMS THE ABEND FOR THE PROGRAM IN THE      05770000
093400* EVENT THAT AN SQL ERROR OR WARNING CODE OCCURS.                 05780000
093500******************************************************************05790000
093600 9100-SQL-ABEND.                                                  05800000
093700     DISPLAY '** ABEND     **'.                                   05810000
093800     DISPLAY '** PROGRAM   ** = ' PC-PROGRAM-NAME.                05820000
093900     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              05830000
094000     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               05840000
094100                                                                  05850000
094200******************************************************************05860000
094300* COPYBOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED      05870000
094400* TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS       05880000
094500******************************************************************05890000
094600                                                                  05900000
094700     COPY DPPD004.                                                05910000
094800                                                                  05920000
094900     SET AC-DB2-ERROR TO TRUE.                                    05930000
095000     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         05940000
095100                                                                  05950000
094500******************************************************************05960099
       9999-END-OF-PROGRAM.                                             05970099
            CLOSE POS-INPUT-FILE.                                       05971099
            CLOSE POS-ERROR-FILE.                                       05973099
            DISPLAY '****************************'.                     05980099
            DISPLAY 'NO OF RECORDS READ  :'PV-RECORDS-READ.             06000099
            DISPLAY 'NO OF CARDS ACTIVATE:' PV-ACTIVATE-COUNT.          06010099
            DISPLAY 'NO OF ERROR CARDS   :' PV-ERROR-COUNT.             06020099
            DISPLAY '  END OF PROGRAM'.                                 06021099
            DISPLAY '****************************'.                     06030099
012300**********************************************************        06040099
012400*  CARD CONVERSION MODULE                                         06050099
012300**********************************************************        06060099
012600     COPY SVPD007.                                                06070099
