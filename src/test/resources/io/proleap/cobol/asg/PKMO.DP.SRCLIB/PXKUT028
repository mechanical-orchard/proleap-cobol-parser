000100 IDENTIFICATION DIVISION.                                         00010000
000110******************************************************************00011099
000120 PROGRAM-ID.    PXKUT028.                                         00012099
000130 AUTHOR.        JOYCE KNOKE.                                      00013099
000140 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00014099
000150 DATE-WRITTEN.  NOVEMBER 2006.                                    00015099
000160 DATE-COMPILED.                                                   00016099
000170***************************************************************** 00017099
000180* THIS PROGRAM READS THE UNLOADED BMC FILE WHERE THE EVENT HAS    00018099
000190* BEEN CHECKED FOR ACTIVE STATUS AND WILL NOW BE VALIDATED FOR    00019099
000200* CLEARANCE. IF NOT STILL CLEARANCE THE ITEM IS MARKED FOR        00020099
000300* DELETION.                                                       00030099
000400***************************************************************** 00040099
000500 ENVIRONMENT DIVISION.                                            00050099
000600***************************************************************** 00060099
000700 CONFIGURATION SECTION.                                           00070099
000800                                                                  00080099
000900 INPUT-OUTPUT SECTION.                                            00090099
001000                                                                  00100099
001100 FILE-CONTROL.                                                    00110099
001200                                                                  00120099
001300     SELECT IN-VALID-FILE                                         00130099
001400         ASSIGN TO INP01.                                         00140099
001500                                                                  00150099
001900     SELECT OUT-DELETE-FILE                                       00190099
002000         ASSIGN TO OUT01.                                         00200099
002310                                                                  00231099
002320******************************************************************00232099
002330 DATA DIVISION.                                                   00233099
002340******************************************************************00234099
002350 FILE SECTION.                                                    00235099
002360                                                                  00236099
002370 FD  IN-VALID-FILE                                                00237099
002380     RECORDING MODE F                                             00238099
002390     LABEL RECORDS ARE STANDARD                                   00239099
002400     BLOCK CONTAINS 0 RECORDS.                                    00240099
002500 01  IN-VALID-RECORD                     PIC  X(27).              00250099
002600                                                                  00260099
003300 FD  OUT-DELETE-FILE                                              00330099
003400     RECORDING MODE F                                             00340099
003500     LABEL RECORDS ARE STANDARD                                   00350099
003600     BLOCK CONTAINS 0 RECORDS.                                    00360099
003700 01  OUT-DELETE-RECORD                   PIC  X(27).              00370099
003710                                                                  00371099
003780****************************************************************  00378099
003790 WORKING-STORAGE SECTION.                                         00379099
003800****************************************************************  00380099
004800****************************************************************  00480099
004900**DATE FIELDS                                                     00490099
005000****************************************************************  00500099
007100                                                                  00710099
007500 01  DF-WORK-DATE                     PIC  X(26).                 00750099
007600 01  DF-WORK-DATE-R   REDEFINES   DF-WORK-DATE.                   00760099
007700     05  DF-DATE-1-10                 PIC  X(10).                 00770099
007800     05  DF-DATE-11-26                PIC  X(16).                 00780099
007801                                                                  00780199
007500 01  DF-END-DATE                      PIC  X(26).                 00780299
007600 01  DF-WORK-END-DATE-R   REDEFINES   DF-END-DATE.                00780399
007700     05  DF-END-DATE-1-10             PIC  X(10).                 00780499
007800     05  DF-END-DATE-11-26            PIC  X(16).                 00780599
007801                                                                  00780699
007802****************************************************************  00780799
007803**PROGRAM ACCUMULATORS                                            00780899
007804****************************************************************  00780999
007805 01  PA-PROGRAM-ACCUMULATORS.                                     00781099
007806     05  PA-TOT-RECS-READ             PIC 9(13) VALUE ZEROS.      00781199
007807     05  PA-TOT-DELETED               PIC 9(13) VALUE ZEROS.      00781299
007808     05  PA-TOT-VALID                 PIC 9(13) VALUE ZEROS.      00781399
007809                                                                  00781499
007810****************************************************************  00781599
007820**PROGRAM VARIABLES.                                              00782099
007830****************************************************************  00783099
007840 01  PV-PROGRAM-VARIABLES.                                        00784099
007850     05  PV-PARAGRAPH-NAME            PIC  X(30) VALUE SPACE.     00785099
007860     05  PV-OPERATION-MSG-1           PIC  X(40) VALUE SPACE.     00786099
007870     05  PV-OPERATION-MSG-2           PIC  X(40) VALUE SPACE.     00787099
007880     05  PV-OPERATION-MSG             PIC  X(30) VALUE SPACE.     00788099
007890     05  PV-DB2-OPERATION             PIC  X(30) VALUE SPACE.     00789099
007900     05  PV-EVENT-DATE                PIC  X(10) VALUE SPACE.     00790099
008000     05  PV-SQL-SUB                   PIC S9(04) COMP             00800099
008100                                                 VALUE +0.        00810099
008200     05  PV-SAVE-SKU-NBR              PIC S9(08) COMP-3           00820099
008300                                                 VALUE +0.        00830099
008400                                                                  00840099
008500****************************************************************  00850099
008600**PROGRAM SWITCHES.                                               00860099
008601*****-**********************************************************  00860199
008602 01  PS-PROGRAM-SWITCHES.                                         00860200
008603     05  PS-END-OF-FILE-SW            PIC  X(01) VALUE 'N'.       00860300
008604         88 PS-END-OF-FILE-N                     VALUE 'N'.       00860400
008605         88 PS-END-OF-FILE-Y                     VALUE 'Y'.       00860500
008606     05  PS-END-OF-CSR-SW             PIC  X(01) VALUE 'N'.       00860600
008607         88 PS-END-OF-CSR-N                      VALUE 'N'.       00860700
008608         88 PS-END-OF-CSR-Y                      VALUE 'Y'.       00860800
008609     05  PS-SKU-FOUND-SW              PIC  X(01) VALUE ' '.       00860999
008610         88 PS-SKU-NOT-FOUND-N                   VALUE 'N'.       00861099
008620         88 PS-SKU-FOUND-Y                       VALUE 'Y'.       00862000
008630     05  PS-SKU-STORE-FOUND-SW        PIC  X(01) VALUE ' '.       00863099
008631         88 PS-SKU-STORE-FOUND-N                 VALUE 'N'.       00863199
008632         88 PS-SKU-STORE-FOUND-Y                 VALUE 'Y'.       00863200
008633     05  PS-SKUS-UNMATCHED-SW         PIC  X(01) VALUE 'N'.       00863399
008634         88 PS-SKUS-UNMATCHED-N                  VALUE 'N'.       00863499
008635         88 PS-SKUS-UNMATCHED-Y                  VALUE 'Y'.       00863500
008636                                                                  00863699
008637****************************************************************  00863799
008638**PROGRAM CONSTANTS.                                              00863899
008639****************************************************************  00863999
008640 01  PC-PROGRAM-CONSTANTS.                                        00864000
008650     05  PC-CURRENT-PROGRAM-NAME      PIC  X(08) VALUE 'PXKUT028'.00865000
008660     05  PC-MAX-RETRIES               PIC S9(004) COMP            00866099
008670                                                 VALUE +5.        00867099
008680                                                                  00868099
009300****************************************************************  00930000
009400**ABEND INFORMATION                                               00940000
009500****************************************************************  00950000
009700 01  AC-ABEND-CODE                    PIC S9(04) VALUE ZERO       00970000
009800                                                 COMP SYNC.       00980000
010000     88  AC-DB2-ERROR                            VALUE +4013.     01000000
010001     88  AC-CONTROL-CARD-ERROR                   VALUE +4003.     01000199
010002                                                                  01000200
010003************************************************************      01000399
010004* VALID MOS ITEMS                                                 01000499
010005************************************************************      01000599
010006     COPY PXRD032.                                                01000699
010007                                                                  01000799
010600***************************************************************** 01060000
010900*  ABEND ROUTINE INFORMATION                                      01090000
010910***************************************************************** 01091099
011000     COPY DPWS900.                                                01100000
011001                                                                  01100199
011002***************************************************************** 01100200
011100*  ABEND ROUTINE INFORMATION                                      01110000
011110***************************************************************** 01111099
011200     COPY DPWS004.                                                01120000
011300                                                                  01130099
011400************************************************************      01140099
011500* DB2 MESSAGE AREA                                                01150099
011600************************************************************      01160099
011700     COPY SQLCA2.                                                 01170099
011800                                                                  01180099
011900************************************************************      01190099
012000* DB2 COMMUNICATIONS AREA                                         01200099
012100************************************************************      01210099
012200     EXEC SQL                                                     01220099
012300       INCLUDE SQLCA                                              01230099
012400     END-EXEC.                                                    01240099
012500                                                                  01250099
012600************************************************************      01260099
012700* DB2 TABLE XST_SKU (XST00010)                                    01270099
012800************************************************************      01280099
012900     EXEC SQL                                                     01290099
013000       INCLUDE XST00010                                           01300099
013100     END-EXEC.                                                    01310099
013200                                                                  01320099
013300************************************************************      01330099
013400* DB2 TABLE XST_SKU_LOC (XST00008)                                01340099
013500************************************************************      01350099
013600     EXEC SQL                                                     01360099
013700       INCLUDE XST00008                                           01370099
013800     END-EXEC.                                                    01380099
013801                                                                  01380199
013802******************************************************************01380200
013803*  PARAMETER LIST FOR THE CALENDAR ROUTINE (DPKUT500)             01380300
013804******************************************************************01380400
013805     COPY DPWS500.                                                01380500
013806                                                                  01380600
013807****************************************************************  01380700
014800 PROCEDURE DIVISION.                                              01480000
014900******************************************************************01490000
015000 0000-MAINLINE.                                                   01500000
015200     PERFORM 1000-HOUSEKEEPING.                                   01520000
015300                                                                  01530099
015400     PERFORM 2000-PROCESS-INPUT-FILE                              01540099
261400         UNTIL PS-END-OF-FILE-Y.                                  26140000
261401                                                                  26140199
261402     PERFORM 9000-END-OF-JOB.                                     26140200
261403                                                                  26140300
261404     STOP RUN.                                                    26140400
261405                                                                  26140500
261406****************************************************************  26140600
261407*     OPEN FILES, READ IN AND VALIDATE CONTROL DATE.              26140700
261408****************************************************************  26140800
261409 1000-HOUSEKEEPING.                                               26140900
261410     OPEN INPUT  IN-VALID-FILE                                    26141000
261412          OUTPUT OUT-DELETE-FILE.                                 26141299
261416                                                                  26141600
261431     PERFORM 5000-READ-INPUT-FILE.                                26143199
261432                                                                  26143200
261700     IF PS-END-OF-FILE-Y                                          26170000
261800         DISPLAY SPACES                                           26180099
261900         DISPLAY ALL '*'                                          26190099
262000         DISPLAY '  INPUT FILE IS EMPTY '                         26200099
262100         DISPLAY ALL '*'                                          26210099
262200         DISPLAY SPACES                                           26220099
262300     END-IF.                                                      26230099
262334                                                                  26233499
262335****************************************************************  26233500
262336*     PROCESS INPUT FILE                                          26233600
262337****************************************************************  26233700
262338 2000-PROCESS-INPUT-FILE.                                         26233800
                                                                        26233999
262340     MOVE SPACES TO PS-SKU-FOUND-SW.                              26234099
262341     MOVE PX032-SKU-NBR TO PV-SAVE-SKU-NBR.                       26234199
262342     PERFORM 2200-VERIFY-SKU-NBR.                                 26234200
262343                                                                  26234399
262350     IF PS-SKU-FOUND-Y                                            26235000
262360       AND XST00008-LOC-SKU-STAT-CDE = '30'                       26236099
262370       CONTINUE                                                   26237099
262400     END-IF.                                                      26240099
262500                                                                  26250099
262350     IF PS-SKU-FOUND-Y                                            26260099
262360       AND XST00008-LOC-SKU-STAT-CDE = '25'                       26270099
262370       AND XST00010-REGN-PRIC-IND = 'Y'                           26280099
262380        PERFORM 3000-PROCESS-SKU-BY-STORE                         26290099
262400     END-IF.                                                      26300099
                                                                        26300199
262350     IF PS-SKU-NOT-FOUND-N                                        26300299
262380        PERFORM 7000-WRITE-DELETE-FILE                            26300499
262400     END-IF.                                                      26300599
262500                                                                  26301099
261431     PERFORM 5000-READ-INPUT-FILE.                                26303099
261416                                                                  26304099
263100******************************************************************26310099
263200* VERIFY SKU NUMBER                                               26320099
263500******************************************************************26350099
263600 2200-VERIFY-SKU-NBR.                                             26360099
263700     INITIALIZE DCLXST00008                                       26370099
263800                DCLXST00010.                                      26380099
264100     PERFORM                                                      26410099
264200         WITH TEST AFTER                                          26420099
264300         VARYING PV-SQL-SUB                                       26430099
264400         FROM 1 BY 1                                              26440099
264500         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 26450099
264600                   OR  SQLCODE = 0                                26460099
264700                   OR  SQLCODE = +100)                            26470099
264800                                                                  26480099
264900         EXEC SQL                                                 26490099
265000           SELECT LOC_SKU_STAT_CDE                                26500099
265100                 ,BEG_TMST                                        26510099
005200           INTO   :XST00008-LOC-SKU-STAT-CDE                      26520099
265300                 ,:XST00008-BEG-TMST                              26530099
265400           FROM   XST_SKU      A                                  26540099
265500                 ,XST_SKU_LOC  B                                  26550099
265700           WHERE A.SKU_NBR       = :PX032-SKU-NBR                 26570099
265700             AND A.INTR_UPC_ID   =  B.INTR_UPC_ID                 26571099
265800             AND B.LOC_NBR       =  0                             26580099
266100             AND B.END_TMST     IS  NULL                          26610099
266300           WITH UR                                                26630099
266400         END-EXEC                                                 26640099
266500                                                                  26650099
266600         EVALUATE TRUE                                            26660099
266700             WHEN SQLCODE = 0                                     26670099
266800                 SET PS-SKU-FOUND-Y TO TRUE                       26680099
266900             WHEN SQLCODE = +100                                  26690099
267000                 SET PS-SKU-NOT-FOUND-N TO TRUE                   26700099
267100             WHEN SQLCODE = -911                                  26710099
267200                 CONTINUE                                         26720099
267300             WHEN SQLWARN NOT = SPACES                            26730099
267400             WHEN SQLCODE NOT = ZERO                              26740099
267500                 MOVE '2200-VERIFY-SKU-NUMBER    '                26750099
267600                                      TO PV-PARAGRAPH-NAME        26760099
267700                 MOVE 'SELECT XST_SKU  '                          26770099
267800                                      TO PV-DB2-OPERATION         26780099
267900                 PERFORM 9999-SQL-ABEND                           26790099
268000         END-EVALUATE                                             26800099
268100     END-PERFORM.                                                 26810099
268200                                                                  26820099
268300     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         26830099
268400       MOVE '2200-VERIFY-SKU-NUMBER'                              26840099
268500                             TO  PV-PARAGRAPH-NAME                26850099
268600       MOVE '2200- SELECT RETRIES EXCEEDED'                       26860099
268700                              TO  PV-DB2-OPERATION                26870099
268800       PERFORM 9999-SQL-ABEND                                     26880099
268801     END-IF.                                                      26880199
268802                                                                  26880200
268852****************************************************************  26885200
268853**    PROCESS SKU BY STORE                                        26885300
268854****************************************************************  26885400
268855 3000-PROCESS-SKU-BY-STORE.                                       26885599
268856     MOVE ' ' TO PS-SKU-STORE-FOUND-SW.                           26885699
268857     PERFORM 4000-SELECT-SKU-BY-STORE.                            26885799
268858                                                                  26885899
268859     IF PS-SKU-STORE-FOUND-Y                                      26885999
268860         CONTINUE                                                 26886099
268861     END-IF.                                                      26886199
268862                                                                  26886200
268863     IF PS-SKU-STORE-FOUND-N                                      26886399
268864         PERFORM 7000-WRITE-DELETE-FILE                           26886499
268865     END-IF.                                                      26886599
268866                                                                  26886600
269400******************************************************************26940099
269500* SELECT SKU BY STORE                                             26950099
269800******************************************************************26980099
269900 4000-SELECT-SKU-BY-STORE.                                        26990099
270100     INITIALIZE DCLXST00008                                       27010099
270200                DCLXST00010.                                      27020099
270300                                                                  27030099
270400     PERFORM                                                      27040099
270500         WITH TEST AFTER                                          27050099
270600         VARYING PV-SQL-SUB                                       27060099
270700         FROM 1 BY 1                                              27070099
270800         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 27080099
270900                   OR  SQLCODE = 0                                27090099
271000                   OR  SQLCODE = +100)                            27100099
271100                                                                  27110099
271200         EXEC SQL                                                 27120099
271300           SELECT LOC_SKU_STAT_CDE                                27130099
271400                 ,BEG_TMST                                        27140099
271500           INTO   :XST00008-LOC-SKU-STAT-CDE                      27150099
271600                 ,:XST00008-BEG-TMST                              27160099
271700           FROM   XST_SKU      A                                  27170099
271800                 ,XST_SKU_LOC  B                                  27180099
271900           WHERE A.SKU_NBR       = :PX032-SKU-NBR                 27190099
272000             AND A.INTR_UPC_ID   =  B.INTR_UPC_ID                 27200099
272100             AND B.LOC_NBR       = :PX032-LOC-NBR                 27210099
272400             AND B.END_TMST     IS  NULL                          27240099
272500           WITH UR                                                27250099
272600         END-EXEC                                                 27260099
272700                                                                  27270099
272800         EVALUATE TRUE                                            27280099
272900             WHEN SQLCODE = 0                                     27290099
273000                 SET PS-SKU-STORE-FOUND-Y TO TRUE                 27300099
273100             WHEN SQLCODE = +100                                  27310099
273200                 SET PS-SKU-STORE-FOUND-N TO TRUE                 27320099
273300             WHEN SQLCODE = -911                                  27330099
273400                 CONTINUE                                         27340099
273500             WHEN SQLWARN NOT = SPACES                            27350099
273600             WHEN SQLCODE NOT = ZERO                              27360099
273700                 MOVE '4000-SELECT-SKU-BY-STORE '                 27370099
273800                                      TO PV-PARAGRAPH-NAME        27380099
273900                 MOVE 'SELECT XST_SKU  '                          27390099
274000                                      TO PV-DB2-OPERATION         27400099
274100                 PERFORM 9999-SQL-ABEND                           27410099
274200         END-EVALUATE                                             27420099
274300     END-PERFORM.                                                 27430099
274400                                                                  27440099
274500     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         27450099
274600       MOVE '4000-SELECT-SKU-BY-STORE '                           27460099
274700                             TO  PV-PARAGRAPH-NAME                27470099
274800       MOVE '4000- SELECT RETRIES EXCEEDED'                       27480099
274900                              TO  PV-DB2-OPERATION                27490099
275000       PERFORM 9999-SQL-ABEND                                     27500099
275001     END-IF.                                                      27500199
275002                                                                  27500200
275003****************************************************************  27500300
275004*     READ INPUT FILE.                                            27500400
275005****************************************************************  27500500
275006 5000-READ-INPUT-FILE.                                            27500600
275007     READ IN-VALID-FILE INTO PX032-VALID-MOS-ITEMS                27500700
275008        AT END                                                    27500800
275009           SET PS-END-OF-FILE-Y      TO TRUE                      27500900
275020     END-READ.                                                    27502000
275021                                                                  27502199
275022     IF PS-END-OF-FILE-N                                          27502200
275023         ADD 1 TO PA-TOT-RECS-READ                                27502399
275024     END-IF.                                                      27502499
275025                                                                  27502599
275033****************************************************************  27503300
275034**    SUBTRACT 1 FROM BEG-TMST TO GET PX032-MOS-END-DATE          27503499
275035**    WRITE DELETE OUTPUT FILE                                    27503500
275036****************************************************************  27503600
275037 7000-WRITE-DELETE-FILE.                                          27503799
261418     MOVE PX032-MOS-EFF-DATE TO DF-WORK-DATE.                     27503899
261421     PERFORM 9999-DATE-ROUTINE-DECR-DAYS.                         27503999
261422                                                                  27504099
275038     MOVE DF-END-DATE-1-10 TO PX032-MOS-END-DATE.                 27505099
275039     WRITE OUT-DELETE-RECORD FROM PX032-VALID-MOS-ITEMS.          27505100
275040     ADD 1 TO  PA-TOT-DELETED.                                    27505299
275041                                                                  27505300
275042****************************************************************  27505400
275043*     CLOSE FILES.                                                27505500
275044****************************************************************  27505600
275045 9000-END-OF-JOB.                                                 27505700
275046     CLOSE IN-VALID-FILE                                          27505800
275048           OUT-DELETE-FILE.                                       27505999
275050                                                                  27506100
275060     DISPLAY ' '.                                                 27506299
275070     DISPLAY '*********************************************'.     27507099
275080     DISPLAY '    PXKUT028 SUMMARY STATISTICS              '      27508099
275090     DISPLAY '*********************************************'.     27509099
275100     DISPLAY 'INPUT RECORDS READ........: ' PA-TOT-RECS-READ      27510099
275200     DISPLAY 'SKU RECORDS DELETED.......: ' PA-TOT-DELETED        27520099
275300     DISPLAY 'OUTPUT RECS VALID.........: ' PA-TOT-VALID          27530099
275301     DISPLAY '*********************************************'.     27530199
275302                                                                  27530200
275303******************************************************************27530399
275304*    KOHLS DATE ROUTINE                                           27530499
275305******************************************************************27530599
275306 9999-DATE-ROUTINE-DECR-DAYS.                                     27530699
275307     MOVE '9999-DATE-ROUTINE-DECR-DAYS' TO PV-PARAGRAPH-NAME.     27530799
275308                                                                  27530899
275309     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              27530999
275310                                                                  27531099
275320     SET DPG51-FISCAL-454-CALENDAR   TO TRUE.                     27532099
275330     SET DPG51-DECREMENT-DATE        TO TRUE.                     27533099
275340     SET DPG52-LK-DTE-ISO-FMT        TO TRUE.                     27534099
275350     MOVE 1                          TO DPG51-INCR-DECR-DAYS-9.   27535099
275360     MOVE DF-DATE-1-10               TO DPG52-LK-DATE-INPUT.      27536099
275370                                                                  27537099
275380     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51                27538099
275390                                             DPG52                27539099
275400                                             DPG53                27540099
275500                                             DPG54                27550099
275600                                             DPG55                27560099
275700                                             DPG56.               27570099
275800     EVALUATE TRUE                                                27580099
275900        WHEN DPG54-NO-ERROR                                       27590099
276000             MOVE DPG55-DB2-ISO-DATE-FMT                          27600099
276100               TO DF-END-DATE-1-10                                27610099
276200        WHEN OTHER                                                27620099
276300             DISPLAY 'ERROR ROUTINE ABEND'                        27630099
276400     END-EVALUATE.                                                27640099
276401                                                                  27640199
276402******************************************************************27640200
276403*     SQL ABEND PARAGRAPH.                                        27640300
276404******************************************************************27640400
276405 9999-SQL-ABEND.                                                  27640500
276406     DISPLAY '** ABEND     **'.                                   27640600
276407     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        27640700
276408     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              27640800
276409     DISPLAY '** OPERATION ** = ' PV-OPERATION-MSG.               27640900
276410                                                                  27641000
276411******************************************************************27641100
276412* COPY BOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED     27641200
276413* TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS.      27641300
276414******************************************************************27641400
276415     COPY DPPD004.                                                27641500
276416     SET AC-DB2-ERROR TO TRUE.                                    27641600
276417     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         27641700
