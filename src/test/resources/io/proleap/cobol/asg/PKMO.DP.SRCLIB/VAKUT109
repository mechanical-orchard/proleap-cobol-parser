       IDENTIFICATION DIVISION.                                         00010000
W34517 PROGRAM-ID.              VAKUT109.                               00020004
       AUTHOR.                  ABRAHAM JACOB - IBM GLOBAL SERVICES.    00030000
       INSTALLATION.            KOHLS DEPARTMENT STORES.                00040000
       DATE-WRITTEN.            01/15/2003.                             00050000
       DATE-COMPILED.                                                   00060000
W34517****IMPORTANT*****************************************************00061000
W34517* THIS IS A CLONE OF THE INKUT109 CREATED FOR THE VA PROJECT     *00062000
W34517* THE MAJOR CHANGES ARE .....                                    *00063000
W34517******************************************************************00064000
      ******************************************************************00070000
      *                                                                *00080000
      *    CREATES ADJUSTED PHYSICAL INVENTORY FILE WHICH IS USED BY   *00090000
      *    INKRP102, INKRP109 AND INKRP111 TO GENERATE REPORTS.        *00100000
      *                                                                *00110000
      ******************** HISTORY OF CHANGES **************************00120000
      * CHG ID/                                                         00130000
      * WR/PROJ  DATE        DESCRIPTION OF CHANGES                     00140000
      * -------  ----------  ----------------------------------------   00150000
R03073* R03073   03/07/2003  MODIFY PROGRAM TO PERFORM A DISPLAY        00160000
R03073*                      THE ATTRIBUTES WHEN A SKU IS NOT FOUND     00170000
21732 * 21732    04/28/2003  ROD JANSSEN                                00180000
21732 *                      DAILY DETAIL STOCKROOM WITHDRAWAL & STORE  00190000
21732 *                      CORRECTIONS REPORT CREATION.               00200000
26600 * 26600    04/27/2004  PAUL KEBER                                 00210000
26600 *                      STORE NUMBER EXPANSION PROJECT CHANGES TO  00220000
26600 *                      REPLACE TSTR000 WITH XMT_LOC.              00230000
W27710* W27710   01/28/2005  ROD JANSSEN                                00240000
W27710*                      REMOVE CONTENTION WITH OTHER INVENTORY PGM 00250000
28545 *                                                                 00260000
28545 * W28545   08/10/2006  B. GRAHAM - STRATAGEM                      00270000
28545 *                      DEPARTMENT LEVEL INVENTORY PROJECT         00280000
28545 *                      JOIN TINVPAR TO TINCNTL                    00290000
28545 *                      REPLACE TSKXREF LOOKUP WITH PRICING MODULE 00300000
W34517* W34517  10-14-2008  INFOSYS    CLONE OF INKUT109 FOR VA         00331000
W34517*                                INVENTORY STREAM.                00332000
W33304* W33304   11/20/2008  SATHISH / INFOSYS                          00333002
W33304*                      HOLDING INVENTORY LEDGER OPEN ACROSS       00334002
W33304*                      PERIODS INVENTORY SHORTAGE REPORTING       00335002
      ******************************************************************00340000
                                                                        00350000
       ENVIRONMENT DIVISION.                                            00360000
       CONFIGURATION SECTION.                                           00370000
       INPUT-OUTPUT SECTION.                                            00380000
       FILE-CONTROL.                                                    00390000
           SELECT ADJ-PHY-INV-FILE                                      00400000
                  ASSIGN TO OUT01.                                      00410000
                                                                        00420000
       DATA DIVISION.                                                   00430000
       FILE SECTION.                                                    00440000
       FD  ADJ-PHY-INV-FILE                                             00450000
           LABEL RECORDS ARE OMITTED                                    00460000
           RECORDING MODE IS F                                          00470000
           BLOCK CONTAINS 0 RECORDS.                                    00480000
21732  01  ADJ-PHY-INV-SUMMARY-REC      PIC  X(100).                    00490000
                                                                        00500000
       EJECT                                                            00510000
                                                                        00520000
       WORKING-STORAGE SECTION.                                         00530000
                                                                        00540000
       01  ABEND-CODE                   PIC S9(04) VALUE 0 COMP SYNC.   00550000
                                                                        00560000
       01  PV-PROGRAM-VARIABLES.                                        00570000
           05  PV-PARA                  PIC  X(30) VALUE SPACES.        00580000
           05  PV-SKU                   PIC  9(08) VALUE ZERO.          00590000
           05  PV-SKU-R  REDEFINES PV-SKU.                              00600000
               10  PV-SKU-DEPT          PIC  9(03).                     00610000
               10  PV-SKU-CLASS         PIC  9(02).                     00620000
               10  PV-SKU-SEQ           PIC  9(03).                     00630000
           05  PV-PREV-SKU              PIC  9(08) VALUE ZERO.          00640000
           05  PV-DEPT                  PIC  9(04) VALUE ZERO.          00650000
           05  PV-PREV-DEPT             PIC  9(04) VALUE ZERO.          00660000
           05  PV-DEFAULT-DATE          PIC  X(10) VALUE '9999-09-09'.  00670000
           05  PV-DB2-OPER-ATTEMPTED    PIC  X(30) VALUE SPACES.        00680000
26600      05  PV-DB2-STORE             PIC S9(4) COMP VALUE ZEROS.     00690000
26600      05  PV-DB2-STORE-ZONED-NUM   PIC  9(05) VALUE ZERO.          00700000
21732      05  PV-DB2-AREA-NBR          PIC S9(9) COMP VALUE ZEROS.     00710000
21732      05  PV-DB2-SHEET-NBR         PIC S9(9) COMP VALUE ZEROS.     00720000
           05  PV-DB2-SKU               PIC S9(08)V COMP-3.             00730000
           05  PV-DB2-DEPT              PIC S9(04)V COMP-3.             00740000
           05  PV-DB2-STORE-TYPE        PIC X(02).                      00750000
           05  PV-DB2-ADJUST-TYPE       PIC X(02).                      00760000
           05  PV-DB2-INV-AMT           PIC S9(15) COMP-3.              00770000
           05  PV-DB2-EXTD-AMT          PIC S9(15)V99 COMP-3.           00780000
           05  PV-DB2-UNIT-PR-AMT       PIC S9(05)V99 COMP-3.           00790000
21732      05  PV-DB2-CRE-TMST-DATE     PIC X(10) VALUE SPACES.         00800000
           05  PV-DB2-TABLE-NAME        PIC X(06).                      00810000
W33304     05  PV-NULL                  PIC S9(04)  VALUE +0            00811005
W33304                                              COMP SYNC.          00812005
                                                                        00820000
       01  SWITCHES.                                                    00830000
           05  DRIVER-CURSOR-IND        PIC  X(01)  VALUE 'N'.          00840000
               88  END-OF-DRIVER-CURSOR             VALUE 'Y'.          00850000
           05  DETAIL-CURSOR-IND        PIC  X(01)  VALUE 'N'.          00860000
               88  BEG-OF-DETAIL-CURSOR             VALUE 'N'.          00870000
               88  END-OF-DETAIL-CURSOR             VALUE 'Y'.          00880000
                                                                        00890000
R03073 01  DISPLAY-FIELDS.                                              00900000
R03073     05  DF-QTY                   PIC ZZZ,ZZZ,ZZZ,ZZZ,ZZ9-.       00910000
R03073     05  DF-EXT-AMT               PIC ZZZ,ZZZ,ZZZ,ZZZ,ZZ9.99-.    00920000
21732      05  DF-AREA-NBR              PIC ZZZZZ9-.                    00930000
R03073     05  PF-UNIT-PR-AMT           PIC ZZ,ZZ9.99-.                 00940000
R03073                                                                  00950000
                                                                        00960000
      ** WORKING STORAGE COPYBOOK FOR PHYSICAL INVENTORY SUMMARY FILE.  00970000
      ***************************************************************** 00980000
                                                                        00990000
21732      COPY INRD109.                                                01000000
                                                                        01010000
28545 ***************************************************************** 01020000
28545 * COMMON PRICING WORKING STORAGE COPYBOOK                       * 01030000
28545 ***************************************************************** 01040000
28545                                                                   01050000
28545      COPY INWS400.                                                01060000
28545                                                                   01070000
                                                                        01080000
      ***************************************************************** 01090000
      * SQL ABEND ROUTINE WORKING STORAGE AND SQLCA                   * 01100000
      ***************************************************************** 01110000
                                                                        01120000
           COPY DPWS004.                                                01130000
           EXEC SQL                                                     01140000
                INCLUDE SQLCA                                           01150000
           END-EXEC.                                                    01160000
                                                                        01170000
           COPY SQLCA2.                                                 01180000
                                                                        01190000
      ***************************************************************** 01200000
      * DB2 DATE ATTRIBUTES TABLE DCLGEN                              * 01210000
      ***************************************************************** 01220000
           EXEC SQL                                                     01230000
                INCLUDE TDTATTR                                         01240000
           END-EXEC.                                                    01250000
      ***************************************************************** 01260000
26600 * DB2 XMT LOCATION TABLE DCLGEN                                 * 01270000
      ***************************************************************** 01280000
           EXEC SQL                                                     01290000
26600           INCLUDE XMT00001                                        01300000
           END-EXEC.                                                    01310000
28545 *                                                                 01320000
28545 ******************************************************************01330000
28545 *  DCLGEN FOR THE INVENTORY CONTROL TABLE.                        01340000
28545 ******************************************************************01350000
28545      EXEC SQL                                                     01360000
28545          INCLUDE TINCNTL                                          01370000
28545      END-EXEC.                                                    01380000
28545 *                                                                 01390000
      ***************************************************************** 01400000
      * DB2 INVENTORY PARAMETER TABLE DCLGEN                          * 01410000
      ***************************************************************** 01420000
           EXEC SQL                                                     01430000
                INCLUDE TINVPAR                                         01440000
           END-EXEC.                                                    01450000
      ***************************************************************** 01460000
      * DB2 SUMMARY INVENTORY TABLE DCLGEN                            * 01470000
      ***************************************************************** 01480000
           EXEC SQL                                                     01490000
                INCLUDE TSUMINV                                         01500000
           END-EXEC.                                                    01510000
      ***************************************************************** 01520000
      * DB2 STOCKROOM ADJUSTMENTS TABLE DCLGEN                        * 01530000
      ***************************************************************** 01540000
           EXEC SQL                                                     01550000
                INCLUDE TSTKRMW                                         01560000
           END-EXEC.                                                    01570000
      ***************************************************************** 01580000
      * DB2 AJUSTMENT DETAIL TABLE DCLGEN                             * 01590000
      ***************************************************************** 01600000
           EXEC SQL                                                     01610000
                INCLUDE TADJDTL                                         01620000
           END-EXEC.                                                    01630000
      ***************************************************************** 01640000
      * DB2 AJUSTMENT ADD TABLE DCLGEN                                * 01650000
      ***************************************************************** 01660000
           EXEC SQL                                                     01670000
                INCLUDE TADJADD                                         01680000
           END-EXEC.                                                    01690000
                                                                        01700000
      ** DRIVER CURSOR                                                  01710000
      ***************************************************************** 01720000
                                                                        01730000
           EXEC SQL                                                     01740000
                DECLARE  DRIVER_CURSOR CURSOR FOR                       01750000
26600            SELECT  A.LOC_NBR                                      01760000
26600                   ,A.LOC_TYP_CDE                                  01770000
28545                   ,B.PLND_INV_DTE                                 01780000
W33304                  ,C.PLND_FIN_BKG_DTE                             01790000
W33304                  ,C.INV_ID                                       01800000
W33304                  ,B.FINCL_INV_STAT_CDE                           01810000
26600              FROM  XMT_LOC A                                      01820000
                        ,TINVPAR B                                      01830000
28545                   ,TINCNTL C                                      01840000
26600             WHERE  A.LOC_NBR        = B.LOC_NBR                   01850000
26600               AND  A.LOC_TYP_CDE   IN ('DC','DS','RV','CS','DA')  01860000
W33304              AND  B.LOC_INV_STAT_CDE = 'IN'                      01870000
26600               AND  B.ACTL_FIN_BK_DTE  = '9999-09-09'              01880000
W33304              AND  B.PLND_INV_DTE <= :DTATTR-FSCL-MN-END-DTE      01920000
28545               AND B.INV_ID = C.INV_ID                             01930000
28545               AND C.ACTV_IND = 'Y'                                01940000
W33304              AND B.FINCL_INV_STAT_CDE IN ('BK','BD')             01950000
W27710            FOR FETCH ONLY                                        01960000
W27710            WITH UR                                               01970000
           END-EXEC.                                                    01980000
                                                                        01990000
      ** DETAIL CURSOR                                                  02000000
      ***************************************************************** 02010000
                                                                        02020000
           EXEC SQL                                                     02030000
                DECLARE  DETAIL_CURSOR CURSOR FOR                       02040000
26600            SELECT  LOC_NBR                                        02050000
21732                   ,AREA_NBR                                       02060000
21732                   ,+0                                             02070000
                        ,SKU_NBR                                        02080000
                        ,DEPT_NBR                                       02090000
                        ,' '                                            02100000
                        ,INV_QTY                                        02110000
                        ,EXTD_AMT                                       02120000
                        ,INV_UNIT_PR_AMT                                02130000
21732                   ,DATE(CHG_TMST)                                 02140000
                        ,'SUMINV'                                       02150000
                   FROM  TSUMINV                                        02160000
26600             WHERE  LOC_NBR = :SUMINV-LOC-NBR                      02170000
                                                                        02180000
                  UNION  ALL                                            02190000
                                                                        02200000
26600            SELECT  LOC_NBR                                        02210000
21732                   ,+0                                             02220000
21732                   ,SHEET_NBR                                      02230000
                        ,SKU_NBR                                        02240000
                        ,+0                                             02250000
                        ,' '                                            02260000
                        ,INV_QTY                                        02270000
                        ,ITM_EXTD_AMT                                   02280000
                        ,ITM_UNIT_PR_AMT                                02290000
21732                   ,DATE(CHG_TMST)                                 02300000
                        ,'STKRMW'                                       02310000
                   FROM  TSTKRMW                                        02320000
26600             WHERE  LOC_NBR = :STKRMW-LOC-NBR                      02330000
                                                                        02340000
                  UNION  ALL                                            02350000
                                                                        02360000
26600            SELECT  LOC_NBR                                        02370000
21732                   ,AREA_NBR                                       02380000
21732                   ,+0                                             02390000
                        ,SKU_NBR                                        02400000
                        ,+0                                             02410000
                        ,ADJ_TYPE_CDE                                   02420000
                        ,ADJ_QTY                                        02430000
                        ,ADJ_EXTD_AMT                                   02440000
                        ,+0                                             02450000
21732                   ,DATE(CRE_TMST)                                 02460000
                        ,'ADJDTL'                                       02470000
                   FROM  TADJDTL                                        02480000
26600             WHERE  LOC_NBR = :ADJDTL-LOC-NBR                      02490000
                                                                        02500000
                  UNION  ALL                                            02510000
                                                                        02520000
26600            SELECT  LOC_NBR                                        02530000
21732                   ,AREA_NBR                                       02540000
21732                   ,+0                                             02550000
                        ,SKU_NBR                                        02560000
                        ,+0                                             02570000
                        ,' '                                            02580000
                        ,ADJ_QTY                                        02590000
                        ,ADJ_EXTD_AMT                                   02600000
                        ,+0                                             02610000
21732                   ,DATE(CHG_TMST)                                 02620000
                        ,'ADJADD'                                       02630000
                   FROM  TADJADD                                        02640000
26600             WHERE  LOC_NBR = :ADJADD-LOC-NBR                      02650000
                                                                        02660000
                  ORDER  BY LOC_NBR                                     02670000
                                                                        02680000
W27710         FOR FETCH ONLY                                           02690000
W27710         WITH UR                                                  02700000
W27710                                                                  02710000
           END-EXEC.                                                    02720000
                                                                        02730000
       LINKAGE SECTION.                                                 02740000
                                                                        02750000
       EJECT                                                            02760000
                                                                        02770000
       PROCEDURE DIVISION.                                              02780000
                                                                        02790000
      ******************************************************************02800000
      *                                                                *02810000
      *                  ***   MAIN PROCESSING   ***                   *02820000
      *                                                                *02830000
      *  PROGRAM LOGIC :                                               *02840000
      *                                                                *02850000
      *    - GET OPEN FICSAL MONTH DATE FROM TMLCNTL TABLE.            *02860000
      *    - GET FISCAL MONTH BEGIN DATE AND END DATE FROM TDTATTR     *02870000
      *      TABLE BY USING OPEN FISCAL MONTH DATE.                    *02880000
      *    - USING DRIVER CURSOR, GET ALL THE STORES WHOSE PLANNED     *02890000
      *      INVENTORY DATE IS BETWEEN FISCAL MONTH BEGIN DATE AND     *02900000
      *      FISCAL MONTH END DATE.                                    *02910000
      *    - USING DETAIL CURSOR, GET ALL THE SKU AND OTHER FIELDS FOR *02920000
      *      EACH STORE AND WRITE INTO THE FILE.  THE FIELDS ARE       *02930000
      *      RETRIEVED FROM TABLES TSUMINV, TSTKRMW, TADJDTL AND       *02940000
      *      TADJADD.                                                  *02950000
      *    - IF DEPARTMENT IS NOT PRESENT IN TABLE, THEN               *02960000
28545 *      COMMON PRICING ROUTINE (ATTRIBUTE LOOK UP) IS USED. IF    *02970000
      *      NOT FOUND, '????' IS MOVED INTO DEPARTMENT FIELD TO SHOW  *02980000
      *      THAT DEPARTMENT IS UNKNOWN.                               *02990000
      *                                                                *03000000
      ******************************************************************03010000
       A100-MAIN-MODULE.                                                03020000
                                                                        03030000
           PERFORM B100-HOUSEKEEPING.                                   03040000
                                                                        03050000
           PERFORM B200-GENERATE-TABLE                                  03060000
             UNTIL END-OF-DRIVER-CURSOR.                                03070000
                                                                        03080000
           PERFORM B400-EOJ.                                            03090000
                                                                        03100000
           STOP RUN.                                                    03110000
                                                                        03120000
      ******************************************************************03130000
      *  OPEN THE ADJ-PHY-INVFILE, GET FISCAL MONTH BEGIN DATE AND     *03140000
      *  FISCAL MONTH END DATE AND OPEN THE DRIVER CURSOR              *03150000
      ******************************************************************03160000
       B100-HOUSEKEEPING.                                               03170000
                                                                        03180000
           MOVE '*B100-HOUSEKEEPING           *' TO  PV-PARA.           03190000
                                                                        03200000
           OPEN OUTPUT ADJ-PHY-INV-FILE.                                03210000
                                                                        03220000
           PERFORM Z025-GET-OPEN-FSCL-MN.                               03230000
                                                                        03240000
           IF  NOT END-OF-DRIVER-CURSOR                                 03250000
               PERFORM Z050-GET-OPEN-DATE-ATTRIBUTES                    03260000
           END-IF.                                                      03270000
                                                                        03280000
           IF  NOT END-OF-DRIVER-CURSOR                                 03290000
               EXEC SQL                                                 03300000
                    OPEN DRIVER_CURSOR                                  03310000
               END-EXEC                                                 03320000
                                                                        03330000
               EVALUATE SQLCODE                                         03340000
                   WHEN +0                                              03350000
                        PERFORM Z100-FETCH-STORE                        03360000
                   WHEN +100                                            03370000
                        SET END-OF-DRIVER-CURSOR   TO TRUE              03380000
                   WHEN OTHER                                           03390000
                        MOVE 'B100-HOUSEKEEPING'   TO PV-PARA           03400000
                        MOVE 'OPEN DRIVER CURSOR'  TO                   03410000
                              PV-DB2-OPER-ATTEMPTED                     03420000
                        PERFORM Z900-SQL-ABEND                          03430000
               END-EVALUATE                                             03440000
           END-IF.                                                      03450000
                                                                        03460000
      ******************************************************************03470000
      *  OPEN AND CLOSE THE DETAIL CURSOR.  FETCH ALL THE ROWS FOR THE *03480000
      *  STORE.                                                        *03490000
      ******************************************************************03500000
       B200-GENERATE-TABLE.                                             03510000
                                                                        03520000
           MOVE '*B200-GENERATE-TABLE       *' TO PV-PARA.              03530000
           MOVE  PV-SKU                        TO PV-PREV-SKU.          03540000
                                                                        03550000
           EXEC SQL                                                     03560000
                OPEN DETAIL_CURSOR                                      03570000
           END-EXEC.                                                    03580000
                                                                        03590000
           EVALUATE SQLCODE                                             03600000
               WHEN +0                                                  03610000
                    SET BEG-OF-DETAIL-CURSOR   TO TRUE                  03620000
                    PERFORM Z200-FETCH-DETAIL                           03630000
                    UNTIL END-OF-DETAIL-CURSOR                          03640000
               WHEN OTHER                                               03650000
                    MOVE 'B200-GENERATE-TABLE' TO PV-PARA               03660000
                    MOVE 'OPEN DETAIL CURSOR'  TO                       03670000
                          PV-DB2-OPER-ATTEMPTED                         03680000
                    PERFORM Z900-SQL-ABEND                              03690000
           END-EVALUATE.                                                03700000
                                                                        03710000
           EXEC SQL                                                     03720000
                CLOSE DETAIL_CURSOR                                     03730000
           END-EXEC.                                                    03740000
                                                                        03750000
           EVALUATE SQLCODE                                             03760000
               WHEN +0                                                  03770000
                    SET END-OF-DETAIL-CURSOR   TO TRUE                  03780000
               WHEN OTHER                                               03790000
                    MOVE 'B200-GENERATE-TABLE' TO PV-PARA               03800000
                    MOVE 'CLOSE DETAIL CURSOR' TO                       03810000
                          PV-DB2-OPER-ATTEMPTED                         03820000
                    PERFORM Z900-SQL-ABEND                              03830000
           END-EVALUATE.                                                03840000
                                                                        03850000
           PERFORM Z100-FETCH-STORE.                                    03860000
                                                                        03870000
      ******************************************************************03880000
      *  WRITE THE RECORD INTO ADJ-PHY-INV-SUMMARY-REC FILE.           *03890000
      ******************************************************************03900000
       B300-WRITE-RECORDS.                                              03910000
                                                                        03920000
           MOVE '*B300-WRITE-RECORDS          *' TO PV-PARA             03930000
                                                                        03940000
26600      MOVE  PV-DB2-STORE-ZONED-NUM                                 03950000
26600                                 TO IN109-STORE-NBR.               03960000
21732      MOVE  PV-DB2-AREA-NBR      TO IN109-AREA-NBR.                03970000
21732      MOVE  PV-DB2-SHEET-NBR     TO IN109-SHEET-NBR.               03980000
           MOVE  PV-DB2-STORE-TYPE    TO IN109-STORE-TYPE.              03990000
           MOVE  PV-DB2-SKU           TO IN109-SKU.                     04000000
           MOVE  PV-DB2-ADJUST-TYPE   TO IN109-ADJUST-TYPE-CODE.        04010000
           MOVE  PV-DB2-INV-AMT       TO IN109-INV-QTY.                 04020000
           MOVE  PV-DB2-EXTD-AMT      TO IN109-EXTD-AMT.                04030000
           MOVE  PV-DB2-UNIT-PR-AMT   TO IN109-UNIT-PR-AMT.             04040000
21732      MOVE  PV-DB2-CRE-TMST-DATE TO IN109-CREATE-DATE.             04050000
           MOVE  PV-DB2-TABLE-NAME    TO IN109-TABLE-NAME.              04060000
                                                                        04070000
           IF  PV-DEPT = 0                                              04080000
               MOVE '????'            TO IN109-DEPT                     04081004
R03073         DISPLAY ' UNKNOWN DEPARTMENT FOR '                       04082004
26600          DISPLAY ' STORE      : ', PV-DB2-STORE-ZONED-NUM         04083004
21732                                                                   04084004
21732          MOVE  PV-DB2-AREA-NBR  TO DF-AREA-NBR                    04085004
21732          DISPLAY ' AREA NBR   : ', DF-AREA-NBR                    04086004
21732          MOVE  PV-DB2-SHEET-NBR TO DF-AREA-NBR                    04087004
21732          DISPLAY ' SHEET NBR  : ', DF-AREA-NBR                    04088004
21732                                                                   04089004
R03073         DISPLAY ' SKU        : ', PV-DB2-SKU                     04089104
R03073         MOVE  PV-DB2-INV-AMT   TO DF-QTY                         04089204
R03073         DISPLAY ' QTY        : ', DF-QTY                         04089304
R03073         MOVE  PV-DB2-EXTD-AMT  TO DF-EXT-AMT                     04089404
R03073         DISPLAY ' EXTD AMT   : ', DF-EXT-AMT                     04089504
R03073         MOVE  PV-DB2-UNIT-PR-AMT TO PF-UNIT-PR-AMT               04089604
R03073         DISPLAY ' UNIT PRICE : ', PF-UNIT-PR-AMT                 04089704
21732          DISPLAY ' CRE TMST   : ', PV-DB2-CRE-TMST-DATE           04089804
R03073         DISPLAY ' TABLE      : ', PV-DB2-TABLE-NAME              04089904
           ELSE                                                         04270000
               MOVE PV-DEPT           TO IN109-DEPT                     04280000
           END-IF.                                                      04290000
                                                                        04300000
           WRITE ADJ-PHY-INV-SUMMARY-REC                                04310000
            FROM IN109-PHY-IN-SUMMARY-RECORD.                           04320000
                                                                        04330000
      ******************************************************************04340000
      *  CLOSE DRIVER CURSOR AND ADJ-PHY-INV-FILE FILE.                *04350000
      ******************************************************************04360000
       B400-EOJ.                                                        04370000
                                                                        04380000
           EXEC SQL                                                     04390000
                CLOSE DRIVER_CURSOR                                     04400000
           END-EXEC.                                                    04410000
                                                                        04420000
           EVALUATE SQLCODE                                             04430000
               WHEN +0                                                  04440000
W33304         WHEN -501                                                04441008
                    CONTINUE                                            04450000
               WHEN OTHER                                               04460000
                    MOVE 'B400-EOJ           ' TO PV-PARA               04470000
                    MOVE 'CLOSE DRIVER CURSOR' TO                       04480000
                          PV-DB2-OPER-ATTEMPTED                         04490000
                    PERFORM Z900-SQL-ABEND                              04500000
           END-EVALUATE.                                                04510000
                                                                        04520000
           CLOSE ADJ-PHY-INV-FILE.                                      04530000
                                                                        04540000
      ******************************************************************04550000
      *  GET THE OPEN FISCAL MONTH AND THE OPEN FISCAL MONTH NUMBER    *04560000
      *  FROM TMLCNTL TABLE.                                           *04570000
      ******************************************************************04580000
       Z025-GET-OPEN-FSCL-MN.                                           04590000
                                                                        04600000
           MOVE '*Z025-GET-OPEN-FSCL-MN.      *' TO PV-PARA             04610000
                                                                        04620000
           EXEC SQL                                                     04630000
W33304          SELECT  MAX(OPN_FSCL_MN_DTE)                            04640000
W33304            INTO  :INCNTL-OPN-FSCL-MN-DTE :PV-NULL                04650005
W33304            FROM  TINCNTL                                         04660000
W33304           WHERE  ACTV_IND = 'Y'                                  04670000
W27710           WITH UR                                                04680000
           END-EXEC.                                                    04690000
                                                                        04700000
           EVALUATE SQLCODE                                             04710000
               WHEN +0                                                  04720007
W33304         DISPLAY 'INCNTL-OPN-FSCL-MN-DTE ', INCNTL-OPN-FSCL-MN-DTE04730003
W33304         IF PV-NULL = -1                                          04731007
W33304              SET END-OF-DRIVER-CURSOR   TO TRUE                  04731207
W33304         END-IF                                                   04732007
               WHEN +100                                                04740000
                    SET END-OF-DRIVER-CURSOR   TO TRUE                  04750000
               WHEN OTHER                                               04760000
                    MOVE 'Z025-GET-OPEN-FSCL-MN'                        04770000
                                               TO PV-PARA               04780000
W33304              MOVE 'SELECT ROW FROM TINCNTL'                      04790003
                                               TO PV-DB2-OPER-ATTEMPTED 04800000
                    PERFORM Z900-SQL-ABEND                              04810000
           END-EVALUATE.                                                04820000
                                                                        04830000
      ******************************************************************04840000
      *  GET THE FISCAL MONTH BEGIN DATE AND FISCAL MONTH END DATE     *04850000
      *  FROM TDTATTR TABLE.                                           *04860000
      ******************************************************************04870000
       Z050-GET-OPEN-DATE-ATTRIBUTES.                                   04880000
                                                                        04890000
           MOVE '*Z050-GET-OPEN-DATE-ATTRIBUTES.   *' TO PV-PARA        04900000
                                                                        04910000
           EXEC SQL                                                     04920000
W33304          SELECT FSCL_MN_END_DTE                                  04930000
W33304            INTO :DTATTR-FSCL-MN-END-DTE                          04940000
W33304            FROM  TDTATTR                                         04950000
W33304           WHERE  KY_DTE = :INCNTL-OPN-FSCL-MN-DTE                04960000
W27710           WITH UR                                                04970000
           END-EXEC                                                     04980000
                                                                        04990000
           EVALUATE SQLCODE                                             05000000
               WHEN +0                                                  05010000
                    DISPLAY 'DTATTR-FSCL-MN-END-DTE ',                  05040000
                             DTATTR-FSCL-MN-END-DTE                     05050000
               WHEN +100                                                05060000
                    SET END-OF-DRIVER-CURSOR   TO TRUE                  05070000
               WHEN OTHER                                               05080000
                    MOVE 'Z050-GET-OPEN-DATE-ATTRIBUTES'                05090000
                                               TO PV-PARA               05100000
                    MOVE 'SELECT ROW FROM TDTATTR'                      05110000
                                               TO PV-DB2-OPER-ATTEMPTED 05120000
                    PERFORM Z900-SQL-ABEND                              05130000
           END-EVALUATE.                                                05140000
                                                                        05150000
      ******************************************************************05160000
      *  FETCH THE STORE FOR WHOSE PLANNED INVENTORY DATE IS BETWEEN   *05170000
      *  FISCAL MONTH BEGIN DATE AND FISCAL MONTH END DATE.            *05180000
      ******************************************************************05190000
       Z100-FETCH-STORE.                                                05200000
                                                                        05210000
           MOVE  '*Z100-FETCH-STORE         *' TO PV-PARA.              05220000
                                                                        05230000
           EXEC SQL                                                     05240000
                FETCH  DRIVER_CURSOR                                    05250000
                 INTO  :PV-DB2-STORE                                    05260000
                      ,:PV-DB2-STORE-TYPE                               05270000
                      ,:INVPAR-PLND-INV-DTE                             05280000
W33304                ,:IN109-PLND-FIN-BK-DTE                           05290000
W33304                ,:IN109-INV-ID                                    05300000
W33304                ,:IN109-FINCL-INV-STAT-CDE                        05310000
           END-EXEC.                                                    05320000
                                                                        05330000
           EVALUATE SQLCODE                                             05340000
               WHEN +0                                                  05350000
26600               MOVE  PV-DB2-STORE         TO SUMINV-LOC-NBR        05360000
                                                  STKRMW-LOC-NBR        05370000
                                                  ADJDTL-LOC-NBR        05380000
                                                  ADJADD-LOC-NBR        05390000
26600                                             PV-DB2-STORE-ZONED-NUM05400000
26600               MOVE  PV-DB2-STORE-ZONED-NUM                        05410000
26600                                          TO IN109-STORE-NBR       05420000
                    MOVE  PV-DB2-STORE-TYPE    TO IN109-STORE-TYPE      05430000
               WHEN +100                                                05440000
                    SET END-OF-DRIVER-CURSOR   TO TRUE                  05450000
               WHEN OTHER                                               05460000
                    MOVE '*Z100-FETCH STORE *' TO PV-PARA               05470000
                    MOVE 'FETCH ROW FROM DRIVER CURSOR'                 05480000
                                               TO PV-DB2-OPER-ATTEMPTED 05490000
                    PERFORM Z900-SQL-ABEND                              05500000
           END-EVALUATE.                                                05510000
                                                                        05520000
      ******************************************************************05530000
      *  FETCH THE FIELDS FOR THE DETAIL CURSOR. IF DEPARTMENT IS ZERO *05540000
      *  TSKXREF OR TUPC/TMDARVS TABLES ARE SEARCHED TO GET DEPARTMENT.*05550000
      ******************************************************************05560000
       Z200-FETCH-DETAIL.                                               05570000
                                                                        05580000
           MOVE  '*Z200-FETCH-DETAIL           *' TO PV-PARA.           05590000
           MOVE  PV-SKU                           TO PV-PREV-SKU.       05600000
           MOVE  PV-DEPT                          TO PV-PREV-DEPT.      05610000
                                                                        05620000
           INITIALIZE PV-DB2-STORE,                                     05630000
21732                 PV-DB2-AREA-NBR,                                  05640000
21732                 PV-DB2-SHEET-NBR,                                 05650000
                      PV-DB2-SKU,                                       05660000
                      PV-DB2-DEPT,                                      05670000
                      PV-DB2-ADJUST-TYPE,                               05680000
                      PV-DB2-INV-AMT,                                   05690000
                      PV-DB2-EXTD-AMT,                                  05700000
21732                 PV-DB2-CRE-TMST-DATE,                             05710000
                      PV-DB2-TABLE-NAME.                                05720000
                                                                        05730000
           EXEC SQL                                                     05740000
                FETCH  DETAIL_CURSOR                                    05750000
                 INTO  :PV-DB2-STORE                                    05760000
21732                 ,:PV-DB2-AREA-NBR                                 05770000
21732                 ,:PV-DB2-SHEET-NBR                                05780000
                      ,:PV-DB2-SKU                                      05790000
                      ,:PV-DB2-DEPT                                     05800000
                      ,:PV-DB2-ADJUST-TYPE                              05810000
                      ,:PV-DB2-INV-AMT                                  05820000
                      ,:PV-DB2-EXTD-AMT                                 05830000
                      ,:PV-DB2-UNIT-PR-AMT                              05840000
21732                 ,:PV-DB2-CRE-TMST-DATE                            05850000
                      ,:PV-DB2-TABLE-NAME                               05860000
           END-EXEC.                                                    05870000
                                                                        05880000
           EVALUATE SQLCODE                                             05890000
               WHEN +0                                                  05900000
26600               MOVE PV-DB2-STORE          TO PV-DB2-STORE-ZONED-NUM05910000
                    MOVE PV-DB2-SKU            TO PV-SKU,               05920000
                                                  IN109-SKU             05930000
                    MOVE PV-DB2-DEPT           TO PV-DEPT               05940000
                    IF  PV-DEPT = 0                                     05950000
                        IF  PV-SKU NOT EQUAL       TO PV-PREV-SKU       05960000
                            IF  PV-SKU-SEQ = 000                        05970000
                            OR  PV-SKU-SEQ = 999                        05980000
                                MOVE  PV-SKU-DEPT  TO PV-DEPT           05990000
                            ELSE                                        06000000
                                PERFORM Z300-GET-DEPT                   06010000
                            END-IF                                      06020000
                        ELSE                                            06030000
                            MOVE  PV-PREV-DEPT     TO PV-DEPT           06040000
                        END-IF                                          06050000
                    END-IF                                              06060000
                    PERFORM B300-WRITE-RECORDS                          06070000
               WHEN +100                                                06080000
                    SET END-OF-DETAIL-CURSOR   TO TRUE                  06090000
               WHEN OTHER                                               06100000
                    MOVE '*Z200-FETCH-DETAIL*' TO PV-PARA               06110000
                    MOVE 'FETCH ROW FROM DETAIL CURSOR'                 06120000
                                               TO PV-DB2-OPER-ATTEMPTED 06130000
                    PERFORM Z900-SQL-ABEND                              06140000
           END-EVALUATE.                                                06150000
                                                                        06160000
      ******************************************************************06170000
      *  GET THE DEPARTMENT NUMBER FROM TSKXREF TABLE BY GIVING SKU.   *06180000
      *  IF  ROW DOES NOT EXIST IN TSKXREF, TUPC/TMDARVS TABLES ARE    *06190000
      *  SEARCHED TO GET DEPARTMENT.                                   *06200000
      ******************************************************************06210000
       Z300-GET-DEPT.                                                   06220000
P28545                                                                  06230000
P28545     INITIALIZE IN400-PV-INPUT-AREA.                              06240000
P28545                                                                  06250000
P28545     SET IN400-PV-SKU-ATTRIB-LOOK TO TRUE.                        06260000
P28545     MOVE PV-DB2-STORE        TO IN400-PV-LOC-IN.                 06270000
P28545     MOVE INVPAR-PLND-INV-DTE TO IN400-PV-EFF-DTE-IN.             06280000
P28545     MOVE PV-DB2-SKU          TO IN400-PV-SKU-IN.                 06290000
P28545                                                                  06300000
P28545     PERFORM IN400-LOOKUP-RETAIL.                                 06310000
P28545                                                                  06320000
P28545     IF IN400-PV-ATT-FOUND                                        06330000
P28545         MOVE IN400-ATT-DEPT-OUT TO PV-DEPT                       06340000
P28545                                    PV-DB2-DEPT                   06350000
P28545     ELSE                                                         06360000
P28545         MOVE 0                 TO PV-DEPT                        06370000
P28545     END-IF.                                                      06380000
                                                                        06390000
      ******************************************************************06400000
      *  STANDARD DB2 ERROR ABEND ROUTINE                              *06410000
      *  THIS ROUTINE FORCES AN ABEND DUE TO A DB2 PROBLEM.            *06420000
      ******************************************************************06430000
       Z900-SQL-ABEND.                                                  06440000
                                                                        06450000
           MOVE +4013                 TO ABEND-CODE.                    06460000
           DISPLAY '**  ABEND     **'.                                  06470000
           DISPLAY '**  PROGRAM   **  =  VAKUT109'.                     06480001
           DISPLAY '**  PARAGRAPH **  = ' PV-PARA.                      06490000
           DISPLAY '**  OPERATION **  = ' PV-DB2-OPER-ATTEMPTED.        06500000
                                                                        06510000
      *    THE FOLLOWING COPYBOOK UTILIZES THE DB2 ABEND MODULE         06520000
      *    DSNTIAR TO CONVERT SQLCA INTO UNDERSTANDABLE VERBAGE.        06530000
                                                                        06540000
           COPY DPPD004.                                                06550000
                                                                        06560000
           CALL 'ILBOABN0'  USING ABEND-CODE.                           06570000
W28545/                                                                 06580000
W28545*----------------------------------------------------------------*06590000
W28545*    PRICE LOOK-UP PROCEDURE DIVISION COPYBOOK                    06600000
W28545*----------------------------------------------------------------*06610000
W28545                                                                  06620000
W28545     COPY INPD400.                                                06630000
