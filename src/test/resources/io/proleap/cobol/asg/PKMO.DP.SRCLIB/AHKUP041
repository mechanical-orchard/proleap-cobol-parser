000100 IDENTIFICATION DIVISION.                                         00010005
000200 PROGRAM-ID.         AHKUP041.                                    00020005
000300 AUTHOR.             NANCY EILBES.                                00030005
000400 DATE-WRITTEN.       APRIL 2000.                                  00040005
000500 DATE-COMPILED.                                                   00050005
000600*************************************************************     00060005
000700*    COBOL 2 WITH SQL                                       *     00070005
000800*                                                           *     00080005
000900*   AHKUP041 - ARCHIVE HISTORY DATA DELETION - TRECEIV      *     00090005
001000*                                                           *     00100005
001100*   PROGRAM OVERVIEW:                                       *     00110005
001200*                                                           *     00120005
001300*  THIS PROGRAM DELETES "OLD" ROWS FROM DB2 TABLE TRECEIV.  *     00130005
001400*  ROWS DELETED ARE THOSE PREVIOUSLY - IDENTIFIED/EXTRACTED *     00140005
001500*  WITHIN THE ARCHIVE/HISTORY SYSTEM.                       *     00150005
001600*                                                           *     00160005
001700*  THE EXTRACT FILE USED AS INPUT WILL BE SORTED BY THE     *     00170005
001800*  CLUSTERING INDEX COLUMNS TO SPEED THE DELETION PROCESS.  *     00180005
001900*  THESE COLUMNS ARE OPER_UNT_ID, FCLTY_ID, ORD_NBR,        *     00190005
002000*  REC_SEQ_NBR.                                             *     00200005
002100*                                                           *     00210005
002200*   INPUT:                                                  *     00220005
002300*                                                           *     00230005
002400*     1. TRECEIV DELETION FILE  COPYBOOK DCLTRECEIV         *     00240005
002500*                                                           *     00250005
002600*   DB2 TABLES:                                             *     00260005
002700*                                                           *     00270005
002800*        TRECEIV - RECEIVING HEADER TABLE                   *     00280005
002900*        TCKRSTIN - CHECKPOINT/RESTART INFO TABLE           *     00290005
003000*        TCKRSTCN - CHECKPOINT/RESTART CONTROL TABLE        *     00300005
003100*                                                           *     00310005
003200*************************************************************     00320005
003300*                                                           *     00330005
003400*************************************************************     00340005
003500 EJECT                                                            00350005
003600 ENVIRONMENT DIVISION.                                            00360005
003700 CONFIGURATION SECTION.                                           00370005
003800 SOURCE-COMPUTER.        IBM-370.                                 00380005
003900 OBJECT-COMPUTER.        IBM-370.                                 00390005
004000                                                                  00400005
004100 INPUT-OUTPUT SECTION.                                            00410005
004200 FILE-CONTROL.                                                    00420005
004300     SELECT TRECEIV-EXTRACT-FILE ASSIGN TO INP01.                 00430005
004400                                                                  00440005
004500 DATA DIVISION.                                                   00450005
004600 FILE SECTION.                                                    00460005
004700 FD  TRECEIV-EXTRACT-FILE                                         00470005
004800     RECORDING MODE IS F                                          00480005
004900     LABEL RECORDS ARE STANDARD                                   00490005
005000     BLOCK CONTAINS 0 RECORDS                                     00500005
005100     RECORD CONTAINS 337 CHARACTERS                               00510005
005200     DATA RECORD IS TRECEIV-EXTRACT-DATA.                         00520005
005300 01  TRECEIV-EXTRACT-DATA       PIC X(337).                       00530005
005400                                                                  00540005
005500                                                                  00550005
005600 EJECT                                                            00560005
005700 WORKING-STORAGE SECTION.                                         00570005
005800                                                                  00580005
005900 01  FILLER                       PIC X(58)     VALUE             00590005
006000     '************WORKING STORAGE STARTS HERE*******************'.00600005
006100                                                                  00610005
006200 01  PV-PROGRAM-VARIABLES.                                        00620005
006300     05  PV-PROGRAM-NAME          PIC X(08)    VALUE 'AHKUP041'.  00630005
006400     05  PV-CKPT-STAT-CODE        PIC X(01)    VALUE SPACE.       00640005
006500     05  PV-CURRENT-PARAGRAPH     PIC X(50)    VALUE SPACES.      00650005
006600     05  PV-CURRENT-TMST          PIC X(26)    VALUE SPACES.      00660005
006700                                                                  00670005
006800     05  PV-TRECEIV-INPUT-COUNT   PIC 9(09)    VALUE ZERO         00680005
006900                                               COMP-3.            00690005
007000     05  PV-TRECEIV-DELETE-COUNT  PIC 9(09)    VALUE ZERO         00700005
007100                                               COMP-3.            00710005
007200     05  PV-SQL-DELETE-COUNT      PIC 9(09)    VALUE ZERO         00720005
007300                                               COMP-3.            00730005
007400     05  PV-SQLERRD3              PIC S9(09)   VALUE ZERO         00740005
007500                                               COMP-3.            00750005
007600     05  PV-DISP-ORD-NBR          PIC X(09)    VALUE SPACES.      00760005
007700     05  PV-DISP-REC-SEQ-NBR      PIC X(09)    VALUE SPACES.      00770005
007800     05  PV-DISP-OPER-UNT-ID      PIC X(09)    VALUE SPACES.      00780005
007900     05  PV-DISP-FCLTY-ID         PIC X(09)    VALUE SPACES.      00790005
008000 01  PC-PROGRAM-CONSTANTS.                                        00800005
008100     05  PC-RETRY-MAX             PIC S9(04)    VALUE +3          00810005
008200                                                COMP SYNC.        00820005
008300     05  PC-RETRY-COUNT           PIC S9(04)    VALUE ZEROS.      00830005
008400     05  PC-IN-PROCESS-CODE       PIC X(01)     VALUE '9'.        00840005
008500     05  PC-RUN-COMPLETE-CODE     PIC X(01)     VALUE '0'.        00850005
008600                                                                  00860005
008700 01  PS-PROGRAM-SWITCHES.                                         00870005
008800     05  PS-COMMITS-TAKEN-SW      PIC  X(01)    VALUE 'N'.        00880005
008900         88  COMMITS-TAKEN                      VALUE 'T'.        00890005
009000         88  NO-COMMITS-TAKEN                   VALUE 'N'.        00900005
009100     05  PS-END-EXTRACT-SW        PIC  X(01)    VALUE 'M'.        00910005
009200         88  MORE-EXTRACT                       VALUE 'M'.        00920005
009300         88  END-OF-EXTRACT                     VALUE 'E'.        00930005
009400     05  PS-RUN-TYPE-SW           PIC  X(01)    VALUE ' '.        00940005
009500         88  NORMAL-RUN                         VALUE '0'.        00950005
009600         88  RESTART-RUN                        VALUE '9'.        00960005
009700                                                                  00970005
009800 01  WS-COUNTER.                                                  00980005
009900     05  WS-HOLD-TMST             PIC X(26)     VALUE SPACES.     00990005
010000     05  WS-TMST                  PIC X(26)     VALUE SPACES.     01000005
010100                                                                  01010005
010200 01  CKPT-RESTART-INFO.                                           01020005
010300     05  CR-EXTRACT-RECS-WORKED   PIC  9(9)     VALUE ZERO.       01030005
010400                                                                  01040005
010500*----------------------------------------------------------------*01050005
010600*  ABEND DATA AREAS                                              *01060005
010700*----------------------------------------------------------------*01070005
010800 01  ABEND-CODE                  PIC S9(04)  VALUE ZEROS          01080005
010900                                             COMP SYNC.           01090005
011000     88  AC-BAD-RECEIVE-DATA                 VALUE +4001.         01100005
011100     88  AC-BAD-DATA                         VALUE +4008.         01110005
011200     88  AC-DB2-ERROR                        VALUE +4013.         01120005
011300     88  AC-DATE-ERROR                       VALUE +4019.         01130005
011400                                                                  01140005
011500                                                                  01150005
011600 01  ABEND-AREAS.                                                 01160005
011700     05  AA-ABEND-LIT            PIC  X(40)  VALUE                01170005
011800             '*****       ABEND'.                                 01180005
011900     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                01190005
012000             '*****   PROGRAM: AHKUP041'.                         01200005
012100     05  AA-PARAGRAPH-LIT.                                        01210005
012200         10  FILLER              PIC  X(17)  VALUE                01220005
012300             '***** PARAGRAPH: '.                                 01230005
012400         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        01240005
012500     05  AA-MESSAGE-LINE-1.                                       01250005
012600         10  FILLER              PIC  X(06)  VALUE '*****'.       01260005
012700         10  AA-MESSAGE-1        PIC  X(127) VALUE SPACES.        01270005
012800     05  AA-MESSAGE-LINE-2.                                       01280005
012900         10  FILLER              PIC  X(06)  VALUE '*****'.       01290005
013000         10  AA-MESSAGE-2        PIC  X(127) VALUE SPACES.        01300005
013100     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                01310005
013200             '*****    DB2 ERROR'.                                01320005
013300     05  AA-DB2-OPERATION-LIT.                                    01330005
013400         10  FILLER              PIC  X(17)  VALUE                01340005
013500             '***** OPERATION: '.                                 01350005
013600         10  AA-DB2-OPERATION    PIC  X(50)  VALUE SPACES.        01360005
013700     05  AA-DB2-TABLE            PIC  X(08)  VALUE SPACES.        01370005
013800     EJECT                                                        01380005
013900                                                                  01390005
014000     COPY DPWS004.                                                01400005
014100     EJECT                                                        01410005
014200*----------------------------------------------------------------*01420005
014300*      TRECEIV TABLE LAYOUT                                       01430005
014400*----------------------------------------------------------------*01440005
014500         EXEC SQL                                                 01450005
014600             INCLUDE TRECEIV                                      01460005
014700         END-EXEC.                                                01470005
014800                                                                  01480005
014900*----------------------------------------------------------------*01490005
015000*      TCKRSTCNTL TABLE LAYOUT                                    01500005
015100*----------------------------------------------------------------*01510005
015200         EXEC SQL                                                 01520005
015300             INCLUDE TCKRSTCN                                     01530005
015400         END-EXEC.                                                01540005
015500                                                                  01550005
015600*----------------------------------------------------------------*01560005
015700*      TCKRSTINF TABLE LAYOUT                                     01570005
015800*----------------------------------------------------------------*01580005
015900         EXEC SQL                                                 01590005
016000             INCLUDE TCKRSTIN                                     01600005
016100         END-EXEC.                                                01610005
016200 EJECT                                                            01620005
016300*----------------------------------------------------------------*01630005
016400*  DB2 COMMUNICATION AREA                                         01640005
016500*----------------------------------------------------------------*01650005
016600*                                                                 01660005
016700     EXEC SQL                                                     01670005
016800         INCLUDE SQLCA                                            01680005
016900     END-EXEC.                                                    01690005
017000                                                                  01700005
017100*----------------------------------------------------------------*01710005
017200*  DB2 COMMUNICATION AREA2                                        01720005
017300*----------------------------------------------------------------*01730005
017400*                                                                 01740005
017500     COPY SQLCA2.                                                 01750005
017600     EJECT                                                        01760005
017700 PROCEDURE DIVISION.                                              01770005
017800 A100-MAINLINE-ROUTINE.                                           01780005
017900                                                                  01790005
018000     PERFORM B100-INITIALIZATION.                                 01800005
018100                                                                  01810005
018200     PERFORM B200-TRECEIV-EXTRACT-PROCESS                         01820005
018300       UNTIL END-OF-EXTRACT.                                      01830005
018400                                                                  01840005
018500     PERFORM B300-EOJ-PROCESSING.                                 01850005
018600                                                                  01860005
018700     GOBACK.                                                      01870005
018800 EJECT                                                            01880005
018900 B100-INITIALIZATION.                                             01890005
019000                                                                  01900005
019100     EXEC SQL                                                     01910005
019200         SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                 01920005
019300     END-EXEC.                                                    01930005
019400                                                                  01940005
019500     PERFORM X300-GET-CHECKPOINT-CNTL.                            01950005
019600     MOVE PV-CKPT-STAT-CODE TO PS-RUN-TYPE-SW.                    01960005
019700                                                                  01970005
019800     OPEN INPUT TRECEIV-EXTRACT-FILE.                             01980005
019900                                                                  01990005
020000     IF RESTART-RUN                                               02000005
020100         PERFORM X200-CHECKPOINT-RESTART                          02010005
020200     ELSE                                                         02020005
020300         PERFORM R100-READ-EXTRACT-FILE                           02030005
020400     END-IF.                                                      02040005
020500                                                                  02050005
020600     PERFORM X500-SET-CHECKPOINT-TIME.                            02060005
020700                                                                  02070005
020800                                                                  02080005
020900     EJECT                                                        02090005
021000 B200-TRECEIV-EXTRACT-PROCESS.                                    02100005
021100                                                                  02110005
021200     MOVE RECEIV-OPER-UNT-ID        TO PV-DISP-OPER-UNT-ID.       02120005
021300     MOVE RECEIV-FCLTY-ID           TO PV-DISP-FCLTY-ID.          02130005
021400     MOVE RECEIV-ORD-NBR            TO PV-DISP-ORD-NBR.           02140005
021500     MOVE RECEIV-REC-SEQ-NBR        TO PV-DISP-REC-SEQ-NBR.       02150005
021600                                                                  02160005
021700     PERFORM D100-DELETE-TRECEIV.                                 02170005
021800                                                                  02180005
021900     PERFORM X100-CHECKPOINT-CHECK.                               02190005
022000                                                                  02200005
022100     PERFORM R100-READ-EXTRACT-FILE.                              02210005
022200     EJECT                                                        02220005
022300                                                                  02230005
022400                                                                  02240005
022500 B300-EOJ-PROCESSING.                                             02250005
022600                                                                  02260005
022700     DISPLAY '** AHKUP041 SUMMARY **'.                            02270005
022800     DISPLAY '** TRECEIV INPUT COUNT = ' PV-TRECEIV-INPUT-COUNT.  02280005
022900     DISPLAY '** TRECEIV DELETE COUNT = ' PV-TRECEIV-DELETE-COUNT.02290005
023000     DISPLAY '** SQL DELETE COUNT = ' PV-SQL-DELETE-COUNT.        02300005
023100                                                                  02310005
023200     CLOSE  TRECEIV-EXTRACT-FILE.                                 02320005
023300                                                                  02330005
023400     MOVE PC-RUN-COMPLETE-CODE TO PV-CKPT-STAT-CODE.              02340005
023500     PERFORM X600-UPDATE-TCKRSTCNTL.                              02350005
023600                                                                  02360005
023700     EJECT                                                        02370005
023800*----------------------------------------------------------------*02380005
023900*    DELETES FROM THE TRECEIV TABLE.  CASCADE DELETE WILL ALSO   *02390005
024000*    CAUSE ROWS TO BE DELETED FROM TMIITEM, TVNDINV AND TEXINVC  *02400005
024100*    TABLES.                                                     *02410005
024200*----------------------------------------------------------------*02420005
024300 D100-DELETE-TRECEIV.                                             02430005
024400                                                                  02440005
024500     MOVE 'D100-DELETE-TRECEIV' TO PV-CURRENT-PARAGRAPH.          02450005
024600                                                                  02460005
024700     PERFORM WITH TEST AFTER                                      02470005
024800        VARYING PC-RETRY-COUNT FROM 1 BY 1                        02480005
024900          UNTIL PC-RETRY-COUNT > PC-RETRY-MAX                     02490005
025000             OR SQLCODE = ZERO                                    02500005
025100                                                                  02510005
025200         EXEC SQL                                                 02520005
025300              DELETE                                              02530005
025400                FROM TRECEIV                                      02540005
025500               WHERE OPER_UNT_ID = :RECEIV-OPER-UNT-ID            02550005
025600                 AND FCLTY_ID    = :RECEIV-FCLTY-ID               02560005
025700                 AND ORD_NBR     = :RECEIV-ORD-NBR                02570005
025800                 AND REC_SEQ_NBR = :RECEIV-REC-SEQ-NBR            02580005
025900         END-EXEC                                                 02590005
026000                                                                  02600005
026100         EVALUATE TRUE                                            02610005
026200             WHEN SQLCODE = ZERO                                  02620005
026300                 ADD 1 TO PV-TRECEIV-DELETE-COUNT                 02630005
026400                 MOVE SQLERRD(3) TO PV-SQLERRD3                   02640007
026500                 ADD PV-SQLERRD3 TO PV-SQL-DELETE-COUNT           02650005
026600                                                                  02660005
026700             WHEN SQLCODE = -904                                  02670005
026800             WHEN SQLCODE = -913                                  02680005
026900                  CONTINUE                                        02690005
027000                                                                  02700005
027100             WHEN SQLCODE = +100                                  02710005
027200                 MOVE PV-CURRENT-PARAGRAPH                        02720005
027300                                     TO AA-PARAGRAPH-NAME         02730005
027400                 DISPLAY '******** OPER UNT ID:'                  02740005
027500                          PV-DISP-OPER-UNT-ID                     02750005
027600                 DISPLAY '******** FCLTY ID:'                     02760005
027700                          PV-DISP-FCLTY-ID                        02770005
027800                 DISPLAY '******** ORD NBR:'                      02780005
027900                          PV-DISP-ORD-NBR                         02790005
028000                 DISPLAY '******** REC SEQ NBR:'                  02800005
028100                          PV-DISP-REC-SEQ-NBR                     02810005
028200                 MOVE 'ROW NOT ON TABLE ********'                 02820005
028300                          TO AA-MESSAGE-1                         02830005
028400                 MOVE SPACES TO AA-MESSAGE-2                      02840005
028500                 MOVE 'UNSUCCESSFUL DELETE'                       02850005
028600                          TO AA-DB2-OPERATION                     02860005
028700                 MOVE 'TRECEIV'  TO AA-DB2-TABLE                  02870005
028800                 PERFORM Z999-DB2-ABEND                           02880005
028900             WHEN SQLWARN0 NOT = SPACES                           02890005
029000             WHEN SQLCODE  NOT = ZERO                             02900005
029100                 MOVE PV-CURRENT-PARAGRAPH                        02910005
029200                                     TO AA-PARAGRAPH-NAME         02920005
029300                 DISPLAY '******** OPER UNT ID:'                  02930005
029400                          PV-DISP-OPER-UNT-ID                     02940005
029500                 DISPLAY '******** FCLTY ID:'                     02950005
029600                          PV-DISP-FCLTY-ID                        02960005
029700                 DISPLAY '******** ORD NBR:'                      02970005
029800                          PV-DISP-ORD-NBR                         02980005
029900                 DISPLAY '******** REC SEQ NBR:'                  02990005
030000                          PV-DISP-REC-SEQ-NBR                     03000005
030100                 MOVE SPACES TO AA-MESSAGE-1                      03010005
030200                                AA-MESSAGE-2                      03020005
030300                 MOVE 'UNSUCCESSFUL DELETE'                       03030005
030400                                     TO AA-DB2-OPERATION          03040005
030500                 MOVE 'TRECEIV'      TO AA-DB2-TABLE              03050005
030600                 PERFORM Z999-DB2-ABEND                           03060005
030700         END-EVALUATE                                             03070005
030800     END-PERFORM.                                                 03080005
030900                                                                  03090005
031000     IF PC-RETRY-COUNT > PC-RETRY-MAX                             03100005
031100         MOVE PV-CURRENT-PARAGRAPH                                03110005
031200                             TO AA-PARAGRAPH-NAME                 03120005
031300         DISPLAY '******** OPER UNT ID :'                         03130005
031400                          PV-DISP-OPER-UNT-ID                     03140005
031500         DISPLAY '******** FCLTY ID:'                             03150005
031600                          PV-DISP-FCLTY-ID                        03160005
031700         DISPLAY '******** ORD NBR:'                              03170005
031800                          PV-DISP-ORD-NBR                         03180005
031900         DISPLAY '******** REC SEQ NBR :'                         03190005
032000                          PV-DISP-REC-SEQ-NBR                     03200005
032100         MOVE SPACES TO AA-MESSAGE-1                              03210005
032200                        AA-MESSAGE-2                              03220005
032300         MOVE 'MAX RETRIES EXCEEDED ON DELETE'                    03230005
032400                             TO AA-DB2-OPERATION                  03240005
032500         MOVE 'TRECEIV'      TO AA-DB2-TABLE                      03250005
032600         PERFORM Z999-DB2-ABEND                                   03260005
032700     END-IF.                                                      03270005
032800                                                                  03280005
032900     EJECT                                                        03290005
033000 R100-READ-EXTRACT-FILE.                                          03300005
033100                                                                  03310005
033200     READ TRECEIV-EXTRACT-FILE                                    03320005
033300          INTO DCLTRECEIV                                         03330005
033400          AT END SET END-OF-EXTRACT TO TRUE.                      03340005
033500                                                                  03350005
033600     IF MORE-EXTRACT                                              03360005
033700         ADD 1 TO PV-TRECEIV-INPUT-COUNT                          03370005
033800     END-IF.                                                      03380005
033900                                                                  03390005
034000                                                                  03400005
034100     EJECT                                                        03410005
034200*----------------------------------------------------------------*03420005
034300*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *03430005
034400*----------------------------------------------------------------*03440005
034500 X100-CHECKPOINT-CHECK.                                           03450005
034600                                                                  03460005
034700     MOVE 'X100-CHECKPOINT-CHECK' TO PV-CURRENT-PARAGRAPH.        03470005
034800                                                                  03480005
034900     EXEC SQL                                                     03490005
035000       SET :WS-TMST = CURRENT TIMESTAMP                           03500005
035100     END-EXEC.                                                    03510005
035200                                                                  03520005
035300     IF SQLCODE = +0                                              03530005
035400         CONTINUE                                                 03540005
035500     ELSE                                                         03550005
035600         MOVE PV-CURRENT-PARAGRAPH                                03560005
035700                             TO AA-PARAGRAPH-NAME                 03570005
035800         MOVE SPACES TO AA-MESSAGE-1                              03580005
035900                        AA-MESSAGE-2                              03590005
036000         MOVE 'BAD SET COMMAND'                                   03600005
036100                             TO AA-DB2-OPERATION                  03610005
036200         MOVE SPACES             TO AA-DB2-TABLE                  03620005
036300         PERFORM Z999-DB2-ABEND                                   03630005
036400     END-IF.                                                      03640005
036500                                                                  03650005
036600     IF WS-TMST > WS-HOLD-TMST                                    03660005
036700         IF NO-COMMITS-TAKEN                                      03670005
036800             MOVE PC-IN-PROCESS-CODE TO PV-CKPT-STAT-CODE         03680005
036900             PERFORM X600-UPDATE-TCKRSTCNTL                       03690005
037000             SET COMMITS-TAKEN TO TRUE                            03700005
037100         END-IF                                                   03710005
037200         PERFORM X700-UPDATE-TCKRSTINF                            03720005
037300         PERFORM Y100-COMMIT                                      03730005
037400         PERFORM X500-SET-CHECKPOINT-TIME                         03740005
037500     END-IF.                                                      03750005
037600                                                                  03760005
037700 EJECT                                                            03770005
037800*----------------------------------------------------------------*03780005
037900*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *03790005
038000*----------------------------------------------------------------*03800005
038100 X200-CHECKPOINT-RESTART.                                         03810005
038200                                                                  03820005
038300     MOVE 'X200-CHECKPOINT-RESTART' TO PV-CURRENT-PARAGRAPH.      03830005
038400                                                                  03840005
038500     PERFORM X400-GET-CHECKPOINT-INFO.                            03850005
038600     MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO CKPT-RESTART-INFO.     03860005
038700                                                                  03870005
038800     DISPLAY '** AHKUP041 CHECKPOINT RESTART **'                  03880005
038900     DISPLAY '** EXTRACT RECS BYPASSED ON RESTART = '             03890005
039000              CR-EXTRACT-RECS-WORKED.                             03900005
039100     DISPLAY '***********************************************'    03910005
039200                                                                  03920005
039300     PERFORM R100-READ-EXTRACT-FILE                               03930005
039400         CR-EXTRACT-RECS-WORKED TIMES.                            03940005
039500     PERFORM R100-READ-EXTRACT-FILE.                              03950005
039600 EJECT                                                            03960005
039700*----------------------------------------------------------------*03970005
039800*    SELECT CHECKPOINT RESTART CONTROL INFO.                     *03980005
039900*----------------------------------------------------------------*03990005
040000 X300-GET-CHECKPOINT-CNTL.                                        04000005
040100                                                                  04010005
040200     MOVE 'X300-GET-CHECKPOINT-CNTL' TO PV-CURRENT-PARAGRAPH.     04020005
040300                                                                  04030005
040400     PERFORM WITH TEST AFTER                                      04040005
040500             VARYING PC-RETRY-COUNT FROM 1 BY 1                   04050005
040600             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             04060005
040700                     SQLCODE = ZERO                               04070005
040800                                                                  04080005
040900             EXEC SQL                                             04090005
041000              SELECT CKPT_STAT_CODE                               04100005
041100               INTO :PV-CKPT-STAT-CODE                            04110005
041200               FROM TCKRSTCNTL                                    04120005
041300               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 04130005
041400             END-EXEC                                             04140005
041500                                                                  04150005
041600             EVALUATE TRUE                                        04160005
041700                 WHEN SQLCODE = ZERO                              04170005
041800                 WHEN SQLCODE = -904                              04180005
041900                 WHEN SQLCODE = -913                              04190005
042000                      CONTINUE                                    04200005
042100                                                                  04210005
042200                 WHEN SQLWARN0 NOT = SPACES                       04220005
042300                 WHEN SQLCODE  NOT = ZERO                         04230005
042400                     MOVE PV-CURRENT-PARAGRAPH                    04240005
042500                                         TO AA-PARAGRAPH-NAME     04250005
042600                     DISPLAY '******** PLAN_NAME:'                04260005
042700                              PV-PROGRAM-NAME                     04270005
042800                     MOVE SPACES TO AA-MESSAGE-1                  04280005
042900                                    AA-MESSAGE-2                  04290005
043000                     MOVE 'UNSUCCESSFUL SELECT'                   04300005
043100                                         TO AA-DB2-OPERATION      04310005
043200                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          04320005
043300                     PERFORM Z999-DB2-ABEND                       04330005
043400             END-EVALUATE                                         04340005
043500     END-PERFORM.                                                 04350005
043600                                                                  04360005
043700     IF PC-RETRY-COUNT > PC-RETRY-MAX                             04370005
043800         MOVE PV-CURRENT-PARAGRAPH                                04380005
043900                             TO AA-PARAGRAPH-NAME                 04390005
044000         DISPLAY '******** PLAN_NAME:'                            04400005
044100                  PV-PROGRAM-NAME                                 04410005
044200         MOVE SPACES TO AA-MESSAGE-1                              04420005
044300                        AA-MESSAGE-2                              04430005
044400         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    04440005
044500                             TO AA-DB2-OPERATION                  04450005
044600         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      04460005
044700         PERFORM Z999-DB2-ABEND                                   04470005
044800     END-IF.                                                      04480005
044900                                                                  04490005
045000 EJECT                                                            04500005
045100*----------------------------------------------------------------*04510005
045200*    SELECT CHECKPOINT RESTART WORKING STORAGE DESCRIPTION INFO  *04520005
045300*----------------------------------------------------------------*04530005
045400 X400-GET-CHECKPOINT-INFO.                                        04540005
045500                                                                  04550005
045600     MOVE 'X400-GET-CHECKPOINT-INFO' TO PV-CURRENT-PARAGRAPH.     04560005
045700                                                                  04570005
045800     PERFORM WITH TEST AFTER                                      04580005
045900             VARYING PC-RETRY-COUNT FROM 1 BY 1                   04590005
046000             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             04600005
046100                     SQLCODE = ZERO                               04610005
046200                                                                  04620005
046300             EXEC SQL                                             04630005
046400              SELECT WORK_STRG_DESC                               04640005
046500               INTO :TCKRSTINF-WORK-STRG-DESC                     04650005
046600               FROM TCKRSTINF                                     04660005
046700               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 04670005
046800             END-EXEC                                             04680005
046900                                                                  04690005
047000             EVALUATE TRUE                                        04700005
047100                 WHEN SQLCODE = ZERO                              04710005
047200                 WHEN SQLCODE = -904                              04720005
047300                 WHEN SQLCODE = -913                              04730005
047400                      CONTINUE                                    04740005
047500                                                                  04750005
047600                 WHEN SQLWARN0 NOT = SPACES                       04760005
047700                 WHEN SQLCODE  NOT = ZERO                         04770005
047800                     MOVE PV-CURRENT-PARAGRAPH                    04780005
047900                                         TO AA-PARAGRAPH-NAME     04790005
048000                     DISPLAY '******** PLAN_NAME:'                04800005
048100                              PV-PROGRAM-NAME                     04810005
048200                     MOVE SPACES TO AA-MESSAGE-1                  04820005
048300                                    AA-MESSAGE-2                  04830005
048400                     MOVE 'UNSUCCESSFUL SELECT'                   04840005
048500                                         TO AA-DB2-OPERATION      04850005
048600                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          04860005
048700                     PERFORM Z999-DB2-ABEND                       04870005
048800             END-EVALUATE                                         04880005
048900     END-PERFORM.                                                 04890005
049000                                                                  04900005
049100     IF PC-RETRY-COUNT > PC-RETRY-MAX                             04910005
049200         MOVE PV-CURRENT-PARAGRAPH                                04920005
049300                             TO AA-PARAGRAPH-NAME                 04930005
049400         DISPLAY '******** PLAN_NAME:'                            04940005
049500                  PV-PROGRAM-NAME                                 04950005
049600         MOVE SPACES TO AA-MESSAGE-1                              04960005
049700                        AA-MESSAGE-2                              04970005
049800         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    04980005
049900                             TO AA-DB2-OPERATION                  04990005
050000         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      05000005
050100         PERFORM Z999-DB2-ABEND                                   05010005
050200     END-IF.                                                      05020005
050300                                                                  05030005
050400 EJECT                                                            05040005
050500*----------------------------------------------------------------*05050005
050600*    SET THE TIME FOR THE NEXT CHECKPOINT.                       *05060005
050700*----------------------------------------------------------------*05070005
050800 X500-SET-CHECKPOINT-TIME.                                        05080005
050900                                                                  05090005
051000     MOVE 'X500-SET-CHECKPOINT-TIME' TO PV-CURRENT-PARAGRAPH.     05100005
051100                                                                  05110005
051200     PERFORM WITH TEST AFTER                                      05120005
051300             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05130005
051400             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05140005
051500                     SQLCODE = ZERO                               05150005
051600                                                                  05160005
051700             EXEC SQL                                             05170005
051800              SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)05180005
051900               INTO :WS-HOLD-TMST                                 05190005
052000               FROM TCKRSTCNTL                                    05200005
052100               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 05210005
052200             END-EXEC                                             05220005
052300                                                                  05230005
052400             EVALUATE TRUE                                        05240005
052500                 WHEN SQLCODE = ZERO                              05250005
052600                 WHEN SQLCODE = -904                              05260005
052700                 WHEN SQLCODE = -913                              05270005
052800                      CONTINUE                                    05280005
052900                                                                  05290005
053000                 WHEN SQLWARN0 NOT = SPACES                       05300005
053100                 WHEN SQLCODE  NOT = ZERO                         05310005
053200                     MOVE PV-CURRENT-PARAGRAPH                    05320005
053300                                         TO AA-PARAGRAPH-NAME     05330005
053400                     DISPLAY '******** PLAN_NAME:'                05340005
053500                              PV-PROGRAM-NAME                     05350005
053600                     MOVE SPACES TO AA-MESSAGE-1                  05360005
053700                                    AA-MESSAGE-2                  05370005
053800                     MOVE 'UNSUCCESSFUL SELECT'                   05380005
053900                                         TO AA-DB2-OPERATION      05390005
054000                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          05400005
054100                     PERFORM Z999-DB2-ABEND                       05410005
054200             END-EVALUATE                                         05420005
054300     END-PERFORM.                                                 05430005
054400                                                                  05440005
054500     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05450005
054600         MOVE PV-CURRENT-PARAGRAPH                                05460005
054700                             TO AA-PARAGRAPH-NAME                 05470005
054800         DISPLAY '******** PLAN_NAME:'                            05480005
054900                  PV-PROGRAM-NAME                                 05490005
055000         MOVE SPACES TO AA-MESSAGE-1                              05500005
055100                        AA-MESSAGE-2                              05510005
055200         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    05520005
055300                             TO AA-DB2-OPERATION                  05530005
055400         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      05540005
055500         PERFORM Z999-DB2-ABEND                                   05550005
055600     END-IF.                                                      05560005
055700                                                                  05570005
055800 EJECT                                                            05580005
055900*----------------------------------------------------------------*05590005
056000*    UPDATES THE CHECKPOINT RESTART CONTROL TABLE.  THE STATUS   *05600005
056100*    CODE IS SET TO '9' (RUN IN PROGRESS) OR '0' (RUN COMPLETE). *05610005
056200*----------------------------------------------------------------*05620005
056300 X600-UPDATE-TCKRSTCNTL.                                          05630005
056400                                                                  05640005
056500     MOVE 'X600-UPDATE-TCKRSTCNTL' TO PV-CURRENT-PARAGRAPH.       05650005
056600                                                                  05660005
056700     PERFORM WITH TEST AFTER                                      05670005
056800             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05680005
056900             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05690005
057000                     SQLCODE = ZERO                               05700005
057100                                                                  05710005
057200             EXEC SQL                                             05720005
057300                 UPDATE TCKRSTCNTL                                05730005
057400                 SET CKPT_STAT_CODE = :PV-CKPT-STAT-CODE          05740005
057500                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          05750005
057600             END-EXEC                                             05760005
057700                                                                  05770005
057800             EVALUATE TRUE                                        05780005
057900                 WHEN SQLCODE = ZERO                              05790005
058000                 WHEN SQLCODE = -904                              05800005
058100                 WHEN SQLCODE = -913                              05810005
058200                      CONTINUE                                    05820005
058300                                                                  05830005
058400                 WHEN SQLWARN0 NOT = SPACES                       05840005
058500                 WHEN SQLCODE  NOT = ZERO                         05850005
058600                     MOVE PV-CURRENT-PARAGRAPH                    05860005
058700                                         TO AA-PARAGRAPH-NAME     05870005
058800                     DISPLAY '******** PLAN_NAME:'                05880005
058900                              PV-PROGRAM-NAME                     05890005
059000                     MOVE SPACES TO AA-MESSAGE-1                  05900005
059100                                    AA-MESSAGE-2                  05910005
059200                     MOVE 'UNSUCCESSFUL UPDATE'                   05920005
059300                                         TO AA-DB2-OPERATION      05930005
059400                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          05940005
059500                     PERFORM Z999-DB2-ABEND                       05950005
059600             END-EVALUATE                                         05960005
059700     END-PERFORM.                                                 05970005
059800                                                                  05980005
059900     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05990005
060000         MOVE PV-CURRENT-PARAGRAPH                                06000005
060100                             TO AA-PARAGRAPH-NAME                 06010005
060200         DISPLAY '******** PLAN_NAME:'                            06020005
060300                  PV-PROGRAM-NAME                                 06030005
060400         MOVE SPACES TO AA-MESSAGE-1                              06040005
060500                        AA-MESSAGE-2                              06050005
060600         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    06060005
060700                             TO AA-DB2-OPERATION                  06070005
060800         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      06080005
060900         PERFORM Z999-DB2-ABEND                                   06090005
061000     END-IF.                                                      06100005
061100                                                                  06110005
061200     EJECT                                                        06120005
061300*----------------------------------------------------------------*06130005
061400*    UPDATES THE CHECKPOINT RESTART INFO TABLE.  THE WORKING     *06140005
061500*    STORAGE DESCRIPTION FIELD IS UPDATED WITH THE CURRENT INPUT *06150005
061600*    FILE RECORD COUNTS AND THE FILE PROCESSOR INDICATOR.        *06160005
061700*----------------------------------------------------------------*06170005
061800 X700-UPDATE-TCKRSTINF.                                           06180005
061900                                                                  06190005
062000     MOVE 'X700-UPDATE-TCKRSTINF' TO PV-CURRENT-PARAGRAPH.        06200005
062100                                                                  06210005
062200     MOVE PV-TRECEIV-INPUT-COUNT TO CR-EXTRACT-RECS-WORKED.       06220005
062300     MOVE CKPT-RESTART-INFO   TO TCKRSTINF-WORK-STRG-DESC-TEXT.   06230005
062400     MOVE 4022                TO TCKRSTINF-WORK-STRG-DESC-LEN.    06240005
062500                                                                  06250005
062600     PERFORM WITH TEST AFTER                                      06260005
062700             VARYING PC-RETRY-COUNT FROM 1 BY 1                   06270005
062800             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             06280005
062900                     SQLCODE = ZERO                               06290005
063000                                                                  06300005
063100             EXEC SQL                                             06310005
063200                 UPDATE TCKRSTINF                                 06320005
063300                 SET WORK_STRG_DESC   = :TCKRSTINF-WORK-STRG-DESC 06330005
063400                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          06340005
063500             END-EXEC                                             06350005
063600                                                                  06360005
063700             EVALUATE TRUE                                        06370005
063800                 WHEN SQLCODE = ZERO                              06380005
063900                 WHEN SQLCODE = -904                              06390005
064000                 WHEN SQLCODE = -913                              06400005
064100                      CONTINUE                                    06410005
064200                                                                  06420005
064300                 WHEN SQLWARN0 NOT = SPACES                       06430005
064400                 WHEN SQLCODE  NOT = ZERO                         06440005
064500                     MOVE PV-CURRENT-PARAGRAPH                    06450005
064600                                         TO AA-PARAGRAPH-NAME     06460005
064700                     DISPLAY '******** PLAN_NAME:'                06470005
064800                              PV-PROGRAM-NAME                     06480005
064900                     MOVE SPACES TO AA-MESSAGE-1                  06490005
065000                                    AA-MESSAGE-2                  06500005
065100                     MOVE 'UNSUCCESSFUL UPDATE'                   06510005
065200                                         TO AA-DB2-OPERATION      06520005
065300                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          06530005
065400                     PERFORM Z999-DB2-ABEND                       06540005
065500             END-EVALUATE                                         06550005
065600     END-PERFORM.                                                 06560005
065700                                                                  06570005
065800     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06580005
065900         MOVE PV-CURRENT-PARAGRAPH                                06590005
066000                             TO AA-PARAGRAPH-NAME                 06600005
066100         DISPLAY '******** PLAN_NAME:'                            06610005
066200                  PV-PROGRAM-NAME                                 06620005
066300         MOVE SPACES TO AA-MESSAGE-1                              06630005
066400                        AA-MESSAGE-2                              06640005
066500         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    06650005
066600                             TO AA-DB2-OPERATION                  06660005
066700         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      06670005
066800         PERFORM Z999-DB2-ABEND                                   06680005
066900     END-IF.                                                      06690005
067000                                                                  06700005
067100 EJECT                                                            06710005
067200                                                                  06720005
067300*----------------------------------------------------------------*06730005
067400*    ISSUES AN SQL COMMIT WORK AFTER A LUW HAS BEEN COMPLETED.   *06740005
067500*----------------------------------------------------------------*06750005
067600 Y100-COMMIT.                                                     06760005
067700                                                                  06770005
067800     MOVE 'Y100-COMMIT'    TO PV-CURRENT-PARAGRAPH.               06780005
067900                                                                  06790005
068000     EXEC SQL                                                     06800005
068100         COMMIT                                                   06810005
068200     END-EXEC.                                                    06820005
068300                                                                  06830005
068400     EVALUATE TRUE                                                06840005
068500         WHEN SQLCODE = ZEROS                                     06850005
068600             CONTINUE                                             06860005
068700         WHEN OTHER                                               06870005
068800             MOVE PV-CURRENT-PARAGRAPH                            06880005
068900                                 TO AA-PARAGRAPH-NAME             06890005
069000             MOVE SPACES TO AA-MESSAGE-1                          06900005
069100                            AA-MESSAGE-2                          06910005
069200             MOVE 'UNSUCCESSFUL COMMIT'                           06920005
069300                                 TO AA-DB2-OPERATION              06930005
069400             MOVE SPACES         TO AA-DB2-TABLE                  06940005
069500             PERFORM Z999-DB2-ABEND                               06950005
069600     END-EVALUATE.                                                06960005
069700 EJECT                                                            06970005
069800 Z900-PROCESS-ABEND.                                              06980005
069900                                                                  06990005
070000     DISPLAY '*** ABEND'.                                         07000005
070100     DISPLAY '*** PROGRAM   = AHKUP041'.                          07010005
070200     DISPLAY '*** PARAGRAPH = ' PV-CURRENT-PARAGRAPH.             07020005
070300     DISPLAY AA-MESSAGE-LINE-1.                                   07030005
070400     DISPLAY AA-MESSAGE-LINE-2.                                   07040005
070500     COPY DPPD004.                                                07050005
070600     CALL 'ILBOABN0' USING ABEND-CODE.                            07060005
070700                                                                  07070005
070800                                                                  07080005
070900                                                                  07090005
071000 Z999-DB2-ABEND.                                                  07100005
071100                                                                  07110005
071200     DISPLAY AA-ABEND-LIT.                                        07120005
071300     DISPLAY AA-DB2-ERROR-LIT.                                    07130005
071400     DISPLAY AA-PROGRAM-LIT.                                      07140005
071500     DISPLAY AA-PARAGRAPH-LIT.                                    07150005
071600     DISPLAY AA-DB2-OPERATION-LIT.                                07160005
071700     DISPLAY AA-DB2-TABLE.                                        07170005
071800     SET AC-DB2-ERROR TO TRUE.                                    07180005
071900                                                                  07190005
072000     COPY DPPD004.                                                07200005
072100                                                                  07210005
072200     CALL 'ILBOABN0' USING ABEND-CODE.                            07220005
