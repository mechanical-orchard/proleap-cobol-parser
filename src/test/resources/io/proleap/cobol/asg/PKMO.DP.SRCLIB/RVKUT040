000100******************************************************************00010035
000200 IDENTIFICATION DIVISION.                                         00020035
000300******************************************************************00030035
000400                                                                  00040035
000500 PROGRAM-ID.    RVKUT040.                                         00050035
000600 AUTHOR.        SIVARAMAKRISHNAN (COGNIZANT).                     00060035
000700 INSTALLATION.  KOHLS.                                            00070035
000800 DATE-WRITTEN   JANUARY, 2015.                                    00080037
000900 DATE-COMPILED.                                                   00090035
001000                                                                  00100035
001100******************************************************************00110035
001200*  THIS PROGRAM DELETES ROWS FROM THE DEFECTIVE SHIPMENT TABLE,  *00120037
001300*  IF NO ROWS ARE PRESENT FOR THE SHIPMENT ID IN TDFCTOR TABLE.  *00130035
001400******************************************************************00140035
001410* CHANGE LOG:                                                     00141051
001420*                                                                 00142052
001430* 04/28/22  CHANGE COMMIT COUNT FROM 1000 TO 500                  00143052
001440*           BY: JEAN KURK                     CHG0269122          00144052
001450*                                                                 00145052
001500                                                                  00150035
001600******************************************************************00160035
001700 ENVIRONMENT DIVISION.                                            00170035
001800******************************************************************00180035
001900                                                                  00190035
002000 CONFIGURATION SECTION.                                           00200035
002100                                                                  00210035
002200 SOURCE-COMPUTER.        IBM-3090.                                00220035
002300 OBJECT-COMPUTER.        IBM-3090.                                00230035
002400                                                                  00240035
002500 INPUT-OUTPUT SECTION.                                            00250035
002600                                                                  00260035
002700 FILE-CONTROL.                                                    00270035
002800                                                                  00280035
002900     SELECT RTV-SHIPT-ID-FILE                                     00290035
003000         ASSIGN TO IN01.                                          00300035
003100                                                                  00310035
003200     SELECT RTV-SHIPT-ARCHIVE-FILE                                00320035
003300         ASSIGN TO OUT01.                                         00330035
003400                                                                  00340035
003500                                                                  00350035
003600******************************************************************00360035
003700 DATA DIVISION.                                                   00370035
003800******************************************************************00380035
003900                                                                  00390035
004000 FILE SECTION.                                                    00400035
004100                                                                  00410035
004200 FD  RTV-SHIPT-ID-FILE                                            00420035
004300     RECORDING MODE IS F                                          00430035
004400     LABEL RECORDS ARE STANDARD                                   00440035
004500     BLOCK CONTAINS 0 RECORDS.                                    00450035
004600                                                                  00460035
004700 01  RTV-SHIPT-ID-RECORD.                                         00470035
004800     05 RTV-SHIPT-ID                 PIC  S9(09) COMP.            00480035
004900                                                                  00490035
005000                                                                  00500035
005100 FD  RTV-SHIPT-ARCHIVE-FILE                                       00510035
005200     RECORDING MODE IS F                                          00520035
005300     LABEL RECORDS ARE STANDARD                                   00530035
005400     BLOCK CONTAINS 0 RECORDS.                                    00540035
005500                                                                  00550035
005600 01  RTV-SHIPT-ARCHIVE-RECORD        PIC  X(35).                  00560037
005700                                                                  00570035
005800                                                                  00580035
005900                                                                  00590035
006000******************************************************************00600035
006100 WORKING-STORAGE SECTION.                                         00610035
006200******************************************************************00620035
006300*                                                                 00630035
006400*                                                                 00640035
006500******************************************************************00650035
006600*  DB2 FORMATTED MESSAGE AREA                                     00660035
006700******************************************************************00670035
006800     COPY DPWS004.                                                00680035
006900*                                                                 00690035
007000******************************************************************00700035
007100*  COMMUNICATIONS AREA FOR DB2                                    00710035
007200******************************************************************00720035
007300     EXEC SQL                                                     00730035
007400          INCLUDE SQLCA                                           00740035
007500     END-EXEC.                                                    00750035
007600 EJECT                                                            00760035
007700*                                                                 00770035
007800******************************************************************00780035
007900*  DB2 TABLE DECLARATION - DEFECTIVE ITEM HEADER TABLE (TDFCTOR)  00790035
008000******************************************************************00800035
008100     EXEC SQL                                                     00810035
008200          INCLUDE TDFCTOR                                         00820035
008300     END-EXEC.                                                    00830035
008400 EJECT                                                            00840035
008500******************************************************************00850035
008600*  DB2 TABLE DECLARATION -DEFECTIVE SHIPMENT TABLE(RVT_DFCT_SHIPT)00860037
008700******************************************************************00870037
008800     EXEC SQL                                                     00880035
008900          INCLUDE RVT00000                                        00890035
009000     END-EXEC.                                                    00900035
009100 EJECT                                                            00910035
009200*                                                                 00920035
009300 01  ABEND-CODE                      PIC S9(04)    VALUE +4013    00930036
009400                                                   COMP SYNC.     00940035
009500*                                                                 00950035
009600 01  PV-PROGRAM-VARAIABLES.                                       00960035
009700     05  PV-ACTL-SHIPT-DTE-NULLIND   PIC  S9(04) COMP.            00970035
009800     05  PV-DELETE-CNT               PIC  9(05).                  00980035
009900*                                                                 00990035
010000 01  PC-PROGRAM-CONSTANTS.                                        01000035
010500     05  PC-COMMIT-HOLD-CNT          PIC  S9(04) VALUE  +500.     01050049
010510*    05  PC-COMMIT-HOLD-CNT          PIC  S9(04) VALUE  +1000.    01051052
010600*                                                                 01060035
010700 01  PS-PROGRAM-SWITCHES.                                         01070035
010800     05  PS-EOF-SHIPT-ID-SW          PIC  X(01)  VALUE 'N'.       01080037
010900         88  PS-EOF-SHIPT-ID                     VALUE 'Y'.       01090037
011000         88  PS-NOT-EOF-SHIPT-ID                 VALUE 'N'.       01100037
011100*                                                                 01110035
011200 01  PA-PROGRAM-ACCUMULATORS.                                     01120035
011300     05  PA-SHIPT-ID-READ-COUNT      PIC  9(10)  VALUE  0.        01130035
011400     05  PA-DELETED-SHIPT-ID-COUNT   PIC  9(10)  VALUE  0.        01140035
011500     05  PA-SHIPT-ARCHIVE-COUNT      PIC  9(10)  VALUE  0.        01150035
011600     05  PA-SHIPT-SKIPPED-COUNT      PIC  9(10)  VALUE  0.        01160035
011700     05  PA-COMMIT-COUNT             PIC  9(05)  VALUE  0.        01170035
011800 EJECT                                                            01180035
011900                                                                  01190035
012000******************************************************************01200035
012100 LINKAGE SECTION.                                                 01210035
012200******************************************************************01220035
012300                                                                  01230035
012400******************************************************************01240035
012500 PROCEDURE DIVISION.                                              01250035
012600******************************************************************01260035
012700                                                                  01270035
012800******************************************************************01280035
012900*  0000-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE PROGRAM    01290035
013000******************************************************************01300035
013100 0000-PROGRAM-MAINLINE.                                           01310035
013200                                                                  01320035
013300     PERFORM 1000-INITIALIZE.                                     01330035
013400                                                                  01340035
013500     PERFORM 2000-PURGE-DATA                                      01350035
013600       UNTIL PS-EOF-SHIPT-ID.                                     01360035
013700                                                                  01370035
013800     PERFORM 9000-EOJ-ROUTINE.                                    01380035
013900     STOP RUN.                                                    01390035
014000                                                                  01400035
014100******************************************************************01410035
014200*  1000-INITIALIZE -  INITIALIZE PROGRAM TOTALS, OPEN ALL THE     01420035
014300*  INPUT AND OUTPUT FILES, AND PERFORM FIRST READS OF THE         01430035
014400*  SHIPMENT ID FROM SHIPMENT ID FILE.                             01440035
014500******************************************************************01450035
014600 1000-INITIALIZE.                                                 01460035
014700                                                                  01470035
014800     OPEN INPUT  RTV-SHIPT-ID-FILE                                01480035
014900          OUTPUT RTV-SHIPT-ARCHIVE-FILE                           01490035
015000                                                                  01500035
015100     INITIALIZE PA-PROGRAM-ACCUMULATORS                           01510035
015200                DCLRVT00000.                                      01520035
015300                                                                  01530035
015400     SET  PS-NOT-EOF-SHIPT-ID        TO TRUE                      01540035
015500                                                                  01550035
015600     PERFORM 8000-READ-SHIPT-FILE.                                01560037
015700                                                                  01570035
015800                                                                  01580035
015900*                                                                 01590035
016000******************************************************************01600035
016100* 2000-PURGE-DATA.                                               *01610035
016200* PROCESS:  THIS PARAGRAPH WILL DELETE THE ROWS FROM DEFECT      *01620035
016300* SHIPMENT TABLE FOR EACH SHIPMENT ID.                           *01630035
016400******************************************************************01640035
016500 2000-PURGE-DATA.                                                 01650035
016600                                                                  01660035
016800     PERFORM 5000-TDFCTOR-CHECK                                   01680035
017000                                                                  01700035
017100     PERFORM 8000-READ-SHIPT-FILE.                                01710037
017300*                                                                 01730035
017400******************************************************************01740035
017500* 2100-COMMIT                                                     01750035
017600* PROCESS:  THIS PARAGRAPH WILL ISSUE A COMMIT IF 1000 ROWS       01760035
017700* ARE AFFECTED.                                                   01770035
017800******************************************************************01780035
017900 2100-COMMIT.                                                     01790035
018000                                                                  01800035
018100     EXEC SQL                                                     01810035
018200         COMMIT                                                   01820035
018300     END-EXEC.                                                    01830035
018400                                                                  01840035
018500     EVALUATE TRUE                                                01850035
018600         WHEN SQLCODE = ZEROS                                     01860035
018700             MOVE 0                TO PV-DELETE-CNT               01870035
018800             ADD +1                TO PA-COMMIT-COUNT             01880035
018810             DISPLAY ' LAST COMMIT ISSUED  DFCT-SHIPT-ID: '       01881044
018820                                            RVT00000-DFCT-SHIPT-ID01882044
018900         WHEN OTHER                                               01890035
019000             DISPLAY '   ABEND   '                                01900035
019100             DISPLAY '   PROGRAM = RVKUT040   '                   01910035
019200             DISPLAY '   PARAGRAPH = 2100-COMMIT'                 01920035
019300               PERFORM 9100-SQL-ABEND                             01930035
019400     END-EVALUATE.                                                01940035
019500                                                                  01950035
019600*                                                                 01960035
019700******************************************************************01970035
019800* 5000-TDFCTOR-CHECK.                                             01980035
019900* PROCESS:THIS PARAGRAPH SELECTS THE ROWS FROM TDFCTOR TABLE      01990035
020000*          FOR PARTCULAR SHIPMENT ID.                             02000035
020100******************************************************************02010035
020200 5000-TDFCTOR-CHECK.                                              02020035
020300                                                                  02030035
020400     EXEC SQL                                                     02040035
020500          SELECT DFCT_ORD_ID                                      02050035
020600          INTO  :DFCTOR-DFCT-ORD-ID                               02060035
020700          FROM                                                    02070035
020800                 TDFCTOR                                          02080035
020900          WHERE DFCT_SHIPT_ID = :RVT00000-DFCT-SHIPT-ID           02090035
021000          FETCH FIRST 1 ROW ONLY                                  02100035
021100     END-EXEC.                                                    02110035
021200                                                                  02120035
021300     EVALUATE TRUE                                                02130035
021400         WHEN SQLCODE EQUAL +0                                    02140035
021500             ADD +1 TO PA-SHIPT-SKIPPED-COUNT                     02150035
021600             CONTINUE                                             02160035
021700         WHEN SQLCODE EQUAL +100                                  02170035
021800             PERFORM 5100-SELECT-SHIPT-DETAIL                     02180035
021900             PERFORM 5200-DELETE-SHIPT-INFO                       02190035
022000         WHEN SQLWARN0 NOT EQUAL SPACE                            02200035
022100         WHEN SQLCODE  NOT EQUAL ZERO                             02210035
022200             DISPLAY '   ABEND   '                                02220035
022300             DISPLAY '   PROGRAM = RVKUT040   '                   02230035
022400             DISPLAY '   PARAGRAPH = 5000-TDFCTOR-CHECK'          02240035
022410             DISPLAY '   DFCT_SHIPT_ID: ' RVT00000-DFCT-SHIPT-ID  02241043
022500             PERFORM 9100-SQL-ABEND                               02250035
022600     END-EVALUATE.                                                02260035
022700*                                                                 02270035
022800******************************************************************02280035
022900* 5100-SELECT-SHIPT-DETAIL.                                      *02290035
023000* PROCESS: THIS PARAGRAPH FETCHES SHIPMENT ID DETAILS FOR THE    *02300035
023100*          SHIPMENT ID AND STORES IT INTO HOST VARIABLE.         *02310035
023200******************************************************************02320035
023300******************************************************************02330035
023400 5100-SELECT-SHIPT-DETAIL.                                        02340035
023500                                                                  02350035
023600     EXEC SQL                                                     02360035
023700          SELECT DFCT_SHIPT_ID                                    02370035
023800                ,TRLR_ID                                          02380035
023900                ,SCAC_CDE                                         02390035
024000                ,ACTL_SHIPT_DTE                                   02400035
024100          INTO :RVT00000-DFCT-SHIPT-ID                            02410035
024200              ,:RVT00000-TRLR-ID                                  02420035
024300              ,:RVT00000-SCAC-CDE                                 02430035
024400              ,:RVT00000-ACTL-SHIPT-DTE :PV-ACTL-SHIPT-DTE-NULLIND02440035
024500          FROM                                                    02450035
024600                 RVT_DFCT_SHIPT                                   02460035
024700          WHERE DFCT_SHIPT_ID = :RVT00000-DFCT-SHIPT-ID           02470035
024800     END-EXEC.                                                    02480035
024900                                                                  02490035
025000     EVALUATE TRUE                                                02500035
025100         WHEN SQLCODE EQUAL   +0                                  02510035
025200         WHEN SQLCODE EQUAL +100                                  02520035
025300             CONTINUE                                             02530035
025400         WHEN SQLWARN0 NOT EQUAL SPACE                            02540035
025500         WHEN SQLCODE NOT EQUAL ZERO                              02550035
025600             DISPLAY '   ABEND   '                                02560035
025700             DISPLAY '   PROGRAM = RVKUT040   '                   02570035
025800             DISPLAY '   PARAGRAPH = 5100-SELECT-SHIPT-DETAIL  '  02580035
025810             DISPLAY '   DFCT_SHIPT_ID: ' RVT00000-DFCT-SHIPT-ID  02581043
025900             PERFORM 9100-SQL-ABEND                               02590035
026000     END-EVALUATE.                                                02600035
026100*                                                                 02610035
026200******************************************************************02620035
026300* 5200-DELETE-SHIPT-INFO.                                        *02630035
026400* PROCESS: THIS PARAGRAPH DELETES THE ROW FOR SHIPMENT ID FROM   *02640035
026500*          DEFECT SHIPMENT TABLE.                                *02650035
026600******************************************************************02660035
026700******************************************************************02670035
026800 5200-DELETE-SHIPT-INFO.                                          02680035
026900                                                                  02690035
027000     EXEC SQL                                                     02700035
027100          DELETE                                                  02710035
027200          FROM                                                    02720035
027300                 RVT_DFCT_SHIPT                                   02730035
027400          WHERE DFCT_SHIPT_ID = :RVT00000-DFCT-SHIPT-ID           02740035
027500     END-EXEC.                                                    02750035
027600                                                                  02760035
027700     EVALUATE TRUE                                                02770035
027800         WHEN SQLCODE EQUAL +0                                    02780035
027900             ADD SQLERRD(3)     TO  PA-DELETED-SHIPT-ID-COUNT     02790035
028000                                    PV-DELETE-CNT                 02800035
028100             IF PV-DELETE-CNT = PC-COMMIT-HOLD-CNT                02810038
028200                PERFORM 2100-COMMIT                               02820035
028300             END-IF                                               02830035
028400             PERFORM 8100-WRITE-SHIPT-ARCHIVE-FILE                02840035
028500         WHEN SQLCODE = +100                                      02850035
028600             ADD +1 TO PA-SHIPT-SKIPPED-COUNT                     02860035
028700             CONTINUE                                             02870035
028800         WHEN SQLWARN0 NOT EQUAL SPACE                            02880035
028900         WHEN SQLCODE NOT EQUAL ZERO                              02890035
029000             DISPLAY '   ABEND   '                                02900035
029100             DISPLAY '   PROGRAM = RVKUT040   '                   02910035
029200             DISPLAY '   PARAGRAPH = 5200-DELETE-SHIPT-INFO    '  02920035
029210             DISPLAY '   DFCT_SHIPT_ID: ' RVT00000-DFCT-SHIPT-ID  02921043
029300             PERFORM 9100-SQL-ABEND                               02930035
029400     END-EVALUATE.                                                02940035
029500*                                                                 02950035
029600******************************************************************02960035
029700* 8000-READ-SHIPT-FILE.                                           02970037
029800******************************************************************02980035
029900 8000-READ-SHIPT-FILE.                                            02990037
030000     READ RTV-SHIPT-ID-FILE                                       03000035
030100     AT END                                                       03010035
030200         SET PS-EOF-SHIPT-ID TO TRUE.                             03020035
030300     MOVE RTV-SHIPT-ID TO RVT00000-DFCT-SHIPT-ID                  03030035
030400     IF PS-NOT-EOF-SHIPT-ID                                       03040035
030500         ADD +1 TO PA-SHIPT-ID-READ-COUNT.                        03050035
030600                                                                  03060035
030700******************************************************************03070035
030800* 8100-WRITE-SHIPT-ARCHIVE-FILE.                                  03080035
030900******************************************************************03090035
031000 8100-WRITE-SHIPT-ARCHIVE-FILE.                                   03100035
031100                                                                  03110035
031200     WRITE RTV-SHIPT-ARCHIVE-RECORD                               03120035
031300         FROM DCLRVT00000.                                        03130035
031400                                                                  03140035
031500     ADD +1 TO PA-SHIPT-ARCHIVE-COUNT.                            03150035
031600                                                                  03160035
031700******************************************************************03170035
031800* 9000-EOJ-ROUTINE.                                               03180035
031900******************************************************************03190035
032000 9000-EOJ-ROUTINE.                                                03200035
032100                                                                  03210035
032200     CLOSE       RTV-SHIPT-ID-FILE                                03220035
032300                 RTV-SHIPT-ARCHIVE-FILE                           03230035
032400                                                                  03240035
032500        IF PV-DELETE-CNT > 0                                      03250035
032600           PERFORM 2100-COMMIT                                    03260035
032700        END-IF.                                                   03270037
032800                                                                  03280035
032900     DISPLAY '*************************************************'. 03290035
033000     DISPLAY '** RVKUT040 TOTALS:'                                03300035
033100     DISPLAY '*************************************************'. 03310035
033200     DISPLAY '**   SHIPMENT ID RECORDS READ: '                    03320035
033300         PA-SHIPT-ID-READ-COUNT.                                  03330035
033400     DISPLAY '*************************************************'. 03340035
033500     DISPLAY '**   SHIPMENT RECORDS DELETED: '                    03350035
033600         PA-DELETED-SHIPT-ID-COUNT.                               03360035
033700     DISPLAY '*************************************************'. 03370035
033800     DISPLAY '**   SHIPMENT RECORDS ARCHIVED: '                   03380035
033900         PA-SHIPT-ARCHIVE-COUNT.                                  03390035
034000     DISPLAY '*************************************************'. 03400035
034100     DISPLAY '**   SHIPMENT RECORDS SKIPPED: '                    03410035
034200         PA-SHIPT-SKIPPED-COUNT.                                  03420035
034300     DISPLAY '*************************************************'. 03430035
034400     DISPLAY '**              COMMITS TAKEN: '                    03440035
034500         PA-COMMIT-COUNT.                                         03450035
034600     DISPLAY '*************************************************'. 03460035
034700                                                                  03470035
034800******************************************************************03480035
034900* 9100-SQL-ABEND - PERFORMS THE ABEND FOR THE PROGRAM IN THE      03490035
035000* EVENT THAT AN SQL ERROR OR WARNING CODE OCCURS.                 03500035
035100******************************************************************03510035
035200 9100-SQL-ABEND.                                                  03520035
035300******************************************************************03530035
035400* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    03540035
035500* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         03550035
035600* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     03560035
035700* FORMAT.                                                         03570035
035800******************************************************************03580035
036000     COPY DPPD004.                                                03600035
036100                                                                  03610035
036300     CALL 'ILBOABN0' USING ABEND-CODE.                            03630035
