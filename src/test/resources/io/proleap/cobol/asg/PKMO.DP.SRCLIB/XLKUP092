000100***************************************************************** 00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300***************************************************************** 00030000
000400                                                                  00040000
000500 PROGRAM-ID.             XLKUP092.                                00050044
000600 AUTHOR.                 SHRIRAM (COGNIZANT).                     00060034
000700 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00070000
000800 DATE-WRITTEN            AUGUST 2014.                             00080034
000900 DATE-COMPILED.                                                   00090000
001000***************************************************************** 00100000
001100*                                                               * 00110000
001200*  THIS PROGRAM UPDATES THE INNER PACK QUANTITY VALUE FOR A PO  * 00120034
001300*  IN TPOPRPK TABLE                                               00130034
001400*                                                               * 00140044
001500***************************************************************** 00150045
001600 ENVIRONMENT DIVISION.                                            00160045
001700***************************************************************** 00170045
001800                                                                  00180045
001900 CONFIGURATION SECTION.                                           00190045
002000                                                                  00200045
002100 SOURCE-COMPUTER.        IBM-3090.                                00210045
002200 OBJECT-COMPUTER.        IBM-3090.                                00220045
002300                                                                  00230045
002400 INPUT-OUTPUT SECTION.                                            00240045
002500                                                                  00250045
002600***************************************************************** 00260045
002700 DATA DIVISION.                                                   00270045
002800***************************************************************** 00280045
002900*                                                                 00290045
003000 FILE SECTION.                                                    00300045
003100*                                                                 00310045
003200 WORKING-STORAGE SECTION.                                         00320045
003300*                                                                 00330045
003400 01  ABEND-CODE                      PIC S9(04)    VALUE +0.      00340045
003500*                                                                 00350045
003600 01  PROGRAM-SWITCHES.                                            00360045
003700     05  PS-EOF-INNER-PK-CURSOR-SW   PIC  X(01)    VALUE 'N'.     00370045
003800         88  PS-EOF-INNER-PK-CURSOR                VALUE 'Y'.     00380045
003900         88  PS-NOT-EOF-INNER-PK-CURSOR            VALUE 'N'.     00390045
004000                                                                  00400045
004100 01  PC-PROGRAM-CONSTANTS.                                        00410045
004200     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          00420045
004300                                                 'XLKUP092'.      00430045
004400     05  PC-COMMIT-HOLD              PIC  9(03)    VALUE 300.     00440045
004500                                                                  00450045
004600 01  PV-PROGRAM-VARIABLES.                                        00460045
004700     05  PV-ABEND-PARAGRAPH          PIC  X(30)    VALUE SPACES.  00470045
004800     05  PV-DB2-OPERATION-ATTEMPTED  PIC  X(30)    VALUE SPACES.  00480045
004900                                                                  00490045
005000     05  PV-PO-NBR                   PIC  S9(9) COMP.             00500045
005100     05  PV-PK-SKU-NBR               PIC  S9(8)V COMP-3.          00510045
005200     05  PV-RATIO-UNT-QTY            PIC  S9(9) COMP.             00520045
005300     05  PV-INNER-PK-QTY             PIC  S9(9) COMP.             00530045
005400                                                                  00540045
005500     05  PV-FETCH-CNT                PIC  9(09)    VALUE ZERO.    00550045
005600     05  PV-UPDATE-CNT               PIC  9(09)    VALUE ZERO.    00560045
005700     05  PV-TOTAL-UPD-CNT            PIC  9(09)    VALUE ZERO.    00570045
005800     05  PV-TOTAL-CNT                PIC  9(09)    VALUE ZERO.    00580045
005900     05  PV-COMMIT-CNT               PIC  9(09)    VALUE ZERO.    00590045
006000     05  PV-DISPLAY-COUNT            PIC  Z(8)9    VALUE ZERO.    00600045
006100                                                                  00610045
006200******************************************************************00620045
006300*  DB2 FORMATTED MESSAGE AREA                                     00630045
006400******************************************************************00640045
006500     COPY DPWS004.                                                00650045
006600                                                                  00660045
006700******************************************************************00670045
006800*  COPY BOOK FOR THE PO PREPACK TABLE                             00680045
006900******************************************************************00690045
007000     EXEC SQL                                                     00700045
007100          INCLUDE TPOPRPK                                         00710045
007200     END-EXEC.                                                    00720045
007300                                                                  00730045
007400***********************************************************       00740045
007500*  XLT_PK TABLE                                          *        00750045
007600***********************************************************       00760045
007700     EXEC SQL                                                     00770045
007800          INCLUDE XLT00007                                        00780045
007900     END-EXEC.                                                    00790045
008000                                                                  00800045
008100***********************************************************       00810045
008200*  XLT_PK_CPT_SKU                                         *       00820045
008300***********************************************************       00830045
008400     EXEC SQL                                                     00840045
008500          INCLUDE XLT00008                                        00850045
008600     END-EXEC.                                                    00860045
008700                                                                  00870045
008800******************************************************************00880045
008900*  DB2 COMMUNICATION AREA                                         00890045
009000******************************************************************00900045
009100     EXEC SQL                                                     00910045
009200         INCLUDE SQLCA                                            00920045
009300     END-EXEC.                                                    00930045
009400                                                                  00940045
009500******************************************************************00950045
009600*  MAIN CURSOR TO FETCH RECORDS BEYOND RETENTION LIMIT           *00960045
009700******************************************************************00970045
009800     EXEC SQL                                                     00980045
009900     DECLARE INNER-PK-CSR CURSOR WITH HOLD FOR                    00990045
010000         SELECT DISTINCT                                          01000045
010100                 A.PK_SKU_NBR                                     01010045
010200                ,A.PO_NBR                                         01020045
010300                ,B.DC_ORD_MULT_QTY                                01030045
010400                ,SUM(C.PK_RATIO_UNT_QTY)                          01040045
010500         FROM   TPOPRPK A                                         01050045
010600               ,XLT_PK  B                                         01060045
010610               ,XLT_PK_CPT_SKU C                                  01061045
010620         WHERE   A.INPK_UNT_QTY= 0                                01062045
010630           AND   B.PK_SKU_NBR = A.PK_SKU_NBR                      01063045
010640           AND   C.PK_SKU_NBR = B.PK_SKU_NBR                      01064045
010650         GROUP BY A.PK_SKU_NBR,A.PO_NBR,B.DC_ORD_MULT_QTY         01065045
010660     END-EXEC.                                                    01066045
010670*                                                                 01067045
010680 PROCEDURE DIVISION.                                              01068045
010690*                                                                 01069045
010700************************************************************      01070045
010800 0000-MAINLINE-PROCESSING.                                        01080045
010900************************************************************      01090045
011000                                                                  01100045
011100     PERFORM 1000-INITIALIZATION.                                 01110045
011200     PERFORM 2000-PROCESS-INNER-PK-QTY.                           01120045
011300     PERFORM 9000-EOJ.                                            01130045
011400     STOP RUN.                                                    01140045
011500                                                                  01150045
011600************************************************************      01160045
011700 1000-INITIALIZATION.                                             01170045
011800************************************************************      01180045
011900                                                                  01190045
012000     DISPLAY 'START OF XLKUP092'.                                 01200045
012100                                                                  01210045
012200     INITIALIZE DCLTPOPRPK                                        01220045
012300                DCLXLT00007                                       01230045
012400                DCLXLT00008.                                      01240045
012500                                                                  01250045
012600                                                                  01260045
012700     SET  PS-NOT-EOF-INNER-PK-CURSOR TO  TRUE.                    01270045
012800                                                                  01280045
012900************************************************************      01290045
013000 2000-PROCESS-INNER-PK-QTY.                                       01300045
013100************************************************************      01310045
013200                                                                  01320045
013300     PERFORM 2100-OPEN-INNER-PK-CSR.                              01330045
013400                                                                  01340045
013500     PERFORM 2200-FETCH-INNER-PK-CSR                              01350045
013600       UNTIL PS-EOF-INNER-PK-CURSOR.                              01360045
013700                                                                  01370045
013800     PERFORM 2300-CLOSE-INNER-PK-CSR.                             01380045
013900                                                                  01390045
014000     IF PV-UPDATE-CNT > 0                                         01400045
014100         PERFORM 8600-TAKE-COMMIT                                 01410045
014200     END-IF.                                                      01420045
014300                                                                  01430045
014400***********************************************************       01440045
014500 2100-OPEN-INNER-PK-CSR.                                          01450045
014600************************************************************      01460045
014700                                                                  01470045
014800     EXEC SQL                                                     01480045
014900          OPEN INNER-PK-CSR                                       01490045
015000     END-EXEC.                                                    01500045
015100                                                                  01510045
015200     EVALUATE TRUE                                                01520045
015300         WHEN SQLCODE = 0                                         01530045
015400             CONTINUE                                             01540045
015500         WHEN SQLWARN0 NOT = SPACES                               01550045
015600         WHEN SQLCODE < ZERO                                      01560045
015700         WHEN SQLCODE > ZERO                                      01570045
015800             MOVE '2100-OPEN-INNER-PK-CSR'                        01580045
015900                                     TO PV-ABEND-PARAGRAPH        01590045
016000             MOVE 'OPEN INNER-PK-CSR'                             01600045
016100                                     TO PV-DB2-OPERATION-ATTEMPTED01610045
016200             PERFORM 9100-SQL-ABEND                               01620045
016300     END-EVALUATE.                                                01630045
016400                                                                  01640045
016500************************************************************      01650045
016600 2200-FETCH-INNER-PK-CSR.                                         01660045
016700************************************************************      01670045
016800                                                                  01680045
016900     EXEC SQL                                                     01690045
017000          FETCH INNER-PK-CSR                                      01700045
017100           INTO :POPRPK-PK-SKU-NBR                                01710045
017200               ,:POPRPK-PO-NBR                                    01720045
017300               ,:XLT00007-DC-ORD-MULT-QTY                         01730045
017400               ,:PV-RATIO-UNT-QTY                                 01740045
017500     END-EXEC.                                                    01750045
017600                                                                  01760045
017700     EVALUATE TRUE                                                01770045
017800       WHEN SQLCODE = ZEROS                                       01780045
017900            MOVE POPRPK-PK-SKU-NBR   TO  PV-PK-SKU-NBR            01790045
018000            MOVE POPRPK-PO-NBR       TO  PV-PO-NBR                01800045
018100            MOVE SQLERRD(3)          TO  PV-FETCH-CNT             01810045
018200            ADD PV-FETCH-CNT         TO  PV-TOTAL-CNT             01820045
018300            COMPUTE PV-INNER-PK-QTY = PV-RATIO-UNT-QTY *          01830045
018400                                      XLT00007-DC-ORD-MULT-QTY    01840045
018500            PERFORM 5000-UPDATE-INNER-PK-QTY                      01850045
018600       WHEN SQLCODE = +100                                        01860045
018700            IF SQLERRD(3) > 0 THEN                                01870045
018800               MOVE SQLERRD(3)       TO  PV-FETCH-CNT             01880045
018900               ADD PV-FETCH-CNT      TO  PV-TOTAL-CNT             01890045
019000            END-IF                                                01900045
019100            SET PS-EOF-INNER-PK-CURSOR  TO TRUE                   01910045
019200       WHEN SQLWARN0 NOT = SPACES                                 01920045
019300       WHEN SQLCODE < ZERO                                        01930045
019400       WHEN SQLCODE > ZERO                                        01940045
019500           MOVE '2200-FETCH-INNER-PK-CSR'                         01950045
019600                                     TO PV-ABEND-PARAGRAPH        01960045
019700           MOVE 'FETCH INNER-PK-CURSOR '                          01970045
019800                                     TO PV-DB2-OPERATION-ATTEMPTED01980045
019900           PERFORM 9100-SQL-ABEND                                 01990045
020000     END-EVALUATE.                                                02000045
020100                                                                  02010045
020200************************************************************      02020045
020300  2300-CLOSE-INNER-PK-CSR.                                        02030045
020400************************************************************      02040045
020500                                                                  02050045
020600     EXEC SQL                                                     02060045
020700          CLOSE INNER-PK-CSR                                      02070045
020800     END-EXEC.                                                    02080045
020900                                                                  02090045
021000     EVALUATE TRUE                                                02100045
021100         WHEN SQLCODE = 0                                         02110045
021200             CONTINUE                                             02120045
021300         WHEN SQLWARN0 NOT = SPACES                               02130045
021400         WHEN SQLCODE < ZERO                                      02140045
021500         WHEN SQLCODE > ZERO                                      02150045
021600             MOVE ' 2300-CLOSE-INNER-PK-CSR'                      02160045
021700                                     TO PV-ABEND-PARAGRAPH        02170045
021800             MOVE 'CLOSE INNER-PK-CSR'                            02180045
021900                                     TO PV-DB2-OPERATION-ATTEMPTED02190045
022000             PERFORM 9100-SQL-ABEND                               02200045
022100     END-EVALUATE.                                                02210045
022200                                                                  02220045
022300************************************************************      02230045
022400 5000-UPDATE-INNER-PK-QTY.                                        02240045
022500************************************************************      02250045
022600                                                                  02260045
022700     EXEC SQL                                                     02270045
022800         UPDATE TPOPRPK                                           02280045
022900           SET  INPK_UNT_QTY = :PV-INNER-PK-QTY                   02290045
023000         WHERE                                                    02300045
023100                PO_NBR       = :PV-PO-NBR                         02310045
023200           AND  PK_SKU_NBR   = :PV-PK-SKU-NBR                     02320045
023300           AND  INPK_UNT_QTY = 0                                  02330045
023400     END-EXEC.                                                    02340045
023500                                                                  02350045
023600     EVALUATE TRUE                                                02360045
023700       WHEN SQLCODE = ZEROS                                       02370045
023800            ADD  SQLERRD(3)          TO  PV-UPDATE-CNT            02380045
023900                                         PV-TOTAL-UPD-CNT         02390045
024000            DISPLAY 'PO NUMBER'          PV-PO-NBR                02400045
024100            DISPLAY 'PACK SKU NUMBER'    PV-PK-SKU-NBR            02410045
024200            IF PV-UPDATE-CNT = PC-COMMIT-HOLD                     02420045
024300                PERFORM 8600-TAKE-COMMIT                          02430045
024400            END-IF                                                02440045
024500                                                                  02450045
024600       WHEN SQLCODE = +100                                        02460045
024700       WHEN SQLWARN0 NOT = SPACES                                 02470045
024800       WHEN SQLCODE < ZERO                                        02480045
024900       WHEN SQLCODE > ZERO                                        02490045
025000           MOVE '5000-UPDATE-INNER-PK-QTY'                        02500045
025100                                     TO PV-ABEND-PARAGRAPH        02510045
025200           MOVE 'UDPATE TO TPOPRPK'                               02520045
025300                                     TO PV-DB2-OPERATION-ATTEMPTED02530045
025400           PERFORM 9100-SQL-ABEND                                 02540045
025500     END-EVALUATE.                                                02550045
025600                                                                  02560045
025700************************************************************      02570045
025800 8600-TAKE-COMMIT.                                                02580045
025900************************************************************      02590045
026000                                                                  02600045
026100     EXEC SQL                                                     02610045
026200         COMMIT                                                   02620045
026300     END-EXEC.                                                    02630045
026400                                                                  02640045
026500     EVALUATE TRUE                                                02650045
026600       WHEN SQLCODE = ZEROS                                       02660045
026700            MOVE 0                   TO PV-UPDATE-CNT             02670045
026800            ADD +1                   TO PV-COMMIT-CNT             02680045
026900       WHEN SQLWARN0 NOT = SPACES                                 02690045
027000       WHEN SQLCODE < ZERO                                        02700045
027100       WHEN SQLCODE > ZERO                                        02710045
027200           MOVE '8600-TAKE-COMMIT'   TO PV-ABEND-PARAGRAPH        02720045
027300           MOVE 'COMMIT'             TO PV-DB2-OPERATION-ATTEMPTED02730045
027400           PERFORM 9100-SQL-ABEND                                 02740045
027500     END-EVALUATE.                                                02750045
027600                                                                  02760045
027700************************************************************      02770045
027800 9000-EOJ.                                                        02780045
027900************************************************************      02790045
028000                                                                  02800045
028100                                                                  02810045
028200     DISPLAY '** ' PC-CURRENT-PROGRAM-NAME ' **'.                 02820045
028300     MOVE PV-TOTAL-CNT               TO   PV-DISPLAY-COUNT.       02830045
028400     DISPLAY '** NUMBER OF RECORD FETCHED : ' PV-DISPLAY-COUNT.   02840045
028500     MOVE PV-TOTAL-UPD-CNT           TO   PV-DISPLAY-COUNT.       02850045
028600     DISPLAY '** NUMBER OF RECORD UPDATE : ' PV-DISPLAY-COUNT.    02860045
028700     MOVE PV-COMMIT-CNT              TO   PV-DISPLAY-COUNT.       02870045
028800     DISPLAY '** NUMBER OF COMMIT TAKEN   : ' PV-DISPLAY-COUNT.   02880045
028900                                                                  02890045
029000************************************************************      02900045
029100 9100-SQL-ABEND.                                                  02910045
029200************************************************************      02920045
029300*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN S      02930045
029400*  ERROR OR WARNING CODE OCCURS.                                  02940045
029500************************************************************      02950045
029600     DISPLAY '9100-SQL-ABEND'.                                    02960045
029700     DISPLAY '** ABEND     **'.                                   02970045
029800     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        02980045
029900     DISPLAY '** PARAGRAPH ** = ' PV-ABEND-PARAGRAPH.             02990045
030000     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.     03000045
030100                                                                  03010045
030200************************************************************      03020045
030300* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STAT      03030045
030400* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         03040045
030500* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABL      03050045
030600* FORMAT.                                                         03060045
030700************************************************************      03070045
030800     COPY DPPD004.                                                03080045
030900                                                                  03090045
031000     MOVE +4013                      TO ABEND-CODE.               03100045
031100     CALL 'ILBOABN0' USING ABEND-CODE.                            03110045
031200                                                                  03120045
