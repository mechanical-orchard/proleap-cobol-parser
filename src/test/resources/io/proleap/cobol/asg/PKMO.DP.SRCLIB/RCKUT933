000100***************************************************************** 00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300***************************************************************** 00030000
000400                                                                  00040000
000500 PROGRAM-ID.             RCKUT933.                                00050000
000600 AUTHOR.                 STEPHANIE HERON.                         00060000
000700 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00070000
000800 DATE-WRITTEN            APRIL 2004.                              00080000
000900 DATE-COMPILED.                                                   00090000
001000***************************************************************** 00100000
001100***************************************************************** 00110000
001200*                                                               * 00120000
001300*  THIS PROGRAM WILL TAKE A TRIP ID AND RESET ALL IT'S SHIPMENTS  00130000
001400*  , TRIP STATUS ROWS AND VEHICLE RECORDS TO AN ARRIVED STATUS    00140000
001410* TABLES AFFECTED ARE                                             00141010
001420*                         TSHIPMT                                 00142010
001430*                         T-ECITM                                 00143010
001440*                         TRECEIV                                 00144010
001441*                         TRECDVS                                 00144110
001442***************************************************************** 00144210
001443*  CHANGED MM/DD/YY BY XXXXXXXXXXX                              * 00144310
001444*   WR# XXXX XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX * 00144410
001445*                                                               * 00144510
001446***************************************************************** 00144610
001447***************************************************************** 00144710
001448 ENVIRONMENT DIVISION.                                            00144810
001449***************************************************************** 00144910
001450                                                                  00145010
001460 CONFIGURATION SECTION.                                           00146010
001470                                                                  00147010
001480 SOURCE-COMPUTER.        IBM-3090.                                00148010
001490 OBJECT-COMPUTER.        IBM-3090.                                00149010
001500                                                                  00150010
001600 INPUT-OUTPUT SECTION.                                            00160010
001700                                                                  00170010
001800 FILE-CONTROL.                                                    00180010
001900*                                                                 00190010
002000     SELECT TRIP-FILE                                             00200010
002100         ASSIGN TO INP01.                                         00210010
002200                                                                  00220010
002300*                                                                 00230010
002400***************************************************************** 00240010
002500 DATA DIVISION.                                                   00250010
002600***************************************************************** 00260010
002700*                                                                 00270010
002800 FILE SECTION.                                                    00280010
002900*                                                                 00290010
003000 FD  TRIP-FILE                                                    00300010
003100     LABEL RECORDS ARE STANDARD                                   00310010
003200     RECORDING MODE IS F                                          00320010
003300     BLOCK CONTAINS 0 RECORDS                                     00330010
003400     RECORD CONTAINS 80 CHARACTERS.                               00340010
003500                                                                  00350010
003600 01  TRIP-RECORD                     PIC X(80).                   00360010
003700*                                                                 00370010
003800                                                                  00380010
003900 WORKING-STORAGE SECTION.                                         00390010
004000*                                                                 00400010
004100 01  ABEND-CODE                      PIC S9(04)    VALUE +0       00410010
004200                                                   COMP SYNC.     00420010
004300*                                                                 00430010
004400 01  PROGRAM-SWITCHES.                                            00440010
004500     05  PS-DATA-IND                 PIC  X(01)  VALUE 'N'.       00450010
004600         88  PS-DATA                             VALUE 'Y'.       00460010
004700         88  PS-NO-DATA                          VALUE 'N'.       00470010
004800     05  PS-END-OF-SHIPMT-CSR-SW     PIC  X(01)    VALUE 'N'.     00480010
004900         88  PS-END-OF-SHIPMT-CSR                  VALUE 'Y'.     00490010
005000         88  PS-NOT-END-OF-SHIPMT-CSR             VALUE 'N'.      00500010
005100     05  PS-END-OF-INPUT-FILE-SW    PIC   X(01)    VALUE 'N'.     00510010
005200         88  PS-END-OF-INPUT-FILE                  VALUE 'Y'.     00520010
005300         88  PS-NOT-END-OF-INPUT-FILE              VALUE 'N'.     00530010
005400*                                                                 00540010
005500 01  PC-CONSTANTS.                                                00550010
005600     05  PC-REPORT-NBR               PIC  9(01)    VALUE 1.       00560010
005700     05  PC-1                        PIC S9(03)    VALUE +1       00570010
005800                                                   COMP-3.        00580010
005900     05  PC-13                       PIC S9(03)    VALUE +13      00590010
006000                                                   COMP-3.        00600010
006010     05  PC-90                       PIC S9(04)    COMP           00601013
006020                                                   VALUE 90.      00602016
006100     05  PC-A                        PIC  X(01)    VALUE 'A'.     00610010
006200     05  PC-Y                        PIC  X(01)    VALUE 'Y'.     00620010
006300     05  PC-RCV                      PIC  X(03)    VALUE 'RCV'.   00630010
006310     05  PC-KHL                      PIC  X(03)    VALUE 'KHL'.   00631013
006320     05  PC-PRDCHK                   PIC  X(06)    VALUE 'PRDCHK'.00632013
006330     05  PC-PARM-TEXT                PIC  X(25)    VALUE          00633013
006340         'LOWER LEVEL ONLY         '.                             00634013
006400     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          00640010
006500         'RCKUT933'.                                              00650010
006600*                                                                 00660010
006700 01  DN-DB2-NULL-INDICATORS.                                      00670010
006800     05  DN-CURR-TRIP-ID                PIC S9(04) COMP VALUE +0. 00680010
006900     05  DN-VEH-NBR                     PIC S9(04) COMP VALUE +0. 00690010
008200 01  PV-MISC-FIELDS.                                              00820000
008300     05  PV-ABEND-CODE               PIC S9(04)    VALUE ZERO     00830000
008400                                                   COMP SYNC.     00840000
008500     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.  00850000
008600     05  PV-DB2-OPERATION-ATTEMPTED  PIC  X(30)    VALUE SPACES.  00860000
008700     05  PV-ABEND-PARAGRAPH          PIC  X(30)    VALUE SPACES.  00870000
008800     05  PV-TRIP-ID-X                PIC  X(09).                  00880000
008900     05  PV-TRIP-ID REDEFINES PV-TRIP-ID-X                        00890000
009000                                     PIC  9(09).                  00900000
009100     05  PV-READ-COUNT               PIC S9(09)    COMP.          00910000
009110     05  PV-WRITE-COUNT              PIC S9(09)    COMP.          00911010
009200     05  PV-QTY-RECV                 PIC S9(09)    COMP.          00920000
009300     05  PV-HOLD-PO-NBR              PIC S9(09)    COMP.          00930000
009400     05  PV-HOLD-REC-SEQ-NBR         PIC S9(09)    COMP.          00940000
009500*                                                                 00950000
009600     05  PV-DISPLAY-FIELD            PIC 9(18).                   00960000
009700*                                                                 00970000
009800     05  PV-DEL-UNLO-XREF-OTBND      PIC X(01).                   00980000
009900     05  PV-UPD-TLBVRDA              PIC X(01).                   00990000
010000     05  PV-DEL-TLBVRMG              PIC X(01).                   01000000
010100     05  PV-DEL-TSUNAUD              PIC X(01).                   01010000
010200     05  PV-DEL-TSUATRN              PIC X(01).                   01020000
010300     05  PV-DEL-TSUAUPC              PIC X(01).                   01030000
010400     05  PV-DEL-SUT-PO-AUD-REQ       PIC X(01).                   01040000
010500     05  PV-DEL-OTBND-P2L-128        PIC X(01).                   01050000
010501                                                                  01050113
010510 01  WS-LOCAL-SERVER.                                             01051013
010520     05  WS-SUBSYS                   PIC X(04)  VALUE SPACES.     01052013
010530     05  FILLER                      PIC X(12)  VALUE SPACES.     01053013
010700*                                                                 01070000
010800 01  DK-DB-KEYS.                                                  01080000
011000    05  DK-TRIP-ID                  PIC S9(09) COMP.              01100000
011010    05  DK-SHIPT-ID                 PIC S9(09) COMP.              01101010
011100    05  DK-SCAC                     PIC X(04).                    01110000
011400                                                                  01140000
011500 01  INPUT-RECORD.                                                01150000
011700     05  IN-TRIP-ID                  PIC 9(09).                   01170000
011800     05  FILLER                      PIC X(01).                   01180000
011900     05  IN-SCAC                     PIC X(04).                   01190000
012000     05  FILLER                      PIC 9(01).                   01200000
012100     05  IN-VEH-NBR                  PIC X(10).                   01210000
012200     05  FILLER                      PIC 9(01).                   01220000
012300     05  IN-TK-ID                    PIC X(08).                   01230000
012310     05  FILLER                      PIC X(01).                   01231000
012320     05  FILLER                      PIC X(01).                   01232000
012330     05  FILLER                      PIC X(01).                   01233000
012340     05  FILLER                      PIC X(01).                   01234000
012350     05  FILLER                      PIC X(01).                   01235000
012360     05  FILLER                      PIC X(01).                   01236000
012370     05  FILLER                      PIC X(01).                   01237000
013100     05  FILLER                      PIC X(41).                   01310000
013200*                                                                 01320000
014200******************************************************************01420000
014300*  DB2 FORMATTED MESSAGE AREA                                     01430000
014400******************************************************************01440000
014500     COPY DPWS004.                                                01450000
014600*                                                                 01460000
014700*                                                                 01470000
014800*  COPY BOOK FOR DB2 TABLE                                        01480000
014900*                                                                 01490000
015000     EXEC SQL                                                     01500000
015100          INCLUDE TKRPRPM                                         01510012
015200     END-EXEC.                                                    01520000
015300                                                                  01530000
015310*  COPY BOOK FOR DB2 TABLE                                        01531012
015320*                                                                 01532012
015330     EXEC SQL                                                     01533012
015340          INCLUDE TVEHICL                                         01534012
015350     END-EXEC.                                                    01535012
015360                                                                  01536012
015400*  COPY BOOK FOR DB2 TABLE                                        01540000
015500*                                                                 01550000
015600     EXEC SQL                                                     01560000
015700          INCLUDE TSHIPMT                                         01570000
015800     END-EXEC.                                                    01580000
015900                                                                  01590000
016000*  COPY BOOK FOR DB2 TABLE                                        01600000
016100*                                                                 01610000
016200     EXEC SQL                                                     01620000
016300          INCLUDE TSHIPST                                         01630000
016400     END-EXEC.                                                    01640000
016500*  COPY BOOK FOR DB2 TABLE                                        01650000
016600*                                                                 01660000
016700     EXEC SQL                                                     01670000
016800          INCLUDE TVHTRIP                                         01680000
016900     END-EXEC.                                                    01690000
021005                                                                  02100500
021006 EJECT                                                            02100600
021007*  COPY BOOK FOR DB2 TABLE                                        02100710
021008*                                                                 02100800
021009     EXEC SQL                                                     02100900
021010          INCLUDE TTRIPST                                         02101000
021011     END-EXEC.                                                    02101100
021012                                                                  02101200
021013 EJECT                                                            02101300
021014*  COPY BOOK FOR DB2 TABLE                                        02101400
021015*                                                                 02101500
021016     EXEC SQL                                                     02101610
021017          INCLUDE TAUVHCL                                         02101710
021018     END-EXEC.                                                    02101810
021019                                                                  02101910
021020*  DB2 COMMUNICATION AREA                                         02102000
021021*                                                                 02102100
021022     EXEC SQL                                                     02102200
021023         INCLUDE SQLCA                                            02102300
021024     END-EXEC.                                                    02102400
021030 EJECT                                                            02103000
021040*  DB2 COMMUNICATION AREA2                                        02104000
021050*                                                                 02105000
021060     COPY SQLCA2.                                                 02106000
021070 EJECT                                                            02107000
021080                                                                  02108000
024205*                                                                 02420500
024206     EXEC SQL                                                     02420610
024207          DECLARE SHIPMENT-CSR CURSOR FOR                         02420710
024208           SELECT SHIPT_ID                                        02420810
024209            FROM  TSHIPMT                                         02420910
024210           WHERE  TRIP_ID = :DK-TRIP-ID                           02421010
024220             AND  TRIP_ID IS NOT NULL                             02422010
024230         ORDER BY SHIPT_ID                                        02423010
024240     END-EXEC.                                                    02424010
024241                                                                  02424110
024242*                                                                 02424200
024243 PROCEDURE DIVISION.                                              02424300
024244*                                                                 02424400
024245 0000-MAINLINE-PROCESSING.                                        02424500
024246******************************************************************02424600
024247**  THIS IS THE MAIN DRIVER FOR THE PROGRAM.                      02424700
024248******************************************************************02424800
024249*                                                                 02424900
024250     PERFORM 1000-INITIALIZATION.                                 02425000
024260*                                                                 02426000
024270                                                                  02427000
024271     IF PS-NOT-END-OF-INPUT-FILE                                  02427110
024280         PERFORM 2000-PROCESS-TRIP                                02428000
024290            UNTIL PS-END-OF-INPUT-FILE                            02429000
024300     END-IF.                                                      02430000
024400                                                                  02440010
024500     MOVE PV-READ-COUNT TO PV-DISPLAY-FIELD.                      02450010
024600     DISPLAY 'RECORDS READ ' PV-DISPLAY-FIELD.                    02460010
024601                                                                  02460110
024602     PERFORM 9000-EOJ-ROUTINE.                                    02460200
024603*                                                                 02460300
024604     GOBACK.                                                      02460400
024700*                                                                 02470000
024800*                                                                 02480000
024900 1000-INITIALIZATION.                                             02490000
025000******************************************************************02500000
025100**  PERFORM THE INITIAL PROCESSING FOR THE PROGRAM.               02510000
025200******************************************************************02520000
025300                                                                  02530000
025310     PERFORM 1100-GET-DB2-INSTANCE.                               02531013
025311     PERFORM 1200-CHECK-IF-PRODUCTION.                            02531113
025320                                                                  02532013
025400     OPEN INPUT  TRIP-FILE.                                       02540013
025500                                                                  02550000
025600     PERFORM 7000-READ-INPUT-FILE.                                02560000
025610*                                                                 02561013
025700 1100-GET-DB2-INSTANCE.                                           02570013
025710                                                                  02571013
025720     MOVE '1100-GET-DB2-INSTANCE'                                 02572014
025730          TO PV-PARAGRAPH-NAME.                                   02573014
025740     MOVE 'GET DB2 INSTANCE'                                      02574014
025750          TO PV-DB2-OPERATION-ATTEMPTED.                          02575014
025760                                                                  02576014
025800     EXEC SQL                                                     02580013
025900         SELECT CURRENT SERVER INTO :WS-LOCAL-SERVER              02590013
026000             FROM SYSIBM.SYSDUMMY1 WITH UR                        02600013
026100     END-EXEC.                                                    02610013
026101                                                                  02610114
026110     EVALUATE TRUE                                                02611014
026120         WHEN SQLCODE = +0                                        02612014
026130             CONTINUE                                             02613014
026170         WHEN SQLWARN0 NOT = SPACES                               02617014
026180         WHEN SQLCODE < +0                                        02618014
026190         WHEN SQLCODE > +0                                        02619014
026191             PERFORM 9100-SQL-ABEND                               02619114
026192     END-EVALUATE.                                                02619214
026200*                                                                 02620000
026210 1200-CHECK-IF-PRODUCTION.                                        02621013
026211                                                                  02621113
026212     MOVE '1200-CHECK-IF-PRODUCTION'                              02621213
026213          TO PV-PARAGRAPH-NAME.                                   02621313
026214     MOVE 'SELECT PRDCHK TKRPRPM '                                02621413
026215          TO PV-DB2-OPERATION-ATTEMPTED.                          02621513
026216                                                                  02621613
026220     EXEC SQL                                                     02622013
026230       SELECT FUNC_TXT                                            02623013
026240         INTO :KRPRPM-FUNC-TXT                                    02624013
026250       FROM   TKRPRPM                                             02625013
026260       WHERE  SYS_PRC_FUNC_CDE  = :PC-PRDCHK                      02626013
026261         AND  INTFC_SYS_CDE     = :PC-KHL                         02626113
026262         AND  LOC_ID            = :PC-90                          02626213
026263         AND  FUNC_TXT          = :PC-PARM-TEXT                   02626313
026270     END-EXEC                                                     02627013
026280                                                                  02628013
026290     EVALUATE TRUE                                                02629013
026291         WHEN SQLCODE = +0                                        02629113
026294             CONTINUE                                             02629413
026295         WHEN SQLCODE = +100                                      02629513
026296             DISPLAY '*******************************************'02629615
026297             DISPLAY '** ABEND - DO NOT RUN THIS RCKUT933 PROGRAM'02629719
026298             DISPLAY '** ABEND - AGAINST PRODUCTION'              02629815
026299             DISPLAY '** ABEND - THIS SHOULD ONLY EVER BE'        02629915
026300             DISPLAY '** ABEND - RUN AGAINST TEST DATA'           02630015
026301             DISPLAY '*******************************************'02630115
026303             DISPLAY '** ABEND - THIS RUN IS GOING AGAINST'       02630315
026304             DISPLAY '** ABEND - DB2 INSTANCE:  '                 02630415
026305                     WS-LOCAL-SERVER                              02630515
026307             DISPLAY '*******************************************'02630715
026308             PERFORM 9100-SQL-ABEND                               02630815
026309                                                                  02630915
026310         WHEN SQLWARN0 NOT = SPACES                               02631015
026311         WHEN SQLCODE < +0                                        02631115
026312         WHEN SQLCODE > +0                                        02631215
026313             PERFORM 9100-SQL-ABEND                               02631313
026314     END-EVALUATE.                                                02631413
026315                                                                  02631513
026320 2000-PROCESS-TRIP.                                               02632000
026400                                                                  02640000
026500     MOVE IN-TRIP-ID  TO DK-TRIP-ID.                              02650010
026600     MOVE IN-SCAC     TO DK-SCAC.                                 02660010
026700                                                                  02670010
026800     PERFORM 8005-UPDATE-TVEHICL.                                 02680010
026900     PERFORM 8030-AUDIT-TVEHICL.                                  02690010
027000     PERFORM 8010-DELETE-TTRIPST.                                 02700010
027100                                                                  02710010
027200     SET PS-NOT-END-OF-SHIPMT-CSR TO TRUE.                        02720010
027300     PERFORM 8100-OPEN-SHIPMENT-CSR.                              02730010
027400     PERFORM 8102-FETCH-SHIPMENT-CSR.                             02740010
027500     PERFORM UNTIL PS-END-OF-SHIPMT-CSR                           02750010
027600         MOVE SHIPMT-SHIPT-ID                                     02760010
027700                         TO DK-SHIPT-ID                           02770010
027800         PERFORM 8110-DELETE-TSHIPST                              02780010
027900         PERFORM 8102-FETCH-SHIPMENT-CSR                          02790010
028000     END-PERFORM.                                                 02800010
028100     PERFORM 8104-CLOSE-SHIPMENT-CSR.                             02810010
028101                                                                  02810110
028102     PERFORM 7000-READ-INPUT-FILE.                                02810200
028103                                                                  02810310
028104*----------------------------------------------------------------*02810410
028105*  UPDATE THE LOCATION AND STATUS OF THE VEHICLE                 *02810510
028106*----------------------------------------------------------------*02810610
028107 8005-UPDATE-TVEHICL.                                             02810710
028108                                                                  02810810
028109** RON KRIER SWITCHED THE SET OF THE CURRENT STATUS ON            02810911
028110** TVEHICL TO BE EN VS AR SINCE THE REST OF THE PROGRAM IS        02811011
028111** DELETING TRIP STATUS ENTRIES EXCEPT FOR EN AND DELETING        02811111
028112** SHIPMENT ENTRIES EXCEPT FOR EN AS WELL.  THE EN STATUS ON      02811211
028113** TVEHICL WILL SYNC TO THE CURRENT STATUS ON THE TRIP STATUS     02811311
028114** TABLE (TTRIPST).                                               02811411
028115*    MOVE 'AR'          TO VEHICL-CURR-STATUS-CDE                 02811511
028116     MOVE 'EN'          TO VEHICL-CURR-STATUS-CDE                 02811611
028117                                                                  02811711
028120     EXEC SQL                                                     02812010
028130       SELECT VEH_NBR                                             02813010
028140         INTO :VHTRIP-VEH-NBR :DN-VEH-NBR                         02814010
028150       FROM   TVHTRIP                                             02815010
028160       WHERE  TRIP_ID       = :DK-TRIP-ID                         02816010
028170     END-EXEC                                                     02817010
028180                                                                  02818010
028190     EVALUATE TRUE                                                02819010
028200         WHEN SQLCODE = +0                                        02820010
028300         WHEN SQLCODE = -904                                      02830010
028400         WHEN SQLCODE = -913                                      02840010
028500             CONTINUE                                             02850010
028600                                                                  02860010
028700         WHEN SQLWARN0 NOT = SPACES                               02870010
028800         WHEN SQLCODE < +0                                        02880010
028900         WHEN SQLCODE > +0                                        02890010
029000             MOVE '8005-UPDATE-TVEHICL'                           02900010
029100                               TO PV-PARAGRAPH-NAME               02910010
029200             MOVE 'SELECT TRIP ID        '                        02920010
029300                              TO PV-DB2-OPERATION-ATTEMPTED       02930010
029400             DISPLAY 'TRIP ID ' IN-TRIP-ID                        02940010
029500             PERFORM 9100-SQL-ABEND                               02950010
029600     END-EVALUATE.                                                02960010
029700                                                                  02970010
029800                                                                  02980010
029900     EXEC SQL                                                     02990010
030000       UPDATE TVEHICL                                             03000010
030100          SET LAST_UPD_DTE     = CURRENT DATE                     03010010
030200             ,LAST_UPD_TME     = CURRENT TIME                     03020010
030300             ,LAST_UPD_UID     = :IN-TK-ID                        03030010
030400             ,CURR_STATUS_DTE  = CURRENT DATE                     03040010
030500             ,CURR_STATUS_TME  = CURRENT TIME                     03050010
030600             ,CURR_STATUS_CDE  = :VEHICL-CURR-STATUS-CDE          03060010
030700             ,CURR_TRIP_ID     = :DK-TRIP-ID                      03070010
030800       WHERE  VEH_NBR       = :VHTRIP-VEH-NBR                     03080010
030900         AND  OWNER_SCAC_ID = :DK-SCAC                            03090010
031000     END-EXEC                                                     03100010
031100                                                                  03110010
031200     EVALUATE TRUE                                                03120010
031300         WHEN SQLCODE = +0                                        03130010
031400         WHEN SQLCODE = -904                                      03140010
031500         WHEN SQLCODE = -913                                      03150010
031600             CONTINUE                                             03160010
031700                                                                  03170010
031800         WHEN SQLWARN0 NOT = SPACES                               03180010
031900         WHEN SQLCODE < +0                                        03190010
032000         WHEN SQLCODE > +0                                        03200010
032100             MOVE '8005-UPDATE-TVEHICL'                           03210010
032200                               TO PV-PARAGRAPH-NAME               03220010
032300             MOVE 'UPDATE CURR INFO ON TVEHICL'                   03230010
032400                              TO PV-DB2-OPERATION-ATTEMPTED       03240010
032500             DISPLAY 'SCAC ' DK-SCAC ' VEH ' VHTRIP-VEH-NBR       03250010
032600             PERFORM 9100-SQL-ABEND                               03260010
032700     END-EVALUATE.                                                03270010
032800                                                                  03280010
032900                                                                  03290010
033000*----------------------------------------------------------------*03300010
033100*  DELETE TRIP STATUS TO GET BACK TO THE AR RECORD               *03310010
033200*----------------------------------------------------------------*03320010
033300 8010-DELETE-TTRIPST.                                             03330010
033400                                                                  03340010
033500                                                                  03350010
033600     EXEC SQL                                                     03360010
033700         DELETE                                                   03370010
033800          FROM  TTRIPST A                                         03380010
033900         WHERE  A.TRIP_ID          = :DK-TRIP-ID                  03390010
034000           AND  A.TRIP_STATUS_CDE  IN( 'DP', 'ET', 'UN','AR')     03400010
034010                                                                  03401010
034100     END-EXEC                                                     03410010
034200                                                                  03420010
034300     EVALUATE TRUE                                                03430010
034400         WHEN SQLCODE = +0                                        03440010
034500         WHEN SQLCODE = -904                                      03450010
034600         WHEN SQLCODE = -913                                      03460010
034700         WHEN SQLCODE = +100                                      03470010
034800             CONTINUE                                             03480010
034900                                                                  03490010
035000         WHEN SQLWARN0 NOT = SPACES                               03500010
035100         WHEN SQLCODE < +0                                        03510010
035200         WHEN SQLCODE > +0                                        03520010
035300             MOVE '8010-DELETE-TTRIPST'                           03530010
035400                               TO PV-PARAGRAPH-NAME               03540010
035500             MOVE 'DELETE TRIPST RECORDS      '                   03550010
035600                              TO PV-DB2-OPERATION-ATTEMPTED       03560010
035700             DISPLAY 'TRIP ID ' IN-TRIP-ID                        03570010
035800             PERFORM 9100-SQL-ABEND                               03580010
035900     END-EVALUATE.                                                03590010
036000                                                                  03600010
036100*----------------------------------------------------------------*03610010
036200*  TAKE A SNAPSHOT OF THE BEFORE IMAGE OF TVEHICL AND WRITE      *03620010
036300*  TO THE AUDIT TABLE.                                           *03630010
036400*----------------------------------------------------------------*03640010
036500 8030-AUDIT-TVEHICL.                                              03650010
036600                                                                  03660010
036700     INITIALIZE DCLTAUVHCL.                                       03670010
036800                                                                  03680010
036900                                                                  03690010
037000     EXEC SQL                                                     03700010
037100         SELECT  OWNER_SCAC_ID                                    03710010
037200                ,VEH_NBR                                          03720010
037300                ,CRT_SRC_CDE                                      03730010
037400                ,LAST_UPD_DTE                                     03740010
037500                ,LAST_UPD_TME                                     03750010
037600                ,LAST_UPD_UID                                     03760010
037700                ,USAGE_CDE                                        03770010
037800                ,VEH_TYP_CDE                                      03780010
037900                ,CURR_STATUS_CDE                                  03790010
038000                ,CURR_STATUS_DTE                                  03800010
038100                ,CURR_STATUS_TME                                  03810010
038200                ,CURR_OPER_UNT_ID                                 03820010
038300                ,CURR_FCLTY_ID                                    03830010
038400                ,CURR_FAC_AREA_ID                                 03840010
038500                ,CURR_LOC_DTE                                     03850010
038600                ,CURR_LOC_TME                                     03860010
038700                ,CURR_TRIP_ID                                     03870010
038800                ,VEH_SIZE_CDE                                     03880010
038900        INTO     :VEHICL-OWNER-SCAC-ID                            03890010
039000                ,:VEHICL-VEH-NBR                                  03900010
039100                ,:VEHICL-CRT-SRC-CDE                              03910010
039200                ,:VEHICL-LAST-UPD-DTE                             03920010
039300                ,:VEHICL-LAST-UPD-TME                             03930010
039400                ,:VEHICL-LAST-UPD-UID                             03940010
039500                ,:VEHICL-USAGE-CDE                                03950010
039600                ,:VEHICL-VEH-TYP-CDE                              03960010
039700                ,:VEHICL-CURR-STATUS-CDE                          03970010
039800                ,:VEHICL-CURR-STATUS-DTE                          03980010
039900                ,:VEHICL-CURR-STATUS-TME                          03990010
040000                ,:VEHICL-CURR-OPER-UNT-ID                         04000010
040100                ,:VEHICL-CURR-FCLTY-ID                            04010010
040200                ,:VEHICL-CURR-FAC-AREA-ID                         04020010
040300                ,:VEHICL-CURR-LOC-DTE                             04030010
040400                ,:VEHICL-CURR-LOC-TME                             04040010
040500                ,:VEHICL-CURR-TRIP-ID                             04050010
040600                   :DN-CURR-TRIP-ID                               04060010
040700                ,:VEHICL-VEH-SIZE-CDE                             04070010
040800       FROM   TVEHICL                                             04080010
040900       WHERE  VEH_NBR       = :VHTRIP-VEH-NBR                     04090010
041000         AND  OWNER_SCAC_ID = :DK-SCAC                            04100010
041100     END-EXEC                                                     04110010
041200                                                                  04120010
041300     EVALUATE TRUE                                                04130010
041400         WHEN SQLCODE = +0                                        04140010
041500         WHEN SQLCODE = -904                                      04150010
041600         WHEN SQLCODE = -913                                      04160010
041700             CONTINUE                                             04170010
041800                                                                  04180010
041900         WHEN SQLWARN0 NOT = SPACES                               04190010
042000         WHEN SQLCODE < +0                                        04200010
042100         WHEN SQLCODE > +0                                        04210010
042200             MOVE '8030-AUDIT-TVEHICL'                            04220010
042300                               TO PV-PARAGRAPH-NAME               04230010
042400             MOVE 'SELECT A TVEHICL ROW   '                       04240010
042500                               TO PV-DB2-OPERATION-ATTEMPTED      04250010
042600             DISPLAY 'SCAC ' DK-SCAC ' VEH ' VHTRIP-VEH-NBR       04260010
042700             PERFORM 9100-SQL-ABEND                               04270010
042800     END-EVALUATE.                                                04280010
042900                                                                  04290010
043000                                                                  04300010
043100     EXEC SQL                                                     04310010
043200         INSERT  INTO TAUVHCL                                     04320010
043300                (OWNER_SCAC_ID                                    04330010
043400                ,VEH_NBR                                          04340010
043500                ,CRT_SRC_CDE                                      04350010
043600                ,LAST_UPD_DTE                                     04360010
043700                ,LAST_UPD_TME                                     04370010
043800                ,LAST_UPD_UID                                     04380010
043900                ,USAGE_CDE                                        04390010
044000                ,VEH_TYP_CDE                                      04400010
044100                ,CURR_STATUS_CDE                                  04410010
044200                ,CURR_STATUS_DTE                                  04420010
044300                ,CURR_STATUS_TME                                  04430010
044400                ,CURR_OPER_UNT_ID                                 04440010
044500                ,CURR_FCLTY_ID                                    04450010
044600                ,CURR_FAC_AREA_ID                                 04460010
044700                ,CURR_LOC_DTE                                     04470010
044800                ,CURR_LOC_TME                                     04480010
044900                ,CURR_TRIP_ID                                     04490010
045000                ,VEH_SIZE_CDE)                                    04500010
045100        VALUES  (:VEHICL-OWNER-SCAC-ID                            04510010
045200                ,:VEHICL-VEH-NBR                                  04520010
045300                ,:VEHICL-CRT-SRC-CDE                              04530010
045400                ,:VEHICL-LAST-UPD-DTE                             04540010
045500                ,:VEHICL-LAST-UPD-TME                             04550010
045600                ,:VEHICL-LAST-UPD-UID                             04560010
045700                ,:VEHICL-USAGE-CDE                                04570010
045800                ,:VEHICL-VEH-TYP-CDE                              04580010
045900                ,:VEHICL-CURR-STATUS-CDE                          04590010
046000                ,:VEHICL-CURR-STATUS-DTE                          04600010
046100                ,:VEHICL-CURR-STATUS-TME                          04610010
046200                ,:VEHICL-CURR-OPER-UNT-ID                         04620010
046300                ,:VEHICL-CURR-FCLTY-ID                            04630010
046400                ,:VEHICL-CURR-FAC-AREA-ID                         04640010
046500                ,:VEHICL-CURR-LOC-DTE                             04650010
046600                ,:VEHICL-CURR-LOC-TME                             04660010
046700                ,:VEHICL-CURR-TRIP-ID                             04670010
046800                   :DN-CURR-TRIP-ID                               04680010
046900                ,:VEHICL-VEH-SIZE-CDE)                            04690010
047000     END-EXEC                                                     04700010
047100                                                                  04710010
047200     EVALUATE TRUE                                                04720010
047300         WHEN SQLCODE = +0                                        04730010
047400         WHEN SQLCODE = -904                                      04740010
047500         WHEN SQLCODE = -913                                      04750010
047600             CONTINUE                                             04760010
047700                                                                  04770010
047800         WHEN SQLWARN0 NOT = SPACES                               04780010
047900         WHEN SQLCODE < +0                                        04790010
048000         WHEN SQLCODE > +0                                        04800010
048100             MOVE '8030-AUDIT-TVEHICL '                           04810010
048200                               TO PV-PARAGRAPH-NAME               04820010
048300             MOVE 'INSERT A ROW ON TAUVHCL'                       04830010
048400                               TO PV-DB2-OPERATION-ATTEMPTED      04840010
048500             DISPLAY 'SCAC ' DK-SCAC ' VEH ' VHTRIP-VEH-NBR       04850010
048600             PERFORM 9100-SQL-ABEND                               04860010
048700     END-EVALUATE.                                                04870010
048800*----------------------------------------------------------------*04880010
048900* OPEN THE SHIPMENT CURSROR                                      *04890010
049000*----------------------------------------------------------------*04900010
049100                                                                  04910010
049200 8100-OPEN-SHIPMENT-CSR.                                          04920010
049300                                                                  04930010
049400                                                                  04940010
049500     EXEC SQL                                                     04950010
049600          OPEN SHIPMENT-CSR                                       04960010
049700     END-EXEC                                                     04970010
049800                                                                  04980010
049900     EVALUATE TRUE                                                04990010
050000         WHEN SQLCODE = +0                                        05000010
050100              CONTINUE                                            05010010
050200         WHEN SQLCODE = -904                                      05020010
050300         WHEN SQLCODE = -913                                      05030010
050400              CONTINUE                                            05040010
050500         WHEN SQLWARN0 NOT = SPACE                                05050010
050600         WHEN SQLCODE  NOT = +0                                   05060010
050700              MOVE '8100-OPEN-SHIPMENT-CSR'                       05070010
050800                               TO PV-PARAGRAPH-NAME               05080010
050900              MOVE 'OPEN SHIPMENT CURSOR'                         05090010
051000                               TO PV-DB2-OPERATION-ATTEMPTED      05100010
051100             DISPLAY 'TRIP ID ' IN-TRIP-ID                        05110010
051200             PERFORM 9100-SQL-ABEND                               05120010
051300     END-EVALUATE.                                                05130010
051400                                                                  05140010
051500*----------------------------------------------------------------*05150010
051600*    FETCH A SHIPMENT ROW                                        *05160010
051700*----------------------------------------------------------------*05170010
051800                                                                  05180010
051900 8102-FETCH-SHIPMENT-CSR.                                         05190010
052000                                                                  05200010
052100     EXEC SQL                                                     05210010
052200          FETCH SHIPMENT-CSR                                      05220010
052300          INTO :SHIPMT-SHIPT-ID                                   05230010
052400     END-EXEC                                                     05240010
052500                                                                  05250010
052600     EVALUATE TRUE                                                05260010
052700         WHEN SQLCODE = +0                                        05270010
052800              CONTINUE                                            05280010
052900                                                                  05290010
053000         WHEN SQLCODE = +100                                      05300010
053100              SET PS-END-OF-SHIPMT-CSR TO TRUE                    05310010
053200                                                                  05320010
053300         WHEN SQLWARN0 NOT = SPACE                                05330010
053400         WHEN SQLCODE < +0                                        05340010
053500         WHEN SQLCODE > +0                                        05350010
053600              MOVE '8102-FETCH-SHIPMENT-CSR'                      05360010
053700                                   TO PV-PARAGRAPH-NAME           05370010
053800              MOVE 'FETCH SHIPMENT CURSOR'                        05380010
053900                               TO PV-DB2-OPERATION-ATTEMPTED      05390010
054000             DISPLAY 'TRIP ID ' IN-TRIP-ID                        05400010
054100             PERFORM 9100-SQL-ABEND                               05410010
054200     END-EVALUATE.                                                05420010
054300                                                                  05430010
054400                                                                  05440010
054500*----------------------------------------------------------------*05450010
054600* CLOSE THE SHIPMENT CURSOR                                      *05460010
054700*----------------------------------------------------------------*05470010
054800                                                                  05480010
054900 8104-CLOSE-SHIPMENT-CSR.                                         05490010
055000                                                                  05500010
055100     EXEC SQL                                                     05510010
055200          CLOSE SHIPMENT-CSR                                      05520010
055300     END-EXEC                                                     05530010
055400                                                                  05540010
055500     EVALUATE TRUE                                                05550010
055600         WHEN SQLCODE = +0                                        05560010
055700              CONTINUE                                            05570010
055800         WHEN SQLWARN0 NOT = SPACE                                05580010
055900         WHEN SQLCODE  NOT = +0                                   05590010
056000              MOVE '8104-CLOSE-SHIPMENT-CSR'                      05600010
056100                                   TO PV-PARAGRAPH-NAME           05610010
056200              MOVE 'CLOSE SHIPMENT CURSOR'                        05620010
056300                               TO PV-DB2-OPERATION-ATTEMPTED      05630010
056400              DISPLAY 'TRIP ID ' IN-TRIP-ID                       05640010
056500              PERFORM 9100-SQL-ABEND                              05650010
056600     END-EVALUATE.                                                05660010
060100*                                                                 06010000
060200*----------------------------------------------------------------*06020010
060300*  SELECT LATEST SHIPMENT STATUS ROW                             *06030010
060400*----------------------------------------------------------------*06040010
060500 8110-DELETE-TSHIPST.                                             06050010
060600                                                                  06060010
060700     EXEC SQL                                                     06070010
060800         DELETE                                                   06080010
060900       FROM   TSHIPST A                                           06090010
061000       WHERE  A.SHIPT_ID = :DK-SHIPT-ID                           06100010
061100         AND  A.SHIPT_STATUS_CDE IN ('DP','ET','UN','AR')         06110010
061200**GB     AND  A.SHIPT_STATUS_CDE IN ('DP','ET','UN')              06120010
061300     END-EXEC                                                     06130010
061400                                                                  06140010
061500     EVALUATE TRUE                                                06150010
061600         WHEN SQLCODE = +0                                        06160010
061700         WHEN SQLCODE = -904                                      06170010
061800         WHEN SQLCODE = -913                                      06180010
061900         WHEN SQLCODE = +100                                      06190010
062000             CONTINUE                                             06200010
062100                                                                  06210010
062200         WHEN SQLWARN0 NOT = SPACES                               06220010
062300         WHEN SQLCODE < +0                                        06230010
062400         WHEN SQLCODE > +0                                        06240010
062500             MOVE '8110-DELETE-TSHIPST'                           06250010
062600                                   TO PV-PARAGRAPH-NAME           06260010
062700             MOVE 'DELETE A TSHIPST ROW   '                       06270010
062800                               TO PV-DB2-OPERATION-ATTEMPTED      06280010
062900             DISPLAY 'SHIP ID ' DK-SHIPT-ID                       06290010
063000             PERFORM 9100-SQL-ABEND                               06300010
063100     END-EVALUATE.                                                06310010
063200                                                                  06320010
063201                                                                  06320110
063202 7000-READ-INPUT-FILE.                                            06320200
063203******************************************************************06320300
063204                                                                  06320400
063205     READ TRIP-FILE INTO INPUT-RECORD                             06320500
063206        AT END                                                    06320600
063207           SET PS-END-OF-INPUT-FILE TO TRUE.                      06320700
063208                                                                  06320800
063209     IF PS-NOT-END-OF-INPUT-FILE                                  06320900
063210        DISPLAY 'TRIP ID: '  IN-TRIP-ID                           06321010
063211        DISPLAY 'SCAC: '     IN-SCAC                              06321110
063212        DISPLAY 'VEH NBR '   IN-VEH-NBR                           06321200
063213        ADD +1 TO PV-READ-COUNT                                   06321310
063214     END-IF.                                                      06321400
063215*                                                                 06321500
063216 9000-EOJ-ROUTINE.                                                06321600
063217                                                                  06321700
063218     CLOSE TRIP-FILE.                                             06321800
063219                                                                  06321900
063220 9100-SQL-ABEND.                                                  06322000
063221******************************************************************06322100
063222*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    06322200
063223*  ERROR OR WARNING CODE OCCURS.                                  06322300
063224******************************************************************06322400
063225     DISPLAY '** ABEND     **'.                                   06322500
063226     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        06322600
063227     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              06322700
063228     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.     06322800
063229                                                                  06322900
063230******************************************************************06323000
063231* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    06323100
063232* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         06323200
063233* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     06323300
063234* FORMAT.                                                         06323400
063235******************************************************************06323500
063236     COPY DPPD004.                                                06323600
063237                                                                  06323700
063238     MOVE +4013                  TO ABEND-CODE.                   06323800
063239     CALL 'ILBOABN0' USING ABEND-CODE.                            06323900
