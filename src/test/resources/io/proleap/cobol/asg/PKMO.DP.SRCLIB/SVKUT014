000100******************************************************************00010003
000200 IDENTIFICATION DIVISION.                                         00020004
000300******************************************************************00030004
000400                                                                  00040004
000500 PROGRAM-ID.             SVKUT014.                                00050004
000600 AUTHOR.                 BARB ERTL - SAFENET CONSULTING.          00060004
000700 INSTALLATION.           KOHLS.                                   00070004
000800 DATE-WRITTEN            JANUARY 2001.                            00080004
000900 DATE-COMPILED.                                                   00090004
001000                                                                  00100004
001100******************************************************************00110004
001200*   THIS PROGRAM READS AN INPUT FILE OF STORED VALUE (SV) CARD    00120004
001300*   DATA EXTRACTED FROM DB2 TABLE TKMCTBL.  THE EXTRACT FILE      00130004
001400*   CONTAINS RECORDS FOR EACH STORED VALUE CARD PRESENT ON THE    00140004
001500*   DATABASE.                                                     00150004
001600*                                                                 00160004
001700*   FOR EACH INPUT RECORD READ, AN OUTPUT RECORD IS               00170004
001800*   WRITTEN CONTAINING DATA FROM BOTH THE INPUT RECORD AND DB2.   00180004
001900*   THE OUTPUT RECORDS WILL BE USED BY SVKUT001.                  00190004
002000*                                                                 00200004
002100******************************************************************00210004
002200*  CHANGED 03/31/02 BY BARB ERTL                                * 00220004
002300*   WR# 22603  MULTI-CHANNEL GIFT CARD PROJECT                  * 00230004
002400*              CHANGE TO USE NEW STORED VALUE DB2 TABLES        * 00240004
002500***************************************************************** 00250004
002600 EJECT                                                            00260004
002700 ENVIRONMENT DIVISION.                                            00270004
002800                                                                  00280004
002900 CONFIGURATION SECTION.                                           00290004
003000                                                                  00300004
003100 SOURCE-COMPUTER.        IBM-3090.                                00310004
003200 OBJECT-COMPUTER.        IBM-3090.                                00320004
003300                                                                  00330004
003400 INPUT-OUTPUT SECTION.                                            00340004
003500                                                                  00350004
003600 FILE-CONTROL.                                                    00360004
003700                                                                  00370004
003800     SELECT EXTRACT-FILE                                          00380004
003900         ASSIGN TO INP01.                                         00390004
004000                                                                  00400004
004100     SELECT ACTIVITY-FILE                                         00410004
004200         ASSIGN TO OUT01.                                         00420004
004300                                                                  00430004
004400******************************************************************00440004
004500 DATA DIVISION.                                                   00450004
004600******************************************************************00460004
004700                                                                  00470004
004800 FILE SECTION.                                                    00480004
004900                                                                  00490004
005000 FD  EXTRACT-FILE                                                 00500004
005100     RECORDING MODE IS F                                          00510004
005200     BLOCK CONTAINS 0 RECORDS                                     00520004
005300     LABEL RECORDS ARE STANDARD.                                  00530004
005400                                                                  00540004
005500 01  EXTRACT-RECORD                         PIC X(14).            00550009
005600                                                                  00560008
005700 FD  ACTIVITY-FILE                                                00570008
005800     RECORDING MODE IS F                                          00580008
005900     BLOCK CONTAINS 0 RECORDS                                     00590008
006000     LABEL RECORDS ARE STANDARD.                                  00600008
006100                                                                  00610008
006200 01  ACTIVITY-RECORD                        PIC X(47).            00620009
006300                                                                  00630004
006400 EJECT                                                            00640004
006500******************************************************************00650004
006600 WORKING-STORAGE SECTION.                                         00660004
006700******************************************************************00670004
006800 01  FILLER                           PIC X(50) VALUE             00680004
006900      ' *** WORKING STORAGE STARTS HERE FOR SVKUT014 *** '.       00690004
007000                                                                  00700004
007100******************************************************************00710004
007200* RECORD LAYOUT FOR INPUT EXTRACT FILE                            00720004
007300******************************************************************00730004
007400     COPY SVRD012.                                                00740011
007500******************************************************************00750004
007600* RECORD LAYOUT FOR OUTPUT ACTIVITY FILE                          00760004
007700******************************************************************00770004
007800     COPY SVRD013.                                                00780011
007900 EJECT                                                            00790004
008000 01  ABEND-CODE                          PIC S9(04)  VALUE ZERO   00800004
008100                                                     COMP SYNC.   00810004
008200 01  PV-PROGRAM-VARIABLES.                                        00820004
008300     05  PV-PARAGRAPH-NAME               PIC  X(30)  VALUE SPACE. 00830004
008400     05  PV-OPERATION-MSG-1              PIC  X(40)  VALUE SPACE. 00840004
008500     05  PV-OPERATION-MSG-2              PIC  X(40)  VALUE SPACE. 00850004
008600     05  PV-DB2-OPERATION                PIC  X(30)  VALUE SPACE. 00860004
008700     05  PV-CRD-PROD-YR                  PIC S9(04)  COMP-3       00870007
008800                                                     VALUE ZERO.  00880006
008900     05  PV-SHIPT-REQ-NBR                PIC S9(04)  COMP-3       00890007
009000                                                     VALUE ZERO.  00900006
009100     05  PV-CRD-STK-TYP-ID               PIC  X(08)  VALUE SPACE. 00910006
009200     05  PV-CRD-STK-TYP-DESC             PIC  X(25)  VALUE SPACE. 00920006
009300     05  PV-INPUT-CNT                    PIC S9(09)  COMP-3       00930006
009400                                                     VALUE ZERO.  00940006
009500     05  PV-OUTPUT-CNT                   PIC S9(09)  COMP-3       00950006
009600                                                     VALUE ZERO.  00960006
009700                                                                  00970004
009800 01  PS-PROGRAM-SWITCHES.                                         00980004
009900     05  PS-END-OF-EXTRACT-FILE-SW       PIC X(01)   VALUE 'N'.   00990004
010000         88  PS-END-OF-EXTRACT-FILE                  VALUE 'Y'.   01000004
010100                                                                  01010004
010200 01  PC-PROGRAM-CONSTANTS.                                        01020004
010300     05 PC-CURRENT-PROGRAM-NAME          PIC X(08)   VALUE        01030004
010400                                                     'SVKUT014'.  01040004
010500******************************************************************01050004
010600*  WS FIELDS FOR SQLCA MESSAGE ROUTINE                            01060004
010700******************************************************************01070004
010800     COPY DPWS004.                                                01080011
010900 EJECT                                                            01090004
011000******************************************************************01100004
011100*  DB2 COMMUNICATION AREA.                                        01110004
011200******************************************************************01120004
011300     EXEC SQL                                                     01130004
011400          INCLUDE SQLCA                                           01140004
011500     END-EXEC.                                                    01150004
011600******************************************************************01160004
011700*  DB2 TABLE DB2PDBA.SVT_CRD_PROD                                 01170004
011800*                            - MERCHANDISE CARD RANGE CONTROL TBL 01180004
011900******************************************************************01190004
012000     EXEC SQL                                                     01200004
012100          INCLUDE SVT00000                                        01210004
012200     END-EXEC.                                                    01220004
011600******************************************************************01221012
011700*  DB2 TABLE DB2PDBA.SVT_CRD_PROD                                 01222012
011800*                            - MERCHANDISE CARD RANGE CONTROL TBL 01223012
011900******************************************************************01224012
012000     EXEC SQL                                                     01225012
012100          INCLUDE SVT00008                                        01226012
012200     END-EXEC.                                                    01227012
012300 EJECT                                                            01230004
012400                                                                  01240004
012500 PROCEDURE DIVISION.                                              01250004
012600******************************************************************01260004
012700*  0000-MAINLINE  -  MAIN LINE OF THE PROGRAM                     01270004
012800*                                                                 01280004
012900******************************************************************01290004
013000 0000-MAINLINE.                                                   01300004
013100                                                                  01310004
013200     PERFORM 1000-INITIALIZE-PROGRAM.                             01320004
013300     PERFORM 2000-PROCESS-EXTRACT-RECORDS                         01330004
013400         UNTIL PS-END-OF-EXTRACT-FILE.                            01340004
013500                                                                  01350004
013600     CLOSE ACTIVITY-FILE                                          01360004
013700           EXTRACT-FILE.                                          01370004
013800                                                                  01380004
013900     DISPLAY 'RECORDS READ     -  ' PV-INPUT-CNT.                 01390004
014000     DISPLAY 'RECORDS WRITTEN  -  ' PV-OUTPUT-CNT.                01400004
014100                                                                  01410004
014200     STOP RUN.                                                    01420004
014300                                                                  01430004
014400******************************************************************01440004
014500* 1000-INITIALIZE-PROGRAM                                         01450004
014600* OPEN FILES, DO PRIME READ OF EXTRACT FILE.                      01460004
014700******************************************************************01470004
014800 1000-INITIALIZE-PROGRAM.                                         01480004
014900                                                                  01490004
015000     OPEN                                                         01500004
015100          INPUT  EXTRACT-FILE                                     01510004
015200          OUTPUT ACTIVITY-FILE.                                   01520004
015300                                                                  01530004
015400     PERFORM 7000-READ-EXTRACT-FILE.                              01540004
015500                                                                  01550004
015600******************************************************************01560004
015700* 2000-PROCESS-EXTRACT-RECORDS - MAIN PROCESS MODULE              01570004
015800* DETERMINE IF YEAR/SHIPMENT REQUEST NUMBER HAS ALREADY BEEN      01580004
015900* RETRIEVED.  IF NOT, RETRIEVE CRD-PROD ROW.  FORMAT OUTPUT       01590004
016000* RECORD, WRITE IT, AND READ NEXT INPUT RECORD.                   01600004
016100******************************************************************01610004
016200 2000-PROCESS-EXTRACT-RECORDS.                                    01620004
016300                                                                  01630004
016400     IF SV012-CRD-PROD-YR = PV-CRD-PROD-YR                        01640004
016500       AND SV012-SHIPT-REQ-NBR = PV-SHIPT-REQ-NBR                 01650004
016600         NEXT SENTENCE                                            01660004
016700     ELSE                                                         01670004
016800         PERFORM 2100-GET-STOCK-TYPE                              01680004
016900     END-IF.                                                      01690004
017000     PERFORM 3000-FORMAT-ACTIVITY-RECORD.                         01700004
017100     PERFORM 8000-WRITE-ACTIVITY-RECORD.                          01710004
017200     PERFORM 7000-READ-EXTRACT-FILE.                              01720004
017300                                                                  01730004
017400                                                                  01740004
017500******************************************************************01750004
017600* 2100-GET-STOCK-TYPE                                             01760004
017700******************************************************************01770004
017800 2100-GET-STOCK-TYPE.                                             01780004
017900                                                                  01790004
018000     EXEC SQL                                                     01800004
018100          SELECT A.CRD_STK_TYP_ID                                 01810011
018200                ,CRD_PROD_YR                                      01820004
018300                ,SHIPT_REQ_NBR                                    01830004
018400                ,CRD_STK_TYP_DESC                                 01840005
018500          INTO   :SVT00000-CRD-STK-TYP-ID                         01850004
018600                ,:SVT00000-CRD-PROD-YR                            01860004
018700                ,:SVT00000-SHIPT-REQ-NBR                          01870004
018800                ,:SVT00008-CRD-STK-TYP-DESC                       01880013
018900          FROM   SVT_CRD_PROD A                                   01890011
018900             ,   SVT_CRD_STK_DNMNTN B                             01891011
019000          WHERE  A.CRD_TYP_CDE    = B.CRD_TYP_CDE                 01900011
019000            AND  A.CRD_STK_TYP_ID = B.CRD_STK_TYP_ID              01901011
019000            AND  A.PRE_DNNTD_CRD_AMT = B.PRE_DNNTD_CRD_AMT        01901111
019000            AND  CRD_PROD_YR      = :SV012-CRD-PROD-YR            01902011
019100            AND  SHIPT_REQ_NBR    = :SV012-SHIPT-REQ-NBR          01910011
019200     END-EXEC.                                                    01920004
019300                                                                  01930004
019400     EVALUATE TRUE                                                01940004
019500         WHEN SQLCODE = ZERO                                      01950004
019600             MOVE SVT00000-CRD-PROD-YR      TO PV-CRD-PROD-YR     01960004
019700             MOVE SVT00000-SHIPT-REQ-NBR    TO PV-SHIPT-REQ-NBR   01970004
019800             MOVE SVT00000-CRD-STK-TYP-ID   TO PV-CRD-STK-TYP-ID  01980004
019900             MOVE SVT00008-CRD-STK-TYP-DESC TO PV-CRD-STK-TYP-DESC01990013
020000         WHEN SQLWARN0 NOT EQUAL SPACE                            02000004
020100         WHEN SQLCODE NOT EQUAL ZERO                              02010004
020200             MOVE '2100-GET-STOCK-TYPE'     TO PV-PARAGRAPH-NAME  02020004
020300             MOVE 'SELECT FROM SVT_CRD_PROD'                      02030004
020400                                            TO PV-DB2-OPERATION   02040004
020500             DISPLAY 'CONTROL = ' SV012-CRD-PROD-YR ' '           02050004
020600                                  SV012-SHIPT-REQ-NBR             02060004
020700             PERFORM 9100-SQL-ABEND                               02070004
020800     END-EVALUATE.                                                02080004
020900                                                                  02090004
021000******************************************************************02100004
021100* 3000-FORMAT-ACTIVITY-RECORD                                     02110004
021200* MOVE FIELDS FROM INPUT FILE ALONG WITH STOCK TYPE TO THE OUTPUT 02120004
021300* ACTIVITY RECORD FIELDS.                                         02130004
021400******************************************************************02140004
021500 3000-FORMAT-ACTIVITY-RECORD.                                     02150004
021600                                                                  02160004
021700     MOVE SPACES               TO  ACTIVITY-RECORD.               02170004
021800     MOVE SV012-CRD-NBR        TO  SV013-CRD-NBR.                 02180004
021900     MOVE SV012-CRD-PROD-YR    TO  SV013-CRD-PROD-YR.             02190004
022000     MOVE SV012-SHIPT-REQ-NBR  TO  SV013-SHIPT-REQ-NBR.           02200004
022100     MOVE SV012-CRD-TYP-CDE    TO  SV013-CRD-TYP-CDE.             02210004
022200     MOVE SV012-CRD-STAT-CDE   TO  SV013-CRD-STAT-CDE.            02220004
022300     MOVE PV-CRD-STK-TYP-ID    TO  SV013-CRD-STK-TYP-ID.          02230004
022400     MOVE PV-CRD-STK-TYP-DESC  TO  SV013-CRD-STK-TYP-DESC.        02240005
022500                                                                  02250004
022600******************************************************************02260004
022700* 7000-READ-EXTRACT-FILE                                          02270004
022800*                                                                 02280004
022900******************************************************************02290004
023000 7000-READ-EXTRACT-FILE.                                          02300004
023100     READ EXTRACT-FILE INTO SV012-CRD-INFO                        02310004
023200        AT END                                                    02320004
023300           SET PS-END-OF-EXTRACT-FILE TO TRUE.                    02330004
023400                                                                  02340004
023500     IF NOT PS-END-OF-EXTRACT-FILE                                02350004
023600         ADD +1 TO PV-INPUT-CNT                                   02360004
023700     END-IF.                                                      02370004
023800                                                                  02380004
023900******************************************************************02390004
024000* 8000-WRITE-ACTIVITY-RECORD                                      02400004
024100*                                                                 02410004
024200******************************************************************02420004
024300 8000-WRITE-ACTIVITY-RECORD.                                      02430004
024400                                                                  02440004
024500     WRITE ACTIVITY-RECORD                                        02450004
024600         FROM SV013-STOCK-RECORD.                                 02460004
024700     ADD +1 TO PV-OUTPUT-CNT.                                     02470004
024800                                                                  02480004
024900******************************************************************02490004
025000* 9100-SQL-ABEND - PERFORMS THE ABEND FOR THE PROGRAM IN THE      02500004
025100* EVENT THAT AN SQL ERROR OR WARNING CODE OCCURS.                 02510004
025200******************************************************************02520004
025300 9100-SQL-ABEND.                                                  02530004
025400     DISPLAY '** ABEND     **'.                                   02540004
025500     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        02550004
025600     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              02560004
025700     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               02570004
025800                                                                  02580004
025900******************************************************************02590004
026000* COPY BOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED     02600004
026100* TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS.      02610004
026200******************************************************************02620004
026300     COPY DPPD004.                                                02630011
026400                                                                  02640004
026500     MOVE +4013 TO ABEND-CODE.                                    02650004
026600     CALL 'ILBOABN0' USING ABEND-CODE.                            02660004
026700                                                                  02670004
