000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400                                                                  00040000
000500 PROGRAM-ID.             IMKUT032.                                00050000
000600 AUTHOR.                 D. THEEL                                 00060000
000700 INSTALLATION.           KOHLS.                                   00070000
000800 DATE-WRITTEN            10/4/2002.                               00080000
000900 DATE-COMPILED.                                                   00090000
001000                                                                  00100000
001100*                                                                 00110000
001200*-----------------------------------------------------------------00120000
001300*    CREATE ITEM DOMAIN END OF DAY MESSAGE                        00130000
001400*-----------------------------------------------------------------00140000
001500*  THE PURPOSE OF THIS PROGRAM IS TO INSERT A ROW INTO THE ITEM   00150000
001600*  EVENT MESSAGE BRIDGE TABLE WHICH WILL GO TO THE MQSI HUB.      00160000
      *  IT WILL INCLUDE SYSTEM DATE.  THE CONSUMERS OF THE ITEM DOMAIN 00160100
001600*  EXTRACT PROCESS CAN SUBSCRIBE TO THIS MESSAGE IN ORDER TO      00160200
001600*  ALERT THEM THAT THE ITEM DOMAIN PROCESS IS COMPLETING SO THEY  00160300
      *  CAN STOP PROCESSING ITEM BRIDGE MESSAGES AND START THEIR       00160400
      *  DOMAIN DATA INTEGRITY PROCESSES.  THE SYSTEM DATE IS TO        00160500
      *  REPRESENT THE ESP DATE THIS IS PROCESSING FOR INCASE WE DO NOT 00160600
      *  PROCESS BEFORE MIDNIGHT AND ALSO TO ENSURE CONSUMERS WHO       00160700
      *  PROCESS LESS OFTEN PICK UP THE CORRECT ITEM DOMAIN END OF DAY  00160800
      *  MESSAGE.  THIS MESSAGE NEEDS TO BE USED IN CONJUNCTION WITH    00160900
      *  CHECKING FOR COMPLETION OF THE PARTICULAR ITEM DOMAIN EXTRACT  00161000
      *  JOBS WHICH APPLY TO THE CONSUMERS DOMAIN.                      00161100
001400*-----------------------------------------------------------------00161200
002100                                                                  00161300
002200******************************************************************00161400
002300 ENVIRONMENT DIVISION.                                            00161500
002400******************************************************************00161600
002500                                                                  00161700
002600 CONFIGURATION SECTION.                                           00161800
002700                                                                  00162000
002800 SOURCE-COMPUTER.        IBM-3090.                                00163000
002900 OBJECT-COMPUTER.        IBM-3090.                                00164000
003000                                                                  00165000
003100 INPUT-OUTPUT SECTION.                                            00166000
003200                                                                  00167000
003300 FILE-CONTROL.                                                    00168000
003400                                                                  00169000
004300                                                                  00230000
004400******************************************************************00240000
004500 DATA DIVISION.                                                   00250000
004600******************************************************************00260000
004700                                                                  00270000
004800 FILE SECTION.                                                    00280000
004900                                                                  00290000
  6100                                                                  00410000
006800******************************************************************00420000
006900 WORKING-STORAGE SECTION.                                         00430000
007000******************************************************************00440000
007100 01  ABEND-CODE                         PIC S9(04)  VALUE +0      00450000
007200                                                    COMP SYNC.    00460000
       01 CC-CONTROL-CARD.                                              00461000
           05  CC-RUN-DATE                     PIC X(10).               00462000
           05  FILLER                          PIC X(70).               00469000
007800                                                                  00469101
007300 01  PC-PROGRAM-CONSTANTS.                                        00470000
007400     05  PC-PGM-NAME             PIC  X(08)     VALUE 'IMKUT032'. 00480000
007600     05  PC-MAX-RETRIES          PIC S9(04)     VALUE +2.         00490000
009100                                                                  00516000
009200 01  PV-PROGRAM-VARIABLES.                                        00517000
009700     05  PV-PARAGRAPH-NAME              PIC  X(30)  VALUE SPACE.  00520000
009800     05  PV-DB2-OPERATION               PIC  X(30)  VALUE SPACE.  00530000
009900     05  PV-RETRY-COUNT                 PIC S9(04)  VALUE ZERO    00540000
010000                                                    COMP SYNC.    00550000
       01  PV-ITM-DOMAIN-END-OF-DAY.                                    00551002
           05  PV-MSG-TYPE                    PIC  9(03)  VALUE 998.    00551103
           05  FILLER1                        PIC  X(197) VALUE SPACE.  00551202
           05  PV-SYSTEM-DATE                 PIC  X(10)  VALUE SPACE.  00551302
           05  FILLER2                        PIC  X(240) VALUE SPACE.  00551402
013100                                                                  00600000
015210*--------------------------------------------------               00601002
015220*  ITEM BRIDGE MESSAGE COPYBOOK.                                  00602002
015230*--------------------------------------------------               00603002
013000     COPY IMRD008.                                                00610002
013100                                                                  00620002
015210*--------------------------------------------------               00660000
015220*  ITEM EVENT MESSAGE BRIDGE TABLE                                00670000
015230*--------------------------------------------------               00680000
015240     EXEC SQL                                                     00690000
015250         INCLUDE IMT00001                                         00700000
015260     END-EXEC.                                                    00710000
015270                                                                  00720000
015300*--------------------------------------------------               00800000
015400*  COMMUNICATION AREA FOR DB2                                     00810000
015500*--------------------------------------------------               00820000
015600     EXEC SQL                                                     00830000
015700         INCLUDE SQLCA                                            00840000
015800     END-EXEC.                                                    00850000
015900                                                                  00860000
016000*--------------------------------------------------               00870000
016100*  DB2 SQL ERROR ROUTINE                                          00880000
016200*--------------------------------------------------               00890000
016300     COPY DPWS004.                                                00900000
016400                                                                  00910000
016500 PROCEDURE DIVISION.                                              00920000
016600*-----------------------------------------------------------------00930000
016700*  GET SYSTEM DATE, INSERT ROW TO ITM_EVNT_MSG_BRG.               00940000
016900*-----------------------------------------------------------------00960000
017000 0000-MAINLINE.                                                   00970000
017100                                                                  00980000
017200     PERFORM 0100-INITIALIZE.                                     00990000
017300                                                                  01000000
017400     PERFORM 1000-INSERT-MSG.                                     01010000
017300                                                                  01020002
017800     GOBACK.                                                      01050000
017900                                                                  01060000
      ******************************************************************01061000
      * ACCEPT RUN DATE                                                 01062000
      ******************************************************************01063000
       0100-INITIALIZE.                                                 01064000
                                                                        01065000
      * GET ESP RUN DATE                                                01066000
           ACCEPT CC-CONTROL-CARD.                                      01067000
           DISPLAY 'ESP RUN DATE: ' CC-RUN-DATE.                        01068000
024300                                                                  01430000
028810*-----------------------------------------------------------------01700000
028820* INSERT ONE REC TO ITEM MESSAGE BRIDGE TABLE WITH MESSAGE TEXT   01710000
028830* REPRESENTING THE SYSTEM PROCESSING DATE.                        01720000
028840*-----------------------------------------------------------------01730000
028310 1000-INSERT-MSG.                                                 01731000
028861     INITIALIZE DCLIMT00001.                                      01760000
           INITIALIZE IMRD008-RECORD.                                   01760102
022400     COMPUTE IMT00001-MSG-TXT-LEN                                 01760202
022500               = LENGTH OF IMRD008-RECORD                         01760302
022600               - LENGTH OF IM008-ITM-DOMAIN-EOD-FILLER.           01760402
           MOVE CC-RUN-DATE TO PV-SYSTEM-DATE.                          01760502
           MOVE PV-ITM-DOMAIN-END-OF-DAY TO IMT00001-MSG-TXT-TEXT.      01760802
028862                                                                  01770000
028870     PERFORM WITH TEST AFTER                                      01780000
028880         VARYING PV-RETRY-COUNT FROM 1 BY 1                       01790000
028890           UNTIL SQLCODE = +0                                     01800000
028893              OR PV-RETRY-COUNT > PC-MAX-RETRIES                  01820000
028894         EXEC SQL                                                 01830000
                   INSERT INTO IMT_EVNT_MSG_BRG                         01831002
                       (  CRE_TMST                                      01832000
                         ,RMS_STYL_ID                                   01833000
                         ,BUS_EVNT_TYP_CDE                              01834000
                         ,MSG_TXT )                                     01835000
                   VALUES (CURRENT TIMESTAMP                            01836000
                           ,99999999.                                   01837002
                           ,998.                                        01838002
                           ,:IMT00001-MSG-TXT)                          01838104
028904         END-EXEC                                                 01890000
028905                                                                  01900000
028906         EVALUATE TRUE                                            01910000
028907             WHEN SQLCODE = -904                                  01920000
028908             WHEN SQLCODE = -913                                  01930000
028909                 CONTINUE                                         01940000
028910             WHEN SQLCODE = ZERO                                  01950000
028911                 CONTINUE                                         01960000
028914             WHEN OTHER                                           01990000
028915                 DISPLAY '** '                                    02000000
028916                         PC-PGM-NAME                              02010000
028924                 MOVE '1000-INSERT-MSG' TO PV-PARAGRAPH-NAME      02040002
028925                 MOVE 'INSERT TO ITM-EVNT-MSG-BRG'                02050002
028925                                             TO PV-DB2-OPERATION  02051002
028926                 PERFORM 9998-SQL-ERROR                           02060000
028927         END-EVALUATE                                             02070000
028928     END-PERFORM.                                                 02080000
028929                                                                  02090000
028930     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          02100000
028931         DISPLAY '** '                                            02110000
028932                 PC-PGM-NAME                                      02120000
028924         MOVE '1000-INSERT-MSG' TO PV-PARAGRAPH-NAME              02130002
028925         MOVE 'INSERT TO ITM-EVNT-MSG-BRG'                        02140002
028925                                     TO PV-DB2-OPERATION          02160002
028926         PERFORM 9998-SQL-ERROR                                   02170000
028940     END-IF.                                                      02180000
028942*-----------------------------------------------------------------02473500
028996                                                                  02473600
042500                                                                  02590000
043800                                                                  02720000
044200                                                                  02750000
045600*-----------------------------------------------------------------02870000
045700* 9800-SQL-ABEND - DISPLAY DB2 ABEND INFO                         02880000
045800*-----------------------------------------------------------------02890000
045900 9998-SQL-ERROR.                                                  02900000
046000                                                                  02910000
046200                                                                  02930000
046300     DISPLAY '** '                                                02940000
046400             PC-PGM-NAME                                          02950000
046500             ' ABEND IN PARAGRAPH '                               02960000
046600             PV-PARAGRAPH-NAME.                                   02970000
046700     DISPLAY '** '                                                02980000
046800             PC-PGM-NAME                                          02990000
046900             ' OPERATION = ' PV-DB2-OPERATION.                    03000000
047000                                                                  03010000
047100*    THE FOLLOWING COPYBOOK UTILIZES MODULE DSNTIAR TO FORMAT     03020000
047200*    THE INFO IN SQLCA INTO UNDERSTANDABLE VERBAGE.               03030000
047300     COPY DPPD004.                                                03040000
047400                                                                  03050000
047500     EXEC SQL                                                     03060000
047600         ROLLBACK                                                 03070000
047700     END-EXEC.                                                    03080000
047800                                                                  03090000
047900     MOVE +4013 TO ABEND-CODE                                     03100000
048000     PERFORM 9999-ABEND.                                          03110000
048100                                                                  03120000
048200*-----------------------------------------------------------------03130000
048300* 9999-ABEND - FORCES PROGRAM ABEND WITH RETURN CODE              03140000
048400*-----------------------------------------------------------------03150000
048500 9999-ABEND.                                                      03160000
048600                                                                  03170000
048700     CALL 'ILBOABN0' USING ABEND-CODE.                            03180000
048800                                                                  03190000
