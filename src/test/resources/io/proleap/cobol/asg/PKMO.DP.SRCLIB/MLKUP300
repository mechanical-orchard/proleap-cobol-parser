000100 IDENTIFICATION DIVISION.                                         00010000
000200                                                                  00020000
000300 PROGRAM-ID.    MLKUP300                                          00030000
000400 AUTHOR.        PAUL KEBER - STRATAGEM.                           00040000
000500 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00050000
000600 DATE-WRITTEN.  5-29-98.                                          00060000
000700 DATE-COMPILED.                                                   00070000
000800                                                                  00080000
000900******************************************************************00090000
001000*     MLKUP300 - WEEKLY SUBCLASS/STORE TABLE UPDATE PROGRAM      *00100000
001100******************************************************************00110000
001200*     THIS PROGRAM WILL MAINTAIN THE WEEKLY SUBCLASS STORE DB2   *00120000
001300* TABLE WITH THE CURRENT WEEK'S DATA.  THE TABLE IS READ USING   *00130000
001400* THE TABLE KEY FROM EACH SORT-SUMMED CONDENSED INPUT FILE       *00140000
001500* RECORD.  IF THE ROW IS FOUND, THE ROW IS UPDATED WITH DATA     *00150000
001600* FROM THE INPUT FILE RECORD.  IF THE ROW IS NOT FOUND, A NEW    *00160000
001700* ROW IS INSERTED ON THE DB2 TABLE (TWKSCLS).  COMMITS ARE TAKEN *00170000
001800* EVERY TEN SECONDS, AND CHECKPOINT RESTART LOGIC IS             *00180000
001900* INCORPORATED.                                                  *00190000
      *    WR/PITS#     DATE        DESCRIPTION                        *00200000
      *    --------   --------     ---------------------------------   *00210000
      *    5701       11/17/1998   MODIFIED WS ACCUM FIELDS TO MIMIC   *00220000
      *                            CHANGES MADE TO INPUT LAYOUT COPY-  *00230000
      *                            BOOK MLRD103 AND DCLGEN.            *00240000
      *                            ALL "AMT" FIELDS WERE CHANGED FROM  *00250000
      *                            PIC S9(07)V99 TO S9(09)V99.         *00260000
      *                            THIS WAS DONE DUE TO AN OVERFLOW ON *00270000
      *                            XFER_IN_RTL_AMT & XFER_OUT_RTL_AMT  *00280000
      *                            THAT OCCURRED WITHIN TWKSCLS        *00290000
      *                            DEPT 127; SCLS 80 ON 11/15/1998.    *00300000
      *                                                                *00310000
      *    10422      04/01/1999   ADDED LOGIC TO UPDATE SLS-RTL-AMT   *00320000
      *                            ON THE TWKSHNK TABLE WHENEVER THE   *00330000
      *                            TWKSCLS TABLE IS UPDATED IN ORDER   *00340000
      *                            TO KEEP THE DATA INTEGRITY BETWEEN  *00350000
      *                            THE TWO TABLES.  TDTATTR MUST BE    *00360000
      *                            READ TO GET THE FSCL_MN_END_DTE FOR *00370000
      *                            INSERTS ON THE TWKSHNK TABLE.       *00380000
W26603******************************************************************00390000
W26603* CHG ID   DATE        DESCRIPTION                               *00400000
W26603* ------   ----------  ----------------------------------------- *00410000
W26603* W26603   04-14-2004  STORE EXPANSION.  EXPANDED SOME PROGRAM   *00420000
W26603*                      VARIABLES TO ACCOMODATE INCREASED LENGTH  *00430000
W26603*                      OF DOLLAR AMOUNTS.  ADDED 'WITH UR' TO    *00440000
W26603*                      SOME DB2 SELECTS.                         *00450000
W26603*                                                                *00460000
W26603*                      - RONNA MCDONALD                          *00470000
002000******************************************************************00480000
002100                                                                  00490000
002200                                                                  00500000
002300 ENVIRONMENT DIVISION.                                            00510000
002400                                                                  00520000
002500 CONFIGURATION SECTION.                                           00530000
002600 SOURCE-COMPUTER.        IBM-3090.                                00540000
002700 OBJECT-COMPUTER.        IBM-3090.                                00550000
002800 INPUT-OUTPUT SECTION.                                            00560000
002900 FILE-CONTROL.                                                    00570000
003000     SELECT CONDENSED-FILE                                        00580000
003100         ASSIGN TO INP01.                                         00590000
003200                                                                  00600000
003300                                                                  00610000
003400 DATA DIVISION.                                                   00620000
003500 FILE SECTION.                                                    00630000
003600                                                                  00640000
003700 FD  CONDENSED-FILE                                               00650000
003800     LABEL RECORDS ARE STANDARD                                   00660000
003900     RECORDING MODE IS F                                          00670000
004000     BLOCK CONTAINS 0 RECORDS.                                    00680000
004100 01  CONDENSED-RECORD            PIC X(100).                      00690000
004200*                                                                 00700000
004300                                                                  00710000
004400                                                                  00720000
004500 WORKING-STORAGE SECTION.                                         00730000
004600                                                                  00740000
004700 01  ABEND-CODE                  PIC S9(04)  VALUE ZERO COMP SYNC.00750000
004800                                                                  00760000
004900 01  PC-PROGRAM-CONSTANTS.                                        00770000
005000     05  PC-JOB-NAME             PIC  X(06)    VALUE 'MLK205'.    00780000
005100     05  PC-PROGRAM-NAME         PIC  X(08)    VALUE 'MLKUP300'.  00790000
005200     05  PC-MAX-RETRIES          PIC S9(03) VALUE +3.             00800000
005300     05  PC-MAX-DEADLOCKS        PIC S9(03) VALUE +3.             00810000
005400                                                                  00820000
005500 01  PC-PROGRAM-COUNTER.                                          00830000
005600     05  PC-UPDATE-CNT           PIC  9(09).                      00840000
005600     05  PC-DISPLAY-CNT          PIC  9(09).                      00850000
005800                                                                  00860000
005900 01  PE-PROGRAM-ERROR-MESSAGES.                                   00870000
006000     05  PE-MSG-01                       PIC X(50) VALUE          00880000
006100          'ATTEMPT TO SELECT ROW FOR UPDATE/INSERT FAILED   '.    00890000
006200     05  PE-MSG-02                       PIC X(50) VALUE          00900000
006300          'ATTEMPT TO UPDATE ROW ON TABLE TWKSCLS FAILED    '.    00910000
006400     05  PE-MSG-03                       PIC X(50) VALUE          00920000
006500          'ATTEMPT TO INSERT ROW ON TABLE TWKSCLS FAILED    '.    00930000
006600     05  PE-MSG-04                       PIC X(50) VALUE          00940000
006700          'ERROR IN SELECT ''STATUS CODE'' FROM TCKRSTCNTL  '.    00950000
006800     05  PE-MSG-05                       PIC X(50) VALUE          00960000
006900          'UPDATE TO ''WORK_STRG_DESC'' ON TCKRSTINF FAILED '.    00970000
007000     05  PE-MSG-06                       PIC X(50) VALUE          00980000
007100          'PROGRAM ABENDED WHILE TRYING TO PERFORM A COMMIT '.    00990000
007200     05  PE-MSG-07                       PIC X(50) VALUE          01000000
007300          'PROGRAM MAXIMUM DEADLOCK COUNT HAS BEEN EXCEEDED'.     01010000
007400     05  PE-MSG-08                       PIC X(50) VALUE          01020000
007500          'AFTER DEADLOCK ERROR, AN UPDATE OR INSERT FAILED'.     01030000
007600     05  PE-MSG-09                       PIC X(50) VALUE          01040000
007700          'CHECKPNT RESTART FAILED UPON FIRST INSERT/UPDATE'.     01050000
007800     05  PE-MSG-10                       PIC X(50) VALUE          01060000
007900          'UPDATE OF STATUS CODE ON TCKRSTCNTL UNSUCCESSFUL'.     01070000
008000     05  PE-MSG-11                       PIC X(50) VALUE          01080000
008100          'ATTEMPT TO SELECT TIMESTAMP + CKPT_FRQNCY_QTY   '.     01090000
006200     05  PE-MSG-12                       PIC X(50) VALUE          01100000
006300          'ATTEMPT TO UPDATE ROW ON TABLE TWKSHNK FAILED    '.    01110000
006400     05  PE-MSG-13                       PIC X(50) VALUE          01120000
006500          'ATTEMPT TO INSERT ROW ON TABLE TWKSHNK FAILED    '.    01130000
008200*                                                                 01140000
008300 01  PS-PROGRAM-SWITCHES.                                         01150000
008400     05  PS-INPUT-FILE-EOF-SW         PIC  X        VALUE 'N'.    01160000
008500         88  PS-MORE-INPUT-RECORDS                  VALUE 'N'.    01170000
008600         88  PS-NO-MORE-INPUT-RECORDS               VALUE 'Y'.    01180000
008700     05  PS-EMPTY-FILE-SW             PIC  X        VALUE 'N'.    01190000
008800         88  PS-EMPTY-INPUT-FILE                    VALUE 'Y'.    01200000
008900     05  PS-FIRST-COMMIT-SW           PIC X         VALUE 'N'.    01210000
009000         88  PS-FIRST-COMMIT                        VALUE 'Y'.    01220000
009100     05  PS-DEADLOCK-RESTART-SW       PIC X         VALUE 'N'.    01230000
009200         88  PS-PROGRAM-DEADLOCKED                  VALUE 'Y'.    01240000
009300     05  PS-PROCESSING-OPTIONS        PIC X         VALUE 'P'.    01250000
009400         88  PS-UPDATE-WKSCLS-ROW                   VALUE 'U'.    01260000
009400         88  PS-UPDATE-WKSHNK-ROW                   VALUE 'U'.    01270000
009500         88  PS-INSERT-WKSCLS-ROW                   VALUE 'I'.    01280000
009500         88  PS-INSERT-WKSHNK-ROW                   VALUE 'I'.    01290000
009600*                                                                 01300000
009700*                                                                 01310000
009800 01  PROGRAM-VARIABLES.                                           01320000
009900     05  PV-DEADLOCK-COUNT               PIC S9(04) VALUE +0.     01330000
010000     05  PV-PARAGRAPH-NAME               PIC  X(30) VALUE SPACES. 01340000
010100     05  PV-ABEND-MESSAGE                PIC  X(75) VALUE SPACES. 01350000
010200     05  PV-OPERATION-ATTEMPTED          PIC  X(50) VALUE SPACES. 01360000
010300     05  PV-CURRENT-TIMESTAMP            PIC  X(26) VALUE SPACES. 01370000
010400     05  PV-COMMIT-TIMESTAMP             PIC  X(26) VALUE SPACES. 01380000
010500     05  PV-SQLCODE-DISPLAY              PIC  ++++9 VALUE ZERO.   01390000
010400     05  PV-FSCL-MN-END-DTE              PIC  X(10) VALUE SPACES. 01400000
010600*                                                                 01410000
010700*                                                                 01420000
010800 01  PA-PROGRAM-ACCUMULATORS.                                     01430000
010900     05  PA-RECORD-COUNTS.                                        01440000
011000         10  PA-INPUT-COUNT              PIC  9(9)  VALUE ZEROES. 01450000
011200         10  PA-UPD-TWKSCLS-COUNT        PIC  9(9)  VALUE ZEROES. 01460000
011200         10  PA-UPD-TWKSHNK-COUNT        PIC  9(9)  VALUE ZEROES. 01470000
011200         10  PA-INS-TWKSCLS-COUNT        PIC  9(9)  VALUE ZEROES. 01480000
011200         10  PA-INS-TWKSHNK-COUNT        PIC  9(9)  VALUE ZEROES. 01490000
011300         10  PA-SEL-TWKSCLS-COUNT        PIC  9(9)  VALUE ZEROES. 01500000
011300         10  PA-SEL-TWKSHNK-COUNT        PIC  9(9)  VALUE ZEROES. 01510000
011300         10  PA-SEL-TDTATTR-COUNT        PIC  9(9)  VALUE ZEROES. 01520000
011400         10  PA-COMMIT-COUNT             PIC  9(9)  VALUE ZEROES. 01530000
011500*                                                                 01540000
011600 01  PD-PROGRAM-DISPLAYS.                                         01550000
011700     05  PD-DEADLOCK-COUNT         PIC  9(04) VALUE 0.            01560000
011800*                                                                 01570000
011900 01  SAVE-AREA.                                                   01580000
012000     05  SV-FSCL-WK-END-DTE        PIC  X(10) VALUE SPACES.       01590000
1195RM*-  CHANGED THE FOLLOWING FIELDS FROM S9(7)V99 TO S9(09)V99.      01600000
012600     05  SV-UPDATE-FIELDS.                                        01610000
W26603         10  SV-RCPT-RTL-AMT       PIC S9(11)V99  COMP-3 VALUE +0.01620000
W26603         10  SV-RCPT-NET-COST      PIC S9(11)V99  COMP-3 VALUE +0.01630000
W26603         10  SV-PADJ-RTL-AMT       PIC S9(11)V99  COMP-3 VALUE +0.01640000
W26603         10  SV-PADJ-NET-COST      PIC S9(11)V99  COMP-3 VALUE +0.01650000
W26603         10  SV-SLS-RTL-AMT        PIC S9(11)V99  COMP-3 VALUE +0.01660000
W26603         10  SV-MKDN-RTL-AMT       PIC S9(11)V99  COMP-3 VALUE +0.01670000
W26603         10  SV-MKUP-RTL-AMT       PIC S9(11)V99  COMP-3 VALUE +0.01680000
W26603         10  SV-XFER-IN-RTL-AMT    PIC S9(11)V99  COMP-3 VALUE +0.01690000
W26603         10  SV-XFER-OUT-RTL       PIC S9(11)V99  COMP-3 VALUE +0.01700000
W26603         10  SV-INV-ADJ-RTL-AMT    PIC S9(11)V99  COMP-3 VALUE +0.01710000
013700*                                                                 01720000
013800*                                                                 01730000
013900******************************************************************01740000
014000* MLRD103 - M/L WEEKLY SUBCLASS STORE DATABASE UPDATE TXN         01750000
014100******************************************************************01760000
014200     COPY MLRD103.                                                01770000
014300*                                                                 01780000
014400******************************************************************01790000
014500*  DB2 ERROR MESSAGES FORMAT AREA.                                01800000
014600******************************************************************01810000
014700     COPY DPWS004.                                                01820000
014800*                                                                 01830000
014900******************************************************************01840000
015000*  USED FOR DB2 ERRORS                                            01850000
015100******************************************************************01860000
015200     EXEC SQL                                                     01870000
015300         INCLUDE SQLCA                                            01880000
015400     END-EXEC.                                                    01890000
015500*                                                                 01900000
015600******************************************************************01910000
015700*  M/L WEEKLY SUBCLASS STORE TABLE                                01920000
015800******************************************************************01930000
015900     EXEC SQL                                                     01940000
016000         INCLUDE TWKSCLS                                          01950000
016100     END-EXEC.                                                    01960000
015500*                                                                 01970000
015600******************************************************************01980000
015700*  M/L WEEKLY SHRINKAGE TABLE                                     01990000
015800******************************************************************02000000
015900     EXEC SQL                                                     02010000
016000         INCLUDE TWKSHNK                                          02020000
016100     END-EXEC.                                                    02030000
015500*                                                                 02040000
015600******************************************************************02050000
015700*  M/L DATE ATTRIBUTES TABLE                                      02060000
015800******************************************************************02070000
015900     EXEC SQL                                                     02080000
016000         INCLUDE TDTATTR                                          02090000
016100     END-EXEC.                                                    02100000
016200*                                                                 02110000
016300***************************************************************** 02120000
016400* DB2 CHECKPOINT RESTART CONTROL TABLE AND RESTART INFO TABLE     02130000
016500***************************************************************** 02140000
016600     EXEC SQL                                                     02150000
016700         INCLUDE TCKRSTCN                                         02160000
016800     END-EXEC.                                                    02170000
016900*                                                                 02180000
017000     EXEC SQL                                                     02190000
017100         INCLUDE TCKRSTIN                                         02200000
017200     END-EXEC.                                                    02210000
017300*                                                                 02220000
017400******************************************************************02230000
017500* CHECKPOINT RESTART VARIABLES AND PREV COMMIT VARIABLES.        *02240000
017600******************************************************************02250000
017700 01  CR-CHECKPOINT-RESTART-AREA.                                  02260000
017800     05  CR-AREA-LEN                  PIC S9(04) VALUE +104 COMP. 02270000
017900     05  CR-CHECKPOINT-RESTART-VAR.                               02280000
018000         10  CR-PREV-DTL-KEY          PIC  X(21) VALUE SPACES.    02290000
018100         10  FILLER REDEFINES CR-PREV-DTL-KEY.                    02300000
018200             15  CR-FISCAL-NBR        PIC  X(02).                 02310000
018300             15  CR-FISCAL-WK-END-DTE PIC  X(10).                 02320000
018400             15  CR-DEPT-NBR          PIC  X(03).                 02330000
018500             15  CR-SUB-CL-NBR        PIC  X(02).                 02340000
018600             15  CR-STR-NBR           PIC  9(04).                 02350000
018700         10  CR-INPUT-READ-COUNT      PIC  9(09) VALUE ZEROES.    02360000
018800         10  CR-TWKSCLS-COMMIT-COUNT  PIC  9(09) VALUE ZEROES.    02370000
018900         10  CR-UPD-TWKSCLS-COUNT     PIC  9(09) VALUE ZEROES.    02380000
018900         10  CR-UPD-TWKSHNK-COUNT     PIC  9(09) VALUE ZEROES.    02390000
018900         10  CR-INS-TWKSCLS-COUNT     PIC  9(09) VALUE ZEROES.    02400000
019000         10  CR-INS-TWKSHNK-COUNT     PIC  9(09) VALUE ZEROES.    02410000
019100         10  CR-SEL-TWKSCLS-COUNT     PIC  9(09) VALUE ZEROES.    02420000
019100         10  CR-SEL-TWKSHNK-COUNT     PIC  9(09) VALUE ZEROES.    02430000
019100         10  CR-SEL-TDTATTR-COUNT     PIC  9(09) VALUE ZEROES.    02440000
019200*                                                                 02450000
019300 01  CK-CHECKPOINT-SAVE-AREA.                                     02460000
019400     05  CK-SAVE-PREV-KEY         PIC  X(21) VALUE SPACES.        02470000
019500     05  FILLER REDEFINES CK-SAVE-PREV-KEY.                       02480000
019600         10  CK-FISCAL-NBR        PIC  X(02).                     02490000
019700         10  CK-FISCAL-WK-END-DTE PIC  X(10).                     02500000
019800         10  CK-DEPT-NBR          PIC  X(03).                     02510000
019900         10  CK-SUB-CL-NBR        PIC  X(02).                     02520000
020000         10  CK-STR-NBR           PIC  9(04).                     02530000
020100*                                                                 02540000
020400*                                                                 02550000
020500*-------------------*                                             02560000
020600 PROCEDURE DIVISION.                                              02570000
020700*-------------------*                                             02580000
020800                                                                  02590000
020900 0000-MAIN-MODULE.                                                02600000
021000                                                                  02610000
021100     PERFORM 1000-INITIALIZATION.                                 02620000
021200*                                                                 02630000
021300     PERFORM 2000-PROCESS-INPUT                                   02640000
021400          UNTIL PS-NO-MORE-INPUT-RECORDS.                         02650000
021500*                                                                 02660000
021600     PERFORM 8000-EOJ-ROUTINE.                                    02670000
021700                                                                  02680000
021800     STOP RUN.                                                    02690000
021900*                                                                 02700000
022000*                                                                 02710000
022100*                                                                 02720000
022200******************************************************************02730000
022300* OPEN INPUT FILE , INITIALIZE COUNTERS , READ FIRST INPUT RECORD 02740000
022400* PREPARE CHECKPOINT RESTART TABLES FOR PROCESSING / RESTART      02750000
022500******************************************************************02760000
022600*                                                                 02770000
022700 1000-INITIALIZATION.                                             02780000
022800*                                                                 02790000
022900     OPEN INPUT CONDENSED-FILE.                                   02800000
023000*                                                                 02810000
023100     PERFORM 7400-INIT-CHECKPOINT-SELECT.                         02820000
023200*                                                                 02830000
023300* CKPT-STAT-CODE = '9' INDICATES A RESTART CONDITION              02840000
023400     IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                           02850000
023500         PERFORM 7500-SELECT-RESTART-INFO                         02860000
023600         MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO                    02870000
023700                                       CR-CHECKPOINT-RESTART-VAR  02880000
023800         MOVE CR-PREV-DTL-KEY         TO CK-SAVE-PREV-KEY         02890000
023900* MOVE RESTART COUNTS TO PA-FIELDS FOR ACCURATE DISPLAY AT EOJ    02900000
024000         MOVE CR-UPD-TWKSCLS-COUNT    TO PA-UPD-TWKSCLS-COUNT     02910000
024000         MOVE CR-UPD-TWKSHNK-COUNT    TO PA-UPD-TWKSHNK-COUNT     02920000
024000         MOVE CR-INS-TWKSCLS-COUNT    TO PA-INS-TWKSCLS-COUNT     02930000
024100         MOVE CR-INS-TWKSHNK-COUNT    TO PA-INS-TWKSHNK-COUNT     02940000
024200         MOVE CR-SEL-TWKSCLS-COUNT    TO PA-SEL-TWKSCLS-COUNT     02950000
024200         MOVE CR-SEL-TWKSHNK-COUNT    TO PA-SEL-TWKSHNK-COUNT     02960000
024200         MOVE CR-SEL-TDTATTR-COUNT    TO PA-SEL-TDTATTR-COUNT     02970000
024300         MOVE CR-TWKSCLS-COMMIT-COUNT TO PA-COMMIT-COUNT          02980000
024400     ELSE                                                         02990000
024500         SET PS-FIRST-COMMIT TO TRUE                              03000000
024600     END-IF.                                                      03010000
024700*                                                                 03020000
024800     DISPLAY 'COMMITS WILL BE TAKEN EVERY ',                      03030000
024900             TCKRSTCNTL-CKPT-FRQNCY-QTY, ' SECONDS.'.             03040000
025000*                                                                 03050000
025100     PERFORM 4000-READ-CONDENSED-FILE UNTIL                       03060000
025200         PA-INPUT-COUNT > CR-INPUT-READ-COUNT                     03070000
025300      OR PS-NO-MORE-INPUT-RECORDS.                                03080000
025400*                                                                 03090000
025500     IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                           03100000
025600         DISPLAY 'FISCAL WEEK NBR      ' ML103-FSCL-WK-NBR        03110000
025700         DISPLAY 'FISCAL WEEK END DATE ' ML103-FSCL-WK-END-DTE    03120000
025800         DISPLAY 'DEPARTMENT NBR       ' ML103-DEPT-NBR           03130000
025900         DISPLAY 'SUB CLASS NBR        ' ML103-SUB-CL-NBR         03140000
026000         DISPLAY 'STORE NBR            ' ML103-STR-NBR            03150000
026100         DISPLAY 'INPUT RECORD RESTARTED ON RECORD '              03160000
026200                  PA-INPUT-COUNT                                  03170000
026300     END-IF.                                                      03180000
026400                                                                  03190000
026500     IF PS-NO-MORE-INPUT-RECORDS                                  03200000
026600         IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                       03210000
026700             CONTINUE                                             03220000
026800         ELSE                                                     03230000
026900             DISPLAY '** NO RECORDS ON INPUT FILE **'             03240000
027000     ELSE                                                         03250000
027100         PERFORM 7300-GET-COMMIT-TIMESTAMP                        03260000
027200     END-IF.                                                      03270000
027300*                                                                 03280000
027400*                                                                 03290000
027500******************************************************************03300000
027600* PROCESS THE SORTED/CONDENSED FILE - UPDATE OR INSERT AS NEEDED  03310000
027700******************************************************************03320000
027800 2000-PROCESS-INPUT.                                              03330000
027900*                                                                 03340000
028000     MOVE 'N' TO PS-DEADLOCK-RESTART-SW.                          03350000
028100*                                                                 03360000
028200     PERFORM 6000-SELECT-WKSCLS-ROW.                              03370000
028300*                                                                 03380000
028400     IF PS-PROGRAM-DEADLOCKED                                     03390000
028500         CONTINUE                                                 03400000
028600     ELSE                                                         03410000
028700         EVALUATE TRUE                                            03420000
028800             WHEN PS-UPDATE-WKSCLS-ROW                            03430000
028900                 PERFORM 6100-UPDATE-WKSCLS-ROW                   03440000
029000             WHEN PS-INSERT-WKSCLS-ROW                            03450000
029100                 PERFORM 6200-INSERT-WKSCLS-ROW                   03460000
029600         END-EVALUATE                                             03470000
029700     END-IF.                                                      03480000
028300*                                                                 03490000
028400     IF PS-PROGRAM-DEADLOCKED                                     03500000
030000         CONTINUE                                                 03510000
030100     ELSE                                                         03520000
028200         PERFORM 7000-SELECT-WKSHNK-ROW                           03530000
029700     END-IF.                                                      03540000
029800*                                                                 03550000
028400     IF PS-PROGRAM-DEADLOCKED                                     03560000
028500         CONTINUE                                                 03570000
028600     ELSE                                                         03580000
028700         EVALUATE TRUE                                            03590000
028800             WHEN PS-UPDATE-WKSHNK-ROW                            03600000
028900                 PERFORM 7100-UPDATE-WKSHNK-ROW                   03610000
029000             WHEN PS-INSERT-WKSHNK-ROW                            03620000
                       IF ML103-FSCL-WK-END-DTE NOT = SV-FSCL-WK-END-DTE03630000
029100                     PERFORM 7150-SELECT-DTATTR-MN-END-DTE        03640000
                       END-IF                                           03650000
029100                 PERFORM 7200-INSERT-WKSHNK-ROW                   03660000
029600         END-EVALUATE                                             03670000
029700     END-IF.                                                      03680000
028300*                                                                 03690000
029900     IF PS-PROGRAM-DEADLOCKED                                     03700000
030000         CONTINUE                                                 03710000
030100     ELSE                                                         03720000
030200         PERFORM 7700-COMMIT-PROCESSING                           03730000
030300         PERFORM 4000-READ-CONDENSED-FILE                         03740000
029700     END-IF.                                                      03750000
030400*                                                                 03760000
030500*                                                                 03770000
030600******************************************************************03780000
030700* CALCULATE FIELDS FOR UPDATE OF DATABASE                         03790000
030800******************************************************************03800000
030900 2100-CALCULATE-UPDATES.                                          03810000
031000* ADD DB2 TABLE ROW VALUES TO CURRENT INPUT RECORD ROW VALUES     03820000
031100*                                                                 03830000
031200     COMPUTE SV-SLS-RTL-AMT       =                               03840000
031300                      WKSCLS-SLS-RTL-AMT + ML103-SLS-RTL-AMT      03850000
031400*                                                                 03860000
031500     COMPUTE SV-MKDN-RTL-AMT      =                               03870000
031600                WKSCLS-MKDN-RTL-AMT     + ML103-MKDN-RTL-AMT      03880000
031700*                                                                 03890000
031800     COMPUTE SV-MKUP-RTL-AMT      =                               03900000
031900                WKSCLS-MKUP-RTL-AMT     + ML103-MKUP-RTL-AMT      03910000
032000*                                                                 03920000
032100     COMPUTE SV-XFER-IN-RTL-AMT   =                               03930000
032200                WKSCLS-XFER-IN-RTL-AMT  + ML103-XFER-IN-RTL-AMT   03940000
032300*                                                                 03950000
032400     COMPUTE SV-XFER-OUT-RTL      =                               03960000
032500                WKSCLS-XFER-OUT-RTL-AMT + ML103-XFER-OUT-RTL-AMT  03970000
032600*                                                                 03980000
032700     COMPUTE SV-RCPT-RTL-AMT      =                               03990000
032800                     WKSCLS-RCPT-RTL-AMT + ML103-RCPT-RTL-AMT     04000000
032900*                                                                 04010000
033000     COMPUTE SV-RCPT-NET-COST     =                               04020000
033100                WKSCLS-RCPT-NET-COST-AMT + ML103-RCPT-NET-COST-AMT04030000
033200*                                                                 04040000
033300     COMPUTE SV-PADJ-RTL-AMT      =                               04050000
033400                WKSCLS-PADJ-RTL-AMT     + ML103-PADJ-RTL-AMT      04060000
033500*                                                                 04070000
033600     COMPUTE SV-PADJ-NET-COST     =                               04080000
033700                WKSCLS-PADJ-NET-COST-AMT + ML103-PADJ-NET-COST-AMT04090000
033800*                                                                 04100000
033900     COMPUTE SV-INV-ADJ-RTL-AMT   =                               04110000
034000                WKSCLS-INV-ADJ-RTL-AMT  + ML103-INV-ADJ-RTL-AMT.  04120000
034100*                                                                 04130000
034200*                                                                 04140000
034300******************************************************************04150000
034400* READS THE CONDENSED FILE INTO THE TWKSCLS LAYOUT                04160000
034500******************************************************************04170000
034600 4000-READ-CONDENSED-FILE.                                        04180000
034700     READ CONDENSED-FILE INTO ML103-UPDATE-REC                    04190000
034800         AT END MOVE 'Y' TO PS-INPUT-FILE-EOF-SW.                 04200000
034900*                                                                 04210000
035000     IF PS-NO-MORE-INPUT-RECORDS                                  04220000
035100         MOVE ML103-FSCL-WK-NBR         TO CR-FISCAL-NBR          04230000
035200         MOVE ML103-FSCL-WK-END-DTE     TO CR-FISCAL-WK-END-DTE   04240000
035300         MOVE ML103-DEPT-NBR            TO CR-DEPT-NBR            04250000
035400         MOVE ML103-SUB-CL-NBR          TO CR-SUB-CL-NBR          04260000
035500         MOVE ML103-STR-NBR             TO CR-STR-NBR             04270000
035600         MOVE PA-INPUT-COUNT            TO CR-INPUT-READ-COUNT    04280000
035700*        MOVE COMMIT INFO TO WORKING STORAGE ROW                  04290000
035800         MOVE CR-CHECKPOINT-RESTART-AREA TO                       04300000
035900                                       TCKRSTINF-WORK-STRG-DESC   04310000
036000         EXEC SQL                                                 04320000
036100           UPDATE TCKRSTINF                                       04330000
036200              SET WORK_STRG_DESC = :TCKRSTINF-WORK-STRG-DESC      04340000
036300            WHERE JOB_NAME   = :PC-JOB-NAME                       04350000
036400              AND PLAN_NAME  = :PC-PROGRAM-NAME                   04360000
036500         END-EXEC                                                 04370000
036600         IF SQLCODE = 0                                           04380000
036700             CONTINUE                                             04390000
036800         ELSE                                                     04400000
036900             MOVE PE-MSG-05            TO PV-OPERATION-ATTEMPTED  04410000
037000             MOVE '* 4000-READ-CONDENSED-FILE *' TO               04420000
037100                  PV-PARAGRAPH-NAME                               04430000
037200             PERFORM 9999-SQL-ABEND                               04440000
037300         END-IF                                                   04450000
037400     ELSE                                                         04460000
037500         ADD 1                         TO PA-INPUT-COUNT          04470000
                                                PC-UPDATE-CNT           04480000
               IF PC-UPDATE-CNT > 100000                                04490000
                    ADD 1                    TO PC-DISPLAY-CNT          04500000
038000              DISPLAY 'UPDATE COUNT: ' PC-DISPLAY-CNT             04510000
                    MOVE +0                  TO PC-UPDATE-CNT           04520000
038100         END-IF                                                   04530000
038200     END-IF.                                                      04540000
038300*                                                                 04550000
038300*                                                                 04560000
038400******************************************************************04570000
038500* SELECT A ROW FROM THE WEEKLY SCL/STORE TABLE THAT MATCHES INPUT 04580000
038600*   KEY SQLCODE FROM 'SELECT' IS EVALUATED IN 2000-PROCESS-INPUT  04590000
038700******************************************************************04600000
038800 6000-SELECT-WKSCLS-ROW.                                          04610000
038900*                                                                 04620000
039000     EXEC SQL                                                     04630000
039100         SELECT SLS_RTL_AMT                                       04640000
039200               ,MKDN_RTL_AMT                                      04650000
039300               ,MKUP_RTL_AMT                                      04660000
039400               ,XFER_IN_RTL_AMT                                   04670000
039500               ,XFER_OUT_RTL_AMT                                  04680000
039600               ,RCPT_RTL_AMT                                      04690000
039700               ,RCPT_NET_COST_AMT                                 04700000
039800               ,PADJ_RTL_AMT                                      04710000
039900               ,PADJ_NET_COST_AMT                                 04720000
040000               ,INV_ADJ_RTL_AMT                                   04730000
040100           INTO :WKSCLS-SLS-RTL-AMT                               04740000
040200               ,:WKSCLS-MKDN-RTL-AMT                              04750000
040300               ,:WKSCLS-MKUP-RTL-AMT                              04760000
040400               ,:WKSCLS-XFER-IN-RTL-AMT                           04770000
040500               ,:WKSCLS-XFER-OUT-RTL-AMT                          04780000
040600               ,:WKSCLS-RCPT-RTL-AMT                              04790000
040700               ,:WKSCLS-RCPT-NET-COST-AMT                         04800000
040800               ,:WKSCLS-PADJ-RTL-AMT                              04810000
040900               ,:WKSCLS-PADJ-NET-COST-AMT                         04820000
041000               ,:WKSCLS-INV-ADJ-RTL-AMT                           04830000
041100         FROM TWKSCLS                                             04840000
041200        WHERE   FSCL_WK_NBR         = :ML103-FSCL-WK-NBR          04850000
041300          AND   FSCL_WK_END_DTE     = :ML103-FSCL-WK-END-DTE      04860000
041400          AND   DEPT_NBR            = :ML103-DEPT-NBR             04870000
041500          AND   SUB_CL_NBR          = :ML103-SUB-CL-NBR           04880000
041600          AND   STR_NBR             = :ML103-STR-NBR              04890000
W26603        WITH UR                                                   04900000
041700     END-EXEC.                                                    04910000
041800*                                                                 04920000
041900     EVALUATE SQLCODE                                             04930000
042000         WHEN 0                                                   04940000
054300             MOVE ZERO                   TO PV-DEADLOCK-COUNT     04950000
042100             SET PS-UPDATE-WKSCLS-ROW    TO TRUE                  04960000
042200             ADD +1                      TO PA-SEL-TWKSCLS-COUNT  04970000
042300         WHEN +100                                                04980000
054300             MOVE ZERO                   TO PV-DEADLOCK-COUNT     04990000
042400             SET PS-INSERT-WKSCLS-ROW    TO TRUE                  05000000
042500         WHEN -911                                                05010000
042600             ADD +1             TO PV-DEADLOCK-COUNT              05020000
042700             DISPLAY 'DEADLOCK -911 IN 6000-SELECT-WKSCLS-ROW'    05030000
042800             IF PV-DEADLOCK-COUNT > PC-MAX-DEADLOCKS              05040000
042900                 MOVE '6000-SELECT-WKSCLS-ROW'                    05050000
043000                                           TO PV-PARAGRAPH-NAME   05060000
043100                 PERFORM 9000-DEADLOCK-ERROR                      05070000
043200             ELSE                                                 05080000
043300                 PERFORM 7999-RESTART-PROCESS                     05090000
043400             END-IF                                               05100000
043500         WHEN OTHER                                               05110000
043600             MOVE '6000-SELECT-WKSCLS-ROW' TO PV-PARAGRAPH-NAME   05120000
043700             MOVE PE-MSG-01 TO PV-OPERATION-ATTEMPTED             05130000
043800             PERFORM 9999-SQL-ABEND                               05140000
043900     END-EVALUATE.                                                05150000
044000*                                                                 05160000
044100*                                                                 05170000
044200***************************************************************** 05180000
044300* THE INPUT RECORD FOUND A MATCHING ROW BASED ON FSCL INFO, DEPT, 05190000
044400* SUB CLASS, AND STORE NUMBER.  CURRENT TABLE VALUES ARE UPDATED  05200000
044500* TO INCLUDE VALUES FROM THE INPUT RECORD.                        05210000
044600***************************************************************** 05220000
044700 6100-UPDATE-WKSCLS-ROW.                                          05230000
044800*                                                                 05240000
044900*                                                                 05250000
045000     PERFORM 2100-CALCULATE-UPDATES.                              05260000
045100*                                                                 05270000
045200     EXEC SQL                                                     05280000
045300         UPDATE TWKSCLS                                           05290000
045400             SET SLS_RTL_AMT         = :SV-SLS-RTL-AMT            05300000
045500               , MKDN_RTL_AMT        = :SV-MKDN-RTL-AMT           05310000
045600               , MKUP_RTL_AMT        = :SV-MKUP-RTL-AMT           05320000
045700               , XFER_IN_RTL_AMT     = :SV-XFER-IN-RTL-AMT        05330000
045800               , XFER_OUT_RTL_AMT    = :SV-XFER-OUT-RTL           05340000
045900               , RCPT_RTL_AMT        = :SV-RCPT-RTL-AMT           05350000
046000               , RCPT_NET_COST_AMT   = :SV-RCPT-NET-COST          05360000
046100               , PADJ_RTL_AMT        = :SV-PADJ-RTL-AMT           05370000
046200               , PADJ_NET_COST_AMT   = :SV-PADJ-NET-COST          05380000
046300               , INV_ADJ_RTL_AMT     = :SV-INV-ADJ-RTL-AMT        05390000
046400        WHERE   FSCL_WK_NBR         = :ML103-FSCL-WK-NBR          05400000
046500          AND   FSCL_WK_END_DTE     = :ML103-FSCL-WK-END-DTE      05410000
046600          AND   DEPT_NBR            = :ML103-DEPT-NBR             05420000
046700          AND   SUB_CL_NBR          = :ML103-SUB-CL-NBR           05430000
046800          AND   STR_NBR             = :ML103-STR-NBR              05440000
046900     END-EXEC.                                                    05450000
047000*                                                                 05460000
047100     EVALUATE SQLCODE                                             05470000
047200         WHEN 0                                                   05480000
054300             MOVE ZERO          TO PV-DEADLOCK-COUNT              05490000
049300             ADD 1              TO PA-UPD-TWKSCLS-COUNT           05500000
047400         WHEN -911                                                05510000
047500             ADD +1             TO PV-DEADLOCK-COUNT              05520000
047600             DISPLAY 'DEADLOCK -911 IN 6100-UPDATE-WKSCLS-ROW'    05530000
047700             IF PV-DEADLOCK-COUNT > PC-MAX-DEADLOCKS              05540000
047800                 MOVE '6100-UPDATE-WKSCLS-ROW'                    05550000
047900                                TO PV-PARAGRAPH-NAME              05560000
048000                 PERFORM 9000-DEADLOCK-ERROR                      05570000
048100             ELSE                                                 05580000
048200                 PERFORM 7999-RESTART-PROCESS                     05590000
048300             END-IF                                               05600000
048400         WHEN OTHER                                               05610000
048500             MOVE '6100-UPDATE-WKSCLS-ROW'                        05620000
047900                                TO PV-PARAGRAPH-NAME              05630000
048600             MOVE PE-MSG-02     TO PV-OPERATION-ATTEMPTED         05640000
048700             PERFORM 9999-SQL-ABEND                               05650000
048800     END-EVALUATE.                                                05660000
048900*                                                                 05670000
049600*                                                                 05680000
049700***************************************************************** 05690000
049800* THERE WAS NO MATCHING ROW ON THE WEEKLY SCL/STORE TABLE.      * 05700000
049900* - ENTRY FOR THIS ENTITY IS INSERTED AS A 'NEW' ROW            * 05710000
050000***************************************************************** 05720000
050100 6200-INSERT-WKSCLS-ROW.                                          05730000
050200*                                                                 05740000
050300*                                                                 05750000
050400     EXEC SQL                                                     05760000
050500         INSERT INTO TWKSCLS                                      05770000
050600             (   FSCL_WK_NBR                                      05780000
050700               , FSCL_WK_END_DTE                                  05790000
050800               , DEPT_NBR                                         05800000
050900               , SUB_CL_NBR                                       05810000
051000               , STR_NBR                                          05820000
051100               , SLS_RTL_AMT                                      05830000
051200               , MKDN_RTL_AMT                                     05840000
051300               , MKUP_RTL_AMT                                     05850000
051400               , XFER_IN_RTL_AMT                                  05860000
051500               , XFER_OUT_RTL_AMT                                 05870000
051600               , RCPT_RTL_AMT                                     05880000
051700               , RCPT_NET_COST_AMT                                05890000
051800               , PADJ_RTL_AMT                                     05900000
051900               , PADJ_NET_COST_AMT                                05910000
052000               , INV_ADJ_RTL_AMT   )                              05920000
052100         VALUES                                                   05930000
052200             (   :ML103-FSCL-WK-NBR                               05940000
052300               , :ML103-FSCL-WK-END-DTE                           05950000
052400               , :ML103-DEPT-NBR                                  05960000
052500               , :ML103-SUB-CL-NBR                                05970000
052600               , :ML103-STR-NBR                                   05980000
052700               , :ML103-SLS-RTL-AMT                               05990000
052800               , :ML103-MKDN-RTL-AMT                              06000000
052900               , :ML103-MKUP-RTL-AMT                              06010000
053000               , :ML103-XFER-IN-RTL-AMT                           06020000
053100               , :ML103-XFER-OUT-RTL-AMT                          06030000
053200               , :ML103-RCPT-RTL-AMT                              06040000
053300               , :ML103-RCPT-NET-COST-AMT                         06050000
053400               , :ML103-PADJ-RTL-AMT                              06060000
053500               , :ML103-PADJ-NET-COST-AMT                         06070000
053600               , :ML103-INV-ADJ-RTL-AMT  )                        06080000
053700     END-EXEC.                                                    06090000
053800*                                                                 06100000
053900     EVALUATE SQLCODE                                             06110000
054000         WHEN 0                                                   06120000
054300             MOVE ZERO          TO PV-DEADLOCK-COUNT              06130000
056100             ADD 1              TO PA-INS-TWKSCLS-COUNT           06140000
054200         WHEN -911                                                06150000
054300             ADD +1             TO PV-DEADLOCK-COUNT              06160000
054400             DISPLAY 'DEADLOCK -911 IN 6200-INSERT-WKSCLS-ROW'    06170000
054500             IF PV-DEADLOCK-COUNT > PC-MAX-DEADLOCKS              06180000
054600                 MOVE '6200-INSERT-WKSCLS-ROW' TO                 06190000
054700                                              PV-PARAGRAPH-NAME   06200000
054800                 PERFORM 9000-DEADLOCK-ERROR                      06210000
054900             ELSE                                                 06220000
055000                 PERFORM 7999-RESTART-PROCESS                     06230000
055100             END-IF                                               06240000
055200         WHEN OTHER                                               06250000
055300             MOVE '6200-INSERT-WKSCLS-ROW' TO PV-PARAGRAPH-NAME   06260000
055400             MOVE PE-MSG-03              TO PV-OPERATION-ATTEMPTED06270000
055500             PERFORM 9999-SQL-ABEND                               06280000
055600     END-EVALUATE.                                                06290000
055700*                                                                 06300000
038300*                                                                 06310000
038400******************************************************************06320000
038500* SELECT A ROW FROM THE WEEKLY SHRINKAGE TABLE THAT MATCHES INPUT 06330000
038600* KEY SQLCODE.  FROM 'SELECT' IS EVALUATED IN 2000-PROCESS-INPUT  06340000
038700******************************************************************06350000
038800 7000-SELECT-WKSHNK-ROW.                                          06360000
038900*                                                                 06370000
039000     EXEC SQL                                                     06380000
039100         SELECT SLS_RTL_AMT                                       06390000
040100           INTO :WKSHNK-SLS-RTL-AMT                               06400000
041100         FROM TWKSHNK                                             06410000
046500        WHERE   FSCL_WK_END_DTE     = :ML103-FSCL-WK-END-DTE      06420000
041400          AND   DEPT_NBR            = :ML103-DEPT-NBR             06430000
041500          AND   SUB_CL_NBR          = :ML103-SUB-CL-NBR           06440000
041600          AND   STR_NBR             = :ML103-STR-NBR              06450000
W26603        WITH UR                                                   06460000
041700     END-EXEC.                                                    06470000
041800*                                                                 06480000
041900     EVALUATE SQLCODE                                             06490000
042000         WHEN 0                                                   06500000
054300             MOVE ZERO                   TO PV-DEADLOCK-COUNT     06510000
042100             SET PS-UPDATE-WKSHNK-ROW    TO TRUE                  06520000
042200             ADD +1                      TO PA-SEL-TWKSHNK-COUNT  06530000
042300         WHEN +100                                                06540000
054300             MOVE ZERO                   TO PV-DEADLOCK-COUNT     06550000
042400             SET PS-INSERT-WKSHNK-ROW    TO TRUE                  06560000
042500         WHEN -911                                                06570000
042600             ADD +1             TO PV-DEADLOCK-COUNT              06580000
042700             DISPLAY 'DEADLOCK -911 IN 7000-SELECT-WKSHNK-ROW'    06590000
042800             IF PV-DEADLOCK-COUNT > PC-MAX-DEADLOCKS              06600000
042900                 MOVE '7000-SELECT-WKSHNK-ROW'                    06610000
043000                                           TO PV-PARAGRAPH-NAME   06620000
043100                 PERFORM 9000-DEADLOCK-ERROR                      06630000
043200             ELSE                                                 06640000
043300                 PERFORM 7999-RESTART-PROCESS                     06650000
043400             END-IF                                               06660000
043500         WHEN OTHER                                               06670000
043600             MOVE '7000-SELECT-WKSHNK-ROW' TO PV-PARAGRAPH-NAME   06680000
043700             MOVE PE-MSG-01 TO PV-OPERATION-ATTEMPTED             06690000
043800             PERFORM 9999-SQL-ABEND                               06700000
043900     END-EVALUATE.                                                06710000
044000*                                                                 06720000
044100*                                                                 06730000
044200***************************************************************** 06740000
044300* UPDATE THE SALES RETAIL AMOUNT ON TWKSHNK FOR THE ROW WHICH     06750000
044400* MATCHES THE UPDATED TWKSCLS ROW.                                06760000
044600***************************************************************** 06770000
044700 7100-UPDATE-WKSHNK-ROW.                                          06780000
044800*                                                                 06790000
044900*                                                                 06800000
031200     COMPUTE SV-SLS-RTL-AMT       =                               06810000
031300                      WKSHNK-SLS-RTL-AMT + ML103-SLS-RTL-AMT      06820000
044900*                                                                 06830000
045200     EXEC SQL                                                     06840000
045300         UPDATE TWKSHNK                                           06850000
045400             SET SLS_RTL_AMT         = :SV-SLS-RTL-AMT            06860000
046500        WHERE   FSCL_WK_END_DTE     = :ML103-FSCL-WK-END-DTE      06870000
046600          AND   DEPT_NBR            = :ML103-DEPT-NBR             06880000
046700          AND   SUB_CL_NBR          = :ML103-SUB-CL-NBR           06890000
046800          AND   STR_NBR             = :ML103-STR-NBR              06900000
046900     END-EXEC.                                                    06910000
047000*                                                                 06920000
047100     EVALUATE SQLCODE                                             06930000
047200         WHEN 0                                                   06940000
054300             MOVE ZERO          TO PV-DEADLOCK-COUNT              06950000
049300             ADD 1              TO PA-UPD-TWKSHNK-COUNT           06960000
047400         WHEN -911                                                06970000
047500             ADD +1             TO PV-DEADLOCK-COUNT              06980000
047600             DISPLAY 'DEADLOCK -911 IN 7100-UPDATE-WKSHNK-ROW'    06990000
047700             IF PV-DEADLOCK-COUNT > PC-MAX-DEADLOCKS              07000000
047800                 MOVE '7100-UPDATE-WKSHNK-ROW' TO                 07010000
047900                                              PV-PARAGRAPH-NAME   07020000
048000                 PERFORM 9000-DEADLOCK-ERROR                      07030000
048100             ELSE                                                 07040000
048200                 PERFORM 7999-RESTART-PROCESS                     07050000
048300             END-IF                                               07060000
048400         WHEN OTHER                                               07070000
048500             MOVE '7100-UPDATE-WKSHNK-ROW' TO PV-PARAGRAPH-NAME   07080000
048600             MOVE PE-MSG-12              TO PV-OPERATION-ATTEMPTED07090000
048700             PERFORM 9999-SQL-ABEND                               07100000
048800     END-EVALUATE.                                                07110000
038300*                                                                 07120000
038300*                                                                 07130000
038400******************************************************************07140000
038500* SELECT THE FISCAL MONTH END DATE FROM THE M/L DATE ATTRIBUTES   07150000
038500* TABLE FOR THE INPUT FISCAL WEEK END DATE.                       07160000
038700******************************************************************07170000
038800 7150-SELECT-DTATTR-MN-END-DTE.                                   07180000
038900*                                                                 07190000
039000     EXEC SQL                                                     07200000
039100         SELECT FSCL_MN_END_DTE                                   07210000
040100           INTO :DTATTR-FSCL-MN-END-DTE                           07220000
041100         FROM TDTATTR                                             07230000
041200        WHERE   KY_DTE = :ML103-FSCL-WK-END-DTE                   07240000
W26603        WITH UR                                                   07250000
041700     END-EXEC.                                                    07260000
041800*                                                                 07270000
041900     EVALUATE SQLCODE                                             07280000
042000         WHEN 0                                                   07290000
054300             MOVE ZERO          TO PV-DEADLOCK-COUNT              07300000
042200             ADD +1             TO PA-SEL-TDTATTR-COUNT           07310000
042200             MOVE DTATTR-FSCL-MN-END-DTE                          07320000
042200                                TO PV-FSCL-MN-END-DTE             07330000
042500         WHEN -911                                                07340000
042600             ADD +1             TO PV-DEADLOCK-COUNT              07350000
042700             DISPLAY 'DEADLOCK -911 IN 7150-SELECT-DTATTR'        07360000
042800             IF PV-DEADLOCK-COUNT > PC-MAX-DEADLOCKS              07370000
042900                 MOVE '7150-SELECT-DTATTR' TO                     07380000
043000                                              PV-PARAGRAPH-NAME   07390000
043100                 PERFORM 9000-DEADLOCK-ERROR                      07400000
043200             ELSE                                                 07410000
043300                 PERFORM 7999-RESTART-PROCESS                     07420000
043400             END-IF                                               07430000
043500         WHEN OTHER                                               07440000
043600             MOVE '7150-SELECT-DTATTR'   TO PV-PARAGRAPH-NAME     07450000
043700             MOVE PE-MSG-01 TO PV-OPERATION-ATTEMPTED             07460000
043800             PERFORM 9999-SQL-ABEND                               07470000
043900     END-EVALUATE.                                                07480000
048900*                                                                 07490000
049600*                                                                 07500000
049700***************************************************************** 07510000
044300* INSERT THE SALES RETAIL AMOUNT ON TWKSHNK FOR THE ROW WHICH     07520000
044400* MATCHES THE INSERTED TWKSCLS ROW.                               07530000
050000***************************************************************** 07540000
050100 7200-INSERT-WKSHNK-ROW.                                          07550000
050200*                                                                 07560000
050300*                                                                 07570000
050400     EXEC SQL                                                     07580000
050500         INSERT INTO TWKSHNK                                      07590000
050700             (   FSCL_WK_END_DTE                                  07600000
050800               , DEPT_NBR                                         07610000
050900               , SUB_CL_NBR                                       07620000
051000               , STR_NBR                                          07630000
050700               , FSCL_MN_END_DTE                                  07640000
051100               , SLS_RTL_AMT                                      07650000
052000               , SHNK_RTL_AMT   )                                 07660000
052100         VALUES                                                   07670000
052300             (   :ML103-FSCL-WK-END-DTE                           07680000
052400               , :ML103-DEPT-NBR                                  07690000
052500               , :ML103-SUB-CL-NBR                                07700000
052600               , :ML103-STR-NBR                                   07710000
052600               , :PV-FSCL-MN-END-DTE                              07720000
052700               , :ML103-SLS-RTL-AMT                               07730000
053600               , 0                    )                           07740000
053700     END-EXEC.                                                    07750000
053800*                                                                 07760000
053900     EVALUATE SQLCODE                                             07770000
054000         WHEN 0                                                   07780000
054300             MOVE ZERO          TO PV-DEADLOCK-COUNT              07790000
049300             ADD 1              TO PA-INS-TWKSHNK-COUNT           07800000
054200         WHEN -911                                                07810000
054300             ADD +1             TO PV-DEADLOCK-COUNT              07820000
054400             DISPLAY 'DEADLOCK -911 IN 7200-INSERT-WKSHNK-ROW'    07830000
054500             IF PV-DEADLOCK-COUNT > PC-MAX-DEADLOCKS              07840000
054600                 MOVE '7200-INSERT-WKSHNK-ROW' TO                 07850000
054700                                              PV-PARAGRAPH-NAME   07860000
054800                 PERFORM 9000-DEADLOCK-ERROR                      07870000
054900             ELSE                                                 07880000
055000                 PERFORM 7999-RESTART-PROCESS                     07890000
055100             END-IF                                               07900000
055200         WHEN OTHER                                               07910000
055300             MOVE '7200-INSERT-WKSHNK-ROW' TO PV-PARAGRAPH-NAME   07920000
055400             MOVE PE-MSG-13              TO PV-OPERATION-ATTEMPTED07930000
055500             PERFORM 9999-SQL-ABEND                               07940000
055600     END-EVALUATE.                                                07950000
055700*                                                                 07960000
056400*                                                                 07970000
056500******************************************************************07980000
056600* 7300-GET-COMMIT-TIMESTAMP.                                     *07990000
056700* PROCESSES: GET THE COMMIT TIMESTAMP FROM THE CHECKPOINT        *08000000
056800*            CONTROL TABLE                                       *08010000
056900******************************************************************08020000
057000 7300-GET-COMMIT-TIMESTAMP.                                       08030000
057100                                                                  08040000
057200     EXEC SQL                                                     08050000
057300* CHECKPOINT TAKEN BASED ON CHEKPOINT RESTART CICSP1 PANEL        08060000
057400       SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)       08070000
057500         INTO :PV-COMMIT-TIMESTAMP                                08080000
057600         FROM TCKRSTCNTL                                          08090000
057700        WHERE JOB_NAME  = :PC-JOB-NAME                            08100000
057800          AND PLAN_NAME = :PC-PROGRAM-NAME                        08110000
057900     END-EXEC.                                                    08120000
058000                                                                  08130000
060900     IF SQLCODE = 0                                               08140000
061000         CONTINUE                                                 08150000
061100     ELSE                                                         08160000
00             MOVE '7300-GET-COMMIT-TIMESTAMP' TO PV-PARAGRAPH-NAME    08170000
00             MOVE PE-MSG-11             TO PV-OPERATION-ATTEMPTED     08180000
00             PERFORM 9999-SQL-ABEND                                   08190000
058900     END-IF.                                                      08200000
059000*                                                                 08210000
059100*                                                                 08220000
059200******************************************************************08230000
059300* 7400-INIT-CHECKPOINT-SELECT                                    *08240000
059400* PROCESSES: SELECTS FROM THE CHECKPOINT RESTART CONTROL TABLE   *08250000
059500*            IF WE ARE IN A RESTART CONDITION.                   *08260000
059600******************************************************************08270000
059700 7400-INIT-CHECKPOINT-SELECT.                                     08280000
059800                                                                  08290000
059900     EXEC SQL                                                     08300000
060000       SELECT  CKPT_STAT_CODE                                     08310000
060100              ,CKPT_FRQNCY_QTY                                    08320000
060200         INTO  :TCKRSTCNTL-CKPT-STAT-CODE                         08330000
060300              ,:TCKRSTCNTL-CKPT-FRQNCY-QTY                        08340000
060400         FROM  TCKRSTCNTL                                         08350000
060500        WHERE  JOB_NAME  = :PC-JOB-NAME                           08360000
060600          AND  PLAN_NAME = :PC-PROGRAM-NAME                       08370000
060700     END-EXEC.                                                    08380000
060800                                                                  08390000
060900     IF SQLCODE = 0                                               08400000
061000         CONTINUE                                                 08410000
061100     ELSE                                                         08420000
061200         MOVE '7400-INIT-CHECKPOINT-SELECT' TO PV-PARAGRAPH-NAME  08430000
061300         MOVE PE-MSG-04             TO PV-OPERATION-ATTEMPTED     08440000
061400         PERFORM 9999-SQL-ABEND                                   08450000
061500     END-IF.                                                      08460000
061600*                                                                 08470000
061700*                                                                 08480000
061800******************************************************************08490000
061900* 7500-SELECT-RESTART-INFO                                       *08500000
062000* PROCESSES: SELECTS FROM THE CHECKPOINT RESTART INFORMATION     *08510000
062100*            TABLE TO OBTAIN THE PROGRAMS SAVED VARIABLES.       *08520000
062200******************************************************************08530000
062300 7500-SELECT-RESTART-INFO.                                        08540000
062400                                                                  08550000
062500     EXEC SQL                                                     08560000
062600       SELECT  WORK_STRG_DESC                                     08570000
062700         INTO  :TCKRSTINF-WORK-STRG-DESC                          08580000
062800         FROM  TCKRSTINF                                          08590000
062900        WHERE  JOB_NAME  = :PC-JOB-NAME                           08600000
063000          AND  PLAN_NAME = :PC-PROGRAM-NAME                       08610000
063100     END-EXEC.                                                    08620000
063200                                                                  08630000
063300     IF SQLCODE = 0                                               08640000
063400         CONTINUE                                                 08650000
063500     ELSE                                                         08660000
063600         MOVE '*7500-SELECT-RESTART-INFO*' TO PV-PARAGRAPH-NAME   08670000
063700         PERFORM 9999-SQL-ABEND                                   08680000
063800     END-IF.                                                      08690000
063900*                                                                 08700000
064000*                                                                 08710000
064100******************************************************************08720000
064200* 7600-SET-CURRENT-TIMESTAMP.                                    *08730000
064300* PROCESSES: GET THE CURRENT TIMESTAMP FROM DB2.                 *08740000
064400******************************************************************08750000
064500 7600-SET-CURRENT-TIMESTAMP.                                      08760000
064600                                                                  08770000
064700     EXEC SQL                                                     08780000
064800          SET :PV-CURRENT-TIMESTAMP = CURRENT TIMESTAMP           08790000
064900     END-EXEC.                                                    08800000
065000*                                                                 08810000
065100     IF SQLCODE = 0                                               08820000
065200         CONTINUE                                                 08830000
065300     ELSE                                                         08840000
065400         MOVE '*7600-SET-CURRENT-TIMESTAMP*' TO PV-PARAGRAPH-NAME 08850000
065500         PERFORM 9999-SQL-ABEND                                   08860000
065600     END-IF.                                                      08870000
065700*                                                                 08880000
065800*                                                                 08890000
065900******************************************************************08900000
066000* 7700-COMMIT-PROCESSING.                                        *08910000
066100* PROCESSES: CHECK IF WE NEED TO TAKE A COMMIT.                  *08920000
066200*          PREPARE CHECKPOINT RECORD FOR UPDATE OF WORK_STRG_DESC*08930000
066300******************************************************************08940000
066400 7700-COMMIT-PROCESSING.                                          08950000
066500     MOVE '*7700-COMMIT-PROCESSING*'    TO PV-PARAGRAPH-NAME.     08960000
066600                                                                  08970000
066700     PERFORM 7600-SET-CURRENT-TIMESTAMP.                          08980000
066800*                                                                 08990000
066900     IF PV-CURRENT-TIMESTAMP > PV-COMMIT-TIMESTAMP                09000000
067000*        PREPARE COMMIT RECORD FOR UPDATE                         09010000
067100         ADD 1                          TO PA-COMMIT-COUNT        09020000
067200         MOVE ML103-FSCL-WK-NBR         TO CR-FISCAL-NBR          09030000
067300         MOVE ML103-FSCL-WK-END-DTE     TO CR-FISCAL-WK-END-DTE   09040000
067400         MOVE ML103-DEPT-NBR            TO CR-DEPT-NBR            09050000
067500         MOVE ML103-SUB-CL-NBR          TO CR-SUB-CL-NBR          09060000
067600         MOVE ML103-STR-NBR             TO CR-STR-NBR             09070000
067700         MOVE PA-COMMIT-COUNT           TO CR-TWKSCLS-COMMIT-COUNT09080000
067800         MOVE PA-INPUT-COUNT            TO CR-INPUT-READ-COUNT    09090000
067900         MOVE PA-UPD-TWKSCLS-COUNT      TO CR-UPD-TWKSCLS-COUNT   09100000
067900         MOVE PA-UPD-TWKSHNK-COUNT      TO CR-UPD-TWKSHNK-COUNT   09110000
067900         MOVE PA-INS-TWKSCLS-COUNT      TO CR-INS-TWKSCLS-COUNT   09120000
068000         MOVE PA-INS-TWKSHNK-COUNT      TO CR-INS-TWKSHNK-COUNT   09130000
068100         MOVE PA-SEL-TWKSCLS-COUNT      TO CR-SEL-TWKSCLS-COUNT   09140000
068100         MOVE PA-SEL-TWKSHNK-COUNT      TO CR-SEL-TWKSHNK-COUNT   09150000
068100         MOVE PA-SEL-TDTATTR-COUNT      TO CR-SEL-TDTATTR-COUNT   09160000
068200*        MOVE COMMIT INFO TO WORKING STORAGE ROW                  09170000
068300         MOVE CR-CHECKPOINT-RESTART-AREA TO                       09180000
068400                                       TCKRSTINF-WORK-STRG-DESC   09190000
068500         IF PS-FIRST-COMMIT                                       09200000
068600             MOVE '9' TO TCKRSTCNTL-CKPT-STAT-CODE                09210000
068700             PERFORM 7900-UPDATE-CHECKPOINT-STATUS                09220000
068800             MOVE 'N' TO PS-FIRST-COMMIT-SW                       09230000
068900         END-IF                                                   09240000
069000         PERFORM 7800-COMMIT-CHANGES                              09250000
069100         PERFORM 7300-GET-COMMIT-TIMESTAMP                        09260000
069200     END-IF.                                                      09270000
069300*                                                                 09280000
069400*                                                                 09290000
069500******************************************************************09300000
069600* 7800-COMMIT-CHANGES.                                            09310000
069700* PROCESSES: PERFORM UPDATE OF CHECKPOINT INFORMATION TABLE.      09320000
069800*            TAKE A COMMIT.                                       09330000
069900*  ==> PERFORMED FROM: 7700-COMMIT-PROCESSING.                    09340000
070000******************************************************************09350000
070100 7800-COMMIT-CHANGES.                                             09360000
070200                                                                  09370000
070300     EXEC SQL                                                     09380000
070400       UPDATE TCKRSTINF                                           09390000
070500          SET WORK_STRG_DESC = :TCKRSTINF-WORK-STRG-DESC          09400000
070600        WHERE JOB_NAME       = :PC-JOB-NAME                       09410000
070700          AND PLAN_NAME      = :PC-PROGRAM-NAME                   09420000
070800     END-EXEC.                                                    09430000
070900                                                                  09440000
071000     IF SQLCODE = 0                                               09450000
071100         CONTINUE                                                 09460000
071200     ELSE                                                         09470000
071300         MOVE PE-MSG-05                  TO PV-OPERATION-ATTEMPTED09480000
071400         MOVE  '* 7800-COMMIT-CHANGES *' TO PV-PARAGRAPH-NAME     09490000
071500         PERFORM 9999-SQL-ABEND                                   09500000
071600     END-IF.                                                      09510000
071700                                                                  09520000
071800     EXEC SQL                                                     09530000
071900         COMMIT                                                   09540000
072000     END-EXEC.                                                    09550000
072100                                                                  09560000
072200     IF SQLCODE = 0                                               09570000
072300         CONTINUE                                                 09580000
072400     ELSE                                                         09590000
072500         MOVE PE-MSG-06                  TO PV-OPERATION-ATTEMPTED09600000
072600         MOVE  '* 7800-COMMIT-CHANGES *' TO PV-PARAGRAPH-NAME     09610000
072700         PERFORM 9999-SQL-ABEND                                   09620000
072800     END-IF.                                                      09630000
072900*                                                                 09640000
073000*                                                                 09650000
073100******************************************************************09660000
073200* 7900-UPDATE-CHECKPOINT-STATUS                                   09670000
073300* PROCESSES: UPDATES THE STATUS ON THE CHECKPOINT CONTROL TABLE   09680000
073400*                                                                 09690000
073500******************************************************************09700000
073600 7900-UPDATE-CHECKPOINT-STATUS.                                   09710000
073700                                                                  09720000
073800     EXEC SQL                                                     09730000
073900       UPDATE  TCKRSTCNTL                                         09740000
074000          SET  CKPT_STAT_CODE = :TCKRSTCNTL-CKPT-STAT-CODE        09750000
074100        WHERE  JOB_NAME  = :PC-JOB-NAME                           09760000
074200          AND  PLAN_NAME = :PC-PROGRAM-NAME                       09770000
074300     END-EXEC.                                                    09780000
074400                                                                  09790000
074500     IF SQLCODE = 0                                               09800000
074600         CONTINUE                                                 09810000
074700     ELSE                                                         09820000
074800         MOVE '7900-UPDATE-CHECKPOINT-STATUS' TO PV-PARAGRAPH-NAME09830000
074900         MOVE PE-MSG-10                  TO PV-OPERATION-ATTEMPTED09840000
075000         PERFORM 9999-SQL-ABEND                                   09850000
075100     END-IF.                                                      09860000
075200                                                                  09870000
075300     EJECT                                                        09880000
075400*                                                                 09890000
075500*                                                                 09900000
075600******************************************************************09910000
075700* PROGRAM RESTART DUE TO A DEADLOCK AGAINST TWKSCLS ROW FOR UPDATE09920000
075800*  FIND RESTART RECORD AND CKPT RESTART AT POINT OF LAST COMMIT.  09930000
075900******************************************************************09940000
076000 7999-RESTART-PROCESS.                                            09950000
076100*                                                                 09960000
076200     SET PS-PROGRAM-DEADLOCKED TO TRUE.                           09970000
076300*                                                                 09980000
076400     CLOSE CONDENSED-FILE.                                        09990000
076500*                                                                 10000000
076600     PERFORM 7500-SELECT-RESTART-INFO.                            10010000
076700*                                                                 10020000
076800     DISPLAY '**** RESTART **** '.                                10030000
076900     MOVE PV-DEADLOCK-COUNT TO PD-DEADLOCK-COUNT.                 10040000
077000     DISPLAY '** SQLCODE -911 **  ' PD-DEADLOCK-COUNT ' TIMES'.   10050000
077100*                                                                 10060000
077200*-- THIS CHECK WILL PREVENT THE FILE FROM BEING RESTARTED IN      10070000
077300*-- THE WRONG POSITION IF NO COMMITS HAVE OCCURRED AND THE        10080000
077400*-- RESTART INFORMATION IS NOT CLEARED OUT.                       10090000
077500     IF PS-FIRST-COMMIT                                           10100000
077600         INITIALIZE TCKRSTINF-WORK-STRG-DESC                      10110000
077700         DISPLAY 'NO COMMITS HAVE OCCURRED YET; RESTART FROM'     10120000
077800                ' BEGINNING'                                      10130000
077900     ELSE                                                         10140000
078000         DISPLAY 'TCKRSTINF-LAST CKPT '                           10150000
078100                  TCKRSTINF-WORK-STRG-DESC (1:104)                10160000
078200***    INFO ON LAST CHECKPOINT TAKEN IS IN                        10170000
078300***    CR-CHECKPOINT-RESTART-AREA.                                10180000
078400         MOVE TCKRSTINF-WORK-STRG-DESC TO                         10190000
078500               CR-CHECKPOINT-RESTART-AREA                         10200000
078600         DISPLAY 'CHECKPOINT RESTART INFORMATION:'                10210000
078700         DISPLAY 'MONTH NBR       ' CR-FISCAL-NBR                 10220000
078800         DISPLAY 'MONTH END DATE  ' CR-FISCAL-WK-END-DTE          10230000
078900         DISPLAY 'DEPARTMENT NBR  ' CR-DEPT-NBR                   10240000
079000         DISPLAY 'SUB CLASS NBR   ' CR-SUB-CL-NBR                 10250000
079100         DISPLAY 'STORE NBR       ' CR-STR-NBR                    10260000
079200         DISPLAY 'INPUT RECS READ ' CR-INPUT-READ-COUNT           10270000
079300     END-IF.                                                      10280000
079400*                                                                 10290000
079500     OPEN INPUT CONDENSED-FILE.                                   10300000
079600     MOVE ZEROES                          TO PA-INPUT-COUNT.      10310000
079700*                                                                 10320000
079800*POSITION INPUT FILE TO 1ST RECORD AFTER LAST CHECKPOINT          10330000
079900     PERFORM 4000-READ-CONDENSED-FILE                             10340000
080000         UNTIL PA-INPUT-COUNT > CR-INPUT-READ-COUNT               10350000
080100           OR PS-NO-MORE-INPUT-RECORDS.                           10360000
080200     IF PS-NO-MORE-INPUT-RECORDS                                  10370000
080300         DISPLAY 'END OF INPUT FILE ON RESTART'                   10380000
080400     ELSE                                                         10390000
080500         DISPLAY 'INPUT RECORD RESTARTED ON RECORD '              10400000
080600                  PA-INPUT-COUNT                                  10410000
080700         DISPLAY 'FISCAL WEEK NBR       ' ML103-FSCL-WK-NBR       10420000
080800         DISPLAY 'FISCAL WEEK END DATE  ' ML103-FSCL-WK-END-DTE   10430000
080900         DISPLAY 'DEPARTMENT NBR        ' ML103-DEPT-NBR          10440000
081000         DISPLAY 'SUB CLASS NBR         ' ML103-SUB-CL-NBR        10450000
081100         DISPLAY 'STORE NBR             ' ML103-STR-NBR           10460000
081200     END-IF.                                                      10470000
081300*                                                                 10480000
081400*RE-ESTABLISH COUNTS FOR PROCESSED INPUT (FROM CHECKPOINT RECORD) 10490000
081500     MOVE CR-UPD-TWKSCLS-COUNT    TO PA-UPD-TWKSCLS-COUNT.        10500000
081500     MOVE CR-UPD-TWKSHNK-COUNT    TO PA-UPD-TWKSHNK-COUNT.        10510000
081500     MOVE CR-INS-TWKSCLS-COUNT    TO PA-INS-TWKSCLS-COUNT.        10520000
081600     MOVE CR-INS-TWKSHNK-COUNT    TO PA-INS-TWKSHNK-COUNT.        10530000
081700     MOVE CR-SEL-TWKSCLS-COUNT    TO PA-SEL-TWKSCLS-COUNT.        10540000
081700     MOVE CR-SEL-TWKSHNK-COUNT    TO PA-SEL-TWKSHNK-COUNT.        10550000
081700     MOVE CR-SEL-TDTATTR-COUNT    TO PA-SEL-TDTATTR-COUNT.        10560000
081800     MOVE CR-TWKSCLS-COMMIT-COUNT TO PA-COMMIT-COUNT.             10570000
081900*                                                                 10580000
082000*                                                                 10590000
082100******************************************************************10600000
082200*  RESET STATUS CODE, DISPLAY FINAL COUNTS , CLOSE INPUT FILE    *10610000
082300******************************************************************10620000
082400 8000-EOJ-ROUTINE.                                                10630000
082500*                                                                 10640000
082600     MOVE '0' TO TCKRSTCNTL-CKPT-STAT-CODE.                       10650000
082700     PERFORM 7900-UPDATE-CHECKPOINT-STATUS.                       10660000
082800*                                                                 10670000
082900     DISPLAY '                                             '.     10680000
083000     DISPLAY 'INPUT RECORDS   ', PA-INPUT-COUNT.                  10690000
083100     DISPLAY 'SELECT TWKSCLS  ', PA-SEL-TWKSCLS-COUNT.            10700000
083200     DISPLAY 'UPDATE TWKSCLS  ', PA-UPD-TWKSCLS-COUNT.            10710000
083300     DISPLAY 'INSERT TWKSCLS  ', PA-INS-TWKSCLS-COUNT.            10720000
083100     DISPLAY 'SELECT TWKSHNK  ', PA-SEL-TWKSHNK-COUNT.            10730000
083200     DISPLAY 'UPDATE TWKSHNK  ', PA-UPD-TWKSHNK-COUNT.            10740000
083300     DISPLAY 'INSERT TWKSHNK  ', PA-INS-TWKSHNK-COUNT.            10750000
083100     DISPLAY 'SELECT TDTATTR  ', PA-SEL-TDTATTR-COUNT.            10760000
083400     DISPLAY '                                             '.     10770000
083500     DISPLAY 'COMMITS TAKEN   ', PA-COMMIT-COUNT.                 10780000
083600*                                                                 10790000
083700     CLOSE CONDENSED-FILE.                                        10800000
083800*                                                                 10810000
083900*                                                                 10820000
084000******************************************************************10830000
084100*  PERFORMED BY 6100-UPDATE AND 7200-INSERT                       10840000
084200*  THIS ROUTINE FORCES AN ABEND DUE TO A SQLCODE -911 (3 TIMES)   10850000
084300******************************************************************10860000
084400 9000-DEADLOCK-ERROR.                                             10870000
084500*                                                                 10880000
084600         MOVE PE-MSG-07             TO PV-OPERATION-ATTEMPTED     10890000
084700         PERFORM 9999-SQL-ABEND.                                  10900000
084800*                                                                 10910000
084900******************************************************************10920000
085000*  STANDARD DB2 ERROR ABEND ROUTINE                               10930000
085100*  THIS ROUTINE FORCES AN ABEND DUE TO A DB2 PROBLEM.             10940000
085200******************************************************************10950000
085300 9999-SQL-ABEND.                                                  10960000
085400                                                                  10970000
085500     MOVE +4013                 TO ABEND-CODE.                    10980000
085600     MOVE SQLCODE               TO PV-SQLCODE-DISPLAY.            10990000
085700     DISPLAY '**  ABEND     **'.                                  11000000
085800     DISPLAY '**  PROGRAM   ** => ' PC-PROGRAM-NAME.              11010000
085900     DISPLAY '**  PARAGRAPH **  = ' PV-PARAGRAPH-NAME.            11020000
086000     DISPLAY '**  OPERATION **  = ' PV-OPERATION-ATTEMPTED.       11030000
086100     DISPLAY '**  SQLCODE   **  = ' PV-SQLCODE-DISPLAY.           11040000
086200                                                                  11050000
086300     EXEC SQL                                                     11060000
086400          ROLLBACK                                                11070000
086500     END-EXEC.                                                    11080000
086600                                                                  11090000
086700*    THE FOLLOWING COPYBOOK UTILIZES THE DB2 ABEND MODULE         11100000
086800*    DSNTIAR TO CONVERT SQLCA INTO UNDERSTANDABLE VERBAGE.        11110000
086900                                                                  11120000
087000     COPY DPPD004.                                                11130000
087100     CALL 'ILBOABN0'  USING ABEND-CODE.                           11140000
