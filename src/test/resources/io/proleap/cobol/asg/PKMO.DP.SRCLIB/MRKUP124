000100 IDENTIFICATION DIVISION.                                                 
000200                                                                          
000300 PROGRAM-ID.              MRKUP124.                                       
000400 AUTHOR.                  DONALD TOMLINSON.                               
000500 INSTALLATION.            KOHLS DEPARTMENT STORES.                        
000600 DATE-WRITTEN.            07/15/02.                                       
000700 DATE-COMPILED.                                                           
000800                                                                          
000900***************************PURPOSE********************************        
001000* PROGRAM WILL UPDATE THE CORPORATE STORE ROW ON TMRITST FOR              
001100* ALL ITEMS THAT HAVE HAD STORES ADDED OR DELETED DURING THE              
001200* DAY VIA RPM.  THE CORPORATE TOTALS WILL BE RECALCULATED FOR             
001300* THE EXISTING STORES.  IF ALL STORES ARE DELETED FOR THE ITEM,           
001400* THE ITEM WILL BE DELETED FROM TMRITEM.  IF ONLY THE E-STORE             
001500* REMAINS ON TMRITST, RT & RT DAY WILL BE SET TO ZERO ON TMRITEM.         
001600* PGM WILL ALSO ADD A CORPORATE STORE ROW TO TMRITST FOR ALL NEW          
001700* ITEMS ADDED DURING THE DAY.  IT WILL RUN DAILY.                         
001800******************************************************************        
001900*                                                                         
002000*  CHANGE LOG:                                                            
002100*  07/15/2002 DON TOMLINSON                                               
002200*     PROJECT: RPM ADDS & DELETES.     NEW PROGRAM.                       
002300******************************************************************        
002310*  08/12/2002 DON TOMLINSON                                               
002320*     PROJECT: RPM ADDS & DELETES.                                        
002330*     CHANGE:  REMOVE 'DISPLAY' STATEMENT FROM 4200- PARAGRAPH.           
002300******************************************************************        
      *                                                                         
002310*  08/15/2002 LINDA FRIESS                                                
002330*     CHANGE:  ADDED LOGIC TO HANDLE -530 SQLCODE IN PARAGRAPH            
002330*              7200 AND +100 SQLCODE IN PARAGRAPH 5200.                   
002400******************************************************************        
      *                                                                         
002310*  08/20/2002 LINDA FRIESS                                                
002330*     CHANGE:  CHANGED ITEM_STR CURSOR TO INCLUDE STORE '000'             
002330*              IN ORDER TO FIX PROBLEM WITH ITEM GETTING                  
002330*              DELETED WHEN ONLY E-STORE REMAINED.                        
002400******************************************************************        
002410* 07/30/2004 - ANNE KINTOPF STORE NUMBER EXPANSION  WR#26363    *         
002420* -  CHANGED REFERENCES FROM TSTR000 TO XMT_LOC                 *         
002490*****************************************************************         
W37507*  02/27/2013 JOHN SELWITSCHKA                      WR#37507              
W37507*     CHANGE:  REMOVE SET RT_DAY TO ZERO LOGIC.                           
W37507******************************************************************        
002500*                                                                         
002600 ENVIRONMENT DIVISION.                                                    
002700*                                                                         
002800 CONFIGURATION SECTION.                                                   
002900                                                                          
003000 SOURCE-COMPUTER. IBM-3090.                                               
003100 OBJECT-COMPUTER. IBM-3090.                                               
003200*                                                                         
003300 INPUT-OUTPUT SECTION.                                                    
003400                                                                          
003500 FILE-CONTROL.                                                            
003600     SELECT ICPOL                                                         
003700         ASSIGN       TO INP01                                            
003800         ORGANIZATION IS INDEXED                                          
003900         RECORD KEY   IS P-KEY                                            
004000         ACCESS MODE  IS DYNAMIC                                          
004100         FILE STATUS  IS ICPOL-STATUS.                                    
004200                                                                          
004300*                                                                         
004400 DATA DIVISION.                                                           
004500*                                                                         
004600*                                                                         
004700 FILE SECTION.                                                            
004800*****************************************************************         
004900*               PROGRAM PRODUCT POLICY FILE                     *         
005000*****************************************************************         
005100     SKIP1                                                                
005200 FD  ICPOL                                                                
005300     DATA RECORD IS POLICY-RECORD.                                        
005400     SKIP1                                                                
005500 01  POLICY-RECORD.                                                       
005600     COPY ICI010C.                                                        
005700     02  POLICY-RECORDX  REDEFINES  P-DATA.                               
005800     COPY ICI030C.                                                        
005900     COPY ICI040C.                                                        
006000                                                                          
006100                                                                          
006200*                                                                         
006300*                                                                         
006400 WORKING-STORAGE SECTION.                                                 
006500                                                                          
006600 01  PROGRAM-SWITCHES.                                                    
006700     05  PS-EOF-ITEM-STR-CURSOR      PIC  X(01)    VALUE 'N'.             
006800         88  EOF-ITEM-STR-CURSOR                   VALUE 'Y'.             
006900         88  NOT-EOF-ITEM-STR-CURSOR               VALUE 'N'.             
007000                                                                          
007100     05  PS-EOF-NEW-ITEM-CURSOR      PIC  X(01)    VALUE 'N'.             
007200         88  EOF-NEW-ITEM-CURSOR                   VALUE 'Y'.             
007300         88  NOT-EOF-NEW-ITEM-CURSOR               VALUE 'N'.             
007400                                                                          
007500 01  PV-PROGRAM-VARIABLES.                                                
007600     05  ICPOL-STATUS                 PIC XX.                             
007700         88  ICPOL-STATUS-OK                     VALUE '00'.              
007800                                                                          
007900     05  PV-PARAGRAPH-NAME            PIC X(30)  VALUE SPACES.            
008000     05  PV-ERROR-STATUS-MSG.                                             
008100          10  FILLER                  PIC X(10)  VALUE                    
008200              'STATUS IS '.                                               
008300          10  PV-ERROR-STATUS         PIC X(20).                          
008400                                                                          
008500     05   PV-ERROR-FILE-MSG.                                              
008600          10  FILLER              PIC  X(26)    VALUE                     
008700              'ERROR HAS OCCURED FILE IS '.                               
008800          10  PV-ERROR-FILE       PIC  X(19).                             
008900                                                                          
009000     05   PV-ERROR-OPERATION-MSG.                                         
009100          10  FILLER              PIC  X(26)    VALUE                     
009200              'OPERATION THAT OCCURED IS '.                               
009300          10  PV-ERROR-OPERATION  PIC  X(19).                             
009400                                                                          
009500     05  PV-NOT-FOUND-MSG.                                                
009600          10  FILLER                  PIC X(12)  VALUE                    
009700              'FILE KEY IS '.                                             
009800          10  PV-NOT-FOUND-KEY        PIC X(21).                          
009900                                                                          
010000     05  PV-DB2-OPER-ATTEMPTED        PIC X(30)  VALUE SPACES.            
010100                                                                          
010200     05  PV-INPUT-REC-CNT1            PIC S9(9)  VALUE +0 COMP-3.         
010300     05  PV-INPUT-REC-CNT2            PIC S9(9)  VALUE +0 COMP-3.         
010400     05  PV-INSERT-CNT-TMRITST        PIC S9(9)  VALUE +0 COMP-3.         
010500     05  PV-DELETE-CNT-TMRITEM        PIC S9(9)  VALUE +0 COMP-3.         
010600     05  PV-UPDATE-CNT-TMRITST        PIC S9(9)  VALUE +0 COMP-3.         
W37507*    05  PV-UPDATE-CNT-TMRITEM        PIC S9(9)  VALUE +0 COMP-3.         
010800                                                                          
010900     05  PV-SUB1                      PIC S9(4)  VALUE +0 COMP.           
011000     05  PV-SUB2                      PIC S9(4)  VALUE +0 COMP.           
011100                                                                          
011200     05  PV-INPUT-REC-CNT-DISP        PIC 9(9)   VALUE 0.                 
011300     05  PV-INSERT-CNT-DISP           PIC 9(9)   VALUE 0.                 
W37507*    05  PV-UPDATE-CNT-DISP1          PIC 9(9)   VALUE 0.                 
011500     05  PV-UPDATE-CNT-DISP2          PIC 9(9)   VALUE 0.                 
011600     05  PV-DELETE-CNT-DISP           PIC 9(9)   VALUE 0.                 
011700                                                                          
011800     05  PV-COMMIT-TIMESTAMP          PIC X(26)  VALUE SPACES.            
011900     05  PV-CURRENT-TIMESTAMP         PIC X(26)  VALUE SPACES.            
012000                                                                          
012100     05  PV-STORE-COUNT               PIC S9(04) COMP VALUE +0.           
012200     05  PV-REMAIN-STR-CNT            PIC S9(09) COMP VALUE +0.           
012300                                                                          
012400     05  PC-MAX-RETRIES               PIC S9(04) VALUE +003.              
012500     05  PC-1                         PIC S9(01) VALUE +1.                
012600     05  PC-10                        PIC S9(05) USAGE COMP-3             
012700                                                 VALUE +10.               
012800     05  PV-CSTOCK-QTY                PIC S9(09)V      COMP-3             
012900                                                 VALUE +0.                
013000     05  PV-USERMIN-QTY               PIC S9(07)V      COMP-3             
013100                                                 VALUE +0.                
013200     05  PV-USERMAX-QTY               PIC S9(07)V      COMP-3             
013300                                                 VALUE +0.                
013400     05  PV-DD-QTY                    PIC S9(06)V9(01) COMP-3             
013500                                                 VALUE +0.                
013600     05  PV-HOLD-CORP-STORE.                                              
013600         10  PV-HOLD-CORP-STORE-N     PIC 9(05)  VALUE ZEROS.             
013700     05  PV-HOLD-ITEM                 PIC S9(15) VALUE +0                 
013800                                                       COMP-3.            
013900                                                                          
014000 01  PV-SCHEDULE-DATE                PIC X(10).                           
014100 01  PV-DATE REDEFINES PV-SCHEDULE-DATE.                                  
014200     05  PV-YEAR                     PIC 9(4).                            
014300     05  FILLER                      PIC X.                               
014400     05  PV-MONTH                    PIC 99.                              
014500     05  FILLER                      PIC X.                               
014600     05  PV-DAY                      PIC 99.                              
014700                                                                          
014800******************************************************************        
014900* CR CHECKPOINT RESTART VARIABLES                                *        
015000******************************************************************        
015100 01  CR-CHECKPOINT-RESTART-AREA.                                          
015200     05  CR-AREA-LEN                 PIC S9(04) VALUE +54  COMP.          
015300                                                                          
015400     05  CR-CHECKPOINT-RESTART-VAR.                                       
015500         10  CR-STR-HDR-CNT          PIC 9(09)  VALUE ZEROS.              
015600         10  CR-STR-DTL-CNT          PIC 9(09)  VALUE ZEROS.              
015700         10  CR-LINES-NO-SKU-CNT     PIC 9(09)  VALUE ZEROS.              
015800         10  CR-LINES-UPD-CNT        PIC 9(09)  VALUE ZEROS.              
015900         10  CR-CORP-DTL-CNT         PIC 9(09)  VALUE ZEROS.              
016000         10  CR-COMMIT-CNT           PIC 9(09)  VALUE ZEROS.              
016100                                                                          
016200                                                                          
016300 01  PC-CONSTANTS.                                                        
016400     05  PC-PGRM-NAME                PIC X(8)   VALUE 'MRKUP124'.         
016500     05  PC-CORPORATE-STORE          PIC X(5)   VALUE '00000'.            
016600                                                                          
016700                                                                          
016800 01  PV-ABEND-CODE                   PIC S9(04) VALUE +0                  
016900                                                COMP SYNC.                
017000                                                                          
017100                                                                          
017200****                                                                      
017300*  COPY BOOK OF WORKING STORAGE FOR SQL ABEND ROUTINE                     
017400****                                                                      
017500                                                                          
017600     COPY DPWS004.                                                        
017700                                                                          
017800     COPY SQLCA2.                                                         
017900                                                                          
018000     EXEC SQL                                                             
018100        INCLUDE SQLCA                                                     
018200     END-EXEC.                                                            
018300                                                                          
018400******************************************************************        
018500*  COBOL DECLARATIONS FOR THE MRT_ITM_STR_AUD TABLE                       
018600******************************************************************        
018700     EXEC SQL                                                             
018800        INCLUDE MRT00001                                                  
018900     END-EXEC.                                                            
019000                                                                          
019100******************************************************************        
019200*  COBOL DECLARATIONS FOR THE MRT_ITM_AUD TABLE                           
019300******************************************************************        
019400     EXEC SQL                                                             
019500        INCLUDE MRT00000                                                  
019600     END-EXEC.                                                            
019700                                                                          
019800******************************************************************        
019900*  COBOL DECLARATIONS FOR THE TMRITST TABLE                               
020000******************************************************************        
020100     EXEC SQL                                                             
020200        INCLUDE TMRITST                                                   
020300     END-EXEC.                                                            
020400                                                                          
020500******************************************************************        
020600*  COBOL DECLARATIONS FOR THE TMRITEM TABLE                               
020700******************************************************************        
020800     EXEC SQL                                                             
020900        INCLUDE TMRITEM                                                   
021000     END-EXEC.                                                            
021100                                                                          
021200******************************************************************        
021300*  COBOL DECLARATIONS FOR THE XMT_LOC TABLE                               
021400******************************************************************        
021500     EXEC SQL                                                             
021600        INCLUDE XMT00001                                                  
021700     END-EXEC.                                                            
021800                                                                          
021900******************************************************************        
022000*  COBOL DECLARATIONS FOR THE CHECKPOINT RESTART CONTROL TABLE            
022100******************************************************************        
022200     EXEC SQL                                                             
022300         INCLUDE TCKRSTCN                                                 
022400     END-EXEC.                                                            
022500*****************************************************                     
022600* ITEM_STR CURSOR                                                         
022700*   TO SELECT ITEMS THAT HAD STORES ADDED OR DELETED.                     
022800*****************************************************                     
022900     EXEC SQL                                                             
023000       DECLARE ITEM_STR CURSOR WITH HOLD FOR                              
023100       SELECT                                                             
023200             B.ITEM_NBR                                                   
023300            ,A.ACTN_CDE                                                   
023400            ,COUNT (DISTINCT B.STR_NBR)                                   
023500        FROM MRT_ITM_STR_AUD A                                            
023600            ,TMRITST B                                                    
023700       WHERE A.ITM_NBR = B.ITEM_NBR                                       
023900         AND DATE(A.CRE_TMST) = :PV-SCHEDULE-DATE                         
024000       GROUP BY B.ITEM_NBR                                                
024100               ,A.ACTN_CDE                                                
024110       ORDER BY B.ITEM_NBR ASC                                            
024120               ,A.ACTN_CDE ASC                                            
024200       FOR FETCH ONLY                                                     
024300     END-EXEC.                                                            
024400*                                                                         
024500****************************************                                  
024600* NEW_ITEM CURSOR                                                         
024700*   TO SELECT NEW ITEMS THAT WERE ADDED.                                  
024800****************************************                                  
024900     EXEC SQL                                                             
025000       DECLARE NEW_ITEM CURSOR WITH HOLD FOR                              
025100       SELECT DISTINCT ITM_NBR                                            
025200        FROM MRT_ITM_AUD                                                  
025300       WHERE ACTN_CDE = 'A'                                               
025400         AND DATE(CRE_TMST) = :PV-SCHEDULE-DATE                           
025500       FOR FETCH ONLY                                                     
025600     END-EXEC.                                                            
025700*                                                                         
025800 PROCEDURE DIVISION.                                                      
025900******************************************************************        
026000*   MAIN PROCESSING ROUTINE                                               
026100******************************************************************        
026200 0000-MAINLINE-PROCESSING.                                                
026300                                                                          
026400     MOVE '0000-MAINLINE-PROCESSING'                                      
026500                                 TO PV-PARAGRAPH-NAME.                    
026600                                                                          
026700     PERFORM 1000-INITIALIZE.                                             
026800                                                                          
026900     PERFORM 6000-MAIN-PROCESS-NEW-ITEM-CUR.                              
027000                                                                          
027100     PERFORM 3000-MAIN-PROCESS-ITEM-STR-CUR.                              
027200                                                                          
027300     PERFORM 9000-END-OF-JOB.                                             
027400                                                                          
027500     GOBACK.                                                              
027600                                                                          
027700******************************************************************        
027800*   INITIALIZATION ROUTINE                                                
027900******************************************************************        
028000*                                                                         
028100 1000-INITIALIZE.                                                         
028200                                                                          
028300     MOVE '1000-INITIALIZE'      TO PV-PARAGRAPH-NAME.                    
028400                                                                          
028500     ACCEPT PV-SCHEDULE-DATE.                                             
028600     DISPLAY PV-SCHEDULE-DATE.                                            
028700                                                                          
028800     PERFORM 1100-OPEN-ITEM-STR-CURSOR.                                   
028900                                                                          
029000     PERFORM 4910-GET-COMMIT-TIMESTAMP.                                   
029100                                                                          
029200                                                                          
029300******************************************************************        
029400*   OPEN ITEM-STR CURSOR                                                  
029500******************************************************************        
029600 1100-OPEN-ITEM-STR-CURSOR.                                               
029700                                                                          
029800     MOVE '1100-OPEN-ITEM-STR-CURSOR'                                     
029900                                     TO PV-PARAGRAPH-NAME.                
030000                                                                          
030100     MOVE 'OPEN ITEM-STR CURSOR'     TO PV-DB2-OPER-ATTEMPTED.            
030300                                                                          
030400     EXEC SQL                                                             
030500         OPEN ITEM_STR                                                    
030600     END-EXEC.                                                            
030700                                                                          
030800     EVALUATE TRUE                                                        
030900         WHEN SQLCODE = ZERO                                              
030910             CONTINUE                                                     
031000*            DISPLAY 'OPEN ITEM_STR SUCCESSFUL'                           
031100         WHEN OTHER                                                       
031200             DISPLAY 'OPEN ITEM_STR FAILURE'                              
031300             PERFORM 9999-SQL-ERROR                                       
031400       END-EVALUATE.                                                      
031500                                                                          
031600                                                                          
031700******************************************************************        
031800*   MAIN PROCESSING ROUTINE FOR ITEM_STR CURSOR                           
031900******************************************************************        
032000 3000-MAIN-PROCESS-ITEM-STR-CUR.                                          
032100                                                                          
032200     MOVE '3000-MAIN-PROCESS-ITEM-STR-CUR'                                
032300                                 TO PV-PARAGRAPH-NAME.                    
032400                                                                          
032500     PERFORM 4000-FETCH-ITEM-STR-CURSOR                                   
032600         UNTIL EOF-ITEM-STR-CURSOR.                                       
032700                                                                          
032800                                                                          
032900******************************************************************        
033000*   FETCH ITEM_STR CURSOR                                                 
033100******************************************************************        
033200 4000-FETCH-ITEM-STR-CURSOR.                                              
033300                                                                          
033400     MOVE '4000-FETCH-CSR'       TO PV-PARAGRAPH-NAME.                    
033500                                                                          
033600     MOVE 'FETCH ITEM STR CSR'   TO PV-DB2-OPER-ATTEMPTED.                
033700     MOVE +0                     TO PV-STORE-COUNT.                       
033800                                                                          
033900     PERFORM                                                              
034000         WITH TEST AFTER                                                  
034100         VARYING PV-SUB1                                                  
034200         FROM 1 BY 1                                                      
034300         UNTIL PV-SUB1 > PC-MAX-RETRIES                                   
034400            OR SQLCODE = ZERO                                             
034500            OR SQLCODE = +100                                             
034600                                                                          
034700         EXEC SQL                                                         
034800             FETCH ITEM_STR                                               
034900              INTO :MRITST-ITEM-NBR                                       
035000                  ,:MRT00001-ACTN-CDE                                     
035100                  ,:PV-STORE-COUNT                                        
035200         END-EXEC                                                         
035300         EVALUATE TRUE                                                    
035400             WHEN SQLCODE = ZERO                                          
035500                 ADD PC-1      TO PV-INPUT-REC-CNT1                       
035600             WHEN SQLCODE = -904                                          
035700             WHEN SQLCODE = -913                                          
035800                 CONTINUE                                                 
035900             WHEN SQLCODE = +100                                          
036000                 SET EOF-ITEM-STR-CURSOR TO TRUE                          
036100             WHEN SQLWARN0 NOT = SPACES                                   
036200             WHEN SQLCODE  NOT = ZERO                                     
036300                  PERFORM 9999-SQL-ERROR                                  
036400         END-EVALUATE                                                     
036500     END-PERFORM.                                                         
036600                                                                          
036700     IF SQLCODE = ZERO                                                    
036800         PERFORM 4100-CHECK-IF-CORP-STR.                                  
036900                                                                          
037000     PERFORM 4900-COMMIT-PROCESSING.                                      
037100                                                                          
037200                                                                          
037300******************************************************************        
037400*  CHECK IF THIS IS A CORPORATE STORE ROW                        *        
037500******************************************************************        
037600 4100-CHECK-IF-CORP-STR.                                                  
037700                                                                          
037800     MOVE '4100-CHECK-IF-CORP-STR'                                        
037900                                 TO PV-PARAGRAPH-NAME.                    
038000                                                                          
038100     MOVE SPACES                 TO PV-HOLD-CORP-STORE.                   
038200                                                                          
038300     IF PV-STORE-COUNT = PC-1                                             
      *       ***  IF ONLY ONE STORE FOR ITEM, SHOULD BE '000'  ***             
      *                                                                         
038400         PERFORM 4110-GET-CORP-STORE                                      
038500         IF PV-HOLD-CORP-STORE = PC-CORPORATE-STORE                       
038501             IF MRT00001-ACTN-CDE = 'D'                                   
038600                 PERFORM 5100-DELETE-TMRITEM                              
038610             ELSE                                                         
038620                 DISPLAY 'ITEM ' MRITST-ITEM-NBR                          
038630                     ' HAS ONE STORE BUT ACTION IS ADD, '                 
038640                     'DELETE CANNOT OCCUR'                                
038650             END-IF                                                       
038700         ELSE                                                             
038800             DISPLAY 'ITEM ' MRITST-ITEM-NBR                              
038900                     ' HAS ONE STORE BUT IT IS NOT THE '                  
039000                     'CORPORATE STORE'                                    
039100         END-IF                                                           
039200     ELSE                                                                 
039300         PERFORM 4200-PROCESS-FETCHED-ITEM                                
039400     END-IF.                                                              
039500                                                                          
039600                                                                          
039700******************************************************************        
039800*  PV-STORE-COUNT WAS = 1, HENCE ONLY A CORP STORE SHOULD EXIST. *        
039900******************************************************************        
040000 4110-GET-CORP-STORE.                                                     
040100                                                                          
040200     MOVE '4110-GET-CORP-STORE'                                           
040300                                 TO PV-PARAGRAPH-NAME.                    
040310*    DISPLAY '4110-GET-CORP-STORE IS PROCESSING'.                         
040400                                                                          
040500     EXEC SQL                                                             
040600         SELECT STR_NBR                                                   
040700            INTO :MRITST-STR-NBR                                          
040800            FROM TMRITST                                                  
040900            WHERE ITEM_NBR   = :MRITST-ITEM-NBR                           
041000              AND STR_NBR    = 0                                          
041100     END-EXEC.                                                            
041200                                                                          
041300     EVALUATE SQLCODE                                                     
041400       WHEN +0                                                            
041500             MOVE MRITST-STR-NBR     TO PV-HOLD-CORP-STORE-N              
041700       WHEN +100                                                          
041800             CONTINUE                                                     
041900       WHEN OTHER                                                         
042000             MOVE 'GET-CORP-STORES'  TO PV-DB2-OPER-ATTEMPTED             
042100             PERFORM 9999-SQL-ERROR                                       
042200     END-EVALUATE.                                                        
042300                                                                          
042400                                                                          
042500******************************************************************        
042600*  PROCESS FETCHED ITEM_STR CURSOR ROW                           *        
042700******************************************************************        
042800 4200-PROCESS-FETCHED-ITEM.                                               
042900                                                                          
043000     MOVE '4200-PROCESS-FETCHED-ITEM'                                     
043100                                 TO PV-PARAGRAPH-NAME.                    
043200                                                                          
043300     MOVE MRITST-ITEM-NBR        TO PV-HOLD-ITEM.                         
043400                                                                          
043500     PERFORM 7100-SUM-NEW-TOTALS-TMRITST.                                 
043600                                                                          
043700     PERFORM 5200-UPDATE-TMRITST.                                         
                                                                                
W37507*    IF MRT00001-ACTN-CDE = 'D'                                           
W37507*        *** CHECK COUNT OF B&M STORES                 ***                
W37507*        *** IF ONLY E-STORE LEFT, SET RT/RT DAY TO 0  ***                
W37507*                                                                         
W37507*        PERFORM 5300-CHECK-REMAIN-STORES                                 
W37507*        IF PV-REMAIN-STR-CNT = +0                                        
W37507*            PERFORM 5400-SET-RT-TO-ZERO                                  
W37507*        ELSE                                                             
W37507*            CONTINUE                                                     
W37507*        END-IF                                                           
W37507*    ELSE                                                                 
W37507**       DISPLAY '5400-SET-RT-TO-ZERO NOT EXECUTING'                      
W37507**       DISPLAY 'MRT00001-ACTN-CDE = ' MRT00001-ACTN-CDE                 
W37507*        CONTINUE                                                         
W37507*    END-IF.                                                              
044600                                                                          
044700                                                                          
044800******************************************************************        
044900*  ==> PROCESSES:                                                *        
045000*    - CHECK IF WE NEED TO TAKE A COMMIT.                        *        
045100*    - COMMIT THIS UNIT OF WORK.                                 *        
045200******************************************************************        
045300 4900-COMMIT-PROCESSING.                                                  
045400                                                                          
045500     MOVE '4900-COMMIT-PROCESSING'                                        
045600                                 TO PV-PARAGRAPH-NAME.                    
045700                                                                          
045800     PERFORM 4920-SET-CURRENT-TIMESTAMP.                                  
045900                                                                          
046000     IF PV-CURRENT-TIMESTAMP > PV-COMMIT-TIMESTAMP                        
046100         PERFORM 4930-COMMIT                                              
046200         PERFORM 4910-GET-COMMIT-TIMESTAMP                                
046300     END-IF.                                                              
046400                                                                          
046500                                                                          
046600******************************************************************        
046700*  ==> PROCESSES:                                                *        
046800*    - GET THE COMMIT TIMESTAMP FROM THE CHECKPOINT CONTROL      *        
046900*      TABLE.                                                    *        
047000******************************************************************        
047100 4910-GET-COMMIT-TIMESTAMP.                                               
047200                                                                          
047300     MOVE '4910-GET-COMMIT-TIMESTAMP'                                     
047400                                 TO PV-PARAGRAPH-NAME.                    
047500                                                                          
047600     EXEC SQL                                                             
047700       SET :PV-COMMIT-TIMESTAMP =                                         
047800              (CURRENT TIMESTAMP + :PC-10 SECONDS)                        
047900     END-EXEC.                                                            
048000                                                                          
048100     IF SQLCODE = 0                                                       
048200         CONTINUE                                                         
048300     ELSE                                                                 
048400         MOVE '4910-GET-COMMIT-TIMESTAMP       '                          
048500                             TO PV-PARAGRAPH-NAME                         
048600         MOVE 'ERROR ON SELECT OF TIMESTAMP  '                            
048700                             TO PV-DB2-OPER-ATTEMPTED                     
048800         PERFORM 9999-SQL-ERROR                                           
048900     END-IF.                                                              
049000                                                                          
049100                                                                          
049200******************************************************************        
049300*  ==> PROCESSES:                                                *        
049400*    - GET THE CURRENT TIMESTAMP FROM DB2.                       *        
049500******************************************************************        
049600 4920-SET-CURRENT-TIMESTAMP.                                              
049700                                                                          
049800     MOVE '4920-SET-CURRENT-TIMESTAMP'                                    
049900                                 TO PV-PARAGRAPH-NAME.                    
050000                                                                          
050100     EXEC SQL                                                             
050200          SET :PV-CURRENT-TIMESTAMP = CURRENT TIMESTAMP                   
050300     END-EXEC.                                                            
050400                                                                          
050500     IF SQLCODE = 0                                                       
050600         CONTINUE                                                         
050700     ELSE                                                                 
050800         MOVE '4920-SET-CURRENT-TIMESTAMP      '                          
050900                             TO PV-PARAGRAPH-NAME                         
051000         MOVE 'ERROR ON SET OF TIMESTAMP     '                            
051100                             TO PV-DB2-OPER-ATTEMPTED                     
051200         PERFORM 9999-SQL-ERROR                                           
051300     END-IF.                                                              
051400                                                                          
051500                                                                          
051600******************************************************************        
051700*   COMMIT                                                                
051800******************************************************************        
051900 4930-COMMIT.                                                             
052000                                                                          
052100     MOVE '4930-COMMIT'              TO PV-PARAGRAPH-NAME.                
052200                                                                          
052300     EXEC SQL                                                             
052400         COMMIT                                                           
052500     END-EXEC.                                                            
052600                                                                          
052700     IF SQLCODE = 0                                                       
052800         ADD PC-1            TO CR-COMMIT-CNT                             
052900     ELSE                                                                 
053000         MOVE '4930-COMMIT                     '                          
053100                             TO PV-PARAGRAPH-NAME                         
053200         MOVE 'ERROR ON COMMIT               '                            
053300                             TO PV-DB2-OPER-ATTEMPTED                     
053400         PERFORM 9999-SQL-ERROR                                           
053500     END-IF.                                                              
053600                                                                          
053700                                                                          
053800******************************************************************        
053900*   DELETE ITEM      TMRITEM                                              
054000******************************************************************        
054100 5100-DELETE-TMRITEM.                                                     
054200                                                                          
054300     MOVE '5100-DELETE-TMRITEM'      TO PV-PARAGRAPH-NAME.                
054310*    DISPLAY '5100-DELETE-TMRITEM IS PROCESSING'.                         
054400                                                                          
054500     EXEC SQL                                                             
054600         DELETE                                                           
054700             FROM TMRITEM                                                 
054800             WHERE ITEM_NBR = :MRITST-ITEM-NBR                            
054900     END-EXEC.                                                            
055000                                                                          
055100     EVALUATE SQLCODE                                                     
055200       WHEN +0                                                            
055300             ADD PC-1 TO PV-DELETE-CNT-TMRITEM                            
055500       WHEN +100                                                          
055600             DISPLAY '5100 NO ROW TO DELETE FOR ITEM '                    
055700                      MRITST-ITEM-NBR                                     
055800       WHEN OTHER                                                         
055900             DISPLAY '5100 FAILED FOR ITEM ' MRITST-ITEM-NBR              
056000             MOVE 'DELETE TMRITEM' TO                                     
056100                  PV-DB2-OPER-ATTEMPTED                                   
056200             PERFORM 9999-SQL-ERROR                                       
056300     END-EVALUATE.                                                        
056400                                                                          
056500                                                                          
056600******************************************************************        
056700*   UPDATE CORPORATE TOTALS    TMRITST                                    
056800******************************************************************        
056900 5200-UPDATE-TMRITST.                                                     
057000                                                                          
057100     MOVE '5200-UPDATE-TMRITST'      TO PV-PARAGRAPH-NAME.                
057200                                                                          
057300                                                                          
057400*** THE FOLLOWING FIELDS WERE CALCULATED IN PARAGRAPH                     
057500*** 7100-SUM-NEW-TOTALS-TMRITST                                           
057600     MOVE PV-CSTOCK-QTY              TO MRITST-CSTOCK-QTY.                
057700     MOVE PV-USERMIN-QTY             TO MRITST-USERMIN-QTY.               
057800     MOVE PV-USERMAX-QTY             TO MRITST-USERMAX-QTY.               
057900     MOVE PV-DD-QTY                  TO MRITST-DD-FCTR.                   
058000                                                                          
058100     EXEC SQL                                                             
058200         UPDATE TMRITST                                                   
058300            SET CSTOCK_QTY  = :MRITST-CSTOCK-QTY                          
058400               ,USERMIN_QTY = :MRITST-USERMIN-QTY                         
058500               ,USERMAX_QTY = :MRITST-USERMAX-QTY                         
058600               ,DD_FCTR     = :MRITST-DD-FCTR                             
058700            WHERE ITEM_NBR  = :MRITST-ITEM-NBR                            
058800              AND STR_NBR   = 0                                           
058900     END-EXEC.                                                            
059000                                                                          
059100     EVALUATE SQLCODE                                                     
059200       WHEN +0                                                            
059300            ADD PC-1 TO PV-UPDATE-CNT-TMRITST                             
062500       WHEN +100                                                          
059600            DISPLAY '5200- ITEM NOT FOUND FOR CORP STORE UPDATE '         
059700                                           MRITST-ITEM-NBR                
059500       WHEN OTHER                                                         
059600            DISPLAY '5200 FAILED FOR ITEM ' MRITST-ITEM-NBR               
059800            MOVE 'UPDATE TMRITST'   TO PV-DB2-OPER-ATTEMPTED              
059900            PERFORM 9999-SQL-ERROR                                        
060000     END-EVALUATE.                                                        
060100                                                                          
060200                                                                          
060300******************************************************************        
060400*   CHECK FOR STORES REMAINING TMRITST THAT ARE NOT E-COMMERCE            
060500******************************************************************        
W37507*5300-CHECK-REMAIN-STORES.                                                
W37507*                                                                         
W37507*    MOVE '5300-CHECK-REMAIN-STORES' TO PV-PARAGRAPH-NAME.                
W37507*                                                                         
W37507*    MOVE +0                         TO PV-REMAIN-STR-CNT.                
W37507*                                                                         
W37507*    EXEC SQL                                                             
W37507*        SELECT COUNT (*)                                                 
W37507*           INTO :PV-REMAIN-STR-CNT                                       
W37507*           FROM XMT_LOC A                                                
W37507*               ,TMRITST B                                                
W37507*           WHERE B.ITEM_NBR      = :MRITST-ITEM-NBR                      
W37507*             AND A.LOC_NBR       = B.STR_NBR                             
W37507*             AND A.E_BUS_IND     = 'N'                                   
W37507*    END-EXEC.                                                            
W37507*                                                                         
W37507*    EVALUATE SQLCODE                                                     
W37507*      WHEN +0                                                            
W37507*            CONTINUE                                                     
W37507*      WHEN +100                                                          
W37507*            CONTINUE                                                     
W37507*      WHEN OTHER                                                         
W37507*            DISPLAY '5300 FAILED FOR ITEM '                              
W37507*                                           MRITST-ITEM-NBR               
W37507*            MOVE 'CHK REMAIN STRS'  TO PV-DB2-OPER-ATTEMPTED             
W37507*            PERFORM 9999-SQL-ERROR                                       
W37507*    END-EVALUATE.                                                        
W37507*                                                                         
W37507*                                                                         
W37507******************************************************************        
W37507*   SET RT/RT DAY TO ZERO     TMRITEM                                     
W37507******************************************************************        
W37507*5400-SET-RT-TO-ZERO.                                                     
W37507*                                                                         
W37507*    MOVE '5400-SET-RT-TO-ZERO'      TO PV-PARAGRAPH-NAME.                
W37507*                                                                         
W37507*    MOVE MRITST-ITEM-NBR            TO MRITEM-ITEM-NBR.                  
W37507*    MOVE +0                         TO MRITEM-RT-NBR                     
W37507*                                       MRITEM-RT-DAY-NBR.                
W37507*                                                                         
W37507*    EXEC SQL                                                             
W37507*        UPDATE TMRITEM                                                   
W37507*           SET RT_NBR            = :MRITEM-RT-NBR                        
W37507*              ,RT_DAY_NBR        = :MRITEM-RT-DAY-NBR                    
W37507*           WHERE ITEM_NBR = :MRITEM-ITEM-NBR                             
W37507*    END-EXEC.                                                            
W37507*                                                                         
W37507*    EVALUATE SQLCODE                                                     
W37507*      WHEN +0                                                            
W37507*            ADD PC-1 TO PV-UPDATE-CNT-TMRITEM                            
W37507*      WHEN OTHER                                                         
W37507*            MOVE '5400 FAILED TO UPDATE TMRITEM' TO                      
W37507*                 PV-DB2-OPER-ATTEMPTED                                   
W37507*            PERFORM 9999-SQL-ERROR                                       
W37507*    END-EVALUATE.                                                        
W37507*                                                                         
W37507*                                                                         
066400******************************************************************        
066500******************************************************************        
066600                                                                          
066700                                                                          
066800******************************************************************        
066900*   MAIN PROCESSING ROUTINE FOR NEW-ITEM CURSOR                           
067000******************************************************************        
067100 6000-MAIN-PROCESS-NEW-ITEM-CUR.                                          
067200                                                                          
067300     PERFORM 6100-OPEN-NEW-ITEM-CURSOR.                                   
067400                                                                          
067500     PERFORM 6200-OPEN-ICPOL.                                             
067600                                                                          
067700     PERFORM 6300-READ-VSAM-POLICY-FILE.                                  
067800                                                                          
067900     PERFORM 7000-FETCH-NEW-ITEM-CURSOR                                   
068000         UNTIL EOF-NEW-ITEM-CURSOR.                                       
068100                                                                          
068200                                                                          
068300******************************************************************        
068400*   OPEN NEW-ITEM CURSOR                                                  
068500******************************************************************        
068600 6100-OPEN-NEW-ITEM-CURSOR.                                               
068700                                                                          
068800     MOVE '6100-OPEN-NEW-ITEM-CURSOR'                                     
068900                                     TO PV-PARAGRAPH-NAME.                
069000     MOVE 'OPEN NEW-ITEM CURSOR'     TO PV-DB2-OPER-ATTEMPTED.            
069200                                                                          
069300     EXEC SQL                                                             
069400         OPEN NEW_ITEM                                                    
069500     END-EXEC.                                                            
069600                                                                          
069700     EVALUATE TRUE                                                        
069800         WHEN SQLCODE = ZERO                                              
069900             CONTINUE                                                     
070000         WHEN OTHER                                                       
070100             DISPLAY 'OPEN NEW_ITEM FAILURE'                              
070200             PERFORM 9999-SQL-ERROR                                       
070300       END-EVALUATE.                                                      
070400                                                                          
070500                                                                          
070600******************************************************************        
070700*   OPEN POLICY FILE VSAM FILE                                            
070800******************************************************************        
070900 6200-OPEN-ICPOL.                                                         
071000     MOVE '6200-OPEN-ICPOL'          TO PV-PARAGRAPH-NAME.                
071100                                                                          
071200     OPEN INPUT ICPOL.                                                    
071300                                                                          
071400     IF ICPOL-STATUS = '00'                                               
071500         CONTINUE                                                         
071600     ELSE                                                                 
071610         DISPLAY 'OPEN ICPOL FAILURE'                                     
071700         MOVE 'POLICY FILE'          TO PV-ERROR-FILE                     
071800         MOVE 'OPEN FILE'            TO PV-ERROR-OPERATION                
071900         MOVE 'BAD-OPEN'             TO PV-ERROR-STATUS                   
072000         MOVE  '//////////////'      TO PV-NOT-FOUND-KEY                  
072100         PERFORM 9999-VSAM-ERROR                                          
072200         MOVE +4006                  TO PV-ABEND-CODE                     
072300         CALL 'ILBOABN0'  USING PV-ABEND-CODE                             
072400     END-IF.                                                              
072500                                                                          
072600                                                                          
072700******************************************************************        
072800*   READ POLICY VSAM FILE FOR STORE '000'                                 
072900******************************************************************        
073000 6300-READ-VSAM-POLICY-FILE.                                              
073100                                                                          
073200     MOVE '6300-READ-VSAM-POLICY'    TO PV-PARAGRAPH-NAME.                
073300                                                                          
073400     MOVE  00                        TO P-RCD-TYPE.                       
073500     MOVE 'COR'                      TO P-RCD-DESCRP.                     
073600     MOVE LOW-VALUES                 TO P-RCD-NO.                         
073700                                                                          
073800     READ ICPOL  KEY IS P-KEY.                                            
073900                                                                          
074000     IF ICPOL-STATUS NOT = '00'                                           
074100         MOVE 'POLICY FILE'          TO PV-ERROR-FILE                     
074200         MOVE 'READ FILE'            TO PV-ERROR-OPERATION                
074300         MOVE 'BAD-READ'             TO PV-ERROR-STATUS                   
074400         MOVE  P-KEY                 TO PV-NOT-FOUND-KEY                  
074500         PERFORM 9999-VSAM-ERROR                                          
074600         MOVE +4006                  TO PV-ABEND-CODE                     
074700         CALL 'ILBOABN0'  USING PV-ABEND-CODE                             
074800     END-IF.                                                              
074900                                                                          
075000                                                                          
075100******************************************************************        
075200*   FETCH NEW_ITEM CURSOR                                                 
075300******************************************************************        
075400 7000-FETCH-NEW-ITEM-CURSOR.                                              
075500                                                                          
075600     MOVE '7000-FETCH-CSR'       TO PV-PARAGRAPH-NAME.                    
075700     MOVE 'FETCH NEW ITEM CSR'   TO PV-DB2-OPER-ATTEMPTED.                
075800                                                                          
075900     PERFORM                                                              
076000         WITH TEST AFTER                                                  
076100         VARYING PV-SUB1                                                  
076200         FROM 1 BY 1                                                      
076300         UNTIL PV-SUB1 > PC-MAX-RETRIES                                   
076400            OR SQLCODE = ZERO                                             
076500            OR SQLCODE = +100                                             
076600                                                                          
076700         EXEC SQL                                                         
076800             FETCH NEW_ITEM                                               
076900              INTO :MRT00000-ITM-NBR                                      
077000         END-EXEC                                                         
077100                                                                          
077200         EVALUATE TRUE                                                    
077300             WHEN SQLCODE = ZERO                                          
077400                 ADD PC-1      TO PV-INPUT-REC-CNT2                       
077500             WHEN SQLCODE = -904                                          
077600             WHEN SQLCODE = -913                                          
077700                 CONTINUE                                                 
077800             WHEN SQLCODE = +100                                          
077900                 SET EOF-NEW-ITEM-CURSOR TO TRUE                          
078000             WHEN SQLWARN0 NOT = SPACES                                   
078100             WHEN SQLCODE  NOT = ZERO                                     
078200                  PERFORM 9999-SQL-ERROR                                  
078300         END-EVALUATE                                                     
078400     END-PERFORM.                                                         
078500                                                                          
078600     IF SQLCODE = ZERO                                                    
078700         MOVE MRT00000-ITM-NBR       TO PV-HOLD-ITEM                      
078800         PERFORM 7100-SUM-NEW-TOTALS-TMRITST                              
078900         PERFORM 7200-INSERT-CORP-STORE-ROW.                              
079000                                                                          
079100     PERFORM 4900-COMMIT-PROCESSING.                                      
079200                                                                          
079300                                                                          
079400******************************************************************        
079500*   SUM NEW TOTALS   TMRITST                                              
079600******************************************************************        
079700 7100-SUM-NEW-TOTALS-TMRITST.                                             
079800                                                                          
079900     MOVE '7100-SUM-NEW-TOTALS'      TO PV-PARAGRAPH-NAME.                
080000                                                                          
080100     MOVE PV-HOLD-ITEM               TO MRITST-ITEM-NBR.                  
080200                                                                          
080300     EXEC SQL                                                             
080400         SELECT COALESCE(SUM(CSTOCK_QTY),0),                              
080500                COALESCE(SUM(USERMIN_QTY),0),                             
080600                COALESCE(SUM(USERMAX_QTY),0),                             
080700                COALESCE(SUM(DD_FCTR),0)                                  
080800             INTO :PV-CSTOCK-QTY,                                         
080900                  :PV-USERMIN-QTY,                                        
081000                  :PV-USERMAX-QTY,                                        
081100                  :PV-DD-QTY                                              
081200             FROM TMRITST                                                 
081300             WHERE ITEM_NBR = :MRITST-ITEM-NBR                            
                     AND ITEM_NBR NOT IN ('701320000000314',                    
                                          '701320000000313',                    
                                          '701320000000312',                    
                                          '701320000000311',                    
                                          '701320000000310',                    
                                          '701320000000309',                    
                                          '701300000000196',                    
                                          '701300000000195',                    
                                          '701300000000194',                    
                                          '701300000000193',                    
                                          '701300000000191',                    
                                          '701300000000190',                    
                                          '701300000000189',                    
                                          '701300000000188',                    
                                          '701300000000187',                    
                                          '701300000000186',                    
                                          '701300000000185',                    
                                          '701140000000246',                    
                                          '700220000000160',                    
                                          '700220000000159',                    
                                          '700220000000158',                    
                                          '700220000000157',                    
                                          '700220000000156',                    
                                          '700220000000155',                    
                                          '700220000000154',                    
                                          '700220000000153',                    
                                          '700220000000152',                    
                                          '700220000000151',                    
                                          '700220000000150',                    
                                          '700220000000149',                    
                                          '700220000000148',                    
                                          '700220000000147',                    
                                          '700220000000146',                    
                                          '700220000000145',                    
                                          '700220000000144',                    
                                          '700220000000143',                    
                                          '700220000000142',                    
                                          '700220000000141',                    
                                          '700220000000140',                    
                                          '700220000000139',                    
                                          '700220000000138',                    
                                          '700220000000137',                    
                                          '700220000000136',                    
                                          '700220000000135',                    
                                          '700220000000134',                    
                                          '700220000000133',                    
                                          '700220000000132',                    
                                          '700220000000131',                    
                                          '700220000000130',                    
                                          '700220000000129',                    
                                          '700220000000128',                    
                                          '700220000000127',                    
                                          '700220000000126',                    
                                          '700220000000125',                    
                                          '700220000000124',                    
                                          '700220000000123',                    
                                          '700220000000122',                    
                                          '700220000000121',                    
                                          '700220000000120',                    
                                          '700220000000119',                    
                                          '700220000000118',                    
                                          '700220000000117',                    
                                          '700220000000116',                    
                                          '700220000000115',                    
                                          '700220000000114',                    
                                          '700220000000113',                    
                                          '700220000000111',                    
                                          '311560000000068',                    
                                          '700200000000808',                    
                                          '700200000001936',                    
                                          '700200000001938',                    
                                          '700200000001939',                    
                                          '700200000001941',                    
                                          '700200000001942',                    
                                          '700200000001943',                    
                                          '700200000001944',                    
                                          '700200000001946',                    
                                          '700200000001947',                    
                                          '700200000001948',                    
                                          '700200000001949',                    
                                          '700200000001950',                    
                                          '700200000001951',                    
                                          '700200000001952',                    
                                          '700200000001953',                    
                                          '700200000001957',                    
                                          '700200000001958',                    
                                          '700200000001960',                    
                                          '700200000001961',                    
                                          '700200000001962',                    
                                          '700200000001963',                    
                                          '700200000001964',                    
                                          '700200000001965',                    
                                          '700200000001966',                    
                                          '700200000001967',                    
                                          '700200000001969',                    
                                          '700200000001970',                    
                                          '700200000001972',                    
                                          '700200000001975',                    
                                          '700310000000675',                    
                                          '700310000001279',                    
                                          '700310000001280',                    
                                          '700310000001281',                    
                                          '700310000001282',                    
                                          '700310000001283',                    
                                          '700310000001284',                    
                                          '700310000001285',                    
                                          '700310000001286',                    
                                          '700310000001287',                    
                                          '700310000001288',                    
                                          '700310000001289',                    
                                          '700310000001290',                    
                                          '700310000001291',                    
                                          '700310000001292',                    
                                          '700310000001293',                    
                                          '700310000001294',                    
                                          '700310000001295',                    
                                          '700310000001296',                    
                                          '700310000001298',                    
                                          '700310000001299',                    
                                          '700310000001300',                    
                                          '700310000001301',                    
                                          '700310000001302',                    
                                          '700310000001303',                    
                                          '700310000001304',                    
                                          '700310000001305',                    
                                          '700310000001306',                    
                                          '700310000001307',                    
                                          '700310000001308',                    
                                          '700310000001309',                    
                                          '700310000001310',                    
                                          '700310000001311',                    
                                          '700310000001312',                    
                                          '700310000001313',                    
                                          '700310000001314',                    
                                          '700310000001315',                    
                                          '700310000001316',                    
                                          '700310000001318',                    
                                          '700310000001319',                    
                                          '700310000001320',                    
                                          '700310000001322',                    
                                          '700310000001323',                    
                                          '700310000001325',                    
                                          '700310000001326',                    
                                          '700310000001327',                    
                                          '700310000001328',                    
                                          '700310000001329',                    
                                          '700310000001330',                    
                                          '700310000001331',                    
                                          '700310000001332',                    
                                          '700310000001334',                    
                                          '700310000001335',                    
                                          '700310000001336',                    
                                          '700310000001337',                    
                                          '700310000001338',                    
                                          '700310000001339',                    
                                          '700310000001340',                    
                                          '700310000001341',                    
                                          '700310000001342',                    
                                          '700310000001343',                    
                                          '700310000001344',                    
                                          '700310000001345',                    
                                          '700310000001346',                    
                                          '700310000001347',                    
                                          '700310000001348',                    
                                          '700310000001349',                    
                                          '700310000001350',                    
                                          '700540000000181',                    
                                          '700540000000182',                    
                                          '700540000000184',                    
                                          '700540000000187',                    
                                          '700600000000309',                    
                                          '700600000000310',                    
                                          '700610000000128',                    
                                          '701300000000035',                    
                                          '701410000000045')                    
081400               AND STR_NBR > 0                                            
081500     END-EXEC.                                                            
081600                                                                          
081700     EVALUATE SQLCODE                                                     
081800       WHEN +0                                                            
081810             CONTINUE                                                     
082000       WHEN +100                                                          
082100             CONTINUE                                                     
082200       WHEN OTHER                                                         
082300             DISPLAY '7100 FAILED FOR ITEM ' PV-HOLD-ITEM                 
082400             MOVE 'SUM NEW TOTALS' TO                                     
082500                  PV-DB2-OPER-ATTEMPTED                                   
082600             PERFORM 9999-SQL-ERROR                                       
082700     END-EVALUATE.                                                        
082800                                                                          
082900                                                                          
083000******************************************************************        
083100*   INSERT ROW TO CORP STORE   TMRITST                                    
083100*                                                                         
083100*   NOTE:  IT IS POSSIBLE ITEM MAY HAVE BEEN DELETED PRIOR                
083100*          TO THIS PROGRAM RUNNING. THEREFORE, -530 SQL ERROR             
083100*          IS BYPASSED (IF NO TMRITEM ROW EXISTS).                        
083200******************************************************************        
083300 7200-INSERT-CORP-STORE-ROW.                                              
083400                                                                          
083500     MOVE '7200-INSERT-CORP-STORE'   TO PV-PARAGRAPH-NAME.                
083600                                                                          
083700     MOVE  MRT00000-ITM-NBR          TO MRITST-ITEM-NBR.                  
083800     MOVE  '000'                     TO MRITST-STR-NBR.                   
083900     MOVE  'X'                       TO MRITST-FT-CDE.                    
084000                                                                          
084100                                                                          
084200                                                                          
084300*** THE FOLLOWING FIELDS WERE CALCULATED IN PARAGRAPH                     
084400*** 7100-SUM-NEW-TOTALS-TMRITST                                           
084500     MOVE PV-CSTOCK-QTY              TO MRITST-CSTOCK-QTY.                
084600     MOVE PV-USERMIN-QTY             TO MRITST-USERMIN-QTY.               
084700     MOVE PV-USERMAX-QTY             TO MRITST-USERMAX-QTY.               
084800     MOVE PV-DD-QTY                  TO MRITST-DD-FCTR.                   
084900                                                                          
085000                                                                          
085100                                                                          
085200*** THE FOLLOWING FIELDS ARE BEING INITIALIZED                            
085300     MOVE  .1                        TO MRITST-MINDD-QTY.                 
085400     MOVE  ZEROES                    TO MRITST-LPP-QTY.                   
085500     MOVE  ZEROES                    TO MRITST-MADSS-QTY.                 
085600     MOVE  ZEROES                    TO MRITST-FWMAD-QTY.                 
085700     MOVE  ZEROES                    TO MRITST-TRNDP-PCT.                 
085800     MOVE  ZEROES                    TO MRITST-MSDTS-QTY.                 
085900     MOVE  ZEROES                    TO MRITST-MADTS-QTY.                 
086000     MOVE  ZEROES                    TO MRITST-LTVFACT-FCTR.              
086100     MOVE  ZEROES                    TO MRITST-PCTZ-PCT.                  
086200     MOVE  'N'                       TO MRITST-MADSTAT-CDE.               
086300     MOVE  '.............'           TO MRITST-DFLREG-CDE.                
086400     MOVE  '.............'           TO MRITST-TSREG-CDE.                 
086500     MOVE  '.............'           TO MRITST-DIREG-CDE.                 
086600     MOVE  '.............'           TO MRITST-BYPREG-CDE.                
086700     MOVE  ZEROES                    TO MRITST-LDD-FCTR                   
086800     MOVE  ZEROES                    TO MRITST-LDDI-FCTR                  
086900     MOVE  ZEROES                    TO MRITST-LMADSS-QTY.                
087000     MOVE  ZEROES                    TO MRITST-LFWMAD-QTY.                
087100     MOVE  ZEROES                    TO MRITST-LCPS-QTY.                  
087200     MOVE  'N'                       TO MRITST-OUTSTAT-CDE.               
087300     MOVE  ZEROES                    TO MRITST-LRTFCST-NBR.               
087400     MOVE  'O'                       TO MRITST-ORDSTAT-CDE.               
087500     MOVE  ZEROES                    TO MRITST-ON-ORDER-QTY.              
087600                                                                          
087700                                                                          
087800                                                                          
087900*** THE FOLLOWING FIELDS ARE BEING MOVED FROM THE ICI030C                 
088000*** COPY BOOK WHICH IS PART OF THE POLICY RECORD.                         
088100     MOVE  COMSTK                    TO MRITST-COMSTK-QTY.                
088200     MOVE  SPOQSW                    TO MRITST-SPOQSW-CDE.                
088300     MOVE  SPOQ                      TO MRITST-SPOQ-QTY.                  
088400     MOVE  OSTRAT                    TO MRITST-OSTRAT-QTY.                
088500     MOVE  MINOUTL                   TO MRITST-MINOUTL-QTY.               
088600     MOVE  MAXOUTL                   TO MRITST-MAXOUTL-QTY.               
088700     MOVE  FOQ                       TO MRITST-FOQ-QTY.                   
088800     MOVE  TMIN                      TO MRITST-TMIN-QTY.                  
088900     MOVE  DDI                       TO MRITST-DDI-FCTR.                  
089000     MOVE  PTAG                      TO MRITST-PTAG-ID.                   
089100     MOVE  MAXOQP                    TO MRITST-MAXOQP-PCT.                
089200     MOVE  FTJOPF                    TO MRITST-FTJOPF-CDE.                
089300     MOVE  CSTKMINT (1)              TO MRITST-CSTKMINT1-PCT.             
089400     MOVE  CSTKMINT (2)              TO MRITST-CSTKMINT2-PCT.             
089500     MOVE  CSTKMINT (3)              TO MRITST-CSTKMINT3-PCT.             
089600     MOVE  CSTKMINT (4)              TO MRITST-CSTKMINT4-PCT.             
089700     MOVE  CSTKMINT (5)              TO MRITST-CSTKMINT5-PCT.             
089800     MOVE  CSTKMINT (6)              TO MRITST-CSTKMINT6-PCT.             
089900     MOVE  CSTKMAXT (1)              TO MRITST-CSTKMAXT1-PCT.             
090000     MOVE  CSTKMAXT (2)              TO MRITST-CSTKMAXT2-PCT.             
090100     MOVE  CSTKMAXT (3)              TO MRITST-CSTKMAXT3-PCT.             
090200     MOVE  CSTKMAXT (4)              TO MRITST-CSTKMAXT4-PCT.             
090300     MOVE  CSTKMAXT (5)              TO MRITST-CSTKMAXT5-PCT.             
090400     MOVE  CSTKMAXT (6)              TO MRITST-CSTKMAXT6-PCT.             
090500                                                                          
090600                                                                          
090700                                                                          
090800*** THE FOLLOWING FIELDS ARE BEING INITIALIZED AS THEY ARE NOT            
090900*** FOUND ON THE POLICY RECORD.                                           
091000     MOVE  0                         TO MRITST-OUTL-QTY.                  
091100     MOVE  0                         TO MRITST-OP-QTY.                    
091200     MOVE  0.0                       TO MRITST-SSTOCK-QTY.                
091300                                                                          
091400     PERFORM                                                              
091500         WITH TEST AFTER                                                  
091600         VARYING PV-SUB2                                                  
091700         FROM 1 BY 1                                                      
091800         UNTIL PV-SUB2  GREATER THAN PC-MAX-RETRIES                       
091900            OR SQLCODE = 0                                                
092000            OR SQLCODE = +100                                             
092100            OR SQLCODE = -530                                             
092100            OR SQLCODE = -803                                             
092200         EXEC SQL                                                         
092300                INSERT INTO TMRITST                                       
092400                        ( ITEM_NBR,                                       
092500                          STR_NBR,                                        
092600                          COMSTK_QTY,                                     
092700                          SPOQSW_CDE,                                     
092800                          SPOQ_QTY,                                       
092900                          FT_CDE,                                         
093000                          OSTRAT_QTY,                                     
093100                          CSTOCK_QTY,                                     
093200                          MINOUTL_QTY,                                    
093300                          MAXOUTL_QTY,                                    
093400                          FOQ_QTY,                                        
093500                          TMIN_QTY,                                       
093600                          USERMIN_QTY,                                    
093700                          USERMAX_QTY,                                    
093800                          DD_FCTR,                                        
093900                          DDI_FCTR,                                       
094000                          LPP_QTY,                                        
094100                          MADSS_QTY,                                      
094200                          FWMAD_QTY,                                      
094300                          TRNDP_PCT,                                      
094400                          MSDTS_QTY,                                      
094500                          MADTS_QTY,                                      
094600                          LTVFACT_FCTR,                                   
094700                          PCTZ_PCT,                                       
094800                          MADSTAT_CDE,                                    
094900                          DFLREG_CDE,                                     
095000                          TSREG_CDE,                                      
095100                          DIREG_CDE,                                      
095200                          BYPREG_CDE,                                     
095300                          LDD_FCTR,                                       
095400                          LDDI_FCTR,                                      
095500                          LMADSS_QTY,                                     
095600                          LFWMAD_QTY,                                     
095700                          LCPS_QTY,                                       
095800                          OUTSTAT_CDE,                                    
095900                          LRTFCST_NBR,                                    
096000                          ORDSTAT_CDE,                                    
096100                          PTAG_ID,                                        
096200                          MINDD_QTY,                                      
096300                          ON_ORDER_QTY,                                   
096400                          MAXOQP_PCT,                                     
096500                          CSTKMINT1_PCT,                                  
096600                          CSTKMINT2_PCT,                                  
096700                          CSTKMINT3_PCT,                                  
096800                          CSTKMINT4_PCT,                                  
096900                          CSTKMINT5_PCT,                                  
097000                          CSTKMINT6_PCT,                                  
097100                          CSTKMAXT1_PCT,                                  
097200                          CSTKMAXT2_PCT,                                  
097300                          CSTKMAXT3_PCT,                                  
097400                          CSTKMAXT4_PCT,                                  
097500                          CSTKMAXT5_PCT,                                  
097600                          CSTKMAXT6_PCT,                                  
097700                          FTJOPF_CDE,                                     
097800                          PTAG_LAST_UPD_DTE)                              
097900                 VALUES (:MRITST-ITEM-NBR,                                
098000                         :MRITST-STR-NBR,                                 
098100                         :MRITST-COMSTK-QTY,                              
098200                         :MRITST-SPOQSW-CDE,                              
098300                         :MRITST-SPOQ-QTY,                                
098400                         :MRITST-FT-CDE,                                  
098500                         :MRITST-OSTRAT-QTY,                              
098600                         :MRITST-CSTOCK-QTY,                              
098700                         :MRITST-MINOUTL-QTY,                             
098800                         :MRITST-MAXOUTL-QTY,                             
098900                         :MRITST-FOQ-QTY,                                 
099000                         :MRITST-TMIN-QTY,                                
099100                         :MRITST-USERMIN-QTY,                             
099200                         :MRITST-USERMAX-QTY,                             
099300                         :MRITST-DD-FCTR,                                 
099400                         :MRITST-DDI-FCTR,                                
099500                         :MRITST-LPP-QTY,                                 
099600                         :MRITST-MADSS-QTY,                               
099700                         :MRITST-FWMAD-QTY,                               
099800                         :MRITST-TRNDP-PCT,                               
099900                         :MRITST-MSDTS-QTY,                               
100000                         :MRITST-MADTS-QTY,                               
100100                         :MRITST-LTVFACT-FCTR,                            
100200                         :MRITST-PCTZ-PCT,                                
100300                         :MRITST-MADSTAT-CDE,                             
100400                         :MRITST-DFLREG-CDE,                              
100500                         :MRITST-TSREG-CDE,                               
100600                         :MRITST-DIREG-CDE,                               
100700                         :MRITST-BYPREG-CDE,                              
100800                         :MRITST-LDD-FCTR,                                
100900                         :MRITST-LDDI-FCTR,                               
101000                         :MRITST-LMADSS-QTY,                              
101100                         :MRITST-LFWMAD-QTY,                              
101200                         :MRITST-LCPS-QTY,                                
101300                         :MRITST-OUTSTAT-CDE,                             
101400                         :MRITST-LRTFCST-NBR,                             
101500                         :MRITST-ORDSTAT-CDE,                             
101600                         :MRITST-PTAG-ID,                                 
101700                         :MRITST-MINDD-QTY,                               
101800                         :MRITST-ON-ORDER-QTY,                            
101900                         :MRITST-MAXOQP-PCT,                              
102000                         :MRITST-CSTKMINT1-PCT,                           
102100                         :MRITST-CSTKMINT2-PCT,                           
102200                         :MRITST-CSTKMINT3-PCT,                           
102300                         :MRITST-CSTKMINT4-PCT,                           
102400                         :MRITST-CSTKMINT5-PCT,                           
102500                         :MRITST-CSTKMINT6-PCT,                           
102600                         :MRITST-CSTKMAXT1-PCT,                           
102700                         :MRITST-CSTKMAXT2-PCT,                           
102800                         :MRITST-CSTKMAXT3-PCT,                           
102900                         :MRITST-CSTKMAXT4-PCT,                           
103000                         :MRITST-CSTKMAXT5-PCT,                           
103100                         :MRITST-CSTKMAXT6-PCT,                           
103200                         :MRITST-FTJOPF-CDE,                              
103300                          CURRENT DATE)                                   
103400         END-EXEC                                                         
103500         EVALUATE SQLCODE                                                 
103600           WHEN +0                                                        
103700                 ADD PC-1 TO PV-INSERT-CNT-TMRITST                        
103900           WHEN -530                                                      
104200                 DISPLAY '7200- TMRITEM DOES NOT EXIST FOR ITEM '         
104300                                            MRITST-ITEM-NBR               
                       DISPLAY '      COULD NOT INSERT CORP. STORE'             
103900           WHEN -803                                                      
104000                 CONTINUE                                                 
104100           WHEN OTHER                                                     
104200                 DISPLAY '7200 FAILED FOR ITEM '                          
104300                                            MRITST-ITEM-NBR               
104400                 MOVE 'INSERT TMRITST' TO                                 
104500                      PV-DB2-OPER-ATTEMPTED                               
104600                 PERFORM 9999-SQL-ERROR                                   
104700         END-EVALUATE                                                     
104800     END-PERFORM.                                                         
104900                                                                          
105000                                                                          
105100******************************************************************        
105200*   CLOSE FILES, DISPLAY COUNTERS                                         
105300******************************************************************        
105400 9000-END-OF-JOB.                                                         
105500                                                                          
105600     MOVE '9000-END-OF-JOB'          TO PV-PARAGRAPH-NAME.                
105700                                                                          
105800     PERFORM 9100-CLOSE-ITEM-STR-CURSOR.                                  
105900                                                                          
106000     PERFORM 9200-CLOSE-NEW-ITEM-CURSOR.                                  
106100                                                                          
106200                                                                          
106300** ITEM_STR CURSOR PROCESSING DISPLAYS                                    
106400     MOVE PV-INPUT-REC-CNT1     TO PV-INPUT-REC-CNT-DISP.                 
106500     MOVE PV-DELETE-CNT-TMRITEM TO PV-DELETE-CNT-DISP.                    
W37507*    MOVE PV-UPDATE-CNT-TMRITEM TO PV-UPDATE-CNT-DISP1.                   
106700     MOVE PV-UPDATE-CNT-TMRITST TO PV-UPDATE-CNT-DISP2.                   
106800                                                                          
106810     DISPLAY '              '.                                            
106900     DISPLAY 'ITEM_STR CURSOR PROCESSING DISPLAYS'.                       
107000     DISPLAY 'ITEM_STR CURSOR ROWS FETCHED: '                             
107100              PV-INPUT-REC-CNT-DISP.                                      
107200                                                                          
107300     DISPLAY 'TMRITEM DELETED FOR STORE CNT = ZERO: '                     
107400              PV-DELETE-CNT-DISP.                                         
107500                                                                          
W37507*    DISPLAY 'TMRITEM UPDATED FOR RT & RT DAY ZERO: '                     
W37507*             PV-UPDATE-CNT-DISP1.                                        
107800                                                                          
107900     DISPLAY 'TMRITST UPDATED FOR CORP STR RECALCS: '                     
108000              PV-UPDATE-CNT-DISP2.                                        
108100                                                                          
108200                                                                          
108300     DISPLAY '              '.                                            
108400                                                                          
108500                                                                          
108600** NEW_ITEM CURSOR PROCESSING DISPLAYS                                    
108700     MOVE PV-INPUT-REC-CNT2     TO PV-INPUT-REC-CNT-DISP.                 
108800     MOVE PV-INSERT-CNT-TMRITST TO PV-INSERT-CNT-DISP.                    
108900                                                                          
109000     DISPLAY 'NEW_ITEM CURSOR PROCESSING DISPLAYS'.                       
109100     DISPLAY 'NEW_ITEM CURSOR ROWS FETCHED: '                             
109200              PV-INPUT-REC-CNT-DISP.                                      
109300                                                                          
109400     DISPLAY 'NBR ROWS INSERTED TO TMRITST: '                             
109500              PV-INSERT-CNT-DISP.                                         
109600                                                                          
109700                                                                          
109800*****************************************************************         
109900*   CLOSE ITEM_STR CURSOR                                                 
110000******************************************************************        
110100 9100-CLOSE-ITEM-STR-CURSOR.                                              
110200                                                                          
110300     MOVE '9100-CLOSE-ITEM-STR-CURSOR'                                    
110400                                 TO PV-PARAGRAPH-NAME.                    
110500                                                                          
110600     MOVE 'CLOSE ITEM_STR'       TO PV-DB2-OPER-ATTEMPTED.                
110800                                                                          
110900     EXEC SQL                                                             
111000         CLOSE ITEM_STR                                                   
111100     END-EXEC.                                                            
111200                                                                          
111300     EVALUATE TRUE                                                        
111400         WHEN SQLCODE = ZERO                                              
111500             CONTINUE                                                     
111600         WHEN OTHER                                                       
111700             DISPLAY '9100-CLOSE-ITEM-STR-CURSOR'                         
111800             PERFORM 9999-SQL-ERROR                                       
111900       END-EVALUATE.                                                      
112000                                                                          
112100                                                                          
112200*****************************************************************         
112300*   CLOSE NEW_ITEM CURSOR                                                 
112400******************************************************************        
112500 9200-CLOSE-NEW-ITEM-CURSOR.                                              
112600                                                                          
112700     MOVE '9200-CLOSE-NEW-ITEM-CURSOR'                                    
112800                                 TO PV-PARAGRAPH-NAME.                    
112900                                                                          
113000     MOVE 'CLOSE NEW_ITEM'       TO PV-DB2-OPER-ATTEMPTED.                
113200                                                                          
113300     EXEC SQL                                                             
113400         CLOSE NEW_ITEM                                                   
113500     END-EXEC.                                                            
113600                                                                          
113700     EVALUATE TRUE                                                        
113800         WHEN SQLCODE = ZERO                                              
113900             CONTINUE                                                     
114000         WHEN OTHER                                                       
114100             DISPLAY '9200-CLOSE-NEW-ITEM-CURSOR'                         
114200             PERFORM 9999-SQL-ERROR                                       
114300       END-EVALUATE.                                                      
114400                                                                          
114500                                                                          
114600******************************************************************        
114700*   SQL ABEND ROUTINE                                                     
114800******************************************************************        
114900 9999-SQL-ERROR.                                                          
115000                                                                          
115100     DISPLAY '**  ABEND     **'.                                          
115200     DISPLAY '**  PROGRAM   **  =  MRKUP124'.                             
115300     DISPLAY '**  PARAGRAPH **  = ' PV-PARAGRAPH-NAME.                    
115400     DISPLAY '**  OPERATION **  = ' PV-DB2-OPER-ATTEMPTED.                
115500*                                                                         
115600*    THE FOLLOWING COPYBOOK UTILIZES THE DB2 ABEND MODULE                 
115700*    DSNTIAR TO CONVERT SQLCA INTO UNDERSTANDABLE VERBAGE.                
115800*                                                                         
115900     COPY DPPD004.                                                        
116000*                                                                         
116100                                                                          
116200     MOVE +4013 TO PV-ABEND-CODE.                                         
116300     CALL 'ILBOABN0'  USING PV-ABEND-CODE.                                
116400                                                                          
116500                                                                          
116600******************************************************************        
116700*   VSAM ERROR ROUTINE                                                    
116800******************************************************************        
116900 9999-VSAM-ERROR.                                                         
117000                                                                          
117100     DISPLAY '**   ABEND   **'.                                           
117200     DISPLAY 'PROGRAM NAME = ' PC-PGRM-NAME.                              
117300     DISPLAY PV-PARAGRAPH-NAME.                                           
117400     DISPLAY PV-ERROR-FILE-MSG.                                           
117500     DISPLAY PV-ERROR-OPERATION-MSG.                                      
117600     DISPLAY PV-ERROR-STATUS-MSG.                                         
117700     DISPLAY PV-NOT-FOUND-MSG                                             
117800     DISPLAY 'VSAM STATUS = ' ICPOL-STATUS.                               
117900     DISPLAY '***************'.                                           
118000                                                                          
