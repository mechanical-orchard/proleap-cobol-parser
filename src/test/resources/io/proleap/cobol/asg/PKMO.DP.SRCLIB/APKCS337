000100 IDENTIFICATION DIVISION.                                         00010002
000200 PROGRAM-ID.    APKCS337.                                         00020002
000300 AUTHOR.        MARY KING.                                        00030002
000400 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00040002
000500 DATE-WRITTEN.  08/17/95.                                         00050002
000600 DATE-COMPILED.                                                   00060002
000700                                                                  00070002
000800*---------------------------------------------------------------* 00080002
000900*    TRANID      - A337                                         * 00090002
001000*    TYPE        - CICS ARCHITECTURE MAINTENANCE - DB2          * 00100002
001100*    MAPSET      - APKM337                                      * 00110002
001200*                                                               * 00120002
001300*    THIS SCREEN ALLOWS USERS TO ADD AND REMOVE VENDOR/DEPTS    * 00130002
001400*    FROM TVNDAGR FOR THE PURPOSE OF INDICATING VENDOR/DEPTS    * 00140002
001500*    THAT REQUIRE MANUAL RECONCILIATION.                        * 00150002
001600*                                                               * 00160002
001700*    NOTE: THIS SCREEN CURRENTLY ALLOWS AN ADD WHEN IN UPDATE   * 00170002
001800*          MODE WHEN THE MANUAL RECON IND = 'Y'.  IF MORE       * 00180002
001900*          UPDATEABLE FIELDS ARE ADDED TO THIS SCREEN, THIS     * 00190002
002000*          FUNCTIONALITY MAY BE REMOVED.                        * 00200002
002100*---------------------------------------------------------------* 00210002
002200                                                                  00220002
002300 ENVIRONMENT DIVISION.                                            00230002
002400 DATA DIVISION.                                                   00240002
002500/                                                                 00250002
002600 WORKING-STORAGE SECTION.                                         00260002
002700                                                                  00270002
002800 01  DN-DB2-NULL-INDICATORS.                                      00280002
002900     05  DN-EXPIRATION-DATE           PIC S9(04) VALUE +0         00290002
003000                                                  COMP.           00300002
003100     05  DN-PROD-STATUS-IND           PIC S9(04) VALUE +0         00310002
003200                                                  COMP.           00320002
003300                                                                  00330002
003400 01  DK-DB2-KEYS.                                                 00340002
003500     05  DK-DUN-NBR                   PIC  X(09) VALUE SPACES.    00350002
003600     05  DK-DEPT-NBR                  PIC  X(03) VALUE SPACES.    00360002
003700     05  DK-ENT-ID                    PIC S9(09) VALUE +0         00370002
003800                                                 COMP.            00380002
003900                                                                  00390002
004000 01  PC-PROGRAM-CONSTANTS.                                        00400002
004100     05  PC-TRANS-ID                  PIC X(04)  VALUE 'A337'.    00410002
004200     05  PC-CURRENT-PROGRAM-NAME      PIC X(08)  VALUE 'APKCS337'.00420002
004300     05  PC-CURRENT-MAP-NAME          PIC X(08)  VALUE 'AP337A  '.00430002
004400     05  PC-CURRENT-MAPSET-NAME       PIC X(08)  VALUE 'APKM337 '.00440002
004500     05  PC-MAX-RETRIES               PIC S9(04) VALUE  +3        00450002
004600                                                 COMP.            00460002
004700     05  PC-TSYMSG-NUMBERS.                                       00470002
004800         10  PC-TSYMSG-00005          PIC 9(05)  VALUE 00005.     00480002
004900         10  PC-TSYMSG-00034          PIC 9(05)  VALUE 00034.     00490002
005000         10  PC-TSYMSG-00059          PIC 9(05)  VALUE 00059.     00500002
005100         10  PC-TSYMSG-01093          PIC 9(05)  VALUE 01093.     00510002
005200         10  PC-TSYMSG-01094          PIC 9(05)  VALUE 01094.     00520002
005300         10  PC-TSYMSG-01095          PIC 9(05)  VALUE 01095.     00530002
005400         10  PC-TSYMSG-01098          PIC 9(05)  VALUE 01098.     00540002
005500         10  PC-TSYMSG-01099          PIC 9(05)  VALUE 01099.     00550002
005600                                                                  00560002
005700 01  PS-PROGRAM-SWITCHES.                                         00570002
005800     05  PS-ERROR-SW                  PIC X(01)  VALUE 'N'.       00580002
005900         88  PS-ERROR                            VALUE 'Y'.       00590002
006000         88  PS-NO-ERROR                         VALUE 'N'.       00600002
006100     05  PS-COMMAREA-SW               PIC  X(01) VALUE 'N'.       00610002
006200         88  PS-COMMAREA-VALID                   VALUE 'Y'.       00620002
006300         88  PS-COMMAREA-NOT-VALID               VALUE 'N'.       00630002
006400     05  PS-FOUND-SW                  PIC X(01)  VALUE 'N'.       00640002
006500         88  PS-FOUND                            VALUE 'Y'.       00650002
006600         88  PS-NOT-FOUND                        VALUE 'N'.       00660002
006700                                                                  00670002
006800 01  PV-PROGRAM-VARIABLES.                                        00680002
006900     05  PV-CICS-RESPONSE             PIC S9(04) VALUE +0         00690002
007000                                                 COMP SYNC.       00700002
007100     05  PV-RETRY-COUNTER             PIC S9(04) VALUE +0         00710002
007200                                                 COMP SYNC.       00720002
007300     05  PV-MAX-SEQ-NBR               PIC S9(04) VALUE +0         00730002
007400                                                 COMP.            00740002
007500     05  PV-NEXT-SEQ-NBR              PIC S9(04) VALUE +0         00750002
007600                                                 COMP.            00760002
007700     05  PV-DB2-COUNT                 PIC S9(09) VALUE +0         00770002
007800                                                 COMP.            00780002
007900     05  PV-DB2-EXPIR-DATE.                                       00790002
008000         10  PV-DB2-EXPIR-CY-YR.                                  00800002
008100             15  PV-DB2-EXPIR-CY      PIC  X(02) VALUE '99'.      00810002
008200             15  PV-DB2-EXPIR-YR      PIC  X(02) VALUE '99'.      00820002
008300         10  FILLER                   PIC  X(01) VALUE '-'.       00830002
008400         10  PV-DB2-EXPIR-MO          PIC  X(02) VALUE '12'.      00840002
008500         10  FILLER                   PIC  X(01) VALUE '-'.       00850002
008600         10  PV-DB2-EXPIR-DA          PIC  X(02) VALUE '31'.      00860002
008700                                                                  00870002
008800     05  PV-DB2-DATE.                                             00880002
008900         10  PV-DB2-CY-YR.                                        00890002
009000             15  PV-DB2-CY            PIC  X(02) VALUE SPACE.     00900002
009100             15  PV-DB2-YR            PIC  X(02) VALUE SPACE.     00910002
009200         10  FILLER                   PIC  X(01) VALUE '-'.       00920002
009300         10  PV-DB2-MO                PIC  X(02) VALUE SPACE.     00930002
009400         10  FILLER                   PIC  X(01) VALUE '-'.       00940002
009500         10  PV-DB2-DA                PIC  X(02) VALUE SPACE.     00950002
009600/                                                                 00960002
009700*----------------------------------------------------------------*00970002
009800*    MAP LAYOUT                                                  *00980002
009900*----------------------------------------------------------------*00990002
010000                                                                  01000002
010100     COPY APKM337.                                                01010002
010200/                                                                 01020002
010300*----------------------------------------------------------------*01030002
010400*    ATTRIBUTE SETTINGS COPYBOOK.                                *01040002
010500*----------------------------------------------------------------*01050002
010600                                                                  01060002
010700     COPY DPWS015.                                                01070002
010800/                                                                 01080002
010900*----------------------------------------------------------------*01090002
011000*    FUNCTION KEYS COPYBOOK                                      *01100002
011100*----------------------------------------------------------------*01110002
011200                                                                  01120002
011300     COPY DPWS016.                                                01130002
011400/                                                                 01140002
011500*----------------------------------------------------------------*01150002
011600*    THE CALLING PARAMETER LIST (DPWS030) FOR THE CICS ARCHIT.   *01160002
011700*    APPLICATION PROGRAMMING INTERFACE MODULE -- DPKCS030.       *01170002
011800*----------------------------------------------------------------*01180002
011900     COPY DPWS030.                                                01190002
012000     COPY DPWS930.                                                01200002
012100/                                                                 01210002
012200*----------------------------------------------------------------*01220002
012300*    STANDARD COMMAREA.                                          *01230002
012400*----------------------------------------------------------------*01240002
012500                                                                  01250002
012600     COPY DPWS020.                                                01260002
012700     05  FILLER REDEFINES DP020-VARIABLE-COMMAREA.                01270002
012800                                                                  01280002
012900*----------------------------------------------------------------*01290002
013000*    INTER-APPLICATION COMMAREA.                                 *01300002
013100*----------------------------------------------------------------*01310002
013200                                                                  01320002
013300         10  INTER-APPL-COMM-AREA PIC X(200).                     01330002
013400     COPY APWS302.                                                01340002
013500*----------------------------------------------------------------*01350002
013600*    SPECIFIC COMMMAREA FOR APKCS337.                            *01360002
013700*----------------------------------------------------------------*01370002
013800         10  ASC-SPECIFIC-COMMAREA.                               01380002
013900             15  ASC-INT-APPL-FORMAT-IND   PIC X(01).             01390002
014000                 88  ASC-INTER-APPL-ADD          VALUE ' '.       01400002
014100                 88  ASC-INTER-APPL-UPDATE       VALUE '1'.       01410002
014200             15  ASC-KEY-FIELDS.                                  01420002
014300                 20  ASC-KEY-DUN-NBR       PIC X(09).             01430002
014400                 20  ASC-KEY-DEPT          PIC X(03).             01440002
014500                 20  ASC-KEY-ENT-ID        PIC S9(9) COMP.        01450002
014600             15  ASC-SCREEN-FIELDS.                               01460002
014700                 20  ASC-ENT-NAME-DESC        PIC X(30).          01470002
014800                 20  ASC-MANUAL-RECON-IND     PIC X(01).          01480002
014900                 20  ASC-START-DATE           PIC X(10).          01490002
015000                 20  ASC-END-DATE             PIC X(10).          01500002
015100             15  ASC-OLD-SCREEN-VALUES.                           01510002
015200                 20  ASC-MANUAL-RECON-IND-OLD PIC X(01).          01520002
015300             15  ASC-DB2-DATE                 PIC  X(10).         01530002
015400             15  ASC-DB2-CURRENT-DATE REDEFINES ASC-DB2-DATE.     01540002
015500                 20  ASC-DB2-CURRENT-CY-YR.                       01550002
015600                     25  ASC-DB2-CURRENT-CY   PIC  X(02).         01560002
015700                     25  ASC-DB2-CURRENT-YR   PIC  X(02).         01570002
015800                 20  FILLER                   PIC  X(01).         01580002
015900                 20  ASC-DB2-CURRENT-MO       PIC  X(02).         01590002
016000                 20  FILLER                   PIC  X(01).         01600002
016100                 20  ASC-DB2-CURRENT-DA       PIC  X(02).         01610002
016200             15  ASC-DISPLAY-START-DATE.                          01620002
016300                 20  ASC-DISPLAY-START-MO     PIC  X(02).         01630002
016400                 20  ASC-DISPLAY-START-S1     PIC  X(01).         01640002
016500                 20  ASC-DISPLAY-START-DA     PIC  X(02).         01650002
016600                 20  ASC-DISPLAY-START-S2     PIC  X(01).         01660002
016700                 20  ASC-DISPLAY-START-CY-YR.                     01670002
016800                     25  ASC-DISPLAY-START-CY PIC  X(02).         01680002
016900                     25  ASC-DISPLAY-START-YR PIC  X(02).         01690002
017000             15  ASC-DISPLAY-END-DATE.                            01700002
017100                 20  ASC-DISPLAY-END-MO       PIC  X(02).         01710002
017200                 20  ASC-DISPLAY-END-S1       PIC  X(01).         01720002
017300                 20  ASC-DISPLAY-END-DA       PIC  X(02).         01730002
017400                 20  ASC-DISPLAY-END-S2       PIC  X(01).         01740002
017500                 20  ASC-DISPLAY-END-CY-YR.                       01750002
017600                     25  ASC-DISPLAY-END-CY   PIC  X(02).         01760002
017700                     25  ASC-DISPLAY-END-YR   PIC  X(02).         01770002
017800/                                                                 01780002
017900*----------------------------------------------------------------*01790002
018000*    ABEND PROCESSING COPYBOOK.                                  *01800002
018100*----------------------------------------------------------------*01810002
018200                                                                  01820002
018300     COPY DPWS013.                                                01830002
018400/                                                                 01840002
018500*----------------------------------------------------------------*01850002
018600*    DB2 SQL COMMUNICATION AREA                                   01860002
018700*----------------------------------------------------------------*01870002
018800     EXEC SQL                                                     01880002
018900          INCLUDE SQLCA                                           01890002
019000     END-EXEC.                                                    01900002
019100/                                                                 01910002
019200*----------------------------------------------------------------*01920002
019300*    DB2 DCLGEN FOR VENDOR EXTERNAL ENTERPRISE TABLE              01930002
019400*----------------------------------------------------------------*01940002
019500     EXEC SQL                                                     01950002
019600          INCLUDE TEXTENT                                         01960002
019700     END-EXEC.                                                    01970002
019800/                                                                 01980002
019900*----------------------------------------------------------------*01990002
020000*    DB2 DCLGEN FOR VENDOR EXTERNAL ENTERPRISE NAME TABLE         02000002
020100*----------------------------------------------------------------*02010002
020200     EXEC SQL                                                     02020002
020300          INCLUDE TENTNME                                         02030002
020400     END-EXEC.                                                    02040002
020500/                                                                 02050002
020600*----------------------------------------------------------------*02060002
020700*    DB2 DCLGEN FOR VENDOR DEPARTMENT TABLE                       02070002
020800*----------------------------------------------------------------*02080002
020900     EXEC SQL                                                     02090002
021000          INCLUDE TVNDDPT                                         02100002
021100     END-EXEC.                                                    02110002
021200/                                                                 02120002
021300*----------------------------------------------------------------*02130002
021400*    DB2 DCLGEN FOR VENDOR AGREEMENT TABLE                        02140002
021500*----------------------------------------------------------------*02150002
021600     EXEC SQL                                                     02160002
021700          INCLUDE TVNDAGR                                         02170002
021800     END-EXEC.                                                    02180002
021900/                                                                 02190002
022000 LINKAGE SECTION.                                                 02200002
022100                                                                  02210002
022200 01  DFHCOMMAREA.                                                 02220002
022300     05  FILLER                       OCCURS  1 TO 4072 TIMES     02230002
022400                                      DEPENDING ON EIBCALEN.      02240002
022500         10  FILLER                   PIC X.                      02250002
022600/                                                                 02260002
022700 PROCEDURE DIVISION.                                              02270002
022800                                                                  02280002
022900*----------------------------------------------------------------*02290002
023000*    THIS MODULE CONTROLS THE OVERALL PROCESSING IN THE PROGRAM. *02300002
023100*    THE SETUP AND PERFORM OF PARAGRAPH 0001-CALL-CICS-ARCH-API  *02310002
023200*    MUST BE THE FIRST CODE EXECUTED IN THIS PROGRAM.            *02320002
023300*                                                                *02330002
023400*    THE SECOND OR 'EXIT' PERFORM OF THIS PARAGRAPH MUST BE THE  *02340002
023500*    LAST CODE EXECUTED ON EACH ITERATION OF THIS PROGRAM.       *02350002
023600*----------------------------------------------------------------*02360002
023700 0000-MAIN-MODULE.                                                02370002
023800                                                                  02380002
023900     INITIALIZE DP030-CICS-API-FIELDS.                            02390002
024000     MOVE +1                       TO DP030-NUMBER-OF-MAPS.       02400002
024100     MOVE PC-CURRENT-MAPSET-NAME   TO DP030-MAPSET-NAME.          02410002
024200     MOVE PC-CURRENT-MAP-NAME      TO DP030-MAP-NAME (1).         02420002
024300     SET DP030-RECEIVE-APPL-MAP    TO TRUE.                       02430002
024400     MOVE LENGTH OF AP337AI        TO DP030-MAP-LENGTH (1).       02440002
024500     MOVE 'PROGRAM ENTRY CALL'     TO DP013-MESSAGE-TEXT (1).     02450002
024600     PERFORM 0001-CALL-CICS-ARCH-API.                             02460002
024700                                                                  02470002
024800     PERFORM 1000-CONTROL-PROCESSING.                             02480002
024900                                                                  02490002
025000     MOVE 'PROGRAM EXIT CALL'      TO DP013-MESSAGE-TEXT (1).     02500002
025100     PERFORM 0001-CALL-CICS-ARCH-API.                             02510002
025200                                                                  02520002
025300/                                                                 02530002
025400 0001-CALL-CICS-ARCH-API.                                         02540002
025500                                                                  02550002
025600     CALL DP930-CICS-ARCH-API  USING DFHEIBLK                     02560002
025700                                     DFHCOMMAREA                  02570002
025800                                     DP030-CICS-API-FIELDS        02580002
025900                                     DP020-STANDARD-COMMAREA      02590002
026000                                     AP337AI.                     02600002
026100                                                                  02610002
026200     IF  DP030-RC-CALL-SUCCESSFUL                                 02620002
026300         CONTINUE                                                 02630002
026400     ELSE                                                         02640002
026500         SET DP013-NO-ROLLBACK                                    02650002
026600             DP013-XCTL-DISPLAY-RESTART                           02660002
026700             DP013-CICS-ABEND      TO TRUE                        02670002
026800         MOVE 'BEFORE 0000-MAIN-MODULE'                           02680002
026900                                   TO DP013-PARAGRAPH             02690002
027000         MOVE 'CALL TO CICS ARCH API NOT SUCCESSFUL, RETURN-CODE O02700002
027100-             'N NEXT LINE'        TO DP013-MESSAGE-TEXT (2)      02710002
027200         MOVE DP030-RETURN-CODE    TO DP013-MESSAGE-TEXT (3)      02720002
027300         PERFORM DP013-0000-PROCESS-ABEND                         02730002
027400     END-IF.                                                      02740002
027500                                                                  02750002
027600/                                                                 02760002
027700*----------------------------------------------------------------*02770002
027800*    PROCESS THE APPROPRIATE PARAGRAPHS BASED ON WHAT THE NEXT   *02780002
027900*    COURSE OF ACTION IS FOR THIS TRANSACTION.                   *02790002
028000*----------------------------------------------------------------*02800002
028100                                                                  02810002
028200 1000-CONTROL-PROCESSING.                                         02820002
028300                                                                  02830002
028400     EVALUATE TRUE                                                02840002
028500         WHEN DP020-NEXT-ACT-INITIAL                              02850002
028600              INITIALIZE ASC-SPECIFIC-COMMAREA                    02860002
028700              PERFORM 1100-PROCESS-INTER-APPL-COMM                02870002
028800              IF  PS-COMMAREA-NOT-VALID                           02880002
028900*                -- THIS WILL RETURN TO CALLING APPLICATION       02890002
029000*                -- WHEN API IS CALLED                            02900002
029100                 SET DP020-NEXT-ACT-APPL-ERROR                    02910002
029200                                   TO TRUE                        02920002
029300              ELSE                                                02930002
029400                  PERFORM 4000-BUILD-INITIAL-PANEL                02940002
029500                  PERFORM 3200-RESET-ATTRIBUTES                   02950002
029600                  MOVE ASC-MANUAL-RECON-IND                       02960002
029700                            TO ASC-MANUAL-RECON-IND-OLD           02970002
029800                  PERFORM 4400-MOVE-COMMAREA-TO-SCREEN            02980002
029900              END-IF                                              02990002
030000                                                                  03000002
030100         WHEN DP020-NEXT-ACT-READ-MAP                             03010002
030200              PERFORM 2000-PROCESS-PANEL                          03020002
030300                                                                  03030002
030400         WHEN DP020-NEXT-ACT-RETURN                               03040002
030500              CONTINUE                                            03050002
030600                                                                  03060002
030700         WHEN OTHER                                               03070002
030800              SET DP013-LOGIC-ABEND                               03080002
030900                  DP013-NO-ROLLBACK TO TRUE                       03090002
031000              MOVE '1000-CONTROL-PROCESSING'                      03100002
031100                                    TO DP013-PARAGRAPH            03110002
031200              MOVE 'INVALID NEXT ACTIVITY RETURNED TO APPL PGM:'  03120002
031300                                    TO DP013-MESSAGE-TEXT(1)      03130002
031400              MOVE DP020-NEXT-APPL-ACTIVITY                       03140002
031500                                    TO DP013-MESSAGE-TEXT(2)      03150002
031600              PERFORM DP013-0000-PROCESS-ABEND                    03160002
031700     END-EVALUATE.                                                03170002
031800/                                                                 03180002
031900*----------------------------------------------------------------*03190002
032000* EDIT DATA IN INTER-APPL COMMAREA.                              *03200002
032100*----------------------------------------------------------------*03210002
032200                                                                  03220002
032300 1100-PROCESS-INTER-APPL-COMM.                                    03230002
032400                                                                  03240002
032500     SET PS-COMMAREA-VALID         TO TRUE.                       03250002
032600                                                                  03260002
032700     EVALUATE TRUE                                                03270002
032800                                                                  03280002
032900     WHEN AP302-DUN-NBR = SPACES AND AP302-DEPT-NBR = SPACES      03290002
033000     WHEN AP302-DUN-NBR > SPACES AND AP302-DEPT-NBR = SPACES      03300002
033100     WHEN AP302-DUN-NBR = SPACES AND AP302-DEPT-NBR > SPACES      03310002
033200*            -- BOTH VENDOR NBR AND DEPARTMENT REQUIRED --        03320002
033300         MOVE PC-TSYMSG-01093      TO DP020-MSG-NUMBER            03330002
033400         SET DP020-MSG-FATAL       TO TRUE                        03340002
033500         SET PS-COMMAREA-NOT-VALID TO TRUE                        03350002
033600                                                                  03360002
033700     WHEN OTHER                                                   03370002
033800         MOVE AP302-DUN-NBR   TO ASC-KEY-DUN-NBR                  03380002
033900                                 DK-DUN-NBR                       03390002
034000         MOVE AP302-DEPT-NBR  TO ASC-KEY-DEPT                     03400002
034100                                 DK-DEPT-NBR                      03410002
034200         SET PS-NOT-FOUND TO TRUE                                 03420002
034300         PERFORM 1110-GET-ENT-ID                                  03430002
034400                                                                  03440002
034500         IF PS-NOT-FOUND                                          03450002
034600*            -- VENDOR NBR IS INVALID --                          03460002
034700             MOVE PC-TSYMSG-01095      TO DP020-MSG-NUMBER        03470002
034800             SET DP020-MSG-FATAL       TO TRUE                    03480002
034900             SET PS-COMMAREA-NOT-VALID TO TRUE                    03490002
035000                                                                  03500002
035100         ELSE                                                     03510002
035200             MOVE EXTENT-ENT-ID        TO ASC-KEY-ENT-ID          03520002
035300                                          DK-ENT-ID               03530002
035400             SET PS-NOT-FOUND TO TRUE                             03540002
035500             PERFORM 1120-GET-VENDOR-DEPT                         03550002
035600                                                                  03560002
035700             IF PS-NOT-FOUND                                      03570002
035800*            -- VENDOR NBR/DEPT COMBINATION IS INVALID --         03580002
035900                 MOVE PC-TSYMSG-01094      TO DP020-MSG-NUMBER    03590002
036000                 SET DP020-MSG-FATAL       TO TRUE                03600002
036100                 SET PS-COMMAREA-NOT-VALID TO TRUE                03610002
036200             END-IF                                               03620002
036300                                                                  03630002
036400         END-IF                                                   03640002
036500     END-EVALUATE.                                                03650002
036600/                                                                 03660002
036700*----------------------------------------------------------------*03670002
036800*    GET THE ENT ID                                              *03680002
036900*----------------------------------------------------------------*03690002
037000 1110-GET-ENT-ID.                                                 03700002
037100                                                                  03710002
037200     PERFORM                                                      03720002
037300         WITH TEST AFTER                                          03730002
037400         VARYING PV-RETRY-COUNTER                                 03740002
037500         FROM 1 BY 1                                              03750002
037600         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               03760002
037700             OR (SQLCODE = +0)                                    03770002
037800             OR (SQLCODE = +100))                                 03780002
037900                                                                  03790002
038000         EXEC SQL                                                 03800002
038100              SELECT ENT_ID                                       03810002
038200                INTO :EXTENT-ENT-ID                               03820002
038300                FROM TEXTENT                                      03830002
038400               WHERE DUN_NBR   = :DK-DUN-NBR                      03840002
038500         END-EXEC                                                 03850002
038600                                                                  03860002
038700         EVALUATE TRUE                                            03870002
038800             WHEN SQLCODE = +0                                    03880002
038900                  SET PS-FOUND TO TRUE                            03890002
039000                                                                  03900002
039100             WHEN SQLCODE = +100                                  03910002
039200             WHEN SQLCODE = -904                                  03920002
039300             WHEN SQLCODE = -913                                  03930002
039400                  CONTINUE                                        03940002
039500                                                                  03950002
039600             WHEN SQLWARN0 NOT = SPACES                           03960002
039700             WHEN SQLCODE < +0                                    03970002
039800             WHEN SQLCODE > +0                                    03980002
039900                  MOVE '1110-GET-ENT-ID'                          03990002
040000                                  TO DP013-PARAGRAPH              04000002
040100                  MOVE 'UNSUCCESSFUL SELECT ENTERPRISE ID'        04010002
040200                                  TO DP013-MESSAGE-TEXT (1)       04020002
040300                  MOVE SQLCA      TO DP013-SQLCA                  04030002
040400                  MOVE 'TEXTENT ' TO DP013-DB2-TABLE-NAME (1)     04040002
040500                  SET DP013-DB2-ABEND                             04050002
040600                      DP013-XCTL-DISPLAY-RESTART                  04060002
040700                                  TO TRUE                         04070002
040800                  PERFORM DP013-0000-PROCESS-ABEND                04080002
040900         END-EVALUATE                                             04090002
041000     END-PERFORM.                                                 04100002
041100                                                                  04110002
041200     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        04120002
041300         MOVE '1110-GET-ENT-ID'   TO DP013-PARAGRAPH              04130002
041400         MOVE 'MAX RETRIES EXCEEDED ON SELECT ENTERPRISE ID'      04140002
041500                                  TO DP013-MESSAGE-TEXT (1)       04150002
041600         MOVE SQLCA               TO DP013-SQLCA                  04160002
041700         MOVE 'TEXTENT '          TO DP013-DB2-TABLE-NAME (1)     04170002
041800         SET DP013-DB2-ABEND                                      04180002
041900             DP013-XCTL-DISPLAY-RESTART                           04190002
042000                                  TO TRUE                         04200002
042100         PERFORM DP013-0000-PROCESS-ABEND                         04210002
042200     END-IF.                                                      04220002
042300/                                                                 04230002
042400*----------------------------------------------------------------*04240002
042500*    VERIFY THE VENDOR DEPARTMENT COMBINATION                    *04250002
042600*----------------------------------------------------------------*04260002
042700 1120-GET-VENDOR-DEPT.                                            04270002
042800                                                                  04280002
042900     PERFORM                                                      04290002
043000         WITH TEST AFTER                                          04300002
043100         VARYING PV-RETRY-COUNTER                                 04310002
043200         FROM 1 BY 1                                              04320002
043300         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               04330002
043400             OR (SQLCODE = +0)                                    04340002
043500             OR (SQLCODE = +100)                                  04350002
043600             OR (SQLCODE = -811))                                 04360002
043700                                                                  04370002
043800         EXEC SQL                                                 04380002
043900              SELECT 1                                            04390002
044000                INTO :PV-DB2-COUNT                                04400002
044100                FROM TVNDDPT                                      04410002
044200               WHERE ENT_ID    = :DK-ENT-ID                       04420002
044300                 AND DEPT_NBR  = :DK-DEPT-NBR                     04430002
044400         END-EXEC                                                 04440002
044500                                                                  04450002
044600         EVALUATE TRUE                                            04460002
044700             WHEN SQLCODE = +0                                    04470002
044800             WHEN SQLCODE = -811                                  04480002
044900                  SET PS-FOUND TO TRUE                            04490002
045000                                                                  04500002
045100             WHEN SQLCODE = +100                                  04510002
045200             WHEN SQLCODE = -904                                  04520002
045300             WHEN SQLCODE = -913                                  04530002
045400                  CONTINUE                                        04540002
045500                                                                  04550002
045600             WHEN SQLWARN0 NOT = SPACES                           04560002
045700             WHEN SQLCODE < +0                                    04570002
045800             WHEN SQLCODE > +0                                    04580002
045900                  MOVE '1120-GET-VENDOR-DEPT'                     04590002
046000                                  TO DP013-PARAGRAPH              04600002
046100                  MOVE 'UNSUCCESSFUL SELECT VENDOR DEPT'          04610002
046200                                  TO DP013-MESSAGE-TEXT (1)       04620002
046300                  MOVE SQLCA      TO DP013-SQLCA                  04630002
046400                  MOVE 'TVNDDPT ' TO DP013-DB2-TABLE-NAME (1)     04640002
046500                  SET DP013-DB2-ABEND                             04650002
046600                      DP013-XCTL-DISPLAY-RESTART                  04660002
046700                                  TO TRUE                         04670002
046800                  PERFORM DP013-0000-PROCESS-ABEND                04680002
046900         END-EVALUATE                                             04690002
047000     END-PERFORM.                                                 04700002
047100                                                                  04710002
047200     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        04720002
047300         MOVE '1120-GET-VENDOR-DEPT' TO DP013-PARAGRAPH           04730002
047400         MOVE 'MAX RETRIES EXCEEDED ON SELECT VENDOR DEPT'        04740002
047500                                  TO DP013-MESSAGE-TEXT (1)       04750002
047600         MOVE SQLCA               TO DP013-SQLCA                  04760002
047700         MOVE 'TVNDDPT '          TO DP013-DB2-TABLE-NAME (1)     04770002
047800         SET DP013-DB2-ABEND                                      04780002
047900             DP013-XCTL-DISPLAY-RESTART                           04790002
048000                                  TO TRUE                         04800002
048100         PERFORM DP013-0000-PROCESS-ABEND                         04810002
048200     END-IF.                                                      04820002
048300/                                                                 04830002
048400*----------------------------------------------------------------*04840002
048500*    DO ANY PROCESSING FOR KEYS FOR WHICH NO EDITTING OF THE DATA*04850002
048600*    ON THE SCREEN NEEDS TO BE DONE.  IF ONE OF THOSE KEYS IS NOT*04860002
048700*    USED, EDIT THE DATA ON THE SCREEN AND GO ON TO CHECK THE    *04870002
048800*    REST OF THE FUNCTION KEYS.  NOTE THAT WITH THE API, NO      *04880002
048900*    INVALID FUNCTION KEYS CAN GET THIS FAR.                     *04890002
049000*----------------------------------------------------------------*04900002
049100                                                                  04910002
049200 2000-PROCESS-PANEL.                                              04920002
049300                                                                  04930002
049400     EVALUATE TRUE                                                04940002
049500                                                                  04950002
049600         WHEN DP020-SRC-AID = DP016-CLEAR                         04960002
049700             PERFORM 3000-EDIT-DATA-IN-COMMAREA                   04970002
049800                                                                  04980002
049900         WHEN DP020-FK-REFRESH(DP020-SRC-AID)                     04990002
050000             PERFORM 4000-BUILD-INITIAL-PANEL                     05000002
050100             PERFORM 3200-RESET-ATTRIBUTES                        05010002
050200             MOVE ASC-MANUAL-RECON-IND                            05020002
050300                           TO ASC-MANUAL-RECON-IND-OLD            05030002
050400             PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                 05040002
050500                                                                  05050002
050600         WHEN OTHER                                               05060002
050700             PERFORM 2200-MOVE-SCREEN-TO-COMMAREA                 05070002
050800             PERFORM 3000-EDIT-DATA-IN-COMMAREA                   05080002
050900             IF  PS-NO-ERROR                                      05090002
051000                 SET DP030-CONTINUE-GO                            05100002
051100                                   TO TRUE                        05110002
051200                 PERFORM 2100-CHECK-FUNCTION-KEY                  05120002
051300             ELSE                                                 05130002
051400                 SET DP030-OVERRIDE-GO                            05140002
051500                                   TO TRUE                        05150002
051600             END-IF                                               05160002
051700     END-EVALUATE.                                                05170002
051800                                                                  05180002
051900/                                                                 05190002
052000*----------------------------------------------------------------*05200002
052100*    ACT ON ANY FUNCTION KEYS THAT REQUIRE EDITS TO BE PASSED    *05210002
052200*    FIRST.  NOTE THAT INVALID FUNCTION KEYS WILL NOT BE RETURNED*05220002
052300*    FROM THE CICS ARCHITECTURE API.                             *05230002
052400*----------------------------------------------------------------*05240002
052500                                                                  05250002
052600 2100-CHECK-FUNCTION-KEY.                                         05260002
052700                                                                  05270002
052800     EVALUATE TRUE                                                05280002
052900         WHEN DP020-SRC-AID = DP016-ENTER                         05290002
053000             CONTINUE                                             05300002
053100                                                                  05310002
053200*   FOR AN INSERT                                                 05320002
053300         WHEN DP020-FK-LOCAL-FUNC-01(DP020-SRC-AID)               05330002
053400             SET DP030-CONTINUE-GO TO TRUE                        05340002
053500             SET PS-NOT-FOUND TO TRUE                             05350002
053600             PERFORM 4020-RETRIEVE-VNDAGR                         05360002
053700             IF PS-FOUND                                          05370002
053800*-- ALREADY EXISTS --                                             05380002
053900                 MOVE PC-TSYMSG-01098 TO DP020-MSG-NUMBER         05390002
054000                 SET DP020-MSG-FATAL  TO TRUE                     05400002
054100             ELSE                                                 05410002
054200                 PERFORM 5000-INSERT-PROCESSING                   05420002
054300*-- ADD SUCCESSFUL --                                             05430002
054400                 MOVE PC-TSYMSG-00034  TO DP020-MSG-NUMBER        05440002
054500                 SET DP020-MSG-INFORMATIONAL TO TRUE              05450002
054600             END-IF                                               05460002
054700                                                                  05470002
054800*   FOR AN UPDATE                                                 05480002
054900         WHEN DP020-FK-LOCAL-FUNC-02(DP020-SRC-AID)               05490002
055000             SET DP030-CONTINUE-GO TO TRUE                        05500002
055100             SET PS-NOT-FOUND TO TRUE                             05510002
055200             PERFORM 4020-RETRIEVE-VNDAGR                         05520002
055300             IF PS-FOUND                                          05530002
055400                 IF  ASC-MANUAL-RECON-IND                         05540002
055500                                = ASC-MANUAL-RECON-IND-OLD        05550002
055600*-- ALREADY EXISTS --                                             05560002
055700                     MOVE PC-TSYMSG-01098 TO DP020-MSG-NUMBER     05570002
055800                     SET DP020-MSG-FATAL  TO TRUE                 05580002
055900                 ELSE                                             05590002
056000                     PERFORM 5100-UPDATE-PROCESSING               05600002
056100*-- UPDATE SUCCESSFUL --                                          05610002
056200                     MOVE PC-TSYMSG-00059  TO DP020-MSG-NUMBER    05620002
056300                     SET DP020-MSG-INFORMATIONAL TO TRUE          05630002
056400                 END-IF                                           05640002
056500             ELSE                                                 05650002
056600                 IF  ASC-MANUAL-RECON-IND = 'Y'                   05660002
056700                     PERFORM 5000-INSERT-PROCESSING               05670002
056800*-- ADD SUCCESSFUL --                                             05680002
056900                     MOVE PC-TSYMSG-00034  TO DP020-MSG-NUMBER    05690002
057000                     SET DP020-MSG-INFORMATIONAL TO TRUE          05700002
057100                 ELSE                                             05710002
057200*-- DOES NOT EXIST --                                             05720002
057300                     MOVE PC-TSYMSG-01099  TO DP020-MSG-NUMBER    05730002
057400                     SET DP020-MSG-INFORMATIONAL TO TRUE          05740002
057500                 END-IF                                           05750002
057600             END-IF                                               05760002
057700                                                                  05770002
057800         WHEN OTHER                                               05780002
057900             SET DP013-NO-ROLLBACK                                05790002
058000                 DP013-XCTL-DISPLAY-RESTART                       05800002
058100                 DP013-CICS-ABEND  TO TRUE                        05810002
058200             MOVE '2100-CHECK-FUNCTION-KEY'                       05820002
058300                                   TO DP013-PARAGRAPH             05830002
058400             MOVE 'INVALID FUNCTION KEY NOT CAPTURED BY API'      05840002
058500                                   TO DP013-MESSAGE-TEXT (1)      05850002
058600             PERFORM DP013-0000-PROCESS-ABEND                     05860002
058700     END-EVALUATE.                                                05870002
058800                                                                  05880002
058900/                                                                 05890002
059000*----------------------------------------------------------------*05900002
059100*  MOVE ALL OF THE FIELDS THAT WERE ENTERED / CHANGED ON THE     *05910002
059200*  SCREEN INTO THE COMMAREA.  ALL EDITTING IS DONE IN THE COMM.  *05920002
059300*----------------------------------------------------------------*05930002
059400 2200-MOVE-SCREEN-TO-COMMAREA.                                    05940002
059500                                                                  05950002
059600     IF  AMNRCSWL > ZERO                                          05960002
059700         MOVE AMNRCSWI             TO ASC-MANUAL-RECON-IND        05970002
059800     ELSE                                                         05980002
059900         IF  AMNRCSWF = DP015-ERASE-EOF                           05990002
060000             MOVE SPACES           TO ASC-MANUAL-RECON-IND        06000002
060100         END-IF                                                   06010002
060200     END-IF.                                                      06020002
060300                                                                  06030002
060400     MOVE ASC-KEY-DUN-NBR          TO DK-DUN-NBR.                 06040002
060500     MOVE ASC-KEY-DEPT             TO DK-DEPT-NBR.                06050002
060600     MOVE ASC-KEY-ENT-ID           TO DK-ENT-ID.                  06060002
060700                                                                  06070002
060800*----------------------------------------------------------------*06080002
060900*  EDIT ALL OF THE DATA ON THE SCREEN AS IT RESIDES IN THE       *06090002
061000*  COMMAREA (EDITTING IS NOT DONE AGAINST THE SCREEN DIRECTLY).  *06100002
061100*----------------------------------------------------------------*06110002
061200 3000-EDIT-DATA-IN-COMMAREA.                                      06120002
061300                                                                  06130002
061400     PERFORM 3200-RESET-ATTRIBUTES.                               06140002
061500                                                                  06150002
061600     IF  ASC-MANUAL-RECON-IND = 'Y' OR 'N'                        06160002
061700         CONTINUE                                                 06170002
061800     ELSE                                                         06180002
061900         SET PS-ERROR              TO TRUE                        06190002
062000         SET DP020-MSG-FATAL       TO TRUE                        06200002
062100         MOVE PC-TSYMSG-00005      TO DP020-MSG-NUMBER            06210002
062200         MOVE DP015-UNP-ALP-BRT-OFF                               06220002
062300                                   TO AMNRCSWA                    06230002
062400         MOVE DP015-RED            TO AMNRCSWC                    06240002
062500         MOVE DP015-REVERSE        TO AMNRCSWH                    06250002
062600         MOVE -1                   TO AMNRCSWL                    06260002
062700         SET DP030-SET-CURSOR-APPL-1                              06270002
062800                                   TO TRUE                        06280002
062900     END-IF.                                                      06290002
063000/                                                                 06300002
063100*----------------------------------------------------------------*06310002
063200*  RESET THE ATTRIBUTES OF ALL ENTERABLE FIELDS ON THE MAP.      *06320002
063300*----------------------------------------------------------------*06330002
063400                                                                  06340002
063500 3200-RESET-ATTRIBUTES.                                           06350002
063600                                                                  06360002
063700     MOVE DP015-UNP-ALP-NOR-OFF TO AMNRCSWC.                      06370002
063800                                                                  06380002
063900     MOVE DP015-GREEN           TO AMNRCSWC.                      06390002
064000                                                                  06400002
064100     MOVE DP015-UNDERLINE       TO AMNRCSWH.                      06410002
064200                                                                  06420002
064300/                                                                 06430002
064400 4000-BUILD-INITIAL-PANEL.                                        06440002
064500                                                                  06450002
064600     INITIALIZE ASC-SCREEN-FIELDS                                 06460002
064700                DCLTVNDAGR                                        06470002
064800                DCLTENTNME                                        06480002
064900                DK-DB2-KEYS.                                      06490002
065000                                                                  06500002
065100     MOVE '/'                        TO ASC-DISPLAY-START-S1      06510002
065200                                        ASC-DISPLAY-START-S2      06520002
065300                                        ASC-DISPLAY-END-S1        06530002
065400                                        ASC-DISPLAY-END-S2.       06540002
065500                                                                  06550002
065600     EXEC SQL                                                     06560002
065700         SET :ASC-DB2-DATE  = CURRENT DATE                        06570002
065800     END-EXEC.                                                    06580002
065900                                                                  06590002
066000     MOVE -1                         TO AMNRCSWL.                 06600002
066100     SET PS-NO-ERROR                 TO TRUE.                     06610002
066200     SET DP030-SET-CURSOR-APPL-1     TO TRUE.                     06620002
066300                                                                  06630002
066400     MOVE ASC-KEY-DUN-NBR            TO DK-DUN-NBR.               06640002
066500     MOVE ASC-KEY-DEPT               TO DK-DEPT-NBR.              06650002
066600     MOVE ASC-KEY-ENT-ID             TO DK-ENT-ID.                06660002
066700                                                                  06670002
066800     PERFORM 4010-GET-VENDOR-NAME.                                06680002
066900     MOVE ENTNME-ENT-NAME-DESC       TO ASC-ENT-NAME-DESC.        06690002
067000                                                                  06700002
067100     SET PS-NOT-FOUND TO TRUE.                                    06710002
067200     PERFORM 4020-RETRIEVE-VNDAGR.                                06720002
067300     IF PS-FOUND                                                  06730002
067400         IF  ASC-DB2-CURRENT-DATE >= VNDAGR-EFFECTIVE-DATE        06740002
067500         AND ASC-DB2-CURRENT-DATE <  VNDAGR-EXPIRATION-DATE       06750002
067600             MOVE 'Y'                TO ASC-MANUAL-RECON-IND      06760002
067700         ELSE                                                     06770002
067800             MOVE 'N'                TO ASC-MANUAL-RECON-IND      06780002
067900         END-IF                                                   06790002
068000         MOVE VNDAGR-EFFECTIVE-DATE  TO PV-DB2-DATE               06800002
068100         MOVE PV-DB2-MO              TO ASC-DISPLAY-START-MO      06810002
068200         MOVE PV-DB2-DA              TO ASC-DISPLAY-START-DA      06820002
068300         MOVE PV-DB2-CY-YR           TO ASC-DISPLAY-START-CY-YR   06830002
068400         MOVE ASC-DISPLAY-START-DATE TO ASC-START-DATE            06840002
068500         MOVE VNDAGR-EXPIRATION-DATE TO PV-DB2-DATE               06850002
068600         MOVE PV-DB2-MO              TO ASC-DISPLAY-END-MO        06860002
068700         MOVE PV-DB2-DA              TO ASC-DISPLAY-END-DA        06870002
068800         MOVE PV-DB2-CY-YR           TO ASC-DISPLAY-END-CY-YR     06880002
068900         MOVE ASC-DISPLAY-END-DATE   TO ASC-END-DATE              06890002
069000     ELSE                                                         06900002
069100         MOVE 'Y'                    TO ASC-MANUAL-RECON-IND      06910002
069200         MOVE ASC-DB2-CURRENT-DATE   TO PV-DB2-DATE               06920002
069300         MOVE PV-DB2-MO              TO ASC-DISPLAY-START-MO      06930002
069400         MOVE PV-DB2-DA              TO ASC-DISPLAY-START-DA      06940002
069500         MOVE PV-DB2-CY-YR           TO ASC-DISPLAY-START-CY-YR   06950002
069600         MOVE ASC-DISPLAY-START-DATE TO ASC-START-DATE            06960002
069700         MOVE PV-DB2-EXPIR-MO        TO ASC-DISPLAY-END-MO        06970002
069800         MOVE PV-DB2-EXPIR-DA        TO ASC-DISPLAY-END-DA        06980002
069900         MOVE PV-DB2-EXPIR-CY-YR     TO ASC-DISPLAY-END-CY-YR     06990002
070000         MOVE ASC-DISPLAY-END-DATE   TO ASC-END-DATE              07000002
070100     END-IF.                                                      07010002
070200                                                                  07020002
070300/                                                                 07030002
070400*----------------------------------------------------------------*07040002
070500*    GET THE VENDOR NAME                                         *07050002
070600*----------------------------------------------------------------*07060002
070700 4010-GET-VENDOR-NAME.                                            07070002
070800                                                                  07080002
070900     PERFORM                                                      07090002
071000         WITH TEST AFTER                                          07100002
071100         VARYING PV-RETRY-COUNTER                                 07110002
071200         FROM 1 BY 1                                              07120002
071300         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               07130002
071400             OR (SQLCODE = +0)                                    07140002
071500             OR (SQLCODE = +100))                                 07150002
071600                                                                  07160002
071700         EXEC SQL                                                 07170002
071800              SELECT ENT_NAME_DESC                                07180002
071900                INTO :ENTNME-ENT-NAME-DESC                        07190002
072000                FROM TENTNME                                      07200002
072100               WHERE ENT_ID     = :DK-ENT-ID                      07210002
072200                 AND TYPE_CDE   = '01'                            07220002
072300         END-EXEC                                                 07230002
072400                                                                  07240002
072500         EVALUATE TRUE                                            07250002
072600             WHEN SQLCODE = +0                                    07260002
072700                  CONTINUE                                        07270002
072800                                                                  07280002
072900             WHEN SQLCODE = +100                                  07290002
073000                  MOVE 'VENDOR NAME NOT FOUND'                    07300002
073100                                        TO ENTNME-ENT-NAME-DESC   07310002
073200             WHEN SQLCODE = -904                                  07320002
073300             WHEN SQLCODE = -913                                  07330002
073400                  CONTINUE                                        07340002
073500                                                                  07350002
073600             WHEN SQLWARN0 NOT = SPACES                           07360002
073700             WHEN SQLCODE < +0                                    07370002
073800             WHEN SQLCODE > +0                                    07380002
073900                  MOVE '4010-GET-VENDOR-NAME'                     07390002
074000                                  TO DP013-PARAGRAPH              07400002
074100                  MOVE 'UNSUCCESSFUL SELECT ENTERPRISE NAME'      07410002
074200                                  TO DP013-MESSAGE-TEXT (1)       07420002
074300                  MOVE SQLCA      TO DP013-SQLCA                  07430002
074400                  MOVE 'TENTNME ' TO DP013-DB2-TABLE-NAME (1)     07440002
074500                  SET DP013-DB2-ABEND                             07450002
074600                      DP013-XCTL-DISPLAY-RESTART                  07460002
074700                                  TO TRUE                         07470002
074800                  PERFORM DP013-0000-PROCESS-ABEND                07480002
074900         END-EVALUATE                                             07490002
075000     END-PERFORM.                                                 07500002
075100                                                                  07510002
075200     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        07520002
075300         MOVE '4010-GET-VENDOR-NAME'                              07530002
075400                                  TO DP013-PARAGRAPH              07540002
075500         MOVE 'MAX RETRIES EXCEEDED ON SELECT ENTERPRISE NAME'    07550002
075600                                  TO DP013-MESSAGE-TEXT (1)       07560002
075700         MOVE SQLCA               TO DP013-SQLCA                  07570002
075800         MOVE 'TENTNME '          TO DP013-DB2-TABLE-NAME (1)     07580002
075900         SET DP013-DB2-ABEND                                      07590002
076000             DP013-XCTL-DISPLAY-RESTART                           07600002
076100                                  TO TRUE                         07610002
076200         PERFORM DP013-0000-PROCESS-ABEND                         07620002
076300     END-IF.                                                      07630002
076400                                                                  07640002
076500/                                                                 07650002
076600*----------------------------------------------------------------*07660002
076700*    GET THE VENDOR AGREEMENT ROW IF IT EXITSTS.                 *07670002
076800*----------------------------------------------------------------*07680002
076900 4020-RETRIEVE-VNDAGR.                                            07690002
077000                                                                  07700002
077100     PERFORM                                                      07710002
077200         WITH TEST AFTER                                          07720002
077300         VARYING PV-RETRY-COUNTER                                 07730002
077400         FROM 1 BY 1                                              07740002
077500         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               07750002
077600             OR (SQLCODE = +0)                                    07760002
077700             OR (SQLCODE = +100))                                 07770002
077800                                                                  07780002
077900         EXEC SQL                                                 07790002
078000              SELECT                                              07800002
078100                     EFFECTIVE_DATE                               07810002
078200                    ,EXPIRATION_DATE                              07820002
078300                INTO                                              07830002
078400                     :VNDAGR-EFFECTIVE-DATE                       07840002
078500                    ,:VNDAGR-EXPIRATION-DATE                      07850002
078600                FROM                                              07860002
078700                     TVNDAGR                                      07870002
078800               WHERE DEPT_NBR      = :DK-DEPT-NBR                 07880002
078900                 AND ENT_ID        = :DK-ENT-ID                   07890002
079000                 AND AGRMT_TYP_ID  = '6'                          07900002
079100                 AND TYP_CDE       = 4                            07910002
079200         END-EXEC                                                 07920002
079300                                                                  07930002
079400         EVALUATE TRUE                                            07940002
079500             WHEN SQLCODE = +0                                    07950002
079600                  SET PS-FOUND TO TRUE                            07960002
079700                                                                  07970002
079800             WHEN SQLCODE = +100                                  07980002
079900             WHEN SQLCODE = -904                                  07990002
080000             WHEN SQLCODE = -913                                  08000002
080100                  CONTINUE                                        08010002
080200                                                                  08020002
080300             WHEN SQLWARN0 NOT = SPACES                           08030002
080400             WHEN SQLCODE < +0                                    08040002
080500             WHEN SQLCODE > +0                                    08050002
080600                  MOVE '4020-RETRIEVE-VNDAGR'                     08060002
080700                                  TO DP013-PARAGRAPH              08070002
080800                  MOVE 'UNSUCCESSFUL SELECT VENDOR AGREEMENT'     08080002
080900                                  TO DP013-MESSAGE-TEXT (1)       08090002
081000                  MOVE SQLCA      TO DP013-SQLCA                  08100002
081100                  MOVE 'TVNDAGR ' TO DP013-DB2-TABLE-NAME (1)     08110002
081200                  SET DP013-DB2-ABEND                             08120002
081300                      DP013-XCTL-DISPLAY-RESTART                  08130002
081400                                  TO TRUE                         08140002
081500                  PERFORM DP013-0000-PROCESS-ABEND                08150002
081600         END-EVALUATE                                             08160002
081700     END-PERFORM.                                                 08170002
081800                                                                  08180002
081900     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        08190002
082000         MOVE '4020-RETRIEVE-VNDAGR'                              08200002
082100                                  TO DP013-PARAGRAPH              08210002
082200         MOVE 'MAX RETRIES EXCEEDED ON SELECT ENTERPRISE NAME'    08220002
082300                                  TO DP013-MESSAGE-TEXT (1)       08230002
082400         MOVE SQLCA               TO DP013-SQLCA                  08240002
082500         MOVE 'TVNDAGR '          TO DP013-DB2-TABLE-NAME (1)     08250002
082600         SET DP013-DB2-ABEND                                      08260002
082700             DP013-XCTL-DISPLAY-RESTART                           08270002
082800                                  TO TRUE                         08280002
082900         PERFORM DP013-0000-PROCESS-ABEND                         08290002
083000     END-IF.                                                      08300002
083100                                                                  08310002
083200/                                                                 08320002
083300*----------------------------------------------------------------*08330002
083400*    RESTORE THE DATA ON THE SCREEN FROM THE COMMAREA.           *08340002
083500*----------------------------------------------------------------*08350002
083600 4400-MOVE-COMMAREA-TO-SCREEN.                                    08360002
083700                                                                  08370002
083800     MOVE ASC-KEY-DUN-NBR          TO AVNDNBRO.                   08380002
083900     MOVE ASC-KEY-DEPT             TO AVNDDPTO.                   08390002
084000     MOVE ASC-ENT-NAME-DESC        TO AVNDNMEO.                   08400002
084100     MOVE ASC-MANUAL-RECON-IND     TO AMNRCSWO.                   08410002
084200     MOVE ASC-START-DATE           TO ASTDTEO.                    08420002
084300     MOVE ASC-END-DATE             TO AENDDTEO.                   08430002
084400                                                                  08440002
084500                                                                  08450002
084600/                                                                 08460002
084700*----------------------------------------------------------------*08470002
084800* PERFORM INSERT LOGIC                                           *08480002
084900*----------------------------------------------------------------*08490002
085000                                                                  08500002
085100 5000-INSERT-PROCESSING.                                          08510002
085200                                                                  08520002
085300     PERFORM 5900-GET-MAX-SEQ-NBR.                                08530002
085400                                                                  08540002
085500     MOVE DK-ENT-ID              TO VNDAGR-ENT-ID.                08550002
085600     MOVE DK-DEPT-NBR            TO VNDAGR-DEPT-NBR.              08560002
085700     MOVE '6'                    TO VNDAGR-AGRMT-TYP-ID.          08570002
085800     MOVE PV-NEXT-SEQ-NBR        TO VNDAGR-SEQ-NBR.               08580002
085900     MOVE 4                      TO VNDAGR-TYP-CDE.               08590002
086000     MOVE PV-DB2-EXPIR-DATE      TO VNDAGR-EXPIRATION-DATE.       08600002
086100     MOVE +1                     TO DN-EXPIRATION-DATE.           08610002
086200     MOVE SPACE                  TO VNDAGR-PROD-STATUS-IND.       08620002
086300     MOVE +1                     TO DN-PROD-STATUS-IND.           08630002
086400                                                                  08640002
086500     PERFORM 6000-INSERT-TVNDAGR.                                 08650002
086600/                                                                 08660002
086700*----------------------------------------------------------------*08670002
086800*    PERFORM UPDATE PROCESSING                                   *08680002
086900*----------------------------------------------------------------*08690002
087000 5100-UPDATE-PROCESSING.                                          08700002
087100                                                                  08710002
087200*  IF VENDOR IS TO BE SET AS REQUIRING MANUAL RECONCILIATION      08720002
087300     IF  ASC-MANUAL-RECON-IND = 'Y'                               08730002
087400         MOVE ASC-DB2-CURRENT-DATE   TO VNDAGR-EFFECTIVE-DATE     08740002
087500         MOVE PV-DB2-EXPIR-DATE      TO VNDAGR-EXPIRATION-DATE    08750002
087600                                                                  08760002
087700     ELSE                                                         08770002
087800*  VENDOR IS TO BE SET AS AUTO-RECONCILIATION                     08780002
087900         MOVE ASC-START-DATE          TO ASC-DISPLAY-START-DATE   08790002
088000         MOVE ASC-DISPLAY-START-MO    TO PV-DB2-MO                08800002
088100         MOVE ASC-DISPLAY-START-DA    TO PV-DB2-DA                08810002
088200         MOVE ASC-DISPLAY-START-CY-YR TO PV-DB2-CY-YR             08820002
088300         MOVE PV-DB2-DATE             TO VNDAGR-EFFECTIVE-DATE    08830002
088400         MOVE ASC-DB2-CURRENT-DATE    TO VNDAGR-EXPIRATION-DATE   08840002
088500     END-IF.                                                      08850002
088600                                                                  08860002
088700     PERFORM 6100-UPDATE-TVNDAGR.                                 08870002
088800                                                                  08880002
088900     MOVE ASC-MANUAL-RECON-IND     TO ASC-MANUAL-RECON-IND-OLD.   08890002
089000/                                                                 08900002
089100*----------------------------------------------------------------*08910002
089200*    FIND THE ROW WITH THE HIGHEST SEQUENCE NUMBER               *08920002
089300*----------------------------------------------------------------*08930002
089400                                                                  08940002
089500 5900-GET-MAX-SEQ-NBR.                                            08950002
089600                                                                  08960002
089700     PERFORM                                                      08970002
089800         WITH TEST AFTER                                          08980002
089900         VARYING PV-RETRY-COUNTER                                 08990002
090000         FROM 1 BY 1                                              09000002
090100         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               09010002
090200             OR (SQLCODE = +0)                                    09020002
090300             OR (SQLCODE = -305))                                 09030002
090400                                                                  09040002
090500         EXEC SQL                                                 09050002
090600              SELECT MAX(SEQ_NBR)                                 09060002
090700                INTO :PV-MAX-SEQ-NBR                              09070002
090800                FROM TVNDAGR                                      09080002
090900               WHERE DEPT_NBR          = :DK-DEPT-NBR             09090002
091000                 AND ENT_ID            = :DK-ENT-ID               09100002
091100                 AND AGRMT_TYP_ID      = '6'                      09110002
091200         END-EXEC                                                 09120002
091300                                                                  09130002
091400         EVALUATE TRUE                                            09140002
091500             WHEN SQLCODE = +0                                    09150002
091600                  COMPUTE PV-NEXT-SEQ-NBR =                       09160002
091700                          PV-MAX-SEQ-NBR + 1                      09170002
091800             WHEN SQLCODE = -305                                  09180002
091900                  MOVE +1         TO PV-NEXT-SEQ-NBR              09190002
092000                                                                  09200002
092100             WHEN SQLCODE = -904                                  09210002
092200             WHEN SQLCODE = -913                                  09220002
092300                  CONTINUE                                        09230002
092400                                                                  09240002
092500             WHEN SQLWARN0 NOT = SPACES                           09250002
092600             WHEN SQLCODE < +0                                    09260002
092700             WHEN SQLCODE > +0                                    09270002
092800                  MOVE '5900-GET-MAX-SEQ-NBR'                     09280002
092900                                  TO DP013-PARAGRAPH              09290002
093000                  MOVE 'UNSUCCESSFUL SELECT MAX SEQ NBR'          09300002
093100                                  TO DP013-MESSAGE-TEXT (1)       09310002
093200                  MOVE SQLCA      TO DP013-SQLCA                  09320002
093300                  MOVE 'TVNDAGR ' TO DP013-DB2-TABLE-NAME (1)     09330002
093400                  SET DP013-DB2-ABEND                             09340002
093500                      DP013-XCTL-DISPLAY-RESTART                  09350002
093600                                  TO TRUE                         09360002
093700                  PERFORM DP013-0000-PROCESS-ABEND                09370002
093800         END-EVALUATE                                             09380002
093900     END-PERFORM.                                                 09390002
094000                                                                  09400002
094100     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        09410002
094200         MOVE '5900-GET-MAX-SEQ-NBR'                              09420002
094300                                  TO DP013-PARAGRAPH              09430002
094400         MOVE 'MAX RETRIES EXCEEDED ON SELECT MAX SEQ NBR'        09440002
094500                                  TO DP013-MESSAGE-TEXT (1)       09450002
094600         MOVE SQLCA               TO DP013-SQLCA                  09460002
094700         MOVE 'TVNDAGR '          TO DP013-DB2-TABLE-NAME (1)     09470002
094800         SET DP013-DB2-ABEND                                      09480002
094900             DP013-XCTL-DISPLAY-RESTART                           09490002
095000                                  TO TRUE                         09500002
095100         PERFORM DP013-0000-PROCESS-ABEND                         09510002
095200     END-IF.                                                      09520002
095300/                                                                 09530002
095400*----------------------------------------------------------------*09540002
095500*    INSERT A SERVICE OR PROGRAM ROW                             *09550002
095600*----------------------------------------------------------------*09560002
095700                                                                  09570002
095800 6000-INSERT-TVNDAGR.                                             09580002
095900                                                                  09590002
096000     PERFORM                                                      09600002
096100         WITH TEST AFTER                                          09610002
096200         VARYING PV-RETRY-COUNTER                                 09620002
096300         FROM 1 BY 1                                              09630002
096400         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               09640002
096500             OR (SQLCODE = +0))                                   09650002
096600                                                                  09660002
096700         EXEC SQL                                                 09670002
096800              INSERT INTO TVNDAGR                                 09680002
096900                     ( ENT_ID                                     09690002
097000                      ,DEPT_NBR                                   09700002
097100                      ,AGRMT_TYP_ID                               09710002
097200                      ,SEQ_NBR                                    09720002
097300                      ,TYP_CDE                                    09730002
097400                      ,EFFECTIVE_DATE                             09740002
097500                      ,EXPIRATION_DATE                            09750002
097600                      ,PROD_STATUS_IND                            09760002
097700                      ,LAST_UPD_TMST                              09770002
097800                      ,LAST_UPD_ID )                              09780002
097900              VALUES ( :DK-ENT-ID                                 09790002
098000                      ,:DK-DEPT-NBR                               09800002
098100                      ,:VNDAGR-AGRMT-TYP-ID                       09810002
098200                      ,:VNDAGR-SEQ-NBR                            09820002
098300                      ,:VNDAGR-TYP-CDE                            09830002
098400                      , CURRENT DATE                              09840002
098500                      ,:VNDAGR-EXPIRATION-DATE                    09850002
098600                         :DN-EXPIRATION-DATE                      09860002
098700                      ,:VNDAGR-PROD-STATUS-IND                    09870002
098800                         :DN-PROD-STATUS-IND                      09880002
098900                      , CURRENT TIMESTAMP                         09890002
099000                      ,:DP020-USERID )                            09900002
099100         END-EXEC                                                 09910002
099200                                                                  09920002
099300         EVALUATE TRUE                                            09930002
099400             WHEN SQLCODE = +0                                    09940002
099500             WHEN SQLCODE = -904                                  09950002
099600             WHEN SQLCODE = -913                                  09960002
099700                  CONTINUE                                        09970002
099800                                                                  09980002
099900             WHEN SQLWARN0 NOT = SPACES                           09990002
100000             WHEN SQLCODE < +0                                    10000002
100100             WHEN SQLCODE > +0                                    10010002
100200                  MOVE '6000-INSERT-TVNDAGR'                      10020002
100300                                  TO DP013-PARAGRAPH              10030002
100400                  MOVE 'UNSUCCESSFUL INSERT FOR TVNDAGR'          10040002
100500                                  TO DP013-MESSAGE-TEXT (1)       10050002
100600                  MOVE SQLCA      TO DP013-SQLCA                  10060002
100700                  MOVE 'TVNDAGR ' TO DP013-DB2-TABLE-NAME (1)     10070002
100800                  SET DP013-DB2-ABEND                             10080002
100900                      DP013-XCTL-DISPLAY-RESTART                  10090002
101000                                  TO TRUE                         10100002
101100                  PERFORM DP013-0000-PROCESS-ABEND                10110002
101200         END-EVALUATE                                             10120002
101300     END-PERFORM.                                                 10130002
101400                                                                  10140002
101500     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        10150002
101600         MOVE '6000-INSERT-TVNDAGR'                               10160002
101700                                  TO DP013-PARAGRAPH              10170002
101800         MOVE 'MAX RETRIES EXCEEDED FOR INSERT ON TVNDAGR'        10180002
101900                                  TO DP013-MESSAGE-TEXT (1)       10190002
102000         MOVE SQLCA               TO DP013-SQLCA                  10200002
102100         MOVE 'TVNDAGR '          TO DP013-DB2-TABLE-NAME (1)     10210002
102200         SET DP013-DB2-ABEND                                      10220002
102300             DP013-XCTL-DISPLAY-RESTART                           10230002
102400                                  TO TRUE                         10240002
102500         PERFORM DP013-0000-PROCESS-ABEND                         10250002
102600     END-IF.                                                      10260002
102700/                                                                 10270002
102800*----------------------------------------------------------------*10280002
102900* PERFORM UPDATE LOGIC                                           *10290002
103000*----------------------------------------------------------------*10300002
103100                                                                  10310002
103200 6100-UPDATE-TVNDAGR.                                             10320002
103300                                                                  10330002
103400     PERFORM                                                      10340002
103500         WITH TEST AFTER                                          10350002
103600         VARYING PV-RETRY-COUNTER                                 10360002
103700         FROM 1 BY 1                                              10370002
103800         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               10380002
103900             OR (SQLCODE = +0))                                   10390002
104000                                                                  10400002
104100         EXEC SQL                                                 10410002
104200              UPDATE TVNDAGR                                      10420002
104300                 SET EFFECTIVE_DATE  = :VNDAGR-EFFECTIVE-DATE     10430002
104400                    ,EXPIRATION_DATE = :VNDAGR-EXPIRATION-DATE    10440002
104500                    ,LAST_UPD_ID     = :DP020-USERID              10450002
104600                    ,LAST_UPD_TMST   = CURRENT TIMESTAMP          10460002
104700               WHERE DEPT_NBR        = :DK-DEPT-NBR               10470002
104800                 AND ENT_ID          = :DK-ENT-ID                 10480002
104900                 AND AGRMT_TYP_ID    = '6'                        10490002
105000                 AND TYP_CDE         = 4                          10500002
105100         END-EXEC                                                 10510002
105200                                                                  10520002
105300         EVALUATE TRUE                                            10530002
105400             WHEN SQLCODE = +0                                    10540002
105500             WHEN SQLCODE = -904                                  10550002
105600             WHEN SQLCODE = -913                                  10560002
105700                  CONTINUE                                        10570002
105800                                                                  10580002
105900             WHEN SQLWARN0 NOT = SPACES                           10590002
106000             WHEN SQLCODE < +0                                    10600002
106100             WHEN SQLCODE > +0                                    10610002
106200                  MOVE '6100-UPDATE-TVNDAGR'                      10620002
106300                                  TO DP013-PARAGRAPH              10630002
106400                  MOVE 'UNSUCCESSFUL UPDATE ON TVNDAGR'           10640002
106500                                  TO DP013-MESSAGE-TEXT (1)       10650002
106600                  MOVE SQLCA      TO DP013-SQLCA                  10660002
106700                  MOVE 'TVNDAGR ' TO DP013-DB2-TABLE-NAME (1)     10670002
106800                  SET DP013-DB2-ABEND                             10680002
106900                      DP013-XCTL-DISPLAY-RESTART                  10690002
107000                                  TO TRUE                         10700002
107100                  PERFORM DP013-0000-PROCESS-ABEND                10710002
107200         END-EVALUATE                                             10720002
107300     END-PERFORM.                                                 10730002
107400                                                                  10740002
107500     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        10750002
107600         MOVE '6100-UPDATE-TVNDAGR'                               10760002
107700                                  TO DP013-PARAGRAPH              10770002
107800         MOVE 'MAX RETRIES EXCEEDED ON UPDATE TVNDAGR'            10780002
107900                                  TO DP013-MESSAGE-TEXT (1)       10790002
108000         MOVE SQLCA               TO DP013-SQLCA                  10800002
108100         MOVE 'TVNDAGR '          TO DP013-DB2-TABLE-NAME (1)     10810002
108200         SET DP013-DB2-ABEND                                      10820002
108300             DP013-XCTL-DISPLAY-RESTART                           10830002
108400                                  TO TRUE                         10840002
108500         PERFORM DP013-0000-PROCESS-ABEND                         10850002
108600     END-IF.                                                      10860002
108700/                                                                 10870002
108800*----------------------------------------------------------------*10880002
108900*    ABEND PROCESSOR MODULE                                      *10890002
109000*----------------------------------------------------------------*10900002
109100                                                                  10910002
109200     COPY DPPD013.                                                10920002
