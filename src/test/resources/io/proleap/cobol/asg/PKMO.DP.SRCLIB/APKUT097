000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.     APKUT097.                                        00020006
000300 AUTHOR.         MIKE BESKE.                                      00030000
000400 DATE-WRITTEN.   MARCH 2003.                                      00040001
000500*************************************************************     00050000
000600*    COBOL 2 WITH DB2 SQL                                   *     00060000
000700*                                                           *     00070000
000800*   SHIPMENT AND TRIP DATA EXTRACT FOR PRG AUDIT            *     00080006
000900*                                                           *     00090000
001000*   PROGRAM OVERVIEW: THIS PROGRAM EXTRACTS SHIPMENT/TRIP   *     00100006
001100*   DATA THAT GOES ALONG WITH THE RECEIVING DATA EXTRACTED  *     00110006
001200*   IN ANOTHER PROGRAM.  THIS IS A PART OF THE PROFIT       *     00120006
001300*   RECOVERY GROUP (PRG) AUDIT PROCESS.                     *     00130006
001400*                                                           *     00140006
001500*                                                           *     00150006
001600*   DB2 TABLES:                                             *     00160006
001700*  1. RECEIVER HEADER TABLE                     (TRECEIV)   *     00170006
001800*  2. SHIPMENT - PO ASSOCIATION TABLE           (TSHPTPO)   *     00180006
001900*  3. SHIPMENT TABLE                            (TSHIPMT)   *     00190006
002000*  4. TRIP TABLE                                (TVHTRIP)   *     00200006
002100*                                                           *     00210006
002200*   INPUT:                                                  *     00220006
002300*  1. PO-FILE                                   (APRD400)   *     00230006
002400*                                                           *     00240006
002500*   OUTPUT:                                                 *     00250006
002600*  1. SHIPMT-TRIP-FILE                          (APRD077)   *     00260006
002700*                                                           *     00270006
002800*************************************************************     00280006
002900*   CHANGES:                                                *     00290006
003000*                                                           *     00300006
003100* 06/17/2003  MIKE BESKE                     WR# 24481      *     00310009
003200*             ADDED 'WITH UR' TO THE 1 CURSOR TO AVOID      *     00320009
003300*             CONTENTION ABENDS.                            *     00330009
003400*                                                           *     00340009
003500*                                                           *     00350006
003600*************************************************************     00360006
003700/                                                                 00370006
003800 ENVIRONMENT DIVISION.                                            00380006
003900 CONFIGURATION SECTION.                                           00390006
004000 INPUT-OUTPUT SECTION.                                            00400006
004100 FILE-CONTROL.                                                    00410006
004200                                                                  00420006
004300     SELECT PO-FILE              ASSIGN TO UT-S-INP01.            00430006
004400     SELECT SHIPMT-TRIP-FILE     ASSIGN TO UT-S-OUT01.            00440006
004500                                                                  00450006
004600 DATA DIVISION.                                                   00460006
004700 FILE SECTION.                                                    00470006
004800 FD  PO-FILE                                                      00480006
004900     RECORDING MODE IS F                                          00490006
005000     LABEL RECORDS ARE STANDARD                                   00500006
005100     BLOCK CONTAINS 0 RECORDS                                     00510006
005200     DATA RECORD IS PO-PRCDTE-RECORD.                             00520006
005300 01  PO-PRCDTE-RECORD            PIC X(800).                      00530006
005400                                                                  00540006
005500 FD  SHIPMT-TRIP-FILE                                             00550006
005600     RECORDING MODE IS F                                          00560006
005700     LABEL RECORDS ARE STANDARD                                   00570006
005800     BLOCK CONTAINS 0 RECORDS                                     00580006
005900     DATA RECORD IS SHIPMT-TRIP-RECORD.                           00590006
006000 01  SHIPMT-TRIP-RECORD          PIC X(104).                      00600006
006100                                                                  00610006
006200 WORKING-STORAGE SECTION.                                         00620006
006300                                                                  00630006
006400 01  PROGRAM-WORKAREA.                                            00640006
006500     05  FILLER                  PIC  X(30)           VALUE       00650006
006600         '** BEGINING OF APKUT097 W/S **'.                        00660006
006700                                                                  00670006
006800     05  PV-CURRENT-PARAGRAPH    PIC  X(30)           VALUE SPACE.00680006
006900     05  PV-PROGRAM-NAME         PIC  X(08)           VALUE       00690006
007000         'APKUT097'.                                              00700006
007100     05  PV-MAX-RETRIES          PIC S9(04)    COMP   VALUE +3.   00710006
007200     05  PV-RETRY-COUNTER        PIC S9(04)    COMP   VALUE +0.   00720006
007300     05  INPUT-COUNT             PIC 9(09)            VALUE  0.   00730006
007400     05  OUTPUT-COUNT            PIC 9(09)            VALUE  0.   00740006
007500                                                                  00750006
007600     05  PV-PO-NBR               PIC S9(9)            VALUE ZEROS 00760006
007700                                                       COMP.      00770006
007800     05  PV-PO-NBR-UNPK          PIC S9(9)            VALUE ZEROS.00780006
007900     05  PV-PO-NBR-9             PIC  9(9)            VALUE ZEROS.00790006
008000                                                                  00800006
008100     05  PV-CURRENT-TIME.                                         00810006
008200         10  PV-CURRENT-HOUR     PIC  9(02)           VALUE 0.    00820006
008300         10  PV-CURRENT-MINUTE   PIC  9(02)           VALUE 0.    00830006
008400         10  FILLER              PIC  9(02)           VALUE 0.    00840006
008500                                                                  00850006
008600 01  PROGRAM-SWITCHES-SUBS.                                       00860006
008700     05  PV-EOF-SW               PIC  X(01)           VALUE 'N'.  00870006
008800         88  EOF                 VALUE 'Y'.                       00880006
008900     05  PS-MULT-SHIP-SW         PIC X(01)            VALUE 'N'.  00890006
009000         88  PS-MULT-SHIP        VALUE 'Y'.                       00900006
009100     05  PS-OUT-OF-RCVR-SW       PIC X(01)            VALUE 'M'.  00910006
009200         88  OUT-OF-RCVR         VALUE 'O'.                       00920006
009300         88  MORE-RCVR           VALUE 'M'.                       00930006
009400                                                                  00940006
009500*  INPUT RECORD AREA                                              00950006
009600                                                                  00960006
009700     COPY APRD400.                                                00970006
009800                                                                  00980006
009900*  OUTPUT RECORD AREA                                             00990006
010000                                                                  01000006
010100     COPY APRD077.                                                01010006
010200                                                                  01020006
010300*----------------------------------------------------------------*01030006
010400*  RECEIVER HEADER TABLE                                         *01040006
010500*----------------------------------------------------------------*01050006
010600     EXEC SQL                                                     01060006
010700          INCLUDE TRECEIV                                         01070006
010800     END-EXEC.                                                    01080006
010900                                                                  01090006
011000*----------------------------------------------------------------*01100006
011100*  SHIPMENT - PO ASSOCIATION TABLE                               *01110006
011200*----------------------------------------------------------------*01120006
011300     EXEC SQL                                                     01130006
011400          INCLUDE TSHPTPO                                         01140006
011500     END-EXEC.                                                    01150006
011600                                                                  01160006
011700*----------------------------------------------------------------*01170006
011800*  SHIPMENT TABLE                                                *01180006
011900*----------------------------------------------------------------*01190006
012000     EXEC SQL                                                     01200006
012100          INCLUDE TSHIPMT                                         01210006
012200     END-EXEC.                                                    01220006
012300                                                                  01230006
012400*----------------------------------------------------------------*01240006
012500*  TRIP TABLE                                                    *01250006
012600*----------------------------------------------------------------*01260006
012700     EXEC SQL                                                     01270006
012800          INCLUDE TVHTRIP                                         01280006
012900     END-EXEC.                                                    01290006
013000                                                                  01300006
013100*                                                                 01310006
013200*    SQL COMMUNICATIONS AREA DCLGEN                               01320006
013300*                                                                 01330006
013400     EXEC SQL                                                     01340006
013500         INCLUDE SQLCA                                            01350006
013600     END-EXEC.                                                    01360006
013700                                                                  01370006
013800*----------------------------------------------------------------*01380006
013900* RECEIVER_CSR WILL FETCH THE RECEIVER SEQUENCE NUMBER FOR THE   *01390006
014000* SPECIFIED PO.                                                  *01400006
014100*----------------------------------------------------------------*01410006
014200     EXEC SQL                                                     01420006
014300       DECLARE RECEIVER_CSR CURSOR FOR                            01430006
014400         SELECT A.REC_SEQ_NBR                                     01440006
014500          FROM TRECEIV A                                          01450006
014600         WHERE A.ORD_NBR          = :PV-PO-NBR                    01460006
014700           AND A.VER_STATUS_CDE   = 'A'                           01470006
014800           AND A.STATUS_CDE       = 'VE'                          01480006
014900         ORDER BY A.REC_SEQ_NBR                                   01490006
015000         WITH UR                                                  01500009
015100     END-EXEC.                                                    01510006
015200                                                                  01520006
015300*----------------------------------------------------------------*01530006
015400*  ABEND DATA AREAS                                              *01540006
015500*----------------------------------------------------------------*01550006
015600 01  ABEND-CODE                  PIC S9(04)  VALUE ZEROS          01560006
015700                                             COMP SYNC.           01570006
015800     88  AC-BAD-DATA                         VALUE +4003.         01580006
015900     88  AC-DB2-ERROR                        VALUE +4013.         01590006
016000     88  AC-DATE-ERROR                       VALUE +4019.         01600006
016100                                                                  01610006
016200                                                                  01620006
016300 01  ABEND-AREAS.                                                 01630006
016400     05  AA-ABEND-LIT            PIC  X(40)  VALUE                01640006
016500             '*****       ABEND'.                                 01650006
016600     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                01660006
016700             '*****   PROGRAM: APKUT097'.                         01670006
016800     05  AA-PARAGRAPH-LIT.                                        01680006
016900         10  FILLER              PIC  X(17)  VALUE                01690006
017000             '***** PARAGRAPH: '.                                 01700006
017100         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        01710006
017200     05  AA-MESSAGE-LINE.                                         01720006
017300         10  FILLER              PIC  X(06)  VALUE '*****'.       01730006
017400         10  AA-MESSAGE          PIC  X(127) VALUE SPACES.        01740006
017500     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                01750006
017600             '*****    DB2 ERROR'.                                01760006
017700     05  AA-DB2-OPERATION-LIT.                                    01770006
017800         10  FILLER              PIC  X(17)  VALUE                01780006
017900             '***** OPERATION: '.                                 01790006
018000         10  AA-DB2-OPERATION.                                    01800006
018100             15  AA-DB2-OP-1     PIC  X(50)  VALUE SPACES.        01810006
018200             15  AA-DB2-OP-2     PIC  X(25)  VALUE SPACES.        01820006
018300     05  AA-DB2-TABLE-1          PIC  X(08)  VALUE SPACES.        01830006
018400     05  AA-DB2-TABLE-2          PIC  X(08)  VALUE SPACES.        01840006
018500     05  AA-DB2-TABLE-3          PIC  X(08)  VALUE SPACES.        01850006
018600                                                                  01860006
018700     COPY DPWS004.                                                01870006
018800                                                                  01880006
018900 01  FILLER                      PIC  X(25)  VALUE                01890006
019000     '** END OF APKUT097 W/S **'.                                 01900006
019100                                                                  01910006
019200 PROCEDURE DIVISION.                                              01920006
019300                                                                  01930006
019400***************************************************************** 01940006
019500*  MAIN DRIVER PARAGRAPH                                          01950006
019600***************************************************************** 01960006
019700 A100-MAIN.                                                       01970006
019800                                                                  01980006
019900     MOVE 'A100-MAIN'            TO   PV-CURRENT-PARAGRAPH.       01990006
020000                                                                  02000006
020100     PERFORM B100-BEGIN-PROGRAM.                                  02010006
020200                                                                  02020006
020300     PERFORM B200-PROCESS-PO UNTIL EOF.                           02030006
020400                                                                  02040006
020500     PERFORM B300-END-PROGRAM.                                    02050006
020600                                                                  02060006
020700     GOBACK.                                                      02070006
020800                                                                  02080006
020900***************************************************************** 02090006
021000*  PROGRAM INITIALIZATION                                         02100006
021100***************************************************************** 02110006
021200 B100-BEGIN-PROGRAM.                                              02120006
021300                                                                  02130006
021400     MOVE 'B100-BEGIN-PROGRAM'   TO   PV-CURRENT-PARAGRAPH.       02140006
021500                                                                  02150006
021600     DISPLAY '**********************************************'.    02160006
021700     DISPLAY '**        APKUT097 STARTING NOW!!!!         **'.    02170006
021800     DISPLAY '**********************************************'.    02180006
021900                                                                  02190006
022000     OPEN INPUT  PO-FILE                                          02200006
022100          OUTPUT SHIPMT-TRIP-FILE.                                02210006
022200                                                                  02220006
022300     INITIALIZE DCLTRECEIV                                        02230006
022400                DCLTSHPTPO                                        02240006
022500                DCLTSHIPMT                                        02250006
022600                DCLTVHTRIP                                        02260006
022700                AP077-RECORD.                                     02270006
022800                                                                  02280006
022900     PERFORM R100-READ-PO-FILE.                                   02290006
023000                                                                  02300006
023100***************************************************************** 02310006
023200*  OPEN THE RECEIVER CURSOR AND PROCESS ALL OF THE RETURNED ROWS  02320006
023300*  UNTIL THERE IS NO MORE DATA FOR THAT PO.                       02330007
023400*  READ THE NEXT INPUT RECORD.                                    02340007
023500***************************************************************** 02350006
023600 B200-PROCESS-PO.                                                 02360006
023700                                                                  02370006
023800     MOVE 'B200-PROCESS-PO'      TO   PV-CURRENT-PARAGRAPH.       02380006
023900                                                                  02390006
024000     PERFORM Y100-OPEN-RCVR-CSR.                                  02400006
024100     PERFORM R200-FETCH-RCVR-DATA.                                02410006
024200     PERFORM C100-PROCESS-RCVR UNTIL OUT-OF-RCVR.                 02420006
024300     PERFORM Y200-CLOSE-RCVR-CSR.                                 02430006
024400     SET MORE-RCVR TO TRUE.                                       02440006
024500                                                                  02450006
024600     PERFORM R100-READ-PO-FILE.                                   02460006
024700                                                                  02470006
024800***************************************************************** 02480006
024900*  END OF PROCESSING.  CLOSE FILES.  DISPLAY COUNTS.              02490006
025000***************************************************************** 02500006
025100 B300-END-PROGRAM.                                                02510006
025200                                                                  02520006
025300     MOVE 'B300-END-PROGRAM'     TO   PV-CURRENT-PARAGRAPH.       02530006
025400                                                                  02540006
025500     CLOSE  PO-FILE                                               02550006
025600            SHIPMT-TRIP-FILE.                                     02560006
025700                                                                  02570006
025800     DISPLAY '***** APKUT097 COUNTS *****'.                       02580006
025900     DISPLAY 'RECORDS READ    = ' INPUT-COUNT.                    02590006
026000     DISPLAY 'RECORDS WRITTEN = ' OUTPUT-COUNT.                   02600006
026100     DISPLAY '***************************'.                       02610006
026200                                                                  02620006
026300***************************************************************** 02630006
026400*  SELECT VARIOUS PARTS OF THE SHIPMENT/TRIP DATA FOR THE PO      02640006
026500*  BEING PROCESSED.  MOVE THE SHIPMENT/TRIP DATA TO THE OUTPUT    02650008
026600*  RECORD.  FETCH THE NEXT RECEIVER ROW FOR PO BEING PROCESSED.   02660008
026700***************************************************************** 02670006
026800 C100-PROCESS-RCVR.                                               02680006
026900                                                                  02690006
027000     MOVE 'C100-PROCESS-RCVR'    TO   PV-CURRENT-PARAGRAPH.       02700006
027100                                                                  02710006
027200     PERFORM S100-SELECT-SHIPMENT-INFO.                           02720006
027300     PERFORM M100-MOVE-SHIPMT-DATA.                               02730006
027400                                                                  02740006
027500     PERFORM R200-FETCH-RCVR-DATA.                                02750006
027600                                                                  02760006
027700***************************************************************** 02770006
027800*  MOVE THE SHIPMENT DATA TO THE OUTPUT RECORD.  WRITE OUT THE    02780008
027900*  OUTPUT RECORD.                                                 02790006
028000***************************************************************** 02800006
028100 M100-MOVE-SHIPMT-DATA.                                           02810006
028200                                                                  02820006
028300     MOVE 'M100-MOVE-SHIPMT-DATA'   TO   PV-CURRENT-PARAGRAPH.    02830006
028400                                                                  02840006
028500     MOVE PV-PO-NBR                 TO AP077-PO-NBR.              02850006
028600     MOVE RECEIV-REC-SEQ-NBR        TO AP077-REC-SEQ-NBR.         02860006
028700     MOVE VHTRIP-OWNER-SCAC-ID      TO AP077-OWNER-SCAC-ID.       02870006
028800     MOVE VHTRIP-OWNR-SCAC-SHIP-DTE TO AP077-OWNR-SCAC-SHIP-DTE.  02880006
028900     MOVE VHTRIP-VEH-NBR            TO AP077-VEH-NBR.             02890006
029000     MOVE SHIPMT-PRO-NBR            TO AP077-PRO-NBR.             02900006
029100     MOVE SHIPMT-BOL-NBR            TO AP077-BOL-NBR.             02910006
029200     MOVE SHIPMT-VEND-SHIP-DTE      TO AP077-VEND-SHIP-DTE.       02920006
029300                                                                  02930006
029400     WRITE SHIPMT-TRIP-RECORD FROM AP077-RECORD.                  02940006
029500     ADD 1 TO OUTPUT-COUNT.                                       02950006
029600     INITIALIZE AP077-RECORD.                                     02960006
029700                                                                  02970006
029800***************************************************************** 02980006
029900*  READ THE INPUT FILE.                                           02990006
030000***************************************************************** 03000006
030100 R100-READ-PO-FILE.                                               03010006
030200                                                                  03020006
030300     MOVE 'R100-READ-PO-FILE'    TO   PV-CURRENT-PARAGRAPH.       03030006
030400                                                                  03040006
030500     READ PO-FILE                INTO AP400-PO-EXTRACT-RECORD     03050006
030600         AT END                                                   03060006
030700             SET EOF TO TRUE.                                     03070006
030800                                                                  03080006
030900     IF PV-EOF-SW = 'N'                                           03090006
031000        MOVE AP400-PO-NBR           TO PV-PO-NBR                  03100006
031100        ADD 1 TO INPUT-COUNT                                      03110006
031200     END-IF.                                                      03120006
031300                                                                  03130006
031400******************************************************************03140006
031500*  RETRIEVES THE RECEIVER DATA FOR THE PO BEING PROCESSED.        03150006
031600******************************************************************03160006
031700 R200-FETCH-RCVR-DATA.                                            03170006
031800                                                                  03180006
031900     MOVE 'R200-FETCH-RCVR-DATA '   TO   PV-CURRENT-PARAGRAPH.    03190006
032000                                                                  03200006
032100     EXEC SQL                                                     03210006
032200         FETCH RECEIVER_CSR                                       03220006
032300         INTO :RECEIV-REC-SEQ-NBR                                 03230006
032400     END-EXEC.                                                    03240006
032500                                                                  03250006
032600     EVALUATE TRUE                                                03260006
032700         WHEN SQLCODE = ZERO                                      03270006
032800              CONTINUE                                            03280006
032900                                                                  03290006
033000         WHEN SQLCODE = +100                                      03300006
033100              SET OUT-OF-RCVR TO TRUE                             03310006
033200                                                                  03320006
033300         WHEN SQLWARN0 NOT = SPACES                               03330006
033400         WHEN SQLCODE  NOT = ZERO                                 03340006
033500             MOVE 'R200-FETCH-RCVR-DATA' TO AA-PARAGRAPH-NAME     03350006
033600             MOVE 'UNSUCCESSFUL FETCH WITH RECEIVER_CSR'          03360006
033700                                           TO AA-DB2-OPERATION    03370006
033800             MOVE 'TRECEIV'                TO AA-DB2-TABLE-1      03380006
033900             MOVE '       '                TO AA-DB2-TABLE-2      03390006
034000             MOVE '       '                TO AA-DB2-TABLE-3      03400006
034100             PERFORM Z998-DB2-ABEND                               03410006
034200     END-EVALUATE.                                                03420006
034300                                                                  03430006
034400******************************************************************03440006
034500*  SELECT THE SHIPMENT INFO FOR THE PO BEING PROCESSED.           03450006
034600******************************************************************03460006
034700 S100-SELECT-SHIPMENT-INFO.                                       03470006
034800                                                                  03480006
034900     MOVE 'S100-SELECT-SHIPMENT-INFO' TO   PV-CURRENT-PARAGRAPH.  03490006
035000                                                                  03500006
035100     MOVE 'N' TO PS-MULT-SHIP-SW.                                 03510006
035200                                                                  03520006
035300     PERFORM                                                      03530006
035400         WITH TEST AFTER                                          03540006
035500         VARYING PV-RETRY-COUNTER                                 03550006
035600         FROM 1 BY 1                                              03560006
035700         UNTIL ((PV-RETRY-COUNTER > PV-MAX-RETRIES)               03570006
035800            OR (SQLCODE = +0)                                     03580006
035900            OR (SQLCODE = +100)                                   03590006
036000            OR (SQLCODE = -305)                                   03600006
036100            OR (SQLCODE = -811))                                  03610006
036200                                                                  03620006
036300        EXEC SQL                                                  03630006
036400           SELECT  DISTINCT                                       03640006
036500                   C.OWNER_SCAC_ID                                03650006
036600                  ,C.OWNR_SCAC_SHIP_DTE                           03660006
036700                  ,COALESCE(C.VEH_NBR,'          ')               03670006
036800                  ,B.PRO_NBR                                      03680006
036900                  ,B.BOL_NBR                                      03690006
037000                  ,B.VEND_SHIP_DTE                                03700006
037100             INTO :VHTRIP-OWNER-SCAC-ID                           03710006
037200                 ,:VHTRIP-OWNR-SCAC-SHIP-DTE                      03720006
037300                 ,:VHTRIP-VEH-NBR                                 03730006
037400                 ,:SHIPMT-PRO-NBR                                 03740006
037500                 ,:SHIPMT-BOL-NBR                                 03750006
037600                 ,:SHIPMT-VEND-SHIP-DTE                           03760006
037700             FROM  TSHPTPO A                                      03770006
037800                  ,TSHIPMT B                                      03780006
037900                  ,TVHTRIP C                                      03790006
038000         WHERE A.PO_NBR      = :PV-PO-NBR                         03800006
038100           AND A.REC_SEQ_NBR = :RECEIV-REC-SEQ-NBR                03810006
038200           AND A.SHIPT_ID        = B.SHIPT_ID                     03820006
038300           AND B.TRIP_ID         = C.TRIP_ID                      03830006
038400        END-EXEC                                                  03840006
038500                                                                  03850006
038600          EVALUATE TRUE                                           03860006
038700              WHEN SQLCODE = +0                                   03870006
038800              WHEN SQLCODE = +100                                 03880006
038900              WHEN SQLCODE = -904                                 03890006
039000              WHEN SQLCODE = -913                                 03900006
039100                  CONTINUE                                        03910006
039200                                                                  03920006
039300              WHEN SQLCODE = -811                                 03930006
039400                 SET PS-MULT-SHIP TO TRUE                         03940006
039500              WHEN SQLWARN0 NOT = SPACE                           03950006
039600              WHEN SQLCODE < +0                                   03960006
039700              WHEN SQLCODE > +0                                   03970006
039800                  MOVE 'S100-SELECT-SHIPMENT-INFO'                03980006
039900                                  TO AA-PARAGRAPH-NAME            03990006
040000                  MOVE 'SELECT SHIPMENT INFO'                     04000006
040100                                  TO AA-DB2-OPERATION             04010006
040200                  MOVE 'TSHPTPO'  TO AA-DB2-TABLE-1               04020006
040300                  MOVE 'TSHIPMT'  TO AA-DB2-TABLE-2               04030006
040400                  MOVE 'TVHTRIP'  TO AA-DB2-TABLE-3               04040006
040500                  PERFORM Z998-DB2-ABEND                          04050006
040600          END-EVALUATE                                            04060006
040700     END-PERFORM.                                                 04070006
040800                                                                  04080006
040900     IF  PV-RETRY-COUNTER > PV-MAX-RETRIES                        04090006
041000         AND (SQLCODE = -904 OR -913)                             04100006
041100         MOVE 'S100-SELECT-SHIPMENT-INFO'                         04110006
041200                                 TO AA-PARAGRAPH-NAME             04120006
041300         MOVE 'MAXIMUM RETRIES EXCEEDED ATTEMPTING TO SELECT'     04130006
041400                                 TO AA-DB2-OPERATION              04140006
041500         MOVE 'TSHPTPO'          TO AA-DB2-TABLE-1                04150006
041600         MOVE 'TSHIPMT'          TO AA-DB2-TABLE-2                04160006
041700         MOVE 'TVHTRIP'          TO AA-DB2-TABLE-3                04170006
041800         PERFORM Z998-DB2-ABEND                                   04180006
041900     END-IF.                                                      04190006
042000                                                                  04200006
042100     IF PS-MULT-SHIP                                              04210006
042200        PERFORM S200-SELECT-PRIM-SHIP                             04220006
042300     END-IF.                                                      04230006
042400                                                                  04240006
042500/                                                                 04250006
042600*----------------------------------------------------------------*04260006
042700*    SELECT THE PRIMARY SHIPMENT DATA IF THERE IS MORE THAN ONE  *04270006
042800*    FOR THE SAME RECEIVER SEQUENCE NUMBER.                      *04280006
042900*----------------------------------------------------------------*04290006
043000 S200-SELECT-PRIM-SHIP.                                           04300006
043100                                                                  04310006
043200     MOVE 'S200-SELECT-PRIM-SHIP   ' TO   PV-CURRENT-PARAGRAPH.   04320006
043300                                                                  04330006
043400     PERFORM                                                      04340006
043500         WITH TEST AFTER                                          04350006
043600         VARYING PV-RETRY-COUNTER                                 04360006
043700         FROM 1 BY 1                                              04370006
043800         UNTIL ((PV-RETRY-COUNTER > PV-MAX-RETRIES)               04380006
043900            OR (SQLCODE = +0)                                     04390006
044000            OR (SQLCODE = +100)                                   04400006
044100            OR (SQLCODE = -811))                                  04410006
044200                                                                  04420006
044300         EXEC SQL                                                 04430006
044400              SELECT C.OWNER_SCAC_ID                              04440006
044500                    ,C.OWNR_SCAC_SHIP_DTE                         04450006
044600                    ,COALESCE(C.VEH_NBR,'          ')             04460006
044700                    ,B.PRO_NBR                                    04470006
044800                    ,B.BOL_NBR                                    04480006
044900                    ,B.VEND_SHIP_DTE                              04490006
045000               INTO :VHTRIP-OWNER-SCAC-ID                         04500006
045100                   ,:VHTRIP-OWNR-SCAC-SHIP-DTE                    04510006
045200                   ,:VHTRIP-VEH-NBR                               04520006
045300                   ,:SHIPMT-PRO-NBR                               04530006
045400                   ,:SHIPMT-BOL-NBR                               04540006
045500                   ,:SHIPMT-VEND-SHIP-DTE                         04550006
045600                FROM TSHPTPO A                                    04560006
045700                    ,TSHIPMT B                                    04570006
045800                    ,TVHTRIP C                                    04580006
045900               WHERE A.PO_NBR      = :PV-PO-NBR                   04590006
046000                 AND A.REC_SEQ_NBR = :RECEIV-REC-SEQ-NBR          04600006
046100                 AND A.SHIPT_ID = B.SHIPT_ID                      04610006
046200                 AND B.TRIP_ID  = C.TRIP_ID                       04620006
046300                 AND A.PRIM_SHIPT_IND = 'Y'                       04630006
046400         END-EXEC                                                 04640006
046500                                                                  04650006
046600                                                                  04660006
046700          EVALUATE TRUE                                           04670006
046800              WHEN SQLCODE = +0                                   04680006
046900              WHEN SQLCODE = +100                                 04690006
047000              WHEN SQLCODE = -904                                 04700006
047100              WHEN SQLCODE = -913                                 04710006
047200                  CONTINUE                                        04720006
047300                                                                  04730006
047400              WHEN SQLWARN0 NOT = SPACE                           04740006
047500              WHEN SQLCODE < +0                                   04750006
047600              WHEN SQLCODE > +0                                   04760006
047700                  MOVE 'S200-SELECT-PRIM-SHIP'                    04770006
047800                                  TO AA-PARAGRAPH-NAME            04780006
047900                  MOVE 'GET PRIMARY SHIPMENT   '                  04790006
048000                                  TO AA-DB2-OPERATION             04800006
048100                  MOVE 'TSHPTPO'  TO AA-DB2-TABLE-1               04810006
048200                  MOVE 'TSHIPMT'  TO AA-DB2-TABLE-2               04820006
048300                  MOVE 'TVHTRIP'  TO AA-DB2-TABLE-3               04830006
048400                  PERFORM Z998-DB2-ABEND                          04840006
048500          END-EVALUATE                                            04850006
048600     END-PERFORM.                                                 04860006
048700                                                                  04870006
048800     IF  PV-RETRY-COUNTER > PV-MAX-RETRIES                        04880006
048900         AND (SQLCODE = -904 OR -913)                             04890006
049000         MOVE 'S200-SELECT-PRIM-SHIP'                             04900006
049100                                 TO AA-PARAGRAPH-NAME             04910006
049200         MOVE 'MAXIMUM RETRIES EXCEEDED ATTEMPTING TO SELECT'     04920006
049300                                 TO AA-DB2-OPERATION              04930006
049400         MOVE 'TSHPTPO'          TO AA-DB2-TABLE-1                04940006
049500         MOVE 'TSHIPMT'          TO AA-DB2-TABLE-2                04950006
049600         MOVE 'TVHTRIP'          TO AA-DB2-TABLE-3                04960006
049700         PERFORM Z998-DB2-ABEND                                   04970006
049800     END-IF.                                                      04980006
049900                                                                  04990006
050000***************************************************************** 05000006
050100*  OPENS THE RECEIVER CURSOR.                                     05010006
050200***************************************************************** 05020006
050300 Y100-OPEN-RCVR-CSR.                                              05030006
050400                                                                  05040006
050500     MOVE 'Y100-OPEN-RCVR-CSR      ' TO   PV-CURRENT-PARAGRAPH.   05050006
050600                                                                  05060006
050700     EXEC SQL                                                     05070006
050800         OPEN RECEIVER_CSR                                        05080006
050900     END-EXEC.                                                    05090006
051000                                                                  05100006
051100     EVALUATE TRUE                                                05110006
051200         WHEN SQLCODE = ZERO                                      05120006
051300              CONTINUE                                            05130006
051400                                                                  05140006
051500         WHEN SQLWARN0 NOT = SPACES                               05150006
051600         WHEN SQLCODE  NOT = ZERO                                 05160006
051700             MOVE 'Y100-OPEN-RCVR-CSR' TO AA-PARAGRAPH-NAME       05170006
051800             MOVE 'UNSUCCESSFUL OPEN ON RECEIVER_CSR'             05180006
051900                                           TO AA-DB2-OPERATION    05190006
052000             MOVE 'TRECEIV'      TO AA-DB2-TABLE-1                05200006
052100             MOVE '       '      TO AA-DB2-TABLE-2                05210006
052200             MOVE '       '      TO AA-DB2-TABLE-3                05220006
052300             PERFORM Z998-DB2-ABEND                               05230006
052400     END-EVALUATE.                                                05240006
052500                                                                  05250006
052600******************************************************************05260006
052700*  CLOSES THE RECEIVER CURSOR.                                    05270006
052800******************************************************************05280006
052900 Y200-CLOSE-RCVR-CSR.                                             05290006
053000                                                                  05300006
053100     MOVE 'Y200-CLOSE-RCVR-CSR    ' TO   PV-CURRENT-PARAGRAPH.    05310006
053200                                                                  05320006
053300       EXEC SQL                                                   05330006
053400           CLOSE RECEIVER_CSR                                     05340006
053500       END-EXEC.                                                  05350006
053600                                                                  05360006
053700       EVALUATE TRUE                                              05370006
053800           WHEN SQLCODE = ZERO                                    05380006
053900                CONTINUE                                          05390006
054000                                                                  05400006
054100           WHEN SQLWARN0 NOT = SPACES                             05410006
054200           WHEN SQLCODE  NOT = ZERO                               05420006
054300               MOVE 'Y200-CLOSE-RCVR-CSR'                         05430006
054400                                         TO AA-PARAGRAPH-NAME     05440006
054500               MOVE 'UNSUCCESSFUL CLOSE ON RECEIVER_CSR'          05450006
054600                                         TO AA-DB2-OPERATION      05460006
054700               MOVE 'TRECEIV'      TO AA-DB2-TABLE-1              05470006
054800               MOVE '       '      TO AA-DB2-TABLE-2              05480006
054900               MOVE '       '      TO AA-DB2-TABLE-3              05490006
055000               PERFORM Z998-DB2-ABEND                             05500006
055100       END-EVALUATE.                                              05510006
055200                                                                  05520006
055300***************************************************************** 05530006
055400*  ABEND ROUTINE FOR DB2 ERRORS                                   05540006
055500***************************************************************** 05550006
055600 Z998-DB2-ABEND.                                                  05560006
055700                                                                  05570006
055800     CLOSE  PO-FILE                                               05580006
055900            SHIPMT-TRIP-FILE.                                     05590006
056000                                                                  05600006
056100     MOVE PV-PO-NBR      TO PV-PO-NBR-UNPK.                       05610006
056200     MOVE PV-PO-NBR-UNPK TO PV-PO-NBR-9.                          05620006
056300     DISPLAY 'PO NBR = ' PV-PO-NBR-9.                             05630006
056400     DISPLAY AA-ABEND-LIT.                                        05640006
056500     DISPLAY AA-DB2-ERROR-LIT.                                    05650006
056600     DISPLAY AA-PROGRAM-LIT.                                      05660006
056700     DISPLAY AA-PARAGRAPH-LIT.                                    05670006
056800     DISPLAY AA-DB2-OPERATION-LIT.                                05680006
056900     DISPLAY AA-DB2-TABLE-1.                                      05690006
057000     DISPLAY AA-DB2-TABLE-2.                                      05700006
057100     DISPLAY AA-DB2-TABLE-3.                                      05710006
057200     SET AC-DB2-ERROR TO TRUE.                                    05720006
057300                                                                  05730006
057400     COPY DPPD004.                                                05740006
057500                                                                  05750006
057600     CALL 'ILBOABN0' USING ABEND-CODE.                            05760006
