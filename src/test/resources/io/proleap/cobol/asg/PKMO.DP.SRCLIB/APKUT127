000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.      APKUT127.                                       00020000
000300 AUTHOR.          NANCY EILBES.                                   00030000
000400 INSTALLATION.    KOHLS DEPARTMENT STORES.                        00040000
000500 DATE-WRITTEN.    04/28/2004.                                     00050000
000600*----------------------------------------------------------------*00060000
000700*   SPLIT VENDOR ALLOWANCE ACTIVITY FILE INTO QUARTER TO DATE    *00070000
000710*   YEAR TO DATE FILES FOR REPORTING PURPOSES.                   *00071000
000711*                                                                *00071100
000712*   COBOL390 WITH DB2 SQL                                        *00071200
000713*----------------------------------------------------------------*00071300
000714*   THIS PROGRAM WILL READ AN EXTRACT FILE OF VENDOR AGREEMENT   *00071400
000715*   PURCHASE ACTIVITY AND DETERMINE IF EACH RECORD SHOULD BE     *00071500
000716*   WRITTEN TO THE QTD FILE AND/OR THE YTD FILE OR NEITHER.      *00071600
000717*   AS THE RECORDS ARE PROCESSED, DMA AND GMA NUMBERS WILL BE    *00071700
000718*   FETCHED FROM THE TMDSEAR TABLE AND REPLACE THE VALUES ON THE *00071800
000719*   INPUT RECORDS.  THIS WILL ENSURE THAT ALL OF THE ACTIVITY    *00071900
000720*   FOR THE QUARTER OR YEAR WILL HAVE THE DEPARTMENTS ALIGNED    *00072000
000730*   ACCORDING TO THE CURRENT MDS HIERARCHY.                      *00073000
000740*----------------------------------------------------------------*00074000
000750*                                                                *00075000
000760* DB2 TABLES:                                                    *00076000
000770*  1. ACCOUNTS PAYABLE CONTROL TABLE  (TAPCNTL TABLE)            *00077000
000780*  2. DATE ATTRIBUTE TABLE            (TDTATTR TABLE)            *00078000
000790*  3. MDS HIERARCHY TABLE             (TMDSEAR TABLE)            *00079000
000800*  4. ENTITY NAME TABLE               (TENTNME TABLE)            *00080000
000900*                                                                *00090000
001000* INPUT FILE:                                                    *00100000
001100*  1. VENDOR AGREEMENT ACTIVITY FILE  (COPYBOOK APRD081)         *00110000
001200*                                                                *00120000
001300* OUTPUT FILE:                                                   *00130000
001400*  1. QUARTER TO DATE REPORTING FILE  (COPYBOOK APRD081)         *00140000
001500*  2. YEAR TO DATE REPORTING FILE     (COPYBOOK APRD081)         *00150000
001600*  3. QUARTER TO DATE DATES FILE                                 *00160000
001610*  4. YEAR TO DATE DATES FILE                                    *00161000
001620*                                                                *00162000
001630*----------------------------------------------------------------*00163000
001640* CHANGE LOG:                                                    *00164000
001650*   DATE  04/28/2004                                             *00165000
001660*       CHANGE MADE: INITIAL VERSION.                            *00166000
001670*       MADE BY: NANCY EILBES            WR/IR #: WR26677        *00167000
001680*                                                                *00168000
001690*   DATE  05/13/2004                                             *00169000
001700*       CHANGE MADE: MODIFIED SQL IN S400 TO RETRIEVE THE DATES  *00170000
001800*       BASED ON THE PREV-WK-END DATE INSTEAD OF THE BATCH       *00180000
001900*       PROCESS DATE.  ON SELECT STATEMENTS GETTING THE MIN AND  *00190000
002000*       AND MAX DATES FOR THE QTR AND YEAR, REMOVED CRITERIA     *00200000
002100*       FSCL_MN_END_DTE <= :APCNTL-BTCH-PRC-DTE.  BOTH OF THESE  *00210000
002200*       CHANGES WERE REQUIRED BECAUSE THE ORIGINAL LOGIC         *00220000
002300*       PREVENTED THE PROGRAM FROM BEING RUN AFTER THE LAST DAY  *00230000
002301*       OF THE FISCAL MONTH, AND IT NEEDS TO BE RUN DURING CLOSE *00230100
002302*       WEEK AND STILL PROCESS FOR THE MONTH BEING CLOSED        *00230200
002303*       RATHER THAN THE NEW MONTH.                               *00230300
002304*       MADE BY: NANCY EILBES            WR/IR #: WR26677        *00230400
002305*                                                                *00230500
002306*   DATE  06/28/2004                                             *00230600
002307*       CHANGE MADE: ADDED TMDSEAR TABLE AND LOGIC TO GET THE    *00230700
002308*       DMA AND GMA NUMBERS.  THESE WILL REPLACE THE VALUES FROM *00230800
002309*       THE INPUT RECORDS TO ENSURE THAT THESE ARE UP TO DATE IN *00230900
002310*       THE CASE WHERE DEPTS MAY HAVE BEEN REALIGNED SINCE THE   *00231000
002311*       EXTRACT WAS CREATED.                                     *00231100
002312*       MADE BY: NANCY EILBES            WR/IR #: WR26677        *00231200
002313*                                                                *00231300
002314*   DATE  10/21/2004                                             *00231400
002315*       CHANGE MADE: ADDED TENTNME TABLE AND LOGIC TO GET THE    *00231500
002316*       VENDOR NAME.  THIS WILL REPLACE THE VENDOR NAME FROM THE *00231600
002317*       THE INPUT RECORDS TO ENSURE THAT THE NAME IS UP TO DATE  *00231700
002318*       BECAUSE NAMES CAN CHANGE SINCE THE EXTRACT WAS CREATED.  *00231800
002319*       ALSO ADDED LOGIC FOR 'NO-AGREEMENT' SO THAT QTD AND YTD  *00231900
002320*       RECORDS WILL BE WRITTEN TO THE OUTPUT.  THIS CHANGE WAS  *00232000
002321*       NECESSARY TO ALLOW QTD AND YTD REPORTS WITH OR WITHOUT   *00232100
002322*       AGREEMENTS TO BE GENERATED.                              *00232200
002323*       MADE BY: NANCY EILBES            WR/IR #: WR26677        *00232300
002324*                                                                *00232402
002325*   DATE  04/22/2005                                             *00232502
002326*       CHANGE MADE: ADDED LOGIC TO HANDLE 'OFF-INVOICE'         *00232602
002327*       POSTING FREQUENCY.                                       *00232702
002328*       MADE BY: NANCY EILBES            WR/IR #: WR28651        *00232802
002329*                                                                *00232900
002330*----------------------------------------------------------------*00233000
002331                                                                  00233100
002332 ENVIRONMENT DIVISION.                                            00233200
002333                                                                  00233300
002334 CONFIGURATION SECTION.                                           00233400
002335 SOURCE-COMPUTER. IBM-3090.                                       00233500
002340 OBJECT-COMPUTER. IBM-3090.                                       00234000
002350                                                                  00235000
002360 INPUT-OUTPUT SECTION.                                            00236000
002370 FILE-CONTROL.                                                    00237000
002380     SELECT VNDAGR-ACTVTY-FILE ASSIGN TO INP01.                   00238000
002390     SELECT QTD-REPORT-FILE    ASSIGN TO OUT01.                   00239000
002400     SELECT YTD-REPORT-FILE    ASSIGN TO OUT02.                   00240000
002500     SELECT QTD-DATES-FILE     ASSIGN TO OUT03.                   00250000
002600     SELECT YTD-DATES-FILE     ASSIGN TO OUT04.                   00260000
002700                                                                  00270000
002800 DATA DIVISION.                                                   00280000
002900                                                                  00290000
003000 FILE SECTION.                                                    00300000
003100                                                                  00310000
003200 FD  VNDAGR-ACTVTY-FILE                                           00320000
003300     RECORDING MODE IS F                                          00330000
003400     LABEL RECORDS ARE STANDARD                                   00340000
003500     BLOCK CONTAINS 0 RECORDS.                                    00350000
003600                                                                  00360000
003700 01  VNDAGR-ACTVTY-RECORD       PIC X(250).                       00370000
003800                                                                  00380000
003900 FD  QTD-REPORT-FILE                                              00390000
004000     RECORDING MODE IS F                                          00400000
004100     LABEL RECORDS ARE STANDARD                                   00410000
004200     BLOCK CONTAINS 0 RECORDS.                                    00420000
004300                                                                  00430000
004400 01  QTD-REPORT-RECORD          PIC X(250).                       00440000
004500                                                                  00450000
004510 FD  YTD-REPORT-FILE                                              00451000
004520     RECORDING MODE IS F                                          00452000
004530     LABEL RECORDS ARE STANDARD                                   00453000
004540     BLOCK CONTAINS 0 RECORDS.                                    00454000
004550                                                                  00455000
004560 01  YTD-REPORT-RECORD          PIC X(250).                       00456000
004570                                                                  00457000
004580 FD  QTD-DATES-FILE                                               00458000
004590     RECORDING MODE IS F                                          00459000
004591     LABEL RECORDS ARE STANDARD                                   00459100
004592     BLOCK CONTAINS 0 RECORDS.                                    00459200
004593                                                                  00459300
004594 01  QTD-DATES-RECORD              PIC X(80).                     00459400
004595                                                                  00459500
004596 FD  YTD-DATES-FILE                                               00459600
004597     RECORDING MODE IS F                                          00459700
004598     LABEL RECORDS ARE STANDARD                                   00459800
004599     BLOCK CONTAINS 0 RECORDS.                                    00459900
004600                                                                  00460000
004601 01  YTD-DATES-RECORD              PIC X(80).                     00460100
004602                                                                  00460200
004603 WORKING-STORAGE SECTION.                                         00460300
004604                                                                  00460400
004605 01  PV-PROGRAM-VARIABLES.                                        00460500
004606     05  PV-CAL-QTR-NBR             PIC X.                        00460600
004607     05  PV-CAL-YR-NBR              PIC X(4).                     00460700
004608     05  PV-QTD-BEG-DTE             PIC X(10).                    00460800
004609     05  PV-QTD-END-DTE             PIC X(10).                    00460900
004610     05  PV-YTD-BEG-DTE             PIC X(10).                    00461000
004620     05  PV-YTD-END-DTE             PIC X(10).                    00462000
004630     05  PV-SAVE-DEPT-NBR           PIC X(3)    VALUE ZEROES.     00463000
004640     05  PV-SAVE-ENT-ID             PIC S9(9) COMP VALUE ZEROES.  00464000
004650     05  DISPLAY-ENT-ID             PIC ZZZZZZZZ9  VALUE ZEROES.  00465000
004660                                                                  00466000
004670 01  WS-COUNTERS-AND-CONSTANTS.                                   00467000
004680     05  INPUT-COUNT                  PIC 9(09) VALUE 0.          00468000
004690     05  OUT-QTD-COUNT                PIC 9(09) VALUE 0.          00469000
004700     05  OUT-YTD-COUNT                PIC 9(09) VALUE 0.          00470000
004800     05  PC-PROGRAM-NAME              PIC X(08) VALUE 'APKUT127'. 00480000
004900                                                                  00490000
005000 01  PS-PROGRAM-SWITCHES.                                         00500000
005100     05  PS-ACTVTY-EOF                PIC X(01)      VALUE 'N'.   00510000
005200         88  ACTVTY-EOF                              VALUE 'Y'.   00520000
005300                                                                  00530000
005400 01  WS-ABEND-FIELDS.                                             00540000
005500     05  WS-ABEND-LITERAL          PIC  X(40)   VALUE             00550000
005600             '*****       ABEND'.                                 00560000
005700     05  WS-ABEND-PROGRAM-MSG.                                    00570000
005800         10  FILLER                PIC X(17)    VALUE             00580000
005900             '*****   PROGRAM: '.                                 00590000
006000         10  WS-ABEND-PROGRAM      PIC X(8)   VALUE 'APKUT127'.   00600000
006100     05  WS-ABEND-PARAGRAPH-MSG.                                  00610000
006200         10  FILLER                PIC  X(17)   VALUE             00620000
006300             '***** PARAGRAPH: '.                                 00630000
006400         10  WS-ABEND-PARAGRAPH    PIC X(35)  VALUE SPACES.       00640000
006500     05  WS-ABEND-OPERATION-MSG.                                  00650000
006600         10  FILLER                PIC  X(17)   VALUE             00660000
006700             '***** OPERATION: '.                                 00670000
006800         10  WS-ABEND-OPERATION    PIC X(50)  VALUE SPACES.       00680000
006900     05  WS-ABEND-TABLE1-MSG.                                     00690000
007000         10  FILLER                PIC  X(15)   VALUE             00700000
007100             '***** TABLE 1: '.                                   00710000
007200         10  WS-ABEND-STRUCTURE-1  PIC X(8)   VALUE SPACES.       00720000
007300     05  WS-ABEND-TABLE2-MSG.                                     00730000
007400         10  FILLER                PIC  X(15)   VALUE             00740000
007500             '***** TABLE 2: '.                                   00750000
007600         10  WS-ABEND-STRUCTURE-2  PIC X(8)   VALUE SPACES.       00760000
007700     05  WS-ABEND-STATUS           PIC XX     VALUE SPACES.       00770000
007800     05  WS-MESSAGE-LINE-1.                                       00780000
007900         10  FILLER                PIC  X(06)   VALUE '*****'.    00790000
008000         10  WS-MESSAGE-1          PIC  X(80)   VALUE SPACES.     00800000
008100     05  WS-MESSAGE-LINE-2.                                       00810000
008200         10  FILLER                PIC  X(06)   VALUE '*****'.    00820000
008300         10  WS-MESSAGE-2          PIC  X(80)   VALUE SPACES.     00830000
008400                                                                  00840000
008500 01  ABEND-CODE                    PIC S9(4)  COMP SYNC           00850000
008600                                              VALUE ZEROS.        00860000
008700     88 AP-TABLE-FULL              VALUE +4004.                   00870000
008800     88 AP-EMPTY-FILE              VALUE +4005.                   00880000
008900     88 AP-TABLE-NOTFND            VALUE +4006.                   00890000
009000     88 AC-BAD-DATA                VALUE +4008.                   00900000
009100     88 AP-DB2-ERROR               VALUE +4013.                   00910000
009200                                                                  00920000
009300*----------------------------------------------------------------*00930000
009400* DB2 SQL ERROR MESSAGE FORMAT AREA                               00940000
009500*----------------------------------------------------------------*00950000
009600                                                                  00960000
009700     COPY DPWS004.                                                00970000
009800                                                                  00980000
009900*----------------------------------------------------------------*00990000
010000* VENDOR AGREEMENT ACTIVITY EXTRACT FILE LAYOUT (INPUT)           01000000
010100*----------------------------------------------------------------*01010000
010200                                                                  01020000
010300     COPY APRD081.                                                01030000
010400                                                                  01040000
010500*----------------------------------------------------------------*01050000
010600* REPORTING DATES CONTROL RECORD.                                 01060000
010700*----------------------------------------------------------------*01070000
010800                                                                  01080000
010900 01  REPORTING-DATES-RECORD.                                      01090000
011000     05  REPORTING-BEGIN-DTE       PIC X(10).                     01100000
011100     05  FILLER                    PIC X.                         01110000
011200     05  REPORTING-END-DTE         PIC X(10).                     01120000
011300     05  FILLER                    PIC X(79).                     01130000
011400                                                                  01140000
011500*----------------------------------------------------------------*01150000
011600* ACCOUNTS PAYABLE CONTROL TABLE                                  01160000
011700*----------------------------------------------------------------*01170000
011800                                                                  01180000
011900     EXEC SQL                                                     01190000
012000         INCLUDE TAPCNTL                                          01200000
012100     END-EXEC.                                                    01210000
012200                                                                  01220000
012300*----------------------------------------------------------------*01230000
012400* DATE ATTRIBUTE TABLE                                            01240000
012500*----------------------------------------------------------------*01250000
012600                                                                  01260000
012700     EXEC SQL                                                     01270000
012800         INCLUDE TDTATTR                                          01280000
012900     END-EXEC.                                                    01290000
013000                                                                  01300000
013100*----------------------------------------------------------------*01310000
013200* MERCHANDISE AREA TABLE                                          01320000
013300*----------------------------------------------------------------*01330000
013400                                                                  01340000
013500     EXEC SQL                                                     01350000
013600         INCLUDE TMDSEAR                                          01360000
013700     END-EXEC.                                                    01370000
013800                                                                  01380000
013900*----------------------------------------------------------------*01390000
014000* ENTITY NAME TABLE                                               01400000
014100*----------------------------------------------------------------*01410000
014200                                                                  01420000
014300     EXEC SQL                                                     01430000
014400         INCLUDE TENTNME                                          01440000
014500     END-EXEC.                                                    01450000
014600                                                                  01460000
014700*----------------------------------------------------------------*01470000
014800* DB2 COMMUNICATION AREA                                          01480000
014900*----------------------------------------------------------------*01490000
015000                                                                  01500000
015100     EXEC SQL                                                     01510000
015200         INCLUDE SQLCA                                            01520000
015300     END-EXEC.                                                    01530000
015400                                                                  01540000
015500*----------------------------------------------------------------*01550000
015600* DB2 COMMUNICATION AREA2                                         01560000
015700*----------------------------------------------------------------*01570000
015800                                                                  01580000
015900     COPY SQLCA2.                                                 01590000
016000                                                                  01600000
016100 PROCEDURE DIVISION.                                              01610000
016200                                                                  01620000
016300 A100-PROGRAM-MAINLINE.                                           01630000
016400                                                                  01640000
016500     PERFORM B100-HOUSEKEEPING.                                   01650000
016600                                                                  01660000
016700     PERFORM B200-PROCESS-ACTVTY-REC                              01670000
016800         UNTIL ACTVTY-EOF.                                        01680000
016900                                                                  01690000
017000     PERFORM B300-END-OF-JOB.                                     01700000
017100                                                                  01710000
017200     GOBACK.                                                      01720000
017300                                                                  01730000
017400*----------------------------------------------------------------*01740000
017500*  B100-HOUSEKEEPING  OPEN FILES, INITIALIZE THE NECESSARY        01750000
017600*  FIELDS, PROCESS THE INVOICE FILE FOR THE FIRST RECORD, AND     01760000
017700*  OPENS THE CURSOR FOR THE FIRST RECORD.                         01770000
017800*----------------------------------------------------------------*01780000
017900                                                                  01790000
018000 B100-HOUSEKEEPING.                                               01800000
018100                                                                  01810000
018200     OPEN INPUT  VNDAGR-ACTVTY-FILE                               01820000
018300          OUTPUT QTD-REPORT-FILE                                  01830000
018400                 YTD-REPORT-FILE                                  01840000
018500                 QTD-DATES-FILE                                   01850000
018600                 YTD-DATES-FILE.                                  01860000
018700                                                                  01870000
018800     PERFORM S400-SELECT-DATES.                                   01880000
018900     DISPLAY '*** DATE CONTROLS SELECTED FOR THIS RUN ***'        01890000
019000     DISPLAY 'BATCH PROCESS DATE   = ' APCNTL-BTCH-PRC-DTE.       01900000
019100     DISPLAY 'DTATTR-FSCL-MN-NBR   = ' DTATTR-FSCL-MN-NBR.        01910000
019200     DISPLAY 'DTATTR-FSCL-YR-NBR   = ' DTATTR-FSCL-YR-NBR.        01920000
019300     DISPLAY 'DTATTR-FSCL-QTR-NBR  = ' DTATTR-FSCL-QTR-NBR.       01930000
019400     DISPLAY 'DTATTR-CAL-MN-NBR    = ' DTATTR-CAL-MN-NBR.         01940000
019500     DISPLAY 'PV-CAL-QTR-NBR       = ' PV-CAL-QTR-NBR.            01950000
019600     DISPLAY 'PV-CAL-YR-NBR        = ' PV-CAL-YR-NBR.             01960000
019700     DISPLAY '****** END OF DATE CONTROLS DISPLAY *******'.       01970000
019800                                                                  01980000
019900     PERFORM W300-WRITE-DATE-RECORDS.                             01990000
020000                                                                  02000000
020100     PERFORM R100-READ-VNDAGR-ACTVTY-FILE.                        02010000
020200                                                                  02020000
020300*---------------------------------------------------------------* 02030000
020400*  PROCESSES RECORDS FROM THE EXTRACT FILE.  POSTING FREQUENCY  * 02040000
020500*  AND THE END OF PERIOD CURRENTLY BEING PROCESSED DETERMINES   * 02050000
020600*  WHETHER OR NOT A VENDOR DEDUCTION WILL BE PROCESSED.         * 02060000
020700*  THE CORRECT HALF-YEAR NUMBER IS ASSIGNED BASED ON QTR NBR.   * 02070000
020800*---------------------------------------------------------------* 02080000
020900                                                                  02090000
021000 B200-PROCESS-ACTVTY-REC.                                         02100000
021100                                                                  02110000
021110     IF AP081-ENT-ID = PV-SAVE-ENT-ID                             02111000
021120        CONTINUE                                                  02112000
021130     ELSE                                                         02113000
021140        PERFORM S200-SELECT-VENDOR-NAME                           02114000
021150        MOVE AP081-ENT-ID TO PV-SAVE-ENT-ID                       02115000
021160     END-IF.                                                      02116000
021170                                                                  02117000
021180     MOVE ENTNME-ENT-NAME-DESC TO AP081-VENDOR-NAME.              02118000
021181                                                                  02118100
021182     IF AP081-DEPT-NBR = PV-SAVE-DEPT-NBR                         02118200
021183        CONTINUE                                                  02118300
021184     ELSE                                                         02118400
021185        PERFORM S100-SELECT-GMA-DMA-NBR                           02118500
021186        MOVE AP081-DEPT-NBR TO PV-SAVE-DEPT-NBR                   02118600
021187     END-IF.                                                      02118700
021188                                                                  02118800
021189     MOVE MDSEAR-GMA-NBR TO AP081-GMA-NBR.                        02118900
021190     MOVE MDSEAR-DMA-NBR TO AP081-DMA-NBR.                        02119000
021191                                                                  02119100
021192     EVALUATE TRUE                                                02119200
021193         WHEN AP081-POST-FSCL-MNTH                                02119300
021194         WHEN AP081-POST-FSCL-QTR                                 02119400
021195         WHEN AP081-POST-FSCL-SEMI-ANNL                           02119500
021196         WHEN AP081-POST-FSCL-ANNL                                02119600
021197         WHEN AP081-DO-NOT-POST                                   02119700
021198         WHEN AP081-OFF-INVOICE                                   02119801
021199         WHEN AP081-NO-AGREEMENT                                  02119901
021200              IF  AP081-FSCL-YR-NBR = DTATTR-FSCL-YR-NBR          02120001
021210                  PERFORM W200-WRITE-YTD-RECORD                   02121001
021300                  IF  AP081-FSCL-QTR-NBR = DTATTR-FSCL-QTR-NBR    02130000
021400                      PERFORM W100-WRITE-QTD-RECORD               02140000
021500                  END-IF                                          02150000
021600              END-IF                                              02160000
021700         WHEN AP081-POST-CAL-QTR                                  02170000
021800         WHEN AP081-POST-CAL-SEMI-ANNL                            02180000
021900         WHEN AP081-POST-CAL-ANNL                                 02190000
022000              IF  AP081-CAL-YR-NBR = DTATTR-FSCL-YR-NBR           02200000
022100                  PERFORM W200-WRITE-YTD-RECORD                   02210000
022200                  IF  AP081-CAL-QTR-NBR = DTATTR-FSCL-QTR-NBR     02220000
022300                      PERFORM W100-WRITE-QTD-RECORD               02230000
022400                  END-IF                                          02240000
022500              END-IF                                              02250000
022600     END-EVALUATE.                                                02260000
022700                                                                  02270000
022800     PERFORM R100-READ-VNDAGR-ACTVTY-FILE.                        02280000
022900                                                                  02290000
023000*---------------------------------------------------------------* 02300000
023010*  CLOSE FILES AND PERFORM FINAL DISPLAYS.                        02301000
023020*---------------------------------------------------------------* 02302000
023030 B300-END-OF-JOB.                                                 02303000
023040                                                                  02304000
023050     CLOSE VNDAGR-ACTVTY-FILE                                     02305000
023060           QTD-REPORT-FILE                                        02306000
023070           YTD-REPORT-FILE                                        02307000
023071           QTD-DATES-FILE                                         02307100
023072           YTD-DATES-FILE.                                        02307200
023073                                                                  02307300
023074     DISPLAY 'ACTIVITY RECORDS READ = ' INPUT-COUNT.              02307400
023075     DISPLAY 'QTD REPORT RECORDS WRITTEN = ' OUT-QTD-COUNT.       02307500
023076     DISPLAY 'YTD REPORT RECORDS WRITTEN = ' OUT-YTD-COUNT.       02307600
023077                                                                  02307700
023078*----------------------------------------------------------------*02307800
023079*  R100-READ-VNDAGR-ACTVTY-FILE                                  *02307900
023080*  READS THE INPUT FILE INTO THE APRD081 COPYBOOK.               *02308000
023090*----------------------------------------------------------------*02309000
023100                                                                  02310000
023200 R100-READ-VNDAGR-ACTVTY-FILE.                                    02320000
023300                                                                  02330000
023400     READ VNDAGR-ACTVTY-FILE INTO AP081-VNDAGR-EXTRACT            02340000
023500         AT END                                                   02350000
023600            SET ACTVTY-EOF TO TRUE.                               02360000
023700                                                                  02370000
023800     IF NOT ACTVTY-EOF                                            02380000
023900        ADD 1 TO INPUT-COUNT                                      02390000
024000     END-IF.                                                      02400000
024100                                                                  02410000
024200                                                                  02420000
024300*----------------------------------------------------------------*02430000
024400*  SELECT GMA AND DMA NUMBERS FOR DEPT BEING PROCESSED.          *02440000
024500*----------------------------------------------------------------*02450000
024600 S100-SELECT-GMA-DMA-NBR.                                         02460000
024700                                                                  02470000
024800     EXEC SQL                                                     02480000
024900         SELECT GMA_NBR                                           02490000
025000              , DMA_NBR                                           02500000
025100           INTO :MDSEAR-GMA-NBR                                   02510000
025200              , :MDSEAR-DMA-NBR                                   02520000
025300           FROM TMDSEAR                                           02530000
025400          WHERE MDSELV_CDE = 'DPT'                                02540000
025500            AND DEPT_NBR   = :AP081-DEPT-NBR                      02550000
025600            AND CURRENT DATE BETWEEN STRT_DTE AND END_DTE         02560000
025700     END-EXEC.                                                    02570000
025800                                                                  02580000
025900     EVALUATE TRUE                                                02590000
026000         WHEN SQLCODE = ZERO                                      02600000
026100             CONTINUE                                             02610000
026200         WHEN SQLWARN0 NOT = SPACES                               02620000
026300         WHEN SQLCODE  NOT = ZERO                                 02630000
026400             DISPLAY 'AP081-DEPT-NBR  = ' AP081-DEPT-NBR          02640000
026500             MOVE 'S100-SELECT-GMA-DMA-NBR      '                 02650000
026600                                 TO WS-ABEND-PARAGRAPH            02660000
026700             MOVE 'UNSUCCESSFUL SELECT FROM TMDSEAR   '           02670000
026800                                 TO WS-ABEND-OPERATION            02680000
026900             MOVE 'TMDSEAR'      TO WS-ABEND-STRUCTURE-1          02690000
027000             MOVE SPACES         TO WS-ABEND-STRUCTURE-2          02700000
027100             PERFORM Z999-SQL-ERROR                               02710000
027200     END-EVALUATE.                                                02720000
027300                                                                  02730000
027400                                                                  02740000
027500*----------------------------------------------------------------*02750000
027600*  SELECT VENDOR NAME FOR ENT-ID BEING PROCESSED. THIS IS NEEDED *02760000
027700*  TO UPDATE HISTORICAL RECORDS BECAUSE NAMES CAN BE CHANGED.    *02770000
027800*----------------------------------------------------------------*02780000
027900 S200-SELECT-VENDOR-NAME.                                         02790000
028000                                                                  02800000
028100     EXEC SQL                                                     02810000
028200         SELECT ENT_NAME_DESC                                     02820000
028300           INTO :ENTNME-ENT-NAME-DESC                             02830000
028400           FROM TENTNME                                           02840000
028500          WHERE ENT_ID = :AP081-ENT-ID                            02850000
028600            AND TYPE_CDE = '01'                                   02860000
028700     END-EXEC.                                                    02870000
028800                                                                  02880000
028900     EVALUATE TRUE                                                02890000
029000         WHEN SQLCODE = ZERO                                      02900000
029100             CONTINUE                                             02910000
029200         WHEN SQLWARN0 NOT = SPACES                               02920000
029300         WHEN SQLCODE  NOT = ZERO                                 02930000
029400             MOVE AP081-ENT-ID TO DISPLAY-ENT-ID                  02940000
029500             DISPLAY 'AP081-VENDOR-NAME = ' AP081-VENDOR-NAME     02950000
029600                     ' AP081-ENT-ID = ' DISPLAY-ENT-ID            02960000
029700             MOVE 'S200-SELECT-VENDOR-NAME'                       02970000
029800                                 TO WS-ABEND-PARAGRAPH            02980000
029900             MOVE 'UNSUCCESSFUL SELECT FROM TENTNME   '           02990000
030000                                 TO WS-ABEND-OPERATION            03000000
030100             MOVE 'TENTNME'      TO WS-ABEND-STRUCTURE-1          03010000
030200             MOVE SPACES         TO WS-ABEND-STRUCTURE-2          03020000
030300             PERFORM Z999-SQL-ERROR                               03030000
030400     END-EVALUATE.                                                03040000
030500                                                                  03050000
030600*----------------------------------------------------------------*03060000
030700*  SELECT BATCH PROCESS DATE, CURR/PREV POSTING FISCAL YEAR,     *03070000
030800*  CURR/PREV POSTING FISCAL MONTH, AND CURR/PREV POSTING FISCAL  *03080000
030900*  WEEK FROM THE TAPCNTL TABLE, ALONG WITH THE FISCAL MONTH      *03090000
031000*  NUMBER FROM THE TDTATTR TABLE.                                *03100000
031100*----------------------------------------------------------------*03110000
031200 S400-SELECT-DATES.                                               03120000
031300                                                                  03130000
031400     EXEC SQL                                                     03140000
031500          SELECT A.BTCH_PRC_DTE                                   03150000
031600               , B.FSCL_MN_NBR                                    03160000
031700               , B.FSCL_YR_NBR                                    03170000
031800               , B.FSCL_QTR_NBR                                   03180000
031900               , B.CAL_MN_NBR                                     03190000
032000               , (CASE B.CAL_MN_NBR                               03200000
032100                  WHEN '01' THEN '1'                              03210000
032200                  WHEN '02' THEN '1'                              03220000
032300                  WHEN '03' THEN '1'                              03230000
032400                  WHEN '04' THEN '2'                              03240000
032500                  WHEN '05' THEN '2'                              03250000
032600                  WHEN '06' THEN '2'                              03260000
032700                  WHEN '07' THEN '3'                              03270000
032800                  WHEN '08' THEN '3'                              03280000
032900                  WHEN '09' THEN '3'                              03290000
033000                  WHEN '10' THEN '4'                              03300000
033100                  WHEN '11' THEN '4'                              03310000
033200                  WHEN '12' THEN '4'                              03320000
033300                  END)                                            03330000
033400               , (CASE B.CAL_MN_NBR                               03340000
033500                  WHEN '01' THEN CHAR(INTEGER(B.FSCL_YR_NBR)+ 1)  03350000
033600                  ELSE B.FSCL_YR_NBR                              03360000
033700                 END)                                             03370000
033800            INTO :APCNTL-BTCH-PRC-DTE                             03380000
033900               , :DTATTR-FSCL-MN-NBR                              03390000
034000               , :DTATTR-FSCL-YR-NBR                              03400000
034100               , :DTATTR-FSCL-QTR-NBR                             03410000
034200               , :DTATTR-CAL-MN-NBR                               03420000
034300               , :PV-CAL-QTR-NBR                                  03430000
034400               , :PV-CAL-YR-NBR                                   03440000
034500*****       FROM TKMA244.TAPCNTL A                                03450002
034600            FROM TAPCNTL A                                        03460002
034700               , TDTATTR B                                        03470000
034800           WHERE A.PREV_WK_END_DTE = B.KY_DTE                     03480000
034900     END-EXEC.                                                    03490000
035000                                                                  03500000
035100     EVALUATE TRUE                                                03510000
035200         WHEN SQLCODE = +0                                        03520000
035300              CONTINUE                                            03530000
035400                                                                  03540000
035500         WHEN SQLWARN0 NOT = SPACES                               03550000
035600         WHEN SQLCODE < +0                                        03560000
035700         WHEN SQLCODE > +0                                        03570000
035800              MOVE 'S400-SELECT-DATES' TO WS-ABEND-PARAGRAPH      03580000
035900              MOVE 'UNSUCCESSFUL SELECT DATES'                    03590000
036000                                       TO WS-ABEND-OPERATION      03600000
036100              MOVE 'TAPCNTL '          TO WS-ABEND-STRUCTURE-1    03610000
036200              MOVE 'TDTATTR '          TO WS-ABEND-STRUCTURE-2    03620000
036300              PERFORM Z999-SQL-ERROR                              03630000
036400     END-EVALUATE.                                                03640000
036500                                                                  03650000
036600     EXEC SQL                                                     03660000
036700         SELECT MIN(C.FSCL_MN_BEG_DTE)                            03670000
036800              , MAX(C.FSCL_MN_END_DTE)                            03680000
036900           INTO :PV-QTD-BEG-DTE                                   03690000
037000              , :PV-QTD-END-DTE                                   03700000
037100           FROM TDTATTR  C                                        03710000
037200          WHERE C.FSCL_QTR_NBR    = :DTATTR-FSCL-QTR-NBR          03720000
037300            AND C.FSCL_YR_NBR     = :DTATTR-FSCL-YR-NBR           03730000
037400     END-EXEC.                                                    03740000
037500                                                                  03750000
037600     EVALUATE TRUE                                                03760000
037700         WHEN SQLCODE = +0                                        03770000
037800              CONTINUE                                            03780000
037900                                                                  03790000
038000         WHEN SQLWARN0 NOT = SPACES                               03800000
038100         WHEN SQLCODE < +0                                        03810000
038200         WHEN SQLCODE > +0                                        03820000
038300              MOVE 'S400-SELECT-DATES' TO WS-ABEND-PARAGRAPH      03830000
038400              MOVE 'UNSUCCESSFUL QUARTER BEGIN/END'               03840000
038500                                       TO WS-ABEND-OPERATION      03850000
038600              MOVE 'TDTATTR '          TO WS-ABEND-STRUCTURE-1    03860000
038700              MOVE SPACE               TO WS-ABEND-STRUCTURE-2    03870000
038800              PERFORM Z999-SQL-ERROR                              03880000
038900     END-EVALUATE.                                                03890000
039000                                                                  03900000
039100     EXEC SQL                                                     03910000
039200         SELECT MIN(C.FSCL_MN_BEG_DTE)                            03920000
039300              , MAX(C.FSCL_MN_END_DTE)                            03930000
039400           INTO :PV-YTD-BEG-DTE                                   03940000
039500              , :PV-YTD-END-DTE                                   03950000
039600           FROM TDTATTR  C                                        03960000
039700          WHERE C.FSCL_YR_NBR     = :DTATTR-FSCL-YR-NBR           03970000
039800     END-EXEC.                                                    03980000
039900                                                                  03990000
040000     EVALUATE TRUE                                                04000000
040100         WHEN SQLCODE = +0                                        04010000
040200              CONTINUE                                            04020000
040300                                                                  04030000
040400         WHEN SQLWARN0 NOT = SPACES                               04040000
040500         WHEN SQLCODE < +0                                        04050000
040600         WHEN SQLCODE > +0                                        04060000
040700              MOVE 'S400-SELECT-DATES' TO WS-ABEND-PARAGRAPH      04070000
040800              MOVE 'UNSUCCESSFUL FSCL YEAR BEGIN/END'             04080000
040900                                       TO WS-ABEND-OPERATION      04090000
041000              MOVE 'TDTATTR '          TO WS-ABEND-STRUCTURE-1    04100000
041100              MOVE SPACE               TO WS-ABEND-STRUCTURE-2    04110000
041200              PERFORM Z999-SQL-ERROR                              04120000
041300     END-EVALUATE.                                                04130000
041400                                                                  04140000
041500*----------------------------------------------------------------*04150000
041600*  WRITES TO THE QUARTER TO DATE REPORT FILE.                    *04160000
041700*----------------------------------------------------------------*04170000
041800                                                                  04180000
041900 W100-WRITE-QTD-RECORD.                                           04190000
042000                                                                  04200000
042100     WRITE QTD-REPORT-RECORD FROM AP081-VNDAGR-EXTRACT.           04210000
042200                                                                  04220000
042300     ADD 1 TO OUT-QTD-COUNT.                                      04230000
042400                                                                  04240000
042500*----------------------------------------------------------------*04250000
042600*  WRITES TO THE YEAR TO DATE REPORT FILE.                       *04260000
042700*----------------------------------------------------------------*04270000
042800                                                                  04280000
042900 W200-WRITE-YTD-RECORD.                                           04290000
043000                                                                  04300000
043010     WRITE YTD-REPORT-RECORD FROM AP081-VNDAGR-EXTRACT.           04301000
043020                                                                  04302000
043030     ADD 1 TO OUT-YTD-COUNT.                                      04303000
043040                                                                  04304000
043050*----------------------------------------------------------------*04305000
043060*  WRITE THE QTD AND YTD DATES RECORDS.                          *04306000
043070*----------------------------------------------------------------*04307000
043080                                                                  04308000
043090 W300-WRITE-DATE-RECORDS.                                         04309000
043100                                                                  04310000
043200     MOVE PV-QTD-BEG-DTE TO REPORTING-BEGIN-DTE.                  04320000
043300     MOVE PV-QTD-END-DTE TO REPORTING-END-DTE.                    04330000
043400                                                                  04340000
043500     WRITE QTD-DATES-RECORD FROM REPORTING-DATES-RECORD.          04350000
043600                                                                  04360000
043700     MOVE PV-YTD-BEG-DTE TO REPORTING-BEGIN-DTE.                  04370000
043800     MOVE PV-YTD-END-DTE TO REPORTING-END-DTE.                    04380000
043900                                                                  04390000
044000     WRITE YTD-DATES-RECORD FROM REPORTING-DATES-RECORD.          04400000
044100                                                                  04410000
044200*----------------------------------------------------------------*04420000
044300*  GENERAL ABEND ROUTINE                                         *04430000
044400*----------------------------------------------------------------*04440000
044500 Z998-ABEND.                                                      04450000
044600                                                                  04460000
044700     DISPLAY WS-ABEND-LITERAL.                                    04470000
044800     DISPLAY WS-ABEND-PROGRAM-MSG.                                04480000
044900     DISPLAY WS-ABEND-PARAGRAPH-MSG.                              04490000
045000     DISPLAY WS-MESSAGE-LINE-1.                                   04500000
045100     DISPLAY WS-MESSAGE-LINE-2.                                   04510000
045200                                                                  04520000
045300     CALL 'ILBOABN0' USING ABEND-CODE.                            04530000
045400                                                                  04540000
045500*----------------------------------------------------------------*04550000
045600*  PROCESS DB2 ABENDS.                                           *04560000
045700*----------------------------------------------------------------*04570000
045800 Z999-SQL-ERROR.                                                  04580000
045900                                                                  04590000
046000     DISPLAY '*** DB2 ERROR '.                                    04600000
046100     DISPLAY WS-ABEND-PROGRAM-MSG.                                04610000
046200     DISPLAY WS-ABEND-PARAGRAPH-MSG.                              04620000
046300     DISPLAY WS-ABEND-OPERATION-MSG.                              04630000
046400     DISPLAY WS-ABEND-TABLE1-MSG.                                 04640000
046500     IF WS-ABEND-STRUCTURE-2 > SPACES                             04650000
046600         DISPLAY WS-ABEND-TABLE2-MSG.                             04660000
046700                                                                  04670000
046800     SET AP-DB2-ERROR              TO TRUE.                       04680000
046900                                                                  04690000
047000     COPY DPPD004.                                                04700000
047100     CALL 'ILBOABN0' USING ABEND-CODE.                            04710000
