000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.     APKUP236.                                        00020001
000300 AUTHOR.         KRYSTEN LEARY.                                   00030000
000400 DATE-WRITTEN.   MARCH 2006.                                      00040001
000500                                                                  00050000
000600****************************************************************  00060099
000700*    COBOL 2 WITH SQL                                          *  00070099
000800*--------------------------------------------------------------*  00080099
000810* THIS PROGRAM WILL DETERMINE WHICH PO/STORE COMBINATIONS      *  00081099
000820* HAVE DISCOUNTS RELATED TO THEM AND COMPARE THOSE TO THE      *  00082099
000830* DISCOUNTS FOUND ON THE INVOICE.  IF THE DISCOUNT DOES NOT    *  00083099
000840* EXIST ON THE INVOICE AND THE INVOICE DATE IS GREATER THAN    *  00084099
000841* THE FISCAL MONTH BEGINNING DATE ON THE ALLOWANCE, IT WILL    *  00084199
000842* BE APPLIED (ADDED TO THE TALCHRG TABLE FOR THAT INVOICE).    *  00084299
000900*--------------------------------------------------------------*  00090099
001300* INPUT:                                                       *  00130099
001400*  1. RELEASED PURCHASE ORDER/STORE TABLE     (TPOSTRR)        *  00140099
001500*  2. PURCHASE ORDER TABLE                    (TPURCHS)        *  00150099
001600*  3. VENDOR AGREEMENT TABLE                  (TVNDAGR)        *  00160099
002100*  4. INVOICE TABLE                           (TINVOIC)        *  00210099
002210*  6. AP CONTROL TABLE                        (TAPCNTL)        *  00221099
002220*  7. MERCHANDISE LEDGER - DATE RECORD        (TDTATTR)        *  00222099
002230*  8. CHECKPOINT RESTART CONTROL TABLE        (TCKRSTCN)       *  00223099
002240*  9. CHECKPOINT RESTART INFORMATION TABLE    (TCKRSTIN)       *  00224099
002300*                                                              *  00230099
002400* OUTPUT:                                                      *  00240099
002500* 1. INVOICE ALLOWANCE/CHARGE TABLE           (TALCHRG)        *  00250099
002700*--------------------------------------------------------------*  00270099
002800* CHANGE LOG:                                                  *  00280099
002900*                                                              *  00290099
003000*  06/08/2006                                                  *  00300099
003100*     CHANGE MADE: INITIAL IMPLEMENTATION.                     *  00310099
003200*  MADE BY: KRYSTEN LEARY              WR/IR#: WR30028         *  00320099
003210*                                                              *  00321099
003300*  06/12/2006                                                  *  00330099
003400*     CHANGE MADE: ADDED LOGIC TO DISPLAY THE POS AND          *  00340099
003410*     ALLOWANCES INSERTED INTO THE TALCHRG TABLE.  A           *  00341099
003420*     COUNT ON THE TOTAL NUMBER OF ALLOWANCES INSERTED WAS     *  00342099
003430*     ALSO ADDED.                                              *  00343099
003500*  MADE BY: KRYSTEN LEARY              WR/IR#: WR30028         *  00350099
003510*                                                              *  00351099
003600*  09/14/2006                                                  *  00360099
003700*     CHANGE MADE: REMOVED ALL RETRY LOGIC FROM PARAGRAPHS     *  00370099
003800*     S100-FETCH-PO-STR-CURSOR, S300-FETCH-VND-AGR-CURSOR, AND *  00380099
003900*     S400-FETCH-INVC-CURSOR.  ALSO INSERTED A SECOND CHECK FOR*  00390099
004000*     AN IMPORT PO IN PARAGRAPH B200-PROCESS-DATA.             *  00400099
004100*  MADE BY: KRYSTEN LEARY              WR/IR#: WR30042         *  00410099
004110*                                                              *  00411099
004200*  03/31/2007                                                  *  00420099
004300*     CHANGE MADE: ADDED PO 004533945 AND STORE 0855 TO THE    *  00430099
004400*     PO_STR_CSR CURSOR SO THAT THE PROGRAM WOULD FINISH.      *  00440099
004700*  MADE BY: KRYSTEN LEARY              WR/IR#: WR31939         *  00470099
004701*                                                              *  00470199
004710*  04/02/2007                                                  *  00471099
004720*     CHANGE MADE: ADDED THE ORDER BY CLAUSE TO THE PO_STR_CSR *  00472099
004730*     CURSOR SO THAT RESTARTS WOULD BE CLEANER.  INCLUDED THE  *  00473099
004731*     SQLCODE -811 IN THE LOGIC THAT HANDLES ZERO SQLCODES IN  *  00473199
004732*     PARAGRAPH S500-FETCH-ALCHRG-CODE.  THIS WAY IF THE       *  00473299
004733*     ALLOWANCE IS FOUND ON THE TALCHRG TABLE IT WILL BE       *  00473399
004734*     BYPASSED AND NOT ABEND THE PROGRAM.  LASTLY, ADDED THE   *  00473499
004735*     DISPLAY OF THE POSTRR-PO-NBR AND THE POSTRR-STR-NBR TO   *  00473599
004736*     THE Z998-ABEND AND Z999-DB2-ABEND ABEND PARAGRAPHS.      *  00473699
004740*  MADE BY: KRYSTEN LEARY              WR/IR#: P001001844      *  00474099
004741*                                                              *  00474199
004750*  04/03/2007                                                  *  00475099
004760*     CHANGE MADE: ADDED PO 004548617 AND STORE 0885 TO THE    *  00476099
004770*     PO_STR_CSR CURSOR SO THAT THE PROGRAM WOULD FINISH.      *  00477099
004780*  MADE BY: KRYSTEN LEARY              WR/IR#: WR31939         *  00478099
004790*                                                              *  00479099
004791*  04/04/2007                                                  *  00479199
004792*     CHANGE MADE: INCLUDED CHECKING THE -811 SQLCODE IN THE   *  00479299
004793*     PERFORM VARYING LOGIC OF PARAGRAPH                       *  00479399
004794*     S500-FETCH-ALCHRG-CODE.                                  *  00479499
004795*  MADE BY: KRYSTEN LEARY              WR/IR#: P001003069      *  00479599
004796*                                                              *  00479699
004800****************************************************************  00480099
004900                                                                  00490000
005000 ENVIRONMENT DIVISION.                                            00500000
005200 INPUT-OUTPUT SECTION.                                            00520000
005300                                                                  00530000
005400 FILE-CONTROL.                                                    00540000
005500                                                                  00550000
006200 DATA DIVISION.                                                   00620000
006400 FILE SECTION.                                                    00640000
006500                                                                  00650000
008000 WORKING-STORAGE SECTION.                                         00800000
008010*----------------------------------------------------------------*00801099
008020* SQLCA FORMATTED MESSAGE AREA                                   *00802000
008030*----------------------------------------------------------------*00803000
008040     COPY DPWS004.                                                00804000
008050                                                                  00805000
008102*----------------------------------------------------------------*00810200
008103*  COMMUNICATIONS AREA2 FOR DB2                                  *00810300
008104*----------------------------------------------------------------*00810400
008105     COPY SQLCA2.                                                 00810500
008106                                                                  00810600
008112 01  PROGRAM-CONSTANTS.                                           00811200
008130     05  PC-MAX-RETRIES                PIC 9(02)   VALUE 3.       00813099
008131     05  PC-PROGRAM-NAME               PIC X(08) VALUE 'APKUP236'.00813199
008133     05  PC-ALW-CHRG-TYP-CDE           PIC X(01)   VALUE 'A'.     00813399
008134     05  PC-ALW-CHRG-SER-CDE           PIC X(10)   VALUE SPACES.  00813499
008135     05  PC-ALW-CHRG-AMT               PIC S9(08)V9(2) COMP-3     00813599
008136                                                   VALUE ZERO.    00813699
008137     05  PC-IN-PROCESS-CODE            PIC X(01)   VALUE '9'.     00813799
008138     05  PC-RUN-COMPLETE-CODE          PIC X(01)   VALUE '0'.     00813899
008140                                                                  00814000
008153 01  PROGRAM-VARIABLES.                                           00815300
008154     05  PV-CKPT-STAT-CODE               PIC X(01)   VALUE SPACE. 00815499
008155     05  PV-CUTOFF-VNDAGR-DTE            PIC X(10)   VALUE SPACES.00815599
008156     05  PV-RETRY-COUNTER                PIC 9(02)   VALUE ZERO.  00815670
008163     05  PV-NEW-ALW-CHRG-SEQ-NBR         PIC S9(04)  COMP.        00816370
008164     05  PV-HOLD-ALPHA-TYP-CDE           PIC X(03)   VALUE SPACES.00816499
008167     05  PV-HOLD-VNDAGR-TBL-TYP-CDE      PIC X(03)   VALUE SPACES.00816799
008168     05  PV-HOLD-VNDAGR-TBL-DSCNT-PCT    PIC SV9(04) COMP-3.      00816899
008169     05  PV-HOLD-VNDAGR-TBL-FSCL-MN-DTE  PIC X(10)   VALUE SPACES.00816999
008170     05  PV-HOLD-VNDAGR-TBL-NSD-IND      PIC X(01)   VALUE SPACES.00817099
008171     05  PV-HOLD-FSCL-MNBEG-DTE          PIC X(10)                00817199
008172                                               VALUE '9999-09-09'.00817299
008173     05  PV-VNDAGR-CNT                   PIC 9(02)   VALUE ZERO.  00817399
008174     05  PV-ALCHRG-CNT                   PIC 9(02)   VALUE ZERO.  00817499
008175     05  INSERT-COUNT                    PIC 9(09)   VALUE ZERO.  00817599
008176     05  PV-DISPLAY-PO                   PIC 9(09)   VALUE ZERO.  00817699
008177     05  PV-CR-STR-NBR                   PIC 9(04)   VALUE ZERO.  00817799
008178                                                                  00817899
008179 01  PROGRAM-SWITCHES.                                            00817999
008180     05  WS-PO-STR-CSR-SW                PIC X(01)  VALUE 'N'.    00818099
008181         88  END-OF-PO-STR                          VALUE 'Y'.    00818199
008182         88  NOT-END-OF-PO-STR                      VALUE 'N'.    00818299
008183     05  WS-IMPORT-PO-SW                 PIC X(01)  VALUE 'N'.    00818399
008184         88  IMPORT-PO                              VALUE 'Y'.    00818499
008185         88  NOT-IMPORT-PO                          VALUE 'N'.    00818599
008186     05  WS-VND-AGR-CSR-SW               PIC X(01)  VALUE 'N'.    00818699
008187         88  END-OF-VND-AGR                         VALUE 'Y'.    00818799
008188         88  NOT-END-OF-VND-AGR                     VALUE 'N'.    00818899
008189     05  WS-INVC-CSR-SW                  PIC X(01)  VALUE 'N'.    00818999
008190         88  END-OF-INVC                            VALUE 'Y'.    00819099
008191         88  NOT-END-OF-INVC                        VALUE 'N'.    00819199
008192     05  WS-INSERT-ALCHRG-ROW-SW         PIC X(01)  VALUE 'N'.    00819299
008193         88  INSERT-ALCHRG-ROW                      VALUE 'Y'.    00819399
008194         88  DO-NOT-INSERT-ALCHRG-ROW               VALUE 'N'.    00819499
008195     05  WS-VNDAGR-DSCNT-PREV-FOUND-SW   PIC X(01)  VALUE 'N'.    00819599
008196         88  VNDAGR-DSCNT-PREV-FOUND                VALUE 'Y'.    00819699
008197         88  VNDAGR-DSCNT-NOT-PREV-FOUND            VALUE 'N'.    00819799
008198     05  WS-VNDAGR-POSTR-MTCH-FOUND-SW   PIC X(01)  VALUE 'N'.    00819899
008199         88  VNDAGR-POSTR-MTCH-FOUND                VALUE 'Y'.    00819999
008200         88  VNDAGR-POSTR-MTCH-NOT-FOUND            VALUE 'N'.    00820099
008210     05  WS-FIRST-VNDAGR-TBL-SEARCH-SW   PIC X(01)  VALUE 'N'.    00821099
008211         88  FIRST-VNDAGR-TBL-SEARCH                VALUE 'Y'.    00821199
008212         88  NOT-FIRST-VNDAGR-TBL-SEARCH            VALUE 'N'.    00821299
008213     05  WS-RUN-TYPE-SW                  PIC X(01)  VALUE ' '.    00821399
008214         88  NORMAL-RUN                             VALUE '0'.    00821499
008215         88  RESTART-RUN                            VALUE '9'.    00821599
008216                                                                  00821699
008217 01  VNDAGR-TABLE.                                                00821799
008218     05  VNDAGR-TBL OCCURS 100 TIMES INDEXED BY VNDAGR-IDX.       00821899
008219         10  VNDAGR-TBL-TYP-CDE         PIC X(03)    VALUE SPACES.00821999
008220         10  VNDAGR-TBL-DSCNT-PCT       PIC SV9(4)   COMP-3.      00822099
008221         10  VNDAGR-TBL-PO-NBR          PIC S9(09)   COMP.        00822199
008222         10  VNDAGR-TBL-STR-NBR         PIC S9(04)   COMP.        00822299
008223         10  VNDAGR-TBL-FSCL-MNBEG-DTE  PIC X(10)    VALUE SPACES.00822399
008224         10  VNDAGR-TBL-NSD-IND         PIC X(01)    VALUE SPACE. 00822499
008226                                                                  00822699
008227 01  DATE-WORK-AREA.                                              00822799
008228     05  SYSTEM-DATE                    PIC 9(06)    VALUE ZERO.  00822899
008229     05  FILLER REDEFINES SYSTEM-DATE.                            00822999
008230         10  SYSTEM-YEAR                PIC 9(02).                00823099
008231         10  SYSTEM-MONTH               PIC 9(02).                00823199
008232         10  SYSTEM-DAY                 PIC 9(02).                00823299
008233     05  SYSTEM-TIME                    PIC 9(08)    VALUE ZERO.  00823399
008234     05  FILLER REDEFINES SYSTEM-TIME.                            00823499
008235         10  SYSTEM-HOUR                PIC 9(02).                00823599
008236         10  SYSTEM-MINUTE              PIC 9(02).                00823699
008237         10  SYSTEM-SECOND              PIC 9(02).                00823799
008238         10  FILLER                     PIC 9(02).                00823899
008239                                                                  00823999
008240 01  CKPT-RESTART-INFO.                                           00824099
008250     05  CR-PO-NBR                    PIC S9(09) VALUE ZEROS COMP.00825099
008260     05  CR-STR-NBR                   PIC S9(04) VALUE ZEROS COMP.00826099
008270                                                                  00827099
008271 01  CKPT-RESTART-TMST.                                           00827199
008272     05  CR-CURR-TMST                 PIC X(26)  VALUE SPACES.    00827299
008273     05  CR-NEXT-TMST                 PIC X(26)  VALUE SPACES.    00827399
008274                                                                  00827499
008280*----------------------------------------------------------------*00828000
008300* DB2 ABEND AREA                                                 *00830000
008310*----------------------------------------------------------------*00831000
008400 01  ABEND-CODE                   PIC S9(4) COMP SYNC VALUE ZEROS.00840000
008700     88 AC-TABLE-OVERFLOW                   VALUE +4004.          00870005
008900     88 AC-DB2-ERROR                        VALUE +4013.          00890000
009000                                                                  00900000
009010 01  ABEND-AREAS.                                                 00901000
009020     05  AA-ABEND-LIT             PIC X(40) VALUE                 00902000
009030           '*****       ABEND'.                                   00903000
009040     05  AA-PROGRAM-LIT           PIC X(40) VALUE                 00904000
009050             '*****   PROGRAM: APKUP236'.                         00905006
009060     05  AA-PARAGRAPH-LIT.                                        00906000
009070         10  FILLER               PIC X(17) VALUE                 00907000
009080             '***** PARAGRAPH: '.                                 00908000
009090         10  AA-PARAGRAPH-NAME    PIC X(35) VALUE SPACES.         00909000
009091     05  AA-MESSAGE-LINE.                                         00909100
009092         10  FILLER               PIC X(06) VALUE '*****'.        00909200
009093         10  AA-MESSAGE           PIC X(127) VALUE SPACES.        00909300
009094     05  AA-DB2-ERROR-LIT         PIC X(40) VALUE                 00909400
009095             '*****    DB2 ERROR'.                                00909500
009096     05  AA-DB2-OPERATION-LIT.                                    00909600
009097         10  FILLER               PIC X(17) VALUE                 00909700
009098             '***** OPERATION: '.                                 00909800
009099         10  AA-DB2-OPERATION.                                    00909900
009100             15  AA-DB2-OP-1      PIC X(25) VALUE SPACES.         00910000
009101             15  AA-DB2-OP-2      PIC X(25) VALUE SPACES.         00910100
009102     05  AA-DB2-TABLE1            PIC X(08) VALUE SPACES.         00910200
009106                                                                  00910600
017600*--------------------------------------------------------------*  01760000
017700*  DB2 AREA FOR COMMUNICATIONS                                 *  01770000
017800*--------------------------------------------------------------*  01780000
017900     EXEC SQL                                                     01790000
018000          INCLUDE SQLCA                                           01800000
018100     END-EXEC.                                                    01810000
018200                                                                  01820000
018210*--------------------------------------------------------------*  01821000
018220*  RELEASED PURCHASE ORDER/STORE TABLE                         *  01822001
018230*--------------------------------------------------------------*  01823000
018240     EXEC SQL                                                     01824000
018250          INCLUDE TPOSTRR                                         01825001
018260     END-EXEC.                                                    01826000
018270                                                                  01827000
018300*--------------------------------------------------------------*  01830000
018400*  PURCHASE ORDER TABLE                                        *  01840000
018500*--------------------------------------------------------------*  01850000
018600     EXEC SQL                                                     01860000
018700          INCLUDE TPURCHS                                         01870000
018800     END-EXEC.                                                    01880000
018900                                                                  01890000
019000*--------------------------------------------------------------*  01900000
019100*  VENDOR AGREEMENT TABLE                                      *  01910001
019200*--------------------------------------------------------------*  01920000
019300     EXEC SQL                                                     01930000
019400          INCLUDE TVNDAGR                                         01940001
019500     END-EXEC.                                                    01950000
019600                                                                  01960000
022500*--------------------------------------------------------------*  02250000
022600*  INVOICE TABLE                                               *  02260001
022700*--------------------------------------------------------------*  02270000
022800     EXEC SQL                                                     02280000
022900          INCLUDE TINVOIC                                         02290001
023000     END-EXEC.                                                    02300000
023100                                                                  02310000
023200*--------------------------------------------------------------*  02320000
023300*  AP CONTROL TABLE                                            *  02330001
023400*--------------------------------------------------------------*  02340000
023500     EXEC SQL                                                     02350000
023600          INCLUDE TAPCNTL                                         02360001
023700     END-EXEC.                                                    02370000
023800                                                                  02380000
023810*--------------------------------------------------------------*  02381000
023820*  INVOICE ALLOWANCE/CHARGE TABLE                              *  02382001
023830*--------------------------------------------------------------*  02383000
023840     EXEC SQL                                                     02384000
023850          INCLUDE TALCHRG                                         02385001
023860     END-EXEC.                                                    02386000
023870                                                                  02387000
023880*--------------------------------------------------------------*  02388076
023890*  MERCHANDISE LEDGER - DATE RECORD                            *  02389076
023891*--------------------------------------------------------------*  02389176
023892     EXEC SQL                                                     02389276
023893          INCLUDE TDTATTR                                         02389376
023894     END-EXEC.                                                    02389476
023895                                                                  02389576
023896*--------------------------------------------------------------*  02389699
023897*  CHECKPOINT RESTART CONTROL TABLE                            *  02389799
023898*--------------------------------------------------------------*  02389899
023899     EXEC SQL                                                     02389999
023900          INCLUDE TCKRSTCN                                        02390099
023901     END-EXEC.                                                    02390199
023902                                                                  02390299
023903*--------------------------------------------------------------*  02390399
023904*  CHECKPOINT RESTART INFORMATION TABLE                        *  02390499
023905*--------------------------------------------------------------*  02390599
023906     EXEC SQL                                                     02390699
023907          INCLUDE TCKRSTIN                                        02390799
023908     END-EXEC.                                                    02390899
023909                                                                  02390999
023910*--------------------------------------------------------------*  02391000
024000* DECLARE PURCHASE ORDER/STORE CURSOR                          *  02400002
024100*--------------------------------------------------------------*  02410000
024200     EXEC SQL                                                     02420000
024300         DECLARE PO_STR_CSR CURSOR WITH HOLD FOR                  02430099
024400          SELECT PO_NBR                                           02440003
025700               , STR_NBR                                          02570003
027400            FROM TPOSTRR                                          02740003
027600           WHERE STATUS_CDE = ' '                                 02760003
027700          ORDER BY PO_NBR                                         02770099
027800                 , STR_NBR                                        02780099
028200         END-EXEC.                                                02820000
028300                                                                  02830000
028400*--------------------------------------------------------------*  02840003
028500* DECLARE VENDOR AGREEMENT CURSOR                              *  02850003
028600*--------------------------------------------------------------*  02860003
028700     EXEC SQL                                                     02870003
028800         DECLARE VND_AGR_CSR CURSOR FOR                           02880003
029001          SELECT DISCOUNT_PCT                                     02900113
029002               , TYP_CDE                                          02900231
029003               , EFFECTIVE_DATE                                   02900374
029100            FROM TVNDAGR                                          02910003
029200           WHERE ENT_ID = :PURCHS-ENT-ID                          02920010
029210             AND DEPT_NBR = :PURCHS-DEPT-NBR                      02921010
029220             AND AGRMT_TYP_ID = '5'                               02922003
029230             AND TYP_CDE IN (1,7,8,9,10,11)                       02923003
029240             AND :APCNTL-BTCH-PRC-DTE BETWEEN EFFECTIVE_DATE      02924007
029250                                          AND EXPIRATION_DATE     02925007
029251             AND EFFECTIVE_DATE >= :PV-CUTOFF-VNDAGR-DTE          02925199
029300         END-EXEC.                                                02930003
029400                                                                  02940003
029500*--------------------------------------------------------------*  02950008
029600* DECLARE INVOICE CURSOR                                       *  02960008
029700*--------------------------------------------------------------*  02970008
029800     EXEC SQL                                                     02980008
029810         DECLARE INVC_CSR CURSOR FOR                              02981008
029820          SELECT INVC_ID                                          02982008
029830               , PO_NBR                                           02983008
029840               , STR_NBR                                          02984008
029850               , INVC_DTE                                         02985075
029894            FROM TINVOIC                                          02989408
029895           WHERE PO_NBR = :POSTRR-PO-NBR                          02989510
029896             AND STR_NBR = :POSTRR-STR-NBR                        02989610
029897             AND STATUS_CDE = 'RL'                                02989773
029898             AND INVC_TYP_CDE = 'MI'                              02989873
029899             AND INVC_DTE >= :PV-HOLD-FSCL-MNBEG-DTE              02989999
029910         END-EXEC.                                                02991008
029920                                                                  02992008
031400*-----------------------*                                         03140000
031700 PROCEDURE DIVISION.                                              03170000
031800*-----------------------*                                         03180000
031900                                                                  03190000
032000     PERFORM B100-INITIALIZATION.                                 03200000
032200     PERFORM B200-PROCESS-DATA                                    03220015
032300         UNTIL END-OF-PO-STR.                                     03230010
032500     PERFORM B300-END-OF-JOB.                                     03250000
032700     GOBACK.                                                      03270000
032900                                                                  03290000
033000*--------------------------------------------------------------*  03300000
033100* INITIALIZATION PROCESSING                                    *  03310000
033200*--------------------------------------------------------------*  03320000
033300 B100-INITIALIZATION.                                             03330000
033500                                                                  03350000
033600     ACCEPT SYSTEM-DATE FROM DATE.                                03360013
033730     ACCEPT SYSTEM-TIME FROM TIME.                                03373013
033780     DISPLAY 'RUN DATE = ' SYSTEM-DATE.                           03378013
033790     DISPLAY 'RUN TIME = ' SYSTEM-TIME.                           03379013
033791                                                                  03379100
034000     INITIALIZE DCLTPOSTRR                                        03400002
034100                DCLTPURCHS                                        03410002
034600                DCLTVNDAGR                                        03460002
034700                DCLTINVOIC                                        03470002
034710                DCLTAPCNTL                                        03471002
034720                DCLTALCHRG                                        03472099
034730                DCLTCKRSTCNTL                                     03473099
034740                DCLTCKRSTINF.                                     03474099
035382     SET FIRST-VNDAGR-TBL-SEARCH        TO TRUE.                  03538299
035383                                                                  03538399
035400     PERFORM S050-GET-BATCH-DATE.                                 03540074
039700     PERFORM Y100-OPEN-PO-STR-CURSOR.                             03970002
039800                                                                  03980070
039900     PERFORM R100-GET-CHECKPOINT-CNTL.                            03990099
040000     MOVE PV-CKPT-STAT-CODE             TO WS-RUN-TYPE-SW.        04000099
040100     IF RESTART-RUN                                               04010099
040200        PERFORM R200-CHECKPOINT-RESTART                           04020099
040201     ELSE                                                         04020199
040210         PERFORM S100-FETCH-PO-STR-CURSOR                         04021099
040220         IF END-OF-PO-STR                                         04022099
040230          DISPLAY '** NO PURCHASE ORDERS/STORES FOUND ON TABLE **'04023099
040240         END-IF                                                   04024099
040300     END-IF.                                                      04030099
040400                                                                  04040099
040700*--------------------------------------------------------------*  04070000
040710* PROCESS PURCHASE ORDER/STORE COMBINATIONS                    *  04071002
040720*--------------------------------------------------------------*  04072000
040800 B200-PROCESS-DATA.                                               04080015
040900                                                                  04090000
041300     INITIALIZE VNDAGR-TABLE.                                     04130099
041320     SET VNDAGR-IDX TO 1.                                         04132068
041330                                                                  04133099
041800     IF NOT-IMPORT-PO                                             04180099
042000        PERFORM P100-PROCESS-TVNDAGR                              04200099
052923        IF VNDAGR-DSCNT-PREV-FOUND                                05292399
052925           PERFORM P200-PROCESS-TINVOIC                           05292599
052956           SET VNDAGR-DSCNT-NOT-PREV-FOUND      TO TRUE           05295699
052957           PERFORM R500-CHECKPOINT-COMMIT                         05295799
052958        ELSE                                                      05295899
052960           SET NOT-END-OF-VND-AGR               TO TRUE           05296099
052961           SET NOT-END-OF-INVC                  TO TRUE           05296199
052962           PERFORM S100-FETCH-PO-STR-CURSOR                       05296299
052963           IF NOT-IMPORT-PO                                       05296399
052965              PERFORM P100-PROCESS-TVNDAGR                        05296599
052966              PERFORM P200-PROCESS-TINVOIC                        05296699
052967           END-IF                                                 05296799
052968        END-IF                                                    05296899
052971     END-IF.                                                      05297136
052972                                                                  05297210
052973     PERFORM S100-FETCH-PO-STR-CURSOR.                            05297399
052974                                                                  05297499
052975** RESET SWITCHES FOR NEW PO/STORE COMBINATION                    05297599
052976     SET NOT-END-OF-VND-AGR                     TO TRUE.          05297699
052980     SET NOT-END-OF-INVC                        TO TRUE.          05298099
053000                                                                  05300015
057300*--------------------------------------------------------------*  05730000
057310* END OF JOB PROCESSING                                        *  05731000
057320*--------------------------------------------------------------*  05732000
057400 B300-END-OF-JOB.                                                 05740000
057410                                                                  05741099
057500     PERFORM Y400-CLOSE-PO-STR-CURSOR.                            05750099
057900                                                                  05790000
057910     MOVE PC-RUN-COMPLETE-CODE         TO PV-CKPT-STAT-CODE.      05791099
057920     PERFORM U100-UPDATE-TCKRSTCNTL.                              05792099
057921     PERFORM U200-UPDATE-TCKRSTINF.                               05792199
057930     PERFORM R400-COMMIT.                                         05793099
058400                                                                  05840000
058500*--------------------------------------------------------------*  05850099
058600* SEARCH THE VENDOR AGREEMENT INTERNAL TABLE.                  *  05860099
058700*--------------------------------------------------------------*  05870099
058800 C100-SEARCH-VNDAGR-TBL.                                          05880099
058900                                                                  05890099
058902** SET THE TABLE INDEX TO ONE IF IT IS THE FIRST TIME SEARCHING   05890299
058903** THE TABLE FOR THAT PO/STORE COMBINATION.  SET THE INDEX UP BY  05890399
058904** ONE WITH EACH SUBSEQUENT SEARCH FOR THAT PO/STORE COMBINATION  05890499
058905** SO THAT THE NEXT ALLOWANCE CODE IS FOUND.                      05890599
058907     IF FIRST-VNDAGR-TBL-SEARCH                                   05890799
058908        SET VNDAGR-IDX TO 1                                       05890899
058910     END-IF.                                                      05891099
058911                                                                  05891199
058915     SEARCH VNDAGR-TBL                                            05891599
058916        AT END                                                    05891699
058917           SET VNDAGR-POSTR-MTCH-NOT-FOUND     TO TRUE            05891799
058918        WHEN (VNDAGR-TBL-PO-NBR(VNDAGR-IDX) = POSTRR-PO-NBR       05891899
058919         AND  VNDAGR-TBL-STR-NBR(VNDAGR-IDX) = POSTRR-STR-NBR)    05891999
058920              SET VNDAGR-POSTR-MTCH-FOUND      TO TRUE            05892099
058921              MOVE VNDAGR-TBL-TYP-CDE(VNDAGR-IDX)                 05892199
058922                TO PV-HOLD-VNDAGR-TBL-TYP-CDE                     05892299
058925              MOVE VNDAGR-TBL-DSCNT-PCT(VNDAGR-IDX)               05892599
058926                TO PV-HOLD-VNDAGR-TBL-DSCNT-PCT                   05892699
058929              MOVE VNDAGR-TBL-FSCL-MNBEG-DTE(VNDAGR-IDX)          05892999
058930                TO PV-HOLD-VNDAGR-TBL-FSCL-MN-DTE                 05893099
058934              MOVE VNDAGR-TBL-NSD-IND(VNDAGR-IDX)                 05893499
058935                TO PV-HOLD-VNDAGR-TBL-NSD-IND                     05893599
058938                                                                  05893899
058939** SEARCH THE TALCHRG TABLE TO DETERMINE IF THE ALLOWANCE CODE    05893999
058940** EXISTS ON IT                                                   05894099
058941              PERFORM S500-FETCH-ALCHRG-CODE                      05894199
058942              SET NOT-FIRST-VNDAGR-TBL-SEARCH   TO TRUE           05894299
058943              SET VNDAGR-IDX UP BY 1                              05894399
058944     END-SEARCH.                                                  05894499
058950                                                                  05895099
059058*--------------------------------------------------------------*  05905815
059059* VERIFY THAT THE NEW STORE DISCOUNT INDICATOR IS SET TO 'Y'   *  05905999
059060* ON THE PURCHASE ORDER FOR NSD ALLOWANCE CODES.  IF THE       *  05906099
059061* INDICATOR IS NOT SET TO 'Y' THEN THE ALLOWANCE CODE SHOULD   *  05906199
059062* NOT BE INSERTED INTO THE TALCHRG TABLE.                      *  05906299
059063*--------------------------------------------------------------*  05906315
059064 C200-VERIFY-NSD-IND.                                             05906499
059065                                                                  05906515
059067     IF PV-HOLD-VNDAGR-TBL-TYP-CDE = 'NSD'                        05906799
059068        IF PV-HOLD-VNDAGR-TBL-NSD-IND = 'Y'                       05906899
059069           SET INSERT-ALCHRG-ROW                TO TRUE           05906915
059071        ELSE                                                      05907115
059072           SET DO-NOT-INSERT-ALCHRG-ROW             TO TRUE       05907299
059074        END-IF                                                    05907415
059075     ELSE                                                         05907535
059076        SET INSERT-ALCHRG-ROW                   TO TRUE           05907635
059078     END-IF.                                                      05907815
059079                                                                  05907935
059080*--------------------------------------------------------------*  05908031
059081* GET THE ALPHA EQUIVALENT FOR THE TYPE CODE                   *  05908131
059082*--------------------------------------------------------------*  05908231
059083 C300-GET-ALPHA-TYP-CDE.                                          05908399
059084                                                                  05908431
059086     INITIALIZE PV-HOLD-ALPHA-TYP-CDE.                            05908699
059087     EVALUATE VNDAGR-TYP-CDE                                      05908731
059088         WHEN 1                                                   05908831
059089            MOVE 'NSD'                   TO PV-HOLD-ALPHA-TYP-CDE 05908999
059090         WHEN 7                                                   05909031
059091            MOVE 'MOS'                   TO PV-HOLD-ALPHA-TYP-CDE 05909199
059092         WHEN 8                                                   05909231
059093            MOVE 'TRD'                   TO PV-HOLD-ALPHA-TYP-CDE 05909399
059094         WHEN 9                                                   05909431
059095            MOVE 'ADV'                   TO PV-HOLD-ALPHA-TYP-CDE 05909599
059096         WHEN 10                                                  05909631
059097            MOVE 'COP'                   TO PV-HOLD-ALPHA-TYP-CDE 05909799
059098         WHEN 11                                                  05909831
059099            MOVE 'ALW'                   TO PV-HOLD-ALPHA-TYP-CDE 05909999
059100     END-EVALUATE.                                                05910031
059101                                                                  05910131
059172*--------------------------------------------------------------*  05917214
059173* INSERT THE VENDOR AGREEMENT (TVNDAGR) ALLOWANCE CODE INTO THE*  05917399
059174* ALLOWANCE CHARGE TABLE (TALCHRG).                            *  05917499
059175*--------------------------------------------------------------*  05917514
059176 I100-INSERT-ALCHRG-RECORD.                                       05917614
059177                                                                  05917714
059199     EXEC SQL                                                     05919999
059200       INSERT INTO TALCHRG                                        05920099
059201              ( PO_NBR                                            05920199
059202              , INVC_ID                                           05920299
059203              , ALW_CHRG_SEQ_NBR                                  05920399
059204              , ALW_CHRG_TYP_CDE                                  05920499
059205              , ALW_CHRG_CDE                                      05920599
059206              , ALW_CHRG_SER_CDE                                  05920699
059207              , ALW_CHRG_PCT                                      05920799
059208              , ALW_CHRG_AMT)                                     05920899
059209       VALUES ( :POSTRR-PO-NBR                                    05920999
059210              , :INVOIC-INVC-ID                                   05921099
059211              , :PV-NEW-ALW-CHRG-SEQ-NBR                          05921199
059212              , :PC-ALW-CHRG-TYP-CDE                              05921299
059213              , :PV-HOLD-VNDAGR-TBL-TYP-CDE                       05921399
059214              , :PC-ALW-CHRG-SER-CDE                              05921499
059215              , :PV-HOLD-VNDAGR-TBL-DSCNT-PCT                     05921599
059216              , :PC-ALW-CHRG-AMT )                                05921699
059217     END-EXEC.                                                    05921799
059218                                                                  05921815
059219     EVALUATE TRUE                                                05921999
059220         WHEN SQLCODE = ZERO                                      05922099
059224           INITIALIZE WS-INSERT-ALCHRG-ROW-SW                     05922499
059225           ADD +1 TO INSERT-COUNT                                 05922599
059226           MOVE POSTRR-PO-NBR TO PV-DISPLAY-PO                    05922699
059227           DISPLAY 'ALLOWANCE TYPE ' PV-HOLD-VNDAGR-TBL-TYP-CDE   05922799
059228                   ' INSERTED FOR PO ' PV-DISPLAY-PO              05922899
059229         WHEN SQLWARN0 NOT = SPACES                               05922999
059230         WHEN SQLCODE NOT = ZERO                                  05923099
059231           MOVE 'I100-INSERT-ALCHRG-ROW'   TO AA-PARAGRAPH-NAME   05923199
059232           MOVE 'UNSUCCESSFUL INSERT FOR TALCHRG'                 05923299
059233                                           TO AA-DB2-OPERATION    05923399
059234           MOVE 'TALCHRG'                  TO AA-DB2-TABLE1       05923499
059235     END-EVALUATE.                                                05923599
059237                                                                  05923715
059246*--------------------------------------------------------------*  05924605
059247* LOAD THE VENDOR AGREEMENT INTERNAL TABLE WITH ALLOWANCES     *  05924799
059248*--------------------------------------------------------------*  05924805
059249  L100-LOAD-VNDAGR-INTERNAL-TBL.                                  05924905
059250                                                                  05925005
059251      IF NOT-END-OF-VND-AGR                                       05925132
059252         IF VNDAGR-IDX > 100                                      05925271
059253            MOVE 'L100-VNDAGR-INTERNAL-TBL' TO AA-PARAGRAPH-NAME  05925332
059254            MOVE 'VNDAGR TABLE EXCEEDS 100 ENTRIES'               05925471
059255                                            TO AA-MESSAGE         05925532
059256            SET AC-TABLE-OVERFLOW           TO TRUE               05925632
059257            PERFORM Z998-ABEND                                    05925732
059258         ELSE                                                     05925832
059259            PERFORM C300-GET-ALPHA-TYP-CDE                        05925999
059260            MOVE PV-HOLD-ALPHA-TYP-CDE                            05926099
059261              TO VNDAGR-TBL-TYP-CDE(VNDAGR-IDX)                   05926132
059264                                                                  05926496
059265            PERFORM S700-GET-FSCL-MNTH-BGN-DTE                    05926596
059266            MOVE DTATTR-FSCL-MN-BEG-DTE                           05926696
059267              TO VNDAGR-TBL-FSCL-MNBEG-DTE(VNDAGR-IDX)            05926796
059272                                                                  05927299
059273            IF DTATTR-FSCL-MN-BEG-DTE < PV-HOLD-FSCL-MNBEG-DTE    05927399
059274               MOVE DTATTR-FSCL-MN-BEG-DTE                        05927499
059275                 TO PV-HOLD-FSCL-MNBEG-DTE                        05927599
059278            END-IF                                                05927899
059279                                                                  05927996
059280            MOVE VNDAGR-DISCOUNT-PCT                              05928032
059281              TO VNDAGR-TBL-DSCNT-PCT(VNDAGR-IDX)                 05928132
059286            MOVE POSTRR-PO-NBR                                    05928632
059287              TO VNDAGR-TBL-PO-NBR(VNDAGR-IDX)                    05928732
059292            MOVE POSTRR-STR-NBR                                   05929278
059293              TO VNDAGR-TBL-STR-NBR(VNDAGR-IDX)                   05929378
059298            MOVE PURCHS-NEW-STR-PO-IND                            05929878
059299              TO VNDAGR-TBL-NSD-IND(VNDAGR-IDX)                   05929932
059300                                                                  05930099
059312            SET VNDAGR-IDX UP BY 1                                05931233
059313         END-IF                                                   05931333
059314      END-IF.                                                     05931432
059315                                                                  05931505
059316*--------------------------------------------------------------*  05931699
059317* PROCESS THE TVNDAGR DATA                                     *  05931799
059318*--------------------------------------------------------------*  05931899
059319 P100-PROCESS-TVNDAGR.                                            05931999
059320                                                                  05932099
059323     PERFORM Y200-OPEN-VND-AGR-CURSOR.                            05932399
059324     PERFORM S300-FETCH-VND-AGR-CURSOR                            05932499
059325        UNTIL END-OF-VND-AGR.                                     05932599
059326     PERFORM Y500-CLOSE-VND-AGR-CURSOR.                           05932699
059334                                                                  05933499
059335*--------------------------------------------------------------*  05933599
059336* PROCESS THE TINVOIC DATA                                     *  05933699
059337*--------------------------------------------------------------*  05933799
059338 P200-PROCESS-TINVOIC.                                            05933899
059339                                                                  05933999
059342     PERFORM Y300-OPEN-INVC-CURSOR.                               05934299
059343     PERFORM S400-FETCH-INVC-CURSOR                               05934399
059344        UNTIL END-OF-INVC.                                        05934499
059345     PERFORM Y600-CLOSE-INVC-CURSOR.                              05934599
059348                                                                  05934899
059378*--------------------------------------------------------------*  05937899
059379* SELECT CHECKPOINT RESTART CONTROL INFORMATION                *  05937999
059380*--------------------------------------------------------------*  05938099
059381 R100-GET-CHECKPOINT-CNTL.                                        05938199
059382                                                                  05938299
059383     PERFORM WITH TEST AFTER                                      05938399
059384        VARYING PV-RETRY-COUNTER FROM 1 BY 1                      05938499
059385          UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                 05938599
059386             OR SQLCODE = ZERO                                    05938699
059387                                                                  05938799
059388        EXEC SQL                                                  05938899
059389          SELECT CKPT_STAT_CODE                                   05938999
059390            INTO :PV-CKPT-STAT-CODE                               05939099
059391            FROM TCKRSTCNTL                                       05939199
059392           WHERE PLAN_NAME = :PC-PROGRAM-NAME                     05939299
059393        END-EXEC                                                  05939399
059394                                                                  05939499
059395        EVALUATE TRUE                                             05939599
059396          WHEN SQLCODE = ZERO                                     05939699
059397          WHEN SQLCODE = -904                                     05939799
059398          WHEN SQLCODE = -913                                     05939899
059399            CONTINUE                                              05939999
059400          WHEN SQLWARN0 NOT = SPACES                              05940099
059401          WHEN SQLCODE NOT = ZERO                                 05940199
059402            MOVE 'R100-GET-CHECKPOINT-CNTL'                       05940299
059403              TO AA-PARAGRAPH-NAME                                05940399
059404            MOVE 'UNSUCCESSFUL SELECT'     TO AA-DB2-OPERATION    05940499
059405            MOVE 'TCKRSTCNTL'              TO AA-DB2-TABLE1       05940599
059406            PERFORM Z999-DB2-ABEND                                05940699
059407        END-EVALUATE                                              05940799
059408     END-PERFORM.                                                 05940899
059409                                                                  05940999
059410     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         05941099
059411        MOVE 'R100-GET-CHECKPOINT-CNTL'     TO AA-PARAGRAPH-NAME  05941199
059412        MOVE 'MAX RETRIES EXCEEDED ON SELECT'                     05941299
059413          TO AA-DB2-OPERATION                                     05941399
059414        MOVE 'TCKRSTCNTL'                   TO AA-DB2-TABLE1      05941499
059415        PERFORM Z999-DB2-ABEND                                    05941599
059416     END-IF.                                                      05941699
059417                                                                  05941799
059418*--------------------------------------------------------------*  05941899
059419* GET THE RESTART INFORMATION                                  *  05941999
059420*--------------------------------------------------------------*  05942099
059421 R200-CHECKPOINT-RESTART.                                         05942199
059422                                                                  05942299
059423     PERFORM R300-GET-CHECKPOINT-INFO.                            05942399
059424     MOVE TCKRSTINF-WORK-STRG-DESC-TEXT  TO CKPT-RESTART-INFO.    05942499
059425     MOVE CR-PO-NBR                      TO PV-DISPLAY-PO.        05942599
059426     MOVE CR-STR-NBR                     TO PV-CR-STR-NBR.        05942699
059427                                                                  05942799
059428     DISPLAY '***********************************************'.   05942899
059429     DISPLAY '**       APKUP236 CHECKPOINT RESTART         **'.   05942999
059430     DISPLAY '** LAST PO NUMBER PROCESSED = '    PV-DISPLAY-PO.   05943099
059431     DISPLAY '** LAST STORE NUMBER PROCESSED = ' PV-CR-STR-NBR.   05943199
059432     DISPLAY '***********************************************'.   05943299
059433                                                                  05943399
059434     PERFORM S100-FETCH-PO-STR-CURSOR                             05943499
059435           WITH TEST AFTER                                        05943599
059436                UNTIL END-OF-PO-STR                               05943699
059437                  OR  POSTRR-PO-NBR > CR-PO-NBR                   05943799
059438                  OR (POSTRR-PO-NBR = CR-PO-NBR AND               05943899
059439                      POSTRR-STR-NBR > CR-STR-NBR).               05943999
059440                                                                  05944099
059441     DISPLAY '***********************************************'.   05944199
059442     DISPLAY '**       APKUP236 CHECKPOINT RESTART         **'.   05944299
059443     DISPLAY '** PO NUMBER ON RESTART = '    POSTRR-PO-NBR.       05944399
059444     DISPLAY '** STORE NUMBER ON RESTART = ' POSTRR-STR-NBR.      05944499
059445     DISPLAY '***********************************************'.   05944599
059446                                                                  05944699
059447*--------------------------------------------------------------*  05944799
059448* SELECT CHECKPOINT RESTART WORKING STORAGE DESCRIPTION        *  05944899
059449* INFORMATION                                                  *  05944999
059450*--------------------------------------------------------------*  05945099
059451 R300-GET-CHECKPOINT-INFO.                                        05945199
059452                                                                  05945299
059453     PERFORM WITH TEST AFTER                                      05945399
059454        VARYING PV-RETRY-COUNTER FROM 1 BY 1                      05945499
059455          UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                 05945599
059456             OR SQLCODE = ZERO                                    05945699
059457                                                                  05945799
059458        EXEC SQL                                                  05945899
059459           SELECT WORK_STRG_DESC                                  05945999
059460             INTO :TCKRSTINF-WORK-STRG-DESC                       05946099
059461             FROM TCKRSTINF                                       05946199
059462            WHERE PLAN_NAME = :PC-PROGRAM-NAME                    05946299
059463        END-EXEC                                                  05946399
059464                                                                  05946499
059465        EVALUATE TRUE                                             05946599
059466          WHEN SQLCODE = ZERO                                     05946699
059467          WHEN SQLCODE = -904                                     05946799
059468          WHEN SQLCODE = -913                                     05946899
059469            CONTINUE                                              05946999
059470          WHEN SQLWARN0 NOT = SPACES                              05947099
059471          WHEN SQLCODE NOT = ZERO                                 05947199
059472            MOVE 'R300-GET-CHECKPOINT-INFO' TO AA-PARAGRAPH-NAME  05947299
059473            MOVE 'UNSUCCESSFUL SELECT'      TO AA-DB2-OPERATION   05947399
059474            MOVE 'TCKRSTINF'                TO AA-DB2-TABLE1      05947499
059475            PERFORM Z999-DB2-ABEND                                05947599
059476        END-EVALUATE                                              05947699
059477     END-PERFORM.                                                 05947799
059478                                                                  05947899
059479     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         05947999
059480        MOVE 'R300-GET-CHECKPOINT-INFO'   TO AA-PARAGRAPH-NAME    05948099
059481        MOVE 'MAX RETRIES EXCEEDED ON SELECT'                     05948199
059482                                          TO AA-DB2-OPERATION     05948299
059483        MOVE 'TCKRSTINF'                  TO AA-DB2-TABLE1        05948399
059484        PERFORM Z999-DB2-ABEND                                    05948499
059485     END-IF.                                                      05948599
059486                                                                  05948699
059487*--------------------------------------------------------------*  05948799
059488* ISSUES AN SQL COMMIT                                         *  05948899
059489*--------------------------------------------------------------*  05948999
059490 R400-COMMIT.                                                     05949099
059491                                                                  05949199
059492     EXEC SQL                                                     05949299
059493        COMMIT                                                    05949399
059494     END-EXEC.                                                    05949499
059495                                                                  05949599
059496     EVALUATE TRUE                                                05949699
059497       WHEN SQLCODE = ZERO                                        05949799
059498         CONTINUE                                                 05949899
059499       WHEN OTHER                                                 05949999
059500         MOVE 'R400-COMMIT'          TO AA-PARAGRAPH-NAME         05950099
059501         MOVE 'UNSUCCESSFUL COMMIT'  TO AA-DB2-OPERATION          05950199
059502         MOVE SPACES                 TO AA-DB2-TABLE1             05950299
059503         PERFORM Z999-DB2-ABEND                                   05950399
059504     END-EVALUATE.                                                05950499
059505                                                                  05950599
059506*--------------------------------------------------------------*  05950699
059507* PERFORM THE CHECKPOINT RESTART AND COMMIT                    *  05950799
059508*--------------------------------------------------------------*  05950899
059509 R500-CHECKPOINT-COMMIT.                                          05950999
059510                                                                  05951099
059511     EXEC SQL                                                     05951199
059512       SET :CR-CURR-TMST = CURRENT TIMESTAMP                      05951299
059513     END-EXEC.                                                    05951399
059514                                                                  05951499
059515     EVALUATE TRUE                                                05951599
059516       WHEN SQLCODE = ZERO                                        05951699
059517         CONTINUE                                                 05951799
059518       WHEN SQLWARN0 NOT = SPACES                                 05951899
059519       WHEN SQLCODE NOT = ZERO                                    05951999
059520         MOVE 'R500-CHECKPOINT-COMMIT'   TO AA-PARAGRAPH-NAME     05952099
059521         MOVE 'UNSUCCESSFUL SET TMST'    TO AA-DB2-OPERATION      05952199
059522         MOVE SPACES                     TO AA-DB2-TABLE1         05952299
059523         PERFORM Z999-DB2-ABEND                                   05952399
059524     END-EVALUATE.                                                05952499
059525                                                                  05952599
059526     IF CR-CURR-TMST > CR-NEXT-TMST                               05952699
059527        MOVE PC-IN-PROCESS-CODE            TO PV-CKPT-STAT-CODE   05952799
059528        PERFORM U100-UPDATE-TCKRSTCNTL                            05952899
059529        PERFORM U200-UPDATE-TCKRSTINF                             05952999
059530        PERFORM R400-COMMIT                                       05953099
059531                                                                  05953199
059532        EXEC SQL                                                  05953299
059533          SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)    05953399
059534            INTO :CR-NEXT-TMST                                    05953499
059535            FROM TCKRSTCNTL                                       05953599
059536           WHERE PLAN_NAME = :PC-PROGRAM-NAME                     05953699
059537        END-EXEC                                                  05953799
059538                                                                  05953899
059539        EVALUATE TRUE                                             05953999
059540          WHEN SQLCODE = ZERO                                     05954099
059541            CONTINUE                                              05954199
059542          WHEN SQLWARN0 NOT = SPACES                              05954299
059543          WHEN SQLCODE NOT = ZERO                                 05954399
059544            MOVE 'R500-CHECKPOINT-COMMIT'   TO AA-PARAGRAPH-NAME  05954499
059545            MOVE 'UNSUCCESSFUL SELECT'      TO AA-DB2-OPERATION   05954599
059546            MOVE 'TCKRSTCNTL'               TO AA-DB2-TABLE1      05954699
059547            PERFORM Z999-DB2-ABEND                                05954799
059548        END-EVALUATE                                              05954899
059549     END-IF.                                                      05954999
059550                                                                  05955099
059551*--------------------------------------------------------------*  05955100
059552* GET THE CURRENT DATE AND THE DATE TWO MONTHS PRIOR TO THE    *  05955299
059553* CURRENT DATE.  THIS IS THE DATE USED TO LIMIT THE VENDOR     *  05955399
059554* AGREEMENT ALLOWANCES RETURNED IN THE VND_AGR_CSR.            *  05955499
059555*--------------------------------------------------------------*  05955500
059556 S050-GET-BATCH-DATE.                                             05955674
059557                                                                  05955704
059558     PERFORM WITH TEST AFTER                                      05955804
059559        VARYING PV-RETRY-COUNTER FROM 1 BY 1                      05955904
059560          UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                 05956004
059561             OR SQLCODE = ZERO                                    05956104
059562             OR SQLCODE = +100                                    05956204
059563                                                                  05956304
059564        EXEC SQL                                                  05956404
059565           SELECT BTCH_PRC_DTE                                    05956504
059566                , BTCH_PRC_DTE - 60 DAYS                          05956699
059567             INTO :APCNTL-BTCH-PRC-DTE                            05956704
059568                , :PV-CUTOFF-VNDAGR-DTE                           05956899
059569             FROM TAPCNTL                                         05956904
059570        END-EXEC                                                  05957004
059571                                                                  05957104
059572        EVALUATE TRUE                                             05957204
059573           WHEN SQLCODE = ZERO                                    05957304
059574           WHEN SQLCODE = -904                                    05957404
059575           WHEN SQLCODE = -912                                    05957504
059576             CONTINUE                                             05957604
059577           WHEN SQLWARN0 NOT = SPACES                             05957704
059578           WHEN SQLCODE NOT = ZERO                                05957804
059579             MOVE 'S050-GET-BATCH-DATE'  TO AA-PARAGRAPH-NAME     05957974
059580             MOVE 'UNSUCCESSFUL SELECT TAPCNTL'                   05958004
059581                                         TO AA-DB2-OPERATION      05958104
059582             MOVE 'TAPCNTL'              TO AA-DB2-TABLE1         05958204
059583             PERFORM Z999-DB2-ABEND                               05958304
059584        END-EVALUATE                                              05958404
059585     END-PERFORM.                                                 05958504
059586                                                                  05958604
059587     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         05958704
059588        MOVE 'S050-GET-BATCH-DATE'       TO AA-PARAGRAPH-NAME     05958874
059589        MOVE 'MAX RETRIES EXCEEDED ON SELECT TAPCNTL'             05958904
059590                                         TO AA-DB2-OPERATION      05959004
059591        MOVE 'TAPCNTL'                   TO AA-DB2-TABLE1         05959104
059592        PERFORM Z999-DB2-ABEND                                    05959204
059593     END-IF.                                                      05959304
059594                                                                  05959499
059595*--------------------------------------------------------------*  05959500
059596* FETCH PO_STR_CSR CURSOR                                      *  05959602
059597*--------------------------------------------------------------*  05959700
059598 S100-FETCH-PO-STR-CURSOR.                                        05959802
059599                                                                  05959900
059700     EXEC SQL                                                     05970099
059800         FETCH PO_STR_CSR                                         05980099
059900          INTO :POSTRR-PO-NBR                                     05990099
061200             , :POSTRR-STR-NBR                                    06120099
062900     END-EXEC.                                                    06290099
063000                                                                  06300000
063100     EVALUATE TRUE                                                06310099
063200       WHEN SQLCODE = ZERO                                        06320099
063320         PERFORM S200-FETCH-TPURCHS-INFO                          06332099
063400       WHEN SQLCODE = +100                                        06340099
063500         SET END-OF-PO-STR                 TO TRUE                06350099
063900       WHEN SQLWARN0 NOT = SPACES                                 06390099
064000       WHEN SQLCODE  NOT = ZERO                                   06400099
064100         MOVE 'S100-FETCH-PO-STR-CURSOR'   TO AA-PARAGRAPH-NAME   06410099
064300         MOVE 'UNSUCCESSFUL FETCH'         TO AA-DB2-OPERATION    06430099
064500         MOVE 'TPOSTRR'                    TO AA-DB2-TABLE1       06450099
064700         PERFORM Z999-DB2-ABEND                                   06470099
064800     END-EVALUATE.                                                06480099
065000                                                                  06500000
066026*--------------------------------------------------------------*  06602600
066027* FETCH PURCHASE ORDER INFORMATION                             *  06602703
066028*--------------------------------------------------------------*  06602800
066029 S200-FETCH-TPURCHS-INFO.                                         06602915
066030                                                                  06603000
066033     PERFORM WITH TEST AFTER                                      06603300
066034         VARYING PV-RETRY-COUNTER FROM 1 BY 1                     06603400
066035           UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                06603500
066036              OR SQLCODE = ZERO                                   06603600
066037                                                                  06603700
066038         EXEC SQL                                                 06603800
066039             SELECT PO_NBR                                        06603903
066040                  , ENT_ID                                        06604003
066041                  , DEPT_NBR                                      06604103
066042                  , NEW_STR_PO_IND                                06604203
066043                  , PO_TYP_CDE                                    06604399
066044               INTO :PURCHS-PO-NBR                                06604403
066045                  , :PURCHS-ENT-ID                                06604503
066046                  , :PURCHS-DEPT-NBR                              06604603
066047                  , :PURCHS-NEW-STR-PO-IND                        06604703
066048                  , :PURCHS-PO-TYP-CDE                            06604899
066049               FROM TPURCHS                                       06604903
066050              WHERE PO_NBR = :POSTRR-PO-NBR                       06605015
066051                AND VER_STATUS_CDE = 'A'                          06605103
066052         END-EXEC                                                 06605200
066053                                                                  06605300
066054         EVALUATE TRUE                                            06605400
066055            WHEN SQLCODE = ZERO                                   06605500
066056              IF PURCHS-PO-TYP-CDE = 'IM' OR 'IE' OR 'IF'         06605699
066057                 SET IMPORT-PO                TO TRUE             06605799
066060              ELSE                                                06606099
066062                 SET NOT-IMPORT-PO            TO TRUE             06606299
066065              END-IF                                              06606599
066069            WHEN SQLCODE = -904                                   06606900
066070            WHEN SQLCODE = -913                                   06607000
066076              CONTINUE                                            06607600
066077            WHEN OTHER                                            06607700
066078              MOVE 'S200-FETCH-TPURCHS-INFO'  TO AA-PARAGRAPH-NAME06607815
066079              MOVE 'PO NBR NOT FOUND ON TPURCHS TABLE'            06607903
066080                                              TO AA-DB2-OPERATION 06608015
066081              MOVE 'TPURCHS'                  TO AA-DB2-TABLE1    06608115
066082              PERFORM Z999-DB2-ABEND                              06608200
066083         END-EVALUATE                                             06608300
066084     END-PERFORM.                                                 06608400
066085                                                                  06608500
066086     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         06608600
066087        MOVE 'S200-FETCH-TPURCHS-INFO'   TO AA-PARAGRAPH-NAME     06608715
066088        MOVE 'MAX RETRIES EXCEEDED ON SELECT'                     06608899
066089                                         TO AA-DB2-OPERATION      06608915
066090        MOVE 'TPURCHS'                   TO AA-DB2-TABLE1         06609015
066091        PERFORM Z999-DB2-ABEND                                    06609100
066092     END-IF.                                                      06609200
066093                                                                  06609300
066094*--------------------------------------------------------------*  06609404
066095* FETCH VND_AGR_CSR CURSOR                                     *  06609504
066096*--------------------------------------------------------------*  06609604
066097 S300-FETCH-VND-AGR-CURSOR.                                       06609704
066098                                                                  06609804
066107     EXEC SQL                                                     06610799
066108         FETCH VND_AGR_CSR                                        06610899
066109          INTO :VNDAGR-DISCOUNT-PCT                               06610999
066110             , :VNDAGR-TYP-CDE                                    06611099
066111             , :VNDAGR-EFFECTIVE-DATE                             06611199
066112     END-EXEC.                                                    06611299
066113                                                                  06611304
066114     EVALUATE TRUE                                                06611499
066115       WHEN SQLCODE = ZERO                                        06611599
066119         SET VNDAGR-DSCNT-PREV-FOUND       TO TRUE                06611999
066121         PERFORM L100-LOAD-VNDAGR-INTERNAL-TBL                    06612199
066122         ADD 1                             TO PV-VNDAGR-CNT       06612299
066124       WHEN SQLCODE = +100                                        06612499
066126        SET END-OF-VND-AGR                TO TRUE                 06612699
066131       WHEN SQLWARN0 NOT = SPACES                                 06613199
066132       WHEN SQLCODE  NOT = ZERO                                   06613299
066133         MOVE 'S300-FETCH-VND-AGR-CURSOR'  TO AA-PARAGRAPH-NAME   06613399
066134         MOVE 'UNSUCCESSFUL FETCH'         TO AA-DB2-OPERATION    06613499
066135         MOVE 'TVNDAGR'                    TO AA-DB2-TABLE1       06613599
066136         PERFORM Z999-DB2-ABEND                                   06613699
066137     END-EVALUATE.                                                06613799
066147                                                                  06614704
066148*--------------------------------------------------------------*  06614810
066149* FETCH INVC_CSR CURSOR                                        *  06614910
066150*--------------------------------------------------------------*  06615010
066151 S400-FETCH-INVC-CURSOR.                                          06615110
066152                                                                  06615210
066160     EXEC SQL                                                     06616099
066161         FETCH INVC_CSR                                           06616199
066162          INTO :INVOIC-INVC-ID                                    06616299
066163             , :INVOIC-PO-NBR                                     06616399
066164             , :INVOIC-STR-NBR                                    06616499
066165             , :INVOIC-INVC-DTE                                   06616599
066166     END-EXEC.                                                    06616699
066167                                                                  06616710
066168     EVALUATE TRUE                                                06616899
066169       WHEN SQLCODE = ZERO                                        06616999
066176         PERFORM C100-SEARCH-VNDAGR-TBL                           06617699
066177           UNTIL PV-VNDAGR-CNT EQUAL PV-ALCHRG-CNT                06617799
066180         SET FIRST-VNDAGR-TBL-SEARCH       TO TRUE                06618099
066190         INITIALIZE PV-ALCHRG-CNT                                 06619099
066192       WHEN SQLCODE = +100                                        06619299
066194         SET END-OF-INVC                   TO TRUE                06619499
066195         INITIALIZE PV-VNDAGR-CNT                                 06619599
066200       WHEN SQLWARN0 NOT = SPACES                                 06620099
066201       WHEN SQLCODE  NOT = ZERO                                   06620199
066202         MOVE 'S400-FETCH-INVC-CURSOR'     TO AA-PARAGRAPH-NAME   06620299
066203         MOVE 'UNSUCCESSFUL FETCH'         TO AA-DB2-OPERATION    06620399
066204         MOVE 'TINVOIC'                    TO AA-DB2-TABLE1       06620499
066205         PERFORM Z999-DB2-ABEND                                   06620599
066206     END-EVALUATE.                                                06620699
066216                                                                  06621699
066217*--------------------------------------------------------------*  06621799
066218* FETCH THE ALLOWANCE CODE                                     *  06621899
066219*--------------------------------------------------------------*  06621999
066220 S500-FETCH-ALCHRG-CODE.                                          06622099
066221                                                                  06622199
066224     PERFORM WITH TEST AFTER                                      06622499
066225        VARYING PV-RETRY-COUNTER FROM 1 BY 1                      06622599
066226          UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                 06622699
066227             OR SQLCODE = ZERO                                    06622799
066228             OR SQLCODE = -811                                    06622899
066229             OR SQLCODE = +100                                    06622999
066230                                                                  06623099
066231        EXEC SQL                                                  06623199
066232            SELECT PO_NBR                                         06623299
066233                 , INVC_ID                                        06623399
066234                 , ALW_CHRG_CDE                                   06623499
066235              INTO :ALCHRG-PO-NBR                                 06623599
066236                 , :ALCHRG-INVC-ID                                06623699
066237                 , :ALCHRG-ALW-CHRG-CDE                           06623799
066238              FROM TALCHRG                                        06623899
066239             WHERE PO_NBR = :POSTRR-PO-NBR                        06623999
066240               AND INVC_ID = :INVOIC-INVC-ID                      06624099
066241               AND ALW_CHRG_TYP_CDE = 'A'                         06624199
066242               AND ALW_CHRG_CDE = :PV-HOLD-VNDAGR-TBL-TYP-CDE     06624299
066243        END-EXEC                                                  06624399
066244                                                                  06624499
066245        EVALUATE TRUE                                             06624599
066246           WHEN SQLCODE = ZERO                                    06624699
066247           WHEN SQLCODE = -811                                    06624799
066248             ADD 1                         TO PV-ALCHRG-CNT       06624899
066249           WHEN SQLCODE = -904                                    06624999
066250           WHEN SQLCODE = -913                                    06625099
066251             CONTINUE                                             06625199
066252           WHEN SQLCODE = +100                                    06625299
066253             PERFORM C200-VERIFY-NSD-IND                          06625399
066254             IF INSERT-ALCHRG-ROW                                 06625499
066255** INSERT THE ALLOWANCE CODE INTO THE TALCHRG TABLE ONLY IF THE   06625599
066256** INVOICE DATE IS GREATER THAN OR EQUAL TO THE FISCAL MONTH      06625699
066257** BEGINNING DATE                                                 06625799
066258                IF INVOIC-INVC-DTE >=                             06625899
066259                   PV-HOLD-VNDAGR-TBL-FSCL-MN-DTE                 06625999
066260                   PERFORM S600-SELECT-MAX-SEQ-NBR                06626099
066261                   PERFORM I100-INSERT-ALCHRG-RECORD              06626199
066262                END-IF                                            06626299
066263             END-IF                                               06626399
066264             ADD 1                         TO PV-ALCHRG-CNT       06626499
066266        END-EVALUATE                                              06626699
066267     END-PERFORM.                                                 06626799
066268                                                                  06626899
066269     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         06626999
066270        MOVE 'S500-FETCH-ALCHRG-CODE'      TO AA-PARAGRAPH-NAME   06627099
066271        MOVE 'MAX RETRIES EXCEEDED ON FETCH'                      06627199
066272                                           TO AA-DB2-OPERATION    06627299
066273        MOVE 'TALCHRG'                     TO AA-DB2-TABLE1       06627399
066274        PERFORM Z999-DB2-ABEND                                    06627499
066275     END-IF.                                                      06627599
066280                                                                  06628099
066328*--------------------------------------------------------------*  06632826
066329* SELECT MAXIMUM ALW_CHRG_SEQ_NBR.  ONE WILL BE ADDED TO THIS  *  06632999
066330* NUMBER FOR THE INSERT OF THE NEW ALLOWANCE CODE INTO THE     *  06633099
066331* TALCHRG TABLE.                                               *  06633199
066332*--------------------------------------------------------------*  06633226
066333 S600-SELECT-MAX-SEQ-NBR.                                         06633326
066334                                                                  06633426
066336     PERFORM WITH TEST AFTER                                      06633626
066337        VARYING PV-RETRY-COUNTER FROM 1 BY 1                      06633726
066338          UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                 06633826
066339             OR SQLCODE = ZERO                                    06633926
066340             OR SQLCODE = +100                                    06634026
066341             OR SQLCODE = -305                                    06634199
066342                                                                  06634226
066343        EXEC SQL                                                  06634326
066344           SELECT MAX(ALW_CHRG_SEQ_NBR)                           06634426
066345             INTO :ALCHRG-ALW-CHRG-SEQ-NBR                        06634526
066346             FROM TALCHRG                                         06634626
066347            WHERE PO_NBR = :POSTRR-PO-NBR                         06634726
066348              AND INVC_ID = :INVOIC-INVC-ID                       06634827
066349        END-EXEC                                                  06634926
066350                                                                  06635026
066351        EVALUATE TRUE                                             06635126
066352           WHEN SQLCODE = ZERO                                    06635226
066356             MOVE ALCHRG-ALW-CHRG-SEQ-NBR                         06635699
066357                  TO PV-NEW-ALW-CHRG-SEQ-NBR                      06635799
066358             ADD 1                   TO PV-NEW-ALW-CHRG-SEQ-NBR   06635899
066361           WHEN SQLCODE = -305                                    06636199
066363             MOVE +0                   TO ALCHRG-ALW-CHRG-SEQ-NBR 06636399
066368             MOVE ALCHRG-ALW-CHRG-SEQ-NBR                         06636899
066369               TO PV-NEW-ALW-CHRG-SEQ-NBR                         06636999
066370             ADD 1                     TO PV-NEW-ALW-CHRG-SEQ-NBR 06637099
066373           WHEN SQLCODE = -904                                    06637326
066374           WHEN SQLCODE = -913                                    06637499
066375             CONTINUE                                             06637526
066376           WHEN SQLCODE = +100                                    06637699
066377             CONTINUE                                             06637799
066378           WHEN SQLWARN0 NOT = SPACES                             06637826
066379           WHEN SQLCODE NOT = ZERO                                06637929
066380             MOVE 'S600-SELECT-MAX-SEQ-NBR'  TO AA-PARAGRAPH-NAME 06638099
066381             MOVE 'UNSUCCESSFUL SELECT'      TO AA-DB2-OPERATION  06638199
066383             MOVE 'TALCHRG'                  TO AA-DB2-TABLE1     06638399
066384             PERFORM Z999-DB2-ABEND                               06638426
066385        END-EVALUATE                                              06638526
066386     END-PERFORM.                                                 06638626
066387                                                                  06638726
066388     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         06638826
066389        MOVE 'S600-SELECT-MAX-SEQ-NBR'      TO AA-PARAGRAPH-NAME  06638999
066390        MOVE 'MAX RETRIES EXCEEDED ON SELECT'                     06639099
066391                                            TO AA-DB2-OPERATION   06639199
066392        MOVE 'TALCHRG'                      TO AA-DB2-TABLE1      06639299
066393        PERFORM Z999-DB2-ABEND                                    06639326
066394     END-IF.                                                      06639426
066395                                                                  06639526
066396*--------------------------------------------------------------*  06639675
066397* GET THE FISCAL MONTH'S BEGINNING DATE BASED ON THE VENDOR    *  06639775
066398* AGREEMENT'S EFFECTIVE DATE.                                  *  06639875
066399*--------------------------------------------------------------*  06639975
066400 S700-GET-FSCL-MNTH-BGN-DTE.                                      06640075
066401                                                                  06640175
066403     PERFORM WITH TEST AFTER                                      06640375
066404        VARYING PV-RETRY-COUNTER FROM 1 BY 1                      06640475
066405          UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                 06640575
066406             OR SQLCODE = ZERO                                    06640675
066407             OR SQLCODE = +100                                    06640775
066408                                                                  06640875
066409        EXEC SQL                                                  06640975
066410           SELECT FSCL_MN_BEG_DTE                                 06641075
066411             INTO :DTATTR-FSCL-MN-BEG-DTE                         06641175
066412             FROM TDTATTR                                         06641275
066413            WHERE KY_DTE = :VNDAGR-EFFECTIVE-DATE                 06641375
066414        END-EXEC                                                  06641475
066415                                                                  06641575
066416        EVALUATE TRUE                                             06641675
066417           WHEN SQLCODE = ZERO                                    06641777
066418           WHEN SQLCODE = -904                                    06641875
066419           WHEN SQLCODE = -912                                    06641975
066420             CONTINUE                                             06642075
066421           WHEN SQLWARN0 NOT = SPACES                             06642175
066422           WHEN SQLCODE NOT = ZERO                                06642275
066423             MOVE 'S700-GET-FSCL-MNTH-BGN-DTE'                    06642375
066424                                          TO AA-PARAGRAPH-NAME    06642475
066425             MOVE 'UNSUCCESSFUL SELECT'   TO AA-DB2-OPERATION     06642599
066427             MOVE 'TDTATTR'               TO AA-DB2-TABLE1        06642775
066428             PERFORM Z999-DB2-ABEND                               06642875
066429        END-EVALUATE                                              06642975
066430     END-PERFORM.                                                 06643075
066431                                                                  06643175
066432     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         06643275
066433        MOVE 'S700-GET-FSCL-MNTH-BGN-DTE'   TO AA-PARAGRAPH-NAME  06643399
066434        MOVE 'MAX RETRIES EXCEEDED ON SELECT'                     06643499
066435          TO AA-DB2-OPERATION                                     06643599
066436        MOVE 'TDTATTR'                      TO AA-DB2-TABLE1      06643699
066437        PERFORM Z999-DB2-ABEND                                    06643775
066438     END-IF.                                                      06643875
066439                                                                  06643975
066541*--------------------------------------------------------------*  06654199
066542* UPDATES THE CHECKPOINT RESTART CONTROL TABLE.  THE STATUS    *  06654299
066543* IS SET TO '9' (RUN IN PROGRESS) OR TO '0' (RUN COMPLETE)     *  06654399
066544*--------------------------------------------------------------*  06654499
066545 U100-UPDATE-TCKRSTCNTL.                                          06654599
066546                                                                  06654699
066547     PERFORM WITH TEST AFTER                                      06654799
066548        VARYING PV-RETRY-COUNTER FROM 1 BY 1                      06654899
066549          UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                 06654999
066550             OR SQLCODE = ZERO                                    06655099
066551                                                                  06655199
066552        EXEC SQL                                                  06655299
066553          UPDATE TCKRSTCNTL                                       06655399
066554             SET CKPT_STAT_CODE = :PV-CKPT-STAT-CODE              06655499
066555           WHERE PLAN_NAME = :PC-PROGRAM-NAME                     06655599
066556        END-EXEC                                                  06655699
066557                                                                  06655799
066558        EVALUATE TRUE                                             06655899
066559          WHEN SQLCODE = ZERO                                     06655999
066560          WHEN SQLCODE = -904                                     06656099
066561          WHEN SQLCODE = -913                                     06656199
066562            CONTINUE                                              06656299
066563          WHEN SQLWARN0 NOT = SPACES                              06656399
066564          WHEN SQLCODE NOT = ZERO                                 06656499
066565            MOVE 'U100-UPDATE-TCKRSTCNTL'   TO AA-PARAGRAPH-NAME  06656599
066566            MOVE 'UNSUCCESSFUL UPDATE'      TO AA-DB2-OPERATION   06656699
066567            MOVE 'TCKRSTCNTL'               TO AA-DB2-TABLE1      06656799
066568            PERFORM Z999-DB2-ABEND                                06656899
066569        END-EVALUATE                                              06656999
066570     END-PERFORM.                                                 06657099
066571                                                                  06657199
066572     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         06657299
066573        MOVE 'U100-UPDATE-TCKRSTCNTL'   TO AA-PARAGRAPH-NAME      06657399
066574        MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                     06657499
066575                                        TO AA-DB2-OPERATION       06657599
066576        MOVE 'TCKRSTCNTL'               TO AA-DB2-TABLE1          06657699
066577        PERFORM Z999-DB2-ABEND                                    06657799
066578     END-IF.                                                      06657899
066579                                                                  06657999
066580*--------------------------------------------------------------*  06658099
066581* UPDATES THE CHECKPOINT RESTART INFORMATION TABLE.  THE       *  06658199
066582* WORKING STORAGE DESCRIPTION FIELD IS UPDATED WITH THE LAST   *  06658299
066583* COMMITED PO/STORE NUMBER COMBINATION.                        *  06658399
066584*--------------------------------------------------------------*  06658499
066585 U200-UPDATE-TCKRSTINF.                                           06658599
066586                                                                  06658699
066587     MOVE POSTRR-PO-NBR        TO CR-PO-NBR.                      06658799
066588     MOVE POSTRR-STR-NBR       TO CR-STR-NBR.                     06658899
066589     MOVE CKPT-RESTART-INFO    TO TCKRSTINF-WORK-STRG-DESC-TEXT.  06658999
066590     MOVE 4022                 TO TCKRSTINF-WORK-STRG-DESC-LEN.   06659099
066591                                                                  06659199
066592     PERFORM WITH TEST AFTER                                      06659299
066593        VARYING PV-RETRY-COUNTER FROM 1 BY 1                      06659399
066594          UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                 06659499
066595             OR SQLCODE = ZERO                                    06659599
066596                                                                  06659699
066597        EXEC SQL                                                  06659799
066598           UPDATE TCKRSTINF                                       06659899
066599              SET WORK_STRG_DESC = :TCKRSTINF-WORK-STRG-DESC      06659999
066600            WHERE PLAN_NAME = :PC-PROGRAM-NAME                    06660099
066601        END-EXEC                                                  06660199
066602                                                                  06660299
066603        EVALUATE TRUE                                             06660399
066604          WHEN SQLCODE = ZERO                                     06660499
066605          WHEN SQLCODE = -904                                     06660599
066606          WHEN SQLCODE = -913                                     06660699
066607            CONTINUE                                              06660799
066608          WHEN SQLWARN0 NOT = SPACES                              06660899
066609          WHEN SQLCODE NOT = ZERO                                 06660999
066610            MOVE 'U200-UPDATE-TCKRSTINF'  TO AA-PARAGRAPH-NAME    06661099
066611            MOVE 'UNSUCCESSFUL UPDATE'    TO AA-DB2-OPERATION     06661199
066612            MOVE 'TCKRSTINF'              TO AA-DB2-TABLE1        06661299
066613            PERFORM Z999-DB2-ABEND                                06661399
066614        END-EVALUATE                                              06661499
066615     END-PERFORM.                                                 06661599
066616                                                                  06661699
066617     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         06661799
066618        MOVE 'U200-UPDATE-TCKRSTINF'       TO AA-PARAGRAPH-NAME   06661899
066619        MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                     06661999
066620                                           TO AA-DB2-OPERATION    06662099
066621        MOVE 'TCKRSTINF'                   TO AA-DB2-TABLE1       06662199
066622        PERFORM Z999-DB2-ABEND                                    06662299
066623     END-IF.                                                      06662399
066624                                                                  06662499
066625*--------------------------------------------------------------*  06662500
066626* OPEN PO_STR_CSR CURSOR                                       *  06662602
066627*--------------------------------------------------------------*  06662700
066628 Y100-OPEN-PO-STR-CURSOR.                                         06662802
066629                                                                  06662900
066631     PERFORM WITH TEST AFTER                                      06663100
066632         VARYING PV-RETRY-COUNTER FROM 1 BY 1                     06663200
066633           UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                06663300
066640              OR SQLCODE = ZERO                                   06664000
066700              OR SQLCODE = +100                                   06670000
066800                                                                  06680000
066900         EXEC SQL                                                 06690000
067000            OPEN PO_STR_CSR                                       06700002
067100         END-EXEC                                                 06710000
067200                                                                  06720000
067300         EVALUATE TRUE                                            06730000
067400           WHEN SQLCODE = ZERO                                    06740000
067500           WHEN SQLCODE = +100                                    06750000
067600           WHEN SQLCODE = -904                                    06760000
067700           WHEN SQLCODE = -913                                    06770000
067800             CONTINUE                                             06780000
068000           WHEN SQLWARN0 NOT = SPACES                             06800000
068100           WHEN SQLCODE  NOT = ZERO                               06810000
068200             MOVE 'Y100-OPEN-PO-STR-CURSOR' TO AA-PARAGRAPH-NAME  06820002
068400             MOVE 'UNSUCCESSFUL OPEN'       TO AA-DB2-OPERATION   06840099
068600             MOVE 'TPOSTRR'                 TO AA-DB2-TABLE1      06860002
068800             PERFORM Z999-DB2-ABEND                               06880000
068900         END-EVALUATE                                             06890000
069000     END-PERFORM.                                                 06900000
069100                                                                  06910000
069200     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         06920000
069300        MOVE 'Y100-OPEN-PO-STR-CURSOR'  TO AA-PARAGRAPH-NAME      06930002
069500        MOVE 'MAX RETRIES EXCEEDED ON OPEN'                       06950099
069600                                        TO AA-DB2-OPERATION       06960002
069700        MOVE 'TPOSTRR'                  TO AA-DB2-TABLE1          06970002
069900        PERFORM Z999-DB2-ABEND                                    06990000
070000     END-IF.                                                      07000000
070100                                                                  07010000
070101*--------------------------------------------------------------*  07010100
070102* OPEN VND_AGR_CSR CURSOR                                      *  07010204
070103*--------------------------------------------------------------*  07010300
070104 Y200-OPEN-VND-AGR-CURSOR.                                        07010404
070105                                                                  07010500
070108     PERFORM WITH TEST AFTER                                      07010800
070109         VARYING PV-RETRY-COUNTER FROM 1 BY 1                     07010900
070110           UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                07011000
070111              OR SQLCODE = ZERO                                   07011100
070112              OR SQLCODE = +100                                   07011200
070113                                                                  07011300
070114         EXEC SQL                                                 07011400
070115            OPEN VND_AGR_CSR                                      07011504
070116         END-EXEC                                                 07011600
070117                                                                  07011700
070118         EVALUATE TRUE                                            07011800
070119           WHEN SQLCODE = ZERO                                    07011900
070120           WHEN SQLCODE = +100                                    07012000
070121           WHEN SQLCODE = -904                                    07012100
070122           WHEN SQLCODE = -913                                    07012200
070123             CONTINUE                                             07012300
070124           WHEN SQLWARN0 NOT = SPACES                             07012400
070125           WHEN SQLCODE  NOT = ZERO                               07012500
070126             MOVE 'Y200-OPEN-VND-AGR-CURSOR'  TO AA-PARAGRAPH-NAME07012604
070127             MOVE 'UNSUCCESSFUL OPEN'         TO AA-DB2-OPERATION 07012799
070128             MOVE 'TVNDAGR'                   TO AA-DB2-TABLE1    07012804
070129             PERFORM Z999-DB2-ABEND                               07012900
070130         END-EVALUATE                                             07013000
070131     END-PERFORM.                                                 07013100
070132                                                                  07013200
070133     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         07013300
070134        MOVE 'Y200-OPEN-VND-AGR-CURSOR'  TO AA-PARAGRAPH-NAME     07013404
070135        MOVE 'MAX RETRIES EXCEEDED ON OPEN'                       07013599
070136                                         TO AA-DB2-OPERATION      07013600
070137        MOVE 'TVNDAGR'                   TO AA-DB2-TABLE1         07013704
070138        PERFORM Z999-DB2-ABEND                                    07013800
070139     END-IF.                                                      07013900
070140                                                                  07014000
070141*--------------------------------------------------------------*  07014109
070142* OPEN INVC_CSR CURSOR                                         *  07014209
070143*--------------------------------------------------------------*  07014309
070144 Y300-OPEN-INVC-CURSOR.                                           07014409
070145                                                                  07014509
070147     PERFORM WITH TEST AFTER                                      07014709
070148         VARYING PV-RETRY-COUNTER FROM 1 BY 1                     07014809
070149           UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                07014909
070150              OR SQLCODE = ZERO                                   07015009
070151              OR SQLCODE = +100                                   07015109
070152                                                                  07015209
070153         EXEC SQL                                                 07015309
070154            OPEN INVC_CSR                                         07015409
070155         END-EXEC                                                 07015509
070156                                                                  07015609
070157         EVALUATE TRUE                                            07015709
070158           WHEN SQLCODE = ZERO                                    07015809
070159           WHEN SQLCODE = +100                                    07015909
070160           WHEN SQLCODE = -904                                    07016009
070161           WHEN SQLCODE = -913                                    07016109
070162             CONTINUE                                             07016209
070163           WHEN SQLWARN0 NOT = SPACES                             07016309
070164           WHEN SQLCODE  NOT = ZERO                               07016409
070165             MOVE 'Y300-OPEN-INVC-CURSOR'     TO AA-PARAGRAPH-NAME07016509
070166             MOVE 'UNSUCCESSFUL OPEN'         TO AA-DB2-OPERATION 07016699
070167             MOVE 'TINVOIC'                   TO AA-DB2-TABLE1    07016709
070168             PERFORM Z999-DB2-ABEND                               07016809
070169         END-EVALUATE                                             07016909
070170     END-PERFORM.                                                 07017009
070171                                                                  07017109
070172     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         07017209
070173        MOVE 'Y300-OPEN-INVC-CURSOR'     TO AA-PARAGRAPH-NAME     07017309
070174        MOVE 'MAX RETRIES EXCEEDED ON OPEN'                       07017499
070175                                         TO AA-DB2-OPERATION      07017509
070176        MOVE 'TINVOIC'                   TO AA-DB2-TABLE1         07017609
070177        PERFORM Z999-DB2-ABEND                                    07017709
070178     END-IF.                                                      07017809
070179                                                                  07017909
070219*--------------------------------------------------------------*  07021900
070220* CLOSE PO_STR_CSR CURSOR                                      *  07022009
070221*--------------------------------------------------------------*  07022100
070230 Y400-CLOSE-PO-STR-CURSOR.                                        07023099
070300                                                                  07030000
070400     PERFORM WITH TEST AFTER                                      07040000
070500         VARYING PV-RETRY-COUNTER FROM 1 BY 1                     07050000
070600           UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                07060000
070700              OR SQLCODE = ZERO                                   07070000
070800              OR SQLCODE = +100                                   07080000
070900                                                                  07090000
071000         EXEC SQL                                                 07100000
071100            CLOSE PO_STR_CSR                                      07110009
071200         END-EXEC                                                 07120000
071300                                                                  07130000
071400         EVALUATE TRUE                                            07140000
071500           WHEN SQLCODE = ZERO                                    07150000
071600           WHEN SQLCODE = +100                                    07160000
071700           WHEN SQLCODE = -904                                    07170000
071800           WHEN SQLCODE = -913                                    07180000
071900             CONTINUE                                             07190000
072000           WHEN SQLWARN0 NOT = SPACES                             07200000
072100           WHEN SQLCODE  NOT = ZERO                               07210000
072200             MOVE 'Y400-CLOSE-PO-STR-CURSOR'  TO AA-PARAGRAPH-NAME07220099
072400             MOVE 'UNSUCCESSFUL CLOSE'        TO AA-DB2-OPERATION 07240099
072600             MOVE 'TPOSTRR'                   TO AA-DB2-TABLE1    07260009
072800             PERFORM Z999-DB2-ABEND                               07280000
072900         END-EVALUATE                                             07290000
073000     END-PERFORM.                                                 07300000
073100                                                                  07310000
073200     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         07320000
073300        MOVE 'Y400-CLOSE-PO-STR-CURSOR'  TO AA-PARAGRAPH-NAME     07330099
073500        MOVE 'MAX RETRIES EXCEEDED ON CLOSE'                      07350099
073600                                         TO AA-DB2-OPERATION      07360009
073700        MOVE 'TPOSTRR'                   TO AA-DB2-TABLE1         07370009
073900        PERFORM Z999-DB2-ABEND                                    07390000
073910     END-IF.                                                      07391000
073911                                                                  07391100
073920*--------------------------------------------------------------*  07392000
073930* CLOSE VND_AGR_CSR CURSOR                                     *  07393009
073940*--------------------------------------------------------------*  07394000
111100 Y500-CLOSE-VND-AGR-CURSOR.                                       11110099
111200                                                                  11120000
111300     PERFORM WITH TEST AFTER                                      11130000
111400         VARYING PV-RETRY-COUNTER FROM 1 BY 1                     11140000
111500           UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                11150000
111600              OR SQLCODE = ZERO                                   11160000
111700              OR SQLCODE = +100                                   11170000
111800                                                                  11180000
111900         EXEC SQL                                                 11190000
112000            CLOSE VND_AGR_CSR                                     11200009
112100         END-EXEC                                                 11210000
112200                                                                  11220000
112300         EVALUATE TRUE                                            11230000
112400           WHEN SQLCODE = ZERO                                    11240000
112500           WHEN SQLCODE = +100                                    11250000
112600           WHEN SQLCODE = -904                                    11260000
112700           WHEN SQLCODE = -913                                    11270000
112800             CONTINUE                                             11280000
112900           WHEN SQLWARN0 NOT = SPACES                             11290000
113000           WHEN SQLCODE  NOT = ZERO                               11300000
113100             MOVE 'Y500-CLOSE-VND-AGR-CURSOR' TO AA-PARAGRAPH-NAME11310099
113300             MOVE 'UNSUCCESSFUL CLOSE'         TO AA-DB2-OPERATION11330099
113500             MOVE 'TVNDAGR'                    TO AA-DB2-TABLE1   11350009
113700             PERFORM Z999-DB2-ABEND                               11370000
113800         END-EVALUATE                                             11380000
113900     END-PERFORM.                                                 11390000
114000                                                                  11400000
114100     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         11410000
114200        MOVE 'Y500-CLOSE-VND-AGR-CURSOR'  TO AA-PARAGRAPH-NAME    11420099
114400        MOVE 'MAX RETRIES EXCEEDED ON CLOSE'                      11440099
114500                                          TO AA-DB2-OPERATION     11450000
114600        MOVE 'TVNDAGR'                    TO AA-DB2-TABLE1        11460009
114800        PERFORM Z999-DB2-ABEND                                    11480000
114810     END-IF.                                                      11481000
114900                                                                  11490000
114910*--------------------------------------------------------------*  11491009
114920* CLOSE INVC_CSR CURSOR                                        *  11492009
114930*--------------------------------------------------------------*  11493009
114940 Y600-CLOSE-INVC-CURSOR.                                          11494099
114950                                                                  11495009
114960     PERFORM WITH TEST AFTER                                      11496009
114970         VARYING PV-RETRY-COUNTER FROM 1 BY 1                     11497009
114980           UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                11498009
114990              OR SQLCODE = ZERO                                   11499009
114991              OR SQLCODE = +100                                   11499109
114992                                                                  11499209
114993         EXEC SQL                                                 11499309
114994            CLOSE INVC_CSR                                        11499409
114995         END-EXEC                                                 11499509
114996                                                                  11499609
114997         EVALUATE TRUE                                            11499709
114998           WHEN SQLCODE = ZERO                                    11499809
114999           WHEN SQLCODE = +100                                    11499909
115000           WHEN SQLCODE = -904                                    11500009
115001           WHEN SQLCODE = -913                                    11500109
115002             CONTINUE                                             11500209
115003           WHEN SQLWARN0 NOT = SPACES                             11500309
115004           WHEN SQLCODE  NOT = ZERO                               11500409
115005             MOVE 'Y600-CLOSE-INVC-CURSOR'    TO AA-PARAGRAPH-NAME11500599
115006             MOVE 'UNSUCCESSFUL CLOSE'        TO AA-DB2-OPERATION 11500699
115007             MOVE 'TINVOIC'                   TO AA-DB2-TABLE1    11500799
115008             PERFORM Z999-DB2-ABEND                               11500809
115009         END-EVALUATE                                             11500909
115010     END-PERFORM.                                                 11501009
115011                                                                  11501109
115012     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         11501209
115013        MOVE 'Y600-CLOSE-INVC-CURSOR'     TO AA-PARAGRAPH-NAME    11501399
115014        MOVE 'MAX RETRIES EXCEEDED ON CLOSE'                      11501499
115015                                          TO AA-DB2-OPERATION     11501509
115016        MOVE 'TINVOIC'                    TO AA-DB2-TABLE1        11501609
115017        PERFORM Z999-DB2-ABEND                                    11501709
115018     END-IF.                                                      11501809
115019                                                                  11501909
115070*--------------------------------------------------------------*  11507006
115100* PROCESS ABENDS                                               *  11510006
115200*--------------------------------------------------------------*  11520006
115300 Z998-ABEND.                                                      11530006
115400                                                                  11540006
115500     DISPLAY AA-ABEND-LIT.                                        11550006
115700     DISPLAY AA-PROGRAM-LIT.                                      11570006
115800     DISPLAY AA-PARAGRAPH-LIT.                                    11580006
115810     DISPLAY AA-MESSAGE-LINE.                                     11581007
115820     DISPLAY 'POSTRR-PO-NBR: ' POSTRR-PO-NBR.                     11582099
115830     DISPLAY 'POSTRR-STR-NBR: ' POSTRR-STR-NBR.                   11583099
116200                                                                  11620006
116300     COPY DPPD004.                                                11630006
116400     CALL 'ILBOABN0' USING ABEND-CODE.                            11640006
116500                                                                  11650006
133710*--------------------------------------------------------------*  13371000
133720* PROCESS DB2 ABENDS                                           *  13372000
133730*--------------------------------------------------------------*  13373000
133800 Z999-DB2-ABEND.                                                  13380000
133900                                                                  13390000
134400     DISPLAY AA-ABEND-LIT.                                        13440000
134500     DISPLAY AA-DB2-ERROR-LIT.                                    13450000
134600     DISPLAY AA-PROGRAM-LIT.                                      13460000
134700     DISPLAY AA-PARAGRAPH-LIT.                                    13470000
134800     DISPLAY AA-DB2-OPERATION-LIT.                                13480000
134810     DISPLAY AA-DB2-TABLE1.                                       13481000
134850     SET AC-DB2-ERROR TO TRUE.                                    13485000
134851     DISPLAY 'POSTRR-PO-NBR: ' POSTRR-PO-NBR.                     13485199
134852     DISPLAY 'POSTRR-STR-NBR: ' POSTRR-STR-NBR.                   13485299
134860                                                                  13486000
135400     COPY DPPD004.                                                13540000
135500     CALL 'ILBOABN0' USING ABEND-CODE.                            13550000
135600                                                                  13560000
