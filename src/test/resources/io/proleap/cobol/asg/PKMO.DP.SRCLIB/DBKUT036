000100 IDENTIFICATION DIVISION.                                         00010000
000200                                                                  00020000
000300 PROGRAM-ID.             DBKUT036.                                00030000
000400 AUTHOR.                 LARRY SCHLEICHER.                        00040000
000500 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00050000
000600 DATE-WRITTEN.           JANUARY 2014.                            00060000
000700 DATE-COMPILED.                                                   00070000
000800                                                                  00080000
000900***************************************************************** 00090000
001000***  RUNSTAT DETERMINATION PROGRAM                            *** 00100000
001100***  ---------------------------                              *** 00110000
001200***  THIS PROGRAM WILL GENERATE IBM DB2 RUNSTAT CONTROL CARDS *** 00120000
001300***  FOR TABLESPACES AND INDEXES WHEN CERTAIN STATISTICAL     *** 00130000
001400***  VALUES EXCEED A THRESHOLD.                               *** 00140000
001500***************************************************************** 00150000
001600*                                                                 00160000
001700***************************************************************** 00170000
001800***-----------------------------------------------------------*** 00180000
001900***  IMPORTANT!!!                                             *** 00190000
002000***-----------------------------------------------------------*** 00200000
002100***  WHENEVER THIS PROGRAM IS TURNED OVER IN DB2P A BIND TO   *** 00210009
002200***  DB6P IS REQUIRED.                                        *** 00220009
002300***  BIND JCL IS IN TKMD.DB2.CNTL(BINDRS6P).                  *** 00230009
002500***************************************************************** 00250000
002610*                                                                 00261007
002620*   10/31/2014 - ONLY CREATE ONE OUTPUT FILE AND REMOVE ALL       00262007
002630*                SAMPLING.  IT CAUSES INSERTS WITH A 0 VALUE IN   00263007
002640*                THE PAGESAVE FIELD.                              00264007
002610*                                                                 00265009
002620*   01/??/2021 - ADD LOGIC TO GENERATE A RUNSTATS IF TABLESPACE   00266009
002630*                STATS TIME IS OLDER THAN A SPECIFIED THRESHOLD.  00267009
002610*                                                                 00268009
002700***************************************************************** 00270000
002800***  THE FOLLOWING STATISTICS ARE COMPARED TO THRESHOLD       *** 00280009
002900***  VALUES TO DETERMINE WHETHER THE OBJECT QUALIFIES FOR A   *** 00290009
003000***  RUNSTATS:                                                *** 00300009
003100***                                                           *** 00310000
003200***  TABLESPACES:                                             *** 00320000
003300***  --------------------                                     *** 00330000
003400***  - NULL REALTIME STATSTIME VALUES                         **  00340009
003400***  - MASS DELETE STATS > 0                                  **  00341009
003500***  - PERCENT OF ROWS CHANGED ALONG WITH NUMBER OF ROWS      *** 00351009
003600***    CHANGED SINCE LAST RUNSTATS                            *** 00360009
003400***  - TIME PERIOD SINCE LAST RUNSTATS                        **  00370009
003800***                                                           *** 00380000
003900***  INDEXES:                                                 *** 00390000
004000***  --------                                                 *** 00400000
003400***  - NULL REALTIME STATSTIME VALUES                         **  00401009
003400***  - MASS DELETE STATS > 0                                  **  00402009
003500***  - PERCENT OF ENTRIES CHANGED ALONG WITH NUMBER OF ENTRIES*** 00420109
003600***    CHANGED SINCE LAST RUNSTATS                            *** 00420209
004500***                                                           *** 00450000
004600***  BOTH TABLESPACES AND INDEXES:                            *** 00460009
004000***  -----------------------------                            *** 00460109
003500***  - OVERALL TIME DIFFERENCE BETWEEN AN OBJECT'S TABLESPACE *** 00461009
003500***    AND INDEX RUNSTATS (AT PARTITION LEVEL WHEN APPLICABLE)*** 00462009
003800***                                                           *** 00463009
005000***************************************************************** 00500000
005100*                                                                 00510000
005200*                                                                 00520000
005300 ENVIRONMENT DIVISION.                                            00530000
005400                                                                  00540000
005500 CONFIGURATION SECTION.                                           00550000
005600                                                                  00560000
005700 SOURCE-COMPUTER.    IBM.                                         00570000
005800 OBJECT-COMPUTER.    IBM.                                         00580000
005900                                                                  00590000
006000 INPUT-OUTPUT SECTION.                                            00600000
006100                                                                  00610000
006200 FILE-CONTROL.                                                    00620000
006300                                                                  00630000
006400     SELECT THRESHOLD-VALUES-FILE                                 00640000
006500         ASSIGN TO IN01.                                          00650000
006600                                                                  00660000
006700     SELECT RUNSTAT-SCOPE-FILE                                    00670000
006800         ASSIGN TO IN02.                                          00680000
006900                                                                  00690000
007000     SELECT TS-RUNSTAT-FILE                                       00700003
007100         ASSIGN TO OUT01.                                         00710000
007200                                                                  00720000
007600                                                                  00760000
007700 DATA DIVISION.                                                   00770000
007800                                                                  00780000
007900 FILE SECTION.                                                    00790000
008000                                                                  00800000
008100 FD  THRESHOLD-VALUES-FILE                                        00810000
008200     RECORDING MODE IS F                                          00820000
008300     BLOCK CONTAINS 0 RECORDS.                                    00830000
008400                                                                  00840000
008500 01  THRESHOLD-VALUES-RECORD    PIC X(080).                       00850000
008600                                                                  00860000
008700 FD  RUNSTAT-SCOPE-FILE                                           00870000
008800     RECORDING MODE IS V                                          00880000
008900     BLOCK CONTAINS 0 RECORDS.                                    00890000
009000                                                                  00900000
009100 01  RUNSTAT-SCOPE-RECORD       PIC X(120).                       00910000
009200                                                                  00920000
009300 FD  TS-RUNSTAT-FILE                                              00930003
009400     RECORDING MODE IS F                                          00940000
009500     BLOCK CONTAINS 0 RECORDS.                                    00950000
009600                                                                  00960000
009700 01  TS-RUNSTAT-RECORD          PIC X(080).                       00970003
009800                                                                  00980000
010500 WORKING-STORAGE SECTION.                                         01050000
010600                                                                  01060000
010700 01  WS-ABEND-CODE                 PIC S9(04) VALUE +0 COMP SYNC. 01070000
010800 01  WS-DAYS-DIFFERENCE            PIC X(22).                     01080000
010800 01  WS-STATS-DAYS-OLD             PIC S9(09) COMP  VALUE +0.     01081013
010900 01  WS-NO-MORE-INDEXES            PIC X(01)  VALUE 'N'.          01090000
011000 01  WS-DSNU1010I-HIT              PIC X(01)  VALUE 'N'.          01100000
011100 01  WS-IX-CSR-DATABASE            PIC X(08)  VALUE SPACES.       01110000
011200 01  WS-IX-CSR-TABLESPACE          PIC X(08)  VALUE SPACES.       01120000
011300 01  WS-ROWS-CHG-PCT               PIC S9(09) COMP  VALUE +0.     01130000
011400 01  WS-ROWS-CHANGED-TBL           PIC S9(09) COMP  VALUE +0.     01140000
011500 01  WS-IX-ENTRIES-CHGD-PCT        PIC S9(09) COMP  VALUE +0.     01150000
011600 01  WS-NULL-COUNT                 PIC S9(09) COMP  VALUE +0.     01160000
011700 01  WS-NBR-IX-ENTRIES-CHGD        PIC S9(04) COMP  VALUE +0.     01170000
011800 01  WS-PARTITIONED-TSPACE         PIC X(01)  VALUE 'N'.          01180000
011900 01  WS-PART-NBR                   PIC S9(04) VALUE +0 COMP SYNC. 01190000
012000 01  WS-PREV-DATABASE              PIC X(08)  VALUE SPACES.       01200000
012100 01  WS-PREV-TABLESPACE            PIC X(08)  VALUE SPACES.       01210000
012200 01  WS-PROCESS-PREV               PIC X(01)  VALUE 'N'.          01220000
012300 01  WS-SCOPE-EOF                  PIC X(01)  VALUE 'N'.          01230000
012400 01  WS-TS-RUNSTAT-COUNT           PIC S9(04) VALUE +0  COMP.     01240005
012600 01  WS-TS-RUNSTAT                 PIC X(01)  VALUE SPACE.        01260000
012700                                                                  01270000
012800 01  TS-TOTALROWS-NULLIND          PIC S9(04) VALUE +0  COMP.     01280000
012900 01  TS-STATSLASTTIME-NULLIND      PIC S9(04) VALUE +0  COMP.     01290000
013000 01  TS-STATSMASSDELETE-NULLIND    PIC S9(04) VALUE +0  COMP.     01300000
013100 01  TS-STATSINSERTS-NULLIND       PIC S9(04) VALUE +0  COMP.     01310000
013200 01  TS-STATSDELETES-NULLIND       PIC S9(04) VALUE +0  COMP.     01320000
013300 01  TS-STATSUPDATES-NULLIND       PIC S9(04) VALUE +0  COMP.     01330000
013400 01  IX-TOTALENTRIES-NULLIND       PIC S9(04) VALUE +0  COMP.     01340000
013500 01  IX-STATSLASTTIME-NULLIND      PIC S9(04) VALUE +0  COMP.     01350000
013600 01  IX-STATSMASSDELETE-NULLIND    PIC S9(04) VALUE +0  COMP.     01360000
013700 01  IX-STATSINSERTS-NULLIND       PIC S9(04) VALUE +0  COMP.     01370000
013800 01  IX-STATSDELETES-NULLIND       PIC S9(04) VALUE +0  COMP.     01380000
013900                                                                  01390000
014000 01  WS-SCOPE-RECORD.                                             01400000
014100     05  FILLER                    PIC X(01).                     01410000
014200     05  WS-DSNU-MSG               PIC X(09).                     01420000
014300     05  FILLER                    PIC X(110).                    01430000
014400                                                                  01440000
014500 01  WS-INCLUDE-LINE  REDEFINES WS-SCOPE-RECORD.                  01450000
014600     05  FILLER                    PIC X(15).                     01460000
014700     05  WS-INCLUDE-KEYWORD        PIC X(18).                     01470000
014800     05  FILLER                    PIC X(01).                     01480000
014900     05  FILLER                    PIC X(86).                     01490000
015000                                                                  01500000
015100 01  WS-UNSTRING-LINE.                                            01510000
015200     05  WS-FILL                   PIC X(01).                     01520000
015300     05  WS-INCLUDE-LIT            PIC X(07).                     01530000
015400     05  WS-TABLESPACE-LIT         PIC X(10).                     01540000
015500     05  WS-DATABASE               PIC X(08).                     01550000
015600     05  WS-TABLESPACE             PIC X(08).                     01560000
015700     05  WS-PARTLEVEL              PIC X(16).                     01570000
015800                                                                  01580000
015900 01  WS-PARTITION.                                                01590000
016000     05  WS-PART-CHAR              PIC X(05).                     01600000
016100     05  WS-PART-NUMERIC                                          01610000
016200           REDEFINES WS-PART-CHAR  PIC 9(5).                      01620000
016300                                                                  01630000
016400 01  WS-THRESHOLD-VALUES-RECORD.                                  01640000
016500     05  WS-THRESH-PCT-TBL-ROWS-CHGD PIC 9(03) VALUE 0.           01650000
016600     05  FILLER                      PIC X(01).                   01660000
016700     05  WS-THRESH-NBR-TBL-ROWS-CHGD PIC 9(03)  VALUE 0.          01670000
016800     05  FILLER                      PIC X(01).                   01680000
016900     05  WS-THRESH-PCT-IX-ENTRIES-CHGD PIC 9(03) VALUE 0.         01690000
017000     05  FILLER                      PIC X(01).                   01700000
017100     05  WS-THRESH-NBR-IX-ENTRIES-CHGD PIC 9(03) VALUE 0.         01710000
017200     05  FILLER                      PIC X(01).                   01720000
017300     05  WS-THRESH-STAT-DAYS-DIFF    PIC 9(03)  VALUE 0.          01730010
017200     05  FILLER                      PIC X(01).                   01731010
017300     05  WS-THRESH-STATS-AGE         PIC 9(03)  VALUE 0.          01732010
017400     05  FILLER                      PIC X(57).                   01740010
017500                                                                  01750000
017600 01  DP004-DB2-ERROR-FIELDS.                                      01760000
017700     05  DP004-ASTERISK-LINE       PIC  X(80)  VALUE ALL '*'.     01770000
017800     05  DP004-MAX-MESSAGE-LINES   PIC S9(04) VALUE +12           01780000
017900                                              COMP SYNC.          01790000
018000     05  DP004-ERROR-LINE-LENGTH   PIC S9(09) VALUE +75           01800000
018100                                              COMP SYNC.          01810000
018200     05  DP004-FORMATTED-MESSAGE.                                 01820000
018300         10  FILLER                PIC S9(04) VALUE +900          01830000
018400                                              COMP SYNC.          01840000
018500         10  DP004-MESSAGE-LINE    OCCURS 12 TIMES                01850000
018600                                   INDEXED BY DP004-MSG-IDX       01860000
018700                                   PIC  X(75).                    01870000
018800                                                                  01880000
018900 01  WS-TS-RUNSTAT-TABLE.                                         01890006
019000     05  WS-TS-RUNSTAT-ENTRIES    OCCURS 5000 TIMES               01900006
019100         INDEXED BY WS-TS-RUNSTAT-IDX.                            01910006
019200         10  WS-TS-RUNSTAT-DB      PIC  X(08).                    01920006
019300         10  WS-TS-RUNSTAT-TS      PIC  X(08).                    01930006
020000                                                                  02000000
020600                                                                  02060000
020700***************************************************************** 02070000
020800*** RUNSTAT TABLESPACE STATEMENTS                             *** 02080000
020900***************************************************************** 02090000
021100                                                                  02110000
021200 01  WS-TS-RUNSTAT-LINE1           PIC X(18)   VALUE              02120000
021300     'LISTDEF TS-RUNSTAT'.                                        02130000
021400                                                                  02140000
021500 01  WS-TS-RUNSTAT-LINE2.                                         02150000
021600     05  FILLER                    PIC X(21)   VALUE              02160000
021700     '  INCLUDE TABLESPACE '.                                     02170000
021800     05  WS-TS-RUNSTAT-DB-TS       PIC X(17)   VALUE SPACES.      02180000
021900     05  FILLER                    PIC X(19)   VALUE SPACE.       02190000
022000                                                                  02200000
022100 01  WS-TS-RUNSTAT-LINE3           PIC X(35)   VALUE              02210000
022200     'RUNSTATS TABLESPACE LIST TS-RUNSTAT'.                       02220000
022300                                                                  02230000
022400 01  WS-TS-RUNSTAT-LINE4           PIC X(43)   VALUE              02240000
022500     '  TABLE(ALL) SHRLEVEL CHANGE HISTORY SPACE '.               02250000
022600                                                                  02260000
022700 01  WS-TS-RUNSTAT-LINE5.                                         02270000
022800     05  FILLER                    PIC X(13)   VALUE              02280003
022900     '  INDEX(ALL) '.                                             02290003
023000                                                                  02300000
023900 01  WS-OPTIONS-LINE.                                             02390000
024000     05  FILLER                    PIC X(29)   VALUE              02400000
024100     'OPTIONS EVENT(ITEMERROR,SKIP)'.                             02410000
024200                                                                  02420000
024300*  SYSIBM.SYSINDEXES                                              02430000
024400     EXEC SQL                                                     02440000
024500         INCLUDE SYSINDEX                                         02450000
024600     END-EXEC.                                                    02460000
024700                                                                  02470000
024800*  SYSIBM.SYSINDEXPART                                            02480000
024900     EXEC SQL                                                     02490000
025000         INCLUDE SYSIXPT                                          02500000
025100     END-EXEC.                                                    02510000
025200                                                                  02520000
025300*  SYSIBM.SYSTABLEPART                                            02530000
025400     EXEC SQL                                                     02540000
025500         INCLUDE SYSTABPT                                         02550000
025600     END-EXEC.                                                    02560000
025700                                                                  02570000
026300*  SYSIBM.SYSTABLES                                               02630000
026400     EXEC SQL                                                     02640000
026500         INCLUDE SYSTABLE                                         02650000
026600     END-EXEC.                                                    02660000
026700                                                                  02670000
026800*  SYSIBM.SYSTABLESPACE                                           02680000
026900     EXEC SQL                                                     02690000
027000         INCLUDE SYSTABSP                                         02700000
027100     END-EXEC.                                                    02710000
027200                                                                  02720000
027300*  SYSIBM.SYSTABLESPACESTATS                                      02730000
027400     EXEC SQL                                                     02740000
027500         INCLUDE SYSRTSTS                                         02750000
027600     END-EXEC.                                                    02760000
027700                                                                  02770000
027800*  SYSIBM.SYSINDEXSPACESTATS                                      02780000
027900     EXEC SQL                                                     02790000
028000         INCLUDE SYSRTSIX                                         02800000
028100     END-EXEC.                                                    02810000
028200                                                                  02820000
028300                                                                  02830000
028400     EXEC SQL                                                     02840000
028500         DECLARE INDEX-CURSOR CURSOR FOR                          02850000
028600             SELECT IX.DBID, IX.ISOBID, IP.PARTITION              02860000
028700                 FROM SYSIBM.SYSTABLES    TBL,                    02870000
028800                      SYSIBM.SYSINDEXES   IX,                     02880000
028900                      SYSIBM.SYSINDEXPART IP                      02890000
029000             WHERE TBL.DBNAME   = :WS-IX-CSR-DATABASE             02900000
029100               AND TBL.TSNAME   = :WS-IX-CSR-TABLESPACE           02910000
029200               AND TBL.TYPE     IN ('T','X')                      02920000
029300               AND TBL.CREATOR  = IX.TBCREATOR                    02930000
029400               AND TBL.NAME     = IX.TBNAME                       02940000
029500               AND IX.CREATOR   = IP.IXCREATOR                    02950000
029600               AND IX.NAME      = IP.IXNAME                       02960000
029700                 ORDER BY IP.PARTITION                            02970000
029800         WITH UR                                                  02980000
029900     END-EXEC.                                                    02990000
030000                                                                  03000000
030100                                                                  03010000
030200     EXEC SQL                                                     03020000
030300         INCLUDE SQLCA                                            03030000
030400     END-EXEC.                                                    03040000
030500                                                                  03050000
030600                                                                  03060000
030700                                                                  03070000
030800 PROCEDURE DIVISION.                                              03080000
030900                                                                  03090000
031000***************************************************************** 03100000
031100*** OPEN FILES, INITIALIZATIONS, READ THROUGH INPUT FILE,     *** 03110000
031200*** CLOSE FILES.                                              *** 03120000
031300***************************************************************** 03130000
031400                                                                  03140000
031500 0000-PROGRAM-MAINLINE SECTION.                                   03150000
031600                                                                  03160000
031700     OPEN INPUT  THRESHOLD-VALUES-FILE                            03170000
031800                 RUNSTAT-SCOPE-FILE.                              03180000
031900                                                                  03190000
032000     OPEN OUTPUT TS-RUNSTAT-FILE.                                 03200003
032200                                                                  03220000
032300     READ THRESHOLD-VALUES-FILE INTO WS-THRESHOLD-VALUES-RECORD   03230000
032400         AT END                                                   03240000
032500             DISPLAY '******************************************' 03250000
032600             DISPLAY '*** PROGRAM ERROR - DBKUT036           ***' 03260000
032700             DISPLAY '***                                    ***' 03270000
032800             DISPLAY '*** PARAGRAPH 0000-PROGRAM-MAINLINE    ***' 03280000
032900             DISPLAY '*** EMPTY THRESHOLD CONTROL FILE       ***' 03290000
033000             DISPLAY '******************************************' 03300000
033100             MOVE +4008 TO WS-ABEND-CODE                          03310000
033200             PERFORM 9999-ABEND.                                  03320000
033300                                                                  03330000
033400                                                                  03340000
033500     PERFORM 1000-READ-SCOPE-FILE THRU 1000-EXIT                  03350000
033600         UNTIL WS-SCOPE-EOF = 'Y'.                                03360000
033700                                                                  03370000
033800     PERFORM 1100-WRITE-TS-RUNSTAT-STMTS THRU 1100-EXIT.          03380000
033900                                                                  03390000
034000     CLOSE THRESHOLD-VALUES-FILE                                  03400000
034100           RUNSTAT-SCOPE-FILE                                     03410000
034200           TS-RUNSTAT-FILE.                                       03420003
034400                                                                  03440000
034500     GOBACK.                                                      03450000
034600                                                                  03460000
034700                                                                  03470000
034800 1000-READ-SCOPE-FILE.                                            03480000
034900                                                                  03490000
035000***************************************************************** 03500000
035100*** THIS FILE CONTAINS THE SYSOUT FROM A REORG THAT WAS RUN   *** 03510000
035200*** USING OPTIONS PREVIEW TO EXPAND THE LISTDEF STATEMENT.    *** 03520000
035300*** THE TABLESPACES TO BE CHECKED FOR RUNSTAT ARE PARSED FROM *** 03530000
035400*** THIS FILE.  INDEXES WILL BE DERIVED FROM THE DB2 CATALOG  *** 03540000
035500*** FOR EACH TABLESPACE.                                      *** 03550000
035600***                                                           *** 03560000
035700*** PROCESSING:                                               *** 03570000
035800*** -----------                                               *** 03580000
035900*** CHECK FOR DB2 MESSAGE DSNU1010I.  THIS MESSAGE OCCURS     *** 03590000
036000*** ONCE AND PRECEDES A GENERATED LISTDEF CONTAINING ALL      *** 03600000
036100*** EVALUATED INCLUDE AND EXCLUDE CLAUSES.                    *** 03610000
036200***                                                           *** 03620000
036300*** FOLLOWING A HIT ON THE DSNU1010I MESSAGE, BEGIN PROCESSING*** 03630000
036400*** THE GENERATED INCLUDE STATEMENTS.  THEY WILL CONTAIN THE  *** 03640000
036500*** DATABASE AND TABLESPACE NAMES AND PARTITION NUMBERS (IF   *** 03650000
036600*** APPLICABLE).                                              *** 03660000
036700***                                                           *** 03670000
036800***                                                           *** 03680000
036900***************************************************************** 03690000
037000                                                                  03700000
037100     READ RUNSTAT-SCOPE-FILE INTO WS-SCOPE-RECORD                 03710000
037200         AT END                                                   03720000
037300             MOVE 'Y'  TO  WS-SCOPE-EOF                           03730000
037400                                                                  03740000
037500             IF WS-TS-RUNSTAT = 'N'                               03750000
037600                 PERFORM 5000-CHECK-IX-THRESHOLDS THRU 5000-EXIT  03760000
037700                 IF WS-TS-RUNSTAT = 'Y'                           03770000
037800                     MOVE 'Y'    TO WS-PROCESS-PREV               03780000
037900                     PERFORM 7000-RUNSTAT-TS THRU 7000-EXIT       03790000
038000                 END-IF                                           03800000
038100             END-IF                                               03810000
038200             GO TO 1000-EXIT.                                     03820000
038300                                                                  03830000
038400     IF WS-DSNU-MSG = 'DSNU1010I'                                 03840000
038500         MOVE 'Y' TO WS-DSNU1010I-HIT                             03850000
038600         GO TO 1000-EXIT.                                         03860000
038700                                                                  03870000
038800     IF WS-DSNU1010I-HIT = 'Y'                                    03880000
038900         AND WS-INCLUDE-KEYWORD = 'INCLUDE TABLESPACE'            03890000
039000             PERFORM 2000-PROCESS-INCLUDE THRU 2000-EXIT.         03900000
039100                                                                  03910000
039200 1000-EXIT.                                                       03920000
039300      EXIT.                                                       03930000
039400                                                                  03940000
039500                                                                  03950000
039600 1100-WRITE-TS-RUNSTAT-STMTS.                                     03960000
039700                                                                  03970000
039800***************************************************************** 03980000
039900** PROCESS ALL OF THE ARRAYS FOR THE DIFFERENT TYPES OF RUNSTATS* 03990000
040000***************************************************************** 04000000
040100                                                                  04010000
040200     IF WS-TS-RUNSTAT-COUNT               = 0                     04020005
040400             MOVE SPACES TO TS-RUNSTAT-RECORD                     04040003
040600             WRITE TS-RUNSTAT-RECORD                              04060003
040700     ELSE                                                         04070001
041200         PERFORM 1110-WRITE-RUNSTATS-STMTS THRU 1110-EXIT         04120005
041600     END-IF.                                                      04160000
041700                                                                  04170000
042500 1100-EXIT.                                                       04250000
042600      EXIT.                                                       04260000
042700                                                                  04270000
042800                                                                  04280000
042900 1110-WRITE-RUNSTATS-STMTS.                                       04290005
043000                                                                  04300000
043100***************************************************************** 04310000
043200*** WRITE RUNSTAT TABLESPACE STATEMENTS                       *** 04320005
043300***************************************************************** 04330000
043400                                                                  04340000
043500     WRITE TS-RUNSTAT-RECORD FROM WS-OPTIONS-LINE.                04350003
043600                                                                  04360000
043700     MOVE SPACES TO TS-RUNSTAT-RECORD.                            04370003
043800     WRITE TS-RUNSTAT-RECORD.                                     04380003
043900                                                                  04390000
044000     WRITE TS-RUNSTAT-RECORD                                      04400003
044100         FROM WS-TS-RUNSTAT-LINE1.                                04410000
044200                                                                  04420000
044300     PERFORM                                                      04430000
044400         VARYING WS-TS-RUNSTAT-IDX                                04440006
044500         FROM 1 BY 1                                              04450000
044600         UNTIL WS-TS-RUNSTAT-IDX >                                04460006
044700               WS-TS-RUNSTAT-COUNT                                04470005
044800             MOVE SPACES TO WS-TS-RUNSTAT-DB-TS                   04480000
044900             STRING WS-TS-RUNSTAT-DB (WS-TS-RUNSTAT-IDX)          04490006
045000                                   DELIMITED BY ' '               04500000
045100                    '.'            DELIMITED BY SIZE              04510000
045200                    WS-TS-RUNSTAT-TS (WS-TS-RUNSTAT-IDX)          04520006
045300                                   DELIMITED BY SIZE              04530000
045400                    INTO WS-TS-RUNSTAT-DB-TS                      04540000
045500             WRITE TS-RUNSTAT-RECORD                              04550003
045600                    FROM WS-TS-RUNSTAT-LINE2                      04560000
045700     END-PERFORM.                                                 04570000
045800                                                                  04580000
045900     MOVE SPACES TO TS-RUNSTAT-RECORD.                            04590003
046000     WRITE TS-RUNSTAT-RECORD.                                     04600003
046100     WRITE TS-RUNSTAT-RECORD                                      04610003
046200         FROM WS-TS-RUNSTAT-LINE3.                                04620000
046300                                                                  04630000
046400     WRITE TS-RUNSTAT-RECORD                                      04640003
046500         FROM WS-TS-RUNSTAT-LINE4.                                04650000
046600                                                                  04660000
046700     WRITE TS-RUNSTAT-RECORD                                      04670003
046800                FROM WS-TS-RUNSTAT-LINE5.                         04680000
046900                                                                  04690000
047000 1110-EXIT.                                                       04700000
047100      EXIT.                                                       04710000
047200                                                                  04720000
047300                                                                  04730000
051800                                                                  05180000
051900                                                                  05190000
052000 2000-PROCESS-INCLUDE.                                            05200000
052100                                                                  05210000
052200***************************************************************** 05220000
052300*** PROCESS 'INCLUDE TABLESPACE' STATEMENT                    *** 05230000
052400*** --------------------------------------                    *** 05240000
052500*** 1) PARSE THE STATEMENT FOR DATABASE-TABLESPACE-PARTITION. *** 05250000
052600*** 2) PERFORM THRESHOLD CHECKS ON TABLESPACE AND INDEX       *** 05260000
052700***    STATISTICS.                                            *** 05270000
052800***************************************************************** 05280000
052900                                                                  05290000
053000      PERFORM 3000-PARSE-INCLUDE THRU 3000-EXIT.                  05300000
053100                                                                  05310000
053200      PERFORM 4000-CHECK-TS-THRESHOLDS THRU 4000-EXIT.            05320000
053300                                                                  05330000
053400      MOVE WS-DATABASE   TO WS-PREV-DATABASE.                     05340000
053500      MOVE WS-TABLESPACE TO WS-PREV-TABLESPACE.                   05350000
053600                                                                  05360000
053700 2000-EXIT.                                                       05370000
053800     EXIT.                                                        05380000
053900                                                                  05390000
054000                                                                  05400000
054100 3000-PARSE-INCLUDE.                                              05410000
054200                                                                  05420000
054300***************************************************************** 05430000
054400*** PARSE THE INCLUDE TABLESPACE STATEMENT.  THE FORMAT IS AS *** 05440000
054500*** FOLLOWS (PARTLEVEL MAY OR MAY NOT BE PRESENT):            *** 05450000
054600***                                                           *** 05460000
054700***  INCLUDE TABLESPACE DATABASE.TABLESPACE PARTLEVEL(#####)  *** 05470000
054800***************************************************************** 05480000
054900                                                                  05490000
055000     MOVE SPACES TO WS-UNSTRING-LINE.                             05500000
055100                                                                  05510000
055200     UNSTRING WS-INCLUDE-LINE DELIMITED BY ALL SPACE OR '.'       05520000
055300       INTO WS-FILL                                               05530000
055400            WS-INCLUDE-LIT                                        05540000
055500            WS-TABLESPACE-LIT                                     05550000
055600            WS-DATABASE                                           05560000
055700            WS-TABLESPACE                                         05570000
055800            WS-PARTLEVEL                                          05580000
055900     END-UNSTRING.                                                05590000
056000                                                                  05600000
056100     IF WS-PARTLEVEL = SPACES                                     05610000
056200         MOVE 0 TO WS-PART-NBR                                    05620000
056300     ELSE                                                         05630000
056400         UNSTRING WS-PARTLEVEL DELIMITED BY 'PARTLEVEL(' OR ')'   05640000
056500           INTO WS-FILL                                           05650000
056600                WS-PART-CHAR                                      05660000
056700         END-UNSTRING                                             05670000
056800         MOVE WS-PART-NUMERIC TO WS-PART-NBR.                     05680000
056900                                                                  05690000
057000                                                                  05700000
057100 3000-EXIT.                                                       05710000
057200     EXIT.                                                        05720000
057300                                                                  05730000
057400                                                                  05740000
057500 4000-CHECK-TS-THRESHOLDS.                                        05750000
057600                                                                  05760000
057700***************************************************************** 05770000
057800*** GET TABLESPACE-LEVEL INFORMATION THE FIRST TIME A NEW     *** 05780013
057800*** DATABASE/TABLESPACE IS ENCOUNTERED.  AT THAT TIME CHECK   *** 05781013
057800*** THE AGE OF TABLESPACE STATS AGAINST THRESHOLD.            *** 05782013
057800***                                                           *** 05783013
057900*** GET TABLESPACE PARTITION-LEVEL STATISTICS.                *** 05790000
057900*** PERFORM ADDITIONAL TABLESPACE THRESHOLD CHECKS.           *** 05791013
058200***************************************************************** 05820000
058300                                                                  05830000
058400     IF (WS-DATABASE = WS-PREV-DATABASE                           05840000
058500        AND WS-TABLESPACE = WS-PREV-TABLESPACE)                   05850000
058600         IF WS-TS-RUNSTAT = 'Y'                                   05860000
058700             GO TO 4000-EXIT                                      05870000
058800         ELSE                                                     05880000
058900             NEXT SENTENCE                                        05890000
059000         END-IF                                                   05900000
059100     ELSE                                                         05910000
059200         IF WS-TS-RUNSTAT = 'N'                                   05920000
059300             PERFORM 5000-CHECK-IX-THRESHOLDS THRU 5000-EXIT      05930000
059400             IF WS-TS-RUNSTAT = 'Y'                               05940000
059500                 MOVE 'Y'    TO WS-PROCESS-PREV                   05950000
059600                 PERFORM 7000-RUNSTAT-TS THRU 7000-EXIT           05960000
059700             END-IF                                               05970000
059800         END-IF                                                   05980000
059900         MOVE WS-DATABASE TO WS-PREV-DATABASE                     05990000
060000         MOVE WS-TABLESPACE TO WS-PREV-TABLESPACE                 06000000
060100         MOVE 'N' TO WS-TS-RUNSTAT                                06010000
060200         PERFORM 4005-GET-TS-DETAILS THRU 4005-EXIT               06020000
060200         PERFORM 4006-CHECK-STATS-AGE THRU 4006-EXIT              06021013
               IF WS-TS-RUNSTAT = 'Y'                                   06022013
059600             PERFORM 7000-RUNSTAT-TS THRU 7000-EXIT               06023013
058700             GO TO 4000-EXIT                                      06024013
060300         END-IF                                                   06030013
060300     END-IF.                                                      06031013
060400                                                                  06040000
00         PERFORM 4010-GET-TS-PART-STATS THRU 4010-EXIT.               06050013
060600                                                                  06060000
060700     MOVE 'N' TO WS-TS-RUNSTAT.                                   06070000
060600                                                                  06071013
060800     PERFORM 4001-CHECK-FOR-NULLS THRU 4001-EXIT.                 06080000
060600                                                                  06081011
060900     IF WS-TS-RUNSTAT = 'N'                                       06090000
061000         PERFORM 4002-CHECK-MASSDELETE THRU 4002-EXIT.            06100000
060600                                                                  06101011
061100     IF WS-TS-RUNSTAT = 'N'                                       06110000
061200        AND SYSRTSTS-TOTALROWS > 0                                06120000
061300         PERFORM 4003-CHECK-CHGD-ROWS THRU 4003-EXIT.             06130000
061400                                                                  06140000
061500     IF WS-TS-RUNSTAT = 'N'                                       06150000
061600         PERFORM 4004-CHECK-DATE THRU 4004-EXIT                   06160000
061700     END-IF.                                                      06170000
061400                                                                  06171013
061800     IF WS-TS-RUNSTAT = 'Y'                                       06180000
061900         PERFORM 7000-RUNSTAT-TS THRU 7000-EXIT                   06190000
062000     END-IF.                                                      06200000
062100                                                                  06210000
062200 4000-EXIT.                                                       06220000
062300     EXIT.                                                        06230000
062500                                                                  06250000
062600                                                                  06260000
062700 4001-CHECK-FOR-NULLS.                                            06270000
062800                                                                  06280000
062900     IF TS-TOTALROWS-NULLIND = -1                                 06290000
063000      OR TS-STATSLASTTIME-NULLIND = -1                            06300000
063100      OR TS-STATSMASSDELETE-NULLIND = -1                          06310000
063200      OR TS-STATSINSERTS-NULLIND = -1                             06320000
063300      OR TS-STATSDELETES-NULLIND = -1                             06330000
063400      OR TS-STATSUPDATES-NULLIND = -1                             06340000
063500         MOVE 'Y' TO WS-TS-RUNSTAT                                06350000
063600     END-IF.                                                      06360000
063700                                                                  06370000
063800 4001-EXIT.                                                       06380000
063900     EXIT.                                                        06390000
064000                                                                  06400000
064000                                                                  06401013
064100 4002-CHECK-MASSDELETE.                                           06410000
064200     IF SYSRTSTS-STATSMASSDELETE  > 0                             06420013
064300         MOVE 'Y' TO WS-TS-RUNSTAT.                               06430013
064000                                                                  06431013
064400 4002-EXIT.                                                       06440000
064500     EXIT.                                                        06450000
064600                                                                  06460000
064600                                                                  06461013
064700 4003-CHECK-CHGD-ROWS.                                            06470000
064600                                                                  06471013
064800     COMPUTE WS-ROWS-CHG-PCT =                                    06480000
064900        (((SYSRTSTS-STATSINSERTS  +                               06490008
065000           SYSRTSTS-STATSDELETES  +                               06500000
065100           SYSRTSTS-STATSUPDATES ) *                              06510008
065110           100 ) /                                                06511008
065200              SYSRTSTS-TOTALROWS).                                06520000
065300                                                                  06530000
065400     COMPUTE WS-ROWS-CHANGED-TBL =                                06540000
065500           SYSRTSTS-STATSINSERTS  +                               06550000
065600           SYSRTSTS-STATSDELETES  +                               06560000
065700           SYSRTSTS-STATSUPDATES.                                 06570000
065800                                                                  06580000
065900     IF WS-ROWS-CHG-PCT > WS-THRESH-PCT-TBL-ROWS-CHGD             06590000
066000         AND WS-ROWS-CHANGED-TBL > WS-THRESH-NBR-TBL-ROWS-CHGD    06600000
066100             MOVE 'Y' TO WS-TS-RUNSTAT                            06610000
066200     END-IF.                                                      06620000
066300                                                                  06630000
066400 4003-EXIT.                                                       06640000
066500     EXIT.                                                        06650000
066600                                                                  06660000
066700                                                                  06670000
066800 4004-CHECK-DATE.                                                 06680000
066900                                                                  06690000
067000***************************************************************** 06700000
067100*** CHECK THE TIME GAP BETWEEN THE MOST RECENT RUNSTATS DATE  *** 06710000
067200*** AND THE EARLIEST RUNSTATS DATE FOR THE TABLESPACE AND     *** 06720000
067300*** INDEXES.                                                  *** 06730000
067400***************************************************************** 06740000
067500     EXEC SQL                                                     06750000
067600       WITH TIMESTAMP_VALUES(OBJ_TIMESTAMP)                       06760000
067700       AS                                                         06770000
067800       (SELECT DISTINCT TP.STATSTIME                              06780000
067900            FROM SYSIBM.SYSTABLEPART TP                           06790000
068000                WHERE TP.DBNAME  = :WS-DATABASE                   06800000
068100                  AND TP.TSNAME  = :WS-TABLESPACE                 06810000
068200       UNION                                                      06820000
068300        SELECT DISTINCT IP.STATSTIME                              06830000
068400            FROM SYSIBM.SYSTABLES TBL,                            06840000
068500                 SYSIBM.SYSINDEXES IX,                            06850000
068600                 SYSIBM.SYSINDEXPART IP                           06860000
068700                WHERE TBL.DBNAME  = :WS-DATABASE                  06870000
068800                  AND TBL.TSNAME  = :WS-TABLESPACE                06880000
068900                  AND IX.TBCREATOR = TBL.CREATOR                  06890000
069000                  AND IX.TBNAME    = TBL.NAME                     06900000
069100                  AND IX.CREATOR   = IP.IXCREATOR                 06910000
069200                  AND IX.NAME      = IP.IXNAME)                   06920000
069300                                                                  06930000
069400       SELECT TIMESTAMPDIFF(16,CAST(MAX(OBJ_TIMESTAMP) -          06940000
069500                MIN(OBJ_TIMESTAMP) AS CHAR(22)))                  06950000
069600       AS DIFFERENCE_IN_DAYS                                      06960000
069700       INTO :WS-DAYS-DIFFERENCE                                   06970000
069800       FROM TIMESTAMP_VALUES                                      06980000
069900       WITH UR                                                    06990000
070000     END-EXEC.                                                    07000000
070100                                                                  07010000
070200     IF  SQLCODE = ZERO                                           07020000
070300         NEXT SENTENCE                                            07030000
070400     ELSE                                                         07040000
070500         DISPLAY '******************************************'     07050000
070600         DISPLAY '*** PROGRAM ERROR - DBKUT036           ***'     07060000
070700         DISPLAY '***                                    ***'     07070000
070800         DISPLAY '*** PARAGRAPH 4004-CHECK-DATE          ***'     07080000
070900         DISPLAY '*** BAD SELECT FOR TIMESTAMPS          ***'     07090000
071000         DISPLAY '******************************************'     07100000
071100         PERFORM 9999-DB2-ABEND                                   07110000
071200     END-IF.                                                      07120000
071300                                                                  07130000
071400     IF WS-DAYS-DIFFERENCE > WS-THRESH-STAT-DAYS-DIFF             07140010
071500         MOVE 'Y' TO WS-TS-RUNSTAT                                07150000
071600     END-IF.                                                      07160000
071700                                                                  07170000
071800 4004-EXIT.                                                       07180000
071900     EXIT.                                                        07190000
072000                                                                  07200000
072000                                                                  07201013
072100 4005-GET-TS-DETAILS.                                             07210000
072200                                                                  07220000
072300***************************************************************** 07230000
072400*** SYSTABLESPACE IS ACCESSED FOR DBID, PSID, AND PARTITIONS  *** 07240014
072500*** VALUES ALONG WITH THE NUMBER OF DAYS SINCE THE LAST TIME  *** 07250014
072500*** STATISTICS WERE COLLECTED.                                *** 07251014
072600***************************************************************** 07260000
072700                                                                  07270000
072800     EXEC SQL                                                     07280000
072900       SELECT DBID,PSID,PARTITIONS,                               07290013
072900              DAYS(CURRENT DATE) - DAYS(STATSTIME)                07291013
073000         INTO :SYSTABSP-DBID,                                     07300000
073100              :SYSTABSP-PSID,                                     07310000
073200              :SYSTABSP-PARTITIONS,                               07320013
073200              :WS-STATS-DAYS-OLD                                  07321014
073300            FROM SYSIBM.SYSTABLESPACE                             07330000
073400         WHERE DBNAME    = :WS-DATABASE                           07340000
073500           AND NAME      = :WS-TABLESPACE                         07350000
073600         WITH UR                                                  07360000
073700     END-EXEC.                                                    07370000
073800                                                                  07380000
073900     IF  SQLCODE NOT = ZERO                                       07390000
074000         DISPLAY '******************************************'     07400000
074100         DISPLAY '*** PROGRAM ERROR - DBKUT036           ***'     07410000
074200         DISPLAY '***                                    ***'     07420000
074300         DISPLAY '*** PARAGRAPH 4005-GET-TS-DETAILS      ***'     07430000
074400         DISPLAY '*** BAD SELECT ON SYSTABLESPACE        ***'     07440000
074500         DISPLAY '******************************************'     07450000
074600         PERFORM 9999-DB2-ABEND                                   07460000
074700     END-IF.                                                      07470000
074800                                                                  07480000
074900     IF SYSTABSP-PARTITIONS = 0                                   07490000
075000         MOVE 'N' TO WS-PARTITIONED-TSPACE                        07500000
075100     ELSE                                                         07510000
075200         MOVE 'Y' TO WS-PARTITIONED-TSPACE.                       07520000
075400                                                                  07540000
075500 4005-EXIT.                                                       07550000
075600     EXIT.                                                        07560000
075700                                                                  07570000
075800                                                                  07580000
064100 4006-CHECK-STATS-AGE.                                            07581015
075800                                                                  07581113
064200     IF WS-STATS-DAYS-OLD > WS-THRESH-STATS-AGE                   07582013
064300         MOVE 'Y' TO WS-TS-RUNSTAT.                               07583013
075800                                                                  07583113
064400 4006-EXIT.                                                       07584013
064500     EXIT.                                                        07585013
064600                                                                  07586013
064600                                                                  07587013
075900 4010-GET-TS-PART-STATS.                                          07590000
076000                                                                  07600000
076100***************************************************************** 07610000
076200*** GET REALTIME STATISTICAL INFORMATION.                     *** 07620000
076300***                                                           *** 07630000
076400*** FOR REALTIME STATISTICS, A VALUE OF NULL INDICATES THE    *** 07640000
076500*** ABSENCE OF RUNSTAT STATISTICS. IN THAT SITUATION A RUNSTAT*** 07650000
076600*** WILL BE FORCED.                                           *** 07660000
076700***************************************************************** 07670000
076800                                                                  07680000
076900     EXEC SQL                                                     07690000
077000       SELECT TOTALROWS, STATSLASTTIME, STATSMASSDELETE,          07700000
077100              STATSINSERTS, STATSDELETES, STATSUPDATES            07710000
077200         INTO :SYSRTSTS-TOTALROWS                                 07720000
077300                INDICATOR :TS-TOTALROWS-NULLIND,                  07730000
077400              :SYSRTSTS-STATSLASTTIME                             07740000
077500                INDICATOR :TS-STATSLASTTIME-NULLIND,              07750000
077600              :SYSRTSTS-STATSMASSDELETE                           07760000
077700                INDICATOR :TS-STATSMASSDELETE-NULLIND,            07770000
077800              :SYSRTSTS-STATSINSERTS                              07780000
077900                INDICATOR :TS-STATSINSERTS-NULLIND,               07790000
078000              :SYSRTSTS-STATSDELETES                              07800000
078100                INDICATOR :TS-STATSDELETES-NULLIND,               07810000
078200              :SYSRTSTS-STATSUPDATES                              07820000
078300                INDICATOR :TS-STATSUPDATES-NULLIND                07830000
078400            FROM SYSIBM.SYSTABLESPACESTATS                        07840000
078500                WHERE DBID        = :SYSTABSP-DBID                07850000
078600                    AND PSID      = :SYSTABSP-PSID                07860000
078700                    AND PARTITION = :WS-PART-NBR                  07870000
078800            WITH UR                                               07880000
078900     END-EXEC.                                                    07890000
079000                                                                  07900000
079100     IF SQLCODE = ZERO                                            07910000
079200         NEXT SENTENCE                                            07920000
079300     ELSE                                                         07930000
079400         IF SQLCODE = +100                                        07940000
079500             MOVE -99 TO  TS-TOTALROWS-NULLIND                    07950000
079600                          TS-STATSLASTTIME-NULLIND                07960000
079700                          TS-STATSMASSDELETE-NULLIND              07970000
079800                          TS-STATSINSERTS-NULLIND                 07980000
079900                          TS-STATSDELETES-NULLIND                 07990000
080000                          TS-STATSUPDATES-NULLIND                 08000000
080100         ELSE                                                     08010000
080200             DISPLAY '******************************************' 08020000
080300             DISPLAY '*** PROGRAM ERROR - DBKUT036           ***' 08030000
080400             DISPLAY '***                                    ***' 08040000
080500             DISPLAY 'DB          = ' WS-DATABASE                 08050000
080600             DISPLAY 'TS          = ' WS-TABLESPACE               08060000
080700             DISPLAY 'DBID        = ' SYSTABSP-DBID               08070000
080800             DISPLAY 'PSID        = ' SYSTABSP-PSID               08080000
080900             DISPLAY '*** PARAGRAPH 4010-GET-TS-PART-STATS   ***' 08090000
081000             DISPLAY '*** BAD SELECT ON SYSTABLESPACESTATS   ***' 08100000
081100             DISPLAY '******************************************' 08110000
081200             PERFORM 9999-DB2-ABEND                               08120000
081300         END-IF                                                   08130000
081400     END-IF.                                                      08140000
081500                                                                  08150000
081600                                                                  08160000
081700 4010-EXIT.                                                       08170000
081800     EXIT.                                                        08180000
081900                                                                  08190000
082000                                                                  08200000
082100 5000-CHECK-IX-THRESHOLDS.                                        08210000
082200                                                                  08220000
082300*--------------------------------------------------------------   08230000
082400*-- CHECK INDEXES FOR RUNSTAT ELIGIBILITY IF TABLESPACE IS NOT    08240000
082500*-- BEING RUNSTATED.                                              08250000
082600*--------------------------------------------------------------   08260000
082700                                                                  08270000
082800     MOVE WS-PREV-DATABASE TO WS-IX-CSR-DATABASE.                 08280000
082900     MOVE WS-PREV-TABLESPACE TO WS-IX-CSR-TABLESPACE.             08290000
083000                                                                  08300000
083100     PERFORM 5100-PROCESS-INDEXES THRU 5100-EXIT.                 08310000
083200                                                                  08320000
083300 5000-EXIT.                                                       08330000
083400     EXIT.                                                        08340000
083500                                                                  08350000
083600                                                                  08360000
083700 5100-PROCESS-INDEXES.                                            08370000
083800                                                                  08380000
083900***************************************************************** 08390000
084000*** GET VARIOUS INDEX-LEVEL STATISTICS.                       *** 08400000
084100***************************************************************** 08410000
084200                                                                  08420000
084300     EXEC SQL                                                     08430000
084400        OPEN INDEX-CURSOR                                         08440000
084500     END-EXEC.                                                    08450000
084600                                                                  08460000
084700     IF  SQLCODE NOT = ZERO                                       08470000
084800         DISPLAY '******************************************'     08480000
084900         DISPLAY '*** PROGRAM ERROR - DBKUT036           ***'     08490000
085000         DISPLAY '***                                    ***'     08500000
085100         DISPLAY '*** PARAGRAPH 5100-PROCESS-INDEXES     ***'     08510000
085200         DISPLAY '*** BAD OPEN ON INDEX-CURSOR           ***'     08520000
085300         DISPLAY '******************************************'     08530000
085400         PERFORM 9999-DB2-ABEND.                                  08540000
085500                                                                  08550000
085600     MOVE 'N' TO WS-NO-MORE-INDEXES.                              08560000
085700                                                                  08570000
085800     PERFORM 5200-FETCH-IX-STATS THRU 5200-EXIT                   08580000
085900         UNTIL WS-NO-MORE-INDEXES = 'Y'                           08590000
086000         OR WS-TS-RUNSTAT = 'Y'.                                  08600000
086100                                                                  08610000
086200     EXEC SQL                                                     08620000
086300        CLOSE INDEX-CURSOR                                        08630000
086400     END-EXEC.                                                    08640000
086500                                                                  08650000
086600     IF  SQLCODE NOT = ZERO                                       08660000
086700         DISPLAY '******************************************'     08670000
086800         DISPLAY '*** PROGRAM ERROR - DBKUT036           ***'     08680000
086900         DISPLAY '***                                    ***'     08690000
087000         DISPLAY '*** PARAGRAPH 5100-PROCESS-INDEXES     ***'     08700000
087100         DISPLAY '*** BAD CLOSE ON INDEX-CURSOR          ***'     08710000
087200         DISPLAY '******************************************'     08720000
087300         PERFORM 9999-DB2-ABEND.                                  08730000
087400                                                                  08740000
087500 5100-EXIT.                                                       08750000
087600     EXIT.                                                        08760000
087700                                                                  08770000
087800                                                                  08780000
087900 5200-FETCH-IX-STATS.                                             08790000
088000                                                                  08800000
088100***************************************************************** 08810000
088200*** 1)  FETCH ROW FROM INDEX-CURSOR.                          *** 08820000
088300*** 2)  OBTAIN REALTIME STATISTICS FOR INDEX.                 *** 08830000
088400*** 3)  CHECK INDEX RUNSTAT THRESHOLDS.                       *** 08840000
088500***************************************************************** 08850000
088600                                                                  08860000
088700                                                                  08870000
088800     MOVE ZERO   TO SYSINDEX-DBID                                 08880000
088900                SYSINDEX-ISOBID                                   08890000
089000                SYSIXPT-PARTITION.                                08900000
089100     EXEC SQL                                                     08910000
089200         FETCH INDEX-CURSOR                                       08920000
089300          INTO :SYSINDEX-DBID,                                    08930000
089400               :SYSINDEX-ISOBID,                                  08940000
089500               :SYSIXPT-PARTITION                                 08950000
089600     END-EXEC.                                                    08960000
089700                                                                  08970000
089800     IF SQLCODE = +0                                              08980000
089900         NEXT SENTENCE                                            08990000
090000     ELSE                                                         09000000
090100         IF SQLCODE = +100                                        09010000
090200             MOVE 'Y' TO WS-NO-MORE-INDEXES                       09020000
090300             GO TO 5200-EXIT                                      09030000
090400         ELSE                                                     09040000
090500             DISPLAY '*****************************************'  09050000
090600             DISPLAY '*** PROGRAM ERROR - DBKUT036          ***'  09060000
090700             DISPLAY '***                                   ***'  09070000
090800             DISPLAY '*** PARAGRAPH 5200-FETCH-IX-STATS     ***'  09080000
090900             DISPLAY '*** BAD FETCH ON INDEX-CURSOR         ***'  09090000
091000             DISPLAY '*****************************************'  09100000
091100             PERFORM 9999-DB2-ABEND.                              09110000
091200                                                                  09120000
091300     EXEC SQL                                                     09130000
091400       SELECT TOTALENTRIES, STATSLASTTIME, STATSMASSDELETE,       09140000
091500              STATSINSERTS, STATSDELETES                          09150000
091600         INTO :SYSRTSIX-TOTALENTRIES                              09160000
091700                INDICATOR :IX-TOTALENTRIES-NULLIND,               09170000
091800              :SYSRTSIX-STATSLASTTIME                             09180000
091900                INDICATOR :IX-STATSLASTTIME-NULLIND,              09190000
092000              :SYSRTSIX-STATSMASSDELETE                           09200000
092100                INDICATOR :IX-STATSMASSDELETE-NULLIND,            09210000
092200              :SYSRTSIX-STATSINSERTS                              09220000
092300                INDICATOR :IX-STATSINSERTS-NULLIND,               09230000
092400              :SYSRTSIX-STATSDELETES                              09240000
092500                INDICATOR :IX-STATSDELETES-NULLIND                09250000
092600            FROM SYSIBM.SYSINDEXSPACESTATS                        09260000
092700                WHERE DBID        = :SYSINDEX-DBID                09270000
092800                    AND ISOBID    = :SYSINDEX-ISOBID              09280000
092900                    AND PARTITION = :SYSIXPT-PARTITION            09290000
093000            WITH UR                                               09300000
093100     END-EXEC.                                                    09310000
093200                                                                  09320000
093300     IF  SQLCODE = ZERO                                           09330000
093400         NEXT SENTENCE                                            09340000
093500     ELSE                                                         09350000
093600         IF SQLCODE = +100                                        09360000
093700             MOVE -99 TO IX-TOTALENTRIES-NULLIND                  09370000
093800                         IX-STATSLASTTIME-NULLIND                 09380000
093900                         IX-STATSMASSDELETE-NULLIND               09390000
094000                         IX-STATSINSERTS-NULLIND                  09400000
094100                         IX-STATSDELETES-NULLIND                  09410000
094200         ELSE                                                     09420000
094300             DISPLAY '******************************************' 09430000
094400             DISPLAY '*** PROGRAM ERROR - DBKUT036           ***' 09440000
094500             DISPLAY '***                                    ***' 09450000
094600             DISPLAY '*** PARAGRAPH 5200-FETCH-IX-STATS      ***' 09460000
094700             DISPLAY '*** BAD SELECT ON SYSINDEXSPACESTATS   ***' 09470000
094800             DISPLAY '******************************************' 09480000
094900             PERFORM 9999-DB2-ABEND                               09490000
095000         END-IF                                                   09500000
095100     END-IF.                                                      09510000
095200                                                                  09520000
095300     PERFORM 5300-CHECK-IX-THRESHOLDS THRU 5300-EXIT.             09530000
095400                                                                  09540000
095500 5200-EXIT.                                                       09550000
095600     EXIT.                                                        09560000
095700                                                                  09570000
095800                                                                  09580000
095900 5300-CHECK-IX-THRESHOLDS.                                        09590000
096000                                                                  09600000
096100                                                                  09610000
096200     IF IX-TOTALENTRIES-NULLIND = -1                              09620000
096300      OR IX-STATSLASTTIME-NULLIND = -1                            09630000
096400      OR IX-STATSMASSDELETE-NULLIND = -1                          09640000
096500      OR IX-STATSINSERTS-NULLIND = -1                             09650000
096600      OR IX-STATSDELETES-NULLIND = -1                             09660000
096700         MOVE 'Y' TO WS-TS-RUNSTAT                                09670000
096800         GO TO 5300-EXIT                                          09680000
096900     END-IF.                                                      09690000
097000                                                                  09700000
097100     IF SYSRTSIX-STATSMASSDELETE  > 0                             09710000
097200         MOVE 'Y' TO WS-TS-RUNSTAT                                09720000
097300         GO TO 5300-EXIT                                          09730000
097400     END-IF.                                                      09740000
097500                                                                  09750000
097600     IF SYSRTSIX-TOTALENTRIES > 0                                 09760000
097700         NEXT SENTENCE                                            09770000
097800     ELSE                                                         09780000
097900         GO TO 5300-EXIT                                          09790000
098000     END-IF.                                                      09800000
098100                                                                  09810000
098200     COMPUTE WS-IX-ENTRIES-CHGD-PCT =                             09820000
098300     (((SYSRTSIX-STATSINSERTS +                                   09830008
098400        SYSRTSIX-STATSDELETES) *                                  09840008
098410        100) /                                                    09841008
098500        SYSRTSIX-TOTALENTRIES ).                                  09850000
098600                                                                  09860000
098700     COMPUTE WS-NBR-IX-ENTRIES-CHGD =                             09870000
098800        SYSRTSIX-STATSINSERTS +                                   09880000
098900        SYSRTSIX-STATSDELETES.                                    09890000
099000                                                                  09900000
099100     IF WS-IX-ENTRIES-CHGD-PCT > WS-THRESH-PCT-IX-ENTRIES-CHGD AND09910000
099200        WS-NBR-IX-ENTRIES-CHGD > WS-THRESH-NBR-IX-ENTRIES-CHGD    09920000
099300             MOVE 'Y' TO WS-TS-RUNSTAT                            09930000
099400     END-IF.                                                      09940000
099500                                                                  09950000
099600 5300-EXIT.                                                       09960000
099700     EXIT.                                                        09970000
099800                                                                  09980000
099900                                                                  09990000
100000                                                                  10000000
100100 7000-RUNSTAT-TS.                                                 10010000
100200                                                                  10020000
100300***************************************************************** 10030000
100400*** SAVE THE DATABASE-TABLESPACE TO BE RUNSTATED              *** 10040000
100500*** IN A WORKING STORAGE TABLE.                               *** 10050000
100600***                                                           *** 10060000
101500***************************************************************** 10150000
101600                                                                  10160000
101800     PERFORM 7010-STORE-TS-DB THRU 7010-EXIT.                     10180005
102200                                                                  10220000
102300 7000-EXIT.                                                       10230000
102400     EXIT.                                                        10240000
102500                                                                  10250000
102600***************************************************************** 10260000
102700*** STORE THE TABLESPACE IN THE ARRAY FOR THOSE TABLESPACES   *** 10270000
102800*** TO BE RUNSTATED                                           *** 10280005
102900***************************************************************** 10290000
103000                                                                  10300000
103100 7010-STORE-TS-DB.                                                10310005
103200     IF WS-TS-RUNSTAT-COUNT >= 5000                               10320005
103300         DISPLAY '******************************************'     10330000
103400         DISPLAY '*** PROGRAM ERROR - DBKUT036           ***'     10340000
103500         DISPLAY '***                                    ***'     10350000
103600         DISPLAY '*** PARAGRAPH 7010-STORE-TS-DB         ***'     10360005
103700         DISPLAY '*** ARRAY IS FULL                      ***'     10370000
103800         DISPLAY '******************************************'     10380000
103900         MOVE +4004 TO WS-ABEND-CODE                              10390000
104000         PERFORM 9999-ABEND                                       10400000
104100     END-IF.                                                      10410000
104200                                                                  10420000
104300     ADD +1 TO WS-TS-RUNSTAT-COUNT.                               10430005
104400                                                                  10440000
104500     IF WS-PROCESS-PREV = 'N'                                     10450000
104600         MOVE WS-DATABASE                                         10460000
104700             TO WS-TS-RUNSTAT-DB (WS-TS-RUNSTAT-COUNT)            10470006
104800                                                                  10480000
104900         MOVE WS-TABLESPACE                                       10490000
105000             TO WS-TS-RUNSTAT-TS (WS-TS-RUNSTAT-COUNT)            10500006
105100     ELSE                                                         10510000
105200         MOVE WS-PREV-DATABASE                                    10520000
105300             TO WS-TS-RUNSTAT-DB (WS-TS-RUNSTAT-COUNT)            10530006
105400                                                                  10540000
105500         MOVE WS-PREV-TABLESPACE                                  10550000
105600             TO WS-TS-RUNSTAT-TS (WS-TS-RUNSTAT-COUNT)            10560006
105700     END-IF.                                                      10570000
105800                                                                  10580000
105900                                                                  10590000
106000 7010-EXIT.                                                       10600000
106100     EXIT.                                                        10610000
106200                                                                  10620000
106300***************************************************************** 10630000
106400*** STORE THE TABLESPACE IN THE ARRAY FOR THOSE TABLESPACES   *** 10640000
106500*** RUNSTATED WITH THE 'SYSTEM AUTO' KEYWORD.                 *** 10650000
106600***************************************************************** 10660000
106700                                                                  10670000
110300                                                                  11030000
110400 9999-DB2-ABEND.                                                  11040000
110500                                                                  11050000
110600     CALL 'DSNTIAR' USING SQLCA                                   11060000
110700                          DP004-FORMATTED-MESSAGE                 11070000
110800                          DP004-ERROR-LINE-LENGTH.                11080000
110900                                                                  11090000
111000     DISPLAY DP004-ASTERISK-LINE.                                 11100000
111100                                                                  11110000
111200     PERFORM                                                      11120000
111300         VARYING DP004-MSG-IDX                                    11130000
111400         FROM 1 BY 1                                              11140000
111500         UNTIL DP004-MSG-IDX > DP004-MAX-MESSAGE-LINES            11150000
111600             DISPLAY '**'                                         11160000
111700                     DP004-MESSAGE-LINE (DP004-MSG-IDX)           11170000
111800                     ' **'                                        11180000
111900     END-PERFORM.                                                 11190000
112000                                                                  11200000
112100     DISPLAY DP004-ASTERISK-LINE.                                 11210000
112200                                                                  11220000
112300     MOVE +4013      TO WS-ABEND-CODE                             11230000
112400     CALL 'ILBOABN0' USING WS-ABEND-CODE.                         11240000
112500                                                                  11250000
112600 9999-ABEND.                                                      11260000
112700                                                                  11270000
112800     CALL 'ILBOABN0' USING WS-ABEND-CODE.                         11280000
112900                                                                  11290000
113000                                                                  11300000
