000100 IDENTIFICATION DIVISION.                                         00010007
000200 PROGRAM-ID.    XLKUP013.                                         00020007
000300 AUTHOR.        LYNN MCADAMS.                                     00030007
000400 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00040007
000500 DATE-WRITTEN.  MARCH 2003.                                       00050007
000600 DATE-COMPILED.                                                   00060007
000700*                                                                 00070007
000800******************************************************************00080007
000900* CALLED MODULE                                                   00090007
001000******************************************************************00100007
001100* THIS PROGRAM CALCULATES THE VALUE OF THE FOLLOWING 5 COLUMNS    00110007
001200* ON THE TPURCHS TABLE.                                           00120007
001300*                                                                 00130007
001400* FOR EACH PO:                                                    00140007
001500* - TPURCHS.TOT_UNT_QTY                                           00150007
001600* - TPURCHS.TOT_VAL_COST_AMT                                      00160007
001700* - TPURCHS.TOT_VAL_RTL_AMT                                       00170007
001800* - TPURCHS.TOT_MU_PCT                                            00180007
001900* - TPURCHS.TOT_SKUS_QTY                                          00190007
002000*                                                                 00200007
002100* FOR NON-PACK MESSAGES, THIS MODULE IS CALLED FROM XLKUT023.     00210007
002200* FOR PACK MESSAGES, THIS MODULE IS CALLED FROM XLKUP017.         00220007
002300*                                                                 00230007
002400* THE CALLING PROGRAM PASSES THE MESSAGE ID AND PO NUMBER.        00240007
002500*                                                                 00250007
002600* THIS PROGRAM WILL PASS A RETURN CODE BACK, EITHER SUCCESSFUL,   00260007
002700* OR NOT SUCCESSFUL, OTHER ERRORS, ETC. TO THE CALLING PROGRAM.   00270007
002800******************************************************************00280007
002900*                                                                 00290007
003000 ENVIRONMENT DIVISION.                                            00300007
003100 CONFIGURATION SECTION.                                           00310007
003200 SOURCE-COMPUTER.  IBM-3090.                                      00320007
003300 OBJECT-COMPUTER.  IBM-3090.                                      00330007
003400 DATA DIVISION.                                                   00340007
003500                                                                  00350007
003600 WORKING-STORAGE SECTION.                                         00360007
003700                                                                  00370007
003800 01  PS-PROGRAM-SWITCHES.                                         00380007
003900     05  PS-ERROR-SW                  PIC X(01)  VALUE 'N'.       00390007
004000         88  PS-ERROR                            VALUE 'Y'.       00400007
004100         88  PS-NO-ERROR                         VALUE 'N'.       00410007
004200                                                                  00420007
004300 01  PV-PROGRAM-VARIABLES.                                        00430007
004400     05  PV-TOT-UNT-QTY              PIC  S9(9) COMP.             00440007
004500     05  PV-TOT-VAL-COST-AMT         PIC  S9(8)V9(2) COMP-3.      00450007
004600     05  PV-TOT-VAL-RTL-AMT          PIC  S9(8)V9(2) COMP-3.      00460007
004700     05  PV-TOT-MU-PCT               PIC  S9(3)V9(4) COMP-3.      00470007
004800     05  PV-RESULT                   PIC  S9(8)V9(2) COMP-3.      00480007
004900     05  PV-TOT-SKUS-QTY             PIC  S9(4) COMP.             00490007
005000     05  PV-IND1                     PIC S9(04) COMP.             00500007
005100     05  PV-IND2                     PIC S9(04) COMP.             00510007
005200     05  PV-IND3                     PIC S9(04) COMP.             00520007
005300     05  PV-IND4                     PIC S9(04) COMP.             00530007
005400                                                                  00540007
005500 01  DK-DB-KEYS.                                                  00550007
005600     05  DK-PO-NBR                   PIC  S9(9) COMP.             00560007
005700                                                                  00570007
005800*PO-PURCHASE TABLE                                                00580007
005900     EXEC SQL                                                     00590007
006000         INCLUDE TPURCHS                                          00600007
006100     END-EXEC.                                                    00610007
006200                                                                  00620007
006300*PO-PURCHASE ITEM TABLE                                           00630007
006400     EXEC SQL                                                     00640007
006500         INCLUDE TPURITM                                          00650007
006600     END-EXEC.                                                    00660007
006700                                                                  00670007
006800     EXEC SQL                                                     00680007
006900          INCLUDE SQLCA                                           00690007
007000     END-EXEC.                                                    00700007
007100                                                                  00710007
007200     COPY SQLCA2.                                                 00720007
007300                                                                  00730007
007400                                                                  00740007
007500                                                                  00750007
007600 LINKAGE SECTION.                                                 00760007
007700 01  XLRD011-RECORD.                                              00770007
007800     COPY XLRD011.                                                00780007
007900/                                                                 00790007
008000 PROCEDURE DIVISION USING XLRD011-RECORD.                         00800007
008100                                                                  00810007
008200     PERFORM 1000-INITIALIZATION.                                 00820007
008300                                                                  00830007
008400     PERFORM 2000-PROCESSING.                                     00840007
008500                                                                  00850007
008600     PERFORM 9999-WRAPUP.                                         00860007
008700                                                                  00870007
008800     GOBACK.                                                      00880007
008900                                                                  00890007
009000 1000-INITIALIZATION.                                             00900007
009100                                                                  00910007
009200     IF XL011-DEBUG-YES                                           00920007
009300         DISPLAY 'XLKUP013 - 1000-INITIALIZE'                     00930007
009400     END-IF                                                       00940007
009500                                                                  00950007
009600     INITIALIZE XL011-RETURN-AREA                                 00960007
009700                                                                  00970007
009800     MOVE 'XLKUP013'                  TO XL011-ERROR-PROGRAM.     00980007
009900                                                                  00990007
010000     INITIALIZE PS-ERROR-SW.                                      01000007
010100                                                                  01010007
010200     INITIALIZE DK-PO-NBR.                                        01020007
010300     MOVE XL011-ORDER-NBR TO DK-PO-NBR.                           01030007
010400/                                                                 01040007
010500                                                                  01050007
010600 2000-PROCESSING.                                                 01060007
010700                                                                  01070007
010800     IF XL011-DEBUG-YES                                           01080007
010900         DISPLAY 'XLKUP013 - 2000-PROCESSING'                     01090007
011000     END-IF                                                       01100007
011100                                                                  01110007
011200     PERFORM 2100-SELECT-TPURITM                                  01120007
011300                                                                  01130007
011400     IF PS-NO-ERROR                                               01140007
011500        PERFORM 2300-GET-TOT-SKUS                                 01150007
011600        PERFORM 7520-UPDATE-TPURCHS                               01160007
011700     ELSE                                                         01170007
011800        CONTINUE                                                  01180007
011900     END-IF.                                                      01190007
012000/                                                                 01200007
012100                                                                  01210007
012200*SUM VALUES FROM TPURITM                                          01220007
012300 2100-SELECT-TPURITM.                                             01230007
012400                                                                  01240007
012500     IF XL011-DEBUG-YES                                           01250007
012600         DISPLAY 'XLKUP013 - 2100-SELECT-TPURITM'                 01260007
012700     END-IF                                                       01270007
012800                                                                  01280007
012900     INITIALIZE PV-TOT-UNT-QTY                                    01290007
013000                PV-TOT-VAL-COST-AMT                               01300007
013100                PV-TOT-VAL-RTL-AMT                                01310007
013200                PV-RESULT                                         01320007
013300                                                                  01330007
013400      EXEC SQL                                                    01340007
013500         SELECT                                                   01350007
013600           SUM(UNT_QTY)                                           01360007
013700        ,  SUM(UNT_QTY * UNT_COST_AMT)                            01370007
013800        ,  SUM(TOT_VAL_RTL_AMT)                                   01380007
013900*       ,  SUM(TOT_VAL_RTL_AMT) - SUM(TOT_VAL_COST_AMT)           01390007
014000                                                                  01400007
014100           INTO  :PV-TOT-UNT-QTY:PV-IND1                          01410007
014200              ,  :PV-TOT-VAL-COST-AMT:PV-IND2                     01420007
014300              ,  :PV-TOT-VAL-RTL-AMT:PV-IND3                      01430007
014400*             ,  :PV-RESULT:PV-IND4                               01440007
014500                                                                  01450007
014600           FROM  TPURITM                                          01460007
014700          WHERE  PO_NBR              = :DK-PO-NBR                 01470007
014800            AND  VER_STATUS_CDE      = 'A'                        01480007
014900            AND  STATUS_CDE          <>'CA'                       01490007
015000      WITH UR                                                     01500007
015100      END-EXEC.                                                   01510007
015200                                                                  01520007
015300      MOVE SQLCODE                     TO XL011-SQLCODE           01530007
015400      EVALUATE TRUE                                               01540007
015500         WHEN SQLCODE = ZERO                                      01550007
015600             SET PS-NO-ERROR           TO TRUE                    01560007
015700             IF PV-TOT-VAL-COST-AMT >= PV-TOT-VAL-RTL-AMT         01570007
015800                 MOVE ZERO            TO PV-TOT-MU-PCT            01580007
015900             ELSE                                                 01590007
016000                 COMPUTE PV-TOT-MU-PCT =                          01600007
016100                   ( (PV-TOT-VAL-RTL-AMT - PV-TOT-VAL-COST-AMT)   01610007
016200                         / PV-TOT-VAL-RTL-AMT ) * 100             01620007
016300                 ON SIZE ERROR                                    01630008
016400                     MOVE ZERO            TO PV-TOT-MU-PCT        01640007
016500                  END-COMPUTE                                     01650007
016600             END-IF                                               01660007
016700                                                                  01670007
016800          WHEN SQLCODE = -304                                     01680007
016900          WHEN SQLCODE = +304                                     01690007
017000*            SET XL011-SQL-ERROR      TO TRUE                     01700007
017100*            SET PS-ERROR  TO TRUE                                01710007
017200*            MOVE '2100-SELECT-TPURITM ' TO                       01720007
017300*                  XL011-ERROR-PARAGRAPH                          01730007
017400*            MOVE 'TPURITM ' TO XL011-DB2-TABLE-NAME(1)           01740007
017500*            MOVE 'OVERFLOW ON TOTAL AMOUNT FOR PO'               01750007
017600*                      TO XL011-ERROR-TEXT                        01760007
017700*            MOVE 'XLKUP013' TO XL011-ERROR-PROGRAM               01770007
017800             INITIALIZE PV-TOT-UNT-QTY                            01780007
017900                        PV-TOT-VAL-COST-AMT                       01790007
018000                        PV-TOT-VAL-RTL-AMT                        01800007
018100                        PV-TOT-MU-PCT                             01810007
018200             SET PS-NO-ERROR           TO TRUE                    01820007
018300          WHEN SQLCODE = -305                                     01830007
018400          WHEN SQLCODE = +100                                     01840007
018500              INITIALIZE PV-TOT-UNT-QTY                           01850007
018600                         PV-TOT-VAL-COST-AMT                      01860007
018700                         PV-TOT-VAL-RTL-AMT                       01870007
018800                         PV-TOT-MU-PCT                            01880007
018900*         WHEN SQLCODE = -904                                     01890007
019000*         WHEN SQLCODE = -911                                     01900007
019100*         WHEN SQLCODE = -913                                     01910007
019200*             CONTINUE                                            01920007
019300          WHEN OTHER                                              01930007
019400              SET PS-ERROR             TO TRUE                    01940007
019500              SET XL011-SQL-ERROR      TO TRUE                    01950007
019600              MOVE '2100-SELECT-TPURITM ' TO                      01960007
019700                    XL011-ERROR-PARAGRAPH                         01970007
019800              MOVE 'TPURITM ' TO XL011-DB2-TABLE-NAME(1)          01980007
019900              MOVE 'NOT FOUND ON TPURITM '                        01990007
020000                        TO XL011-ERROR-TEXT                       02000007
020100              MOVE 'XLKUP013' TO XL011-ERROR-PROGRAM              02010007
020200      END-EVALUATE.                                               02020007
020300/                                                                 02030007
020400                                                                  02040007
020500                                                                  02050007
020600*COUNT NUMBER OF ROWS ON TPURITM FOR PO                           02060007
020700 2300-GET-TOT-SKUS.                                               02070007
020800     IF XL011-DEBUG-YES                                           02080007
020900         DISPLAY 'XLKUP013 - 2300-GET-TOT-SKUS'                   02090007
021000     END-IF                                                       02100007
021100                                                                  02110007
021200      EXEC SQL                                                    02120007
021300         SELECT  COUNT(*)                                         02130007
021400           INTO  :PV-TOT-SKUS-QTY                                 02140007
021500           FROM  TPURITM                                          02150007
021600          WHERE  PO_NBR              = :DK-PO-NBR                 02160007
021700            AND  VER_STATUS_CDE      = 'A'                        02170007
021800            AND  STATUS_CDE          <>'CA'                       02180007
021900      WITH UR                                                     02190007
022000      END-EXEC.                                                   02200007
022100                                                                  02210007
022200      MOVE SQLCODE                     TO XL011-SQLCODE           02220007
022300      EVALUATE TRUE                                               02230007
022400          WHEN SQLCODE = ZERO                                     02240007
022500              SET PS-NO-ERROR          TO TRUE                    02250007
022600          WHEN OTHER                                              02260007
022700              SET PS-ERROR             TO TRUE                    02270007
022800              SET XL011-SQL-ERROR      TO TRUE                    02280007
022900              MOVE '2300-GET-TOT-SKUS ' TO                        02290007
023000                    XL011-ERROR-PARAGRAPH                         02300007
023100              MOVE 'TPURITM ' TO XL011-DB2-TABLE-NAME(1)          02310007
023200              MOVE 'NOT FOUND ON TPURITM '                        02320007
023300                        TO XL011-ERROR-TEXT                       02330007
023400              MOVE 'XLKUP013' TO XL011-ERROR-PROGRAM              02340007
023500      END-EVALUATE.                                               02350007
023600/                                                                 02360007
023700                                                                  02370007
023800 7520-UPDATE-TPURCHS.                                             02380007
023900     IF XL011-DEBUG-YES                                           02390007
024000         DISPLAY 'XLKUP013 - 7520-UPDATE-TPURCHS'                 02400007
024100     END-IF                                                       02410007
024200                                                                  02420007
024300     EXEC SQL                                                     02430007
024400         UPDATE                                                   02440007
024500             TPURCHS                                              02450007
024600         SET                                                      02460007
024700             TOT_UNT_QTY              = :PV-TOT-UNT-QTY           02470007
024800           , TOT_VAL_COST_AMT         = :PV-TOT-VAL-COST-AMT      02480007
024900           , TOT_VAL_RTL_AMT          = :PV-TOT-VAL-RTL-AMT       02490007
025000           , TOT_MU_PCT               = :PV-TOT-MU-PCT            02500007
025100           , TOT_SKUS_QTY             = :PV-TOT-SKUS-QTY          02510007
025200         WHERE PO_NBR                 = :DK-PO-NBR                02520007
025300         AND VER_STATUS_CDE           = 'A'                       02530007
025400*LMM     AND STATUS_CDE               <>'CA'                      02540007
025500     END-EXEC.                                                    02550007
025600                                                                  02560007
025700     MOVE SQLCODE                     TO XL011-SQLCODE            02570007
025800     EVALUATE TRUE                                                02580007
025900         WHEN SQLCODE = ZERO                                      02590007
026000             SET XL011-SUCCESSFUL TO TRUE                         02600007
026100         WHEN OTHER                                               02610007
026200             SET XL011-SQL-ERROR      TO TRUE                     02620007
026300             MOVE '7520-UPDATE-TPURCHS ' TO                       02630007
026400                   XL011-ERROR-PARAGRAPH                          02640007
026500             MOVE 'TPURCHS ' TO XL011-DB2-TABLE-NAME(1)           02650007
026600             MOVE 'BAD UPDATE TO TPURCHS '                        02660007
026700                       TO XL011-ERROR-TEXT                        02670007
026800             MOVE 'XLKUP013' TO XL011-ERROR-PROGRAM               02680007
026900     END-EVALUATE.                                                02690007
027000/                                                                 02700007
027100 9999-WRAPUP.                                                     02710007
027200                                                                  02720007
027300     IF XL011-DEBUG-YES                                           02730007
027400         DISPLAY 'XLKUP013 - 9999-WRAPUP'                         02740007
027500     END-IF                                                       02750007
027600                                                                  02760007
027700     MOVE SQLCA                       TO XL011-SQLCA.             02770007
027800                                                                  02780007
