000300*---------------------------------------------------------------  00010000
000400 IDENTIFICATION DIVISION.                                         00020000
000500*---------------------------------------------------------------  00030000
000600 PROGRAM-ID.         SSKUT064.                                    00040066
000700 AUTHOR.             JOE GARDETTO.                                00050000
000800 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00060000
000900 DATE-WRITTEN        MAY 2013.                                    00070044
001000 DATE-COMPILED.                                                   00080000
001100                                                                  00090000
001200*---------------------------------------------------------------  00100000
001300* THIS PROGRAM CREATES A PIPE DELIMITED FILE THAT WILL BE FTP'D   00110052
001400* TO SPLUNK TO GENERATE REPORTING FOR AVERAGE TRANSACTION         00120068
001500* TIMES AT THE STORES.                                            00130044
001800*---------------------------------------------------------------  00150000
001900                                                                  00160000
002000*---------------------------------------------------------------  00170000
002100* HISTORY LOG:                                                    00180000
002200*                                                                 00190000
002300* DATE: 05/08/13                                                  00200044
002400* WR/IR#: 42007                                                   00210067
002500* PROGRAMMER: JOE GARDETTO                                        00220000
002600* DESCRIPTION: NEW PROGRAM                                        00230000
002200*                                                                 00240000
002700*---------------------------------------------------------------  00250000
003000 ENVIRONMENT DIVISION.                                            00260000
003200 CONFIGURATION SECTION.                                           00270000
003300 SOURCE-COMPUTER.    IBM-3090.                                    00280000
003400 OBJECT-COMPUTER.    IBM-3090.                                    00290000
003500                                                                  00300000
003600 INPUT-OUTPUT SECTION.                                            00310000
003800 FILE-CONTROL.                                                    00320000
003900                                                                  00330000
004000     SELECT DATE-FILE                                             00340001
004100         ASSIGN TO INP01.                                         00350000
004200                                                                  00360000
004300     SELECT AVERAGE-TRANS-FILE                                    00371046
004400         ASSIGN TO OUT01.                                         00380000
004500                                                                  00390000
004600*---------------------------------------------------------------  00400000
004700 DATA DIVISION.                                                   00410000
004900 FILE SECTION.                                                    00420000
005000                                                                  00430000
005100 FD  DATE-FILE                                                    00440001
005200     RECORDING MODE IS F                                          00450000
005300     RECORD CONTAINS 80 CHARACTERS                                00460000
005400     LABEL RECORDS ARE STANDARD                                   00470000
005500     BLOCK CONTAINS 0 RECORDS.                                    00480000
005600                                                                  00490000
005700 01  INPUT-DATE-CONTROL-RECORD   PIC X(80).                       00500005
005800                                                                  00510000
005900 FD  AVERAGE-TRANS-FILE                                           00520046
006000     RECORDING MODE IS F                                          00530000
006100     RECORD CONTAINS 80 CHARACTERS                                00540000
006200     LABEL RECORDS ARE STANDARD                                   00550000
006300     BLOCK CONTAINS 0  RECORDS.                                   00560000
006400                                                                  00570000
006500 01  AVERAGE-TRANS-RECORD        PIC X(80).                       00580046
006600                                                                  00599832
006700*---------------------------------------------------------------  00600000
006800 WORKING-STORAGE SECTION.                                         00610000
006900*---------------------------------------------------------------  00620000
007000 01  AC-ABEND-CODE               PIC   S9(04) VALUE +0            00630000
007100                                              COMP SYNC.          00640000
007600     88  AC-CALENDAR-ROUTINE-ERROR            VALUE +4019.        00690075
007700     88  AC-INVALID-CONTROL-CARD              VALUE +4003.        00701075
007800     88  AC-DB2-ERROR                         VALUE +4013.        00710000
007900                                                                  00870000
008000*------------------------------------------------                 00880000
008100* AVERAGE TRANSACTION TIMES RECORD LAYOUT - OUTPUT                00890044
008200*------------------------------------------------                 00900000
010100                                                                  00910000
       01  ATR-DETAIL-RECORD.                                           00921044
008800     05  ATR-SALES-DATE          PIC  X(10)   VALUE SPACES.       00931046
008900     05  FILLER                  PIC  X(1)    VALUE '|'.          00940052
008800     05  ATR-SPLUNK-TIMESTAMP    PIC  X(5)    VALUE SPACES.       00941054
008900     05  FILLER                  PIC  X(1)    VALUE '|'.          00941152
008800     05  ATR-STORE-NBR           PIC  X(4)    VALUE SPACES.       00941252
008900     05  FILLER                  PIC  X(1)    VALUE '|'.          00942052
008800     05  ATR-LOC-NM              PIC  X(20)   VALUE SPACES.       00943046
009100     05  FILLER                  PIC  X(1)    VALUE '|'.          00970052
008800     05  ATR-ST-CDE              PIC  X(2)    VALUE SPACES.       00971046
009100     05  FILLER                  PIC  X(1)    VALUE '|'.          00972052
008800     05  ATR-AVG-TRAN-TM-MM      PIC  X(2)    VALUE SPACES.       01000060
009100     05  FILLER                  PIC  X(1)    VALUE ':'.          01000160
008800     05  ATR-AVG-TRAN-TM-SS      PIC  X(2)    VALUE SPACES.       01000260
009100     05  FILLER                  PIC  X(1)    VALUE '|'.          01000360
                                                                        01001046
010200*---------------------------------------------------------------  01020000
010300* LAYOUT FOR THE INPUT DATE CONTROL CARD                          01030003
010500*---------------------------------------------------------------  01050000
010600 01  INPUT-DATE-CONTROL-AREA.                                     01061003
010700     05  INPUT-CONTROL-DATE      PIC  X(10)   VALUE SPACES.       01070003
011200     05  FILLER                  PIC  X(70)   VALUE SPACES.       01110003
011300                                                                  01120000
011400*------------------------------------------------                 01130000
011500* PC- PROGRAM CONSTANTS                                           01140000
011600*------------------------------------------------                 01150000
011700 01  PC-PROGRAM-CONSTANTS.                                        01160000
011800     05  PC-PROGRAM-NAME         PIC  X(8)    VALUE 'SSKUT064'.   01170067
011900     05  PC-ROW-NOT-FOUND        PIC S9(04)   VALUE +100          01180000
012000                                              COMP SYNC.          01190000
012200*------------------------------------------------                 01212015
012300* PS- PROGRAM SWITCHES                                            01220000
012400*------------------------------------------------                 01230000
012500 01  PS-PROGRAM-SWITCHES.                                         01240000
012600     05  PS-END-OF-ATR-CURSOR-SW     PIC X  VALUE 'N'.            01250046
012700         88 PS-END-OF-ATR-CURSOR            VALUE 'Y'.            01260046
012800     05  PS-END-OF-DATE-FILE-SW      PIC X  VALUE 'N'.            01270002
012900         88 PS-END-OF-DATE-FILE             VALUE 'Y'.            01280002
012800     05  PS-VALID-INPUT-DATE-SW      PIC X  VALUE 'N'.            01281004
012900         88 PS-VALID-INPUT-DATE             VALUE 'Y'.            01282004
013000                                                                  01290000
013100*------------------------------------------------                 01300000
013200* PV- PROGRAM VARIABLES                                           01310000
013300*------------------------------------------------                 01320000
013400 01  PV-PROGRAM-VARIABLES.                                        01330000
013500     05  PV-RECORDS-WRITTEN          PIC S9(7)    VALUE +0 COMP-3.01340000
013600     05  PV-ATR-CURSOR-COUNT         PIC S9(7)    VALUE +0 COMP-3.01350049
013800     05  PV-SALES-DATE               PIC X(10).                   01370074
013900     05  PV-PARAGRAPH-NAME           PIC X(30)    VALUE SPACES.   01380000
014000     05  PV-OPERATION-MSG-1          PIC X(40)    VALUE SPACES.   01390000
014100     05  PV-OPERATION-MSG-2          PIC X(40)    VALUE SPACES.   01400000
014200     05  PV-DB2-OPERATION            PIC X(30)    VALUE SPACES.   01410000
015200     05  PV-EDIT-MASK                PIC Z,ZZZ,ZZ9.               01460000
013900     05  PV-AVG-TRAN-TM-TOT-SECONDS  PIC S9(4) COMP.              01494158
013900     05  PV-AVG-TRAN-TM-MINUTES      PIC 9(2).                    01502164
013900     05  PV-AVG-TRAN-TM-SECONDS      PIC 9(2).                    01503061
019100                                                                  01504057
019200*-----------------------------------------------------            01510000
019300* PARAMETER LIST FOR THE CALENDAR ROUTINE (DPKUT500)              01520000
019400*-----------------------------------------------------            01530000
019500     COPY DPWS500.                                                01540000
019600                                                                  01550000
019700*-----------------------------------------------------            01560000
019800* WS FIELDS FOR SQLCA MESSAGE ROUTINE (DPPD004)                   01570000
019900*-----------------------------------------------------            01580000
020000     COPY DPWS004.                                                01590000
020100                                                                  01600000
020200*-----------------------------------------------------            01610000
020300* DB2 COMMUNICATION AREA                                          01620000
020400*-----------------------------------------------------            01630000
020500     EXEC SQL                                                     01640000
020600          INCLUDE SQLCA                                           01650000
020700     END-EXEC.                                                    01660000
020800                                                                  01670000
020900*-----------------------------------------------------            01680000
021000* DB2 TABLE DB2PDBA.TEPPART - PARTITION TABLE                     01690000
021100*-----------------------------------------------------            01700000
021200     EXEC SQL                                                     01710000
021300          INCLUDE TEPPART                                         01720000
021400     END-EXEC.                                                    01730000
022200                                                                  01740000
021600*-----------------------------------------------------            01750000
021700* DB2 TABLE DB2PDBA.TEPTRN - TRANSACTION TABLE                    01760000
021800*-----------------------------------------------------            01770000
021900     EXEC SQL                                                     01780000
022000          INCLUDE TEPTRN                                          01790000
022100     END-EXEC.                                                    01800000
                                                                        01801045
27383 *---------------------------------------------------------*       01810045
27383 * DCLGEN FOR XST_LOC LOCATION TABLE                               01820045
27383 *---------------------------------------------------------*       01830045
27383      EXEC SQL                                                     01840045
27383        INCLUDE XST00001                                           01850045
27383      END-EXEC.                                                    01860045
023600                                                                  02027008
023700*---------------------------------------------------------------  02030000
023800* ATR-CURSOR --> GET THE AVERAGE TRANSACTION TIME PER STORE       02040046
024000*---------------------------------------------------------------  02050000
024100     EXEC SQL                                                     02060000
             DECLARE ATR-CURSOR CURSOR FOR                              02477144
               SELECT                                                   02478344
                 PRT.SLS_DTE                                            02478444
                ,TRN.STR_NBR                                            02478544
                ,LOC.LOC_NM                                             02478644
                ,LOC.ST_CDE                                             02478744
                ,AVG (                                                  02478844
                 (MINUTE(TRN.END_TM -                                   02478944
                  TRN.FRST_ITM_SCND_STRT_TM) * 60) +                    02479044
                 (SECOND(TRN.END_TM -                                   02479144
                  TRN.FRST_ITM_SCND_STRT_TM)))                          02479244
                                                                        02479364
                ,'00'                                                   02480564
                 CONCAT                                                 02480664
                 ':'                                                    02480764
                 CONCAT                                                 02480864
                 LPAD(RTRIM(CHAR((AVG ((MINUTE(TRN.END_TM -             02480964
                 TRN.FRST_ITM_SCND_STRT_TM) * 60) +                     02481064
                            (SECOND(TRN.END_TM -                        02481164
                            TRN.FRST_ITM_SCND_STRT_TM)))/60))),2,'0')   02481364
                 CONCAT                                                 02481464
                 ':'                                                    02481564
                 CONCAT                                                 02481664
                 LPAD(RTRIM(CHAR(MOD(AVG ((MINUTE(TRN.END_TM -          02481764
                 TRN.FRST_ITM_SCND_STRT_TM) * 60) +                     02481864
                            (SECOND(TRN.END_TM -                        02481964
                            TRN.FRST_ITM_SCND_STRT_TM))),60))),2,'0')   02482064
               FROM                                                     02485064
                 TEPTRN TRN                                             02485164
                ,TEPPART PRT                                            02485264
                ,XST_LOC LOC                                            02485364
               WHERE PRT.SLS_DTE        = :PV-SALES-DATE                02485474
                 AND PRT.DB_STRUC_CDE   = 'O'                           02485564
                 AND PRT.STR_GP_CDE     = 'A'                           02485664
                 AND TRN.PARTN_NBR      = PRT.PARTN_NBR                 02485764
                 AND LOC.LOC_NBR        = TRN.STR_NBR                   02485864
                 AND TRN.VOID_ABRT_CDE  = 'N'                           02485964
                 AND TRN.TRN_STAT_CDE   IN ('V', 'Z', 'L')              02486064
                 AND TRN.TRN_TYP_CDE    IN ('01','02')                  02486164
                 AND TRN.FIN_SEQ_STRT_TM <= TRN.END_TM                  02486276
                 AND LOC.E_BUS_IND <> 'Y'                               02486364
              GROUP BY PRT.SLS_DTE,TRN.STR_NBR,LOC.LOC_NM,LOC.ST_CDE    02486464
              ORDER BY PRT.SLS_DTE,TRN.STR_NBR,LOC.LOC_NM,LOC.ST_CDE    02486564
               WITH UR                                                  02486664
028400     END-EXEC.                                                    02486764
023600                                                                  02487064
028500                                                                  02493008
028600*---------------------------------------------------------------  02500000
028700 PROCEDURE DIVISION.                                              02510000
028800*---------------------------------------------------------------  02520000
028900     PERFORM 1000-INITIALIZATION.                                 02530000
029000                                                                  02540000
           PERFORM 2000-PROCESS-AVERAGE-TRAN-FILE                       02571146
             UNTIL PS-END-OF-ATR-CURSOR                                 02572046
           PERFORM 8000-END-OF-JOB                                      02580042
030400                                                                  02670000
030500     STOP RUN.                                                    02680000
030600                                                                  02690000
030700*---------------------------------------------------------------  02700000
030800* INITIALIZATION ROUTINE, OPEN THE EXTRACT, ACCEPT THE CARD       02710000
030900* FROM SYSIN, PERFORM THE ROUTINE TO FIND THE FISCAL PERIOD AND   02720000
031000* PERFORM THE ROUTINE TO OPEN THE CURSOR                          02730000
031100*---------------------------------------------------------------  02740000
031200 1000-INITIALIZATION.                                             02750000
031300                                                                  02760000
031400     OPEN INPUT  DATE-FILE.                                       02770001
031500     OPEN OUTPUT AVERAGE-TRANS-FILE.                              02780046
031600                                                                  02790000
031700     READ DATE-FILE                                               02800001
031800         INTO INPUT-DATE-CONTROL-AREA                             02810003
031900         AT END SET PS-END-OF-DATE-FILE                           02820002
032000                                    TO TRUE.                      02830000
032100     IF PS-END-OF-DATE-FILE                                       02840002
032200         MOVE '1000-INITIALIZATION'                               02850000
032300                                    TO PV-PARAGRAPH-NAME          02860000
032400         MOVE 'INPUT DATE CONTROL CARD IS EMPTY'                  02870003
032500                                    TO PV-OPERATION-MSG-1         02880000
032600         SET AC-INVALID-CONTROL-CARD                              02890075
032600                                    TO TRUE                       02891075
032700         PERFORM 9999-ABEND                                       02900000
           ELSE                                                         02901003
033100         PERFORM 1100-DATE-ROUTINE                                02904003
033200         PERFORM 1200-OPEN-ATR-CURSOR                             02905046
033300         PERFORM 2100-FETCH-ATR-CURSOR                            02906046
032800     END-IF.                                                      02910000
032900                                                                  02920003
033600*---------------------------------------------------------------  03010000
033700* INITIALIZE THE CALL PARAMETERS, SET THE DATE INDICATORS,        03020000
033800* MOVE THE YEAR AND PERIOD TO THE INPUT AREA, AND CALL THE        03030000
033900* ROUTINE AND CHECK FOR ERRORS.                                   03040000
034000*---------------------------------------------------------------  03050000
034100 1100-DATE-ROUTINE.                                               03060000
034200                                                                  03070000
034300     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              03080000
034400                                                                  03090004
034500     SET  DPG51-ACTUAL-CALENDAR-ONLY  TO TRUE.                    03141004
034700     SET  DPG52-LK-DTE-ISO-FMT        TO TRUE.                    03143004
034800     MOVE INPUT-CONTROL-DATE          TO DPG52-LK-DATE-INPUT.     03144004
026600     SET DPG52-LK-DTE-ISO-FMT      TO TRUE                        03144171
034900                                                                  03153071
035000     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    03154071
035100                                             DPG54 DPG55 DPG56.   03160000
035200     EVALUATE TRUE                                                03170000
035300         WHEN DPG54-SEVERE-ERROR                                  03180000
035400         WHEN DPG54-DATE-INVALID                                  03190000
027400             DISPLAY ' '                                          03191072
027500             DISPLAY '** ABEND     **'                            03192072
027600             DISPLAY '** PROGRAM   **  = ' PC-PROGRAM-NAME        03193072
027700             DISPLAY '** PARAGRAPH **  = 1100-DATE-ROUTINE'       03194072
027800             DISPLAY '** BAD CALL TO CALENDAR MODULE '            03195072
027900             DISPLAY '** DETERMINE VALID DATES **'                03196072
028000             DISPLAY DPG54-ERROR-MESSAGE                          03197072
035500             MOVE '1100-DATE-ROUTINE'                             03200000
035600                                       TO PV-PARAGRAPH-NAME       03210000
035700             MOVE 'ERROR VALIDATING INPUT CARD DATE'              03220072
035800                                       TO PV-OPERATION-MSG-1      03230000
035900             SET AC-CALENDAR-ROUTINE-ERROR                        03240000
036000                                       TO TRUE                    03250000
036100             MOVE DPG54-ERROR-MESSAGE  TO PV-OPERATION-MSG-2      03260000
036200             MOVE DPG54-ERROR-MESSAGE  TO PV-OPERATION-MSG-2      03270000
036300             PERFORM 9999-ABEND                                   03280000
036400     END-EVALUATE.                                                03290000
036500                                                                  03291204
012900     SET PS-VALID-INPUT-DATE          TO TRUE.                    03292014
072700     MOVE INPUT-CONTROL-DATE          TO PV-SALES-DATE.           03352274
                                                                        03352325
037000     DISPLAY 'PV-SALES-DATE -- ' PV-SALES-DATE.                   03354074
037100                                                                  03360000
037200*---------------------------------------------------------------  03370000
037300* OPEN MTR CURSOR AND CHECK FOR ERRORS                            03380008
037400*---------------------------------------------------------------  03390000
037500 1200-OPEN-ATR-CURSOR.                                            03400046
037600                                                                  03410000
037700     EXEC SQL                                                     03420000
037800          OPEN ATR-CURSOR                                         03430046
037900     END-EXEC.                                                    03440000
038000                                                                  03450000
038100     EVALUATE TRUE                                                03460000
038200         WHEN SQLCODE = ZERO                                      03470000
038300              CONTINUE                                            03480000
038400         WHEN SQLWARN0 NOT EQUAL SPACE                            03490000
038500         WHEN SQLCODE NOT EQUAL ZERO                              03500000
038600              MOVE '1200-OPEN-ATR-CURSOR'                         03510046
038700                                 TO PV-PARAGRAPH-NAME             03520000
038800              MOVE 'ERROR ON OPEN OF MTR-CURSOR'                  03530002
038900                                 TO PV-DB2-OPERATION              03540000
039000              SET AC-DB2-ERROR   TO TRUE                          03550075
039100              PERFORM 9800-SQL-ABEND                              03560000
039200     END-EVALUATE.                                                03570000
037100                                                                  03571008
039300                                                                  03581008
039400*---------------------------------------------------------------  03590000
039600* WRITE ROW TO AVERAGE-TRANS-FILE; PERFORM FETCH TO GET           03600046
039700* ANOTHER ROW FROM THE CURSOR;                                    03610000
040000*---------------------------------------------------------------  03620000
040100 2000-PROCESS-AVERAGE-TRAN-FILE.                                  03630046
040200                                                                  03640000
041600     MOVE EPTRN-SLS-DTE          TO ATR-SALES-DATE.               03671046
041600     MOVE '23:00'                TO ATR-SPLUNK-TIMESTAMP.         03671153
083420     MOVE EPTRN-STR-NBR          TO ATR-STORE-NBR.                03671252
041400     MOVE XST00001-LOC-NM        TO ATR-LOC-NM.                   03671346
083420     MOVE XST00001-ST-CDE        TO ATR-ST-CDE.                   03673146
           DIVIDE PV-AVG-TRAN-TM-TOT-SECONDS BY 60                      03723057
               GIVING PV-AVG-TRAN-TM-MINUTES                            03724057
            REMAINDER PV-AVG-TRAN-TM-SECONDS.                           03725057
           MOVE PV-AVG-TRAN-TM-MINUTES TO ATR-AVG-TRAN-TM-MM.           03725160
           MOVE PV-AVG-TRAN-TM-SECONDS TO ATR-AVG-TRAN-TM-SS.           03725260
                                                                        03729964
044900     PERFORM 9000-WRITE-EXTRACT-RECORDS.                          03730000
                                                                        03750000
081800     PERFORM 2100-FETCH-ATR-CURSOR.                               03760046
                                                                        03777424
082100*---------------------------------------------------------------  03790000
082200* FETCH THE MTR CURSOR AND CHECK FOR ERRORS                       03800008
082300*---------------------------------------------------------------  03810000
082400 2100-FETCH-ATR-CURSOR.                                           03820046
082500                                                                  03830000
082600     EXEC SQL                                                     03840000
082700          FETCH ATR-CURSOR                                        03850046
                 INTO :EPTRN-SLS-DTE                                    03860044
                     ,:EPTRN-STR-NBR                                    03861044
                     ,:XST00001-LOC-NM                                  03863046
                     ,:XST00001-ST-CDE                                  03870046
                     ,:PV-AVG-TRAN-TM-TOT-SECONDS                       03880057
083300     END-EXEC.                                                    03900000
                                                                        03910000
083500     EVALUATE TRUE                                                03930000
083600         WHEN SQLCODE = ZERO                                      03940000
083700             ADD 1                  TO PV-ATR-CURSOR-COUNT        04000049
083800         WHEN SQLCODE = PC-ROW-NOT-FOUND                          04010000
083900             SET PS-END-OF-ATR-CURSOR                             04020046
084000                                     TO TRUE                      04030000
084100         WHEN SQLWARN0 NOT EQUAL SPACE                            04040000
084200         WHEN SQLCODE NOT EQUAL ZERO                              04050000
084300             MOVE '2100-FETCH-ATR-CURSOR'                         04060046
084400                                     TO PV-PARAGRAPH-NAME         04070000
084500             MOVE SQLCODE            TO PV-DB2-OPERATION          04080000
084900             SET AC-DB2-ERROR        TO TRUE                      04090075
085000             PERFORM 9800-SQL-ABEND                               04100000
085100     END-EVALUATE.                                                04110000
                                                                        04111008
099000*---------------------------------------------------------------  04130000
099100* CLOSES FISCAL MONTH INPUT FILE, ECOMM RETURN EXTRACT FILE, AND  04140000
099200* ECOMM CURSOR                                                    04150000
099300*---------------------------------------------------------------  04160000
099400 8000-END-OF-JOB.                                                 04170000
100000     CLOSE DATE-FILE.                                             04180001
100100     CLOSE AVERAGE-TRANS-FILE.                                    04190046
100200                                                                  04200000
100300     PERFORM 8100-CLOSE-ATR-CURSOR.                               04210049
100400                                                                  04220000
100500     DISPLAY '****************************************'           04230000
100600     DISPLAY '*************** SSKUT064 ***************'           04240067
100700     DISPLAY '****************************************'           04250000
100800     MOVE PV-ATR-CURSOR-COUNT TO PV-EDIT-MASK                     04260049
100900     INSPECT PV-EDIT-MASK REPLACING LEADING SPACE BY '.'          04270000
101000     DISPLAY 'RETURN COUNT ROWS FETCHED......'                    04280000
101100         PV-EDIT-MASK                                             04290000
101200     MOVE PV-RECORDS-WRITTEN     TO PV-EDIT-MASK                  04300000
101300     INSPECT PV-EDIT-MASK REPLACING LEADING SPACE BY '.'          04310000
101400     DISPLAY 'EXTRACT RECORDS WRITTEN........'                    04320000
101500         PV-EDIT-MASK                                             04330000
101600     DISPLAY '****************************************'           04340000
101700     DISPLAY '****************************************'           04350000
101800     DISPLAY '****************************************'.          04360000
101900                                                                  04370000
102000     MOVE ZERO                   TO RETURN-CODE.                  04380000
102100                                                                  04390000
102200*---------------------------------------------------------------  04400000
102300* CLOSE THE ATR CURSOR AND CHECK FOR ERRORS                       04410072
102400*---------------------------------------------------------------  04420000
102500 8100-CLOSE-ATR-CURSOR.                                           04430049
102600                                                                  04440000
102700     EXEC SQL                                                     04450000
102800          CLOSE ATR-CURSOR                                        04460049
102900     END-EXEC.                                                    04470000
103000                                                                  04480000
103100     EVALUATE TRUE                                                04490000
103200         WHEN SQLCODE = ZERO                                      04500000
103300              CONTINUE                                            04510000
103400         WHEN SQLWARN0 NOT EQUAL SPACE                            04520000
103500         WHEN SQLCODE NOT EQUAL ZERO                              04530000
103600             MOVE '8100-CLOSE-ATR-CURSOR'                         04540049
103700                                 TO PV-PARAGRAPH-NAME             04550000
103800             MOVE 'ERROR ON CLOSE OF ATR-CURSOR'                  04560049
103900                                 TO PV-DB2-OPERATION              04570000
104000             SET AC-DB2-ERROR    TO TRUE                          04580075
104100             PERFORM 9800-SQL-ABEND                               04590000
104200     END-EVALUATE.                                                04600000
104300                                                                  04610000
104400*---------------------------------------------------------------  04620000
104500* THIS MODULE WRITES THE OUTPUT FILE RECORD                       04630000
104600*---------------------------------------------------------------  04640000
104700 9000-WRITE-EXTRACT-RECORDS.                                      04650000
104800                                                                  04660000
104900     WRITE AVERAGE-TRANS-RECORD                                   04670046
105000         FROM ATR-DETAIL-RECORD.                                  04680046
105100                                                                  04690000
105200     ADD 1 TO PV-RECORDS-WRITTEN.                                 04700000
105300                                                                  04710000
105400*---------------------------------------------------------------  04722000
105500* 9800-SQL-ABEND                                                  04730000
105600* ABEND PROGRAM WHEN A WARNING OR SQL ERROR CODE OCCURS           04740000
105700*---------------------------------------------------------------  04750000
105800 9800-SQL-ABEND.                                                  04760000
105900     DISPLAY '** ABEND     **'.                                   04770000
106000     DISPLAY '** PROGRAM   ** = ' PC-PROGRAM-NAME.                04780000
106100     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              04790000
106200     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               04800000
106600                                                                  04810000
106700     COPY DPPD004.                                                04820000
106800     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         04830000
106900                                                                  04840000
107000*---------------------------------------------------------------  04850000
107100* 9999-ABEND                                                      04860000
107200* ABEND PROGRAM WHEN AN ERROR OCCURS                              04870000
107300*---------------------------------------------------------------  04880000
107400 9999-ABEND.                                                      04890000
107500     DISPLAY '** ABEND     **'.                                   04900000
107600     DISPLAY '** PROGRAM   ** = ' PC-PROGRAM-NAME.                04910000
107700     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              04920000
107800     DISPLAY '** OPERATION ** = ' PV-OPERATION-MSG-1.             04930000
107900     DISPLAY '**           ** = ' PV-OPERATION-MSG-2.             04940000
108000                                                                  04950000
108100     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         04960000
