000100 IDENTIFICATION DIVISION.                                         00010022
000200                                                                  00020022
000300 PROGRAM-ID.             SUKUT183.                                00030022
000400 AUTHOR.                 CHERI PARMLEY.                           00040022
000500 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00050022
000600 DATE-WRITTEN            FEBRUARY 2017.                           00060022
000700 DATE-COMPILED.                                                   00070022
000800***************************************************************** 00080022
000900*                                                                 00090022
001000******************************************************************00100022
001100*  MODULE TYPE: COBOL2 DB2 BATCH                                  00110022
001200*                                                                 00120022
001300*  DESCRIPTION:                                                   00130022
000900******************************************************************00131022
001000*   THIS PROGRAM READS THE PKMT.SU.TSUOBTS.SUDB033.INPUT FILE     00132022
001100*   FOR EACH OUTBOUND TRIP ID AND CHECKS TO SEE IF ANY MASTER     00133022
001200*   CARTONS WERE DIVERTED OR SCANNED FOR THE TRIP ID.             00134022
001200*   FOR EACH MASTER DIVERTED/SCANNED, THEN GENERATE A LIST OF THE 00135022
001200*   CHILD CARTONS ATTACHED TO THE MASTER AND CREATE AN OUPUT      00136022
001200*   FILE (SURD142). THIS NEW OUTPUT FILE WOULD HAVE TRIP ID,      00137022
001200*   PARENT SML AND SML.                                           00138022
001300******************************************************************00139022
001400*                                                                 00140022
001600*                                                                 00150022
001700*========================== CHANGE LOG ===========================00160022
001800*  BY        DATE     #                DESCRIPTION                00170022
001900*=================================================================00180022
002000*  C.PARMLEY 02-20-17                  INITIAL                    00190022
002600******************************************************************00200022
002700 ENVIRONMENT DIVISION.                                            00210022
002800 CONFIGURATION SECTION.                                           00220022
002900 SOURCE-COMPUTER.        IBM-3090.                                00230022
003000 OBJECT-COMPUTER.        IBM-3090.                                00240022
003100 INPUT-OUTPUT SECTION.                                            00250022
003200 FILE-CONTROL.                                                    00260022
003300                                                                  00270022
003400     SELECT INPUT-FILE                                            00280022
003500         ASSIGN TO INP01.                                         00290022
003600                                                                  00300022
003700     SELECT OUTPUT-FILE                                           00310022
003800         ASSIGN TO OUT01.                                         00320022
003900                                                                  00330022
004000 DATA DIVISION.                                                   00340022
004100 FILE SECTION.                                                    00350022
004200                                                                  00360022
004300 FD  INPUT-FILE                                                   00370022
004400     RECORDING MODE IS F                                          00380022
004500     LABEL RECORDS ARE STANDARD                                   00390022
004600     BLOCK CONTAINS 0  RECORDS.                                   00400022
004700 01  INPUT-UPDATE-REC                 PIC X(013).                 00410022
004800                                                                  00420022
004900 FD  OUTPUT-FILE                                                  00430022
005000     RECORDING MODE IS F                                          00440022
005100     LABEL RECORDS ARE STANDARD                                   00450022
005200     BLOCK CONTAINS 0  RECORDS.                                   00460022
005300 01  OUTPUT-REC                       PIC X(030).                 00470022
005400                                                                  00480022
005500 WORKING-STORAGE SECTION.                                         00490022
005600 01  PS-SWITCHES.                                                 00500022
005700     05  PS-EOF-EXTRACT-SW            PIC X(01) VALUE 'N'.        00510022
005800         88  PS-EOF-EXTRACT-YES                 VALUE 'Y'.        00520022
005900     05  PS-END-OF-CSR-SW             PIC  X(01) VALUE 'N'.       00530022
006000         88 PS-END-OF-CSR-N                      VALUE 'N'.       00540022
006100         88 PS-END-OF-CSR-Y                      VALUE 'Y'.       00550022
005900     05  PS-END-OF-CSR2-SW             PIC  X(01) VALUE 'N'.      00560022
006000         88 PS-END-OF-CSR2-N                      VALUE 'N'.      00570022
006100         88 PS-END-OF-CSR2-Y                      VALUE 'Y'.      00580022
005900     05  PS-END-OF-CSR3-SW             PIC  X(01) VALUE 'N'.      00590022
006000         88 PS-END-OF-CSR3-N                      VALUE 'N'.      00600022
006100         88 PS-END-OF-CSR3-Y                      VALUE 'Y'.      00610022
006500                                                                  00620022
006900                                                                  00630022
007000 01  PROGRAM-VARIABLES.                                           00640022
007100     05  PV-DISP-NBR                  PIC Z,ZZZ,ZZ9.              00650022
007300     05  PV-DISP-TRIP                 PIC ZZZZZZZZ9.              00660022
007800     05  PV-DISP-FETCH-COUNT          PIC ZZZ,ZZZ,ZZ9.            00670022
008400     05  PV-ABEND-CODE                PIC S9(04) VALUE ZERO       00680022
008500                                                 COMP SYNC.       00690022
008600         88  ABEND-4013-DB2-ERROR                VALUE +4013.     00700022
000804     05  PV-MSTR-HOLD               PIC  S9(18)V VALUE 0 COMP-3.  00710022
008700     05  PV-INPUT-COUNT               PIC S9(09) COMP-3           00720022
008800                                          VALUE ZERO.             00730022
008900     05  PV-CSR-COUNT                 PIC S9(09) COMP-3           00740022
009000                                          VALUE ZERO.             00750022
008900     05  PV-CSR2-COUNT                PIC S9(09) COMP-3           00760022
009000                                          VALUE ZERO.             00770022
008900     05  PV-CSR3-COUNT                PIC S9(09) COMP-3           00780022
009000                                          VALUE ZERO.             00790022
010000     05  PC-MAX-RETRIES               PIC S9(03) COMP-3           00800022
010100                                        VALUE 3.                  00810022
010200     05  PV-ABEND-PARAGRAPH           PIC X(35) VALUE SPACES.     00820022
010300     05  PV-CURRENT-TMST              PIC X(26) VALUE SPACES.     00830022
                                                                        00840022
035200 01  PV-DB2-NULL-INDICATORS.                                      00850022
035300     05  PV-CHLD-SHIPT-UNT-ID        PIC S9(04) COMP VALUE +0.    00860022
035300     05  PV-CHLD-MSTR-SHIPT-ID       PIC S9(04) COMP VALUE +0.    00870022
011000                                                                  00880022
011100 01  PV-DISP-KEY-MSG.                                             00890022
011200     05  FILLER                      PIC X(11) VALUE              00900022
011300         ' TRIP-ID = '.                                           00910022
011400     05  PV-KEY-OTBND-TRIP-ID        PIC 9(09) VALUE ZEROES.      00920022
011200     05  FILLER                      PIC X(11) VALUE              00930022
011300         ' MSTR-ID = '.                                           00940022
011400     05  PV-KEY-MSTR-UNT-ID          PIC 9(18) VALUE ZEROES.      00950022
                                                                        00960022
012700                                                                  00970022
005000******************************************************************00980022
005100*  CARTON INPUT FILE LAYOUT                                       00990022
005200******************************************************************01000022
005300     COPY SURD012.                                                01010022
005400*                                                                 01020022
005000******************************************************************01030022
005100*  CARTON OUTPUT FILE LAYOUT                                      01040022
005200******************************************************************01050022
005300     COPY SURD142.                                                01060022
005400*                                                                 01070022
013000     COPY SURD105.                                                01080022
013100***DB2 ABEND COPYBOOK                                             01090022
013200     COPY DPWS900.                                                01100022
013300                                                                  01110022
006000******************************************************************01120022
006100*  DCLGEN FOR SUT_OTBND_LOC TABLE                                 01130022
006200******************************************************************01140022
006300     EXEC SQL                                                     01150022
006400          INCLUDE SUT00027                                        01160022
006500     END-EXEC.                                                    01170022
006600                                                                  01180022
006610******************************************************************01190022
006620*  DCLGEN FOR SUT_OTBND_CART TABLE                                01200022
006630******************************************************************01210022
006640     EXEC SQL                                                     01220022
006650          INCLUDE SUT00024                                        01230022
006660     END-EXEC.                                                    01240022
006670                                                                  01250022
006610******************************************************************01260022
006620*  DCLGEN FOR TSUCRDBV TABLE (CARTON DIVERT)                      01270023
006630******************************************************************01280022
006640     EXEC SQL                                                     01290022
006650          INCLUDE TSUCRDV                                         01300022
006660     END-EXEC.                                                    01310022
006670                                                                  01320022
006610******************************************************************01330022
006620*  DCLGEN FOR TSUOBTR  TABLE                                      01340022
006630******************************************************************01340122
006640     EXEC SQL                                                     01340222
006650          INCLUDE TSUOBTR                                         01340322
006660     END-EXEC.                                                    01340422
006670                                                                  01340522
006610******************************************************************01340622
006620*  DCLGEN FOR TSUCDOT  TABLE                                      01340722
006630******************************************************************01340822
006640     EXEC SQL                                                     01340922
006650          INCLUDE TSUCDOT                                         01341022
006660     END-EXEC.                                                    01341122
006670                                                                  01341222
006610******************************************************************01341322
006620*  DCLGEN FOR SUT_MSTR_SHIPT_CNT                                  01341422
006630******************************************************************01341522
006640     EXEC SQL                                                     01341622
006650          INCLUDE SUT00099                                        01341722
006660     END-EXEC.                                                    01341822
006670                                                                  01341922
006700******************************************************************01342022
018600     EXEC SQL                                                     01343022
018700         INCLUDE SQLCA                                            01344022
018800     END-EXEC.                                                    01345022
018900                                                                  01346022
019000     COPY SQLCA2.                                                 01347022
019100     COPY DPWS004.                                                01348022
019200 EJECT                                                            01349022
019300/                                                                 01350022
019400 PROCEDURE DIVISION.                                              01360022
019500     PERFORM 1000-INITIALIZE.                                     01370022
019600     PERFORM 2000-PROCESS                                         01380022
019700             UNTIL PS-EOF-EXTRACT-YES                             01390022
019800     PERFORM 9000-EOJ.                                            01400022
019900                                                                  01410022
020000     GOBACK.                                                      01420022
020100                                                                  01430022
020200 1000-INITIALIZE.                                                 01440022
020300                                                                  01450022
           DISPLAY ' ++++ START SUKUT183 ++++ '.                        01460022
020400     OPEN INPUT INPUT-FILE.                                       01470022
020500     OPEN OUTPUT OUTPUT-FILE.                                     01480022
020600                                                                  01490022
020700     EXEC SQL                                                     01500022
020800         SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                 01510022
020900     END-EXEC.                                                    01520022
021000                                                                  01530022
           DISPLAY ' ++++ RUN TIME ++++ ' PV-CURRENT-TMST.              01540022
                                                                        01550022
021100     PERFORM 8000-READ-EXTRACT-FILE.                              01560022
021200     IF PS-EOF-EXTRACT-YES                                        01570022
021300         DISPLAY ' SUKUT183 - INPUT FILE IS EMPTY '               01580022
021400     ELSE                                                         01590022
021800         PERFORM 3000-DECLARE-CURSOR                              01600022
021900         PERFORM 3100-OPEN-CURSOR                                 01610022
022000     END-IF.                                                      01620022
022100                                                                  01630022
022200 2000-PROCESS.                                                    01640022
022300                                                                  01650022
022400     PERFORM 3200-FETCH-CURSOR.                                   01660022
022500     IF PS-END-OF-CSR-N                                           01670022
022600         PERFORM 3300-PROCESS-CURSOR                              01680022
022700           UNTIL PS-END-OF-CSR-Y                                  01690022
022800     END-IF.                                                      01700022
022900                                                                  01710022
023000     PERFORM 3400-CLOSE-CURSOR.                                   01720022
024000                                                                  01730022
024100     PERFORM 8000-READ-EXTRACT-FILE.                              01740022
024200     IF PS-EOF-EXTRACT-YES                                        01750022
024300         DISPLAY ' SUKUT183 - END OF INPUT FILE '                 01760022
024400     ELSE                                                         01770022
024500         PERFORM 3000-DECLARE-CURSOR                              01780022
024600         PERFORM 3100-OPEN-CURSOR                                 01790022
024700     END-IF.                                                      01800022
024800                                                                  01810022
035900                                                                  01820022
036000****************************************************************  01830022
036100*     DECLARE CURSOR. THE CURSOR FETCHES THE OUTBOUND TRIPS       01840022
036300****************************************************************  01850022
036400 3000-DECLARE-CURSOR.                                             01860022
036500                                                                  01870022
036600     MOVE '3000-DECLARE-CURSOR'       TO PV-ABEND-PARAGRAPH.      01880022
036700     MOVE SU012-TRIP-ID               TO SUT00027-OTBND-TRIP-ID.  01890022
036900                                                                  01900022
037800     EXEC SQL                                                     01910022
037900       DECLARE CSR-TRIPS CURSOR FOR                               01920022
015706         SELECT DISTINCT A.SHIPT_UNT_ID , 'SCAN'                  01930022
                   FROM SUT_OTBND_LOC A                                 01940022
                      , SUT_OTBND_CART B                                01950022
                  WHERE A.OTBND_TRIP_ID = :SUT00027-OTBND-TRIP-ID       01960022
                    AND A.SCN_CDE = 'SHON'                              01970022
                    AND B.SHIPT_UNT_ID = A.SHIPT_UNT_ID                 01980022
                    AND B.MSTR_CART_IND = 'Y'                           01990022
                    UNION                                               02000022
                    SELECT DISTINCT D.SHIPT_UNT_ID, 'DIVERT'            02010022
                      FROM TSUOBTR A                                    02020022
                         , TSUCDOT B                                    02030022
                         , TSUCRDV C                                    02040022
                         , SUT_OTBND_CART D                             02050022
                    WHERE A.OTBND_TRIP_ID = :SUT00027-OTBND-TRIP-ID     02060022
                      AND B.OTBND_TRIP_ID = A.OTBND_TRIP_ID             02070022
                      AND C.OPER_UNT_ID = B.OPER_UNT_ID                 02080022
                      AND C.DOOR_ID = B.DOOR_ID                         02090022
                      AND C.DIVERT_TMST >= B.STRT_DIVERT_TMST           02100022
                      AND C.DIVERT_TMST <= B.END_DIVERT_TMST            02110022
                      AND D.SHIPT_UNT_ID = C.SHIPT_UNT_ID               02120022
                      AND D.MSTR_CART_IND = 'Y'                         02130022
                    ORDER BY 1, 2                                       02140022
046900     END-EXEC.                                                    02150022
047000                                                                  02160022
047100     EVALUATE TRUE                                                02170022
047200        WHEN SQLCODE = 100                                        02180022
047300            CONTINUE                                              02190022
047400        WHEN SQLCODE NOT EQUAL ZERO                               02200022
047500             MOVE SU012-TRIP-ID       TO PV-KEY-OTBND-TRIP-ID     02210022
047700             DISPLAY '**************************************'     02220022
047800             DISPLAY '3000-ERROR ISSUED ON                  '     02230022
047900             DISPLAY 'CURSOR DECLARE - CSR-TRIPS            '     02240022
048000             DISPLAY PV-DISP-KEY-MSG                              02250022
048100             DISPLAY '**************************************'     02260022
048200             PERFORM 9900-SQL-ERROR                               02270022
048300     END-EVALUATE.                                                02280022
048400                                                                  02290022
048500 3100-OPEN-CURSOR.                                                02300022
048600                                                                  02310022
048700     MOVE SU012-TRIP-ID         TO PV-DISP-TRIP.                  02320022
049200                                                                  02330022
049300     MOVE '3100-OPEN-CURSOR'          TO PV-ABEND-PARAGRAPH       02340022
049400                                                                  02350022
049500     EXEC SQL                                                     02360022
049600        OPEN CSR-TRIPS                                            02370022
049700     END-EXEC.                                                    02380022
049800                                                                  02390022
049900     EVALUATE SQLCODE                                             02400022
050000        WHEN 0                                                    02410022
050100            SET PS-END-OF-CSR-N       TO TRUE                     02420022
050200        WHEN OTHER                                                02430022
050300             MOVE SU012-TRIP-ID TO PV-KEY-OTBND-TRIP-ID           02440022
D50500             DISPLAY '**************************************'     02450022
050600             DISPLAY '3100-ERROR ISSUED ON                  '     02460022
050700             DISPLAY 'OPEN CURSOR CSR-TRIPS                 '     02470022
050800             DISPLAY PV-DISP-KEY-MSG                              02480022
050900             DISPLAY '**************************************'     02490022
051000             PERFORM 9900-SQL-ERROR                               02500022
051100     END-EVALUATE.                                                02510022
051200                                                                  02520022
051300 3200-FETCH-CURSOR.                                               02530022
051400                                                                  02540022
051500     MOVE '3200-FETCH-CURSOR'         TO PV-ABEND-PARAGRAPH.      02550022
051600                                                                  02560022
052300     EXEC SQL                                                     02570022
052400        FETCH CSR-TRIPS                                           02580022
052500         INTO :SUT00027-SHIPT-UNT-ID                              02590022
054300     END-EXEC.                                                    02600022
054400                                                                  02610022
054500     EVALUATE TRUE                                                02620022
054600        WHEN SQLCODE EQUAL ZERO                                   02630022
054700             ADD 1 TO PV-CSR-COUNT                                02640022
054800        WHEN SQLCODE = +100                                       02670022
054900             MOVE PV-CSR-COUNT                                    02680022
055000                                      TO PV-DISP-FETCH-COUNT      02690022
055100             DISPLAY 'END OF CURSOR   '                           02700022
055200                   'FETCH COUNT: '  PV-DISP-FETCH-COUNT           02710022
055300             SET PS-END-OF-CSR-Y        TO TRUE                   02720022
055400        WHEN OTHER                                                02730022
055500             MOVE SU012-TRIP-ID TO PV-KEY-OTBND-TRIP-ID           02740022
055700             MOVE PV-CSR-COUNT                                    02750022
055800                                      TO PV-DISP-FETCH-COUNT      02760022
055900            DISPLAY '**************************************'      02770022
056000            DISPLAY '3200-ERROR ISSUED ON                  '      02780022
056100            DISPLAY 'FETCH CURSOR CSR-TRIPS                '      02790022
056200            DISPLAY 'FETCH COUNT: '  PV-DISP-FETCH-COUNT          02800022
056300            DISPLAY PV-DISP-KEY-MSG                               02810022
056400            DISPLAY '**************************************'      02820022
056500            PERFORM 9900-SQL-ERROR                                02830022
056600     END-EVALUATE.                                                02840022
056700                                                                  02850022
056800 3300-PROCESS-CURSOR.                                             02860022
056900                                                                  02870022
057000     PERFORM 4200-DECLARE-MSTR-CSR.                               02880022
057000     PERFORM 4210-OPEN-MSTR-CSR.                                  02890022
022400     PERFORM 4300-FETCH-CURSOR.                                   02900022
022500     IF PS-END-OF-CSR2-N                                          02910022
022600         PERFORM 4600-PROCESS-CURSOR                              02920022
022700           UNTIL PS-END-OF-CSR2-Y                                 02930022
022800     END-IF.                                                      02940022
022900                                                                  02950022
      *    CLOSE MASTER CURSOR - READ ANOTHER TRIP                      02960022
023000     PERFORM 4500-CLOSE-CURSOR.                                   02970022
057400     PERFORM 3200-FETCH-CURSOR.                                   02980022
057500                                                                  02990022
057600 3400-CLOSE-CURSOR.                                               03000022
057700                                                                  03010022
057800     MOVE '3400-CLOSE-CURSOR'         TO PV-ABEND-PARAGRAPH       03020022
058600                                                                  03030022
058700     EXEC SQL                                                     03040022
058800        CLOSE CSR-TRIPS                                           03050022
058900     END-EXEC.                                                    03060022
059000                                                                  03070022
059100     EVALUATE TRUE                                                03080022
059200        WHEN SQLCODE EQUAL ZERO                                   03090022
059300           CONTINUE                                               03100022
059400        WHEN OTHER                                                03110022
059500             MOVE SU012-TRIP-ID  TO PV-KEY-OTBND-TRIP-ID          03120022
060000             DISPLAY '**************************************'     03130022
060100             DISPLAY '3400-ERROR ISSUED ON                  '     03140022
060200             DISPLAY 'CLOSE CURSOR CSR-TRIPS                '     03150022
060300             DISPLAY PV-DISP-KEY-MSG                              03160022
060400             DISPLAY '**************************************'     03170022
060500             PERFORM 9900-SQL-ERROR                               03180022
060600     END-EVALUATE.                                                03190022
060700                                                                  03200022
      *CURSOR 2                                                         03210022
067000 4200-DECLARE-MSTR-CSR.                                           03220022
069200                                                                  03230022
036600     MOVE '4200-DECLARE-MSTR-CSR'   TO PV-ABEND-PARAGRAPH.        03240022
036700     MOVE SUT00027-SHIPT-UNT-ID     TO SUT00099-MSTR-SHIPT-UNT-ID.03250022
 36900                                                                  03260022
037800     EXEC SQL                                                     03270022
037900       DECLARE CSR-MSTR  CURSOR FOR                               03280022
            SELECT CHLD_SHIPT_UNT_ID                                    03290022
                  ,CHLD_MSTR_SHIPT_ID                                   03300022
                  ,ACTN_TYP_CDE                                         03310022
              FROM  SUT_MSTR_SHIPT_CNT A                                03320022
             WHERE  A.MSTR_SHIPT_UNT_ID = :SUT00099-MSTR-SHIPT-UNT-ID   03330022
               AND  A.ACTN_TYP_CDE     IN ('ACM', 'RTM')                03340022
               AND  A.CRE_TMST IN                                       03350022
                    (SELECT MAX(B.CRE_TMST)                             03360022
                     FROM SUT_MSTR_SHIPT_CNT B                          03370022
                     WHERE  A.CHLD_SHIPT_UNT_ID = B.CHLD_SHIPT_UNT_ID)  03380022
            UNION                                                       03390022
            SELECT CHLD_SHIPT_UNT_ID                                    03400022
                  ,CHLD_MSTR_SHIPT_ID                                   03410022
                  ,ACTN_TYP_CDE                                         03420022
               FROM  SUT_MSTR_SHIPT_CNT A                               03430022
              WHERE  A.MSTR_SHIPT_UNT_ID = :SUT00099-MSTR-SHIPT-UNT-ID  03440022
                AND  A.ACTN_TYP_CDE      = 'AMM'                        03450022
                AND  A.CRE_TMST IN                                      03460022
                     (SELECT MAX(B.CRE_TMST)                            03470022
                      FROM SUT_MSTR_SHIPT_CNT B                         03480022
                      WHERE A.MSTR_SHIPT_UNT_ID = B.MSTR_SHIPT_UNT_ID   03490022
                        AND A.CHLD_MSTR_SHIPT_ID = B.CHLD_MSTR_SHIPT_ID)03500022
             ORDER BY 1                                                 03510022
069100     END-EXEC.                                                    03520022
                                                                        03530022
047100     EVALUATE TRUE                                                03540022
047200        WHEN SQLCODE = 100                                        03550022
047300            CONTINUE                                              03560022
047400        WHEN SQLCODE NOT EQUAL ZERO                               03570022
047500             MOVE SU012-TRIP-ID       TO PV-KEY-OTBND-TRIP-ID     03580022
036700             MOVE SUT00099-MSTR-SHIPT-UNT-ID TO PV-KEY-MSTR-UNT-ID03590022
047700             DISPLAY '**************************************'     03600022
047800             DISPLAY '4200-DECLARE-MSTR-CSR                 '     03610022
047900             DISPLAY 'CURSOR DECLARE - CSR-MSTR             '     03620022
048000             DISPLAY PV-DISP-KEY-MSG                              03630022
048100             DISPLAY '**************************************'     03640022
048200             PERFORM 9900-SQL-ERROR                               03650022
048300     END-EVALUATE.                                                03660022
071800                                                                  03670022
048500 4210-OPEN-MSTR-CSR.                                              03680022
049200                                                                  03690022
049300     MOVE '4210-OPEN-MSTR-CSR'     TO PV-ABEND-PARAGRAPH          03700022
049400                                                                  03710022
049500     EXEC SQL                                                     03720022
049600        OPEN CSR-MSTR                                             03730022
049700     END-EXEC.                                                    03740022
049800                                                                  03750022
049900     EVALUATE SQLCODE                                             03760022
050000        WHEN 0                                                    03770022
050100            SET PS-END-OF-CSR2-N       TO TRUE                    03780022
050200        WHEN OTHER                                                03790022
050300             MOVE SU012-TRIP-ID TO PV-KEY-OTBND-TRIP-ID           03800022
050400             MOVE SUT00099-MSTR-SHIPT-UNT-ID TO PV-KEY-MSTR-UNT-ID03810022
050500             DISPLAY '**************************************'     03820022
050600             DISPLAY '4210-OPEN-MSTR-CSR                    '     03830022
050700             DISPLAY 'OPEN CURSOR CSR-MSTR                  '     03840022
050800             DISPLAY PV-DISP-KEY-MSG                              03850022
050900             DISPLAY '**************************************'     03860022
051000             PERFORM 9900-SQL-ERROR                               03870022
051100     END-EVALUATE.                                                03880022
                                                                        03890022
      *CURSOR 2                                                         03900022
051300 4300-FETCH-CURSOR.                                               03910022
051400                                                                  03920022
051500     MOVE '4300-FETCH-CURSOR'         TO PV-ABEND-PARAGRAPH.      03930022
051600                                                                  03940022
052300     EXEC SQL                                                     03950022
052400        FETCH CSR-MSTR                                            03960022
052500         INTO :SUT00099-CHLD-SHIPT-UNT-ID :PV-CHLD-SHIPT-UNT-ID   03970022
                   ,:SUT00099-CHLD-MSTR-SHIPT-ID :PV-CHLD-MSTR-SHIPT-ID 03980022
                   ,:SUT00099-ACTN-TYP-CDE                              03990022
054300     END-EXEC.                                                    04000022
054400                                                                  04010022
054500     EVALUATE TRUE                                                04020022
054600        WHEN SQLCODE EQUAL ZERO                                   04030022
054700             ADD 1 TO PV-CSR2-COUNT                               04040022
054800        WHEN SQLCODE = +100                                       04050022
054900             MOVE PV-CSR2-COUNT                                   04060022
055000                                      TO PV-DISP-FETCH-COUNT      04070022
055100             DISPLAY 'END OF CURSOR   '                           04080022
055200                   'FETCH COUNT: '  PV-DISP-FETCH-COUNT           04090022
055300             SET PS-END-OF-CSR2-Y        TO TRUE                  04100022
055400        WHEN OTHER                                                04110022
055500             MOVE SU012-TRIP-ID TO PV-KEY-OTBND-TRIP-ID           04120022
055700             MOVE PV-CSR2-COUNT                                   04130022
055800                                      TO PV-DISP-FETCH-COUNT      04140022
055900            DISPLAY '**************************************'      04150022
056000            DISPLAY '4300-ERROR ISSUED ON                  '      04160022
056100            DISPLAY 'FETCH CURSOR CSR-MSTR                 '      04170022
056200            DISPLAY 'FETCH COUNT: '  PV-DISP-FETCH-COUNT          04180022
056300            DISPLAY PV-DISP-KEY-MSG                               04190022
056400            DISPLAY '**************************************'      04200022
056500            PERFORM 9900-SQL-ERROR                                04210022
056600     END-EVALUATE.                                                04220022
073900                                                                  04230022
057600 4500-CLOSE-CURSOR.                                               04240022
057700                                                                  04250022
057800     MOVE '4500-CLOSE-CURSOR'         TO PV-ABEND-PARAGRAPH       04260022
058600                                                                  04270022
058700     EXEC SQL                                                     04280022
058800        CLOSE CSR-MSTR                                            04290022
058900     END-EXEC.                                                    04300022
059000                                                                  04310022
059100     EVALUATE TRUE                                                04320022
059200        WHEN SQLCODE EQUAL ZERO                                   04330022
059300           CONTINUE                                               04340022
059400        WHEN OTHER                                                04350022
059500             MOVE SU012-TRIP-ID  TO PV-KEY-OTBND-TRIP-ID          04360022
05960              MOVE SUT00099-MSTR-SHIPT-UNT-ID TO PV-KEY-MSTR-UNT-ID04370022
060000             DISPLAY '**************************************'     04380022
060100             DISPLAY '4500-ERROR ISSUED ON                  '     04390022
060200             DISPLAY 'CLOSE CURSOR CSR-MSTR                 '     04400022
060300             DISPLAY PV-DISP-KEY-MSG                              04410022
060400             DISPLAY '**************************************'     04420022
060500             PERFORM 9900-SQL-ERROR                               04430022
060600     END-EVALUATE.                                                04440022
                                                                        04450022
056800 4600-PROCESS-CURSOR.                                             04460022
           IF SUT00099-ACTN-TYP-CDE = 'ACM' OR 'RTM'                    04470022
057200         PERFORM 5000-MOVE-TO-OUTPUT                              04480022
057300         PERFORM 8100-WRITE-OUTPUT-FILE                           04490022
           ELSE                                                         04500022
      *        ITS AMM                                                  04510022
      *        NEED TO LOOP THRU CURSOR 3 WITH THE CHLD-MSTR            04520022
      *        AS THE MASTER AND GET THE CHILDREN FOR IT                04530022
               PERFORM 6000-DECLARE-CHLD-MSTR-CSR                       04540022
               PERFORM 6100-OPEN-CHLD-MSTR-CURSOR                       04550022
022400         PERFORM 6200-FETCH-CURSOR                                04560022
022500         IF PS-END-OF-CSR3-N                                      04570022
022600             PERFORM 7000-PROCESS-CURSOR                          04580022
022700               UNTIL PS-END-OF-CSR3-Y                             04590022
022800         END-IF                                                   04600022
022900                                                                  04610022
023000         PERFORM 6300-CLOSE-CURSOR.                               04620022
                                                                        04630022
      *    FETCH ANOTHER MASTER                                         04640022
057400     PERFORM 4300-FETCH-CURSOR.                                   04650022
                                                                        04660022
074000 5000-MOVE-TO-OUTPUT.                                             04670022
074100                                                                  04680022
074200     MOVE SU012-TRIP-ID        TO SU142-OTBND-TRIP-ID.            04690022
      *    MSTR COMES FROM CURSOR2                                      04700022
074300     MOVE SUT00099-MSTR-SHIPT-UNT-ID TO SU142-MSTR-UNT-ID         04710022
074400     MOVE SUT00099-CHLD-SHIPT-UNT-ID TO SU142-SHIPT-UNT-ID.       04720022
076700                                                                  04730022
      *CURSOR 3                                                         04740022
067000 6000-DECLARE-CHLD-MSTR-CSR.                                      04750022
069200                                                                  04760022
036600     MOVE '6000-DECLARE-CHLD-MSTR-CSR'   TO PV-ABEND-PARAGRAPH.   04770022
           MOVE SUT00099-MSTR-SHIPT-UNT-ID TO PV-MSTR-HOLD.             04780022
                                                                        04790022
036700     MOVE SUT00099-CHLD-MSTR-SHIPT-ID TO                          04800022
036700          SUT00099-MSTR-SHIPT-UNT-ID.                             04810022
036900                                                                  04820022
      *HOW DOES THE ACM-TRM-AMM COME TO PLAY?                           04830022
      *DO I CARE AT THIS POINT WHAT IT IS ON THE CHILD                  04840022
                                                                        04850022
037800     EXEC SQL                                                     04860022
037900       DECLARE CSR-CHLD-MSTR  CURSOR FOR                          04870022
            SELECT CHLD_SHIPT_UNT_ID                                    04880022
              FROM  SUT_MSTR_SHIPT_CNT A                                04890022
             WHERE  A.MSTR_SHIPT_UNT_ID = :SUT00099-MSTR-SHIPT-UNT-ID   04900022
               AND  A.ACTN_TYP_CDE     IN ('ACM', 'RTM')                04910022
               AND  A.CRE_TMST IN                                       04920022
                    (SELECT MAX(B.CRE_TMST)                             04930022
                     FROM SUT_MSTR_SHIPT_CNT B                          04940022
                     WHERE  A.CHLD_SHIPT_UNT_ID = B.CHLD_SHIPT_UNT_ID)  04950022
            UNION                                                       04960022
             SELECT CHLD_SHIPT_UNT_ID                                   04970022
               FROM  SUT_MSTR_SHIPT_CNT A                               04980022
              WHERE  A.MSTR_SHIPT_UNT_ID = :SUT00099-MSTR-SHIPT-UNT-ID  04990022
                AND  A.ACTN_TYP_CDE      = 'AMM'                        05000022
                AND  A.CRE_TMST IN                                      05010022
                     (SELECT MAX(B.CRE_TMST)                            05020022
                      FROM SUT_MSTR_SHIPT_CNT B                         05030022
                      WHERE A.MSTR_SHIPT_UNT_ID = B.MSTR_SHIPT_UNT_ID   05040022
                        AND A.CHLD_MSTR_SHIPT_ID = B.CHLD_MSTR_SHIPT_ID)05050022
             ORDER BY 1                                                 05060022
069100     END-EXEC.                                                    05070022
                                                                        05080022
047100     EVALUATE TRUE                                                05090022
047200        WHEN SQLCODE = 100                                        05100022
047300            CONTINUE                                              05110022
047400        WHEN SQLCODE NOT EQUAL ZERO                               05120022
047500             MOVE SU012-TRIP-ID       TO PV-KEY-OTBND-TRIP-ID     05130022
036700             MOVE SUT00099-MSTR-SHIPT-UNT-ID TO PV-KEY-MSTR-UNT-ID05140022
047700             DISPLAY '**************************************'     05150022
047800             DISPLAY '6000-DECLARE-CHLD-MSTR-CSR            '     05160022
047900             DISPLAY 'CURSOR DECLARE - CSR-CHLD-MSTR        '     05170022
048000             DISPLAY PV-DISP-KEY-MSG                              05180022
048100             DISPLAY '**************************************'     05190022
048200             PERFORM 9900-SQL-ERROR                               05200022
048300     END-EVALUATE.                                                05210022
071800                                                                  05220022
048500 6100-OPEN-CHLD-MSTR-CURSOR.                                      05230022
049200                                                                  05240022
049300     MOVE '6100-OPEN-CHLD-MSTR-CURSOR'     TO PV-ABEND-PARAGRAPH  05250022
049400                                                                  05260022
049500     EXEC SQL                                                     05270022
049600        OPEN CSR-CHLD-MSTR                                        05280022
049700     END-EXEC.                                                    05290022
049800                                                                  05300022
049900     EVALUATE SQLCODE                                             05310022
050000        WHEN 0                                                    05320022
050100            SET PS-END-OF-CSR3-N       TO TRUE                    05330022
050200        WHEN OTHER                                                05340022
050300             MOVE SU012-TRIP-ID TO PV-KEY-OTBND-TRIP-ID           05350022
050400             MOVE SUT00099-MSTR-SHIPT-UNT-ID TO PV-KEY-MSTR-UNT-ID05360022
050500             DISPLAY '**************************************'     05370022
050600             DISPLAY '6100-OPEN-CHLD-MSTR-CURSRO            '     05380022
050700             DISPLAY 'OPEN CURSOR CSR-MSTR                  '     05390022
050800             DISPLAY PV-DISP-KEY-MSG                              05400022
050900             DISPLAY '**************************************'     05410022
051000             PERFORM 9900-SQL-ERROR                               05420022
051100     END-EVALUATE.                                                05430022
                                                                        05440022
      *CURSOR 3                                                         05450022
051300 6200-FETCH-CURSOR.                                               05460022
051400                                                                  05470022
051500     MOVE '6200-FETCH-CURSOR'         TO PV-ABEND-PARAGRAPH.      05480022
051600                                                                  05490022
052300     EXEC SQL                                                     05500022
052400        FETCH  CSR-CHLD-MSTR                                      05510022
               INTO :SUT00099-CHLD-SHIPT-UNT-ID :PV-CHLD-SHIPT-UNT-ID   05520022
054300     END-EXEC.                                                    05530022
054400                                                                  05540022
054500     EVALUATE TRUE                                                05550022
054600        WHEN SQLCODE EQUAL ZERO                                   05560022
054700             ADD 1 TO PV-CSR3-COUNT                               05570022
054800        WHEN SQLCODE = +100                                       05580022
054900             MOVE PV-CSR3-COUNT                                   05590022
055000                                      TO PV-DISP-FETCH-COUNT      05600022
055100             DISPLAY 'END OF CURSOR   '                           05610022
055200                   'FETCH COUNT: '  PV-DISP-FETCH-COUNT           05620022
055300             SET PS-END-OF-CSR3-Y        TO TRUE                  05630022
055400        WHEN OTHER                                                05640022
055500             MOVE SU012-TRIP-ID TO PV-KEY-OTBND-TRIP-ID           05650022
055700             MOVE PV-CSR3-COUNT                                   05660022
055800                                      TO PV-DISP-FETCH-COUNT      05670022
055900            DISPLAY '**************************************'      05680022
056000            DISPLAY '6200-ERROR ISSUED ON                  '      05690022
056100            DISPLAY 'FETCH CURSOR CSR-CHLD-MSTR            '      05700022
056200            DISPLAY 'FETCH COUNT: '  PV-DISP-FETCH-COUNT          05710022
056300            DISPLAY PV-DISP-KEY-MSG                               05720022
056400            DISPLAY '**************************************'      05730022
056500            PERFORM 9900-SQL-ERROR                                05740022
056600     END-EVALUATE.                                                05750022
073900                                                                  05760022
057600 6300-CLOSE-CURSOR.                                               05770022
057700                                                                  05780022
057800     MOVE '6300-CLOSE-CURSOR'         TO PV-ABEND-PARAGRAPH       05790022
058600                                                                  05800022
058700     EXEC SQL                                                     05810022
058800        CLOSE CSR-CHLD-MSTR                                       05820022
058900     END-EXEC.                                                    05830022
059000                                                                  05840022
059100     EVALUATE TRUE                                                05850022
059200        WHEN SQLCODE EQUAL ZERO                                   05860022
059300           CONTINUE                                               05870022
059400        WHEN OTHER                                                05880022
059500             MOVE SU012-TRIP-ID  TO PV-KEY-OTBND-TRIP-ID          05890022
059600             MOVE SUT00099-MSTR-SHIPT-UNT-ID TO PV-KEY-MSTR-UNT-ID05900022
060000             DISPLAY '**************************************'     05910022
060100             DISPLAY '6300-ERROR ISSUED ON                  '     05920022
060200             DISPLAY 'CLOSE CURSOR CSR-MSTR                 '     05930022
060300             DISPLAY PV-DISP-KEY-MSG                              05940022
060400             DISPLAY '**************************************'     05950022
060500             PERFORM 9900-SQL-ERROR                               05960022
060600     END-EVALUATE.                                                05970022
                                                                        05980022
       7000-PROCESS-CURSOR.                                             05990022
074200     MOVE SU012-TRIP-ID              TO SU142-OTBND-TRIP-ID.      06000022
074300     MOVE PV-MSTR-HOLD               TO SU142-MSTR-UNT-ID.        06010022
074400     MOVE SUT00099-CHLD-SHIPT-UNT-ID TO SU142-SHIPT-UNT-ID.       06020022
078700     PERFORM 8100-WRITE-OUTPUT-FILE.                              06030022
022400     PERFORM 6200-FETCH-CURSOR.                                   06040022
                                                                        06050022
076800 8000-READ-EXTRACT-FILE.                                          06060022
076900                                                                  06070022
077000     READ INPUT-FILE                                              06080022
077100         INTO SU012-EXTRACT-RECORD                                06090022
077200     AT END                                                       06100022
077300         SET PS-EOF-EXTRACT-YES       TO TRUE                     06110022
077400     NOT AT END                                                   06120022
077500         ADD 1                          TO PV-INPUT-COUNT         06130022
077600         MOVE  SU012-TRIP-ID            TO PV-DISP-TRIP           06140022
078000         DISPLAY '*'                                              06150022
078100         DISPLAY 'TRIP:'    PV-DISP-TRIP                          06160022
078500     END-READ.                                                    06170022
078600                                                                  06180022
078700 8100-WRITE-OUTPUT-FILE.                                          06190022
078800                                                                  06200022
078900     WRITE OUTPUT-REC                                             06210022
079000         FROM SU142-EXTRACT-RECORD.                               06220022
079100                                                                  06230022
079200 9000-EOJ.                                                        06240022
079300                                                                  06250022
079400     CLOSE      INPUT-FILE                                        06260022
079500                OUTPUT-FILE.                                      06270022
079800                                                                  06280022
080100     DISPLAY SPACES.                                              06290022
080200     MOVE PV-INPUT-COUNT              TO PV-DISP-NBR              06300022
080300     DISPLAY 'INPUTS READ   = ' PV-DISP-NBR.                      06310022
080400                                                                  06320022
080500 9800-SQL-WARNING.                                                06330022
080600                                                                  06340022
080700     MOVE SQLCODE               TO SQLCODE2.                      06350022
080800     MOVE SQLERRD(3)            TO SQLERRD3.                      06360022
080900     DISPLAY '** ABEND **       ** = SQLWARNING'.                 06370022
081000     DISPLAY '** PROGRAM        ** = SUKUT183'.                   06380022
081100     DISPLAY '** PARAGRAPH      ** = ' PV-ABEND-PARAGRAPH.        06390022
081200     DISPLAY '** SQLCODE        ** = ' SQLCODE2.                  06400022
081300     DISPLAY '** ROWS PROCESSED ** = ' SQLERRD3.                  06410022
081400                                                                  06420022
081500     COPY DPPD004.                                                06430022
081600     SET ABEND-4013-DB2-ERROR   TO TRUE                           06440022
081700     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         06450022
081800                                                                  06460022
081900 9900-SQL-ERROR.                                                  06470022
082000                                                                  06480022
082100     MOVE SQLCODE               TO SQLCODE2.                      06490022
082200     MOVE SQLERRD(3)            TO SQLERRD3.                      06500022
082300     DISPLAY '** ABEND **       ** = SQLERROR'.                   06510022
082400     DISPLAY '** PROGRAM        ** = SUKUT183'.                   06520022
082500     DISPLAY '** PARAGRAPH      ** = ' PV-ABEND-PARAGRAPH.        06530022
082600     DISPLAY '** SQLCODE        ** = ' SQLCODE2.                  06540022
082700                                                                  06550022
082800     COPY DPPD004.                                                06560022
082900     SET ABEND-4013-DB2-ERROR   TO TRUE                           06570022
083000     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         06580022
