000100*-----------------------*                                         00010099
000200 IDENTIFICATION DIVISION.                                         00020099
000300*-----------------------*                                         00030099
000400 PROGRAM-ID.    RDKCS027.                                         00040099
000500 AUTHOR.        KARI SUTTON.                                      00050099
000600 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00060099
000700 DATE-WRITTEN.  11-21-96.                                         00070099
000800 DATE-COMPILED.                                                   00080099
000900                                                                  00090099
001000*---------------------------------------------------------------* 00100099
001100*    U027 - STORED VALUE COMMENT SCREEN.                        * 00110099
001200*                                                               * 00120099
001300*  THIS SCREEN HAS TWO MODES, INQUIRY AND ADD.                  * 00130099
001400*                                                               * 00140099
001500*  IN INQUIRY MODE, THE SCREEN DISPLAYS ALL THE COMMENTS FOR    * 00150099
001600*  THE SPECIFIED CARD NUMBER IN DESCENDING ORDER (MOST CURRENT  * 00160099
001700*  TO LEAST CURRENT).  PAGE UP AND PAGE DOWN ARE USED TO SCROLL * 00170099
001800*  THROUGH THE COMMENTS.                                        * 00180099
001900*                                                               * 00190099
002000*  IN ADD MODE, THE SCREEN ALLOWS ENTRY OF A COMMENT ON PAGE    * 00200099
002100*  ONE.  THE OTHER TWO COMMENTS ON PAGE ONE DISPLAY THE MOST    * 00210099
002200*  CURRENT COMMENTS.  ALL COMMENTS NOT ON PAGE ONE WILL BE      * 00220099
002300*  DISPLAY ONLY.                                                * 00230099
002400*                                                               * 00240099
002500*  TO ADD A COMMENT, THE PF13 KEY IS PRESSED AND THEN PF2       * 00250099
002600*  IS PRESSED TO CONFIRM THE ADD.  THE COMMENT IS ADDED AND     * 00260099
002700*  DROPPED TO THE NEXT SPOT ON THE SCREEN, ALLOWING FOR ANOTHER * 00270099
002800*  COMMENT TO BE ADDED.  AN ADD SUCCESSFUL MESSAGE IS DISPLAYED.* 00280099
002900*                                                               * 00290099
003000*  A COMMENT ON THE TKMCCOM TABLE CAN CONSIST OF UP TO 4, 65    * 00300099
003100*  CHARACTER LINES.  ONLY THOSE LINES ENTERED WILL BE INSERTED  * 00310099
003200*  INTO THE TABLE.  IF DATA IS ENTERED ON LINE 2, WITHOUT DATA  * 00320099
003300*  ENTERED ON LINE 1, COMMENT LINE 2 IS MOVED UP TO LINE 1.     * 00330099
003400*  SAME FOR LINES 3 AND 4.                                      * 00340099
003500*                                                               * 00350099
003600*  COMMENTS CAN NOT BE UPDATED AND WHEN ENTERED ON THIS SCREEN  * 00360099
003700*  ARE NOT RELATED TO A SPECIFIC TRANSACTION.                   * 00370099
003800*---------------------------------------------------------------* 00380099
003900******************************************************************00390099
004000*  09/19/01 - ARCHIVE PROJECT - GREG SHEFF                       *00400099
004100*   IF CARD NUMBER IS NOT FOUND IN TABLES TKMCTBL AND TKMCCOM    *00410099
004200*   THEN SEARCH HISTORY TABLES TKMCHTB AND TKMCHCM FOR THAT CARD.*00420099
004300******************************************************************00430099
CICS  * CHANGED 10/27/2022    BY JIM HUNTER      WR: CHG0277293                 
CICS  * ADD COPYBOOK DPWS930 AND MAKE THE CICS ARCHITECTURE CALL                
CICS  * DYNAMIC INSTEAD OF STATIC BY CALLING DP930-CICS-ARCH-API.               
CICS  ******************************************************************        
004400 EJECT                                                            00440099
004500 ENVIRONMENT DIVISION.                                            00450099
004600                                                                  00460099
004700 DATA DIVISION.                                                   00470099
004800                                                                  00480099
004900 WORKING-STORAGE SECTION.                                         00490099
005000                                                                  00500099
005100 01  DK-DB2-KEYS.                                                 00510099
005200     15  DK-CARD-ID                     PIC S9(12)V VALUE ZEROS   00520099
005300                                                    COMP-3.       00530099
005400                                                                  00540099
005500 01  PC-PROGRAM-CONSTANTS.                                        00550099
005600     05  PC-CURRENT-MAP-NAME            PIC  X(08)  VALUE         00560099
005700                                                    'RD027A  '.   00570099
005800     05  PC-CURRENT-MAPSET-NAME         PIC  X(08)  VALUE         00580099
005900                                                    'RDKM027 '.   00590099
006000     05  PC-CURRENT-PROGRAM-NAME        PIC  X(08)  VALUE         00600099
006100                                                    'RDKCS027'.   00610099
006200     05  PC-USERID-HEADING              PIC  X(08)  VALUE         00620099
006300                                                    'USERID :'.   00630099
006400     05  PC-LIST-QUEUE-SEQ              PIC  9(01)  VALUE 1.      00640099
006500     05  PC-SEL-QUEUE-SEQ               PIC  9(01)  VALUE 2.      00650099
006600     05  PC-ADD-FORMAT                  PIC  X(01)  VALUE '5'.    00660099
006700     05  PC-INQUIRY-FORMAT              PIC  X(01)  VALUE '6'.    00670099
006800     05  PC-ITEMS-PER-PANEL             PIC S9(04)  VALUE +03     00680099
006900                                                    COMP SYNC.    00690099
007000     05  PC-MAX-BLOCKS-IN-ARRAY         PIC S9(04)  VALUE +2      00700099
007100                                                    COMP SYNC.    00710099
007200     05  PC-MAX-ITEMS                   PIC S9(09)  VALUE         00720099
007300                                                    +999999       00730099
007400                                                    COMP-3.       00740099
007500     05  PC-MAX-RETRIES                 PIC S9(03)  VALUE 3       00750099
007600                                                    COMP-3.       00760099
007700*                                                                 00770099
007800     05  PC-TSYMSG-NUMBERS.                                       00780099
007900         10  PC-TSYMSG-00004            PIC  9(05)  VALUE 00004.  00790099
008000         10  PC-TSYMSG-00005            PIC  9(05)  VALUE 00005.  00800099
008100         10  PC-TSYMSG-00008            PIC  9(05)  VALUE 00008.  00810099
008200         10  PC-TSYMSG-00034            PIC  9(05)  VALUE 00034.  00820099
008300         10  PC-TSYMSG-00050            PIC  9(05)  VALUE 00050.  00830099
008400         10  PC-TSYMSG-00051            PIC  9(05)  VALUE 00051.  00840099
008500         10  PC-TSYMSG-00052            PIC  9(05)  VALUE 00052.  00850099
008600         10  PC-TSYMSG-00053            PIC  9(05)  VALUE 00053.  00860099
008700         10  PC-TSYMSG-00054            PIC  9(05)  VALUE 00054.  00870099
008800         10  PC-TSYMSG-00055            PIC  9(05)  VALUE 00055.  00880099
008900         10  PC-TSYMSG-00057            PIC  9(05)  VALUE 00057.  00890099
009000         10  PC-TSYMSG-00069            PIC  9(05)  VALUE 00069.  00900099
009100         10  PC-TSYMSG-00070            PIC  9(05)  VALUE 00070.  00910099
009200         10  PC-TSYMSG-00101            PIC  9(05)  VALUE 00101.  00920099
009300         10  PC-TSYMSG-00279            PIC  9(05)  VALUE 00279.  00930099
009400         10  PC-TSYMSG-00330            PIC  9(05)  VALUE 00330.  00940099
009500         10  PC-TSYMSG-00999            PIC  9(05)  VALUE 00999.  00950099
009600         10  PC-TSYMSG-01210            PIC  9(05)  VALUE 01210.  00960099
009700         10  PC-TSYMSG-99901            PIC  9(05)  VALUE 99901.  00970099
009800*                                                                 00980099
009900 01  PS-PROGRAM-SWITCHES.                                         00990099
010000     05  PS-ERROR-SW                    PIC  X(01)  VALUE 'Y'.    01000099
010100         88  PS-NO-ERROR                            VALUE 'Y'.    01010099
010200         88  PS-ERROR                               VALUE 'N'.    01020099
010300     05  PS-COMMAREA-SW                 PIC  X(01)  VALUE 'N'.    01030099
010400         88  PS-COMMAREA-VALID                      VALUE 'Y'.    01040099
010500         88  PS-COMMAREA-NOT-VALID                  VALUE 'N'.    01050099
010600     05  PS-COMMENT-ROW-FOUND-SW        PIC  X(01)  VALUE 'Y'.    01060099
010700         88  PS-COMMENT-ROW-FOUND                   VALUE 'Y'.    01070099
010800         88  PS-COMMENT-ROW-NOT-FOUND               VALUE 'N'.    01080099
010900     05  PS-SAME-COMMENT-SW             PIC  X(01)  VALUE 'Y'.    01090099
011000         88  PS-SAME-COMMENT                        VALUE 'Y'.    01100099
011100         88  PS-DIFFERENT-COMMENT                   VALUE 'N'.    01110099
011200     05  PS-ITEMS-SW                    PIC  X(01)  VALUE 'N'.    01120000
011300         88  PS-ITEMS-FOUND                         VALUE 'Y'.    01130000
011400         88  PS-ITEMS-NOT-FOUND                     VALUE 'N'.    01140000
011500     05  PS-HIST-SW                     PIC  X(01)  VALUE 'N'.    01150000
011600         88  PS-HIST-READ                           VALUE 'Y'.    01160000
011700         88  PS-HIST-NOT-FOUND                      VALUE 'N'.    01170000
011800*                                                                 01180099
011900 01  PV-PROGRAM-VARIABLES.                                        01190099
012000     05  PV-SUB                         PIC S9(04)  VALUE +0      01200099
012100                                                    COMP SYNC.    01210099
012200     05  PV-COMMENT-SUB                 PIC S9(04)  VALUE +0      01220099
012300                                                    COMP SYNC.    01230099
012400     05  PV-REMAINDER                   PIC S9(04)  VALUE +0      01240099
012500                                                    COMP SYNC.    01250099
012600     05  PV-READ-COUNT                  PIC S9(09)  VALUE +0      01260099
012700                                                    COMP-3.       01270099
012800     05  PV-NUMBER-OF-BLANK-LINES       PIC S9(01)  VALUE +0      01280099
012900                                                    COMP-3.       01290099
013000     05  PV-SELECT                      PIC  X(01)  VALUE SPACE.  01300099
013100     05  PV-HOLD-COMMENT-TMST.                                    01310099
013200         10  PV-HOLD-CMMT-TMST-CC       PIC  X(02)  VALUE SPACES. 01320099
013300         10  PV-HOLD-CMMT-TMST-YY       PIC  X(02)  VALUE SPACES. 01330099
013400         10  FILLER                     PIC  X(01)  VALUE SPACES. 01340099
013500         10  PV-HOLD-CMMT-TMST-MM       PIC  X(02)  VALUE SPACES. 01350099
013600         10  FILLER                     PIC  X(01)  VALUE SPACES. 01360099
013700         10  PV-HOLD-CMMT-TMST-DD       PIC  X(02)  VALUE SPACES. 01370099
013800         10  FILLER                     PIC  X(01)  VALUE SPACES. 01380099
013900         10  PV-HOLD-CMMT-TMST-HH       PIC  X(02)  VALUE SPACES. 01390099
014000         10  FILLER                     PIC  X(01)  VALUE SPACES. 01400099
014100         10  PV-HOLD-CMMT-TMST-MIN      PIC  X(02)  VALUE SPACES. 01410099
014200         10  FILLER                     PIC  X(01)  VALUE SPACES. 01420099
014300         10  PV-HOLD-CMMT-TMST-SS       PIC  X(02)  VALUE SPACES. 01430099
014400         10  FILLER                     PIC  X(01)  VALUE SPACES. 01440099
014500         10  PV-HOLD-CMMT-TMST-TTTTTT   PIC  X(06)  VALUE SPACES. 01450099
014600     05  PV-HOLD-USERID                 PIC  X(08)  VALUE SPACES. 01460099
014700     05  PV-TRANS-TIMESTAMP.                                      01470099
014800         10  PV-TRANS-TMST-MM           PIC  X(02)  VALUE SPACES. 01480099
014900         10  FILLER                     PIC  X(01)  VALUE '/'.    01490099
015000         10  PV-TRANS-TMST-DD           PIC  X(02)  VALUE SPACES. 01500099
015100         10  FILLER                     PIC  X(01)  VALUE '/'.    01510099
015200         10  PV-TRANS-TMST-YY           PIC  X(02)  VALUE SPACES. 01520099
015300         10  FILLER                     PIC  X(01)  VALUE '-'.    01530099
015400         10  PV-TRANS-TMST-HH           PIC  X(02)  VALUE SPACES. 01540099
015500         10  FILLER                     PIC  X(01)  VALUE '.'.    01550099
015600         10  PV-TRANS-TMST-MIN          PIC  X(02)  VALUE SPACES. 01560099
015700         10  FILLER                     PIC  X(01)  VALUE '.'.    01570099
015800         10  PV-TRANS-TMST-SS           PIC  X(02)  VALUE SPACES. 01580099
015900     05  PV-CURRENT-TIMESTAMP           PIC  X(26)  VALUE SPACES. 01590099
016000     05  PV-ITEM-IN-USE                 PIC S9(09)  VALUE +0      01600099
016100                                                    COMP-3.       01610099
016200     05  PV-TOP-ITEM                    PIC S9(09)  VALUE +0      01620099
016300                                                    COMP-3.       01630099
016400     05  PV-BOTTOM-ITEM                 PIC S9(09)  VALUE +0      01640099
016500                                                    COMP-3.       01650099
016600     05  PV-TEMP-BLOCK-NUMBER           PIC S9(09)  VALUE +0      01660099
016700                                                    COMP-3.       01670099
016800     05  PV-BLOCK-NUMBER                PIC S9(04)  VALUE +0      01680099
016900                                                    COMP SYNC.    01690099
017000     05  PV-CICS-RESP                   PIC S9(04)  VALUE +0      01700099
017100                                                    COMP SYNC.    01710099
017200     05  PV-ITEM                        PIC S9(04)  VALUE +0      01720099
017300                                                    COMP SYNC.    01730099
017400     05  PV-SEL-QUEUE-ITEM              PIC S9(04)  VALUE +0      01740099
017500                                                    COMP SYNC.    01750099
017600     05  PV-SAVE-ITEM                   PIC S9(04)  VALUE +0      01760099
017700                                                    COMP SYNC.    01770099
017800     05  PV-HIGHEST-BLOCK-WRITTEN       PIC S9(04)  VALUE +0      01780099
017900                                                    COMP SYNC.    01790099
018000     05  PV-LIST-ITEM-NUMBER            PIC S9(04)  VALUE +0      01800099
018100                                                    COMP SYNC.    01810099
018200     05  PV-FIRST-BLOCK-IN-ARRAY        PIC S9(04)  VALUE +0      01820099
018300                                                    COMP SYNC.    01830099
018400     05  PV-NEXT-BLOCK-IN-ARRAY         PIC S9(04)  VALUE +0      01840099
018500                                                    COMP SYNC.    01850099
018600     05  PV-PREV-BLOCK-IN-ARRAY         PIC S9(04)  VALUE +0      01860099
018700                                                    COMP SYNC.    01870099
018800     05  PV-SQL-SUB                     PIC S9(04)  VALUE +0      01880099
018900                                                    COMP SYNC.    01890099
019000     05  PV-RETRY-COUNTER               PIC S9(04)  VALUE +0      01900099
019100                                                    COMP SYNC.    01910099
019200     05  PV-COMMENT-LINES               OCCURS 04 TIMES.          01920099
019300         10  PV-COMMENT-LINE            PIC  X(65)  VALUE SPACES. 01930099
019400*---------------------------------------------------------------* 01940099
019500*    MAP LAYOUT                                                 * 01950099
019600*---------------------------------------------------------------* 01960099
019700                                                                  01970099
019800     COPY RDKM027.                                                01980099
019900*                                                                 01990099
020000 01  MR-OCCURS-LAYOUT                   REDEFINES  RD027AO.       02000099
020100     05  FILLER                         PIC X(30).                02010099
020200     05  MR-SCROLL-AREA                 OCCURS 03 TIMES.          02020099
020300                                                                  02030099
020400         10  MR-TRANS-TIMESTAMPL        PIC S9(04) COMP.          02040099
020500         10  MR-TRANS-TIMESTAMPA        PIC  X(01).               02050099
020600         10  MR-TRANS-TIMESTAMPC        PIC  X(01).               02060099
020700         10  MR-TRANS-TIMESTAMPH        PIC  X(01).               02070099
020800         10  MR-TRANS-TIMESTAMP         PIC  X(17).               02080099
020900                                                                  02090099
021000         10  MR-USERID-HEADINGL         PIC S9(04) COMP.          02100099
021100         10  MR-USERID-HEADINGA         PIC  X(01).               02110099
021200         10  MR-USERID-HEADINGC         PIC  X(01).               02120099
021300         10  MR-USERID-HEADINGH         PIC  X(01).               02130099
021400         10  MR-USERID-HEADING          PIC  X(08).               02140099
021500                                                                  02150099
021600         10  MR-USERIDL                 PIC S9(04) COMP.          02160099
021700         10  MR-USERIDA                 PIC  X(01).               02170099
021800         10  MR-USERIDC                 PIC  X(01).               02180099
021900         10  MR-USERIDH                 PIC  X(01).               02190099
022000         10  MR-USERID                  PIC  X(08).               02200099
022100                                                                  02210099
022200         10  MR-COMMENT-AREA            OCCURS 04 TIMES.          02220099
022300             15  MR-COMMENTL            PIC S9(04) COMP.          02230099
022400             15  MR-COMMENTA            PIC  X(01).               02240099
022500             15  MR-COMMENTC            PIC  X(01).               02250099
022600             15  MR-COMMENTH            PIC  X(01).               02260099
022700             15  MR-COMMENTI            PIC  X(65).               02270099
022800                                                                  02280099
022900     EJECT                                                        02290099
023000*---------------------------------------------------------------* 02300099
023100*    ATTRIBUTE SETTINGS COPYBOOK.                               * 02310099
023200*---------------------------------------------------------------* 02320099
023300                                                                  02330099
023400     COPY DPWS015.                                                02340099
023500******************************************************************02350099
023600** WORKING STORAGE FOR CONVERSION TO CARD NUMBER                 *02360099
023700******************************************************************02370099
023800     COPY SVWS007.                                                02380099
023900******************************************************************02390099
024000** WORKING STORAGE CONSTANT LIST FOR STORED VALUE SYSTEM         *02400099
024100******************************************************************02410099
024200     COPY SVWS004.                                                02420099
024300                                                                  02430099
024400*---------------------------------------------------------------* 02440099
024500*    FUNCTION KEYS COPYBOOK.                                    * 02450099
024600*---------------------------------------------------------------* 02460099
024700                                                                  02470099
024800     COPY DPWS016.                                                02480099
024900                                                                  02490099
025000*---------------------------------------------------------------* 02500099
025100*    NUMERIC EDIT LAYOUT.                                       * 02510099
025200*---------------------------------------------------------------* 02520099
025300                                                                  02530099
025400     COPY DPWS010I.                                               02540099
025500 EJECT                                                            02550099
025600*---------------------------------------------------------------* 02560099
025700*    PARAMETERS FOR CALLING THE CICS ARCHITECTURE API.          * 02570099
025800*---------------------------------------------------------------* 02580099
025900                                                                  02590099
026000     COPY DPWS030.                                                02600099
CICS       COPY DPWS930.                                                02600099
026100 EJECT                                                            02610099
026200*---------------------------------------------------------------* 02620099
026300*    STANDARD COMMAREA.                                         * 02630099
026400*---------------------------------------------------------------* 02640099
026500                                                                  02650099
026600     COPY DPWS020.                                                02660099
026700     05  FILLER REDEFINES DP020-VARIABLE-COMMAREA.                02670099
026800                                                                  02680099
026900*---------------------------------------------------------------* 02690099
027000* INTER-APPLICATION COMMAREA.                                   * 02700099
027100*   RDWS023 - IS THE INPUT LAYOUT WHEN COMING FROM THE CRIT.    * 02710099
027200*             SPEC SCREEN, THE MANUAL REFERRAL SCREEN, THE VOID * 02720099
027300*             SCREEN, THE AUDIT SCREEN, AND THE INQUIRY SCREEN. * 02730099
027400*---------------------------------------------------------------* 02740099
027500                                                                  02750099
027600         10  INTER-APPL-COMM-AREA       PIC X(200).               02760099
027700     COPY RDWS023.                                                02770099
027800*---------------------------------------------------------------* 02780099
027900*  THIS IS THE APPLICATION-SPECIFIC COMMAREA.                   * 02790099
028000*---------------------------------------------------------------* 02800099
028100         10  ASC-SPECIFIC-COMMAREA.                               02810099
028200             15  ASC-LIST-KEYS.                                   02820099
028300                 20  ASC-KEY-CARD-ID                 PIC  9(13).  02830099
028400             15  ASC-SHORT-CARD-ID                   PIC  9(12).  02840099
028500             15  ASC-ADD-FUNCTION-KEY-SW             PIC  X(01).  02850099
028600                 88  ASC-ADD-FUNCTION-NOT-PRESSED    VALUE 'N'.   02860099
028700                 88  ASC-ADD-FUNCTION-PRESSED        VALUE 'Y'.   02870099
028800             15  ASC-HIST-SW                         PIC  X(01).  02880099
028900                 88  ASC-HIST-READ                   VALUE 'Y'.   02890099
029000                 88  ASC-HIST-NOT-FOUND              VALUE 'N'.   02900099
029100             15  ASC-BLOCK-ENTRIES OCCURS 2 TIMES.                02910099
029200                 20  ASC-BLOCK-MODIFIED-SW           PIC  X(01).  02920099
029300                     88  ASC-BLOCK-NOT-MODIFIED      VALUE 'N'.   02930099
029400                     88  ASC-BLOCK-MODIFIED          VALUE 'Y'.   02940099
029500                                                                  02950099
029600                 20  ASC-ITEM-ARRAY.                              02960099
029700                     25  ASC-ITEM-ENTRIES OCCURS 03 TIMES.        02970099
029800                         30  ASC-LIST-ITEM-NUMBER    PIC S9(09)   02980099
029900                                                     COMP-3.      02990099
030000                         30  ASC-TRANS-TIMESTAMP     PIC  X(17).  03000099
030100                         30  ASC-USERID              PIC  X(08).  03010099
030200                         30  ASC-COMMENT-LINES    OCCURS 04 TIMES.03020099
030300                             35  ASC-COMMENT-LINE    PIC  X(65).  03030099
030400                                                                  03040099
030500             15  ASC-BLK-SUB                         PIC S9(04)   03050099
030600                                                          COMP    03060099
030700                                                          SYNC.   03070099
030800             15  ASC-ITEM-SUB                        PIC S9(04)   03080099
030900                                                          COMP    03090099
031000                                                          SYNC.   03100099
031100             15  ASC-NUMBER-OF-ITEMS-READ            PIC S9(09)   03110099
031200                                                          COMP-3. 03120099
031300             15  ASC-ITEMS-DISPLAYED                 PIC S9(03)   03130099
031400                                                          COMP-3. 03140099
031500             15  ASC-ITEM-AT-TOP-OF-PANEL            PIC S9(09)   03150099
031600                                                          COMP-3. 03160099
031700             15  ASC-ITEM-AT-BOT-OF-PANEL            PIC S9(09)   03170099
031800                                                          COMP-3. 03180099
031900             15  ASC-HIGHEST-BLOCK-WRITTEN           PIC S9(04)   03190099
032000                                                          COMP    03200099
032100                                                          SYNC.   03210099
032200             15  ASC-ITEMS-LEFT-INDICATOR            PIC  X(01).  03220099
032300                 88  ASC-ITEMS-LEFT-ON-DB            VALUE 'Y'.   03230099
032400                 88  ASC-NO-ITEMS-LEFT-ON-DB         VALUE 'N'.   03240099
032500             15  ASC-LIST-QUEUE-NAME.                             03250099
032600                 20  ASC-LIST-TERM-ID                PIC  X(04).  03260099
032700                 20  ASC-LIST-TASK-NUMBER            PIC S9(05)   03270099
032800                                                          COMP-3. 03280099
032900                 20  ASC-LIST-SEQ                    PIC  9(01).  03290099
033000             15  ASC-SEL-QUEUE-NAME.                              03300099
033100                 20  ASC-SEL-TERM-ID                 PIC  X(04).  03310099
033200                 20  ASC-SEL-TASK-NUMBER             PIC S9(05)   03320099
033300                                                          COMP-3. 03330099
033400                 20  ASC-SEL-SEQ                     PIC  9(01).  03340099
033500         10  FILLER                                  PIC  X(1055).03350099
033600     EJECT                                                        03360099
033700*---------------------------------------------------------------* 03370099
033800*    ABEND PROCESSING COPYBOOK.                                 * 03380099
033900*---------------------------------------------------------------* 03390099
034000                                                                  03400099
034100     COPY DPWS013.                                                03410099
034200                                                                  03420099
034300 EJECT                                                            03430099
034400*---------------------------------------------------------------* 03440099
034500*    DB2 AREA FOR TKMCCOM                                       * 03450099
034600*---------------------------------------------------------------* 03460099
034700     EXEC SQL                                                     03470099
034800          INCLUDE SVT00003                                        03480099
034900     END-EXEC.                                                    03490099
035000*---------------------------------------------------------------* 03500099
035100*    DB2 AREA FOR TKMCHCM                                       * 03510099
035200*---------------------------------------------------------------* 03520099
035300     EXEC SQL                                                     03530099
035400          INCLUDE SVT00007                                        03540099
035500     END-EXEC.                                                    03550099
035600*---------------------------------------------------------------* 03560099
035700*    DB2 AREA FOR TKMCTBL                                       * 03570099
035800*---------------------------------------------------------------* 03580099
035900     EXEC SQL                                                     03590099
036000          INCLUDE SVT00001                                        03600099
036100     END-EXEC.                                                    03610099
036200*---------------------------------------------------------------* 03620099
036300*    DB2 AREA FOR TKMCHTB                                       * 03630099
036400*---------------------------------------------------------------* 03640099
036500     EXEC SQL                                                     03650099
036600          INCLUDE SVT00005                                        03660099
036700     END-EXEC.                                                    03670099
036800*---------------------------------------------------------------* 03680099
036900*    DB2 AREA FOR COMMUNICATIONS                                * 03690099
037000*---------------------------------------------------------------* 03700099
037100     EXEC SQL                                                     03710099
037200          INCLUDE SQLCA                                           03720099
037300     END-EXEC.                                                    03730099
037400                                                                  03740099
037500*---------------------------------------------------------------* 03750099
037600*    COMMENT CURSOR                                             * 03760099
037700*---------------------------------------------------------------* 03770099
037800                                                                  03780099
037900     EXEC SQL                                                     03790099
038000          DECLARE COMMENT-CSR CURSOR                              03800099
038100          FOR SELECT                                              03810099
038200                CRE_TMST                                          03820099
038300              , CMNT_SEQ_NBR                                      03830099
038400              , CMNT_TXT                                          03840099
038500              , CRE_BY_USR_ID                                     03850099
038600          FROM                                                    03860099
038700                SVT_CRD_ACCT_CMMT                                 03870099
038800          WHERE                                                   03880099
038900                CRD_NBR        = :DK-CARD-ID                      03890099
039000          ORDER BY                                                03900099
039100                CRE_TMST DESC                                     03910099
039200              , CMNT_SEQ_NBR                                      03920099
039201          WITH UR                                                         
039300     END-EXEC.                                                    03930099
039400*---------------------------------------------------------------* 03940099
039500*    HISTORY COMMENT CURSOR                                     * 03950099
039600*---------------------------------------------------------------* 03960099
039700                                                                  03970099
039800     EXEC SQL                                                     03980099
039900          DECLARE COMMENT-CSR-HIST CURSOR                         03990099
040000          FOR SELECT                                              04000099
040100                CRE_TMST                                          04010099
040200              , CMNT_SEQ_NBR                                      04020099
040300              , CMNT_TXT                                          04030099
040400              , CRE_BY_USR_ID                                     04040099
040500          FROM                                                    04050099
040600                SVT_CRD_CMMT_HIST                                 04060099
040700          WHERE                                                   04070099
040800                CRD_NBR        = :DK-CARD-ID                      04080099
040900          ORDER BY                                                04090099
041000                CRE_TMST DESC                                     04100099
041100              , CMNT_SEQ_NBR                                      04110099
041101          WITH UR                                                         
041200     END-EXEC.                                                    04120099
041300                                                                  04130099
041400 EJECT                                                            04140099
041500 LINKAGE SECTION.                                                 04150099
041600                                                                  04160099
041700 01  DFHCOMMAREA.                                                 04170099
041800     05  FILLER                         OCCURS  1 TO 4072 TIMES   04180099
041900                                        DEPENDING ON EIBCALEN.    04190099
042000         10  FILLER                     PIC X.                    04200099
042100                                                                  04210099
042200 EJECT                                                            04220099
042300 PROCEDURE DIVISION.                                              04230099
042400******************************************************************04240099
042500**  THIS MODULE IS THE HIGHEST PROCESSING LEVEL IN THE PROGRAM. **04250099
042600**  FIRST, CALL THE CICS ARCHITECTURE API, PERFORM THE PROGRAM  **04260099
042700**  PROCESSING AND THEN CALL THE CICS ARCHITECTURE API TO EXIT. **04270099
042800******************************************************************04280099
042900 0000-MAIN-MODULE.                                                04290099
043000     INITIALIZE DP030-CICS-API-FIELDS.                            04300099
043100     MOVE +1                       TO DP030-NUMBER-OF-MAPS.       04310099
043200     MOVE PC-CURRENT-MAPSET-NAME   TO DP030-MAPSET-NAME.          04320099
043300     MOVE PC-CURRENT-MAP-NAME      TO DP030-MAP-NAME (1).         04330099
043400     SET DP030-RECEIVE-APPL-MAP    TO TRUE.                       04340099
043500     MOVE LENGTH OF RD027AI        TO DP030-MAP-LENGTH (1).       04350099
043600     MOVE 'PROGRAM ENTRY CALL'     TO DP013-MESSAGE-TEXT (1).     04360099
043700     PERFORM 0001-CALL-CICS-ARCH-API.                             04370099
043800     PERFORM 1000-CONTROL-PROCESSING                              04380099
043900*                                                                 04390099
044000     MOVE 'PROGRAM EXIT CALL'      TO DP013-MESSAGE-TEXT (1).     04400099
044100     PERFORM 0001-CALL-CICS-ARCH-API.                             04410099
044200                                                                  04420099
044300******************************************************************04430099
044400**  THIS PARAGRAPH CALLS THE CICS ARCHITECTURE API SUBROUTINE   **04440099
044500**  AND WILL ABEND IF ANY ERRORS OCCURRED IN THAT CALL.         **04450099
044600******************************************************************04460099
044700 0001-CALL-CICS-ARCH-API.                                         04470099
CICS       CALL DP930-CICS-ARCH-API USING DFHEIBLK                              
044900                                    DFHCOMMAREA                           
045000                                    DP030-CICS-API-FIELDS                 
045100                                    DP020-STANDARD-COMMAREA               
045200                                    RD027AI.                              
045300*                                                                 04530099
045400     IF  DP030-RC-CALL-SUCCESSFUL                                 04540099
045500         CONTINUE                                                 04550099
045600     ELSE                                                         04560099
045700         SET DP013-NO-ROLLBACK                                    04570099
045800             DP013-XCTL-DISPLAY-RESTART                           04580099
045900             DP013-CICS-ABEND      TO TRUE                        04590099
046000         MOVE '0001-CALL-CICS-ARCH-API'                           04600099
046100                                   TO DP013-PARAGRAPH             04610099
CICS           MOVE 'CALL TO CICS ARCH API NOT SUCCESSFUL, RETURN-CODE O        
CICS  -             'N NEXT LINE'        TO DP013-MESSAGE-TEXT (2)              
046400         MOVE DP030-RETURN-CODE    TO DP013-MESSAGE-TEXT (3)      04640099
046500         PERFORM DP013-0000-PROCESS-ABEND                         04650099
046600     END-IF.                                                      04660099
046700*----------------------------------------------------------------*04670099
046800* PROCESS THE APPROPRIATE PARAGRAPHS BASED ON WHAT THE NEXT      *04680099
046900* COURSE OF ACTION IS FOR THIS TRANSACTION.                      *04690099
047000*                                                                *04700099
047100* NOTE:  PV-TOP-ITEM IS THE ITEM THAT IS REQUESTED TO BE AT THE  *04710099
047200*  TOP OF THE PANEL.  MOVING ASC-ITEM-AT-TOP-OF-PANEL TO THIS    *04720099
047300*  MEANS THAT POSITION WITHIN THE LIST WILL NOT CHANGE -- THIS   *04730099
047400*  IS THE DEFAULT WHICH WILL BE OVERRIDDEN BY SCROLLING ACTIONS. *04740099
047500*----------------------------------------------------------------*04750099
047600                                                                  04760099
047700 1000-CONTROL-PROCESSING.                                         04770099
047800                                                                  04780099
047900     EVALUATE TRUE                                                04790099
048000         WHEN DP020-NEXT-ACT-INITIAL                              04800099
048100             INITIALIZE ASC-SPECIFIC-COMMAREA                     04810099
048200             MOVE EIBTRMID         TO ASC-LIST-TERM-ID            04820099
048300                                      ASC-SEL-TERM-ID             04830099
048400             MOVE DP020-SRC-TASK-NUMBER                           04840099
048500                                   TO ASC-LIST-TASK-NUMBER        04850099
048600                                      ASC-SEL-TASK-NUMBER         04860099
048700             MOVE PC-LIST-QUEUE-SEQ                               04870099
048800                                   TO ASC-LIST-SEQ                04880099
048900             MOVE PC-SEL-QUEUE-SEQ TO ASC-SEL-SEQ                 04890099
049000             PERFORM 1100-PROCESS-INTER-APPL-COMM                 04900099
049100***-----$TEMPLATE NOTE$-------------------------------------------04910099
049200*** IF THE DATA EXPECTED IS NOT RECEIVED FROM CALLING APPLICATION,04920099
049300*** SETUP APPROPRIATE MESSAGE AND SEVERITY AND SET APPL-ERROR TO  04930099
049400*** TRUE, THIS WILL RETURN TO CALLING APPLICATION WHEN API CALLED.04940099
049500***---------------------------------------------------------------04950099
049600             IF  PS-COMMAREA-NOT-VALID                            04960099
049700                 PERFORM 1105-PROCESS-INTER-APPL-HIST             04970099
049800                 IF  PS-COMMAREA-NOT-VALID                        04980099
049900                     SET DP020-MSG-FATAL                          04990099
050000                                       TO TRUE                    05000099
050100                     SET DP020-NEXT-ACT-APPL-ERROR                05010099
050200                                       TO TRUE                    05020099
050300                 ELSE                                             05030099
050400                     PERFORM 4005-BUILD-INITIAL-HIST              05040099
050500                 END-IF                                           05050099
050600             ELSE                                                 05060099
050700                 PERFORM 4000-BUILD-INITIAL-PANEL                 05070099
050800             END-IF                                               05080099
050900                                                                  05090099
051000         WHEN DP020-NEXT-ACT-READ-MAP                             05100099
051100             MOVE ASC-ITEM-AT-TOP-OF-PANEL                        05110099
051200                                   TO PV-TOP-ITEM                 05120099
051300             PERFORM 2000-PROCESS-PANEL                           05130099
051400                                                                  05140099
051500         WHEN DP020-NEXT-ACT-RETURN                               05150099
051600             MOVE ASC-ITEM-AT-TOP-OF-PANEL                        05160099
051700                                   TO PV-TOP-ITEM                 05170099
051800             MOVE ZERO             TO ASC-ITEM-AT-TOP-OF-PANEL    05180099
051900             PERFORM 3000-EDIT-DATA-IN-COMMAREA                   05190099
052000             PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                 05200099
052100                                                                  05210099
052200         WHEN OTHER                                               05220099
052300             SET DP013-LOGIC-ABEND TO TRUE                        05230099
052400             SET DP013-NO-ROLLBACK TO TRUE                        05240099
052500             MOVE '1000-CONTROL-PROCESSING'                       05250099
052600                                   TO DP013-PARAGRAPH             05260099
052700             MOVE 'INVALID NEXT APPLICATION ACTIVITY RECEIVED'    05270099
052800                                   TO DP013-MESSAGE-TEXT(1)       05280099
052900             PERFORM DP013-0000-PROCESS-ABEND                     05290099
053000     END-EVALUATE.                                                05300099
053100                                                                  05310099
053200 EJECT                                                            05320099
053300*----------------------------------------------------------------*05330099
053400* DETERMINE IF DATA WAS PASSED THROUGH INTER-APPL COMMAREA.      *05340099
053500*----------------------------------------------------------------*05350099
053600                                                                  05360099
053700 1100-PROCESS-INTER-APPL-COMM.                                    05370099
053800                                                                  05380099
053900     SET ASC-HIST-NOT-FOUND        TO TRUE.                       05390000
054000     SET PS-COMMAREA-VALID         TO TRUE.                       05400099
054100     IF RD023-CARD-ID = ZERO                                      05410099
054200         SET PS-COMMAREA-NOT-VALID                                05420099
054300                                   TO TRUE                        05430099
054400*        --- ENTRY OF FIELD IS REQUIRED ---                       05440099
054500         MOVE PC-TSYMSG-00330      TO DP020-MSG-NUMBER            05450099
054600     ELSE                                                         05460099
054800         PERFORM 1170-SETUP-CARD-NBR                              05480099
054900     END-IF.                                                      05490099
055000                                                                  05500099
055100     PERFORM 1150-VERIFY-CARD.                                    05510099
055200                                                                  05520099
055300*----------------------------------------------------------------*05530099
055400* DETERMINE IF DATA WAS PASSED THROUGH INTER-APPL COMMAREA.      *05540099
055500*----------------------------------------------------------------*05550099
055600 1105-PROCESS-INTER-APPL-HIST.                                    05560099
055700                                                                  05570099
055800     SET ASC-HIST-READ             TO TRUE.                       05580099
055900     SET PS-COMMAREA-VALID         TO TRUE.                       05590099
056000     IF RD023-CARD-ID = ZERO                                      05600099
056100         SET PS-COMMAREA-NOT-VALID                                05610099
056200                                   TO TRUE                        05620099
056300*        --- ENTRY OF FIELD IS REQUIRED ---                       05630099
056400         MOVE PC-TSYMSG-00330      TO DP020-MSG-NUMBER            05640099
056500     ELSE                                                         05650099
056700         PERFORM 1170-SETUP-CARD-NBR                              05670099
056800     END-IF.                                                      05680099
056900                                                                  05690099
057000     PERFORM 1155-VERIFY-CARD-HIST.                               05700099
057100 EJECT                                                            05710099
057200*----------------------------------------------------------------*05720099
057300*  VERIFY THAT THE CARD NUMBER EXISTS ON THE TKMCTBL.            *05730099
057400*----------------------------------------------------------------*05740099
057500                                                                  05750099
057600 1150-VERIFY-CARD.                                                05760099
057700                                                                  05770099
057800     EXEC SQL                                                     05780099
057900         SELECT  '1'                                              05790099
058000           INTO  :PV-SELECT                                       05800099
058100           FROM  SVT_KOHLS_CRD_ACCT                               05810099
058200          WHERE  CRD_NBR = :DK-CARD-ID                            05820099
058201          WITH UR                                                         
058300     END-EXEC.                                                    05830099
058400                                                                  05840099
058500     EVALUATE TRUE                                                05850099
058600         WHEN SQLCODE = ZERO                                      05860099
058700             CONTINUE                                             05870099
058800         WHEN SQLCODE = +100                                      05880099
058900             SET PS-COMMAREA-NOT-VALID TO TRUE                    05890099
059000*            --- CARD ID NOT FOUND ---                            05900099
059100         WHEN OTHER                                               05910099
059200             MOVE '1150-VERIFY-CARD'   TO DP013-PARAGRAPH         05920099
059300             MOVE 'UNABLE TO SELECT CARD ID'                      05930099
059400                                       TO DP013-MESSAGE-TEXT (1)  05940099
059500             MOVE SQLCA                TO DP013-SQLCA             05950099
059600             MOVE 'SVT_KOHLS_CRD_ACCT' TO DP013-DB2-TABLE-NAME (1)05960099
059700             SET DP013-DB2-ABEND       TO TRUE                    05970099
059800             PERFORM DP013-0000-PROCESS-ABEND                     05980099
059900     END-EVALUATE.                                                05990099
060000                                                                  06000099
060100*----------------------------------------------------------------*06010099
060200*  VERIFY THAT THE CARD NUMBER EXISTS ON THE TSVT00005.          *06020099
060300*----------------------------------------------------------------*06030099
060400                                                                  06040099
060500 1155-VERIFY-CARD-HIST.                                           06050099
060600                                                                  06060099
060700     EXEC SQL                                                     06070099
060800         SELECT  '1'                                              06080099
060900           INTO  :PV-SELECT                                       06090099
061000           FROM  SVT_CRD_ACCT_HIST                                06100099
061100          WHERE  CRD_NBR = :DK-CARD-ID                            06110099
061101          WITH UR                                                         
061200     END-EXEC.                                                    06120099
061300                                                                  06130099
061400     EVALUATE TRUE                                                06140099
061500         WHEN SQLCODE = ZERO                                      06150099
061600             CONTINUE                                             06160099
061700         WHEN SQLCODE = +100                                      06170099
061800             SET PS-COMMAREA-NOT-VALID TO TRUE                    06180099
061900*            --- CARD ID NOT FOUND ---                            06190099
062000             MOVE PC-TSYMSG-01210      TO DP020-MSG-NUMBER        06200099
062100         WHEN OTHER                                               06210099
062200             MOVE '1155-VERIFY-CARD-HIST'   TO DP013-PARAGRAPH    06220099
062300             MOVE 'UNABLE TO SELECT CARD ID'                      06230099
062400                                       TO DP013-MESSAGE-TEXT (1)  06240099
062500             MOVE SQLCA                TO DP013-SQLCA             06250099
062600             MOVE 'SVT_CRD_ACCT_HIST'  TO DP013-DB2-TABLE-NAME (1)06260099
062700             SET DP013-DB2-ABEND       TO TRUE                    06270099
062800             PERFORM DP013-0000-PROCESS-ABEND                     06280099
062900     END-EVALUATE.                                                06290099
063000                                                                  06300099
063100 1170-SETUP-CARD-NBR.                                             06310099
063101     MOVE RD023-30-DIGIT-CARD-NBR TO SV007-CARD-NUMBER-IN.                
063102     MOVE 0                       TO SV007-CARD-NUMBER-LENGTH             
063103     SET SV007-FORMAT-IN          TO TRUE                                 
063104     PERFORM SV007-FORMAT-CARD                                            
063105     MOVE SV007-CARD-NBR          TO DK-CARD-ID                           
063106                                     ASC-KEY-CARD-ID                      
063600                                     ASC-SHORT-CARD-ID.           06360099
063700*----------------------------------------------------------------*06370099
063800* DO ANY PROCESSING FOR KEYS FOR WHICH NO EDITTING OF THE DATA   *06380099
063900* ON THE SCREEN NEEDS TO BE DONE.  IF ONE OF THOSE KEYS IS NOT   *06390099
064000* USED, EDIT THE DATA ON THE SCREEN AND GO ON TO CHECK THE REST  *06400099
064100* OF THE FUNCTION KEYS.  NOTE THAT WITH THE API, NO INVALID      *06410099
064200* FUNCTION KEYS CAN GET THIS FAR.                                *06420099
064300*----------------------------------------------------------------*06430099
064400                                                                  06440099
064500 2000-PROCESS-PANEL.                                              06450099
064600     EVALUATE TRUE                                                06460099
064700         WHEN DP020-SRC-AID = DP016-CLEAR                         06470099
064800             MOVE ZERO             TO ASC-ITEM-AT-TOP-OF-PANEL    06480099
064900             SET ASC-ADD-FUNCTION-NOT-PRESSED                     06490099
065000                                   TO TRUE                        06500099
065100             PERFORM 3000-EDIT-DATA-IN-COMMAREA                   06510099
065200             PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                 06520099
065300                                                                  06530099
065400         WHEN DP020-FK-REFRESH (DP020-SRC-AID)                    06540099
065500             MOVE ASC-SHORT-CARD-ID                               06550099
065600                                   TO DK-CARD-ID                  06560099
065700             PERFORM 2050-DELETE-LIST-QUEUE                       06570099
065800             IF ASC-HIST-READ                                     06580099
065900                PERFORM 4005-BUILD-INITIAL-HIST                   06590099
066000             ELSE                                                 06600099
066100                PERFORM 4000-BUILD-INITIAL-PANEL                  06610099
066200             END-IF                                               06620099
066300                                                                  06630099
066400         WHEN OTHER                                               06640099
066500             PERFORM 2200-MOVE-SCREEN-TO-COMMAREA                 06650099
066600             SET DP030-CONTINUE-GO                                06660099
066700                                 TO TRUE                          06670099
066800             PERFORM 2100-CHECK-FUNCTION-KEY                      06680099
066900     END-EVALUATE.                                                06690099
067000 EJECT                                                            06700099
067100*----------------------------------------------------------------*06710099
067200*  DELETE THE LIST ITEMS TEMP STORAGE QUEUE.                     *06720099
067300*----------------------------------------------------------------*06730099
067400 2050-DELETE-LIST-QUEUE.                                          06740099
067500                                                                  06750099
067600     EXEC CICS                                                    06760099
067700         DELETEQ TS                                               06770099
067800             QUEUE (ASC-LIST-QUEUE-NAME)                          06780099
067900             RESP  (PV-CICS-RESP)                                 06790099
068000     END-EXEC.                                                    06800099
068100                                                                  06810099
068200     IF (PV-CICS-RESP = DFHRESP(NORMAL)) OR                       06820099
068300        (PV-CICS-RESP = DFHRESP(QIDERR))                          06830099
068400         CONTINUE                                                 06840099
068500     ELSE                                                         06850099
068600         SET DP013-CICS-ABEND      TO TRUE                        06860099
068700         SET DP013-NO-ROLLBACK     TO TRUE                        06870099
068800                                                                  06880099
068900         MOVE '2050-DELETE-LIST-QUEUE'                            06890099
069000                                   TO DP013-PARAGRAPH             06900099
069100         MOVE 'ERROR TRYING TO DELETE LIST TEMP STORAGE QUEUE'    06910099
069200                                   TO DP013-MESSAGE-TEXT (1)      06920099
069300         PERFORM DP013-0000-PROCESS-ABEND                         06930099
069400     END-IF.                                                      06940099
069500                                                                  06950099
069600     MOVE +0                       TO ASC-HIGHEST-BLOCK-WRITTEN.  06960099
069700 EJECT                                                            06970099
069800*----------------------------------------------------------------*06980099
069900* ACT ON ANY FUNCTION KEYS THAT REQUIRE EDITS TO BE PASSED FIRST.*06990099
070000* NOTE THAT INVALID FUNCTION KEYS WILL NOT BE RETURNED FROM THE  *07000099
070100* CICS ARCHITECTURE API.                                         *07010099
070200*----------------------------------------------------------------*07020099
070300 2100-CHECK-FUNCTION-KEY.                                         07030099
070400                                                                  07040099
070500     EVALUATE TRUE                                                07050099
070600         WHEN DP020-FK-LOCAL-FUNC-01(DP020-SRC-AID)               07060099
070700             IF PV-TOP-ITEM = 1 OR 4                              07070099
070800                 CONTINUE                                         07080099
070900             ELSE                                                 07090099
071000                 MOVE 1          TO PV-TOP-ITEM                   07100099
071100                 MOVE 1          TO ASC-BLK-SUB                   07110099
071200                                    PV-BLOCK-NUMBER               07120099
071300                 PERFORM 4410-READ-TEMP-STORAGE                   07130099
071400                 IF ASC-HIGHEST-BLOCK-WRITTEN > 1                 07140099
071500                     MOVE 2      TO ASC-BLK-SUB                   07150099
071600                                    PV-BLOCK-NUMBER               07160099
071700                     PERFORM 4410-READ-TEMP-STORAGE               07170099
071800                 END-IF                                           07180099
071900             END-IF                                               07190099
072000             MOVE 1 TO PV-TOP-ITEM                                07200099
072100             PERFORM 3000-EDIT-DATA-IN-COMMAREA                   07210099
072200             IF  PS-NO-ERROR                                      07220099
072300                 SET DP030-CONTINUE-GO                            07230099
072400                                  TO TRUE                         07240099
072500                 SET ASC-ADD-FUNCTION-PRESSED                     07250099
072600                                  TO TRUE                         07260099
072700*                --- PRESS F2 TO CONFIRM REQUEST ---              07270099
072800                 MOVE PC-TSYMSG-00004 TO DP020-MSG-NUMBER         07280099
072900                 SET DP020-MSG-INFORMATIONAL                      07290099
073000                                  TO TRUE                         07300099
073100             ELSE                                                 07310099
073200                 SET DP030-OVERRIDE-GO                            07320099
073300                                  TO TRUE                         07330099
073400             END-IF                                               07340099
073500             PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                 07350099
073600                                                                  07360099
073700         WHEN DP020-FK-CONFIRM(DP020-SRC-AID)                     07370099
073800             IF ASC-BLOCK-MODIFIED (1) OR                         07380099
073900                ASC-ADD-FUNCTION-NOT-PRESSED                      07390099
074000                 PERFORM 4400-MOVE-COMMAREA-TO-SCREEN             07400099
074100*                --- ADD MUST BE REQUESTED BEFORE CONFIRM ---     07410099
074200                 MOVE PC-TSYMSG-00999 TO DP020-MSG-NUMBER         07420099
074300                 SET DP020-MSG-INFORMATIONAL                      07430099
074400                                  TO TRUE                         07440099
074500             ELSE                                                 07450099
074600                 IF ASC-HIST-READ                                 07460000
074700                    PERFORM 8005-GET-CUR-TIMESTAMP-HIST           07470099
074800                    PERFORM 8105-INSERT-COMMENT-HIST              07480099
074900                        VARYING PV-COMMENT-SUB                    07490099
075000                        FROM 1 BY 1                               07500099
075100                        UNTIL PV-COMMENT-SUB > 4                  07510099
075200                 ELSE                                             07520099
075300                    PERFORM 8000-GET-CURRENT-TIMESTAMP            07530099
075400                    PERFORM 8100-INSERT-COMMENT                   07540099
075500                        VARYING PV-COMMENT-SUB                    07550099
075600                        FROM 1 BY 1                               07560099
075700                        UNTIL PV-COMMENT-SUB > 4                  07570099
075800                 END-IF                                           07580099
075900                 PERFORM 2050-DELETE-LIST-QUEUE                   07590099
076000                 IF ASC-HIST-READ                                 07600000
076100                    PERFORM 4005-BUILD-INITIAL-HIST               07610099
076200                 ELSE                                             07620099
076300                    PERFORM 4000-BUILD-INITIAL-PANEL              07630099
076400                 END-IF                                           07640099
076500*            --- ADD SUCCESSFUL ---                               07650099
076600                 MOVE PC-TSYMSG-00034 TO DP020-MSG-NUMBER         07660099
076700                 SET DP020-MSG-INFORMATIONAL TO TRUE              07670099
076800             END-IF                                               07680099
076900                                                                  07690099
077000         WHEN DP020-FK-FIRST-PAGE(DP020-SRC-AID)                  07700099
077100             MOVE +1               TO PV-TOP-ITEM                 07710099
077200             SET ASC-ADD-FUNCTION-NOT-PRESSED                     07720099
077300                                   TO TRUE                        07730099
077400             PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                 07740099
077500                                                                  07750099
077600         WHEN DP020-FK-PREV-PAGE(DP020-SRC-AID)                   07760099
077700             SET ASC-ADD-FUNCTION-NOT-PRESSED                     07770099
077800                                   TO TRUE                        07780099
077900             PERFORM 2110-BROWSE-BACKWARD                         07790099
078000             PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                 07800099
078100                                                                  07810099
078200         WHEN DP020-FK-NEXT-PAGE(DP020-SRC-AID)                   07820099
078300             SET ASC-ADD-FUNCTION-NOT-PRESSED                     07830099
078400                                   TO TRUE                        07840099
078500             IF PV-TOP-ITEM = 1                                   07850099
078600                 PERFORM 3000-EDIT-DATA-IN-COMMAREA               07860099
078700             END-IF                                               07870099
078800             PERFORM 2120-BROWSE-FORWARD                          07880099
078900             PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                 07890099
079000                                                                  07900099
079100         WHEN DP020-SRC-AID = DP016-ENTER                         07910099
079200             SET ASC-ADD-FUNCTION-NOT-PRESSED                     07920099
079300                                   TO TRUE                        07930099
079400             IF PV-TOP-ITEM = 1                                   07940099
079500                 PERFORM 3000-EDIT-DATA-IN-COMMAREA               07950099
079600             END-IF                                               07960099
079700             PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                 07970099
079800                                                                  07980099
079900         WHEN OTHER                                               07990099
080000             SET DP013-NO-ROLLBACK                                08000099
080100                 DP013-XCTL-DISPLAY-RESTART                       08010099
080200                 DP013-CICS-ABEND  TO TRUE                        08020099
080300             MOVE '2100-CHECK-FUNCTION-KEY'                       08030099
080400                                   TO DP013-PARAGRAPH             08040099
080500             MOVE 'INVALID FUNCTION KEY NOT CAPTURED BY API'      08050099
080600                                   TO DP013-MESSAGE-TEXT (1)      08060099
080700             PERFORM DP013-0000-PROCESS-ABEND                     08070099
080800     END-EVALUATE.                                                08080099
080900*                                                                 08090099
081000*----------------------------------------------------------------*08100099
081100*    IF THE USER HITS THE PAGE BACKWARD KEY, COMPUTE THE TOP     *08110099
081200*    ITEM NUMBER FOR THE NEW PAGE.  IF IT IS ABOVE THE TOP,      *08120099
081300*    SET THE TOP ITEM NUMBER TO +1 AND DISPLAY THE TOP OF LIST   *08130099
081400*    MESSAGE.                                                    *08140099
081500*----------------------------------------------------------------*08150099
081600                                                                  08160099
081700 2110-BROWSE-BACKWARD.                                            08170099
081800     SUBTRACT PC-ITEMS-PER-PANEL FROM ASC-ITEM-AT-TOP-OF-PANEL    08180099
081900         GIVING PV-TOP-ITEM.                                      08190099
082000*                                                                 08200099
082100     IF  ((PV-TOP-ITEM < +1)                                      08210099
082200       OR (PV-TOP-ITEM = +1))                                     08220099
082300         MOVE +1                   TO PV-TOP-ITEM                 08230099
082400*        -- TOP OF LIST --                                        08240099
082500         MOVE PC-TSYMSG-00069      TO DP020-MSG-NUMBER            08250099
082600         SET DP020-MSG-INFORMATIONAL TO TRUE                      08260099
082700     END-IF.                                                      08270099
082800                                                                  08280099
082900 EJECT                                                            08290099
083000*----------------------------------------------------------------*08300099
083100*    IF THE USER HITS THE PAGE FORWARD KEY, COMPUTE THE TOP      *08310099
083200*    ITEM NUMBER FOR THE NEW PAGE.  IF THE USER ATTEMPTS TO GO   *08320099
083300*    PAST THE END, ISSUE THE BOTTOM OF LIST MESSAGE.             *08330099
083400*----------------------------------------------------------------*08340099
083500                                                                  08350099
083600 2120-BROWSE-FORWARD.                                             08360099
083700                                                                  08370099
083800     ADD PC-ITEMS-PER-PANEL ASC-ITEM-AT-TOP-OF-PANEL              08380099
083900         GIVING PV-TOP-ITEM.                                      08390099
084000     IF  PV-TOP-ITEM > ASC-NUMBER-OF-ITEMS-READ                   08400099
084100         MOVE ASC-ITEM-AT-TOP-OF-PANEL                            08410099
084200                                   TO PV-TOP-ITEM                 08420099
084300*        -- BOTTOM OF LIST --                                     08430099
084400         MOVE PC-TSYMSG-00070      TO DP020-MSG-NUMBER            08440099
084500         SET DP020-MSG-INFORMATIONAL                              08450099
084600                                   TO TRUE                        08460099
084700     ELSE                                                         08470099
084800         COMPUTE PV-BOTTOM-ITEM =                                 08480099
084900             PV-TOP-ITEM + PC-ITEMS-PER-PANEL - 1                 08490099
085000         IF  PV-BOTTOM-ITEM > ASC-NUMBER-OF-ITEMS-READ            08500099
085100*            -- BOTTOM OF LIST --                                 08510099
085200             MOVE PC-TSYMSG-00070  TO DP020-MSG-NUMBER            08520099
085300             SET DP020-MSG-INFORMATIONAL                          08530099
085400                                   TO TRUE                        08540099
085500         END-IF                                                   08550099
085600     END-IF.                                                      08560099
085700 EJECT                                                            08570099
085800******************************************************************08580099
085900** MOVE ALL OF THE FIELDS THAT WERE ENTERED / CHANGED ON THE    **08590099
086000** SCREEN INTO THE COMMAREA.  ALL EDITTING IS DONE IN THE COMM. **08600099
086100******************************************************************08610099
086200 2200-MOVE-SCREEN-TO-COMMAREA.                                    08620099
086300                                                                  08630099
086400     MOVE PV-TOP-ITEM              TO PV-ITEM-IN-USE.             08640099
086500     MOVE +1                       TO PV-SUB.                     08650099
086600*                                                                 08660099
086700     PERFORM 3100-SET-SUBSCRIPTS.                                 08670099
086800     IF ASC-LIST-ITEM-NUMBER (ASC-BLK-SUB ASC-ITEM-SUB) = 1       08680099
086900         PERFORM 2210-MOVE-LINES-TO-COMMAREA                      08690099
087000             VARYING PV-COMMENT-SUB                               08700099
087100             FROM 1 BY 1                                          08710099
087200             UNTIL PV-COMMENT-SUB > 4                             08720099
087300     END-IF.                                                      08730099
087400******************************************************************08740099
087500** MOVE THE ENTERABLE FIELDS ON EACH LIST LINE INTO THE COMMAREA**08750099
087600******************************************************************08760099
087700 2210-MOVE-LINES-TO-COMMAREA.                                     08770099
087800                                                                  08780099
087900     IF MR-COMMENTL (1 PV-COMMENT-SUB) > ZERO                     08790099
088000         SET ASC-BLOCK-MODIFIED (ASC-BLK-SUB) TO TRUE             08800099
088100         MOVE MR-COMMENTI (1 PV-COMMENT-SUB)                      08810099
088200                               TO ASC-COMMENT-LINE                08820099
088300               (ASC-BLK-SUB ASC-ITEM-SUB PV-COMMENT-SUB)          08830099
088400     ELSE                                                         08840099
088500         IF MR-COMMENTA (1 PV-COMMENT-SUB) = DP015-ERASE-EOF      08850099
088600             SET ASC-BLOCK-MODIFIED (ASC-BLK-SUB) TO TRUE         08860099
088700             MOVE SPACE        TO ASC-COMMENT-LINE                08870099
088800               (ASC-BLK-SUB ASC-ITEM-SUB PV-COMMENT-SUB)          08880099
088900         END-IF                                                   08890099
089000     END-IF.                                                      08900099
089100                                                                  08910099
089200******************************************************************08920099
089300** EDIT ALL OF THE DATA ON THE SCREEN AS IT RESIDES IN THE      **08930099
089400** COMMAREA (EDITTING IS NOT DONE AGAINST THE SCREEN DIRECTLY). **08940099
089500** (ONLY THE FIRST COMMENT AREA IS EDITTED.)                    **08950099
089600******************************************************************08960099
089700 3000-EDIT-DATA-IN-COMMAREA.                                      08970099
089800     SET PS-NO-ERROR               TO TRUE.                       08980099
089900**                                                                08990099
090000* CALCULATE THE POSITION OF THE LAST ITEM DISPLAYED.              09000099
090100* EDITTING IS DONE FROM THE BOTTOM UP.                            09010099
090200**                                                                09020099
090300     COMPUTE PV-ITEM-IN-USE = PV-TOP-ITEM +                       09030099
090400         ASC-ITEMS-DISPLAYED - 1.                                 09040099
090500     PERFORM 3100-SET-SUBSCRIPTS.                                 09050099
090600     MOVE +1                       TO ASC-ITEM-SUB.               09060099
090700     PERFORM 3300-EDIT-SELECTIONS.                                09070099
090800*                                                                 09080099
090900 EJECT                                                            09090099
091000*----------------------------------------------------------------*09100099
091100*    DETERMINE THE VALUE OF THE ITEM SUBSCRIPT BASED ON THE ITEM *09110099
091200*    CURRENTLY IN USE AND THE FIRST ITEM IN THE ARRAY.  THIS WILL*09120099
091300*    POSITION US IN THE 1ST BLOCK OF THE ARRAY.                  *09130099
091400*                                                                *09140099
091500*    IF THE ITEM SUBSCRIPT EXCEEDS THE MAXIMUM NUMBER OF ITEMS   *09150099
091600*    IN A BLOCK, RECALCULATE THE SUBSCRIPT BY SUBTRACTING OUT    *09160099
091700*    THE MAXIMUM NUMBER OF ITEMS.  THIS WILL CORRECTLY POSITION  *09170099
091800*    US IN THE 2ND BLOCK OF THE ARRAY.                           *09180099
091900*----------------------------------------------------------------*09190099
092000                                                                  09200099
092100 3100-SET-SUBSCRIPTS.                                             09210099
092200                                                                  09220099
092300     COMPUTE ASC-ITEM-SUB =                                       09230099
092400         (PV-ITEM-IN-USE - ASC-LIST-ITEM-NUMBER(1 1)) + 1.        09240099
092500                                                                  09250099
092600     IF ASC-ITEM-SUB > PC-ITEMS-PER-PANEL                         09260099
092700         SUBTRACT PC-ITEMS-PER-PANEL FROM ASC-ITEM-SUB            09270099
092800                                                                  09280099
092900         MOVE PC-MAX-BLOCKS-IN-ARRAY TO ASC-BLK-SUB               09290099
093000     ELSE                                                         09300099
093100         MOVE +1                     TO ASC-BLK-SUB               09310099
093200     END-IF.                                                      09320099
093300******************************************************************09330099
093400** RESET THE ATTRIBUTES OF ALL ENTERABLE FIELDS ON THE MAP.     **09340099
093500******************************************************************09350099
093600                                                                  09360099
093700 3200-RESET-ATTRIBUTES.                                           09370099
093800*                                                                 09380099
093900     IF DP020-INT-APPL-FORMAT-IND = PC-ADD-FORMAT                 09390099
094000         IF PV-TOP-ITEM > PC-ITEMS-PER-PANEL                      09400099
094100             PERFORM                                              09410099
094200                 VARYING PV-COMMENT-SUB                           09420099
094300                 FROM 1 BY 1                                      09430099
094400                 UNTIL PV-COMMENT-SUB > 4                         09440099
094500                     MOVE DP015-PRO-NOR-OFF                       09450099
094600                                      TO MR-COMMENTA              09460099
094700                                      (1 PV-COMMENT-SUB)          09470099
094800                     MOVE DP015-BLUE  TO MR-COMMENTC              09480099
094900                                      (1 PV-COMMENT-SUB)          09490099
095000                     MOVE DP015-HL-OFF    TO MR-COMMENTH          09500099
095100                                      (1 PV-COMMENT-SUB)          09510099
095200             END-PERFORM                                          09520099
095300         ELSE                                                     09530099
095400             IF DP020-MSG-NUMBER = PC-TSYMSG-00005                09540099
095500                 PERFORM                                          09550099
095600                     VARYING PV-COMMENT-SUB                       09560099
095700                     FROM 1 BY 1                                  09570099
095800                     UNTIL PV-COMMENT-SUB > 4                     09580099
095900                         MOVE DP015-UNP-ALP-NOR-OFF               09590099
096000                                      TO MR-COMMENTA              09600099
096100                                      (1 PV-COMMENT-SUB)          09610099
096200                         MOVE DP015-RED                           09620099
096300                                      TO MR-COMMENTC              09630099
096400                                      (1 PV-COMMENT-SUB)          09640099
096500                         MOVE DP015-REVERSE                       09650099
096600                                      TO MR-COMMENTH              09660099
096700                                      (1 PV-COMMENT-SUB)          09670099
096800                 END-PERFORM                                      09680099
096900             ELSE                                                 09690099
097000                 PERFORM                                          09700099
097100                     VARYING PV-COMMENT-SUB                       09710099
097200                     FROM 1 BY 1                                  09720099
097300                     UNTIL PV-COMMENT-SUB > 4                     09730099
097400                         MOVE DP015-UNP-ALP-NOR-OFF               09740099
097500                                      TO MR-COMMENTA              09750099
097600                                      (1 PV-COMMENT-SUB)          09760099
097700                         MOVE DP015-GREEN TO MR-COMMENTC          09770099
097800                                      (1 PV-COMMENT-SUB)          09780099
097900                         MOVE DP015-UNDERLINE TO MR-COMMENTH      09790099
098000                                      (1 PV-COMMENT-SUB)          09800099
098100                 END-PERFORM                                      09810099
098200             END-IF                                               09820099
098300         END-IF                                                   09830099
098400     END-IF.                                                      09840099
098500                                                                  09850099
098600******************************************************************09860099
098700** EDIT THE COMMENTS ENTERED.                                   **09870099
098800******************************************************************09880099
098900 3300-EDIT-SELECTIONS.                                            09890099
099000                                                                  09900099
099100     MOVE ZERO                  TO PV-NUMBER-OF-BLANK-LINES.      09910099
099200     PERFORM                                                      09920099
099300         VARYING PV-SUB                                           09930099
099400         FROM 1 BY 1                                              09940099
099500         UNTIL PV-SUB > 4                                         09950099
099600             IF ASC-COMMENT-LINE (1 1 PV-SUB) = SPACES            09960099
099700                 ADD +1         TO PV-NUMBER-OF-BLANK-LINES       09970099
099800             END-IF                                               09980099
099900     END-PERFORM.                                                 09990099
100000                                                                  10000099
100100     IF (PV-NUMBER-OF-BLANK-LINES = 4) AND                        10010099
100200        (ASC-LIST-ITEM-NUMBER (ASC-BLK-SUB ASC-ITEM-SUB) = 1)     10020099
100300                                                                  10030099
100400         IF DP020-FK-NEXT-PAGE(DP020-SRC-AID) OR                  10040099
100500            DP020-SRC-AID = DP016-ENTER                           10050099
100600                                                                  10060099
100700             CONTINUE                                             10070099
100800         ELSE                                                     10080099
100900             SET PS-ERROR TO TRUE                                 10090099
101000*            --- INVALID MESSAGE ---                              10100099
101100             MOVE PC-TSYMSG-00005   TO DP020-MSG-NUMBER           10110099
101200             SET DP020-MSG-FATAL    TO TRUE                       10120099
101300         END-IF                                                   10130099
101400     ELSE                                                         10140099
101500         PERFORM 3330-REARRANGE-COMMENTS                          10150099
101600         PERFORM 5100-WRITE-TEMP-STORAGE                          10160099
101700         MOVE 1          TO ASC-BLK-SUB                           10170099
101800                            PV-BLOCK-NUMBER                       10180099
101900         PERFORM 4410-READ-TEMP-STORAGE                           10190099
102000     END-IF.                                                      10200099
102100*                                                                 10210099
102200******************************************************************10220099
102300** REARRANGES THE COMMENT LINES, SO THAT ALL OF THE ENTERED     **10230099
102400** DATA IS ONE LINE AFTER ANOTHER (NO EMPTY LINES IN BETWEEN).  **10240099
102500******************************************************************10250099
102600 3330-REARRANGE-COMMENTS.                                         10260099
102700                                                                  10270099
102800     PERFORM                                                      10280099
102900         VARYING PV-COMMENT-SUB                                   10290099
103000         FROM 1 BY 1                                              10300099
103100         UNTIL PV-COMMENT-SUB > 4                                 10310099
103200             MOVE SPACES     TO PV-COMMENT-LINE (PV-COMMENT-SUB)  10320099
103300     END-PERFORM.                                                 10330099
103400                                                                  10340099
103500     MOVE ZERO               TO PV-COMMENT-SUB.                   10350099
103600     PERFORM                                                      10360099
103700         VARYING PV-SUB                                           10370099
103800         FROM 1 BY 1                                              10380099
103900         UNTIL PV-SUB > 4                                         10390099
104000             IF ASC-COMMENT-LINE (1 1 PV-SUB) = SPACES            10400099
104100                 CONTINUE                                         10410099
104200             ELSE                                                 10420099
104300                 ADD +1      TO PV-COMMENT-SUB                    10430099
104400                 MOVE ASC-COMMENT-LINE (1 1 PV-SUB)               10440099
104500                             TO PV-COMMENT-LINE (PV-COMMENT-SUB)  10450099
104600             END-IF                                               10460099
104700     END-PERFORM.                                                 10470099
104800                                                                  10480099
104900     PERFORM                                                      10490099
105000         VARYING PV-COMMENT-SUB                                   10500099
105100         FROM 1 BY 1                                              10510099
105200         UNTIL PV-COMMENT-SUB > 4                                 10520099
105300             MOVE PV-COMMENT-LINE (PV-COMMENT-SUB)                10530099
105400                             TO ASC-COMMENT-LINE                  10540099
105500                                  (1 1 PV-COMMENT-SUB)            10550099
105600     END-PERFORM.                                                 10560099
105700*                                                                 10570099
105800*----------------------------------------------------------------*10580099
105900*    INITIALIZE BOTH BLOCKS IN THE ARRAY.                        *10590099
106000*    INITIALIZE ALL COUNTERS AND FLAGS.                          *10600099
106100*    READ THE DATA BASE FOR THE 1ST TIME AND FILL UP THE ARRAY.  *10610099
106200*    DISPLAY THE PANEL TO USER.                                  *10620099
106300*----------------------------------------------------------------*10630099
106400                                                                  10640099
106500 4000-BUILD-INITIAL-PANEL.                                        10650099
106600                                                                  10660099
106700     INITIALIZE                  ASC-BLOCK-ENTRIES (1)            10670099
106800                                 ASC-BLOCK-ENTRIES (2).           10680099
106900     MOVE +1                 TO ASC-BLK-SUB.                      10690099
107000     SET ASC-ITEMS-LEFT-ON-DB                                     10700099
107100                             TO TRUE.                             10710099
107200                                                                  10720099
107300     SET ASC-ADD-FUNCTION-NOT-PRESSED                             10730099
107400                             TO TRUE.                             10740099
107500     MOVE +0                 TO ASC-ITEM-SUB                      10750099
107600                                ASC-NUMBER-OF-ITEMS-READ          10760099
107700                                ASC-HIGHEST-BLOCK-WRITTEN         10770099
107800                                ASC-ITEM-AT-TOP-OF-PANEL.         10780099
107900                                                                  10790099
108000     PERFORM 4100-PREPARE-CURSOR.                                 10800099
108100                                                                  10810099
108200     PERFORM 4010-OPEN-CURSOR.                                    10820099
108300                                                                  10830099
108400     MOVE SPACES              TO PV-COMMENT-LINE (1)              10840099
108500                                 PV-COMMENT-LINE (2)              10850099
108600                                 PV-COMMENT-LINE (3)              10860099
108700                                 PV-COMMENT-LINE (4).             10870099
108800     MOVE ZERO                TO SVT00003-CMNT-SEQ-NBR.           10880099
108900     SET PS-COMMENT-ROW-FOUND TO TRUE.                            10890099
109000     SET PS-SAME-COMMENT      TO TRUE.                            10900099
109100                                                                  10910000
109200     PERFORM 4310-FETCH                                           10920099
109300         VARYING PV-COMMENT-SUB                                   10930099
109400         FROM 1 BY 1                                              10940099
109500         UNTIL PS-COMMENT-ROW-NOT-FOUND                           10950099
109600            OR PS-DIFFERENT-COMMENT.                              10960099
109700                                                                  10970099
109800     PERFORM 4300-READ-ITEMS-FROM-DB.                             10980099
109900                                                                  10990099
110000     PERFORM 4020-CLOSE-CURSOR.                                   11000099
110100                                                                  11010099
110200     MOVE +1                   TO  PV-TOP-ITEM.                   11020099
110300     IF  ASC-NUMBER-OF-ITEMS-READ = ZERO                          11030099
110400         SET DP020-NEXT-ACT-APPL-ERROR TO TRUE                    11040099
110500         SET DP020-MSG-FATAL   TO  TRUE                           11050099
110600         MOVE PC-TSYMSG-00050  TO  DP020-MSG-NUMBER               11060099
110700     ELSE                                                         11070099
110800         PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                     11080099
110900     END-IF.                                                      11090099
111000*                                                                 11100099
111100*----------------------------------------------------------------*11110099
111200*    INITIALIZE BOTH BLOCKS IN THE ARRAY.                        *11120099
111300*    INITIALIZE ALL COUNTERS AND FLAGS.                          *11130099
111400*    READ THE DATA BASE FOR THE 1ST TIME AND FILL UP THE ARRAY.  *11140099
111500*    DISPLAY THE PANEL TO USER.                                  *11150099
111600*----------------------------------------------------------------*11160099
111700 4005-BUILD-INITIAL-HIST.                                         11170099
111800                                                                  11180099
111900     INITIALIZE                  ASC-BLOCK-ENTRIES (1)            11190099
112000                                 ASC-BLOCK-ENTRIES (2).           11200099
112100     MOVE +1                 TO ASC-BLK-SUB.                      11210099
112200     SET ASC-ITEMS-LEFT-ON-DB                                     11220099
112300                             TO TRUE.                             11230099
112400                                                                  11240099
112500     SET ASC-ADD-FUNCTION-NOT-PRESSED                             11250099
112600                             TO TRUE.                             11260099
112700     MOVE +0                 TO ASC-ITEM-SUB                      11270099
112800                                ASC-NUMBER-OF-ITEMS-READ          11280099
112900                                ASC-HIGHEST-BLOCK-WRITTEN         11290099
113000                                ASC-ITEM-AT-TOP-OF-PANEL.         11300099
113100                                                                  11310099
113200     PERFORM 4100-PREPARE-CURSOR.                                 11320099
113300                                                                  11330099
113400     PERFORM 4015-OPEN-CURSOR-HIST.                               11340099
113500                                                                  11350099
113600     MOVE SPACES              TO PV-COMMENT-LINE (1)              11360099
113700                                 PV-COMMENT-LINE (2)              11370099
113800                                 PV-COMMENT-LINE (3)              11380099
113900                                 PV-COMMENT-LINE (4).             11390099
114000     MOVE ZERO                TO SVT00007-CMNT-SEQ-NBR.           11400099
114100     SET PS-COMMENT-ROW-FOUND TO TRUE.                            11410099
114200     SET PS-SAME-COMMENT      TO TRUE.                            11420099
114300                                                                  11430000
114400     PERFORM 4315-FETCH-HIST                                      11440099
114500         VARYING PV-COMMENT-SUB                                   11450099
114600         FROM 1 BY 1                                              11460099
114700         UNTIL PS-COMMENT-ROW-NOT-FOUND                           11470099
114800            OR PS-DIFFERENT-COMMENT.                              11480099
114900                                                                  11490099
115000     PERFORM 4305-READ-ITEMS-HIST-DB.                             11500000
115100                                                                  11510099
115200     PERFORM 4025-CLOSE-CURSOR-HIST.                              11520099
115300                                                                  11530099
115400     MOVE +1                   TO  PV-TOP-ITEM.                   11540099
115500     IF  ASC-NUMBER-OF-ITEMS-READ = ZERO                          11550099
115600         SET DP020-NEXT-ACT-APPL-ERROR TO TRUE                    11560099
115700         SET DP020-MSG-FATAL   TO  TRUE                           11570099
115800         MOVE PC-TSYMSG-00050  TO  DP020-MSG-NUMBER               11580099
115900     ELSE                                                         11590099
116000         PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                     11600099
116100     END-IF.                                                      11610099
116200 EJECT                                                            11620099
116300*----------------------------------------------------------------*11630099
116400* OPEN THE COMMENT CURSOR.                                       *11640099
116500*----------------------------------------------------------------*11650099
116600                                                                  11660099
116700 4010-OPEN-CURSOR.                                                11670099
116800     PERFORM                                                      11680099
116900         WITH TEST AFTER                                          11690099
117000         VARYING PV-RETRY-COUNTER                                 11700099
117100         FROM 1 BY 1                                              11710099
117200         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               11720099
117300                   OR (SQLCODE = ZERO))                           11730099
117400                                                                  11740099
117500         EXEC SQL                                                 11750099
117600              OPEN COMMENT-CSR                                    11760099
117700         END-EXEC                                                 11770099
117800                                                                  11780099
117900         EVALUATE TRUE                                            11790099
118000             WHEN SQLCODE = ZERO                                  11800099
118100             WHEN SQLCODE = -904                                  11810099
118200             WHEN SQLCODE = -913                                  11820099
118300                 CONTINUE                                         11830099
118400             WHEN SQLWARN0 NOT = SPACES                           11840099
118500             WHEN SQLCODE < ZERO                                  11850099
118600             WHEN SQLCODE > ZERO                                  11860099
118700                 MOVE '4010-OPEN-CURSOR'                          11870099
118800                                   TO DP013-PARAGRAPH             11880099
118900                 MOVE 'OPEN COMMENT LINE CURSOR     '             11890099
119000                                   TO DP013-MESSAGE-TEXT (1)      11900099
119100                 MOVE SQLCA        TO DP013-SQLCA                 11910099
119200                 MOVE 'SVT_CRD_ACCT_CMMT '                        11920099
119300                                   TO DP013-DB2-TABLE-NAME (1)    11930099
119400                 SET DP013-DB2-ABEND                              11940099
119500                     DP013-XCTL-DISPLAY-RESTART TO TRUE           11950099
119600                 PERFORM DP013-0000-PROCESS-ABEND                 11960099
119700         END-EVALUATE                                             11970099
119800     END-PERFORM.                                                 11980099
119900*                                                                 11990099
120000     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        12000099
120100         MOVE '4010-OPEN-CURSOR'   TO DP013-PARAGRAPH             12010099
120200         MOVE 'MAXIMUM RETRIES EXCEEDED ATTEMPTING TO OPEN CSR'   12020099
120300                                   TO DP013-MESSAGE-TEXT (1)      12030099
120400         MOVE SQLCA                TO DP013-SQLCA                 12040099
120500         MOVE 'SVT_CRD_ACCT_CMMT ' TO DP013-DB2-TABLE-NAME (1)    12050099
120600         SET DP013-DB2-ABEND                                      12060099
120700             DP013-XCTL-DISPLAY-RESTART                           12070099
120800                                   TO TRUE                        12080099
120900         PERFORM DP013-0000-PROCESS-ABEND                         12090099
121000     END-IF.                                                      12100099
121100                                                                  12110099
121200*----------------------------------------------------------------*12120099
121300* OPEN THE HISTORY COMMENT CURSOR.                               *12130099
121400*----------------------------------------------------------------*12140099
121500                                                                  12150099
121600 4015-OPEN-CURSOR-HIST.                                           12160099
121700     PERFORM                                                      12170099
121800         WITH TEST AFTER                                          12180099
121900         VARYING PV-RETRY-COUNTER                                 12190099
122000         FROM 1 BY 1                                              12200099
122100         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               12210099
122200                   OR (SQLCODE = ZERO))                           12220099
122300                                                                  12230099
122400         EXEC SQL                                                 12240099
122500              OPEN COMMENT-CSR-HIST                               12250099
122600         END-EXEC                                                 12260099
122700                                                                  12270099
122800         EVALUATE TRUE                                            12280099
122900             WHEN SQLCODE = ZERO                                  12290099
123000             WHEN SQLCODE = -904                                  12300099
123100             WHEN SQLCODE = -913                                  12310099
123200                 CONTINUE                                         12320099
123300             WHEN SQLWARN0 NOT = SPACES                           12330099
123400             WHEN SQLCODE < ZERO                                  12340099
123500             WHEN SQLCODE > ZERO                                  12350099
123600                 MOVE '4015-OPEN-CURSOR-HIST'                     12360099
123700                                   TO DP013-PARAGRAPH             12370099
123800                 MOVE 'OPEN COMMENT LINE CURSOR     '             12380099
123900                                   TO DP013-MESSAGE-TEXT (1)      12390099
124000                 MOVE SQLCA        TO DP013-SQLCA                 12400099
124100                 MOVE 'SVT_CRD_CMMT_HIST '                        12410099
124200                                   TO DP013-DB2-TABLE-NAME (1)    12420099
124300                 SET DP013-DB2-ABEND                              12430099
124400                     DP013-XCTL-DISPLAY-RESTART TO TRUE           12440099
124500                 PERFORM DP013-0000-PROCESS-ABEND                 12450099
124600         END-EVALUATE                                             12460099
124700     END-PERFORM.                                                 12470099
124800*                                                                 12480099
124900     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        12490099
125000         MOVE '4010-OPEN-CURSOR-HIST'   TO DP013-PARAGRAPH        12500099
125100         MOVE 'MAXIMUM RETRIES EXCEEDED ATTEMPTING TO OPEN CSR'   12510099
125200                                   TO DP013-MESSAGE-TEXT (1)      12520099
125300         MOVE SQLCA                TO DP013-SQLCA                 12530099
125400         MOVE 'SVT_CRD_CMMT_HIST ' TO DP013-DB2-TABLE-NAME (1)    12540099
125500         SET DP013-DB2-ABEND                                      12550099
125600             DP013-XCTL-DISPLAY-RESTART                           12560099
125700                                   TO TRUE                        12570099
125800         PERFORM DP013-0000-PROCESS-ABEND                         12580099
125900     END-IF.                                                      12590099
126000                                                                  12600099
126100 EJECT                                                            12610099
126200*----------------------------------------------------------------*12620099
126300* CLOSE THE COMMENT CURSOR.                                      *12630099
126400*----------------------------------------------------------------*12640099
126500                                                                  12650099
126600 4020-CLOSE-CURSOR.                                               12660099
126700                                                                  12670099
126800     EXEC SQL                                                     12680099
126900         CLOSE COMMENT-CSR                                        12690099
127000     END-EXEC.                                                    12700099
127100*                                                                 12710099
127200     EVALUATE TRUE                                                12720099
127300         WHEN SQLCODE = ZERO                                      12730099
127400             CONTINUE                                             12740099
127500         WHEN SQLWARN0 NOT = SPACES                               12750099
127600         WHEN SQLCODE < ZERO                                      12760099
127700         WHEN SQLCODE > ZERO                                      12770099
127800             MOVE '4020-CLOSE-CURSOR'                             12780099
127900                               TO DP013-PARAGRAPH                 12790099
128000             MOVE 'CLOSE COMMENT LINE CURSOR   '                  12800099
128100                               TO DP013-MESSAGE-TEXT (1)          12810099
128200             MOVE SQLCA        TO DP013-SQLCA                     12820099
128300             MOVE 'SVT_CRD_ACCT_CMMT ' TO DP013-DB2-TABLE-NAME (1)12830099
128400             SET DP013-DB2-ABEND                                  12840099
128500                 DP013-XCTL-DISPLAY-RESTART TO TRUE               12850099
128600             PERFORM DP013-0000-PROCESS-ABEND                     12860099
128700     END-EVALUATE.                                                12870099
128800                                                                  12880099
128900*----------------------------------------------------------------*12890099
129000* CLOSE THE HISTORY COMMENT CURSOR.                              *12900099
129100*----------------------------------------------------------------*12910099
129200                                                                  12920099
129300 4025-CLOSE-CURSOR-HIST.                                          12930099
129400                                                                  12940099
129500     EXEC SQL                                                     12950099
129600         CLOSE COMMENT-CSR-HIST                                   12960099
129700     END-EXEC.                                                    12970099
129800*                                                                 12980099
129900     EVALUATE TRUE                                                12990099
130000         WHEN SQLCODE = ZERO                                      13000099
130100             CONTINUE                                             13010099
130200         WHEN SQLWARN0 NOT = SPACES                               13020099
130300         WHEN SQLCODE < ZERO                                      13030099
130400         WHEN SQLCODE > ZERO                                      13040099
130500             MOVE '4025-CLOSE-CURSOR-HIST'                        13050099
130600                               TO DP013-PARAGRAPH                 13060099
130700             MOVE 'CLOSE COMMENT LINE CURSOR   '                  13070099
130800                               TO DP013-MESSAGE-TEXT (1)          13080099
130900             MOVE SQLCA        TO DP013-SQLCA                     13090099
131000             MOVE 'SVT_CRD_CMMT_HIST ' TO DP013-DB2-TABLE-NAME (1)13100099
131100             SET DP013-DB2-ABEND                                  13110099
131200                 DP013-XCTL-DISPLAY-RESTART TO TRUE               13120099
131300             PERFORM DP013-0000-PROCESS-ABEND                     13130099
131400     END-EVALUATE.                                                13140099
131500                                                                  13150099
131600 EJECT                                                            13160099
131700*----------------------------------------------------------------*13170099
131800*    SET UP THE HOST VARIABLES.                                  *13180099
131900*----------------------------------------------------------------*13190099
132000                                                                  13200099
132100 4100-PREPARE-CURSOR.                                             13210099
132200                                                                  13220099
132300     MOVE ASC-SHORT-CARD-ID    TO DK-CARD-ID.                     13230099
132400                                                                  13240099
132500 EJECT                                                            13250099
132600*----------------------------------------------------------------*13260099
132700*    READ THE ITEMS FROM THE DATA BASE AND MOVE THEM INTO THE    *13270099
132800*    BLOCKS IN THE ARRAY.  WHENEVER BOTH BLOCKS BECOME FULL,     *13280099
132900*    WRITE OUT THE 1ST BLOCK TO TEMPORARY STORAGE, MOVE THE 2ND  *13290099
133000*    BLOCK IN THE ARRAY TO THE 1ST BLOCK, AND INITIALIZE THE     *13300099
133100*    2ND BLOCK MAKING IT AVAILABLE TO BE USED.                   *13310099
133200*----------------------------------------------------------------*13320099
133300                                                                  13330099
133400 4300-READ-ITEMS-FROM-DB.                                         13340099
133500                                                                  13350099
133600     PERFORM                                                      13360099
133700         VARYING PV-READ-COUNT                                    13370099
133800         FROM 1 BY 1                                              13380099
133900         UNTIL ((PV-READ-COUNT > PC-MAX-ITEMS)                    13390099
134000            OR (ASC-NO-ITEMS-LEFT-ON-DB))                         13400099
134100                                                                  13410099
134200         IF  ASC-ITEMS-LEFT-ON-DB                                 13420099
134300             IF  ASC-ITEM-SUB < PC-ITEMS-PER-PANEL                13430099
134400                 ADD +1            TO ASC-ITEM-SUB                13440099
134500             ELSE                                                 13450099
134600                 ADD +1            TO ASC-BLK-SUB                 13460099
134700                 MOVE +1           TO ASC-ITEM-SUB                13470099
134800                                                                  13480099
134900                 IF  ASC-BLK-SUB > PC-MAX-BLOCKS-IN-ARRAY         13490099
135000                     MOVE +1       TO ASC-BLK-SUB                 13500099
135100                     SET ASC-BLOCK-MODIFIED (1)                   13510099
135200                                   TO TRUE                        13520099
135300                     PERFORM 5100-WRITE-TEMP-STORAGE              13530099
135400                     MOVE ASC-BLOCK-ENTRIES                       13540099
135500                               (PC-MAX-BLOCKS-IN-ARRAY)           13550099
135600                                TO ASC-BLOCK-ENTRIES(ASC-BLK-SUB) 13560099
135700                     ADD +1        TO ASC-BLK-SUB                 13570099
135800                     INITIALIZE ASC-BLOCK-ENTRIES (ASC-BLK-SUB)   13580099
135900                     SET ASC-BLOCK-NOT-MODIFIED(ASC-BLK-SUB)      13590099
136000                                   TO TRUE                        13600099
136100                 END-IF                                           13610099
136200             END-IF                                               13620099
136300             IF (DP020-INT-APPL-FORMAT-IND = PC-ADD-FORMAT)       13630099
136400                AND (ASC-BLK-SUB = 1) AND (ASC-ITEM-SUB = 1)      13640099
136500                 ADD +1            TO ASC-NUMBER-OF-ITEMS-READ    13650099
136600                 MOVE ASC-NUMBER-OF-ITEMS-READ                    13660099
136700                                   TO ASC-LIST-ITEM-NUMBER        13670099
136800                                      (ASC-BLK-SUB ASC-ITEM-SUB)  13680099
136900                 MOVE SPACES       TO ASC-TRANS-TIMESTAMP         13690099
137000                                      (ASC-BLK-SUB ASC-ITEM-SUB)  13700099
137100                 MOVE DP020-USERID TO ASC-USERID                  13710099
137200                                      (ASC-BLK-SUB ASC-ITEM-SUB)  13720099
137300                 PERFORM                                          13730099
137400                     VARYING PV-COMMENT-SUB                       13740099
137500                     FROM 1 BY 1                                  13750099
137600                     UNTIL PV-COMMENT-SUB > 4                     13760099
137700                         MOVE SPACES   TO ASC-COMMENT-LINE        13770099
137800                        (ASC-BLK-SUB ASC-ITEM-SUB PV-COMMENT-SUB) 13780099
137900                 END-PERFORM                                      13790099
138000                 ADD +1            TO ASC-ITEM-SUB                13800099
138100             END-IF                                               13810099
138200             IF PV-HOLD-COMMENT-TMST = SPACES                     13820099
138300                 CONTINUE                                         13830099
138400             ELSE                                                 13840099
138500                 ADD +1            TO ASC-NUMBER-OF-ITEMS-READ    13850099
138600                 MOVE ASC-NUMBER-OF-ITEMS-READ                    13860099
138700                                   TO ASC-LIST-ITEM-NUMBER        13870099
138800                                      (ASC-BLK-SUB ASC-ITEM-SUB)  13880099
138900                 MOVE PV-HOLD-CMMT-TMST-MM                        13890099
139000                                   TO PV-TRANS-TMST-MM            13900099
139100                 MOVE PV-HOLD-CMMT-TMST-DD                        13910099
139200                                   TO PV-TRANS-TMST-DD            13920099
139300                 MOVE PV-HOLD-CMMT-TMST-YY                        13930099
139400                                   TO PV-TRANS-TMST-YY            13940099
139500                 MOVE PV-HOLD-CMMT-TMST-HH                        13950099
139600                                   TO PV-TRANS-TMST-HH            13960099
139700                 MOVE PV-HOLD-CMMT-TMST-MIN                       13970099
139800                                   TO PV-TRANS-TMST-MIN           13980099
139900                 MOVE PV-HOLD-CMMT-TMST-SS                        13990099
140000                                   TO PV-TRANS-TMST-SS            14000099
140100                 MOVE PV-TRANS-TIMESTAMP                          14010099
140200                                   TO ASC-TRANS-TIMESTAMP         14020099
140300                                       (ASC-BLK-SUB ASC-ITEM-SUB) 14030099
140400                 MOVE PV-HOLD-USERID                              14040099
140500                                   TO ASC-USERID                  14050099
140600                                       (ASC-BLK-SUB ASC-ITEM-SUB) 14060099
140700                 PERFORM                                          14070099
140800                     VARYING PV-COMMENT-SUB                       14080099
140900                     FROM 1 BY 1                                  14090099
141000                     UNTIL PV-COMMENT-SUB > 4                     14100099
141100                         MOVE PV-COMMENT-LINE (PV-COMMENT-SUB)    14110099
141200                                       TO ASC-COMMENT-LINE        14120099
141300                      (ASC-BLK-SUB ASC-ITEM-SUB PV-COMMENT-SUB)   14130099
141400                 END-PERFORM                                      14140099
141500             END-IF                                               14150099
141600         END-IF                                                   14160099
141700                                                                  14170099
141800         MOVE SPACES TO PV-COMMENT-LINE (1)                       14180099
141900                        PV-COMMENT-LINE (2)                       14190099
142000                        PV-COMMENT-LINE (3)                       14200099
142100                        PV-COMMENT-LINE (4)                       14210099
142200                                                                  14220099
142300         SET PS-SAME-COMMENT      TO TRUE                         14230099
142400         IF PS-COMMENT-ROW-FOUND                                  14240099
142500             PERFORM 4310-FETCH                                   14250099
142600                 VARYING PV-COMMENT-SUB                           14260099
142700                 FROM 2 BY 1                                      14270099
142800                 UNTIL PS-COMMENT-ROW-NOT-FOUND                   14280099
142900                    OR PS-DIFFERENT-COMMENT                       14290099
143000         ELSE                                                     14300099
143100             SET ASC-NO-ITEMS-LEFT-ON-DB TO TRUE                  14310099
143200         END-IF                                                   14320099
143300                                                                  14330099
143400     END-PERFORM.                                                 14340099
143500                                                                  14350099
143600     IF  ASC-NUMBER-OF-ITEMS-READ > ZERO                          14360099
143700         MOVE +1               TO ASC-BLK-SUB                     14370099
143800         PERFORM 5100-WRITE-TEMP-STORAGE                          14380099
143900         ADD +1                TO ASC-BLK-SUB                     14390099
144000         PERFORM 5100-WRITE-TEMP-STORAGE                          14400099
144100                                                                  14410099
144200         MOVE 1                TO ASC-BLK-SUB                     14420099
144300                                  PV-BLOCK-NUMBER                 14430099
144400         PERFORM 4410-READ-TEMP-STORAGE                           14440099
144500         IF  ASC-HIGHEST-BLOCK-WRITTEN GREATER THAN 1             14450099
144600             MOVE 2            TO ASC-BLK-SUB                     14460099
144700                                  PV-BLOCK-NUMBER                 14470099
144800             PERFORM 4410-READ-TEMP-STORAGE                       14480099
144900         END-IF                                                   14490099
145000     END-IF.                                                      14500099
145100*----------------------------------------------------------------*14510099
145200*    READ THE ITEMS FROM THE DATA BASE AND MOVE THEM INTO THE    *14520099
145300*    BLOCKS IN THE ARRAY.  WHENEVER BOTH BLOCKS BECOME FULL,     *14530099
145400*    WRITE OUT THE 1ST BLOCK TO TEMPORARY STORAGE, MOVE THE 2ND  *14540099
145500*    BLOCK IN THE ARRAY TO THE 1ST BLOCK, AND INITIALIZE THE     *14550099
145600*    2ND BLOCK MAKING IT AVAILABLE TO BE USED.                   *14560099
145700*----------------------------------------------------------------*14570099
145800 4305-READ-ITEMS-HIST-DB.                                         14580099
145900                                                                  14590099
146000     PERFORM                                                      14600099
146100         VARYING PV-READ-COUNT                                    14610099
146200         FROM 1 BY 1                                              14620099
146300         UNTIL ((PV-READ-COUNT > PC-MAX-ITEMS)                    14630099
146400            OR (ASC-NO-ITEMS-LEFT-ON-DB))                         14640099
146500                                                                  14650099
146600         IF  ASC-ITEMS-LEFT-ON-DB                                 14660099
146700             IF  ASC-ITEM-SUB < PC-ITEMS-PER-PANEL                14670099
146800                 ADD +1            TO ASC-ITEM-SUB                14680099
146900             ELSE                                                 14690099
147000                 ADD +1            TO ASC-BLK-SUB                 14700099
147100                 MOVE +1           TO ASC-ITEM-SUB                14710099
147200                                                                  14720099
147300                 IF  ASC-BLK-SUB > PC-MAX-BLOCKS-IN-ARRAY         14730099
147400                     MOVE +1       TO ASC-BLK-SUB                 14740099
147500                     SET ASC-BLOCK-MODIFIED (1)                   14750099
147600                                   TO TRUE                        14760099
147700                     PERFORM 5100-WRITE-TEMP-STORAGE              14770099
147800                     MOVE ASC-BLOCK-ENTRIES                       14780099
147900                               (PC-MAX-BLOCKS-IN-ARRAY)           14790099
148000                                TO ASC-BLOCK-ENTRIES(ASC-BLK-SUB) 14800099
148100                     ADD +1        TO ASC-BLK-SUB                 14810099
148200                     INITIALIZE ASC-BLOCK-ENTRIES (ASC-BLK-SUB)   14820099
148300                     SET ASC-BLOCK-NOT-MODIFIED(ASC-BLK-SUB)      14830099
148400                                   TO TRUE                        14840099
148500                 END-IF                                           14850099
148600             END-IF                                               14860099
148700             IF (DP020-INT-APPL-FORMAT-IND = PC-ADD-FORMAT)       14870099
148800                AND (ASC-BLK-SUB = 1) AND (ASC-ITEM-SUB = 1)      14880099
148900                 ADD +1            TO ASC-NUMBER-OF-ITEMS-READ    14890099
149000                 MOVE ASC-NUMBER-OF-ITEMS-READ                    14900099
149100                                   TO ASC-LIST-ITEM-NUMBER        14910099
149200                                      (ASC-BLK-SUB ASC-ITEM-SUB)  14920099
149300                 MOVE SPACES       TO ASC-TRANS-TIMESTAMP         14930099
149400                                      (ASC-BLK-SUB ASC-ITEM-SUB)  14940099
149500                 MOVE DP020-USERID TO ASC-USERID                  14950099
149600                                      (ASC-BLK-SUB ASC-ITEM-SUB)  14960099
149700                 PERFORM                                          14970099
149800                     VARYING PV-COMMENT-SUB                       14980099
149900                     FROM 1 BY 1                                  14990099
150000                     UNTIL PV-COMMENT-SUB > 4                     15000099
150100                         MOVE SPACES   TO ASC-COMMENT-LINE        15010099
150200                        (ASC-BLK-SUB ASC-ITEM-SUB PV-COMMENT-SUB) 15020099
150300                 END-PERFORM                                      15030099
150400                 ADD +1            TO ASC-ITEM-SUB                15040099
150500             END-IF                                               15050099
150600             IF PV-HOLD-COMMENT-TMST = SPACES                     15060099
150700                 CONTINUE                                         15070099
150800             ELSE                                                 15080099
150900                 ADD +1            TO ASC-NUMBER-OF-ITEMS-READ    15090099
151000                 MOVE ASC-NUMBER-OF-ITEMS-READ                    15100099
151100                                   TO ASC-LIST-ITEM-NUMBER        15110099
151200                                      (ASC-BLK-SUB ASC-ITEM-SUB)  15120099
151300                 MOVE PV-HOLD-CMMT-TMST-MM                        15130099
151400                                   TO PV-TRANS-TMST-MM            15140099
151500                 MOVE PV-HOLD-CMMT-TMST-DD                        15150099
151600                                   TO PV-TRANS-TMST-DD            15160099
151700                 MOVE PV-HOLD-CMMT-TMST-YY                        15170099
151800                                   TO PV-TRANS-TMST-YY            15180099
151900                 MOVE PV-HOLD-CMMT-TMST-HH                        15190099
152000                                   TO PV-TRANS-TMST-HH            15200099
152100                 MOVE PV-HOLD-CMMT-TMST-MIN                       15210099
152200                                   TO PV-TRANS-TMST-MIN           15220099
152300                 MOVE PV-HOLD-CMMT-TMST-SS                        15230099
152400                                   TO PV-TRANS-TMST-SS            15240099
152500                 MOVE PV-TRANS-TIMESTAMP                          15250099
152600                                   TO ASC-TRANS-TIMESTAMP         15260099
152700                                       (ASC-BLK-SUB ASC-ITEM-SUB) 15270099
152800                 MOVE PV-HOLD-USERID                              15280099
152900                                   TO ASC-USERID                  15290099
153000                                       (ASC-BLK-SUB ASC-ITEM-SUB) 15300099
153100                 PERFORM                                          15310099
153200                     VARYING PV-COMMENT-SUB                       15320099
153300                     FROM 1 BY 1                                  15330099
153400                     UNTIL PV-COMMENT-SUB > 4                     15340099
153500                         MOVE PV-COMMENT-LINE (PV-COMMENT-SUB)    15350099
153600                                       TO ASC-COMMENT-LINE        15360099
153700                      (ASC-BLK-SUB ASC-ITEM-SUB PV-COMMENT-SUB)   15370099
153800                 END-PERFORM                                      15380099
153900             END-IF                                               15390099
154000         END-IF                                                   15400099
154100                                                                  15410099
154200         MOVE SPACES TO PV-COMMENT-LINE (1)                       15420099
154300                        PV-COMMENT-LINE (2)                       15430099
154400                        PV-COMMENT-LINE (3)                       15440099
154500                        PV-COMMENT-LINE (4)                       15450099
154600                                                                  15460099
154700         SET PS-SAME-COMMENT      TO TRUE                         15470099
154800         IF PS-COMMENT-ROW-FOUND                                  15480099
154900             PERFORM 4315-FETCH-HIST                              15490099
155000                 VARYING PV-COMMENT-SUB                           15500099
155100                 FROM 2 BY 1                                      15510099
155200                 UNTIL PS-COMMENT-ROW-NOT-FOUND                   15520099
155300                    OR PS-DIFFERENT-COMMENT                       15530099
155400         ELSE                                                     15540099
155500             SET ASC-NO-ITEMS-LEFT-ON-DB TO TRUE                  15550099
155600         END-IF                                                   15560099
155700                                                                  15570099
155800     END-PERFORM.                                                 15580099
155900                                                                  15590099
156000     IF  ASC-NUMBER-OF-ITEMS-READ > ZERO                          15600099
156100         MOVE +1               TO ASC-BLK-SUB                     15610099
156200         PERFORM 5100-WRITE-TEMP-STORAGE                          15620099
156300         ADD +1                TO ASC-BLK-SUB                     15630099
156400         PERFORM 5100-WRITE-TEMP-STORAGE                          15640099
156500                                                                  15650099
156600         MOVE 1                TO ASC-BLK-SUB                     15660099
156700                                  PV-BLOCK-NUMBER                 15670099
156800         PERFORM 4410-READ-TEMP-STORAGE                           15680099
156900         IF  ASC-HIGHEST-BLOCK-WRITTEN GREATER THAN 1             15690099
157000             MOVE 2            TO ASC-BLK-SUB                     15700099
157100                                  PV-BLOCK-NUMBER                 15710099
157200             PERFORM 4410-READ-TEMP-STORAGE                       15720099
157300         END-IF                                                   15730099
157400     END-IF.                                                      15740099
157500 EJECT                                                            15750099
157600*----------------------------------------------------------------*15760099
157700* 4310-FETCH                                                     *15770099
157800*   A COMMENT MAY HAVE UP TO FOUR ROWS ON THE TKMCCOM TABLE.     *15780099
157900*   EACH PERFORMANCE OF THIS PARAGRAPH GETS ALL OF THE ROWS      *15790099
158000*   ASSOCIATED WITH THE SAME COMMENT, PLUS THE FIRST ROW OF THE  *15800099
158100*   NEXT COMMENT, IF THERE IS ONE.  THE ORDER OF THE COMMENT     *15810099
158200*   ROWS IS KEPT BY THE TIMESTAMP AND THE KMCCOM-CMNT-SEQ-NBR    *15820099
158300*   FIELD, WHICH RANGES IN VALUE FROM ONE TO FOUR.               *15830099
158400*                                                                *15840099
158500*   THE FIRST FETCH RETRIEVES THE MOST CURRENT COMMENT AND THE   *15850099
158600*   FIRST SEQUENCE NUMBER OF THAT COMMENT.  THE NEXT TIME        *15860099
158700*   THROUGH, BEFORE THE FETCH IS CALLED TO GET ANOTHER ROW, THE  *15870099
158800*   PREVIOUS ROW IS MOVED TO WORKING STORAGE FIELDS.  ALL THE    *15880099
158900*   OTHER ROWS ASSOCIATED WITH THE SAME COMMENT ARE MOVED TO     *15890099
159000*   WORKING STORAGE WITHIN THE SQLCODE LOGIC.                    *15900099
159100*----------------------------------------------------------------*15910099
159200                                                                  15920099
159300 4310-FETCH.                                                      15930099
159400                                                                  15940099
159500     IF SVT00003-CMNT-SEQ-NBR = 1                                 15950099
159600         MOVE SVT00003-CMNT-TXT                                   15960099
159700                          TO PV-COMMENT-LINE (1)                  15970099
159800         MOVE SVT00003-CRE-TMST                                   15980099
159900                          TO PV-HOLD-COMMENT-TMST                 15990099
160000         MOVE SVT00003-CRE-BY-USR-ID                              16000099
160100                          TO PV-HOLD-USERID                       16010099
160200     END-IF.                                                      16020099
160300                                                                  16030099
160400     EXEC SQL                                                     16040099
160500          FETCH COMMENT-CSR                                       16050099
160600           INTO                                                   16060099
160700                :SVT00003-CRE-TMST                                16070099
160800              , :SVT00003-CMNT-SEQ-NBR                            16080099
160900              , :SVT00003-CMNT-TXT                                16090099
161000              , :SVT00003-CRE-BY-USR-ID                           16100099
161100     END-EXEC.                                                    16110099
161200                                                                  16120099
161300     EVALUATE TRUE                                                16130099
161400         WHEN SQLCODE = ZERO                                      16140099
161500              IF SVT00003-CRE-TMST = PV-HOLD-COMMENT-TMST         16150099
161600                  MOVE SVT00003-CMNT-TXT                          16160099
161700                          TO PV-COMMENT-LINE (PV-COMMENT-SUB)     16170099
161800              ELSE                                                16180099
161900                  IF PV-HOLD-COMMENT-TMST NOT = SPACES            16190099
162000                      SET PS-DIFFERENT-COMMENT TO TRUE            16200099
162100                  END-IF                                          16210099
162200              END-IF                                              16220099
162300         WHEN SQLCODE = +100                                      16230099
162400             SET PS-COMMENT-ROW-NOT-FOUND TO TRUE                 16240099
162500                                                                  16250099
162600         WHEN SQLWARN0 NOT = SPACE                                16260099
162700         WHEN SQLCODE NOT = ZERO                                  16270099
162800              MOVE '4310-FETCH-CURSOR'                            16280099
162900                               TO DP013-PARAGRAPH                 16290099
163000              MOVE 'FETCH COMMENT CURSOR'                         16300099
163100                               TO DP013-MESSAGE-TEXT (1)          16310099
163200              MOVE SQLCA       TO DP013-SQLCA                     16320099
163300              SET DP013-DB2-ABEND                                 16330099
163400                               TO TRUE                            16340099
163500              PERFORM DP013-0000-PROCESS-ABEND                    16350099
163600     END-EVALUATE.                                                16360099
163700                                                                  16370099
163800*----------------------------------------------------------------*16380099
163900* 4315-FETCH-HIST.                                               *16390099
164000*   A COMMENT MAY HAVE UP TO FOUR ROWS ON THE TKMCCOM TABLE.     *16400099
164100*   EACH PERFORMANCE OF THIS PARAGRAPH GETS ALL OF THE ROWS      *16410099
164200*   ASSOCIATED WITH THE SAME COMMENT, PLUS THE FIRST ROW OF THE  *16420099
164300*   NEXT COMMENT, IF THERE IS ONE.  THE ORDER OF THE COMMENT     *16430099
164400*   ROWS IS KEPT BY THE TIMESTAMP AND THE KMCCOM-CMNT-SEQ-NBR    *16440099
164500*   FIELD, WHICH RANGES IN VALUE FROM ONE TO FOUR.               *16450099
164600*                                                                *16460099
164700*   THE FIRST FETCH RETRIEVES THE MOST CURRENT COMMENT AND THE   *16470099
164800*   FIRST SEQUENCE NUMBER OF THAT COMMENT.  THE NEXT TIME        *16480099
164900*   THROUGH, BEFORE THE FETCH IS CALLED TO GET ANOTHER ROW, THE  *16490099
165000*   PREVIOUS ROW IS MOVED TO WORKING STORAGE FIELDS.  ALL THE    *16500099
165100*   OTHER ROWS ASSOCIATED WITH THE SAME COMMENT ARE MOVED TO     *16510099
165200*   WORKING STORAGE WITHIN THE SQLCODE LOGIC.                    *16520099
165300*----------------------------------------------------------------*16530099
165400                                                                  16540099
165500 4315-FETCH-HIST.                                                 16550099
165600                                                                  16560099
165700     IF SVT00007-CMNT-SEQ-NBR = 1                                 16570099
165800         MOVE SVT00007-CMNT-TXT                                   16580099
165900                          TO PV-COMMENT-LINE (1)                  16590099
166000         MOVE SVT00007-CRE-TMST                                   16600099
166100                          TO PV-HOLD-COMMENT-TMST                 16610099
166200         MOVE SVT00007-CRE-BY-USR-ID                              16620099
166300                          TO PV-HOLD-USERID                       16630099
166400     END-IF.                                                      16640099
166500                                                                  16650099
166600     EXEC SQL                                                     16660099
166700          FETCH COMMENT-CSR-HIST                                  16670099
166800           INTO                                                   16680099
166900                :SVT00007-CRE-TMST                                16690099
167000              , :SVT00007-CMNT-SEQ-NBR                            16700099
167100              , :SVT00007-CMNT-TXT                                16710099
167200              , :SVT00007-CRE-BY-USR-ID                           16720099
167300     END-EXEC.                                                    16730099
167400                                                                  16740099
167500     EVALUATE TRUE                                                16750099
167600         WHEN SQLCODE = ZERO                                      16760099
167700              IF SVT00007-CRE-TMST = PV-HOLD-COMMENT-TMST         16770099
167800                  MOVE SVT00007-CMNT-TXT                          16780099
167900                          TO PV-COMMENT-LINE (PV-COMMENT-SUB)     16790099
168000              ELSE                                                16800099
168100                  IF PV-HOLD-COMMENT-TMST NOT = SPACES            16810099
168200                      SET PS-DIFFERENT-COMMENT TO TRUE            16820099
168300                  END-IF                                          16830099
168400              END-IF                                              16840099
168500         WHEN SQLCODE = +100                                      16850099
168600             SET PS-COMMENT-ROW-NOT-FOUND TO TRUE                 16860099
168700                                                                  16870099
168800         WHEN SQLWARN0 NOT = SPACE                                16880099
168900         WHEN SQLCODE NOT = ZERO                                  16890099
169000              MOVE '4315-FETCH-CURSOR-HIST'                       16900099
169100                               TO DP013-PARAGRAPH                 16910099
169200              MOVE 'FETCH COMMENT CURSOR'                         16920099
169300                               TO DP013-MESSAGE-TEXT (1)          16930099
169400              MOVE SQLCA       TO DP013-SQLCA                     16940099
169500              SET DP013-DB2-ABEND                                 16950099
169600                               TO TRUE                            16960099
169700              PERFORM DP013-0000-PROCESS-ABEND                    16970099
169800     END-EVALUATE.                                                16980099
169900                                                                  16990099
170000 EJECT                                                            17000099
170100*----------------------------------------------------------------*17010099
170200* MOVE THE DISPLAYED FIELDS FROM THE COMMAREA TO THE SCREEN.     *17020099
170300*----------------------------------------------------------------*17030099
170400                                                                  17040099
170500 4400-MOVE-COMMAREA-TO-SCREEN.                                    17050099
170600     IF  (((PV-TOP-ITEM > ASC-LIST-ITEM-NUMBER (1 1))             17060099
170700         AND (PV-TOP-ITEM > ASC-LIST-ITEM-NUMBER (2 1)))          17070099
170800         OR  (PV-TOP-ITEM < ASC-LIST-ITEM-NUMBER (1 1)))          17080099
170900             MOVE +1    TO ASC-BLK-SUB                            17090099
171000             PERFORM 5100-WRITE-TEMP-STORAGE                      17100099
171100             ADD +1     TO ASC-BLK-SUB                            17110099
171200             PERFORM 5100-WRITE-TEMP-STORAGE                      17120099
171300             DIVIDE PV-TOP-ITEM BY PC-ITEMS-PER-PANEL             17130099
171400                 GIVING PV-BLOCK-NUMBER                           17140099
171500                 REMAINDER PV-REMAINDER                           17150099
171600             IF  PV-REMAINDER > ZERO                              17160099
171700                 ADD +1 TO PV-BLOCK-NUMBER                        17170099
171800             END-IF                                               17180099
171900             MOVE +1    TO ASC-BLK-SUB                            17190099
172000             PERFORM 4410-READ-TEMP-STORAGE                       17200099
172100             ADD +1     TO ASC-BLK-SUB                            17210099
172200                           PV-BLOCK-NUMBER                        17220099
172300             PERFORM 4410-READ-TEMP-STORAGE                       17230099
172400     END-IF.                                                      17240099
172500     MOVE +1            TO ASC-BLK-SUB.                           17250099
172600     COMPUTE ASC-ITEM-SUB =                                       17260099
172700         ((PV-TOP-ITEM - ASC-LIST-ITEM-NUMBER (1 1))              17270099
172800         + PC-ITEMS-PER-PANEL).                                   17280099
172900*                                                                 17290099
173000     IF  ASC-ITEM-SUB > PC-ITEMS-PER-PANEL                        17300099
173100         ADD +1         TO ASC-BLK-SUB                            17310099
173200         SUBTRACT PC-ITEMS-PER-PANEL FROM ASC-ITEM-SUB            17320099
173300     END-IF.                                                      17330099
173400*                                                                 17340099
173500     COMPUTE ASC-ITEM-AT-BOT-OF-PANEL =                           17350099
173600         ((PV-TOP-ITEM + PC-ITEMS-PER-PANEL) - 1).                17360099
173700*                                                                 17370099
173800     PERFORM 4420-FORMAT-LIST-LINES                               17380099
173900         VARYING PV-SUB                                           17390099
174000         FROM PC-ITEMS-PER-PANEL BY -1                            17400099
174100         UNTIL PV-SUB < +1.                                       17410099
174200*                                                                 17420099
174300     PERFORM 3200-RESET-ATTRIBUTES.                               17430099
174400     COMPUTE ASC-ITEMS-DISPLAYED =                                17440099
174500         ((ASC-ITEM-AT-BOT-OF-PANEL - PV-TOP-ITEM) + 1).          17450099
174600     MOVE PV-TOP-ITEM              TO ASC-ITEM-AT-TOP-OF-PANEL.   17460099
174700*                                                                 17470099
           MOVE ASC-KEY-CARD-ID          TO SV007-CARD-NUMBER9                  
           MOVE 13                       TO SV007-CARD-NUMBER-DIS-LENGTH        
           SET SV007-FORMAT-DISPLAY      TO TRUE                                
           PERFORM SV007-FORMAT-CARD                                            
           MOVE SV007-CARD-NUMBER-DISPLAY TO ACARDIDO                           
174900*                                                                 17490099
175000     IF  DP020-MSG-NUMBER-X = SPACE                               17500099
175100         IF  ASC-ITEM-AT-BOT-OF-PANEL < ASC-NUMBER-OF-ITEMS-READ  17510099
175200*            --- MORE ITEMS TO DISPLAY ----                       17520099
175300             MOVE PC-TSYMSG-00279  TO DP020-MSG-NUMBER            17530099
175400             SET DP020-MSG-INFORMATIONAL TO TRUE                  17540099
175500         END-IF                                                   17550099
175600     END-IF.                                                      17560099
175700*----------------------------------------------------------------*17570099
175800*    READ A BLOCK FROM TEMPORARY STORAGE INTO THE ARRAY.         *17580099
175900*----------------------------------------------------------------*17590099
176000                                                                  17600099
176100 4410-READ-TEMP-STORAGE.                                          17610099
176200                                                                  17620099
176300     EXEC CICS                                                    17630099
176400         READQ TS                                                 17640099
176500             QUEUE (ASC-LIST-QUEUE-NAME)                          17650099
176600             INTO  (ASC-BLOCK-ENTRIES(ASC-BLK-SUB))               17660099
176700             ITEM  (PV-BLOCK-NUMBER)                              17670099
176800             RESP  (PV-CICS-RESP)                                 17680099
176900     END-EXEC.                                                    17690099
177000                                                                  17700099
177100     IF  ((PV-CICS-RESP = DFHRESP (NORMAL))                       17710099
177200       OR (PV-CICS-RESP = DFHRESP (ITEMERR)))                     17720099
177300         CONTINUE                                                 17730099
177400     ELSE                                                         17740099
177500         SET DP013-CICS-ABEND     TO TRUE                         17750099
177600         SET DP013-NO-ROLLBACK    TO TRUE                         17760099
177700         MOVE '4410-READ-TEMP-STORAGE'                            17770099
177800                                  TO DP013-PARAGRAPH              17780099
177900         MOVE 'ERROR TRYING TO READ FROM TEMP STORAGE QUEUE'      17790099
178000                                  TO DP013-MESSAGE-TEXT(1)        17800099
178100         PERFORM DP013-0000-PROCESS-ABEND                         17810099
178200     END-IF.                                                      17820099
178300                                                                  17830099
178400     SET ASC-BLOCK-NOT-MODIFIED(ASC-BLK-SUB) TO TRUE.             17840099
178500*                                                                 17850099
178600     IF  PV-CICS-RESP = DFHRESP (ITEMERR)                         17860099
178700         INITIALIZE ASC-BLOCK-ENTRIES (ASC-BLK-SUB)               17870099
178800     END-IF.                                                      17880099
178900 EJECT                                                            17890099
179000*----------------------------------------------------------------*17900099
179100*    PROCESS THE ITEMS IN THE ARRAY AND MOVE THEM TO THE MAP.    *17910099
179200*----------------------------------------------------------------*17920099
179300                                                                  17930099
179400 4420-FORMAT-LIST-LINES.                                          17940099
179500                                                                  17950099
179600     IF  ASC-ITEM-AT-BOT-OF-PANEL > ASC-NUMBER-OF-ITEMS-READ      17960099
179700         SUBTRACT +1 FROM ASC-ITEM-AT-BOT-OF-PANEL                17970099
179800         MOVE SPACE              TO MR-TRANS-TIMESTAMP (PV-SUB)   17980099
179900                                    MR-USERID-HEADING (PV-SUB)    17990099
180000                                    MR-USERID (PV-SUB)            18000099
180100         PERFORM                                                  18010099
180200             VARYING PV-COMMENT-SUB                               18020099
180300             FROM 1 BY 1                                          18030099
180400             UNTIL PV-COMMENT-SUB > 4                             18040099
180500                 MOVE SPACE      TO MR-COMMENTI                   18050099
180600                                    (PV-SUB PV-COMMENT-SUB)       18060099
180700         END-PERFORM                                              18070099
180800     ELSE                                                         18080099
180900         MOVE ASC-TRANS-TIMESTAMP (ASC-BLK-SUB ASC-ITEM-SUB)      18090099
181000                                 TO MR-TRANS-TIMESTAMP (PV-SUB)   18100099
181100         MOVE PC-USERID-HEADING  TO MR-USERID-HEADING (PV-SUB)    18110099
181200         MOVE ASC-USERID (ASC-BLK-SUB ASC-ITEM-SUB)               18120099
181300                                 TO MR-USERID (PV-SUB)            18130099
181400         PERFORM                                                  18140099
181500             VARYING PV-COMMENT-SUB                               18150099
181600             FROM 1 BY 1                                          18160099
181700             UNTIL PV-COMMENT-SUB > 4                             18170099
181800                 MOVE ASC-COMMENT-LINE                            18180099
181900                     (ASC-BLK-SUB ASC-ITEM-SUB PV-COMMENT-SUB)    18190099
182000                                 TO MR-COMMENTI                   18200099
182100                                 (PV-SUB PV-COMMENT-SUB)          18210099
182200         END-PERFORM                                              18220099
182300         IF ASC-LIST-ITEM-NUMBER (ASC-BLK-SUB ASC-ITEM-SUB) = 1   18230099
182400           AND DP020-INT-APPL-FORMAT-IND = PC-ADD-FORMAT          18240099
182500             MOVE -1                TO MR-COMMENTL (1 1)          18250099
182600             SET DP030-SET-CURSOR-APPL-1                          18260099
182700                                    TO TRUE                       18270099
182800         END-IF                                                   18280099
182900     END-IF.                                                      18290099
183000     SUBTRACT +1 FROM ASC-ITEM-SUB.                               18300099
183100     IF  ASC-ITEM-SUB < + 1                                       18310099
183200         MOVE PC-ITEMS-PER-PANEL TO ASC-ITEM-SUB                  18320099
183300         MOVE +1                 TO ASC-BLK-SUB                   18330099
183400     END-IF.                                                      18340099
183500*----------------------------------------------------------------*18350099
183600*    WRITE A NEW BLOCK FROM THE ARRAY TO TEMPORARY STORAGE.      *18360099
183700*    REWRITE AN EXISITING BLOCK ONLY IF IT HAS BEEN MODIFIED.    *18370099
183800*----------------------------------------------------------------*18380099
183900                                                                  18390099
184000 5100-WRITE-TEMP-STORAGE.                                         18400099
184100     MOVE ASC-LIST-ITEM-NUMBER(ASC-BLK-SUB 1)                     18410099
184200                                   TO PV-LIST-ITEM-NUMBER.        18420099
184300     COMPUTE PV-BLOCK-NUMBER =                                    18430099
184400         1 + ((PV-LIST-ITEM-NUMBER - 1) / PC-ITEMS-PER-PANEL).    18440099
184500                                                                  18450099
184600     IF (PV-BLOCK-NUMBER < ASC-HIGHEST-BLOCK-WRITTEN)             18460099
184700     OR (PV-BLOCK-NUMBER = ASC-HIGHEST-BLOCK-WRITTEN)             18470099
184800         IF  ASC-BLOCK-MODIFIED(ASC-BLK-SUB)                      18480099
184900             PERFORM 5105-REWRITE-ASC-LISTQ                       18490099
185000         END-IF                                                   18500099
185100     ELSE                                                         18510099
185200         COMPUTE PV-HIGHEST-BLOCK-WRITTEN =                       18520099
185300         ASC-HIGHEST-BLOCK-WRITTEN + 1                            18530099
185400         PERFORM 5110-WRITE-ASC-LISTQ                             18540099
185500         ADD +1                    TO ASC-HIGHEST-BLOCK-WRITTEN   18550099
185600     END-IF.                                                      18560099
185700                                                                  18570099
185800     SET ASC-BLOCK-NOT-MODIFIED(ASC-BLK-SUB) TO TRUE.             18580099
185900******************************************************************18590099
186000** REWRITE THE LIST TEMP STORAGE QUEUE FROM THE APPLICATION-    **18600099
186100** SPECIFIC COMMAREA.                                           **18610099
186200******************************************************************18620099
186300 5105-REWRITE-ASC-LISTQ.                                          18630099
186400     EXEC CICS                                                    18640099
186500         WRITEQ TS                                                18650099
186600             QUEUE (ASC-LIST-QUEUE-NAME)                          18660099
186700             FROM  (ASC-BLOCK-ENTRIES(ASC-BLK-SUB))               18670099
186800             ITEM  (PV-BLOCK-NUMBER)                              18680099
186900             REWRITE                                              18690099
187000             RESP  (PV-CICS-RESP)                                 18700099
187100     END-EXEC.                                                    18710099
187200                                                                  18720099
187300     IF  PV-CICS-RESP = DFHRESP(NORMAL)                           18730099
187400         CONTINUE                                                 18740099
187500     ELSE                                                         18750099
187600         SET DP013-CICS-ABEND            TO TRUE                  18760099
187700         SET DP013-NO-ROLLBACK           TO TRUE                  18770099
187800         MOVE '5105-REWRITE-ASC-LISTQ'   TO DP013-PARAGRAPH       18780099
187900         MOVE 'ATTEMPTING TO REWRITE LIST TEMP STORAGE QUEUE'     18790099
188000                                         TO DP013-MESSAGE-TEXT(1) 18800099
188100         PERFORM DP013-0000-PROCESS-ABEND                         18810099
188200     END-IF.                                                      18820099
188300                                                                  18830099
188400******************************************************************18840099
188500** WRITE THE LIST TEMP STORAGE QUEUE FROM THE APPLICATION-      **18850099
188600** SPECIFIC COMMAREA.                                           **18860099
188700******************************************************************18870099
188800 5110-WRITE-ASC-LISTQ.                                            18880099
188900     EXEC CICS                                                    18890099
189000         WRITEQ TS                                                18900099
189100             QUEUE (ASC-LIST-QUEUE-NAME)                          18910099
189200             FROM  (ASC-BLOCK-ENTRIES(ASC-BLK-SUB))               18920099
189300             ITEM  (PV-BLOCK-NUMBER)                              18930099
189400             RESP  (PV-CICS-RESP)                                 18940099
189500     END-EXEC.                                                    18950099
189600     IF  PV-CICS-RESP NOT = DFHRESP (NORMAL)                      18960099
189700         SET DP013-CICS-ABEND      TO TRUE                        18970099
189800         SET DP013-NO-ROLLBACK     TO TRUE                        18980099
189900         MOVE '5110-WRITE-ASC-LISTQ'                              18990099
190000                                   TO DP013-PARAGRAPH             19000099
190100         MOVE 'ATTEMPTING TO DELETE TEMP STORAGE QUEUE'           19010099
190200                                   TO DP013-MESSAGE-TEXT(1)       19020099
190300         PERFORM DP013-0000-PROCESS-ABEND                         19030099
190400     END-IF.                                                      19040099
190500 EJECT                                                            19050099
190600*----------------------------------------------------------------*19060099
190700 8000-GET-CURRENT-TIMESTAMP.                                      19070099
190800                                                                  19080099
190900     EXEC SQL                                                     19090099
191000         SET :PV-CURRENT-TIMESTAMP = CURRENT TIMESTAMP            19100099
191100     END-EXEC.                                                    19110099
191200                                                                  19120099
191300     EVALUATE TRUE                                                19130099
191400         WHEN SQLCODE = +0                                        19140099
191500             CONTINUE                                             19150099
191600         WHEN OTHER                                               19160099
191700             MOVE '8000-GET-CURRENT-TIMESTAMP'                    19170099
191800                              TO DP013-PARAGRAPH                  19180099
191900             MOVE 'INSERTING COMMENT'                             19190099
192000                              TO DP013-MESSAGE-TEXT(1)            19200099
192100             MOVE SQLCA       TO DP013-SQLCA                      19210099
192200             MOVE 'SVT_CRD_ACCT_CMMT' TO DP013-DB2-TABLE-NAME(1)  19220099
192300             SET DP013-DB2-ABEND                                  19230099
192400                 DP013-XCTL-DISPLAY-RESTART                       19240099
192500                              TO TRUE                             19250099
192600             PERFORM DP013-0000-PROCESS-ABEND                     19260099
192700     END-EVALUATE.                                                19270099
192800*----------------------------------------------------------------*19280099
192900 8005-GET-CUR-TIMESTAMP-HIST.                                     19290099
193000                                                                  19300099
193100     EXEC SQL                                                     19310099
193200         SET :PV-CURRENT-TIMESTAMP = CURRENT TIMESTAMP            19320099
193300     END-EXEC.                                                    19330099
193400                                                                  19340099
193500     EVALUATE TRUE                                                19350099
193600         WHEN SQLCODE = +0                                        19360099
193700             CONTINUE                                             19370099
193800         WHEN OTHER                                               19380099
193900             MOVE '8005-GET-CUR-TIMESTAMP-HIST'                   19390099
194000                              TO DP013-PARAGRAPH                  19400099
194100             MOVE 'INSERTING COMMENT'                             19410099
194200                              TO DP013-MESSAGE-TEXT(1)            19420099
194300             MOVE SQLCA       TO DP013-SQLCA                      19430099
194400             MOVE 'SVT_CRD_CMMT_HIST' TO DP013-DB2-TABLE-NAME(1)  19440099
194500             SET DP013-DB2-ABEND                                  19450099
194600                 DP013-XCTL-DISPLAY-RESTART                       19460099
194700                              TO TRUE                             19470099
194800             PERFORM DP013-0000-PROCESS-ABEND                     19480099
194900     END-EVALUATE.                                                19490099
195000*----------------------------------------------------------------*19500099
195100 8100-INSERT-COMMENT.                                             19510099
195200                                                                  19520099
195300     IF ASC-COMMENT-LINE (1 1 PV-COMMENT-SUB) = SPACES            19530099
195400         CONTINUE                                                 19540099
195500     ELSE                                                         19550099
195600         MOVE ASC-SHORT-CARD-ID    TO SVT00003-CRD-NBR            19560099
195700*        MOVE DK-CARD-ID           TO SVT00003-CRD-NBR            19570099
195800         MOVE PV-CURRENT-TIMESTAMP TO SVT00003-CRE-TMST           19580099
195900         MOVE PV-COMMENT-SUB       TO SVT00003-CMNT-SEQ-NBR       19590099
196000         MOVE ASC-COMMENT-LINE (1 1 PV-COMMENT-SUB)               19600099
196100                                   TO SVT00003-CMNT-TXT           19610099
196200         MOVE ASC-USERID (1 1)     TO SVT00003-CRE-BY-USR-ID      19620099
196300                                                                  19630099
196400         EXEC SQL                                                 19640099
196500             INSERT INTO SVT_CRD_ACCT_CMMT                        19650099
196600                (CRD_NBR                                          19660099
196700               , CRE_TMST                                         19670099
196800               , CMNT_SEQ_NBR                                     19680099
196900               , CMNT_TXT                                         19690099
197000               , CRE_BY_USR_ID)                                   19700099
197100             VALUES                                               19710099
197200                (:SVT00003-CRD-NBR                                19720099
197300               , :SVT00003-CRE-TMST                               19730099
197400               , :SVT00003-CMNT-SEQ-NBR                           19740099
197500               , :SVT00003-CMNT-TXT                               19750099
197600               , :SVT00003-CRE-BY-USR-ID)                         19760099
197700         END-EXEC                                                 19770099
197800                                                                  19780099
197900         EVALUATE TRUE                                            19790099
198000             WHEN SQLCODE = +0                                    19800099
198100                 CONTINUE                                         19810099
198200             WHEN OTHER                                           19820099
198300                 MOVE '8100-INSERT-COMMENT'                       19830099
198400                                  TO DP013-PARAGRAPH              19840099
198500                 MOVE 'INSERTING COMMENT'                         19850099
198600                                  TO DP013-MESSAGE-TEXT(1)        19860099
198700                 MOVE SQLCA       TO DP013-SQLCA                  19870099
198800                 MOVE 'SVT_CRD_ACCT_CMMT'                         19880099
198900                                  TO DP013-DB2-TABLE-NAME(1)      19890099
199000                 SET DP013-DB2-ABEND                              19900099
199100                     DP013-XCTL-DISPLAY-RESTART                   19910099
199200                                  TO TRUE                         19920099
199300                 PERFORM DP013-0000-PROCESS-ABEND                 19930099
199400         END-EVALUATE                                             19940099
199500     END-IF.                                                      19950099
199600                                                                  19960099
199700*----------------------------------------------------------------*19970099
199800 8105-INSERT-COMMENT-HIST.                                        19980099
199900                                                                  19990099
200000     IF ASC-COMMENT-LINE (1 1 PV-COMMENT-SUB) = SPACES            20000099
200100         CONTINUE                                                 20010099
200200     ELSE                                                         20020099
200300         MOVE ASC-SHORT-CARD-ID    TO SVT00007-CRD-NBR            20030099
200400         MOVE PV-CURRENT-TIMESTAMP TO SVT00007-CRE-TMST           20040099
200500         MOVE PV-COMMENT-SUB       TO SVT00007-CMNT-SEQ-NBR       20050099
200600         MOVE ASC-COMMENT-LINE (1 1 PV-COMMENT-SUB)               20060099
200700                                   TO SVT00007-CMNT-TXT           20070099
200800         MOVE ASC-USERID (1 1)     TO SVT00007-CRE-BY-USR-ID      20080099
200900                                                                  20090099
201000         EXEC SQL                                                 20100099
201100             INSERT INTO SVT_CRD_CMMT_HIST                        20110099
201200                (CRD_NBR                                          20120099
201300               , CRE_TMST                                         20130099
201400               , CMNT_SEQ_NBR                                     20140099
201500               , CMNT_TXT                                         20150099
201600               , CRE_BY_USR_ID)                                   20160099
201700             VALUES                                               20170099
201800                (:SVT00007-CRD-NBR                                20180099
201900               , :SVT00007-CRE-TMST                               20190099
202000               , :SVT00007-CMNT-SEQ-NBR                           20200099
202100               , :SVT00007-CMNT-TXT                               20210099
202200               , :SVT00007-CRE-BY-USR-ID)                         20220099
202300         END-EXEC                                                 20230099
202400                                                                  20240099
202500         EVALUATE TRUE                                            20250099
202600             WHEN SQLCODE = +0                                    20260099
202700                 CONTINUE                                         20270099
202800             WHEN OTHER                                           20280099
202900                 MOVE '8105-INSERT-COMMENT-HIST'                  20290099
203000                                  TO DP013-PARAGRAPH              20300099
203100                 MOVE 'INSERTING COMMENT'                         20310099
203200                                  TO DP013-MESSAGE-TEXT(1)        20320099
203300                 MOVE SQLCA       TO DP013-SQLCA                  20330099
203400                 MOVE 'SVT_CRD_CMMT_HIST'                         20340099
203500                                  TO DP013-DB2-TABLE-NAME(1)      20350099
203600                 SET DP013-DB2-ABEND                              20360099
203700                     DP013-XCTL-DISPLAY-RESTART                   20370099
203800                                  TO TRUE                         20380099
203900                 PERFORM DP013-0000-PROCESS-ABEND                 20390099
204000         END-EVALUATE                                             20400099
204100     END-IF.                                                      20410099
204200                                                                  20420099
204300******************************************************************20430099
204400**  CONVERSION OF CARD NUMBER                                    *20440099
204500******************************************************************20450099
204600     COPY SVPD007.                                                20460099
204700*----------------------------------------------------------------*20470099
204800*    ABEND PROCESSOR MODULE                                      *20480099
204900*----------------------------------------------------------------*20490099
205000                                                                  20500099
205100     COPY DPPD013.                                                20510099
