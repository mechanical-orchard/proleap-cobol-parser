000100 ID DIVISION.                                                     00010000
000200 PROGRAM-ID.   AUKCS520.                                          00020003
000300 AUTHOR.       BRAD GROCHOWSKI TKMA557.                           00030000
000400 INSTALLATION. KOHLS DEPARTMENT STORES.                           00040000
000500 DATE-WRITTEN. 2004-08-09                                         00050000
000600 DATE-COMPILED.                                                   00060000
000700                                                                  00070000
000800*---------------------------------------------------------------* 00080000
000900*         CICS PROGRAM - AUKCS520 - A520                        * 00090003
001000*    AUKCS520 - CONTROL PROGRAM FOR INCOMM MAINFRAME LISTENER   * 00100003
001100*               AUKCS519.                                       * 00110001
001200*                                                               * 00120000
001300*    THIS PROGRAM CONTROLS TRACING ON/OFF, AND CAN CANCEL THE   * 00130000
001400*    INCOMM TO MAINFRAME TCP/IP LISTENER AUKCS519.              * 00140001
001500*    SEE PROGRAM DOC FOR USAGE AND SPECIFIC INFORMATION.        * 00150000
001600*                                                               * 00160000
001700*    NOTE: THIS PROGRAM DOES NOT REQUIRE ANY SPECIAL COMPILE    * 00170000
001800*          OPTIONS, IT IS NOT DB2, NOT MQSERIES,                * 00180000
001900*          AND NOT CICS SOCKETS PGM.                            * 00190000
002000*---------------------------------------------------------------* 00200000
002100 ENVIRONMENT DIVISION.                                            00210000
002200 DATA DIVISION.                                                   00220000
002300 WORKING-STORAGE SECTION.                                         00230000
002400                                                                  00240000
002500 01  PC-PROGRAM-CONSTANTS.                                        00250000
002600     05  IPSW-TRAN                  PIC X(4) VALUE 'A520'.        00260003
002700 01  PV-PROGRAM-VARIABLES.                                        00270000
002800     05  DISP-MSGS                  PIC 9(8) COMP VALUE 9999.     00280000
002900     05  RC                         PIC 9(8) COMP.                00290000
003000     05  PV-I                       PIC 9(4) COMP.                00300000
003100     05  PV-J                       PIC 9(4) COMP.                00310000
003200     05  PV-L                       PIC 9(4) COMP.                00320000
003300     05  MAX                        PIC 9(4).                     00330000
003400     05  TSQ-READA                  PIC X(80).                    00340000
003500     05  TSQREC-LENGTH              PIC 9(4) COMP VALUE 80.       00350000
003600     05  EXTRA                      PIC 9(4) COMP VALUE 0.        00360000
003700     05  WS-RECEIVE                 PIC X(80) VALUE SPACES.       00370000
003800     05  WS-LEN                     PIC S9(4) COMP VALUE +80.     00380000
003900     05  FIRST-SPACE                PIC 9(4) COMP VALUE 0.        00390000
004000     05  ERR                        PIC 9(4) COMP VALUE 0.        00400000
004100     05  GWPTR                      PIC S9(8) COMP.               00410000
004200     05  DSTAMP                     PIC 9(16) COMP.               00420000
004300     05  CLENG                      PIC 9(4) BINARY.              00430000
004400     05  HOLD-PORT                  PIC X(4) VALUE SPACES.        00440000
004500                                                                  00450000
004600 01  TCPIPSWQ.                                                    00460000
004700     05  FILLER                 PIC X(7) VALUE 'AUINCSW'.         00470002
004800     05  TCPIPSWQ-ONE           PIC X(1) VALUE SPACE.             00480000
004900                                                                  00490000
005000 01  TCPCICS-MSG-AREA.                                            00500000
005100    02 TCPCICS-MSG-1.                                             00510000
005200       05 FILLER                PIC X(1) VALUE SPACES.            00520000
005300       05 MSGDATE               PIC 9(8).                         00530000
005400       05 FILLER                PIC X(1) VALUE SPACES.            00540000
005500       05 MSGTIME               PIC 9(8).                         00550000
005600       05 FILLER                PIC X(3) VALUE ' > '.             00560000
005700       05 MODULE                PIC X(4) VALUE 'A520'.            00570003
005800       05 FILLER                PIC X(1) VALUE SPACES.            00580000
005900    02 TCPCICS-MSG-2.                                             00590000
006000       05 MSG-AREA              PIC X(50).                        00600000
006100    02 MSG-OUT REDEFINES TCPCICS-MSG-2.                           00610000
006200       05  CALL-NO              PIC X(10).                        00620000
006300       05  FIELDXX              PIC X(7).                         00630000
006400       05  ERR-CODE             PIC X(8).                         00640000
006500       05  FIELDYY              PIC X(7).                         00650000
006600       05  RET-CODE             PIC X(10).                        00660000
006700       05  FILLER               PIC X(8).                         00670000
006800                                                                  00680000
006900 01  SEND-MSG.                                                    00690000
007000     02  FILLER                 PIC X(6) VALUE X'1140401D4013'.   00700000
007100     02  FILLER                 PIC X(5) VALUE X'115CF01DF8'.     00710000
007200     02  SEND-AREA              PIC X(48).                        00720000
007300     02  FILLER                 PIC X(40) VALUE SPACES.           00730000
007400                                                                  00740000
007500****************************************************************  00750000
007600                                                                  00760000
007700 PROCEDURE DIVISION.                                              00770000
007800                                                                  00780000
007900     PERFORM INITIALIZATION THRU INITIALIZATION-EXIT.             00790000
008000     EXEC CICS EXTRACT EXIT PROGRAM('EZACIC01') GASET(GWPTR)      00800000
008100          GALENGTH(PV-L) RESP(RC) END-EXEC.                       00810000
008200     IF RC NOT = 0 THEN                                           00820000
008300        MOVE 'TCP/IP TRUE INTERFACE NOT ACTIVE' TO SEND-AREA      00830000
008400        PERFORM WRITE-MESSAGE THRU WRITE-MESSAGE-EXIT             00840000
008500        GO TO PGM-EXIT                                            00850000
008600     END-IF.                                                      00860000
008700                                                                  00870000
008800     EXEC CICS RECEIVE INTO(WS-RECEIVE) LENGTH(WS-LEN)            00880000
008900          RESP(RC) END-EXEC.                                      00890000
009000     IF WS-RECEIVE(1:1) = X'11' THEN                              00900000
009100        MOVE 'WRITE STRUCTURE IN PARMS' TO MSG-AREA               00910000
009200        PERFORM WRITE-CICS THRU WRITE-CICS-EXIT                   00920000
009300        MOVE SPACES TO TSQ-READA                                  00930000
009400        MOVE WS-RECEIVE(4:37) TO TSQ-READA                        00940000
009500        MOVE TSQ-READA TO WS-RECEIVE                              00950000
009600     END-IF.                                                      00960000
009700     MOVE 'PARMS=' TO MSG-AREA.                                   00970000
009800     MOVE WS-RECEIVE TO MSG-AREA(7:40).                           00980000
009900     PERFORM WRITE-CICS THRU WRITE-CICS-EXIT.                     00990000
010000     IF WS-RECEIVE(1:4) = 'A520' THEN                             01000003
010100        MOVE WS-RECEIVE(6:31) TO TSQ-READA                        01010000
010200        MOVE TSQ-READA TO WS-RECEIVE                              01020000
010300     END-IF.                                                      01030000
010400     IF RC NOT = 0 THEN                                           01040000
010500        MOVE 'RECV-RC=' TO FIELDXX                                01050000
010600        MOVE RC TO ERR-CODE                                       01060000
010700        PERFORM WRITE-MESSAGE THRU WRITE-MESSAGE-EXIT             01070000
010800*       GO TO PGM-EXIT                                            01080000
010900     END-IF.                                                      01090000
011000                                                                  01100000
011100     MOVE WS-RECEIVE TO MSG-AREA.                                 01110000
011200     PERFORM WRITE-CICS THRU WRITE-CICS-EXIT.                     01120000
011300                                                                  01130000
011400     PERFORM REMOVE-EXTRA-SPACES THRU REMOVE-EXTRA-SPACES-EXIT.   01140000
011500                                                                  01150000
011600     PERFORM VALIDATE-CMD THRU VALIDATE-CMD-EXIT.                 01160000
011700                                                                  01170000
011800     IF HOLD-PORT = '7993' OR                                     01180000
011900        HOLD-PORT = '7996' OR                                     01190000
012000        HOLD-PORT = '7997' OR                                     01200000
012100        HOLD-PORT = '7998' THEN                                   01210000
012200        MOVE '1' TO TCPIPSWQ-ONE                                  01220000
012300     END-IF.                                                      01230000
012400                                                                  01240000
012500     IF TCPIPSWQ-ONE = SPACE THEN                                 01250000
012600        MOVE 'NO PORT / BAD PORT PASSED' TO SEND-AREA             01260000
012700        PERFORM WRITE-MESSAGE THRU WRITE-MESSAGE-EXIT             01270000
012800        GO TO PGM-EXIT                                            01280000
012900     END-IF.                                                      01290000
013000                                                                  01300000
013100     MOVE WS-RECEIVE TO MSG-AREA.                                 01310000
013200     PERFORM WRITE-CICS THRU WRITE-CICS-EXIT.                     01320000
013300                                                                  01330000
013400* SEARCH TO TSQ FOR A DUPLICATE REQUEST                           01340000
013500                                                                  01350000
013600     PERFORM VARYING PV-I FROM 1 BY 1 UNTIL PV-I > 100            01360000
013700        EXEC CICS READQ TS QUEUE(TCPIPSWQ) INTO(TSQ-READA)        01370000
013800             ITEM(PV-I) LENGTH(TSQREC-LENGTH) END-EXEC            01380000
013900        IF TSQ-READA = WS-RECEIVE THEN                            01390000
014000           MOVE 'REQUEST ALREADY IN QUEUE' TO SEND-AREA           01400000
014100           PERFORM WRITE-MESSAGE THRU WRITE-MESSAGE-EXIT          01410000
014200           GO TO PGM-EXIT                                         01420000
014300        END-IF                                                    01430000
014400        IF TSQ-READA = SPACES AND FIRST-SPACE = 0 THEN            01440000
014500           MOVE PV-I TO FIRST-SPACE                               01450000
014600        END-IF                                                    01460000
014700     END-PERFORM.                                                 01470000
014800                                                                  01480000
014900     IF FIRST-SPACE = 0 THEN                                      01490000
015000        MOVE '!TCPIPSWQ IS FULL' TO SEND-AREA                     01500000
015100        PERFORM WRITE-MESSAGE THRU WRITE-MESSAGE-EXIT             01510000
015200        GO TO PGM-EXIT                                            01520000
015300     ELSE                                                         01530000
015400        EXEC CICS WRITEQ TS QUEUE(TCPIPSWQ) FROM(WS-RECEIVE)      01540000
015500             ITEM(FIRST-SPACE) LENGTH(TSQREC-LENGTH)              01550000
015600             MAIN REWRITE END-EXEC                                01560000
015700        MOVE FIRST-SPACE TO MAX                                   01570000
015800        MOVE 'SWQ=' TO MSG-AREA                                   01580000
015900        MOVE MAX TO MSG-AREA(5:4)                                 01590000
016000        MOVE WS-RECEIVE TO MSG-AREA(14:36)                        01600000
016100        PERFORM WRITE-CICS THRU WRITE-CICS-EXIT                   01610000
016200     END-IF.                                                      01620000
016300     GO TO PGM-EXIT.                                              01630000
016400 MAIN-EXIT.                                                       01640000
016500     EXIT.                                                        01650000
016600                                                                  01660000
016700 PGM-EXIT.                                                        01670000
016800     MOVE 'END OF IPSW PROGRAM' TO MSG-AREA.                      01680000
016900     PERFORM WRITE-CICS THRU WRITE-CICS-EXIT.                     01690000
017000     EXEC CICS RETURN  END-EXEC.                                  01700000
017100     GOBACK.                                                      01710000
017200     EXIT.                                                        01720000
017300                                                                  01730000
017400****************************************************************  01740000
017500* THIS ROUTE DOES ALL OF THE INITIALIZATION FOR THIS TASK.     *  01750000
017600****************************************************************  01760000
017700                                                                  01770000
017800 INITIALIZATION.                                                  01780000
017900*    EXEC CICS IGNORE CONDITION TERMERR EOC SIGNAL END-EXEC.      01790000
018000                                                                  01800000
018100     EXEC CICS HANDLE CONDITION                                   01810000
018200                                INVREQ  (INVREQ-ERR-SEC)          01820000
018300                                IOERR   (IOERR-SEC)               01830000
018400                                ENDDATA (ENDDATA-SEC)             01840000
018500                                LENGERR (LENGERR-SEC)             01850000
018600                                NOSPACE (NOSPACE-ERR-SEC)         01860000
018700                                NOSTG   (NOSPACE-ERR-SEC)         01870000
018800                                QIDERR  (QIDERR-SEC)              01880000
018900                                ITEMERR (ITEMERR-SEC)             01890000
019000                                QZERO   (QZERO-SEC)               01900000
019100          END-EXEC.                                               01910000
019200                                                                  01920000
019300     MOVE '!INITIALIZATION DONE' TO MSG-AREA.                     01930000
019400     PERFORM WRITE-CICS THRU WRITE-CICS-EXIT.                     01940000
019500                                                                  01950000
019600 INITIALIZATION-EXIT.                                             01960000
019700     EXIT.                                                        01970000
019800                                                                  01980000
019900****************************************************************  01990000
020000*  THIS ROUTE WILL VALIDATE THE COMMAND FROM THE PARMS         *  02000000
020100****************************************************************  02010000
020200                                                                  02020000
020300 VALIDATE-CMD.                                                    02030000
020400                                                                  02040000
020500     IF WS-RECEIVE(1:5) = 'TRACE' THEN                            02050000
020600        MOVE 'TRACE TURNED ON FOR STORE' TO SEND-AREA             02060000
020700        PERFORM WRITE-MESSAGE THRU WRITE-MESSAGE-EXIT             02070000
020800        MOVE WS-RECEIVE(6:4) TO HOLD-PORT                         02080000
020900        GO TO VALIDATE-CMD-EXIT                                   02090000
021000     END-IF                                                       02100000
021100     IF WS-RECEIVE(1:7) = 'NOTRACE' THEN                          02110000
021200        MOVE 'TRACE TURNED OFF FOR STORE' TO SEND-AREA            02120000
021300        PERFORM WRITE-MESSAGE THRU WRITE-MESSAGE-EXIT             02130000
021400        MOVE WS-RECEIVE(8:4) TO HOLD-PORT                         02140000
021500        GO TO VALIDATE-CMD-EXIT                                   02150000
021600     END-IF                                                       02160000
021700     IF WS-RECEIVE(1:6) = 'CANCEL' THEN                           02170000
021800        MOVE 'CANCEL REQUESTED FOR TRAN' TO SEND-AREA             02180000
021900        PERFORM WRITE-MESSAGE THRU WRITE-MESSAGE-EXIT             02190000
022000        MOVE WS-RECEIVE(7:4) TO HOLD-PORT                         02200000
022100        GO TO VALIDATE-CMD-EXIT                                   02210000
022200     END-IF.                                                      02220000
022300                                                                  02230000
022400     MOVE '!' TO MSG-AREA.                                        02240000
022500     MOVE WS-RECEIVE TO MSG-AREA(2:44).                           02250000
022600     PERFORM WRITE-CICS THRU WRITE-CICS-EXIT.                     02260000
022700     MOVE 'INVALID COMMAND ENTERED - PLEASE RETRY' TO SEND-AREA.  02270000
022800     PERFORM WRITE-MESSAGE THRU WRITE-MESSAGE-EXIT.               02280000
022900     GO TO PGM-EXIT.                                              02290000
023000                                                                  02300000
023100 VALIDATE-CMD-EXIT.                                               02310000
023200     EXIT.                                                        02320000
023300                                                                  02330000
023400****************************************************************  02340000
023500*  THIS ROUTE WILL REMOVE EXTRA SPACES IN THE WS-RECEIVE       *  02350000
023600****************************************************************  02360000
023700 REMOVE-EXTRA-SPACES.                                             02370000
023800     PERFORM VARYING PV-I FROM 1 BY 1 UNTIL PV-I > WS-LEN         02380000
023900        IF EXTRA > 1 AND WS-RECEIVE(PV-I:1) NOT = ' ' THEN        02390000
024000           COMPUTE PV-J = PV-I - EXTRA + 1                        02400000
024100           COMPUTE PV-L = WS-LEN - PV-I + 1                       02410000
024200           MOVE WS-RECEIVE(PV-I:PV-L) TO WS-RECEIVE(PV-J:PV-L)    02420000
024300           COMPUTE PV-J = PV-J + PV-L                             02430000
024400           COMPUTE PV-L = WS-LEN - PV-J + 1                       02440000
024500           MOVE SPACES TO WS-RECEIVE(PV-J:PV-L)                   02450000
024600           MOVE PV-J TO PV-I                                      02460000
024700        END-IF                                                    02470000
024800        IF WS-RECEIVE(PV-I:1) = ' ' THEN                          02480000
024900           ADD 1 TO EXTRA                                         02490000
025000        ELSE                                                      02500000
025100           MOVE 0 TO EXTRA                                        02510000
025200        END-IF                                                    02520000
025300     END-PERFORM.                                                 02530000
025400                                                                  02540000
025500 REMOVE-EXTRA-SPACES-EXIT.                                        02550000
025600     EXIT.                                                        02560000
025700                                                                  02570000
025800****************************************************************  02580000
025900*                                                              *  02590000
026000* THIS ROUTE WRITES OUT A MESSAGE TO THE DISPLAY               *  02600000
026100*                                                              *  02610000
026200****************************************************************  02620000
026300*                                                                 02630000
026400 WRITE-MESSAGE.                                                   02640000
026500                                                                  02650000
026600     MOVE LENGTH OF SEND-MSG TO PV-L.                             02660000
026700     EXEC CICS SEND FROM(SEND-MSG) LENGTH(PV-L) END-EXEC.         02670000
026800     MOVE SEND-AREA TO MSG-AREA.                                  02680000
026900     PERFORM WRITE-CICS THRU WRITE-CICS-EXIT.                     02690000
027000                                                                  02700000
027100 WRITE-MESSAGE-EXIT.                                              02710000
027200     EXIT.                                                        02720000
027300                                                                  02730000
027400                                                                  02740000
027500****************************************************************  02750000
027600* THIS ROUTE WRITES OUT A MESSAGE TO THE CICS LOG              *  02760000
027700****************************************************************  02770000
027800                                                                  02780000
027900 WRITE-CICS.                                                      02790000
028000                                                                  02800000
028100     IF MSG-AREA(1:1) = '!' OR DISP-MSGS > 0                      02810000
028200        MOVE LENGTH OF TCPCICS-MSG-AREA TO CLENG                  02820000
028300        EXEC CICS ASKTIME ABSTIME(DSTAMP) NOHANDLE END-EXEC       02830000
028400        EXEC CICS FORMATTIME ABSTIME(DSTAMP) MMDDYY(MSGDATE)      02840000
028500             TIME(MSGTIME) DATESEP TIMESEP(':') NOHANDLE END-EXEC 02850000
028600        MOVE IPSW-TRAN TO MODULE                                  02860000
028700        EXEC CICS WRITEQ TD QUEUE('CSSL') FROM (TCPCICS-MSG-AREA) 02870000
028800             LENGTH(CLENG) END-EXEC                               02880000
028900     END-IF.                                                      02890000
029000                                                                  02900000
029100     IF DISP-MSGS > 0 AND DISP-MSGS < 9999                        02910000
029200        SUBTRACT 1 FROM DISP-MSGS.                                02920000
029300     MOVE SPACES TO MSG-AREA.                                     02930000
029400                                                                  02940000
029500                                                                  02950000
029600 WRITE-CICS-EXIT.                                                 02960000
029700     EXIT.                                                        02970000
029800                                                                  02980000
029900 EJECT                                                            02990000
030000*---------------------------------------------------------------* 03000000
030100*                                                               * 03010000
030200*  CONTROL IS GIVEN TO THE FOLLOWING ERROR ROUTINES BY 'HANDLES'* 03020000
030300*  ISSUED AT THE BEGINNING OF THE PROGRAM.                      * 03030000
030400*                                                               * 03040000
030500*---------------------------------------------------------------* 03050000
030600                                                                  03060000
030700 INVREQ-ERR-SEC.                                                  03070000
030800     MOVE '!INTERFACE IS NOT ACTIVE' TO MSG-AREA.                 03080000
030900     PERFORM WRITE-CICS THRU WRITE-CICS-EXIT.                     03090000
031000     GO TO PGM-EXIT.                                              03100000
031100                                                                  03110000
031200 IOERR-SEC.                                                       03120000
031300     MOVE '!IOERR OCCURS           ' TO MSG-AREA.                 03130000
031400     PERFORM WRITE-CICS THRU WRITE-CICS-EXIT.                     03140000
031500     GO TO PGM-EXIT.                                              03150000
031600                                                                  03160000
031700 QZERO-SEC.                                                       03170000
031800     MOVE '!QZERO OCCURRS          ' TO MSG-AREA.                 03180000
031900     PERFORM WRITE-CICS THRU WRITE-CICS-EXIT.                     03190000
032000     GO TO PGM-EXIT.                                              03200000
032100                                                                  03210000
032200 LENGERR-SEC.                                                     03220000
032300     MOVE '!*A520* LENGTH ERROR READING TD QUEUE' TO MSG-AREA.    03230003
032400     PERFORM WRITE-CICS THRU WRITE-CICS-EXIT.                     03240000
032500     MOVE '!' TO MSG-AREA.                                        03250000
032600     MOVE 'READQTD' TO FIELDXX.                                   03260000
032700     MOVE CLENG TO ERR-CODE.                                      03270000
032800     MOVE 'READQTD' TO FIELDYY.                                   03280000
032900     MOVE CLENG TO RET-CODE.                                      03290000
033000     MOVE '****' TO CALL-NO.                                      03300000
033100     PERFORM WRITE-CICS THRU WRITE-CICS-EXIT.                     03310000
033200     GO TO PGM-EXIT.                                              03320000
033300                                                                  03330000
033400 NOSPACE-ERR-SEC.                                                 03340000
033500     MOVE '!NOSPACE CONDITION      ' TO MSG-AREA.                 03350000
033600     PERFORM WRITE-CICS THRU WRITE-CICS-EXIT.                     03360000
033700     GO TO PGM-EXIT.                                              03370000
033800                                                                  03380000
033900 QIDERR-SEC.                                                      03390000
034000     MOVE '!QIDERR  CONDITION      ' TO MSG-AREA.                 03400000
034100     PERFORM WRITE-CICS THRU WRITE-CICS-EXIT.                     03410000
034200     GO TO PGM-EXIT.                                              03420000
034300                                                                  03430000
034400 ITEMERR-SEC.                                                     03440000
034500     MOVE 'NO TCPIPSWQ-SOCKET TASK NOT ACTIVE' TO SEND-AREA       03450000
034600     PERFORM WRITE-MESSAGE THRU WRITE-MESSAGE-EXIT.               03460000
034700     GO TO PGM-EXIT.                                              03470000
034800                                                                  03480000
034900 ENDDATA-SEC.                                                     03490000
035000     MOVE '!RETRIEVE DATA CAN NT BE FOUND' TO MSG-AREA.           03500000
035100     PERFORM WRITE-CICS THRU WRITE-CICS-EXIT.                     03510000
035200     GO TO PGM-EXIT.                                              03520000
