000100******************************************************************00010018
000200 IDENTIFICATION DIVISION.                                         00020001
000300******************************************************************00030001
000400                                                                  00040001
000500 PROGRAM-ID.             ARKUP001.                                00050001
000600 AUTHOR.                 RICK TULLOCH.                            00060001
000700 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00070001
000800 DATE-WRITTEN            9-14-88.                                 00080001
000900 DATE-COMPILED.                                                   00090001
001000                                                                  00100001
001100******************************************************************00110001
001200*  THIS PROGRAM UPDATES THE PROGRAMS TEPCRD AND TEPPAY TO        *00120054
001300*  INDICATE THAT THE TRANSACTIONS HAVE BEEN SENT TO CREDIT.      *00130054
001400*                                                                *00140054
001500*  IN THE PAST THIS PROGRAM PERFORMED EDITS ON TRANSACTIONS.     *00150054
001600*  ALL OF THIS CODE HAS BEEN REMOVED.                            *00160054
001700******************************************************************00170001
001800*  12/19/2002 JOANNE PIETROSKE                                   *00180069
001900*  CHANGED COPYBOOK ARRD001 TO INCREASE OPERATOR ID FIELD FROM   *00190070
002000*  6 TO 9 BYTES.  NEEDED TO RECOMPILE ONLY.                      *00200070
002100******************************************************************00210070
P9696 *  02/17/2014 COGNIZANT                                          *00212081
P9696 *  CHANGED THE RECORD LENGTH OF INPUT FILE TO 311. SINCE THE     *00213081
P9696 *  COPYBOOK ARRD001 IS MODIFIED AND ADDED WITH ADDITIONAL FIELDS.*00214083
P9696 ******************************************************************00215081
P9696 *  11/09/2016 BARB SCHULTZ                                       *00216084
P9696 *  CHANGED THE RECORD LENGTH OF INPUT FILE TO 385.               *00217084
P9696 ******************************************************************00219084
002200 ENVIRONMENT DIVISION.                                            00220001
002300******************************************************************00230001
002400                                                                  00240001
002500 CONFIGURATION SECTION.                                           00250001
002600                                                                  00260001
002700 SOURCE-COMPUTER.        IBM-3090.                                00270001
002800 OBJECT-COMPUTER.        IBM-3090.                                00280001
002900                                                                  00290001
003000 INPUT-OUTPUT SECTION.                                            00300001
003100                                                                  00310001
003200 FILE-CONTROL.                                                    00320001
003300                                                                  00330001
003400     SELECT AR-TRANSACTION-FILE                                   00340001
003500         ASSIGN TO INP01.                                         00350001
003600                                                                  00360001
003700******************************************************************00370001
003800 DATA DIVISION.                                                   00380001
003900******************************************************************00390001
004000                                                                  00400001
004100 FILE SECTION.                                                    00410001
004200                                                                  00420001
004300 FD  AR-TRANSACTION-FILE                                          00430001
004400     RECORDING MODE IS F                                          00440001
004500     LABEL RECORDS ARE STANDARD                                   00450001
004600     BLOCK CONTAINS 0 RECORDS                                     00460001
CFEES      RECORD CONTAINS 385 CHARACTERS                               00470084
004800     DATA RECORD IS AT-AR-TRANSACTION-RECORD.                     00480001
004900                                                                  00490001
CFEES  01  AT-AR-TRANSACTION-RECORD    PIC X(385).                      00500084
005100                                                                  00510001
005200 WORKING-STORAGE SECTION.                                         00520001
005300                                                                  00530001
005400*                                                                 00540001
005500*  ACCOUNTS RECEIVABLE TRANSACTION FILE RECORD LAYOUT             00550001
005600*                                                                 00560001
005700                                                                  00570001
005800     COPY ARRD001.                                                00580068
005900                                                                  00590001
006000                                                                  00600001
006100*                                                                 00610001
006200*  VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004        00620001
006300*                                                                 00630001
006400                                                                  00640001
006500     COPY DPWS004.                                                00650051
006600                                                                  00660001
006700*                                                                 00670001
006800*  INCLUDE FOR AR CONSTANT VALUES                                 00680001
006900*                                                                 00690001
007000                                                                  00700001
007100     COPY ARWS004.                                                00710051
007200                                                                  00720001
007300 01  ABEND-CODE                  PIC S9(4)    VALUE ZEROS         00730001
007400                                              COMP SYNC.          00740001
007500     88  AC-FILE-WRITE-ERROR                  VALUE +4001.        00750001
007600     88  AC-FILE-READ-ERROR                   VALUE +4002.        00760001
007700     88  AC-CONTROL-CARD-ERROR                VALUE +4003.        00770001
007800     88  AC-TABLE-OVERFLOW-ERROR              VALUE +4004.        00780001
007900     88  AC-FILE-OPEN-ERROR                   VALUE +4005.        00790001
008000     88  AC-FILE-CLOSE-ERROR                  VALUE +4006.        00800001
008100     88  AC-INVLD-DATA-ON-DATASET-ERROR       VALUE +4008.        00810001
008200     88  AC-DB2-ERROR                         VALUE +4013.        00820001
008300                                                                  00830001
008400 01  PS-PROGRAM-SWITCHES.                                         00840001
008500     05  PS-END-OF-TRANS-FILE-IND                                 00850001
008600                                 PIC X(1)     VALUE 'N'.          00860001
008700         88  PS-END-OF-TRANS-FILE             VALUE 'Y'.          00870001
008800         88  PS-NOT-END-OF-TRANS-FILE         VALUE 'N'.          00880056
008900                                                                  00890001
009000 01  PC-PROGRAM-CONSTANTS.                                        00900001
009100     05  PC-CURRENT-PROGRAM-NAME PIC X(8)     VALUE 'ARKUP001'.   00910001
009200     05  PC-SUCCESSFUL-SQLCODE                                    00920001
009300                                 PIC S9(9)    VALUE ZEROS         00930001
009400                                              COMP SYNC.          00940001
009500     05  PC-ROW-NOT-FOUND-SQLCODE                                 00950001
009600                                 PIC S9(9)    VALUE +100          00960001
009700                                              COMP SYNC.          00970001
009800     05  PC-LIT-P                PIC  X(1)    VALUE 'P'.          00980018
009900     05  PC-PAYMENT-TRAN-CODE    PIC  X(3)    VALUE '310'.        00990018
010000     05  PC-DEBIT-ADJ-TRAN       PIC  X(3)    VALUE '120'.        01000045
010100                                                                  01010001
010200 01  PV-PROGRAM-VARIABLES.                                        01020001
010300     05  PV-LAST-DB2-ACTION      PIC X(45)    VALUE SPACES.       01030001
010400         88  PV-UPDATE-TEPCRD-TABLE           VALUE               01040018
010500             'UPDATING TEPCRD TABLE                        '.     01050018
010600         88  PV-UPDATE-TEPPAY-TABLE           VALUE               01060018
010700             'UPDATING TEPPAY TABLE                        '.     01070018
010800         88  PV-SELECT-TCKRSTCNTL             VALUE               01080018
010900             'SELECTING A ROW FROM THE TCKRSTCNTL TABLE    '.     01090018
011000     05  PV-NUM-4                PIC 9(4)     VALUE ZERO.         01100018
011100     05  PV-COMMIT-TIMESTAMP     PIC X(26)    VALUE SPACES.       01110018
011200     05  PV-CURRENT-TIMESTAMP    PIC X(26)    VALUE SPACES.       01120018
011300     05  PV-RECORD-COUNT         PIC S9(9)    VALUE ZERO COMP-3.  01130056
011400     05  PV-TRANSACTION-COUNT    PIC S9(9)    VALUE ZERO COMP-3.  01140056
011500     05  PV-TEPCRD-UPDATE-COUNT  PIC S9(9)    VALUE ZERO COMP-3.  01150056
011600     05  PV-TEPPAY-UPDATE-COUNT  PIC S9(9)    VALUE ZERO COMP-3.  01160056
011700     05  PV-DISPLAY-COUNT        PIC -ZZZ,ZZZ,ZZ9.                01170056
011800                                                                  01180001
011900 01  CK-CURRENT-KEY-AREA.                                         01190001
012000     05  CK-PARTITION-NUMBER     PIC S9(4) COMP VALUE ZERO.       01200055
012100     05  CK-STORE-NUMBER         PIC X(4)       VALUE SPACES.     01210055
012200     05  CK-TERMINAL-NUMBER      PIC X(4)       VALUE SPACES.     01220055
012300     05  CK-TRANSACTION-NUMBER   PIC X(4)       VALUE SPACES.     01230055
012400     05  CK-START-TIME           PIC X(08)      VALUE SPACES.     01240058
012500     05  CK-SLS-CORR-SEQ-NBR     PIC S9(4) COMP VALUE ZERO.       01250055
012600     05  CK-TNDR-SEQ-NBR         PIC S9(4) COMP VALUE ZERO.       01260077
012700     05  CK-TRANSACTION-CODE     PIC X(03)      VALUE SPACES.     01270055
012800                                                                  01280001
012900                                                                  01290001
013000******************************************************************01300001
013100*  INCLUDE FOR THE CREDIT TENDER TABLE (TEPCRD)                  *01310001
013200******************************************************************01320001
013300                                                                  01330001
013400     EXEC SQL                                                     01340001
013500         INCLUDE TEPCRD                                           01350001
013600     END-EXEC.                                                    01360001
013700                                                                  01370001
013800******************************************************************01380001
013900*  INCLUDE FOR THE KOHLS PAYMENT TABLE (TEPPAY)                  *01390001
014000******************************************************************01400001
014100                                                                  01410001
014200     EXEC SQL                                                     01420001
014300         INCLUDE TEPPAY                                           01430001
014400     END-EXEC.                                                    01440001
014500                                                                  01450018
014600*----------------------------------------------------------------*01460018
014700*    STANDARD DB/2 DCLGEN FOR THE CHECKPOINT RESTART TABLE       *01470018
014800*----------------------------------------------------------------*01480018
014900     EXEC SQL                                                     01490018
015000         INCLUDE TCKRSTCN                                         01500018
015100     END-EXEC.                                                    01510018
015200                                                                  01520001
015300*                                                                 01530001
015400*  STANDARD LAYOUT FOR THE SQL COMMUNICATIONS AREA                01540001
015500*                                                                 01550001
015600                                                                  01560001
015700     EXEC SQL                                                     01570001
015800         INCLUDE SQLCA                                            01580001
015900     END-EXEC.                                                    01590001
016000                                                                  01600001
016100******************************************************************01610001
016200 PROCEDURE DIVISION.                                              01620001
016300******************************************************************01630001
016400                                                                  01640001
016500 0000-MAINLINE.                                                   01650001
016600                                                                  01660061
016700     PERFORM 1000-INITIALIZE.                                     01670001
016800                                                                  01680001
016900     PERFORM 2000-PROCESS-TRANSACTION                             01690001
017000         UNTIL PS-END-OF-TRANS-FILE.                              01700001
017100                                                                  01710001
017200     IF PV-RECORD-COUNT > 0                                       01720070
017300         PERFORM 3000-PROCESS-EP-TABLE-UPDATE                     01730070
017400     END-IF.                                                      01740070
017500                                                                  01750060
017600     PERFORM 9000-EOJ-ROUTINE.                                    01760001
017700                                                                  01770001
017800     GOBACK.                                                      01780054
017900                                                                  01790001
018000******************************************************************01800001
018100*  SET UP FOR PROGRAM PROCESSING OPENING THE INPUT FILE, GETTING *01810056
018200*  THE CURRENT TIMESTAMP AND READING THE FIRST RECORD IN THE     *01820056
018300*  FILE.                                                         *01830056
018400******************************************************************01840001
018500                                                                  01850001
018600 1000-INITIALIZE.                                                 01860001
018700                                                                  01870001
018800     OPEN INPUT  AR-TRANSACTION-FILE.                             01880054
018900                                                                  01890001
019000     PERFORM 4200-GET-COMMIT-TIMESTAMP.                           01900055
019100                                                                  01910001
019200     PERFORM 2100-READ-TRANSACTION-FILE.                          01920056
019300     MOVE AR001-PARTITION-NUMBER     TO CK-PARTITION-NUMBER.      01930055
019400     MOVE AR001-STORE-NUMBER         TO CK-STORE-NUMBER           01940055
019500     MOVE AR001-TERMINAL-NUMBER      TO CK-TERMINAL-NUMBER.       01950055
019600     MOVE AR001-TRANSACTION-NUMBER   TO CK-TRANSACTION-NUMBER.    01960055
019700     MOVE AR001-START-TIME           TO CK-START-TIME.            01970058
019800     MOVE AR001-SLS-CORR-SEQ-NBR     TO CK-SLS-CORR-SEQ-NBR.      01980055
019900     MOVE AR001-TNDR-SEQ-NBR         TO CK-TNDR-SEQ-NBR.          01990078
020000     MOVE AR001-TRANSACTION-CODE     TO CK-TRANSACTION-CODE.      02000055
020100                                                                  02010055
020200*1000-EXIT.                                                       02020001
020300                                                                  02030001
020400******************************************************************02040001
020500*  PROCESS AN ACCOUNTS RECEIVABLE TRANSACTION. AFTER ALL THE     *02050055
020600*  RECORDS FOR A TRANSACTION HAVE BEEN READ, UPDATE THE          *02060055
020700*  TEPPAY OR TEPCRD TABLE TO INDICATE THAT THE TRANSACTION HAS   *02070055
020800*  BEEN PROCESSED.                                               *02080055
020900******************************************************************02090001
021000                                                                  02100001
021100 2000-PROCESS-TRANSACTION.                                        02110001
021200                                                                  02120055
021300     IF AR001-PARTITION-NUMBER   = CK-PARTITION-NUMBER   AND      02130055
021400        AR001-STORE-NUMBER       = CK-STORE-NUMBER       AND      02140055
021500        AR001-TERMINAL-NUMBER    = CK-TERMINAL-NUMBER    AND      02150055
021600        AR001-TRANSACTION-NUMBER = CK-TRANSACTION-NUMBER AND      02160055
021700        AR001-START-TIME         = CK-START-TIME         AND      02170055
021800        AR001-SLS-CORR-SEQ-NBR   = CK-SLS-CORR-SEQ-NBR   AND      02180078
021900        AR001-TNDR-SEQ-NBR       = CK-TNDR-SEQ-NBR                02190078
022000         CONTINUE                                                 02200055
022100     ELSE                                                         02210055
022200         PERFORM 3000-PROCESS-EP-TABLE-UPDATE                     02220055
022300         PERFORM 4000-CHECK-FOR-COMMIT                            02230055
022400     END-IF.                                                      02240055
022500                                                                  02250055
022600     MOVE AR001-PARTITION-NUMBER     TO CK-PARTITION-NUMBER.      02260055
022700     MOVE AR001-STORE-NUMBER         TO CK-STORE-NUMBER           02270055
022800     MOVE AR001-TERMINAL-NUMBER      TO CK-TERMINAL-NUMBER.       02280055
022900     MOVE AR001-TRANSACTION-NUMBER   TO CK-TRANSACTION-NUMBER.    02290055
023000     MOVE AR001-START-TIME           TO CK-START-TIME.            02300058
023100     MOVE AR001-SLS-CORR-SEQ-NBR     TO CK-SLS-CORR-SEQ-NBR.      02310055
023200     MOVE AR001-TNDR-SEQ-NBR         TO CK-TNDR-SEQ-NBR.          02320078
023300     MOVE AR001-TRANSACTION-CODE     TO CK-TRANSACTION-CODE.      02330055
023400                                                                  02340055
023500     PERFORM 2100-READ-TRANSACTION-FILE.                          02350056
023600                                                                  02360018
023700*2000-EXIT.                                                       02370001
023800                                                                  02380055
023900******************************************************************02390056
024000*  READ AN ACCOUNTS RECEIVABLE TRANSACTION RECORD.               *02400056
024100******************************************************************02410056
024200                                                                  02420056
024300 2100-READ-TRANSACTION-FILE.                                      02430056
024400     READ AR-TRANSACTION-FILE                                     02440056
024500         INTO AR001-AR-TRANSACTION-RECORD                         02450056
024600         AT END                                                   02460056
024700             SET PS-END-OF-TRANS-FILE TO TRUE                     02470056
024800     END-READ.                                                    02480056
024900                                                                  02490056
025000     IF PS-NOT-END-OF-TRANS-FILE                                  02500056
025100        ADD +1 TO PV-RECORD-COUNT                                 02510056
025200     END-IF.                                                      02520056
025300*2100-EXIT.                                                       02530056
025400                                                                  02540056
025500******************************************************************02550018
025600*  DETERMINE THE TRANSACTION TYPE AND CALL THE APPROPRIATE       *02560042
025700*  TABLE UPDATE ROUTINE.                                         *02570042
025800******************************************************************02580018
025900 3000-PROCESS-EP-TABLE-UPDATE.                                    02590055
026000                                                                  02600018
026100     ADD +1 TO PV-TRANSACTION-COUNT.                              02610060
026200                                                                  02620060
026300     IF CK-TRANSACTION-CODE        = PC-PAYMENT-TRAN-CODE  OR     02630045
026400                                     PC-DEBIT-ADJ-TRAN            02640045
026500         PERFORM 3100-UPDATE-TEPPAY                               02650055
026600     ELSE                                                         02660040
026700         PERFORM 3200-UPDATE-TEPCRD                               02670055
026800     END-IF.                                                      02680040
026900                                                                  02690040
027000******************************************************************02700018
027100*  UPDATE THE TEPPAY TABLE TO REFLECT THE TRANSACTION HAS BEEN    02710036
027200*  PROCESSED                                                      02720018
027300******************************************************************02730018
027400 3100-UPDATE-TEPPAY.                                              02740055
027500                                                                  02750040
027600     ADD +1                        TO PV-TEPPAY-UPDATE-COUNT.     02760056
027700     MOVE CK-PARTITION-NUMBER      TO EPPAY-PARTN-NBR             02770062
027800     MOVE CK-STORE-NUMBER          TO PV-NUM-4.                   02780062
027900     MOVE PV-NUM-4                 TO EPPAY-STR-NBR.              02790062
028000     MOVE CK-TERMINAL-NUMBER       TO PV-NUM-4.                   02800040
028100     MOVE PV-NUM-4                 TO EPPAY-RGST-ID.              02810040
028200     MOVE CK-TRANSACTION-NUMBER    TO PV-NUM-4.                   02820040
028300     MOVE PV-NUM-4                 TO EPPAY-TRN-NBR.              02830040
028400     MOVE CK-START-TIME            TO EPPAY-STRT-TM.              02840058
028500     MOVE CK-SLS-CORR-SEQ-NBR      TO EPPAY-SLS-CORR-SEQ-NBR      02850040
028600                                                                  02860040
028700     EXEC SQL                                                     02870040
028800         UPDATE TEPPAY                                            02880040
028900             SET STTLMNT_PRCD_CDE = :PC-LIT-P                     02890040
029000             WHERE PARTN_NBR      = :EPPAY-PARTN-NBR              02900040
029100               AND STR_NBR        = :EPPAY-STR-NBR                02910040
029200               AND RGST_ID        = :EPPAY-RGST-ID                02920040
029300               AND TRN_NBR        = :EPPAY-TRN-NBR                02930040
029400               AND  STRT_TM       = :EPPAY-STRT-TM                02940040
029500               AND SLS_CORR_SEQ_NBR                               02950040
029600                                  = :EPPAY-SLS-CORR-SEQ-NBR       02960040
029700     END-EXEC.                                                    02970040
029800                                                                  02980040
029900     EVALUATE TRUE                                                02990040
030000         WHEN SQLCODE = ZERO                                      03000040
030100             CONTINUE                                             03010040
030200         WHEN SQLWARN0 NOT EQUAL SPACE                            03020040
030300         WHEN SQLCODE NOT EQUAL ZERO                              03030040
030400             DISPLAY 'PARTITION NBR ' EPPAY-PARTN-NBR             03040078
030500             DISPLAY 'STORE NBR ' EPPAY-STR-NBR                   03050078
030600             DISPLAY 'REGISTER ID ' EPPAY-RGST-ID                 03060078
030700             DISPLAY 'TRAN NBR ' EPPAY-TRN-NBR                    03070078
030800             DISPLAY 'TIME ' EPPAY-STRT-TM                        03080078
030900             DISPLAY 'SLS CORR ' EPPAY-SLS-CORR-SEQ-NBR           03090078
031000             DISPLAY '3100-UPDATE-TEPPAY'                         03100058
031100             SET PV-UPDATE-TEPPAY-TABLE                           03110040
031200                                   TO TRUE                        03120040
031300             PERFORM 9100-DB2-ERROR                               03130077
031400     END-EVALUATE.                                                03140040
031500*                                                                 03150037
031600******************************************************************03160018
031700*  UPDATE THE TEPCRD TABLE TO REFELCT THE TRANSACTION HAS BEEN    03170018
031800*  PROCESSED                                                      03180018
031900******************************************************************03190018
032000 3200-UPDATE-TEPCRD.                                              03200055
032100                                                                  03210040
032200     ADD +1                        TO PV-TEPCRD-UPDATE-COUNT.     03220056
032300     MOVE CK-PARTITION-NUMBER      TO EPCRD-PARTN-NBR.            03230058
032400     MOVE CK-STORE-NUMBER          TO PV-NUM-4.                   03240062
032500     MOVE PV-NUM-4                 TO EPCRD-STR-NBR.              03250062
032600     MOVE CK-TERMINAL-NUMBER       TO PV-NUM-4.                   03260040
032700     MOVE PV-NUM-4                 TO EPCRD-RGST-ID.              03270040
032800     MOVE CK-TRANSACTION-NUMBER    TO PV-NUM-4.                   03280040
032900     MOVE PV-NUM-4                 TO EPCRD-TRN-NBR.              03290040
033000     MOVE CK-START-TIME            TO EPCRD-STRT-TM.              03300058
033100     MOVE CK-SLS-CORR-SEQ-NBR      TO EPCRD-SLS-CORR-SEQ-NBR      03310040
033200     MOVE CK-TNDR-SEQ-NBR          TO EPCRD-TNDR-SEQ-NBR.         03320078
033300                                                                  03330040
033400     EXEC SQL                                                     03340040
033500         UPDATE TEPCRD                                            03350040
033600             SET STTLMNT_PRCD_CDE = :PC-LIT-P                     03360040
033700             WHERE PARTN_NBR      = :EPCRD-PARTN-NBR              03370040
033800               AND STR_NBR        = :EPCRD-STR-NBR                03380040
033900               AND RGST_ID        = :EPCRD-RGST-ID                03390040
034000               AND TRN_NBR        = :EPCRD-TRN-NBR                03400040
034100               AND STRT_TM        = :EPCRD-STRT-TM                03410040
034200               AND SLS_CORR_SEQ_NBR                               03420040
034300                                  = :EPCRD-SLS-CORR-SEQ-NBR       03430040
034400               AND TNDR_SEQ_NBR   = :EPCRD-TNDR-SEQ-NBR           03440078
034500     END-EXEC.                                                    03450040
034600                                                                  03460040
034700     EVALUATE TRUE                                                03470040
034800         WHEN SQLCODE = ZERO                                      03480040
034900             CONTINUE                                             03490040
035000         WHEN SQLWARN0 NOT EQUAL SPACE                            03500040
035100         WHEN SQLCODE NOT EQUAL ZERO                              03510066
035200             DISPLAY 'PARTITION NBR ' EPCRD-PARTN-NBR             03520078
035300             DISPLAY 'STORE NBR ' EPCRD-STR-NBR                   03530078
035400             DISPLAY 'REGISTER ID ' EPCRD-RGST-ID                 03540078
035500             DISPLAY 'TRAN NBR ' EPCRD-TRN-NBR                    03550078
035600             DISPLAY 'TIME ' EPCRD-STRT-TM                        03560078
035700             DISPLAY 'SLS CORR ' EPCRD-SLS-CORR-SEQ-NBR           03570078
035800             DISPLAY 'TNDR SEQ ' EPCRD-TNDR-SEQ-NBR               03580078
035900             DISPLAY '3200-UPDATE-TEPCRD'                         03590058
036000             SET PV-UPDATE-TEPCRD-TABLE                           03600040
036100                                   TO TRUE                        03610040
036200             PERFORM 9100-DB2-ERROR                               03620077
036300     END-EVALUATE.                                                03630040
036400*                                                                 03640037
036500******************************************************************03650055
036600* CHECK TO SEE IF A COMMIT NEEDS TO BE TAKEN                     *03660055
036700******************************************************************03670055
036800 4000-CHECK-FOR-COMMIT.                                           03680055
036900                                                                  03690055
037000     EXEC SQL                                                     03700055
037100         SET :PV-CURRENT-TIMESTAMP = CURRENT TIMESTAMP            03710055
037200     END-EXEC.                                                    03720055
037300                                                                  03730055
037400     EVALUATE TRUE                                                03740055
037500         WHEN SQLCODE = ZERO                                      03750055
037600             IF PV-CURRENT-TIMESTAMP > PV-COMMIT-TIMESTAMP        03760058
037700                 PERFORM 4100-COMMIT                              03770055
037800                 PERFORM 4200-GET-COMMIT-TIMESTAMP                03780055
037900             END-IF                                               03790055
038000         WHEN SQLWARN0 NOT EQUAL SPACE                            03800055
038100         WHEN SQLCODE NOT EQUAL ZERO                              03810055
038200             DISPLAY '4000-CHECK-FOR-COMMIT'                      03820056
038300             SET PV-SELECT-TCKRSTCNTL                             03830055
038400                                   TO TRUE                        03840055
038500             PERFORM 9100-DB2-ERROR                               03850055
038600     END-EVALUATE.                                                03860055
038700*                                                                 03870055
038800***************************************************************** 03880018
038900* COMMIT DB2 CHANGES                                            * 03890018
039000***************************************************************** 03900018
039100 4100-COMMIT.                                                     03910055
039200                                                                  03920042
039300     EXEC SQL                                                     03930042
039400         COMMIT                                                   03940042
039500     END-EXEC.                                                    03950042
039600                                                                  03960042
039700     EVALUATE TRUE                                                03970042
039800         WHEN SQLCODE = ZERO                                      03980042
039900             CONTINUE                                             03990042
040000         WHEN SQLWARN0 NOT EQUAL SPACE                            04000042
040100         WHEN SQLCODE NOT EQUAL ZERO                              04010042
040200             DISPLAY '4100-COMMIT'                                04020056
040300             SET PV-SELECT-TCKRSTCNTL                             04030042
040400                                   TO TRUE                        04040042
040500             PERFORM 9100-DB2-ERROR                               04050042
040600     END-EVALUATE.                                                04060042
040700                                                                  04070018
040800******************************************************************04080055
040900*  GET THE TIMESTAMP THAT WILL BE USED TO DETERMINE COMMIT       *04090055
041000*  PROCESSING                                                    *04100055
041100******************************************************************04110055
041200 4200-GET-COMMIT-TIMESTAMP.                                       04120055
041300                                                                  04130055
041400     EXEC SQL                                                     04140055
041500         SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)     04150055
041600         INTO :PV-COMMIT-TIMESTAMP                                04160055
041700         FROM TCKRSTCNTL                                          04170055
041800         WHERE PLAN_NAME           = :PC-CURRENT-PROGRAM-NAME     04180055
041900     END-EXEC.                                                    04190055
042000                                                                  04200055
042100     EVALUATE TRUE                                                04210055
042200         WHEN SQLCODE = ZERO                                      04220055
042300             CONTINUE                                             04230055
042400         WHEN SQLWARN0 NOT EQUAL SPACE                            04240055
042500         WHEN SQLCODE NOT EQUAL ZERO                              04250055
042600             DISPLAY '4200-GET-COMMIT-TIMESTAMP'                  04260056
042700             SET PV-SELECT-TCKRSTCNTL                             04270055
042800                                   TO TRUE                        04280055
042900             PERFORM 9100-DB2-ERROR                               04290055
043000     END-EVALUATE.                                                04300055
043100                                                                  04310055
043200******************************************************************04320001
043300*  CLOSE ALL FILES AND DISPLAY PROCESSING COUNTS.                *04330056
043400******************************************************************04340001
043500                                                                  04350001
043600 9000-EOJ-ROUTINE.                                                04360001
043700                                                                  04370056
043800     CLOSE AR-TRANSACTION-FILE.                                   04380056
043900                                                                  04390056
044000     DISPLAY 'CONTROL TOTALS FOR PROGRAM '                        04400061
044100              PC-CURRENT-PROGRAM-NAME.                            04410061
044200     DISPLAY ' '.                                                 04420061
044300     DISPLAY 'RECORDS READ           '                            04430061
044400             PV-RECORD-COUNT.                                     04440056
044500     DISPLAY 'TRANSACTIONS PROCESSED '                            04450061
044600             PV-TRANSACTION-COUNT.                                04460056
044700     DISPLAY 'TEPPAY ROWS UPDATED    '                            04470061
044800             PV-TEPPAY-UPDATE-COUNT.                              04480056
044900     DISPLAY 'TEPCRD ROWS UPDATED    '                            04490061
045000             PV-TEPCRD-UPDATE-COUNT.                              04500056
045100                                                                  04510056
045200*9000-EXIT.                                                       04520001
045300                                                                  04530001
045400******************************************************************04540001
045500*  FORMAT A DB2 ERROR MESSAGE, AND ABEND THE PROGRAM.            *04550001
045600******************************************************************04560001
045700                                                                  04570001
045800 9100-DB2-ERROR.                                                  04580001
045900     DISPLAY '** ABEND **'.                                       04590001
046000     DISPLAY PC-CURRENT-PROGRAM-NAME  ' - SQL ERROR'.             04600001
046100     DISPLAY PC-CURRENT-PROGRAM-NAME  ' - ATTEMPTING TO '         04610001
046200               PV-LAST-DB2-ACTION.                                04620001
046300                                                                  04630001
046400*                                                                 04640001
046500*  ROUTINE TO CONVERT THE SQLCA INTO A READABLE FORMAT, USING     04650001
046600*  THE CALLED MODULE DSNTIAR.                                     04660001
046700*                                                                 04670001
046800                                                                  04680001
046900     COPY DPPD004.                                                04690001
047000                                                                  04700001
047100     SET AC-DB2-ERROR TO TRUE.                                    04710001
047200     CALL 'ILBOABN0' USING ABEND-CODE.                            04720001
047300*9100-EXIT.                                                       04730001
