000100 IDENTIFICATION DIVISION.                                         00010099
000200                                                                  00020099
000300 PROGRAM-ID.      TFKRP005.                                       00030099
000400 AUTHOR.          STEVEN NOWAK.                                   00040099
000500 INSTALLATION.    KOHLS DEPARTMENT STORES.                        00050099
000600 DATE-WRITTEN.    04/01/06.                                       00060099
000700 DATE-COMPILED.                                                   00070099
000800                                                                  00080099
000900******************************************************************00090099
001000*  MODULE TYPE:   COBOL2 DB2 BATCH                                00100099
001100*                                                                 00110099
001200*  DESCRIPTION:   DAILY CALLBACK ITEMS DETAIL REPORT              00120099
001300*                                                                 00130099
001400*========================== CHANGE LOG ===========================00140099
001500*  AUTH     BY         DATE                 DESCRIPTION           00150099
001600*=================================================================00160099
001700* WR30039  S.NOWAK   04-01-06   CREATE PROGRAM                    00170099
001800*                                                                 00180099
001900* WR34886  K.GIVENS  06-20-08   ADD DSTRY AND HOLD TO CLBK NUMBER 00190099
002000*                               COLUMN                            00200099
002100*                                                                 00210099
002200******************************************************************00220099
002300                                                                  00230099
002400 ENVIRONMENT DIVISION.                                            00240099
002500 CONFIGURATION SECTION.                                           00250099
002600                                                                  00260099
002700 SOURCE-COMPUTER.        IBM-3090.                                00270099
002800 OBJECT-COMPUTER.        IBM-3090.                                00280099
002900                                                                  00290099
003000 INPUT-OUTPUT SECTION.                                            00300099
003100 FILE-CONTROL.                                                    00310099
003200                                                                  00320099
003300     SELECT RPT-FILE ASSIGN TO RPT01.                             00330099
003400                                                                  00340099
003500 DATA DIVISION.                                                   00350099
003600 FILE SECTION.                                                    00360099
003700                                                                  00370099
003800 FD  RPT-FILE                                                     00380099
003900     LABEL RECORDS STANDARD                                       00390099
004000     RECORDING MODE IS F                                          00400099
004100     BLOCK CONTAINS 0 RECORDS.                                    00410099
004200                                                                  00420099
004300 01  PRT-REC                        PIC X(132).                   00430099
004400                                                                  00440099
004500******************************************************************00450099
004600*                       WORKING STORAGE                           00460099
004700******************************************************************00470099
004800 WORKING-STORAGE SECTION.                                         00480099
004900                                                                  00490099
005000 01  W-START                        PIC X(40)                     00500099
005100     VALUE 'TFKRP005 - WORKING STORAGE BEGINS HERE'.              00510099
005200                                                                  00520099
005300                                                                  00530099
005400******************************************************************00540099
005500*                         SWITCHES                                00550099
005600******************************************************************00560099
005700 01  PS-PROGRAM-SWITCHES.                                         00570099
005800     05  PS-CALL-BCK-EOF-SW         PIC X(01)   VALUE 'N'.        00580099
005900         88  CALL-BCK-END-OF-FILE               VALUE 'Y'.        00590099
006000     05  PS-ITM-EOF-SW              PIC X(01)   VALUE 'N'.        00600099
006100         88  ITM-END-OF-FILE                    VALUE 'Y'.        00610099
006200                                                                  00620099
006300     05  PS-FIRST-READ-SW           PIC X(01)   VALUE 'Y'.        00630099
006400         88  FIRST-READ                         VALUE 'Y'.        00640099
006500                                                                  00650099
006600******************************************************************00660099
006700*                        ACCUMULATORS                             00670099
006800******************************************************************00680099
006900 01  PA-ACCUMS.                                                   00690099
007000     05  PA-PAGE-CNT                PIC 9(05)   VALUE ZEROS.      00700099
007100     05  PA-LINE-CNT                PIC 9(02)   VALUE ZEROS.      00710099
007200                                                                  00720099
007300     05  PA-CALL-BCK-READ           PIC 9(11)   VALUE ZEROS.      00730099
007400                                                                  00740099
007500     05  PA-SALE                    PIC 9(11)   VALUE ZEROS.      00750099
007600     05  PA-SALE-DUMMY              PIC 9(11)   VALUE ZEROS.      00760099
007700     05  PA-RETURN                  PIC 9(11)   VALUE ZEROS.      00770099
007800     05  PA-RETURN-VALID            PIC 9(11)   VALUE ZEROS.      00780099
007900     05  PA-RETURN-DUMMY            PIC 9(11)   VALUE ZEROS.      00790099
008000                                                                  00800099
008100     05  PA-WRITTEN                 PIC 9(11)   VALUE ZEROS.      00810099
008200                                                                  00820099
008300******************************************************************00830099
008400*                          WORK AREA                              00840099
008500******************************************************************00850099
008600 01  WS-WORK-AREA.                                                00860099
008700     05  WS-HOLD-STR-NBR            PIC S9(04)  COMP.             00870099
008800                                                                  00880099
008900     05  WS-CCYY-MM-DD              PIC  X(10)  VALUE SPACES.     00890099
009000                                                                  00900099
009100     05  WS-SLS-DTE                 PIC  X(10)  VALUE SPACES.     00910099
009200                                                                  00920099
009300     05  WS-SKU-NBR                 PIC  9(08)  VALUE ZEROS.      00930099
009400                                                                  00940099
009500                                                                  00950099
009600******************************************************************00960099
009700*                          CONSTANTS                              00970099
009800******************************************************************00980099
009900 01  PC-CONSTANTS.                                                00990099
010000     05  PC-PROGRAM-NAME            PIC  X(08)  VALUE 'TFKRP005'. 01000099
010100     05  PC-MAX-LINES               PIC  9(02)  VALUE 56.         01010099
010200                                                                  01020099
010300     05  PC-ROW-NOT-FOUND           PIC S9(03)  VALUE +100.       01030099
010400                                                                  01040099
010500******************************************************************01050099
010600*                        VARIABLES                                01060099
010700******************************************************************01070099
010800 01  PC-PROGRAM-VARIABLES.                                        01080099
010900     05  PV-SQLCODE                 PIC +9(04)  VALUE ZEROS.      01090099
011000     05  PV-PARAGRAPH-NAME          PIC  X(30)  VALUE SPACES.     01100099
011100     05  PV-TABLE-NAME              PIC  X(12)  VALUE SPACES.     01110099
011200     05  PV-OPERATION-MSG           PIC  X(60)  VALUE SPACES.     01120099
011300                                                                  01130099
011400******************************************************************01140099
011500*                        CONTROL CARD                             01150099
011600******************************************************************01160099
011700 01  CC-CONTROL-CARD.                                             01170099
011800     05  CC-CNTL-CARD.                                            01180099
011900         10  FILLER                 PIC  X(06)  VALUE             01190099
012000                                                'DATE: '.         01200099
012100         10  CC-DATE.                                             01210099
012200             15  CC-YY              PIC  X(04)  VALUE SPACES.     01220099
012300             15  FILLER             PIC  X(01)  VALUE SPACES.     01230099
012400             15  CC-MM              PIC  X(02)  VALUE SPACES.     01240099
012500             15  FILLER             PIC  X(01)  VALUE SPACES.     01250099
012600             15  CC-DD              PIC  X(02)  VALUE SPACES.     01260099
012700         10  FILLER                 PIC  X(64)  VALUE SPACES.     01270099
012800                                                                  01280099
012900******************************************************************01290099
013000*               SYTEM TIME AND DATE VARIABLES                     01300099
013100******************************************************************01310099
013200 01  SYS-DATE-TIME.                                               01320099
013300     05  SYS-DATE                   PIC  X(08)  VALUE SPACES.     01330099
013400     05  SYS-TIME                   PIC  X(08)  VALUE SPACES.     01340099
013500                                                                  01350099
013600 01  ST-BEG-TIME.                                                 01360099
013700     05  ST-BEG-HR                  PIC  9(02)  VALUE ZEROS.      01370099
013800     05  FILLER                     PIC  X(01)  VALUE ':'.        01380099
013900     05  ST-BEG-MN                  PIC  9(02)  VALUE ZEROS.      01390099
014000                                                                  01400099
014100 01  ST-END-TIME.                                                 01410099
014200     05  ST-END-HR                  PIC  9(02)  VALUE ZEROS.      01420099
014300     05  FILLER                     PIC  X(01)  VALUE ':'.        01430099
014400     05  ST-END-MN                  PIC  9(02)  VALUE ZEROS.      01440099
014500                                                                  01450099
014600 01  SD-EDIT-DATE.                                                01460099
014700     05  SD-MONTH                   PIC  9(02)  VALUE ZEROS.      01470099
014800     05  FILLER                     PIC  X(01)  VALUE '-'.        01480099
014900     05  SD-DAY                     PIC  9(02)  VALUE ZEROS.      01490099
015000     05  FILLER                     PIC  X(01)  VALUE '-'.        01500099
015100     05  SD-YEAR.                                                 01510099
015200         10  SD-CC                  PIC  9(02)  VALUE ZEROS.      01520099
015300         10  SD-YY                  PIC  9(02)  VALUE ZEROS.      01530099
015400                                                                  01540099
015500******************************************************************01550099
015600*                        ERROR HANDLING                           01560099
015700******************************************************************01570099
015800 01  ABEND-CODE                  PIC S9(4) VALUE ZEROS COMP SYNC. 01580099
015900     88  ABEND-4001-WRITE-ERROR            VALUE +4001.           01590099
016000     88  ABEND-4002-READ-ERROR             VALUE +4002.           01600099
016100     88  ABEND-4003-CTRL-CARD-ERROR        VALUE +4003.           01610099
016200     88  ABEND-4004-TABLE-ERROR            VALUE +4004.           01620099
016300     88  ABEND-4005-OPEN-ERROR             VALUE +4005.           01630099
016400     88  ABEND-4006-CLOSE-ERROR            VALUE +4006.           01640099
016500     88  ABEND-4007-SEQUENCE-ERROR         VALUE +4007.           01650099
016600     88  ABEND-4008-DATA-ERROR             VALUE +4008.           01660099
016700     88  ABEND-4009-KEY-DATA-ERROR         VALUE +4009.           01670099
016800     88  ABEND-4010-IMS-ERROR              VALUE +4010.           01680099
016900     88  ABEND-4011-DJDE-ERROR             VALUE +4011.           01690099
017000     88  ABEND-4013-DB2-ERROR              VALUE +4013.           01700099
017100     88  ABEND-4019-CAL-SUB-ERROR          VALUE +4019.           01710099
017200     88  ABEND-4444-FORCED-ABEND           VALUE +4444.           01720099
017300                                                                  01730099
017400******************************************************************01740099
017500* KOHLS STANDARD HEADING ROUTINE                                  01750099
017600******************************************************************01760099
017700*    COPY DPWS132O.                                               01770099
017800 01  DP132O-STANDRD-HEADER-132-COLS.                              01780099
017900     05  DP132O-RUN-DATE.                                         01790099
018000         10  DP132O-RUN-MONTH          PIC  9(02)    VALUE ZERO.  01800099
018100         10  FILLER                    PIC  X(01)    VALUE '/'.   01810099
018200         10  DP132O-RUN-DAY            PIC  9(02)    VALUE ZERO.  01820099
018300         10  FILLER                    PIC  X(01)    VALUE '/'.   01830099
018400         10  DP132O-RUN-CENTURY        PIC  9(02)    VALUE ZERO.  01840099
018500         10  DP132O-RUN-YEAR           PIC  9(02)    VALUE ZERO.  01850099
018600         10  FILLER                    PIC  X(01)    VALUE SPACE. 01860099
018700     05  DP132O-RUN-TIME.                                         01870099
018800         10  DP132O-RUN-HOUR           PIC  9(02)    VALUE ZERO.  01880099
018900         10  FILLER                    PIC  X(01)    VALUE ':'.   01890099
019000         10  DP132O-RUN-MINUTE         PIC  9(02)    VALUE ZERO.  01900099
019100     05  FILLER                        PIC  X(26)    VALUE SPACE. 01910099
019200     05  FILLER                        PIC  X(45)                 01920099
019300         VALUE 'K O H L S   D E P A R T M E N T   S T O R E S'.   01930099
019400     05  FILLER                        PIC  X(21)    VALUE SPACE. 01940099
019500     05  DP132O-PROGRAM-NAME           PIC  X(08)    VALUE SPACE. 01950099
019600     05  FILLER                        PIC  X(01)    VALUE '-'.   01960099
019700     05  DP132O-REPORT-NUMBER          PIC  9(01)    VALUE ZERO.  01970099
019800     05  FILLER                        PIC  X(02)    VALUE SPACE. 01980099
019900     05  FILLER                        PIC  X(05)    VALUE 'PAGE'.01990099
020000     05  DP132O-PAGE-NUMBER            PIC ZZZZ9     VALUE ZERO.  02000099
020100     05  FILLER                        PIC  X(02)    VALUE SPACE. 02010099
020200                                                                  02020099
020300                                                                  02030099
020400******************************************************************02040099
020500* REPORT HEADINGS                                                 02050099
020600******************************************************************02060099
020700 01 PV-HDR1.                                                      02070099
020800     05  FILLER                    PIC X(48)  VALUE SPACES.       02080099
020900     05  FILLER                    PIC X(26)  VALUE               02090099
021000         'CALLBACK ITEMS REPORT FOR '.                            02100099
021100     05  HD-DATE.                                                 02110099
021200         10  HD-MM                 PIC X(02)  VALUE SPACES.       02120099
021300         10  FILLER                PIC X(01)  VALUE '/'.          02130099
021400         10  HD-DD                 PIC X(02)  VALUE SPACES.       02140099
021500         10  FILLER                PIC X(01)  VALUE '/'.          02150099
021600         10  HD-YY                 PIC X(04)  VALUE SPACES.       02160099
021700                                                                  02170099
021800 01 PV-HDR2.                                                      02180099
021900     05  FILLER                    PIC X(02)  VALUE SPACES.       02190099
022000     05  FILLER                    PIC X(07)  VALUE               02200099
022100         'STORE: '.                                               02210099
022200     05  HD-STORE                  PIC ZZZ9   VALUE ZEROS.        02220099
022300                                                                  02230099
022400 01 PV-HDR3.                                                      02240099
022500     05  FILLER                    PIC X(22)  VALUE SPACES.       02250099
022600     05  FILLER                    PIC X(04)  VALUE 'CALL'.       02260099
022700     05  FILLER                    PIC X(73)  VALUE SPACES.       02270099
022800     05  FILLER                    PIC X(03)  VALUE 'REG'.        02280099
022900     05  FILLER                    PIC X(02)  VALUE SPACES.       02290099
023000     05  FILLER                    PIC X(04)  VALUE 'TRAN'.       02300099
023100     05  FILLER                    PIC X(02)  VALUE SPACES.       02310099
023200     05  FILLER                    PIC X(08)  VALUE 'OPERATOR'.   02320099
023300     05  FILLER                    PIC X(03)  VALUE SPACES.       02330099
023400     05  FILLER                    PIC X(08)  VALUE 'CALLBACK'.   02340099
023500                                                                  02350099
023600 01 PV-HDR4.                                                      02360099
023700     05  FILLER                    PIC X(11)  VALUE SPACES.       02370099
023800     05  FILLER                    PIC X(03)  VALUE 'UPC'.        02380099
023900     05  FILLER                    PIC X(08)  VALUE SPACES.       02390099
024000     05  FILLER                    PIC X(04)  VALUE 'BACK'.       02400099
024100     05  FILLER                    PIC X(11)  VALUE SPACES.       02410099
024200     05  FILLER                    PIC X(11)  VALUE               02420099
024300         'DESCRIPTION'.                                           02430099
024400     05  FILLER                    PIC X(14)  VALUE SPACES.       02440099
024500     05  FILLER                    PIC X(09)  VALUE               02450099
024600         'TRAN TYPE'.                                             02460099
024700     05  FILLER                    PIC X(07)  VALUE SPACES.       02470099
024800     05  FILLER                    PIC X(03)  VALUE 'QTY'.        02480099
024900     05  FILLER                    PIC X(06)  VALUE SPACES.       02490099
025000     05  FILLER                    PIC X(06)  VALUE 'AMOUNT'.     02500099
025100     05  FILLER                    PIC X(06)  VALUE SPACES.       02510099
025200     05  FILLER                    PIC X(03)  VALUE 'NBR'.        02520099
025300     05  FILLER                    PIC X(03)  VALUE SPACES.       02530099
025400     05  FILLER                    PIC X(03)  VALUE 'NBR'.        02540099
025500     05  FILLER                    PIC X(05)  VALUE SPACES.       02550099
025600     05  FILLER                    PIC X(02)  VALUE 'ID'.         02560099
025700     05  FILLER                    PIC X(07)  VALUE SPACES.       02570099
025800     05  FILLER                    PIC X(06)  VALUE 'NUMBER'.     02580099
025900                                                                  02590099
026000 01 PV-HDR5.                                                      02600099
026100     05  FILLER                    PIC X(11)  VALUE SPACES.       02610099
026200     05  FILLER                    PIC X(03)  VALUE ALL '='.      02620099
026300     05  FILLER                    PIC X(08)  VALUE SPACES.       02630099
026400     05  FILLER                    PIC X(04)  VALUE ALL '='.      02640099
026500     05  FILLER                    PIC X(11)  VALUE SPACES.       02650099
026600     05  FILLER                    PIC X(11)  VALUE ALL '='.      02660099
026700     05  FILLER                    PIC X(14)  VALUE SPACES.       02670099
026800     05  FILLER                    PIC X(09)  VALUE ALL '='.      02680099
026900     05  FILLER                    PIC X(07)  VALUE SPACES.       02690099
027000     05  FILLER                    PIC X(03)  VALUE ALL '='.      02700099
027100     05  FILLER                    PIC X(06)  VALUE SPACES.       02710099
027200     05  FILLER                    PIC X(06)  VALUE ALL '='.      02720099
027300     05  FILLER                    PIC X(06)  VALUE SPACES.       02730099
027400     05  FILLER                    PIC X(03)  VALUE ALL '='.      02740099
027500     05  FILLER                    PIC X(02)  VALUE SPACES.       02750099
027600     05  FILLER                    PIC X(04)  VALUE ALL '='.      02760099
027700     05  FILLER                    PIC X(02)  VALUE SPACES.       02770099
027800     05  FILLER                    PIC X(08)  VALUE ALL '='.      02780099
027900     05  FILLER                    PIC X(03)  VALUE SPACES.       02790099
028000     05  FILLER                    PIC X(08)  VALUE ALL '='.      02800099
028100                                                                  02810099
028200                                                                  02820099
028300******************************************************************02830099
028400* DETAIL LINES                                                    02840099
028500******************************************************************02850099
028600 01  PV-DTL1.                                                     02860099
028700     05  FILLER                    PIC X(05)   VALUE SPACES.      02870099
028800     05  DT-UPC-NBR                PIC ZZZZZZZZZZZZZZZ.           02880099
028900     05  FILLER                    PIC X(03)   VALUE SPACES.      02890099
029000     05  DT-CALL-BCK               PIC X(01)   VALUE SPACES.      02900099
029100     05  FILLER                    PIC X(04)   VALUE SPACES.      02910099
029200     05  DT-SKU-DESC               PIC X(30)   VALUE SPACES.      02920099
029300     05  FILLER                    PIC X(02)   VALUE SPACES.      02930099
029400     05  DT-TRAN-TYPE              PIC X(16)   VALUE SPACES.      02940099
029500     05  FILLER                    PIC X(02)   VALUE SPACES.      02950099
029600     05  DT-QTY                    PIC ZZZ9    VALUE ZEROS.       02960099
029700     05  FILLER                    PIC X(02)   VALUE SPACES.      02970099
029800     05  DT-AMT                    PIC Z,ZZZ,ZZZ.99.              02980099
029900     05  FILLER                    PIC X(02)   VALUE SPACES.      02990099
030000     05  DT-REG-NBR                PIC ZZZZ    VALUE ZEROS.       03000099
030100     05  FILLER                    PIC X(02)   VALUE SPACES.      03010099
030200     05  DT-TRAN-NBR               PIC ZZZZ    VALUE ZEROS.       03020099
030300     05  FILLER                    PIC X(02)   VALUE SPACES.      03030099
030400     05  DT-ASSOC-ID               PIC ZZZZZZZZZ.                 03040099
030500     05  FILLER                    PIC X(02)   VALUE SPACES.      03050099
030600     05  DT-CLBK-ID                PIC ZZZZZZZZZ.                 03060099
030700     05  DT-CLBK-ID-X REDEFINES DT-CLBK-ID                        03070099
030800                                   PIC X(09).                     03080099
030900                                                                  03090099
031000 01  PV-DTL2.                                                     03100099
031100     05  FILLER                    PIC X(48)   VALUE SPACES.      03110099
031200     05  FILLER                    PIC X(36)  VALUE               03120099
031300         '*** NO DETAIL WRITTEN FOR REPORT ***'.                  03130099
031400                                                                  03140099
031500                                                                  03150099
031600******************************************************************03160099
031700* VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004         03170099
031800******************************************************************03180099
031900     COPY DPWS004.                                                03190099
032000                                                                  03200099
032100******************************************************************03210099
032200* DB2 MESSAGE AREA                                                03220099
032300******************************************************************03230099
032400     COPY SQLCA2.                                                 03240099
032500                                                                  03250099
032600******************************************************************03260099
032700* DB2 COMMUNICATION AREA                                          03270099
032800******************************************************************03280099
032900     EXEC SQL                                                     03290099
033000          INCLUDE SQLCA                                           03300099
033100     END-EXEC.                                                    03310099
033200                                                                  03320099
033300******************************************************************03330099
033400* TRANSACTION TABLE                                               03340099
033500******************************************************************03350099
033600     EXEC SQL                                                     03360099
033700          INCLUDE TEPTRN                                          03370099
033800     END-EXEC.                                                    03380099
033900                                                                  03390099
034000******************************************************************03400099
034100* ITEM TABLE                                                      03410099
034200******************************************************************03420099
034300     EXEC SQL                                                     03430099
034400          INCLUDE TEPITM                                          03440099
034500     END-EXEC.                                                    03450099
034600                                                                  03460099
034700******************************************************************03470099
034800* ITEM CALLBACK TABLE (EPT_ITM_CLBK)                              03480099
034900******************************************************************03490099
035000     EXEC SQL                                                     03500099
035100          INCLUDE EPT00026                                        03510099
035200     END-EXEC.                                                    03520099
035300                                                                  03530099
035400******************************************************************03540099
035500* SKU TABLE (XST_SKU)                                             03550099
035600******************************************************************03560099
035700     EXEC SQL                                                     03570099
035800          INCLUDE XST00010                                        03580099
035900     END-EXEC.                                                    03590099
036000                                                                  03600099
036100******************************************************************03610099
036200* PARTITION TABLE                                                 03620099
036300******************************************************************03630099
036400     EXEC SQL                                                     03640099
036500          INCLUDE TEPPART                                         03650099
036600     END-EXEC.                                                    03660099
036700                                                                  03670099
036800******************************************************************03680099
036900* CALLBACK TABLE (TFT_CLBK)                                       03690099
037000******************************************************************03700099
037100     EXEC SQL                                                     03710099
037200          INCLUDE TFT00002                                        03720099
037300     END-EXEC.                                                    03730099
037400                                                                  03740099
037500******************************************************************03750099
037600* CALLBACK MDSE TABLE (TFT_CLBK_MDSE)                             03760099
037700******************************************************************03770099
037800     EXEC SQL                                                     03780099
037900          INCLUDE TFT00003                                        03790099
038000     END-EXEC.                                                    03800099
038100                                                                  03810099
038200******************************************************************03820099
038300* CALLBACK CURSOR                                                 03830099
038400******************************************************************03840099
038500     EXEC SQL                                                     03850099
038600        DECLARE CALL-BCK-CSR CURSOR FOR                           03860099
038700         SELECT  TRN.PARTN_NBR                                    03870099
038800                ,TRN.STR_NBR                                      03880099
038900                ,TRN.RGST_ID                                      03890099
039000                ,TRN.TRN_NBR                                      03900099
039100                ,TRN.STRT_TM                                      03910099
039200                ,TRN.SLS_CORR_SEQ_NBR                             03920099
039300                ,TRN.TRN_TYP_CDE                                  03930099
039400                ,TRN.ASSOC_ID                                     03940099
039500                ,TRN.VOID_ABRT_CDE                                03950099
039600                ,ITM.SKU_SEQ_NBR                                  03960099
039700                ,ITM.SAL_RET_CDE                                  03970099
039800                ,ITM.UPC_NBR                                      03980099
039900                ,ITM.SKU_NBR                                      03990099
040000                ,ITM.SLD_QTY                                      04000099
040100                ,ITM.NET_CHRGD_AMT                                04010099
040200                ,SKU.SKU_DESC                                     04020099
040300                ,PRT.SLS_DTE                                      04030099
040400                                                                  04040099
040500           FROM TEPTRN       TRN                                  04050099
040600               ,TEPITM       ITM                                  04060099
040700               ,EPT_ITM_CLBK CLB                                  04070099
040800               ,XST_SKU      SKU                                  04080099
040900               ,TEPPART      PRT                                  04090099
041000                                                                  04100099
041100           WHERE TRN.PARTN_NBR = PRT.PARTN_NBR                    04110099
041200             AND TRN.PARTN_NBR = ITM.PARTN_NBR                    04120099
041300             AND TRN.PARTN_NBR = CLB.PARTN_NBR                    04130099
041400                                                                  04140099
041500             AND TRN.STR_NBR = ITM.STR_NBR                        04150099
041600             AND TRN.STR_NBR = CLB.STR_NBR                        04160099
041700                                                                  04170099
041800             AND TRN.RGST_ID = ITM.RGST_ID                        04180099
041900             AND TRN.RGST_ID = CLB.RGST_ID                        04190099
042000             AND TRN.TRN_NBR = ITM.TRN_NBR                        04200099
042100             AND TRN.TRN_NBR = CLB.TRN_NBR                        04210099
042200             AND TRN.STRT_TM = ITM.STRT_TM                        04220099
042300             AND TRN.STRT_TM = CLB.STRT_TM                        04230099
042400                                                                  04240099
042500             AND TRN.SLS_CORR_SEQ_NBR = ITM.SLS_CORR_SEQ_NBR      04250099
042600             AND TRN.SLS_CORR_SEQ_NBR = CLB.SLS_CORR_SEQ_NBR      04260099
042700                                                                  04270099
042800             AND ITM.LNE_ITM_SEQ_NBR  = CLB.LNE_ITM_SEQ_NBR       04280099
042900                                                                  04290099
043000             AND ITM.SKU_NBR = SKU.SKU_NBR                        04300099
043100                                                                  04310099
043200             AND PRT.SLS_DTE = :WS-SLS-DTE                        04320099
043300             AND TRN.VOID_ABRT_CDE IN ('N', 'V', 'A')             04330099
043400             AND TRN.TRN_TYP_CDE   IN ('01', '02', '11', '12',    04340099
043500                                       '21', '24', '25', '46')    04350099
043600                                                                  04360099
043700             AND ITM.LIV_RSLU_CDE IN ('+', '-', 'R')              04370099
043800             AND ITM.SAL_RET_CDE  IN ('S', 'R')                   04380099
043900                                                                  04390099
044000          ORDER BY ITM.STR_NBR                                    04400099
044100                  ,ITM.UPC_NBR                                    04410099
044200                                                                  04420099
044300       WITH UR                                                    04430099
044400     END-EXEC.                                                    04440099
044500                                                                  04450099
044600                                                                  04460099
044700******************************************************************04470099
044800* ITEM CURSOR                                                     04480099
044900******************************************************************04490099
045000     EXEC SQL                                                     04500099
045100        DECLARE ITM-CSR CURSOR FOR                                04510099
045200         SELECT  UPC_NBR                                          04520099
045300                ,SKU_NBR                                          04530099
045400                ,SLD_QTY                                          04540099
045500                ,NET_CHRGD_AMT                                    04550099
045600                                                                  04560099
045700           FROM TEPITM                                            04570099
045800                                                                  04580099
045900           WHERE PARTN_NBR = :EPTRN-PARTN-NBR                     04590099
046000             AND STR_NBR   = :EPTRN-STR-NBR                       04600099
046100             AND RGST_ID   = :EPTRN-RGST-ID                       04610099
046200             AND TRN_NBR   = :EPTRN-TRN-NBR                       04620099
046300             AND STRT_TM   = :EPTRN-STRT-TM                       04630099
046400             AND SLS_CORR_SEQ_NBR = :EPTRN-SLS-CORR-SEQ-NBR       04640099
046500             AND SAL_RET_CDE  = 'S'                               04650099
046600             AND DEPT_NBR <> '983'                                04660099
046700                                                                  04670099
046800       WITH UR                                                    04680099
046900     END-EXEC.                                                    04690099
047000                                                                  04700099
047100                                                                  04710099
047200                                                                  04720099
047300 PROCEDURE DIVISION.                                              04730099
047400******************************************************************04740099
047500* MAIN DRIVER                                                     04750099
047600******************************************************************04760099
047700 0000-MAIN-DRIVER.                                                04770099
047800                                                                  04780099
047900     PERFORM A1000-INITIALIZE.                                    04790099
048000                                                                  04800099
048100     PERFORM B1000-PROCESS.                                       04810099
048200                                                                  04820099
048300     PERFORM Z9000-END-PROC.                                      04830099
048400                                                                  04840099
048500     GOBACK.                                                      04850099
048600                                                                  04860099
048700                                                                  04870099
048800******************************************************************04880099
048900* PREFORMS TASK INITIATION PROCESSING                             04890099
049000******************************************************************04900099
049100 A1000-INITIALIZE.                                                04910099
049200                                                                  04920099
049300     OPEN OUTPUT RPT-FILE.                                        04930099
049400                                                                  04940099
049500     ACCEPT CC-CNTL-CARD FROM SYSIN.                              04950099
049600     MOVE CC-DATE TO WS-SLS-DTE.                                  04960099
049700     MOVE CC-YY TO HD-YY.                                         04970099
049800     MOVE CC-MM TO HD-MM.                                         04980099
049900     MOVE CC-DD TO HD-DD.                                         04990099
050000                                                                  05000099
050100     MOVE FUNCTION CURRENT-DATE TO SYS-DATE-TIME.                 05010099
050200                                                                  05020099
050300     MOVE SYS-TIME (1:2) TO ST-BEG-HR.                            05030099
050400     MOVE SYS-TIME (3:2) TO ST-BEG-MN.                            05040099
050500                                                                  05050099
050600     MOVE SYS-DATE (1:2) TO SD-CC.                                05060099
050700     MOVE SYS-DATE (3:2) TO SD-YY.                                05070099
050800     MOVE SYS-DATE (5:2) TO SD-MONTH.                             05080099
050900     MOVE SYS-DATE (7:2) TO SD-DAY.                               05090099
051000                                                                  05100099
051100     PERFORM A2000-HDR-SETUP.                                     05110099
051200                                                                  05120099
051300******************************************************************05130099
051400* SETUP THE HEADER INFO                                           05140099
051500******************************************************************05150099
051600 A2000-HDR-SETUP.                                                 05160099
051700                                                                  05170099
051800     MOVE 'TFKRP005' TO DP132O-PROGRAM-NAME.                      05180099
051900     MOVE 1          TO DP132O-REPORT-NUMBER.                     05190099
052000                                                                  05200099
052100     MOVE SD-CC      TO DP132O-RUN-CENTURY.                       05210099
052200     MOVE SD-YY      TO DP132O-RUN-YEAR.                          05220099
052300     MOVE SD-MONTH   TO DP132O-RUN-MONTH.                         05230099
052400     MOVE SD-DAY     TO DP132O-RUN-DAY.                           05240099
052500                                                                  05250099
052600     MOVE ST-BEG-HR  TO DP132O-RUN-HOUR.                          05260099
052700     MOVE ST-BEG-MN  TO DP132O-RUN-MINUTE.                        05270099
052800                                                                  05280099
052900******************************************************************05290099
053000* MAIN PROCESS                                                    05300099
053100******************************************************************05310099
053200 B1000-PROCESS.                                                   05320099
053300                                                                  05330099
053400     PERFORM B2000-OPEN-CALL-BCK-CSR.                             05340099
053500                                                                  05350099
053600     PERFORM B3000-FETCH-CALL-BCK-CSR                             05360099
053700        UNTIL CALL-BCK-END-OF-FILE.                               05370099
053800                                                                  05380099
053900     PERFORM B4000-CLOSE-CALL-BCK-CSR.                            05390099
054000                                                                  05400099
054100                                                                  05410099
054200******************************************************************05420099
054300* OPEN CALL-BACK CURSOR                                           05430099
054400******************************************************************05440099
054500 B2000-OPEN-CALL-BCK-CSR.                                         05450099
054600                                                                  05460099
054700     EXEC SQL                                                     05470099
054800          OPEN CALL-BCK-CSR                                       05480099
054900     END-EXEC.                                                    05490099
055000                                                                  05500099
055100     IF SQLCODE NOT EQUAL ZERO                                    05510099
055200        MOVE SQLCODE                   TO PV-SQLCODE              05520099
055300        MOVE 'TEPTRN'                  TO PV-TABLE-NAME           05530099
055400        MOVE 'B2000-OPEN-CALL-BCK-CSR' TO PV-PARAGRAPH-NAME       05540099
055500                                                                  05550099
055600        STRING 'ERROR ON OPEN OF CALL-BCK CURSOR - SQLCODE= '     05560099
055700                PV-SQLCODE DELIMITED BY SIZE INTO                 05570099
055800                PV-OPERATION-MSG                                  05580099
055900        END-STRING                                                05590099
056000                                                                  05600099
056100        PERFORM Z1000-ABEND                                       05610099
056200     END-IF.                                                      05620099
056300                                                                  05630099
056400                                                                  05640099
056500******************************************************************05650099
056600* FETCH CALL-BACK CURSOR                                          05660099
056700******************************************************************05670099
056800 B3000-FETCH-CALL-BCK-CSR.                                        05680099
056900                                                                  05690099
057000     EXEC SQL                                                     05700099
057100         FETCH CALL-BCK-CSR                                       05710099
057200          INTO :EPTRN-PARTN-NBR                                   05720099
057300              ,:EPTRN-STR-NBR                                     05730099
057400              ,:EPTRN-RGST-ID                                     05740099
057500              ,:EPTRN-TRN-NBR                                     05750099
057600              ,:EPTRN-STRT-TM                                     05760099
057700              ,:EPTRN-SLS-CORR-SEQ-NBR                            05770099
057800              ,:EPTRN-TRN-TYP-CDE                                 05780099
057900              ,:EPTRN-ASSOC-ID                                    05790099
058000              ,:EPTRN-VOID-ABRT-CDE                               05800099
058100              ,:EPITM-SKU-SEQ-NBR                                 05810099
058200              ,:EPITM-SAL-RET-CDE                                 05820099
058300              ,:EPITM-UPC-NBR                                     05830099
058400              ,:EPITM-SKU-NBR                                     05840099
058500              ,:EPITM-SLD-QTY                                     05850099
058600              ,:EPITM-NET-CHRGD-AMT                               05860099
058700              ,:XST00010-SKU-DESC                                 05870099
058800              ,:EPPART-SLS-DTE                                    05880099
058900     END-EXEC.                                                    05890099
059000                                                                  05900099
059100     EVALUATE TRUE                                                05910099
059200        WHEN SQLCODE = ZERO                                       05920099
059300           ADD 1 TO PA-CALL-BCK-READ                              05930099
059400                                                                  05940099
059500           IF  FIRST-READ                                         05950099
059600               MOVE 'N' TO PS-FIRST-READ-SW                       05960099
059700               MOVE EPTRN-STR-NBR TO HD-STORE                     05970099
059800                                     WS-HOLD-STR-NBR              05980099
059900               PERFORM P1000-HDRS                                 05990099
060000           END-IF                                                 06000099
060100                                                                  06010099
060200           PERFORM C1000-PROCESS-ITEMS                            06020099
060300                                                                  06030099
060400        WHEN SQLCODE = PC-ROW-NOT-FOUND                           06040099
060500           SET CALL-BCK-END-OF-FILE TO TRUE                       06050099
060600                                                                  06060099
060700        WHEN OTHER                                                06070099
060800           MOVE SQLCODE                    TO PV-SQLCODE          06080099
060900           MOVE 'TEPTRN'                   TO PV-TABLE-NAME       06090099
061000           MOVE 'B3000-FETCH-CALL-BCK-CSR' TO PV-PARAGRAPH-NAME   06100099
061100                                                                  06110099
061200           STRING 'ERROR ON FETCH OF CALL-BCK CURSOR - SQLCODE= ' 06120099
061300                   PV-SQLCODE DELIMITED BY SIZE INTO              06130099
061400                   PV-OPERATION-MSG                               06140099
061500           END-STRING                                             06150099
061600                                                                  06160099
061700           PERFORM Z1000-ABEND                                    06170099
061800     END-EVALUATE.                                                06180099
061900                                                                  06190099
062000                                                                  06200099
062100******************************************************************06210099
062200* CLOSE CALL-BACK CURSOR                                          06220099
062300******************************************************************06230099
062400 B4000-CLOSE-CALL-BCK-CSR.                                        06240099
062500                                                                  06250099
062600     EXEC SQL                                                     06260099
062700          CLOSE CALL-BCK-CSR                                      06270099
062800     END-EXEC.                                                    06280099
062900                                                                  06290099
063000     IF SQLCODE NOT EQUAL ZERO                                    06300099
063100        MOVE SQLCODE                    TO PV-SQLCODE             06310099
063200        MOVE 'TEPTRN'                   TO PV-TABLE-NAME          06320099
063300        MOVE 'B4000-CLOSE-CALL-BCK-CSR' TO PV-PARAGRAPH-NAME      06330099
063400                                                                  06340099
063500        STRING 'ERROR ON CLOSE OF CALL-BCK CURSOR - SQLCODE= '    06350099
063600                PV-SQLCODE DELIMITED BY SIZE INTO                 06360099
063700                PV-OPERATION-MSG                                  06370099
063800        END-STRING                                                06380099
063900                                                                  06390099
064000        PERFORM Z1000-ABEND                                       06400099
064100     END-IF.                                                      06410099
064200                                                                  06420099
064300                                                                  06430099
064400******************************************************************06440099
064500* PROCESS THE CALLBACK RECORDS                                    06450099
064600*   - DO NOT PROCESS VOIDS FOR RETURNS                            06460099
064700*   - PROCESS DUMMY RECORDS FOR SALE ITEMS ONLY                   06470099
064800******************************************************************06480099
064900 C1000-PROCESS-ITEMS.                                             06490099
065000                                                                  06500099
065100     IF  EPTRN-STR-NBR = WS-HOLD-STR-NBR                          06510099
065200         CONTINUE                                                 06520099
065300     ELSE                                                         06530099
065400         MOVE EPTRN-STR-NBR TO HD-STORE                           06540099
065500                               WS-HOLD-STR-NBR                    06550099
065600         PERFORM P1000-HDRS                                       06560099
065700     END-IF.                                                      06570099
065800                                                                  06580099
065900                                                                  06590099
066000     IF  EPITM-SAL-RET-CDE = 'S'                                  06600099
066100         ADD 1 TO PA-SALE                                         06610099
066200                                                                  06620099
066300         PERFORM C2000-SETUP-CLBK-REC                             06630099
066400         PERFORM D1000-CHECK-FOR-DUMMYS                           06640099
066500                                                                  06650099
066600     ELSE                                                         06660099
066700         ADD 1 TO PA-RETURN                                       06670099
066800                                                                  06680099
066900         IF  EPTRN-VOID-ABRT-CDE = 'N'                            06690099
067000             PERFORM C2000-SETUP-CLBK-REC                         06700099
067100         END-IF                                                   06710099
067200     END-IF.                                                      06720099
067300                                                                  06730099
067400                                                                  06740099
067500******************************************************************06750099
067600* PROCESS THE RECORDS                                             06760099
067700******************************************************************06770099
067800 C2000-SETUP-CLBK-REC.                                            06780099
067900                                                                  06790099
068000     IF  EPITM-UPC-NBR = ZEROS                                    06800099
068100         MOVE EPITM-SKU-NBR TO DT-UPC-NBR                         06810099
068200     ELSE                                                         06820099
068300         MOVE EPITM-UPC-NBR TO DT-UPC-NBR                         06830099
068400     END-IF.                                                      06840099
068500                                                                  06850099
068600     MOVE 'Y'                 TO DT-CALL-BCK.                     06860099
068700     MOVE XST00010-SKU-DESC   TO DT-SKU-DESC.                     06870099
068800     MOVE EPITM-SLD-QTY       TO DT-QTY.                          06880099
068900     MOVE EPITM-NET-CHRGD-AMT TO DT-AMT.                          06890099
069000     MOVE EPTRN-RGST-ID       TO DT-REG-NBR.                      06900099
069100     MOVE EPTRN-TRN-NBR       TO DT-TRAN-NBR.                     06910099
069200     MOVE EPTRN-ASSOC-ID      TO DT-ASSOC-ID.                     06920099
069300                                                                  06930099
069400     PERFORM C3000-DET-TRAN-TYPE.                                 06940099
069500     PERFORM C4000-GET-CALLBK-ID.                                 06950099
069600                                                                  06960099
069700     PERFORM P2000-PRINT.                                         06970099
069800                                                                  06980099
069900                                                                  06990099
070000******************************************************************07000099
070100* DETERMINE THE TRAN TYPE                                         07010099
070200******************************************************************07020099
070300 C3000-DET-TRAN-TYPE.                                             07030099
070400                                                                  07040099
070500     MOVE SPACES TO DT-TRAN-TYPE.                                 07050099
070600                                                                  07060099
070700     IF  EPTRN-TRN-TYP-CDE = '01'                                 07070099
070800     OR  EPTRN-TRN-TYP-CDE = '02'                                 07080099
070900         MOVE 'ATTEMPTED SALE' TO DT-TRAN-TYPE                    07090099
071000     END-IF.                                                      07100099
071100                                                                  07110099
071200     IF  EPTRN-TRN-TYP-CDE = '21'                                 07120099
071300     AND EPITM-SAL-RET-CDE = 'S'                                  07130099
071400         MOVE 'ATTEMPTED SALE' TO DT-TRAN-TYPE                    07140099
071500     END-IF.                                                      07150099
071600                                                                  07160099
071700     IF  EPTRN-TRN-TYP-CDE = '11'                                 07170099
071800     OR  EPTRN-TRN-TYP-CDE = '12'                                 07180099
071900         MOVE 'RETURN' TO DT-TRAN-TYPE                            07190099
072000     END-IF.                                                      07200099
072100                                                                  07210099
072200     IF  EPTRN-TRN-TYP-CDE = '21'                                 07220099
072300     AND EPITM-SAL-RET-CDE = 'R'                                  07230099
072400         MOVE 'RETURN' TO DT-TRAN-TYPE                            07240099
072500     END-IF.                                                      07250099
072600                                                                  07260099
072700     IF  EPTRN-TRN-TYP-CDE = '24'                                 07270099
072800     OR  EPTRN-TRN-TYP-CDE = '25'                                 07280099
072900         MOVE 'PRICE ADJUSTMENT' TO DT-TRAN-TYPE                  07290099
073000     END-IF.                                                      07300099
073100                                                                  07310099
073200     IF  EPTRN-TRN-TYP-CDE = '46'                                 07320099
073300         MOVE 'ITEM INQUIRIES' TO DT-TRAN-TYPE                    07330099
073400     END-IF.                                                      07340099
073500                                                                  07350099
073600                                                                  07360099
073700******************************************************************07370099
073800* GET THE CALLBACK ID                                             07380099
073900******************************************************************07390099
074000 C4000-GET-CALLBK-ID.                                             07400099
074100                                                                  07410099
074200     EXEC SQL                                                     07420099
074300        SELECT B.USR_CLBK_ID                                      07430099
074400              ,B.CLBK_NM                                          07440099
074500                                                                  07450099
074600        INTO :TFT00002-USR-CLBK-ID                                07460099
074700            ,:TFT00002-CLBK-NM                                    07470099
074800                                                                  07480099
074900        FROM TFT_CLBK_MDSE A                                      07490099
075000            ,TFT_CLBK      B                                      07500099
075100                                                                  07510099
075200        WHERE A.SKU_NBR      = :EPITM-SKU-NBR                     07520099
075300          AND A.EFF_BEG_DTE <= :EPPART-SLS-DTE                    07530099
075400          AND A.EFF_END_DTE >= :EPPART-SLS-DTE                    07540099
075500                                                                  07550099
075600          AND A.CLBK_ID      = B.CLBK_ID                          07560099
075700          AND A.EFF_BEG_DTE = (SELECT MAX(C.EFF_BEG_DTE)          07570099
075800                               FROM TFT_CLBK_MDSE C               07580099
075900                               WHERE A.SKU_NBR = C.SKU_NBR        07590099
076000                             AND C.EFF_BEG_DTE <= :EPPART-SLS-DTE 07600099
076100                             AND C.EFF_END_DTE >= :EPPART-SLS-DTE)07610099
076200                                                                  07620099
076300        WITH UR                                                   07630099
076400     END-EXEC.                                                    07640099
076500                                                                  07650099
076600     EVALUATE TRUE                                                07660099
076700        WHEN SQLCODE = ZERO                                       07670099
076800             EVALUATE TFT00002-USR-CLBK-ID                        07680099
076900                 WHEN 11111                                       07690099
077000                      MOVE '     HOLD'   TO DT-CLBK-ID-X          07700099
077100                 WHEN 99999                                       07710099
077200                      MOVE '    DSTRY'   TO DT-CLBK-ID-X          07720099
077300                 WHEN OTHER                                       07730099
077400                      MOVE TFT00002-USR-CLBK-ID                   07740099
077500                                         TO DT-CLBK-ID            07750099
077600             END-EVALUATE                                         07760099
077700                                                                  07770099
077800        WHEN SQLCODE = PC-ROW-NOT-FOUND                           07780099
077900           MOVE ZEROS                TO DT-CLBK-ID                07790099
078000                                                                  07800099
078100        WHEN OTHER                                                07810099
078200           DISPLAY '          '                                   07820099
078300           DISPLAY 'SKU NBR = ' EPITM-SKU-NBR                     07830099
078400           DISPLAY 'SLS DTE = ' EPPART-SLS-DTE                    07840099
078500                                                                  07850099
078600           MOVE SQLCODE               TO PV-SQLCODE               07860099
078700           MOVE 'TFT_CLBK'            TO PV-TABLE-NAME            07870099
078800           MOVE 'C4000-GET-CALLBK-ID' TO PV-PARAGRAPH-NAME        07880099
078900                                                                  07890099
079000           STRING 'ERROR ON READ OF CALL-BCK TABLE - SQLCODE= '   07900099
079100                   PV-SQLCODE DELIMITED BY SIZE INTO              07910099
079200                   PV-OPERATION-MSG                               07920099
079300           END-STRING                                             07930099
079400                                                                  07940099
079500           PERFORM Z1000-ABEND                                    07950099
079600     END-EVALUATE.                                                07960099
079700                                                                  07970099
079800                                                                  07980099
079900******************************************************************07990099
080000* CHECK FOR DUMMY RECORDS                                         08000099
080100******************************************************************08010099
080200 D1000-CHECK-FOR-DUMMYS.                                          08020099
080300                                                                  08030099
080400     MOVE 'N' TO PS-ITM-EOF-SW.                                   08040099
080500                                                                  08050099
080600     PERFORM D2000-OPEN-ITM-CSR.                                  08060099
080700                                                                  08070099
080800     PERFORM D3000-FETCH-ITM-CSR                                  08080099
080900        UNTIL ITM-END-OF-FILE.                                    08090099
081000                                                                  08100099
081100     PERFORM D4000-CLOSE-ITM-CSR.                                 08110099
081200                                                                  08120099
081300                                                                  08130099
081400******************************************************************08140099
081500* OPEN ITEM CURSOR                                                08150099
081600******************************************************************08160099
081700 D2000-OPEN-ITM-CSR.                                              08170099
081800                                                                  08180099
081900     EXEC SQL                                                     08190099
082000          OPEN ITM-CSR                                            08200099
082100     END-EXEC.                                                    08210099
082200                                                                  08220099
082300     IF SQLCODE NOT EQUAL ZERO                                    08230099
082400        MOVE SQLCODE              TO PV-SQLCODE                   08240099
082500        MOVE 'TEPITM'             TO PV-TABLE-NAME                08250099
082600        MOVE 'D2000-OPEN-ITM-CSR' TO PV-PARAGRAPH-NAME            08260099
082700                                                                  08270099
082800        STRING 'ERROR ON OPEN OF ITM CURSOR - SQLCODE= '          08280099
082900                PV-SQLCODE DELIMITED BY SIZE INTO                 08290099
083000                PV-OPERATION-MSG                                  08300099
083100        END-STRING                                                08310099
083200                                                                  08320099
083300        PERFORM Z1000-ABEND                                       08330099
083400     END-IF.                                                      08340099
083500                                                                  08350099
083600                                                                  08360099
083700******************************************************************08370099
083800* FETCH ITEM CURSOR                                               08380099
083900******************************************************************08390099
084000 D3000-FETCH-ITM-CSR.                                             08400099
084100                                                                  08410099
084200     EXEC SQL                                                     08420099
084300         FETCH ITM-CSR                                            08430099
084400          INTO :EPITM-UPC-NBR                                     08440099
084500              ,:EPITM-SKU-NBR                                     08450099
084600              ,:EPITM-SLD-QTY                                     08460099
084700              ,:EPITM-NET-CHRGD-AMT                               08470099
084800     END-EXEC.                                                    08480099
084900                                                                  08490099
085000     EVALUATE TRUE                                                08500099
085100        WHEN SQLCODE = ZERO                                       08510099
085200           PERFORM D3100-SETUP-DUMMY                              08520099
085300                                                                  08530099
085400        WHEN SQLCODE = PC-ROW-NOT-FOUND                           08540099
085500           SET ITM-END-OF-FILE TO TRUE                            08550099
085600                                                                  08560099
085700        WHEN OTHER                                                08570099
085800           MOVE SQLCODE                    TO PV-SQLCODE          08580099
085900           MOVE 'TEPTRN'                   TO PV-TABLE-NAME       08590099
086000           MOVE 'D3000-FETCH-ITM-CSR' TO PV-PARAGRAPH-NAME        08600099
086100                                                                  08610099
086200           STRING 'ERROR ON FETCH OF ITM CURSOR - SQLCODE= '      08620099
086300                   PV-SQLCODE DELIMITED BY SIZE INTO              08630099
086400                   PV-OPERATION-MSG                               08640099
086500           END-STRING                                             08650099
086600                                                                  08660099
086700           PERFORM Z1000-ABEND                                    08670099
086800     END-EVALUATE.                                                08680099
086900                                                                  08690099
087000                                                                  08700099
087100******************************************************************08710099
087200* SETUP THE DUMMY RECORD                                          08720099
087300*   - IF LAST 3 BYTES OF SKU EQUAL ZEROS, THEN ITS A DUMMY REC    08730099
087400******************************************************************08740099
087500 D3100-SETUP-DUMMY.                                               08750099
087600                                                                  08760099
087700     MOVE EPITM-SKU-NBR TO WS-SKU-NBR.                            08770099
087800                                                                  08780099
087900     IF  WS-SKU-NBR (6:3) = ZEROS                                 08790099
088000         ADD 1 TO PA-SALE-DUMMY                                   08800099
088100                                                                  08810099
088200         IF  EPITM-UPC-NBR = ZEROS                                08820099
088300             MOVE EPITM-SKU-NBR   TO DT-UPC-NBR                   08830099
088400         ELSE                                                     08840099
088500             MOVE EPITM-UPC-NBR   TO DT-UPC-NBR                   08850099
088600         END-IF                                                   08860099
088700                                                                  08870099
088800         MOVE SPACE               TO DT-CALL-BCK                  08880099
088900         MOVE 'DUMMY SKU'         TO DT-SKU-DESC                  08890099
089000         MOVE 'SALE'              TO DT-TRAN-TYPE                 08900099
089100         MOVE EPITM-SLD-QTY       TO DT-QTY                       08910099
089200         MOVE EPITM-NET-CHRGD-AMT TO DT-AMT                       08920099
089300         MOVE EPTRN-RGST-ID       TO DT-REG-NBR                   08930099
089400         MOVE EPTRN-TRN-NBR       TO DT-TRAN-NBR                  08940099
089500         MOVE EPTRN-ASSOC-ID      TO DT-ASSOC-ID                  08950099
089600         MOVE ZEROS               TO DT-CLBK-ID                   08960099
089700                                                                  08970099
089800         PERFORM P2000-PRINT                                      08980099
089900     END-IF.                                                      08990099
090000                                                                  09000099
090100                                                                  09010099
090200******************************************************************09020099
090300* CLOSE ITEM CURSOR                                               09030099
090400******************************************************************09040099
090500 D4000-CLOSE-ITM-CSR.                                             09050099
090600                                                                  09060099
090700     EXEC SQL                                                     09070099
090800          CLOSE ITM-CSR                                           09080099
090900     END-EXEC.                                                    09090099
091000                                                                  09100099
091100     IF SQLCODE NOT EQUAL ZERO                                    09110099
091200        MOVE SQLCODE                    TO PV-SQLCODE             09120099
091300        MOVE 'TEPTRN'                   TO PV-TABLE-NAME          09130099
091400        MOVE 'D4000-CLOSE-ITM-CSR' TO PV-PARAGRAPH-NAME           09140099
091500                                                                  09150099
091600        STRING 'ERROR ON CLOSE OF ITM CURSOR - SQLCODE= '         09160099
091700                PV-SQLCODE DELIMITED BY SIZE INTO                 09170099
091800                PV-OPERATION-MSG                                  09180099
091900        END-STRING                                                09190099
092000                                                                  09200099
092100        PERFORM Z1000-ABEND                                       09210099
092200     END-IF.                                                      09220099
092300                                                                  09230099
092400                                                                  09240099
092500******************************************************************09250099
092600* PRINT THE REPORT HEADINGS                                       09260099
092700******************************************************************09270099
092800 P1000-HDRS.                                                      09280099
092900                                                                  09290099
093000     MOVE ZEROS TO PA-LINE-CNT.                                   09300099
093100                                                                  09310099
093200     ADD 1 TO PA-PAGE-CNT.                                        09320099
093300     MOVE PA-PAGE-CNT TO DP132O-PAGE-NUMBER.                      09330099
093400                                                                  09340099
093500     WRITE PRT-REC                                                09350099
093600           FROM DP132O-STANDRD-HEADER-132-COLS AFTER PAGE.        09360099
093700                                                                  09370099
093800     WRITE PRT-REC FROM PV-HDR1 AFTER 1.                          09380099
093900     WRITE PRT-REC FROM PV-HDR2 AFTER 2.                          09390099
094000     WRITE PRT-REC FROM PV-HDR3 AFTER 2.                          09400099
094100     WRITE PRT-REC FROM PV-HDR4 AFTER 1.                          09410099
094200     WRITE PRT-REC FROM PV-HDR5 AFTER 1.                          09420099
094300                                                                  09430099
094400     ADD 8 TO PA-LINE-CNT.                                        09440099
094500                                                                  09450099
094600                                                                  09460099
094700******************************************************************09470099
094800* PRINT THE REPORT DETAIL LINES                                   09480099
094900******************************************************************09490099
095000 P2000-PRINT.                                                     09500099
095100                                                                  09510099
095200     IF  PA-LINE-CNT > PC-MAX-LINES                               09520099
095300         PERFORM P1000-HDRS                                       09530099
095400     END-IF.                                                      09540099
095500                                                                  09550099
095600     WRITE PRT-REC FROM PV-DTL1 AFTER 1.                          09560099
095700                                                                  09570099
095800     ADD 1 TO PA-LINE-CNT                                         09580099
095900              PA-WRITTEN.                                         09590099
096000                                                                  09600099
096100                                                                  09610099
096200******************************************************************09620099
096300* ABEND ROUTINE                                                   09630099
096400******************************************************************09640099
096500 Z1000-ABEND.                                                     09650099
096600                                                                  09660099
096700     PERFORM Z9000-END-PROC.                                      09670099
096800                                                                  09680099
096900     MOVE SQLCODE TO SQLCODE2.                                    09690099
097000     MOVE SQLERRD(3) TO SQLERRD3.                                 09700099
097100                                                                  09710099
097200     DISPLAY 'Z1000-ABEND'.                                       09720099
097300     DISPLAY '** ABEND           ** = SQLABEND'.                  09730099
097400     DISPLAY '** PROGRAM         ** = ' PC-PROGRAM-NAME.          09740099
097500     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        09750099
097600     DISPLAY '** TABLES AFFECTED ** = ' PV-TABLE-NAME.            09760099
097700     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG.         09770099
097800     DISPLAY '** SQLCODE         ** = ' SQLCODE2.                 09780099
097900     DISPLAY '** ROWS PROCESSED  ** = ' SQLERRD3.                 09790099
098000     DISPLAY '** SQLERRM         ** = ' SQLERRM.                  09800099
098100     DISPLAY '** SQLERRMC        ** = ' SQLERRMC.                 09810099
098200                                                                  09820099
098300******************************************************************09830099
098400*  THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-   09840099
098500*  MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE        09850099
098600* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     09860099
098700*  FORMAT.                                                        09870099
098800******************************************************************09880099
098900     COPY DPPD004.                                                09890099
099000                                                                  09900099
099100     SET ABEND-4013-DB2-ERROR TO TRUE.                            09910099
099200                                                                  09920099
099300     CALL 'ILBOABN0' USING ABEND-CODE.                            09930099
099400                                                                  09940099
099500                                                                  09950099
099600******************************************************************09960099
099700* PREFORMS TASK TERMINATION PROCESSING                            09970099
099800******************************************************************09980099
099900 Z9000-END-PROC.                                                  09990099
100000                                                                  10000099
100100     IF  PA-WRITTEN = ZERO                                        10010099
100200         PERFORM P1000-HDRS                                       10020099
100300         WRITE PRT-REC FROM PV-DTL2 AFTER 2                       10030099
100400     END-IF.                                                      10040099
100500                                                                  10050099
100600     CLOSE RPT-FILE.                                              10060099
100700                                                                  10070099
100800     PERFORM Z9100-CONTROLS.                                      10080099
100900                                                                  10090099
101000                                                                  10100099
101100******************************************************************10110099
101200* PROGRAM CONTROLS                                                10120099
101300******************************************************************10130099
101400 Z9100-CONTROLS.                                                  10140099
101500                                                                  10150099
101600     MOVE FUNCTION CURRENT-DATE TO SYS-DATE-TIME.                 10160099
101700                                                                  10170099
101800     MOVE SYS-TIME (1:2) TO ST-END-HR.                            10180099
101900     MOVE SYS-TIME (3:2) TO ST-END-MN.                            10190099
102000                                                                  10200099
102100     DISPLAY '                    '.                              10210099
102200     DISPLAY '**********************'.                            10220099
102300     DISPLAY '   TFKRP005 CONTROLS  '.                            10230099
102400     DISPLAY '**********************'.                            10240099
102500     DISPLAY 'RUN DATE  = ' SD-EDIT-DATE.                         10250099
102600     DISPLAY 'BEG TIME  = ' ST-BEG-TIME.                          10260099
102700     DISPLAY 'END TIME  = ' ST-END-TIME.                          10270099
102800     DISPLAY '======================'.                            10280099
102900     DISPLAY 'CNTL CARD: ' CC-DATE.                               10290099
103000     DISPLAY '            '.                                      10300099
103100     DISPLAY 'CALL BACK = ' PA-CALL-BCK-READ.                     10310099
103200     DISPLAY '                    '.                              10320099
103300     DISPLAY 'SALE      = ' PA-SALE.                              10330099
103400     DISPLAY '  DUMMY   = ' PA-SALE-DUMMY.                        10340099
103500     DISPLAY '            '.                                      10350099
103600     DISPLAY 'RETURN    = ' PA-RETURN.                            10360099
103700     DISPLAY '  VALID   = ' PA-RETURN-VALID.                      10370099
103800     DISPLAY '  DUMMY   = ' PA-RETURN-DUMMY.                      10380099
103900     DISPLAY '                    '.                              10390099
104000                                                                  10400099
104100                                                                  10410099
