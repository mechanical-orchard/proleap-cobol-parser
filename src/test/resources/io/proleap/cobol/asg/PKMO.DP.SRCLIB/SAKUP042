000100 IDENTIFICATION DIVISION.                                         00010000
000200                                                                  00020000
000300 PROGRAM-ID.      SAKUP042.                                       00030001
000400 AUTHOR.          DAVID WELLER.                                   00040000
000500 INSTALLATION.    KOHLS DEPARTMENT STORES.                        00050000
000600 DATE-WRITTEN.    09/03/13.                                       00060001
000700 DATE-COMPILED.                                                   00070000
000800                                                                  00080000
000900******************************************************************00090000
001000*  MODULE TYPE:   COBOL2 DB2 BATCH.                               00100000
001100*                                                                 00110000
001200*  DESCRIPTION: PROGRAM UPDATES THE TSAADSU TABLE WITH THE DATA   00120000
001300*               PULLED IN PROGRAM SAKUT116                        00130001
001400*                                                                 00140000
C53632*========================== CHANGE LOG ===========================00150000
C53632*  AUTH        BY           DATE    DESCRIPTION                   00160002
C53632*=================================================================00170000
C53632* CHG53632    TKMA602     09-03-13  CREATE PROGRAM                00180002
C53632*                                                                 00190000
260107* CHG0260107  JIM HUNTER  08-19-21  ADD COPYBOOK DPWS991 TO MAKE  00191002
260107*                                   THE CALL TO DPKUT901 DYNAMIC. 00192002
C53632******************************************************************00200000
002100                                                                  00210000
002200 ENVIRONMENT DIVISION.                                            00220000
002300 CONFIGURATION SECTION.                                           00230000
002400                                                                  00240000
002500 SOURCE-COMPUTER.    IBM-3090.                                    00250000
002600 OBJECT-COMPUTER.    IBM-3090.                                    00260000
002700                                                                  00270000
002800 INPUT-OUTPUT SECTION.                                            00280000
002900 FILE-CONTROL.                                                    00290000
003000                                                                  00300000
003100 DATA DIVISION.                                                   00310000
003200 FILE SECTION.                                                    00320000
003300                                                                  00330000
003400                                                                  00340000
003500***************************************************************** 00350000
003600*                       WORKING STORAGE                           00360000
003700***************************************************************** 00370000
003800 WORKING-STORAGE SECTION.                                         00380000
003900                                                                  00390000
004000 01  W-START                          PIC  X(40)                  00400000
004100     VALUE 'SAKUP042 - WORKING STORAGE BEGINS HERE'.              00410001
004200                                                                  00420000
004300                                                                  00430000
004400***************************************************************** 00440000
004500*                         SWITCHES                                00450000
004600***************************************************************** 00460000
004700 01  PROGRAM-SWITCHES.                                            00470000
004800     05  PS-RESTART-REQUIRED-SW       PIC  X(01) VALUE 'N'.       00480000
004900         88  PS-RESTART-REQUIRED                 VALUE 'Y'.       00490000
005000         88  PS-RESTART-NOT-REQUIRED             VALUE 'N'.       00500000
005100                                                                  00510000
005200******************************************************************00520000
005300*                       ACCUMULATORS                              00530000
005400******************************************************************00540000
005500 01  PROGRAM-ACCUM.                                               00550000
005600     05  PA-READ                      PIC  9(11) VALUE ZEROS.     00560000
005700                                                                  00570000
005800******************************************************************00580000
005900*                           CONSTANTS                             00590000
006000******************************************************************00600000
006100 01  PROGRAM-CONSTANTS.                                           00610000
006200     05  PC-MAX-RETRIES               PIC S9(04) VALUE +3         00620000
006300                                                 COMP SYNC.       00630000
006400     05  PC-MAX-DEADLOCKS             PIC S9(04) VALUE +3         00640000
006500                                                 COMP SYNC.       00650000
006600                                                                  00660000
006700     05  PC-CKPT-JOB-NAME             PIC  X(08) VALUE 'SAK945  '.00670001
006800     05  PC-CKPT-PLAN-NAME            PIC  X(08) VALUE 'SAKUP042'.00680001
006900     05  PC-PROGRAM-NAME              PIC  X(08) VALUE 'SAKUP042'.00690001
007000                                                                  00700000
007100     05  PC-TRAN-PRES-FUNC-CODES.                                 00710000
007200         10  PC-TRAN-PRES-FUNC-OPEN   PIC  X(05) VALUE 'OPEN '.   00720000
007300         10  PC-TRAN-PRES-FUNC-TRANS  PIC  X(05) VALUE 'TRANS'.   00730000
007400         10  PC-TRAN-PRES-FUNC-RSTRT  PIC  X(05) VALUE 'RSTRT'.   00740000
007500         10  PC-TRAN-PRES-FUNC-CLOSE  PIC  X(05) VALUE 'CLOSE'.   00750000
007600                                                                  00760000
007700     05  PC-MINUS-ONE                 PIC S9(01) VALUE -1.        00770000
007800     05  PC-SYSTEM                    PIC  X(08) VALUE 'SYSTEM  '.00780000
007900                                                                  00790000
008000******************************************************************00800000
008100*                          VARIABLES                              00810000
008200******************************************************************00820000
008300 01  PROGRAM-VARIABLES.                                           00830000
008400     05  PV-SQL-SUB                   PIC  9(03) VALUE ZERO.      00840000
008500     05  PV-DEADLOCK-COUNTER          PIC  9(03) VALUE ZERO.      00850000
008600     05  PV-PARAGRAPH-NAME            PIC  X(30) VALUE SPACE.     00860000
008700     05  PV-DB2-OPER-ATTEMPTED        PIC  X(30) VALUE SPACE.     00870000
008800     05  PV-OPERATION-MSG             PIC  X(35) VALUE SPACE.     00880000
008900     05  PV-RET-CODE                  PIC  9(04) VALUE ZEROS.     00890000
009000                                                                  00900000
009100******************************************************************00910000
009200*               SYSTEM TIME AND DATE VARIABLES                    00920000
009300******************************************************************00930000
009400 01  SYS-DATE-TIME.                                               00940000
009500     05  SYS-DATE                     PIC  X(08) VALUE SPACES.    00950000
009600     05  SYS-TIME                     PIC  X(08) VALUE SPACES.    00960000
009700                                                                  00970000
009800 01  ST-BEG-TIME.                                                 00980000
009900     05  ST-BEG-HR                    PIC  9(02) VALUE ZEROS.     00990000
010000     05  FILLER                       PIC  X(01) VALUE ':'.       01000000
010100     05  ST-BEG-MN                    PIC  9(02) VALUE ZEROS.     01010000
010200                                                                  01020000
010300 01  ST-END-TIME.                                                 01030000
010400     05  ST-END-HR                    PIC  9(02) VALUE ZEROS.     01040000
010500     05  FILLER                       PIC  X(01) VALUE ':'.       01050000
010600     05  ST-END-MN                    PIC  9(02) VALUE ZEROS.     01060000
010700                                                                  01070000
010800 01  SD-EDIT-DATE.                                                01080000
010900     05  SD-MONTH                     PIC  9(02) VALUE ZEROS.     01090000
011000     05  FILLER                       PIC  X(01) VALUE '-'.       01100000
011100     05  SD-DAY                       PIC  9(02) VALUE ZEROS.     01110000
011200     05  FILLER                       PIC  X(01) VALUE '-'.       01120000
011300     05  SD-CENT                      PIC  9(02) VALUE ZEROS.     01130000
011400     05  SD-YEAR                      PIC  9(02) VALUE ZEROS.     01140000
011500                                                                  01150000
011600******************************************************************01160000
011700*                        ERROR HANDLING                           01170000
011800******************************************************************01180000
011900 01  ABEND-CODE                       PIC S9(04) VALUE ZEROS      01190000
012000                                                 COMP SYNC.       01200000
012100     88  ABEND-4002-READ-ERROR                   VALUE +4002.     01210000
012200     88  ABEND-4013-DB2-ERROR                    VALUE +4013.     01220000
012300     88  ABEND-4019-CAL-SUB-ERROR                VALUE +4019.     01230000
012400                                                                  01240000
012500                                                                  01250000
012600******************************************************************01260000
012700*  TSAADSU - STORE TOTALS RECORD LAYOUT                           01270000
012800******************************************************************01280000
012900     COPY SARD007.                                                01290000
013000                                                                  01300000
013100******************************************************************01310000
013200*  DB2 FORMATTED ERROR MESSAGE                                    01320000
013300******************************************************************01330000
013400     COPY DPWS004.                                                01340000
013500                                                                  01350000
013600******************************************************************01360000
013700*  SQL COMMUNICATIONS WORK AREA                                   01370000
013800******************************************************************01380000
013900     COPY SQLCA2.                                                 01390000
014000                                                                  01400000
014100******************************************************************01410000
014200*  COMMUNICATIONS AREA FOR DB2                                    01420000
014300******************************************************************01430000
014400     EXEC SQL                                                     01440000
014500         INCLUDE SQLCA                                            01450000
014600     END-EXEC.                                                    01460000
014700                                                                  01470000
014800******************************************************************01480000
014900*  DB2 TABLE TSAADSU - STORE TOTALS TABLE                         01490000
015000******************************************************************01500000
015100     EXEC SQL                                                     01510000
015200          INCLUDE TSAADSU                                         01520000
015300     END-EXEC.                                                    01530000
015400                                                                  01540000
015500******************************************************************01550000
015600*  TRANSACTION PREPARATION MODULE COMMUNICATIONS AREA             01560000
015700******************************************************************01570000
260107     COPY DPWS991.                                                01580002
015800                                                                  01581002
015800     COPY DPLS001.                                                01582002
015900     05  WORK-STORAGE-PASSED.                                     01590000
016000******************************************************************01600000
016100*PA - PROGRAM ACCUMULATORS                                        01610000
016200******************************************************************01620000
016300         10  PROGRAM-ACCUMULATORS.                                01630000
016400             15  PA-ROWS-INSERTED PIC S9(11)           VALUE ZERO 01640000
016500                                                       COMP-3.    01650000
016600                                                                  01660000
016400             15  PA-ROWS-UPDATED  PIC S9(11)           VALUE ZERO 01661000
016500                                                       COMP-3.    01662000
016600                                                                  01663000
044600                                                                  01664000
016700 01  FILLER                          PIC X(4096)  VALUE SPACE.    01665000
016800                                                                  01666000
016900                                                                  01667000
017000                                                                  01668000
017100 PROCEDURE DIVISION.                                              01669000
017200******************************************************************01670000
017300* MAINLINE-PROCESSING                                             01680000
017400******************************************************************01690000
017500                                                                  01700000
017600     PERFORM A100-INITIALIZE.                                     01710000
017700                                                                  01720000
017800     PERFORM B100-PROCESS-UPDATE-RECORDS                          01730000
017900       UNTIL DP001-PREP-TRANS-EOF.                                01740000
018000                                                                  01750000
018100     PERFORM Z990-EOJ-ROUTINE.                                    01760000
018200                                                                  01770000
018300     GOBACK.                                                      01780000
018400                                                                  01790000
018500                                                                  01800000
018600******************************************************************01810000
018700* PREFORMS TASK INITIATION                                        01820000
018800******************************************************************01830000
018900 A100-INITIALIZE.                                                 01840000
019000                                                                  01850000
019100     MOVE FUNCTION CURRENT-DATE TO SYS-DATE-TIME.                 01860000
019200                                                                  01870000
019300     MOVE SYS-TIME (1:2) TO ST-BEG-HR.                            01880000
019400     MOVE SYS-TIME (3:2) TO ST-BEG-MN.                            01890000
019500                                                                  01900000
019600     MOVE SYS-DATE (1:2) TO SD-CENT.                              01910000
019700     MOVE SYS-DATE (3:2) TO SD-YEAR.                              01920000
019800     MOVE SYS-DATE (5:2) TO SD-MONTH.                             01930000
019900     MOVE SYS-DATE (7:2) TO SD-DAY.                               01940000
020000                                                                  01950000
020100     MOVE PC-TRAN-PRES-FUNC-OPEN TO DP001-FUNC-CODE.              01960000
020200                                                                  01970000
020300     PERFORM X100-BUILD-COMM-AREA-TRAN-PRES.                      01980000
020400                                                                  01990000
020500                                                                  02000000
020600******************************************************************02010000
020700* PROCESS UPDATE RECORDS                                          02020000
020800******************************************************************02030000
020900 B100-PROCESS-UPDATE-RECORDS.                                     02040000
021000                                                                  02050000
021100     SET PS-RESTART-NOT-REQUIRED TO TRUE.                         02060000
021200                                                                  02070000
021300     PERFORM C100-UPDATE-FIELDS.                                  02080000
021200                                                                  02090000
027000     IF SQLCODE = +100                                            02100000
027000         PERFORM C300-TSAADSU-INSERT                              02110000
027000     END-IF.                                                      02120000
021400                                                                  02130000
021500*----------------------------------------------------------------*02140000
021600*  IF A RESTART IS REQUIRED, ISSUE A RESTART CALL RATHER THAN A  *02150000
021700*  TRANS CALL.  THIS WILL ALLOW PROCESSING TO RESUME WITH THE    *02160000
021800*  FIRST TRANSACTION AFTER THE LAST COMMIT.                      *02170000
021900*----------------------------------------------------------------*02180000
022000     IF  PS-RESTART-REQUIRED                                      02190000
022100         MOVE PC-TRAN-PRES-FUNC-RSTRT TO DP001-FUNC-CODE          02200000
022200     ELSE                                                         02210000
022300         MOVE PC-TRAN-PRES-FUNC-TRANS TO DP001-FUNC-CODE          02220000
022400     END-IF.                                                      02230000
022500                                                                  02240000
022600     PERFORM X100-BUILD-COMM-AREA-TRAN-PRES.                      02250000
022700                                                                  02260000
022800     ADD 1 TO PA-READ.                                            02270000
022900                                                                  02280000
023000                                                                  02290000
023100******************************************************************02300000
023200* UPDATES THE TSAADSU FIELDS                                      02310000
023300******************************************************************02320000
023400 C100-UPDATE-FIELDS.                                              02330000
023500                                                                  02340000
023600     MOVE SA007-SLS-DTE        TO SAADSU-SLS-DTE.                 02350000
023700     MOVE SA007-STR-NBR        TO SAADSU-STR-NBR.                 02360000
023800     MOVE SA007-SUM-CTG-CDE    TO SAADSU-SUM-CTG-CDE.             02370000
023900     MOVE SA007-ORIG-AMT       TO SAADSU-ORIG-AMT.                02380000
024000     MOVE SA007-ADJ-AMT        TO SAADSU-ADJ-AMT.                 02390000
024100     MOVE SA007-ADJ-IND        TO SAADSU-ADJ-IND.                 02400000
024200                                                                  02410000
024300     PERFORM WITH TEST AFTER                                      02420000
024400         VARYING PV-SQL-SUB                                       02430000
024500         FROM 1 BY 1                                              02440000
024600         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       02450000
024700                OR SQLCODE = -911                                 02460000
024700                OR SQLCODE = +100                                 02470000
024800                OR SQLCODE = 0)                                   02480000
024900                                                                  02490000
025000         EXEC SQL                                                 02500000
025100             UPDATE TSAADSU                                       02510000
025100              SET ORIG_AMT = ORIG_AMT + :SAADSU-ORIG-AMT          02511000
025200                , ADJ_AMT  = ADJ_AMT + :SAADSU-ADJ-AMT            02512000
025200             WHERE SLS_DTE     = :SAADSU-SLS-DTE                  02513000
025200               AND STR_NBR     = :SAADSU-STR-NBR                  02514000
025400               AND SUM_CTG_CDE = :SAADSU-SUM-CTG-CDE              02515000
026500         END-EXEC                                                 02516000
026600                                                                  02517000
026700         EVALUATE TRUE                                            02518000
026800             WHEN SQLCODE = 0                                     02519000
026900                 ADD +1 TO PA-ROWS-UPDATED                        02520000
027000                                                                  02530000
027000             WHEN SQLCODE = +100                                  02540000
026900                 ADD +1 TO PA-ROWS-INSERTED                       02550000
027000                                                                  02560000
027100             WHEN SQLCODE = -911                                  02570000
027200                 ADD +1 TO PV-DEADLOCK-COUNTER                    02580000
027300                                                                  02590000
027400                 DISPLAY '                   '                    02600000
027500                 DISPLAY 'DEADLOCK INCOUNTERED -911'              02610000
027600                 DISPLAY 'DEADLOCK-COUNTER = ' PV-DEADLOCK-COUNTER02620000
027700                                                                  02630000
027800                 IF PV-DEADLOCK-COUNTER > PC-MAX-DEADLOCKS        02640000
027900                     MOVE 'C100-UPDATE-FIELDS'                    02650000
028000                                      TO PV-PARAGRAPH-NAME        02660000
028100                     MOVE 'MAXIMUM DEADLOCKS EXCEEDED    '        02670000
028200                                      TO PV-DB2-OPER-ATTEMPTED    02680000
028300                     PERFORM Z200-SQL-ABEND                       02690000
028400                                                                  02700000
028500                 ELSE                                             02710000
028600                     SET PS-RESTART-REQUIRED TO TRUE              02720000
028700                 END-IF                                           02730000
028800                                                                  02740000
028900             WHEN OTHER                                           02750000
029000                 DISPLAY '                   '                    02760000
029100                 DISPLAY 'SQLCODE = ' SQLCODE                     02770000
029200                 DISPLAY 'DP001-FUNC-CODE = ' DP001-FUNC-CODE     02780000
029300                 DISPLAY 'DP001-RET-CODE  = ' DP001-RET-CODE      02790000
029400                 DISPLAY '                   '                    02800000
029500                 DISPLAY 'UPDATE ABENDED ON: '                    02810000
029600                 DISPLAY 'SLS-DTE  = ' SAADSU-SLS-DTE             02820000
029700                 DISPLAY 'STR-NBR  = ' SAADSU-STR-NBR             02830000
029800                 DISPLAY 'SUM-CTG  = ' SAADSU-SUM-CTG-CDE         02840000
029900                 DISPLAY 'ORIG-AMT = ' SAADSU-ORIG-AMT            02850000
030000                 DISPLAY 'ADJ-AMT  = ' SAADSU-ADJ-AMT             02860000
030100                 DISPLAY 'ADJ-IND  = ' SAADSU-ADJ-IND             02870000
030200                                                                  02880000
030300                 MOVE 'C100-UPDATE-FIELDS'                        02890000
030400                                        TO PV-PARAGRAPH-NAME      02900000
030500                 MOVE 'TSAADSU INSERT'                            02910000
030600                                        TO PV-DB2-OPER-ATTEMPTED  02920000
030700                                                                  02930000
030800                 PERFORM Z200-SQL-ABEND                           02940000
030900         END-EVALUATE                                             02950000
031000     END-PERFORM.                                                 02960000
031100                                                                  02970000
031100******************************************************************02980000
023200* INSERT THE TSAADSU FIELDS                                       02990000
031100******************************************************************03000000
031100                                                                  03010000
027000 C300-TSAADSU-INSERT.                                             03020000
031200                                                                  03030000
031300     IF PV-SQL-SUB > PC-MAX-RETRIES                               03040000
031400         MOVE 'C300-TSAADSU-INSERT'     TO PV-PARAGRAPH-NAME      03050000
031500         MOVE 'VERIFY RETRIES EXCEEDED' TO PV-DB2-OPER-ATTEMPTED  03060000
031600         PERFORM Z200-SQL-ABEND                                   03070000
031700     END-IF.                                                      03080000
031800                                                                  03090000
024300     PERFORM WITH TEST AFTER                                      03100000
024400         VARYING PV-SQL-SUB                                       03110000
024500         FROM 1 BY 1                                              03120000
024600         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       03130000
024700                OR SQLCODE = -911                                 03140000
024800                OR SQLCODE = 0)                                   03150000
024900                                                                  03160000
025000         EXEC SQL                                                 03170000
025100             INSERT  INTO TSAADSU                                 03180000
025200                  (  SLS_DTE                                      03181000
025300                  ,  STR_NBR                                      03182000
025400                  ,  SUM_CTG_CDE                                  03183000
025500                  ,  ORIG_AMT                                     03184000
025600                  ,  ADJ_AMT                                      03185000
025700                  ,  ADJ_IND)                                     03186000
025800              VALUES                                              03187000
025900                  (  :SAADSU-SLS-DTE                              03188000
026000                  ,  :SAADSU-STR-NBR                              03189000
026100                  ,  :SAADSU-SUM-CTG-CDE                          03190000
026200                  ,  :SAADSU-ORIG-AMT                             03190100
026300                  ,  :SAADSU-ADJ-AMT                              03190200
026400                  ,  :SAADSU-ADJ-IND)                             03190300
026500         END-EXEC                                                 03190400
026600                                                                  03190500
026700         EVALUATE TRUE                                            03190600
026800             WHEN SQLCODE = 0                                     03190700
026900                 ADD +1 TO PA-ROWS-INSERTED                       03190800
027000                                                                  03190900
027100             WHEN SQLCODE = -911                                  03191000
027200                 ADD +1 TO PV-DEADLOCK-COUNTER                    03191100
027300                                                                  03191200
027400                 DISPLAY '                   '                    03191300
027500                 DISPLAY 'DEADLOCK INCOUNTERED -911'              03191400
027600                 DISPLAY 'DEADLOCK-COUNTER = ' PV-DEADLOCK-COUNTER03191500
027700                                                                  03191600
027800                 IF PV-DEADLOCK-COUNTER > PC-MAX-DEADLOCKS        03191700
027900                     MOVE 'C300-INSERT-FIELDS'                    03191800
028000                                      TO PV-PARAGRAPH-NAME        03191900
028100                     MOVE 'MAXIMUM DEADLOCKS EXCEEDED    '        03192000
028200                                      TO PV-DB2-OPER-ATTEMPTED    03192100
028300                     PERFORM Z200-SQL-ABEND                       03192200
028400                                                                  03192300
028500                 ELSE                                             03192400
028600                     SET PS-RESTART-REQUIRED TO TRUE              03192500
028700                 END-IF                                           03192600
028800                                                                  03192700
028900             WHEN OTHER                                           03192800
029000                 DISPLAY '                   '                    03192900
029100                 DISPLAY 'SQLCODE = ' SQLCODE                     03193000
029200                 DISPLAY 'DP001-FUNC-CODE = ' DP001-FUNC-CODE     03193100
029300                 DISPLAY 'DP001-RET-CODE  = ' DP001-RET-CODE      03193200
029400                 DISPLAY '                   '                    03193300
029500                 DISPLAY 'INSERT ABENDED ON: '                    03193400
029600                 DISPLAY 'SLS-DTE  = ' SAADSU-SLS-DTE             03193500
029700                 DISPLAY 'STR-NBR  = ' SAADSU-STR-NBR             03193600
029800                 DISPLAY 'SUM-CTG  = ' SAADSU-SUM-CTG-CDE         03193700
029900                 DISPLAY 'ORIG-AMT = ' SAADSU-ORIG-AMT            03193800
030000                 DISPLAY 'ADJ-AMT  = ' SAADSU-ADJ-AMT             03193900
030100                 DISPLAY 'ADJ-IND  = ' SAADSU-ADJ-IND             03194000
030200                                                                  03194100
030300                 MOVE 'C300-INSERT-FIELDS'                        03194200
030400                                        TO PV-PARAGRAPH-NAME      03194300
030500                 MOVE 'TSAADSU INSERT'                            03194400
030600                                        TO PV-DB2-OPER-ATTEMPTED  03194500
030700                                                                  03194600
030800                 PERFORM Z200-SQL-ABEND                           03194700
030900         END-EVALUATE                                             03194800
031000     END-PERFORM.                                                 03194900
031100                                                                  03195000
031200                                                                  03195100
031300     IF PV-SQL-SUB > PC-MAX-RETRIES                               03195200
031400         MOVE 'C300-INSERT-FIELDS'      TO PV-PARAGRAPH-NAME      03195300
031500         MOVE 'VERIFY RETRIES EXCEEDED' TO PV-DB2-OPER-ATTEMPTED  03195400
031600         PERFORM Z200-SQL-ABEND                                   03195500
031700     END-IF.                                                      03195600
031800                                                                  03195700
031900                                                                  03195800
032000******************************************************************03195900
032100* BUILD THE COMMUNICATION AREA FOR A CALL TO THE TRANSACTION      03196000
032200* PRESENTATION MODULE                                             03197000
032300******************************************************************03198000
032400 X100-BUILD-COMM-AREA-TRAN-PRES.                                  03199000
032500                                                                  03200000
032600     MOVE LENGTH OF                                               03210000
032700          WORK-STORAGE-PASSED TO DP001-WORK-STRG-LENGTH.          03220000
032800     MOVE PC-CKPT-JOB-NAME    TO DP001-JOB-NAME.                  03230000
032900     MOVE PC-CKPT-PLAN-NAME   TO DP001-PLAN-NAME.                 03240000
033000                                                                  03250000
033100     PERFORM X200-CALL-TRANS-PRES-MODULE.                         03260000
033200                                                                  03270000
033300     MOVE DP001-TRANS-RECORD  TO SA007-TSAADSU-REC.               03280000
033400                                                                  03290000
033500     IF  DP001-CKPT-TAKEN                                         03300000
033700         DISPLAY '*** CHECKPOINT TAKEN ON REC: '                  03310000
033800                                       PA-ROWS-INSERTED '  '      03320000
033900                                       SAADSU-SUM-CTG-CDE         03330000
033910         DISPLAY '                             '                  03340000
034000         INITIALIZE PV-DEADLOCK-COUNTER                           03350000
034100     END-IF.                                                      03360000
034200                                                                  03370000
034300                                                                  03380000
034400******************************************************************03390000
034500* VERIFY THE RETURN CODE ON THE CALLED MODULE                     03400000
034600******************************************************************03410000
034700 X200-CALL-TRANS-PRES-MODULE.                                     03420000
034800                                                                  03430000
034900     PERFORM Z900-CALL-TRANS-PRES-MODULE.                         03440000
035000                                                                  03450000
035100     IF  DP001-GOOD-RET-CODE                                      03460000
035200     OR  DP001-CKPT-TAKEN                                         03470000
035300     OR  DP001-RESTART                                            03480000
035400         CONTINUE                                                 03490000
035500                                                                  03500000
035600     ELSE                                                         03510000
035700         MOVE 'X200-CALL-TRANS-PRES-MODULE' TO PV-PARAGRAPH-NAME  03520000
035800         MOVE '** BAD CALL TO TRANS PREP MODULE **'               03530000
035900                                            TO PV-OPERATION-MSG   03540000
036000         MOVE DP001-RET-CODE                TO PV-RET-CODE        03550000
036100                                                                  03560000
036200         SET ABEND-4019-CAL-SUB-ERROR TO TRUE                     03570000
036300                                                                  03580000
036400         PERFORM Z100-ABEND                                       03590000
036500     END-IF.                                                      03600000
036600                                                                  03610000
036700                                                                  03620000
036800******************************************************************03630000
036900* NON-DB2 ABEND                                                   03640000
037000******************************************************************03650000
037100 Z100-ABEND.                                                      03660000
037200                                                                  03670000
037300     PERFORM Z999-CONTROLS.                                       03680000
037400                                                                  03690000
037500     DISPLAY '                     '.                             03700000
037600     DISPLAY '** ABEND           **'.                             03710000
037700     DISPLAY '** PROGRAM         ** = ' PC-PROGRAM-NAME.          03720000
037800     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        03730000
037900     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG.         03740000
038000     DISPLAY '** RETURN CODE     ** = ' PV-RET-CODE.              03750000
038100                                                                  03760000
038200     CALL 'ILBOABN0' USING ABEND-CODE.                            03770000
038300                                                                  03780000
038400                                                                  03790000
038500******************************************************************03800000
038600* ABEND THE PROGRAM IN THE EVENT THAT A SQL ERROR OR WARNING      03810000
038700* CODE OCCURS.                                                    03820000
038800******************************************************************03830000
038900 Z200-SQL-ABEND.                                                  03840000
039000                                                                  03850000
039100     PERFORM Z999-CONTROLS.                                       03860000
039200                                                                  03870000
039300     DISPLAY '** ABEND     **'.                                   03880000
039400     DISPLAY '** PROGRAM   ** = ' PC-PROGRAM-NAME.                03890000
039500     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              03900000
039600     DISPLAY '** OPERATION ** = ' PV-DB2-OPER-ATTEMPTED.          03910000
039700                                                                  03920000
039800******************************************************************03930000
039900* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    03940000
040000* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         03950000
040100* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     03960000
040200* FORMAT.                                                         03970000
040300******************************************************************03980000
040400     COPY DPPD004.                                                03990000
040500                                                                  04000000
040600     SET ABEND-4013-DB2-ERROR TO TRUE.                            04010000
040700                                                                  04020000
040800     CALL 'ILBOABN0' USING ABEND-CODE.                            04030000
040900                                                                  04040000
041000                                                                  04050000
041100******************************************************************04060000
041200* PREFORMS TASK TERMINATION PROCESSING                            04070000
041300******************************************************************04080000
041400 Z990-EOJ-ROUTINE.                                                04090000
041500                                                                  04100000
041600     MOVE PC-TRAN-PRES-FUNC-CLOSE TO DP001-FUNC-CODE.             04110000
041700                                                                  04120000
041800     PERFORM X100-BUILD-COMM-AREA-TRAN-PRES.                      04130000
041900                                                                  04140000
042000     PERFORM Z999-CONTROLS.                                       04150000
042100                                                                  04160000
042200                                                                  04170000
042300******************************************************************04180000
042400* DISPLAY CONTROLS FROM THE PROGRAM                               04190000
042500******************************************************************04200000
042600 Z999-CONTROLS.                                                   04210000
042700                                                                  04220000
042800     MOVE FUNCTION CURRENT-DATE TO SYS-DATE-TIME.                 04230000
042900                                                                  04240000
043000     MOVE SYS-TIME (1:2) TO ST-END-HR.                            04250000
043100     MOVE SYS-TIME (3:2) TO ST-END-MN.                            04260000
043200                                                                  04270000
043300     DISPLAY '                    '.                              04280000
043400     DISPLAY '**********************'.                            04290000
043500     DISPLAY '   SAKUP042 CONTROLS  '.                            04300001
043600     DISPLAY '**********************'.                            04310000
043700     DISPLAY 'RUN DATE  = ' SD-EDIT-DATE.                         04320000
043800     DISPLAY 'BEG TIME  = ' ST-BEG-TIME.                          04330000
043900     DISPLAY 'END TIME  = ' ST-END-TIME.                          04340000
044000     DISPLAY '======================'.                            04350000
044100     DISPLAY 'RECORDS READ  = ' PA-READ.                          04360000
044200     DISPLAY '                '.                                  04370000
044300     DISPLAY 'ROWS UPDATED  = ' PA-ROWS-UPDATED.                  04380000
044400     DISPLAY '                '.                                  04390000
044300     DISPLAY 'ROWS INSERTED = ' PA-ROWS-INSERTED.                 04400000
044400     DISPLAY '                '.                                  04410000
044500                                                                  04420000
044700******************************************************************04430000
044800* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    04440000
044900* MENTS THAT ARE REQUIRED TO INVOKE THE TRANSACTION PRESENTATION  04450000
045000* MODULE (DPKUT901) OF THE DB2 CHECKPOINT RESTART SYSTEM.         04460000
045100******************************************************************04470000
045200     COPY DPPD001.                                                04480000
045300                                                                  04490000
045400                                                                  04500000
