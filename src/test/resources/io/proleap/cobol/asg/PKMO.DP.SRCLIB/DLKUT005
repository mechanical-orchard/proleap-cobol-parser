000100 TITLE 'EXTRACT CLOSED ASSIGNMENTS DATA'.                         00010009
000200 IDENTIFICATION DIVISION.                                         00020000
000300 PROGRAM-ID.    DLKUT005.                                         00030009
000400 AUTHOR.        THERESE RAMSEYER.                                 00040009
000500 DATE-WRITTEN.  FEBRUARY 2004.                                    00050009
000600******************************************************************00060012
000700***************************************************************** 00070012
000800* THIS PROGRAM WILL EXTRACT RECORDS FROM DLT_ASGMT AND WRITE    * 00080012
000900* THOSE REORDS TO AN OUTPUT FILE                                * 00090012
001000***************************************************************** 00100012
001100 ENVIRONMENT DIVISION.                                            00110000
001200 INPUT-OUTPUT SECTION.                                            00120000
001300                                                                  00130000
001400 FILE-CONTROL.                                                    00140000
001500     SELECT ASGMT-EXTRACT-FILE     ASSIGN TO OUT01.               00150010
001600                                                                  00160000
001700 DATA DIVISION.                                                   00170000
001800 FILE SECTION.                                                    00180000
001900                                                                  00190000
002000 FD  ASGMT-EXTRACT-FILE                                           00200010
002100     RECORDING MODE IS F                                          00210000
002200     LABEL RECORDS ARE STANDARD                                   00220000
002300     BLOCK CONTAINS 0 RECORDS.                                    00230000
002400                                                                  00240000
002500 01  ASGMT-EXTRACT-RECORD             PIC X(50).                  00250025
002600                                                                  00260000
002700 WORKING-STORAGE SECTION.                                         00270000
002800                                                                  00280000
002900 01  PV-ABEND-CODE                    PIC S9(04)   VALUE ZERO     00290000
003000                                                   COMP SYNC.     00300000
003100                                                                  00310000
003200 01  PS-PROGRAM-SWITCHES.                                         00320000
003300     05  PS-END-CSR-SW                PIC X(1)   VALUE 'N'.       00330000
003400         88  PS-END-CSR                          VALUE 'Y'.       00340000
003500     05  PS-ASGMT-DETAIL-SW           PIC X(1)   VALUE 'N'.       00350010
003600         88  PS-ASGMT-DETAIL-FOUND               VALUE 'Y'.       00360010
003700         88  PS-ASGMT-DETAIL-NOT-FOUND           VALUE 'N'.       00370010
003800                                                                  00380000
004400                                                                  00440011
004500 01  PA-PROGRAM-ACCUMULATORS.                                     00450011
004600     05  PA-ASGMT-RECS-FETCHED        PIC S9(9)   COMP-3          00460011
004700                                                  VALUE ZEROS.    00470011
004800     05  PA-OUTPUT-RECS-WRITTEN       PIC S9(9)   COMP-3          00480010
004900                                                  VALUE ZEROS.    00490010
005000                                                                  00500010
005100 01  PV-PROGRAM-VARIABLES.                                        00510010
005200     05  PV-RETRY-COUNT               PIC S9(04)  VALUE ZERO      00520010
005300                                                  COMP SYNC.      00530000
005400     05  PV-CNTL-TMST                 PIC X(26)   VALUE SPACES.   00540010
005500     05  PV-PARAGRAPH-NAME            PIC X(30)   VALUE SPACES.   00550000
005600     05  PV-ERROR-MESSAGE-1           PIC X(60)   VALUE SPACES.   00560000
005700     05  PV-ERROR-MESSAGE-2           PIC X(60)   VALUE SPACES.   00570000
005800     05  PV-SQLCODE                   PIC 9(9)    VALUE ZERO.     00580000
005900     05  PV-DISPLAY-NUMBER            PIC 9999999999.             00590000
006000     05  PV-DISPLAY-COUNT             PIC ZZZ,ZZZ,ZZ9.            00600000
006100                                                                  00610000
006200 01  PC-PROGRAM-CONSTANTS.                                        00620000
006300     05  PC-PROGRAM-NAME              PIC X(08)  VALUE 'DLKUT005'.00630009
006400     05  PC-MAX-RETRIES               PIC S9(04) VALUE +3         00640000
006500                                                 COMP SYNC.       00650000
006600 01  PV-ABEND-FIELDS.                                             00660000
006700     05  PV-ABEND-PROGRAM             PIC X(8)   VALUE 'DLKUT005'.00670009
006800     05  PV-ABEND-PARAGRAPH           PIC X(50)  VALUE SPACES.    00680000
006900     05  PV-ABEND-OPERATION           PIC X(50)  VALUE SPACES.    00690000
007000     05  PV-ABEND-STRUCTURE-1         PIC X(15)  VALUE SPACES.    00700000
007100     05  PV-ABEND-STRUCTURE-2         PIC X(15)  VALUE SPACES.    00710000
007200     05  PV-ABEND-STRUCTURE-3         PIC X(15)  VALUE SPACES.    00720000
007300     05  PV-ABEND-STATUS              PIC XX     VALUE SPACES.    00730000
007400     05  PV-DB2-OPERATION-MESSAGE-1   PIC  X(79) VALUE SPACES.    00740000
007500     05  PV-DB2-OPERATION-MESSAGE-2   PIC  X(79) VALUE SPACES.    00750000
007600     05  PV-DB2-OPERATION-MESSAGE-3   PIC  X(79) VALUE SPACES.    00760000
007700     05  PV-DB2-OPERATION-MESSAGE-4   PIC  X(79) VALUE SPACES.    00770000
007800                                                                  00780000
007900*    DCLGEN FOR PARAMETERS                                        00790015
008000     EXEC SQL                                                     00800000
008100         INCLUDE TKRPRPM                                          00810015
008200     END-EXEC                                                     00820000
008300                                                                  00830000
008400*    DCLGEN FOR DLT_ASGMT                                         00840010
008500     EXEC SQL                                                     00850000
008600         INCLUDE DLT00004                                         00860010
008700     END-EXEC                                                     00870000
008800                                                                  00880000
008900/                                                                 00890000
009000     EXEC SQL                                                     00900000
009100         DECLARE ASGMT-CSR CURSOR FOR                             00910010
009200             SELECT ASGMT_STRT_DTE                                00920010
009300                  , ASGMT_NBR_TXT                                 00930010
009400                  , ASGMT_NBR_SEQ_NBR                             00940010
009500             FROM   DLT_ASGMT                                     00950010
009600             WHERE  ASGMT_STP_TMST IS NOT NULL                    00960010
009700               AND  ASGMT_STP_TMST < :PV-CNTL-TMST                00970010
009800         ORDER BY 1 ASC                                           00980011
009900                 ,3 ASC                                           00990011
010000     END-EXEC                                                     01000000
010100/                                                                 01010000
010200*  USED FOR DB2 ERROR MESSAGE BUILDING                            01020000
010300     COPY DPWS004.                                                01030000
010400                                                                  01040000
010410*  USED FOR BUILDING OUTPUT FILE OF ASGMT KET DATA.               01041025
010420     COPY DLRD005.                                                01042025
010430                                                                  01043025
010500*   DB2 SQL COMMUNICATION AREA                                    01050000
010600     EXEC SQL                                                     01060000
010700          INCLUDE SQLCA                                           01070000
010800     END-EXEC.                                                    01080000
010900/                                                                 01090000
011000 PROCEDURE DIVISION.                                              01100000
011100                                                                  01110000
011200     PERFORM 1000-INIT.                                           01120000
011300                                                                  01130000
011400     PERFORM 2000-PROCESS UNTIL PS-END-CSR.                       01140000
011500                                                                  01150000
011600     PERFORM 9000-TERMINATE.                                      01160000
011700                                                                  01170000
011800     STOP RUN.                                                    01180011
011900                                                                  01190000
012000 1000-INIT.                                                       01200000
012100                                                                  01210000
012200     OPEN OUTPUT ASGMT-EXTRACT-FILE.                              01220011
012300                                                                  01230000
012400     PERFORM 3000-CALC-PURGE-TMST.                                01240011
012500     PERFORM 7000-OPEN-ASGMT-CSR.                                 01250011
012600     PERFORM 7010-FETCH-ASGMT-CSR.                                01260011
012700                                                                  01270000
012800 2000-PROCESS.                                                    01280000
012900                                                                  01290000
013000     PERFORM 8000-WRITE-EXTRACT-REC.                              01300011
013100                                                                  01310000
013200     PERFORM 7010-FETCH-ASGMT-CSR.                                01320012
013300                                                                  01330011
013400 3000-CALC-PURGE-TMST.                                            01340011
013500                                                                  01350000
013600     EXEC SQL                                                     01360011
013700         SELECT FUNC_QTY                                          01370011
013800               ,CHAR((CURRENT TIMESTAMP) - FUNC_QTY DAYS)         01380024
013900           INTO :KRPRPM-FUNC-QTY                                  01390011
014000               ,:PV-CNTL-TMST                                     01400011
014100           FROM TKRPRPM                                           01410013
014200               ,SYSIBM.SYSDUMMY1                                  01420011
014300          WHERE LOC_ID            = 90                            01430011
014400            AND INTFC_SYS_CDE     = 'DLX'                         01440011
014500            AND SYS_PRC_FUNC_CDE  = 'DLASPG'                      01450011
014600            AND FUNC_PRC_STAT_CDE = 'AC'                          01460011
014700     END-EXEC.                                                    01470011
014800                                                                  01480011
014900     EVALUATE TRUE                                                01490011
015000         WHEN SQLCODE = ZERO                                      01500011
015100             CONTINUE                                             01510011
015200         WHEN SQLCODE = +100                                      01520011
015300         WHEN SQLWARN0 NOT = SPACE                                01530011
015400         WHEN SQLCODE  NOT = ZERO                                 01540011
015500             MOVE '3000-CALC-PURGE-TMST' TO PV-ABEND-PARAGRAPH    01550011
015600             MOVE 'SELECT'               TO PV-ABEND-OPERATION    01560011
015700             MOVE 'CALC PURGE TMST    '  TO PV-ABEND-STRUCTURE-1  01570023
015800             MOVE 'DB2 - TKRPRPM     '   TO PV-ABEND-STRUCTURE-2  01580011
015900             PERFORM 9900-DB2-ABEND                               01590011
016000     END-EVALUATE.                                                01600011
016100                                                                  01610011
016200 7000-OPEN-ASGMT-CSR.                                             01620012
016300     EXEC SQL                                                     01630000
016400         OPEN ASGMT-CSR                                           01640011
016500     END-EXEC.                                                    01650000
016600                                                                  01660000
016700     EVALUATE TRUE                                                01670000
016800         WHEN SQLCODE = ZERO                                      01680000
016900             CONTINUE                                             01690000
017000         WHEN SQLWARN0 NOT = SPACE                                01700000
017100         WHEN SQLCODE  NOT = ZERO                                 01710000
017200             MOVE '7000-OPEN-ASGMT-CSR'  TO PV-ABEND-PARAGRAPH    01720011
017300             MOVE 'OPEN CURSOR'          TO PV-ABEND-OPERATION    01730011
017400             MOVE 'ASGMT PURGE PROCESS'  TO PV-ABEND-STRUCTURE-1  01740011
017500             MOVE 'DB2 - DLT_ASGMT   '   TO PV-ABEND-STRUCTURE-2  01750011
017600             PERFORM 9900-DB2-ABEND                               01760000
017700     END-EVALUATE.                                                01770000
017800                                                                  01780000
017900 7010-FETCH-ASGMT-CSR.                                            01790012
018000     EXEC SQL                                                     01800000
018100         FETCH ASGMT-CSR                                          01810011
018200         INTO                                                     01820000
018300             :DLT00004-ASGMT-STRT-DTE                             01830018
018400         ,   :DLT00004-ASGMT-NBR-TXT                              01840018
018500         ,   :DLT00004-ASGMT-NBR-SEQ-NBR                          01850018
018600     END-EXEC.                                                    01860000
018700                                                                  01870000
018800     EVALUATE TRUE                                                01880000
018900         WHEN SQLCODE = ZERO                                      01890000
019000             ADD 1                    TO PA-ASGMT-RECS-FETCHED    01900011
019600                                                                  01960018
019700         WHEN SQLCODE = +100                                      01970000
019800             SET PS-END-CSR           TO TRUE                     01980000
019900         WHEN SQLWARN0 NOT = SPACE                                01990000
020000         WHEN SQLCODE  NOT = ZERO                                 02000000
020100             MOVE '7010-FETCH-ASGMT-CSR' TO PV-ABEND-PARAGRAPH    02010011
020200             MOVE 'FETCH CURSOR'         TO PV-ABEND-OPERATION    02020011
020300             MOVE 'ASGMT PURGE PROCESS'  TO PV-ABEND-STRUCTURE-1  02030011
020400             MOVE 'DB2 - DLT_ASGMT   '   TO PV-ABEND-STRUCTURE-2  02040011
020500             PERFORM 9900-DB2-ABEND                               02050000
020600     END-EVALUATE.                                                02060000
020700                                                                  02070000
020800 7020-CLOSE-ASGMT-CSR.                                            02080011
020900     EXEC SQL                                                     02090000
021000         CLOSE ASGMT-CSR                                          02100011
021100     END-EXEC.                                                    02110000
021200                                                                  02120000
021300     EVALUATE TRUE                                                02130000
021400         WHEN SQLCODE = ZERO                                      02140000
021500             CONTINUE                                             02150000
021600         WHEN SQLWARN0 NOT = SPACE                                02160000
021700         WHEN SQLCODE  NOT = ZERO                                 02170000
021800             MOVE '7020-CLOSE-ASGMT-CSR' TO PV-ABEND-PARAGRAPH    02180011
021900             MOVE 'CLOSE CURSOR'         TO PV-ABEND-OPERATION    02190011
022000             MOVE 'ASGMT PURGE PROCESS'  TO PV-ABEND-STRUCTURE-1  02200011
022100             MOVE 'DB2 - DLT_ASGMT   '   TO PV-ABEND-STRUCTURE-2  02210011
022200             PERFORM 9900-DB2-ABEND                               02220000
022300     END-EVALUATE.                                                02230000
022400                                                                  02240000
022500                                                                  02250000
022600 8000-WRITE-EXTRACT-REC.                                          02260011
022700                                                                  02270000
022800     INITIALIZE DL005-ASGMT-PURGE-LAYOUT.                         02280025
022900                                                                  02290011
023000     MOVE DLT00004-ASGMT-STRT-DTE    TO DL005-ASGMT-STRT-DTE.     02300025
023100     MOVE DLT00004-ASGMT-NBR-TXT     TO DL005-ASGMT-NBR-TXT.      02310025
023200     MOVE DLT00004-ASGMT-NBR-SEQ-NBR TO DL005-ASGMT-NBR-SEQ-NBR.  02320025
023300                                                                  02330011
023400     ADD 1 TO PA-OUTPUT-RECS-WRITTEN.                             02340011
023500     WRITE ASGMT-EXTRACT-RECORD FROM DL005-ASGMT-PURGE-LAYOUT.    02350026
023600                                                                  02360000
023700 9000-TERMINATE.                                                  02370000
023800                                                                  02380000
023900     PERFORM 7020-CLOSE-ASGMT-CSR.                                02390011
024000                                                                  02400000
024100     CLOSE ASGMT-EXTRACT-FILE.                                    02410011
024200                                                                  02420000
024300     DISPLAY 'TMST :'  PV-CNTL-TMST.                              02430016
024400                                                                  02440016
024500                                                                  02450016
024600     DISPLAY '************************'.                          02460000
024700     DISPLAY '******* DLKUT005 *******'.                          02470009
024800     DISPLAY '************************'.                          02480000
024900     DISPLAY SPACES                                               02490000
025000                                                                  02500000
025100     MOVE PA-ASGMT-RECS-FETCHED       TO PV-DISPLAY-COUNT.        02510011
025200     DISPLAY 'TOTAL ASGMT RECS FETCHED      = ' PV-DISPLAY-COUNT. 02520011
025300                                                                  02530000
025400     MOVE PA-OUTPUT-RECS-WRITTEN      TO PV-DISPLAY-COUNT.        02540011
025500     DISPLAY 'TOTAL OUTPUT RECS WRITTEN     = ' PV-DISPLAY-COUNT. 02550011
025600                                                                  02560000
025700     DISPLAY SPACES                                               02570000
025800     DISPLAY '************************'.                          02580000
025900                                                                  02590000
026000                                                                  02600000
026100 9900-DB2-ABEND.                                                  02610000
026200                                                                  02620000
026300     MOVE SQLCODE TO PV-SQLCODE.                                  02630000
026400     DISPLAY '*** DB2 ERROR '.                                    02640000
026500     DISPLAY '*** SQLCODE   = ' PV-SQLCODE.                       02650000
026600     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                 02660000
026700     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               02670000
026800     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               02680000
026900     DISPLAY '*** MESSAGE   = ' PV-DB2-OPERATION-MESSAGE-1.       02690000
027000     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-2.       02700000
027100     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-3.       02710000
027200     DISPLAY '*** PROCESS   = ' PV-ABEND-STRUCTURE-1.             02720011
027300     DISPLAY '*** TABLE     = ' PV-ABEND-STRUCTURE-2.             02730011
027400                                                                  02740000
027500                                                                  02750000
027600     COPY DPPD004.                                                02760000
027700                                                                  02770000
027800     MOVE +4013                  TO PV-ABEND-CODE.                02780000
027900     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         02790000
028000                                                                  02800000
