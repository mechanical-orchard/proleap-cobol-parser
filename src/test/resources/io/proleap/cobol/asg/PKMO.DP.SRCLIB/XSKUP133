000100*--------------------------------------------------------------   00010066
000200 IDENTIFICATION DIVISION.                                         00020003
000100*--------------------------------------------------------------   00030066
000400 PROGRAM-ID.    XSKUP133.                                         00040055
000500 AUTHOR.        JIM ARENDT.                                       00050055
000600 DATE-WRITTEN.  APRIL 10, 2010.                                   00060091
000700                                                                  00070003
000100*--------------------------------------------------------------   00080066
000900*            PROMOTION TYPE ID CHECK                              00090066
000100*--------------------------------------------------------------   00100066
001101* THIS PROGRAM IS A MODULE AND IS CALLED BY PROGRAM XSKUP031.     00110066
001102* IT CHECKS FOR EXISTANCE OF A PROMO NAME, PROMO ABBREVIATED NAME,00120073
001102* AND PROMO TYPE CODE ON XST_PROMO_TYP.  IF FOUND, UPDATE TABLE   00130073
001100* XST_PROMO WITH THE PROMO-TYP-ID.  OTHERWISE IT WILL INSERT A    00140073
001103* ROW INTO XST_PROMO_TYP AND UPDATE TABLE XST_PROMO WITH THE NEW  00150088
001103* PROMO-TYP-ID.  IT WILL THEN PASS BACK A 4051 RETURN CODE SO A   00160094
001104* NOTIFICATION EMAIL CAN BE GENERATED.                            00170073
001114*                                                                 00180007
000100*--------------------------------------------------------------   00190066
001151* HISTORY LOG:                                                    00200003
000100*--------------------------------------------------------------   00210066
1010  * DATE:        10/08/2010                                         00220099
1010  * WR/IR#:      WR38306                                            00230099
1010  * PROGRAMMER:  JIM ARENDT                                         00240099
1010  * DESCRIPTION: CHANGED PROGRAM TO POPULATE NEW FIELD              00250099
1010  *              (PROMO-LVL-CDE) ON XST_PROMO_TYP WITH NULLS.       00260099
000100*--------------------------------------------------------------   00270066
W37916* DATE:        07/22/2011                                         00280099
W37916* WR/IR#:      WR37916                                            00290099
W37916* PROGRAMMER:  JIM HUNTER                                         00300099
W37916* DESCRIPTION: INITIALIZE PS-INSERT-NO TO TRUE IN PARA.           00310099
W37916*              1000-INITIALIZATION.                               00320099
W37916*--------------------------------------------------------------   00330099
001160 ENVIRONMENT DIVISION.                                            00340038
000100*--------------------------------------------------------------   00350066
001162 CONFIGURATION SECTION.                                           00360038
001163 SOURCE-COMPUTER. IBM-3090.                                       00370038
001164 OBJECT-COMPUTER. IBM-3090.                                       00380038
001165                                                                  00390038
001166 INPUT-OUTPUT SECTION.                                            00400038
001167                                                                  00410038
001170 FILE-CONTROL.                                                    00420005
001180                                                                  00430005
000100*--------------------------------------------------------------   00440066
001200 DATA DIVISION.                                                   00450005
000100*--------------------------------------------------------------   00460066
001400 FILE SECTION.                                                    00470005
001500                                                                  00480005
001600                                                                  00490005
000100*--------------------------------------------------------------   00500066
001800                                                                  00510005
001900 WORKING-STORAGE SECTION.                                         00520005
000100*--------------------------------------------------------------   00530066
002100* PC- PROGRAM CONSTANTS                                           00540005
000100*--------------------------------------------------------------   00550066
002300 01  PC-PROGRAM-CONSTANTS.                                        00560005
002400     05  PC-PROGRAM-NAME              PIC  X(08) VALUE 'XSKUP133'.00570055
002500     05  PC-MAX-RETRIES               PIC S9(04) VALUE +5 COMP.   00580005
002550     05  PC-NOT-NULL                  PIC S9(04) VALUE +0 COMP.   00590066
1010       05  PC-NULL                      PIC S9(04) VALUE -1 COMP.   00600099
002550     05  PC-MAIN                      PIC  X(02) VALUE 'M '.      00610097
002550     05  PC-OTHER                     PIC  X(02) VALUE 'O '.      00620097
002600                                                                  00630005
000100*--------------------------------------------------------------   00640066
002800* PS- PROGRAM SWITCHES                                            00650039
000100*--------------------------------------------------------------   00660066
003000 01  PS-PROGRAM-SWITCHES.                                         00670005
003100     05  PS-PROCESS-CONTINUE-SW       PIC  X(01) VALUE 'Y'.       00680055
003200         88  PS-PROCESS-CONTINUE                 VALUE 'Y'.       00690005
003300         88  PS-PROCESS-COMPLETE                 VALUE 'N'.       00700005
003300     05  PS-PROMO-DATA-FOUND-SW       PIC  X(01) VALUE 'N'.       00710067
003300         88  PS-PROMO-DATA-FOUND                 VALUE 'Y'.       00720067
003300         88  PS-PROMO-DATA-NOT-FND               VALUE 'N'.       00730067
003300     05  PS-INSERT-SW                 PIC  X(01) VALUE 'N'.       00740066
003300         88  PS-INSERT-YES                       VALUE 'Y'.       00750066
003300         88  PS-INSERT-NO                        VALUE 'N'.       00760066
003400                                                                  00770005
000100*--------------------------------------------------------------   00780066
003600* PV- PROGRAM VARIABLES                                           00790005
000100*--------------------------------------------------------------   00800066
003800 01 PV-PROGRAM-VARIABLES.                                         00810005
003900    05  PV-SQL-SUB                    PIC S9(04) VALUE +0 COMP.   00820055
003910    05  PV-SQL-CODE                   PIC S9(04) VALUE +0.        00830055
004000    05  PV-MAX-PROMO-TYP-ID           PIC S9(10) VALUE +0 COMP-3. 00840066
004000    05  PV-DB2-PROMO-TYP-ID           PIC S9(10) VALUE +0 COMP-3. 00850096
004000    05  PV-PROMO-ID                   PIC S9(10) VALUE +0 COMP-3. 00860069
004000    05  PV-SPECIFIC-TYPE-CDE          PIC  X(02) VALUE SPACES.    00870096
004000    05  PV-ABBR-NM                    PIC  X(05) VALUE SPACES.    00880071
004000    05  PV-CPLT-NM                    PIC  X(40) VALUE SPACES.    00890067
004250    05  PV-LD-STATUS-CDE              PIC  X(02).                 00900055
004260        88  PV-NO-ERROR                          VALUE '00'.      00910006
004270        88  PV-CRITICAL-ERROR                    VALUE '01'.      00920005
004280        88  PV-NOT-CRITICAL-ERROR                VALUE '02'.      00930005
004290    05  PV-PGM-STATUS-CDE             PIC  X(02).                 00940055
004300        88  PV-SUCCESS-CDE                       VALUE '00'.      00950005
004400        88  PV-UPDATE-NEED                       VALUE '01'.      00960005
004500        88  PV-UPDATE-NOT-NEED                   VALUE '02'.      00970005
004600        88  PV-ADD-CDE                           VALUE '03'.      00980005
004610        88  PV-UPDATE-BYPASS                     VALUE '04'.      00990011
004700        88  PV-NO-SUCCESS-CDE                    VALUE '05'.      01000011
004800        88  PV-UNEXPECT-CDE                      VALUE '06'.      01010011
004900                                                                  01020005
004910    05  PV-NULLS-INDICATORS.                                      01030016
004940        10  PV-TYP-CDE-IND            PIC S9(04) COMP VALUE +0.   01040055
004960        10  PV-ABBR-NM-IND            PIC S9(04) COMP VALUE +0.   01050055
1010          10  PV-PROMO-LVL-IND          PIC S9(04) COMP VALUE +0.   01060099
004970                                                                  01070016
000100*--------------------------------------------------------------   01080066
007400* PROMOTION BUSINESS EVENT RECORD LAYOUT                          01090005
000100*--------------------------------------------------------------   01100066
007600     COPY XSRD016.                                                01110005
007700                                                                  01120005
000100*--------------------------------------------------------------   01130066
008400* VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004         01140005
000100*--------------------------------------------------------------   01150066
008600     COPY DPWS004.                                                01160005
008700                                                                  01170005
000100*--------------------------------------------------------------   01180066
008900*  DB2 COMMUNICATION AREA.                                        01190005
000100*--------------------------------------------------------------   01200066
009100     EXEC SQL                                                     01210005
009200          INCLUDE SQLCA                                           01220005
009300     END-EXEC.                                                    01230005
009400                                                                  01240005
000100*--------------------------------------------------------------   01250066
010400*  DB2 TABLE XST00026 (XST_PROMO) - PROMOTION TABLE               01260072
000100*--------------------------------------------------------------   01270066
010100     EXEC SQL                                                     01280066
010100          INCLUDE XST00026                                        01290072
010100     END-EXEC.                                                    01300066
010100                                                                  01310005
000100*--------------------------------------------------------------   01320072
010400*  DB2 TABLE XST00132 (XST_PROMO_TYP) - PROMOTION TYPE TABLE      01330072
000100*--------------------------------------------------------------   01340072
010100     EXEC SQL                                                     01350072
010100          INCLUDE XST00132                                        01360072
010100     END-EXEC.                                                    01370072
010100                                                                  01380072
010200 LINKAGE SECTION.                                                 01390005
010300                                                                  01400005
000100*--------------------------------------------------------------   01410066
010500* FILE INFORMATION BEING PASSED TO AND FROM THIS MODULE.          01420005
000100*--------------------------------------------------------------   01430066
010700 01 LV-LINKAGE-VARIABLES.                                         01440005
010800    05  LV-PROMOTION-BUS-REC       PIC  X(300).                   01450060
010800    05  LV-MAX-OFFSET-DTE          PIC  X(08).                    01460060
011000    05  LV-LD-SQL-RETURN-CDE       PIC S9(04).                    01470060
011100    05  LV-PGM-STATUS-CDE          PIC  X(02).                    01480060
011200    05  LV-LD-SEVERITY-LVL         PIC  X(02).                    01490060
011300                                                                  01500005
011400                                                                  01510005
000100*--------------------------------------------------------------   01520066
011600 PROCEDURE DIVISION USING LV-LINKAGE-VARIABLES.                   01530005
000100*--------------------------------------------------------------   01540066
011800 0000-MAINLINE.                                                   01550005
011900                                                                  01560005
012000     PERFORM 1000-INITIALIZATION.                                 01570005
012100                                                                  01580005
012200     PERFORM 2000-PROCESS-MESSAGE                                 01590005
012300        UNTIL PS-PROCESS-COMPLETE.                                01600066
012400                                                                  01610005
012500     PERFORM 9999-WRAPUP.                                         01620005
012600                                                                  01630005
012700     EXIT PROGRAM.                                                01640030
012800                                                                  01650005
012900*0000-EXIT.                                                       01660005
013000 EJECT.                                                           01670005
013100                                                                  01680005
000100*--------------------------------------------------------------   01690066
013300* 1000-INITIALIZATION.                                            01700005
013400*     INTIALIZES OR MOVES ANY VARIABLES BEFORE IT WILL            01710005
013500*     INSERT A RECORD.                                            01720055
000100*--------------------------------------------------------------   01730066
013700 1000-INITIALIZATION.                                             01740005
013800                                                                  01750005
013900     INITIALIZE DCLXST00132                                       01760055
013901                PV-SQL-CODE                                       01770025
013910                PV-NULLS-INDICATORS.                              01780016
014000     MOVE LV-PROMOTION-BUS-REC TO XS016-PROMOTION-RECORD.         01790024
014600     SET PV-NO-ERROR           TO TRUE.                           01800005
014700     SET PV-SUCCESS-CDE        TO TRUE.                           01810005
014800     SET PS-PROCESS-CONTINUE   TO TRUE.                           01820005
W37916     SET PS-INSERT-NO          TO TRUE.                           01830099
014900     MOVE XS016-ABBR-NM        TO PV-ABBR-NM.                     01840071
014900     MOVE XS016-CPLT-NM        TO PV-CPLT-NM.                     01850071
019200     MOVE XS016-PROMO-ID       TO PV-PROMO-ID.                    01860071
014900                                                                  01870005
019200     MOVE XS016-SPECIFIC-PROMO-TYP-CDE TO PV-SPECIFIC-TYPE-CDE.   01880096
019200     IF XS016-SPECIFIC-PROMO-TYP-CDE = PC-MAIN                    01890096
019200     OR XS016-SPECIFIC-PROMO-TYP-CDE = PC-OTHER                   01900096
019200        PERFORM 3000-CHECK-FOR-EXISTANCE                          01910096
019200     ELSE                                                         01920096
019200        PERFORM 3100-CHECK-FOR-EXISTANCE-NULL                     01930096
019200     END-IF.                                                      01940096
019200                                                                  01950096
015000*1000-EXIT.                                                       01960005
015100 EJECT.                                                           01970005
017365                                                                  01980017
000100*--------------------------------------------------------------   01990066
017800* 2000-PROCESS-MESSAGE.                                           02000005
017900*    IF THE PROMO-TYP-ID FIELD IS POPULATED ON THE INPUT RECORD   02010066
018000*    CHECK TO SEE IF IT EXISTS ON XST_PROMO_TYP.  IF YES,         02020066
018100*    CONTINUE PROCESSING ELSE INSERT THE NEW PROMO-TYP-ID FIELD   02030066
018200*    ONTO XST_PROMO_TYP AND SET A SWITCH TO SEND A NOTIFICATION   02040066
018300*    EMAIL.                                                       02050066
000100*--------------------------------------------------------------   02060066
018400 2000-PROCESS-MESSAGE.                                            02070005
019300                                                                  02080074
019300     IF PS-PROMO-DATA-FOUND                                       02090074
019600         PERFORM 3300-UPDATE-ROUTINE                              02100074
019500     ELSE                                                         02110066
019600         PERFORM 3200-INSERT-ROUTINE                              02120066
019600         MOVE PV-MAX-PROMO-TYP-ID TO PV-DB2-PROMO-TYP-ID          02130096
019600         PERFORM 3300-UPDATE-ROUTINE                              02140067
019600     END-IF.                                                      02150066
019700                                                                  02160066
019700*2000-EXIT.                                                       02170055
019900                                                                  02180055
000100*--------------------------------------------------------------   02190096
019900* 3000-CHECK-FOR-EXISTANCE.                                       02200096
019900*     CHECK TO SEE IF THE ROW EXISTS ON XST_PRMO_TYP.             02210096
000100*--------------------------------------------------------------   02220096
019900 3000-CHECK-FOR-EXISTANCE.                                        02230096
019900                                                                  02240096
019900     PERFORM                                                      02250096
019900         WITH TEST AFTER                                          02260096
019900         VARYING PV-SQL-SUB                                       02270096
019900         FROM 1 BY 1                                              02280096
019900         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 02290096
019900                   OR  SQLCODE NOT = -904 AND -911 AND -913)      02300096
019900                                                                  02310096
019900         EXEC SQL                                                 02320096
019900             SELECT  PROMO_TYP_ID                                 02330096
019900               INTO :PV-DB2-PROMO-TYP-ID                          02340096
019900               FROM  XST_PROMO_TYP                                02350096
019900              WHERE  TYP_CDE    = :PV-SPECIFIC-TYPE-CDE           02360096
019900                AND  ABBR_NM    = :PV-ABBR-NM                     02370096
019900                AND  CPLT_NM    = :PV-CPLT-NM                     02380096
019900         END-EXEC                                                 02390096
019900                                                                  02400096
019900         MOVE SQLCODE TO PV-SQL-CODE                              02410096
019900                                                                  02420096
019900         EVALUATE TRUE                                            02430096
019900             WHEN SQLCODE = -904                                  02440096
019900             WHEN SQLCODE = -911                                  02450096
019900             WHEN SQLCODE = -913                                  02460096
019900                  CONTINUE                                        02470096
019900                                                                  02480096
019900             WHEN SQLCODE = 0                                     02490096
019900                  SET PS-PROMO-DATA-FOUND   TO TRUE               02500096
019900                                                                  02510096
019900             WHEN SQLCODE = +100                                  02520096
019900                  SET PS-PROMO-DATA-NOT-FND TO TRUE               02530096
019900                                                                  02540096
019900             WHEN OTHER                                           02550096
019900                  SET PS-PROCESS-COMPLETE   TO TRUE               02560096
019900                  SET PV-NO-SUCCESS-CDE     TO TRUE               02570096
019900                  SET PV-CRITICAL-ERROR     TO TRUE               02580096
019900         END-EVALUATE                                             02590096
019900     END-PERFORM.                                                 02600096
019900                                                                  02610096
019900     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         02620096
019900        SET PS-PROCESS-COMPLETE TO TRUE                           02630096
019900        SET PV-NO-SUCCESS-CDE   TO TRUE                           02640096
019900        SET PV-CRITICAL-ERROR   TO TRUE                           02650096
019900     END-IF.                                                      02660096
019900                                                                  02670096
019900*3000-EXIT.                                                       02680096
019900*                                                                 02690096
000100*--------------------------------------------------------------   02700066
019900* 3100-CHECK-FOR-EXISTANCE-NULL.                                  02710096
019900*     CHECK TO SEE IF THE ROW EXISTS ON XST_PRMO_TYP.             02720067
000100*--------------------------------------------------------------   02730066
019900 3100-CHECK-FOR-EXISTANCE-NULL.                                   02740096
019900                                                                  02750066
019900     PERFORM                                                      02760066
019900         WITH TEST AFTER                                          02770066
019900         VARYING PV-SQL-SUB                                       02780066
019900         FROM 1 BY 1                                              02790066
019900         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 02800066
019900                   OR  SQLCODE NOT = -904 AND -911 AND -913)      02810066
019900                                                                  02820066
019900         EXEC SQL                                                 02830066
019900             SELECT  PROMO_TYP_ID                                 02840074
019900               INTO :PV-DB2-PROMO-TYP-ID                          02850096
019900               FROM  XST_PROMO_TYP                                02860066
019900              WHERE  ABBR_NM  = :PV-ABBR-NM                       02870096
019900                AND  CPLT_NM  = :PV-CPLT-NM                       02880096
019900                AND  TYP_CDE  IS NULL                             02890096
019900         END-EXEC                                                 02900066
019900                                                                  02910066
019900         MOVE SQLCODE TO PV-SQL-CODE                              02920066
019900                                                                  02930066
019900         EVALUATE TRUE                                            02940066
019900             WHEN SQLCODE = -904                                  02950066
019900             WHEN SQLCODE = -911                                  02960066
019900             WHEN SQLCODE = -913                                  02970066
019900                  CONTINUE                                        02980066
019900                                                                  02990066
019900             WHEN SQLCODE = 0                                     03000066
019900                  SET PS-PROMO-DATA-FOUND   TO TRUE               03010067
019900                                                                  03020066
019900             WHEN SQLCODE = +100                                  03030066
019900                  SET PS-PROMO-DATA-NOT-FND TO TRUE               03040067
019900                                                                  03050066
019900             WHEN OTHER                                           03060066
019900                  SET PS-PROCESS-COMPLETE   TO TRUE               03070088
019900                  SET PV-NO-SUCCESS-CDE     TO TRUE               03080088
019900                  SET PV-CRITICAL-ERROR     TO TRUE               03090088
019900         END-EVALUATE                                             03100066
019900     END-PERFORM.                                                 03110066
019900                                                                  03120066
019900     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         03130066
019900        SET PS-PROCESS-COMPLETE TO TRUE                           03140066
019900        SET PV-NO-SUCCESS-CDE   TO TRUE                           03150066
019900        SET PV-CRITICAL-ERROR   TO TRUE                           03160066
019900     END-IF.                                                      03170066
019900                                                                  03180066
019900*3000-EXIT.                                                       03190066
019900                                                                  03200096
000100*--------------------------------------------------------------   03210066
019900* 3200-INSERT-ROUTINE.                                            03220066
019900*     PREPARE TO INSERT A RECORD INTO XST_DEPT DB2 TABLE.         03230066
000100*--------------------------------------------------------------   03240066
019900 3200-INSERT-ROUTINE.                                             03250066
019900                                                                  03260066
019900     MOVE ZERO                    TO PV-MAX-PROMO-TYP-ID.         03270066
019900     PERFORM 3400-GET-MAX-PROMO-TYP.                              03280066
019900                                                                  03290066
019900     MOVE PV-MAX-PROMO-TYP-ID     TO XST00132-PROMO-TYP-ID.       03300066
019900     MOVE 'N'                     TO XST00132-PARL-DAY-PROMO-IND. 03310079
019900     MOVE XS016-SPECIFIC-PROMO-TYP-CDE                            03320098
019900                                  TO XST00132-TYP-CDE.            03330098
019900     MOVE 1001                    TO XST00132-PRCDNC-PRTY-NBR.    03340095
1010       MOVE PC-NULL                 TO PV-PROMO-LVL-IND.            03350099
019900     MOVE PC-NOT-NULL             TO PV-ABBR-NM-IND               03360066
019900                                     PV-TYP-CDE-IND.              03370066
019900                                                                  03380066
019900     IF XS016-CPLT-NM = SPACES                                    03390066
019900        MOVE 'UNKNOWN PROMO NAME' TO XST00132-CPLT-NM             03400089
019900     ELSE                                                         03410066
019900        MOVE XS016-CPLT-NM        TO XST00132-CPLT-NM             03420066
019900     END-IF.                                                      03430066
019900                                                                  03440066
019900     IF XS016-ABBR-NM = SPACES                                    03450066
019900        MOVE SPACES               TO XST00132-ABBR-NM             03460090
019900     ELSE                                                         03470066
019900        MOVE XS016-ABBR-NM        TO XST00132-ABBR-NM             03480066
019900     END-IF.                                                      03490066
019900                                                                  03500066
019900     PERFORM 3600-INSERT-XST-PROMO-TYP.                           03510091
019900                                                                  03520066
019900*3200-EXIT.                                                       03530066
019900 EJECT.                                                           03540066
032100*------------------------------------------------------           03550067
032200* 3300-UPDATE-ROUTINE.                                            03560067
032300*     UPDATE THE XST_PROMO RECORD.                                03570067
032400*------------------------------------------------------           03580067
019600 3300-UPDATE-ROUTINE.                                             03590067
032600                                                                  03600067
032700     PERFORM                                                      03610067
032800         WITH TEST AFTER                                          03620067
032900         VARYING PV-SQL-SUB                                       03630067
033000         FROM 1 BY 1                                              03640067
033100         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 03650067
033200                   OR  SQLCODE NOT = -904 AND -911 AND -913)      03660067
033500                                                                  03670067
033600         EXEC SQL                                                 03680067
033700             UPDATE XST_PROMO                                     03690067
033800             SET  PROMO_TYP_ID  = :PV-DB2-PROMO-TYP-ID            03700096
034800                 ,LAST_UPD_TMST =  CURRENT TIMESTAMP              03710088
034810            WHERE PROMO_ID      = :PV-PROMO-ID                    03720076
034830         END-EXEC                                                 03730067
034840                                                                  03740067
034841         MOVE SQLCODE TO PV-SQL-CODE                              03750067
034842                                                                  03760067
034850         EVALUATE TRUE                                            03770067
034900             WHEN SQLCODE = 0                                     03780067
035500                  SET PS-PROCESS-COMPLETE TO TRUE                 03790081
035500                                                                  03800081
034860             WHEN SQLCODE = -904                                  03810067
034870             WHEN SQLCODE = -911                                  03820067
034880             WHEN SQLCODE = -913                                  03830067
034890                  CONTINUE                                        03840067
034890                                                                  03850067
035400             WHEN OTHER                                           03860067
035500                  SET PS-PROCESS-COMPLETE TO TRUE                 03870067
035600                  SET PV-NO-SUCCESS-CDE   TO TRUE                 03880067
036400                  SET PV-CRITICAL-ERROR   TO TRUE                 03890070
035800         END-EVALUATE                                             03900067
035900     END-PERFORM.                                                 03910067
036000                                                                  03920067
036100     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         03930067
036200        SET PS-PROCESS-COMPLETE TO TRUE                           03940067
036300        SET PV-NO-SUCCESS-CDE   TO TRUE                           03950067
036400        SET PV-CRITICAL-ERROR   TO TRUE                           03960070
036500     END-IF.                                                      03970067
036600                                                                  03980067
036700*2200-EXIT.                                                       03990067
036800 EJECT.                                                           04000067
036900                                                                  04010067
000100*--------------------------------------------------------------   04020066
019900* 3400-GET-MAX-PROMO-TYP.                                         04030066
019900*     RETRIEVE THE MAXIMUM PROMO-TYP-ID FROM XST_DEPT             04040066
000100*--------------------------------------------------------------   04050066
019900 3400-GET-MAX-PROMO-TYP.                                          04060066
019900                                                                  04070066
019900     PERFORM                                                      04080066
019900         WITH TEST AFTER                                          04090066
019900         VARYING PV-SQL-SUB                                       04100066
019900         FROM 1 BY 1                                              04110066
019900         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 04120066
019900                   OR  SQLCODE NOT = -904 AND -911 AND -913)      04130066
019900                                                                  04140066
019900         EXEC SQL                                                 04150066
019900             SELECT  MAX(PROMO_TYP_ID) + 1                        04160066
019900               INTO :PV-MAX-PROMO-TYP-ID                          04170066
019900               FROM  XST_PROMO_TYP                                04180066
019900             WITH UR                                              04190066
019900         END-EXEC                                                 04200066
019900                                                                  04210066
019900         MOVE SQLCODE TO PV-SQL-CODE                              04220066
019900                                                                  04230066
019900         EVALUATE TRUE                                            04240066
019900             WHEN SQLCODE = 0                                     04250066
019900             WHEN SQLCODE = -904                                  04260066
019900             WHEN SQLCODE = -911                                  04270066
019900             WHEN SQLCODE = -913                                  04280066
019900                  CONTINUE                                        04290066
019900                                                                  04300066
019900             WHEN SQLCODE = +100                                  04310066
019900                  MOVE +1                 TO PV-MAX-PROMO-TYP-ID  04320066
019900                                                                  04330066
019900             WHEN OTHER                                           04340066
019900                  SET PS-PROCESS-COMPLETE TO TRUE                 04350066
019900                  SET PV-NO-SUCCESS-CDE   TO TRUE                 04360066
019900                  SET PV-CRITICAL-ERROR   TO TRUE                 04370066
019900         END-EVALUATE                                             04380066
019900     END-PERFORM.                                                 04390066
019900                                                                  04400066
019900     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         04410066
019900        SET PS-PROCESS-COMPLETE TO TRUE                           04420066
019900        SET PV-NO-SUCCESS-CDE   TO TRUE                           04430066
019900        SET PV-CRITICAL-ERROR   TO TRUE                           04440066
019900     END-IF.                                                      04450066
019900                                                                  04460066
019900*3400-EXIT.                                                       04470066
019900 EJECT.                                                           04480066
000100*--------------------------------------------------------------   04490066
019900* 3600-INSERT-XST-PROMO-TYP.                                      04500091
019900*     INSERT A ROW INTO XST_PROMO_TYP.                            04510091
000100*--------------------------------------------------------------   04520066
019900 3600-INSERT-XST-PROMO-TYP.                                       04530091
019900                                                                  04540066
019900     PERFORM                                                      04550066
019900         WITH TEST AFTER                                          04560066
019900         VARYING PV-SQL-SUB                                       04570066
019900         FROM 1 BY 1                                              04580066
019900         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 04590066
019900                   OR  SQLCODE NOT = -803 AND -904 AND            04600066
019900                                     -911 AND -913)               04610066
019900                                                                  04620066
019900         EXEC SQL                                                 04630066
019900             INSERT INTO XST_PROMO_TYP (PROMO_TYP_ID              04640066
019900                                       ,CPLT_NM                   04650066
019900                                       ,ABBR_NM                   04660066
019900                                       ,TYP_CDE                   04670066
019900                                       ,PRCDNC_PRTY_NBR           04680066
019900                                       ,PARL_DAY_PROMO_IND        04690099
1010                                         ,PROMO_LVL_CDE)            04700099
019900             VALUES                                               04710066
019900                               ( :XST00132-PROMO-TYP-ID           04720088
019900                                ,:XST00132-CPLT-NM                04730088
019900                                ,:XST00132-ABBR-NM :PV-ABBR-NM-IND04740088
019900                                ,:XST00132-TYP-CDE :PV-TYP-CDE-IND04750088
019900                                ,:XST00132-PRCDNC-PRTY-NBR        04760088
019900                                ,:XST00132-PARL-DAY-PROMO-IND     04770099
1010                                  ,:XST00132-PROMO-LVL-CDE          04780099
1010                                   :PV-PROMO-LVL-IND)               04790099
019900         END-EXEC                                                 04800066
019900                                                                  04810066
019900         MOVE SQLCODE TO PV-SQL-CODE                              04820066
019900                                                                  04830066
019900         EVALUATE TRUE                                            04840066
019900             WHEN SQLCODE = 0                                     04850066
019900                  SET PS-INSERT-YES       TO TRUE                 04860081
019900                  SET PS-PROCESS-COMPLETE TO TRUE                 04870081
019900                                                                  04880066
019900             WHEN SQLCODE = -904                                  04890066
019900             WHEN SQLCODE = -911                                  04900066
019900             WHEN SQLCODE = -913                                  04910066
019900                  CONTINUE                                        04920066
019900                                                                  04930066
019900             WHEN SQLCODE = -803                                  04940066
019900                  COMPUTE PV-MAX-PROMO-TYP-ID =                   04950066
019900                          PV-MAX-PROMO-TYP-ID + 1                 04960066
019900                  MOVE PV-MAX-PROMO-TYP-ID                        04970066
019900                                          TO XST00132-PROMO-TYP-ID04980088
019900                                                                  04990066
019900             WHEN OTHER                                           05000066
019900                  SET PS-PROCESS-COMPLETE TO TRUE                 05010066
019900                  SET PV-NO-SUCCESS-CDE   TO TRUE                 05020066
019900                  SET PV-CRITICAL-ERROR   TO TRUE                 05030066
019900         END-EVALUATE                                             05040066
019900     END-PERFORM.                                                 05050066
019900                                                                  05060066
019900     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         05070066
019900        SET PS-PROCESS-COMPLETE TO TRUE                           05080066
019900        SET PV-NO-SUCCESS-CDE   TO TRUE                           05090066
019900        SET PV-CRITICAL-ERROR   TO TRUE                           05100066
019900     END-IF.                                                      05110066
019900                                                                  05120066
019900*3600-EXIT.                                                       05130091
019900 EJECT.                                                           05140066
039700                                                                  05150005
000100*--------------------------------------------------------------   05160066
041200* 9999-WRAPUP.                                                    05170005
041300*     MOVES ALL ERROR CODES TO THE LINKAGE VARIABLES TO           05180005
041400*     BE PASSED BACK TO THE CALLING PROGRAM.  EXITS THE           05190005
041500*     PROGRAM.                                                    05200005
000100*--------------------------------------------------------------   05210066
041700 9999-WRAPUP.                                                     05220005
041800                                                                  05230005
041900     MOVE PV-PGM-STATUS-CDE TO LV-PGM-STATUS-CDE.                 05240005
041900     IF PS-INSERT-YES                                             05250065
042000        MOVE 4051           TO LV-LD-SQL-RETURN-CDE               05260094
042000     ELSE                                                         05270064
042000        MOVE PV-SQL-CODE    TO LV-LD-SQL-RETURN-CDE               05280064
042000     END-IF.                                                      05290064
042100     MOVE PV-LD-STATUS-CDE  TO LV-LD-SEVERITY-LVL.                05300005
042200                                                                  05310005
042300*9999-EXIT.                                                       05320005
042400 EJECT.                                                           05330005
042500                                                                  05340005
