000100 IDENTIFICATION DIVISION.                                         00010006
000200 PROGRAM-ID.    XLKUT074.                                         00020006
000300 AUTHOR.        PAUL OMAN.                                        00030006
000400 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00040006
000500 DATE-WRITTEN.  JUNE 2004.                                        00050006
000600 DATE-COMPILED.                                                   00060006
000700                                                                  00070006
000800****************************************************************  00080006
000900*    XLWS074 - COPYBOOK USED WHEN CALLING THIS PROGRAM.        *  00090006
001000*                                                              *  00100006
001100*    XLKCS074 - CICS VERSION OF THIS PROGRAM.                  *  00110006
001200*                                                              *  00120006
001300*  NOTE: WHEN CALLING THIS PROGRAM, THE CALLING PROGRAM'S      *  00130006
001400*        DB2 PLAN MUST INCLUDE THE XL COLLECTION ID.           *  00140006
001500*                                                              *  00150006
001600*    PROGRAM IS USED TO ACCESS INTRANSIT AND STORE EXPECTED    *  00160006
001700*        QUANTITIES.  CALLING PROGRAMS ARE REQUIRED TO SUPPLY  *  00170006
001800*        THE TYPE OF ITEM ACCESS: SKU, ITEM, UPC NUMBER, OR    *  00180006
001900*        INTERNAL UPC NUMBER.  THEY ARE ALSO REQUIRED TO       *  00190006
002000*        SUPPLY THE TYPE OF LOCATION ACCESS, IF IT IS FOR AN   *  00200006
002100*        INDIVIDUAL STORE OR ALL STORES.                       *  00210006
002200*                                                              *  00220006
002300*    XLKUT001 IS CALLED TO CONVERT THE SKU, ITEM, OR UPC       *  00230006
002400*        NUMBER TO THE INTERNAL UPC NUMBER SO THAT THE         *  00240006
002500*        PCT_TRN_CLSN_BAL (PCT00014) TABLE CAN BE READ.        *  00250006
002600*                                                              *  00260006
002700****************************************************************  00270006
002800                                                                  00280006
002900 ENVIRONMENT DIVISION.                                            00290006
003000 CONFIGURATION SECTION.                                           00300006
003100 SOURCE-COMPUTER. IBM-3090.                                       00310006
003200 OBJECT-COMPUTER. IBM-3090.                                       00320006
003300                                                                  00330006
003400 DATA DIVISION.                                                   00340006
003500 WORKING-STORAGE SECTION.                                         00350006
003600 01  PV-STUFF.                                                    00360006
003700     05  PV-INTR-UPC-ID               PIC S9(9) VALUE 0 COMP.     00370006
003800     05  PV-LOCATION-NBR              PIC S9(4) VALUE 0 COMP.     00380006
003900     05  PV-TRN-CLSN-QTY              PIC S9(9) VALUE 0 COMP.     00390006
004000     05  PV-TRN-CLSN-CDE              PIC X(02) VALUE SPACES.     00400006
004100                                                                  00410006
004200 01  DK-KEYS.                                                     00420006
004300     05  DK-SUB-CL-NBR                PIC X(03).                  00430006
004400                                                                  00440006
004500 01  PC-CONSTANTS.                                                00450006
004600     05  PC-IT                       PIC X(02)  VALUE 'IT'.       00460006
004700     05  PC-SE                       PIC X(02)  VALUE 'SE'.       00470006
004800     05  PC-INTERNAL-UPC-CDE         PIC X(02)  VALUE 'I'.        00480006
004900                                                                  00490006
005000***  XLWS001  - COMMAREA USED TO CALL XLKUT001                    00500006
005100     COPY XLWS001.                                                00510006
005200                                                                  00520006
005300***  PCT00014 - PCT_TRN_CLSN_BAL                                  00530006
005400     EXEC SQL                                                     00540006
005500         INCLUDE PCT00014                                         00550006
005600     END-EXEC.                                                    00560006
005700                                                                  00570006
005800     EXEC SQL                                                     00580006
005900          INCLUDE SQLCA                                           00590006
006000     END-EXEC.                                                    00600006
006100                                                                  00610006
006200                                                                  00620006
006300 LINKAGE SECTION.                                                 00630006
006400     COPY XLWS074.                                                00640006
006500                                                                  00650006
006600 PROCEDURE DIVISION USING XL074-ITEM-COMMAREA.                    00660006
006700                                                                  00670006
006800     SET XL074-SUCCESSFUL        TO TRUE.                         00680006
006900     INITIALIZE DCLPCT00014.                                      00690006
007000                                                                  00700006
007100     PERFORM 1000-VALIDATE-INPUT.                                 00710006
007200                                                                  00720006
007300     IF  XL074-SUCCESSFUL                                         00730009
007310         IF  XL074-BY-INTERNAL-UPC                                00731009
007311             MOVE XL074-KEY-INTR-UPC TO PV-INTR-UPC-ID            00731109
007312                                        XL074-INTR-UPC            00731209
007330         ELSE                                                     00733009
007400             PERFORM 2000-CALL-XLKUT001                           00740009
007410         END-IF                                                   00741009
007500     END-IF.                                                      00750006
007600                                                                  00760006
007700     IF XL074-SUCCESSFUL                                          00770006
007800        PERFORM 3000-RETRIEVE-QUANTITIES                          00780006
007900     END-IF.                                                      00790006
008000                                                                  00800006
008100     GOBACK.                                                      00810006
008200                                                                  00820006
008300****************************************************************  00830006
008400*    CHECK THAT THE APPROPRIATE KEY FIELD HAS BEEN FILLED IN   *  00840006
008500*        FOR THE ITEM ACCESS METHOD SELECTED.                  *  00850006
008600*                                                              *  00860006
008700*    CHECK THAT A VALID LOCATION ACCESS METHOD HAS BEEN        *  00870006
008800*        SELECTED WITH ANY REQUIRED INFORMATION.               *  00880006
008900****************************************************************  00890006
009000 1000-VALIDATE-INPUT.                                             00900006
009100                                                                  00910006
009200     EVALUATE TRUE                                                00920006
009300         WHEN XL074-BY-SKU                                        00930006
009400              IF XL074-KEY-SKU = 0                                00940006
009500                 SET XL074-SKU-IS-ZERO TO TRUE                    00950006
009600              END-IF                                              00960006
009700                                                                  00970006
009800         WHEN XL074-BY-ITEM                                       00980006
009900              IF XL074-KEY-ITEM-NBR = 0                           00990006
010000                 SET XL074-ITEM-NBR-IS-ZERO TO TRUE               01000006
010100              END-IF                                              01010006
010200                                                                  01020006
010300         WHEN XL074-BY-UPC-NBR                                    01030006
010400              IF XL074-KEY-UPC-NBR = 0                            01040006
010500                 SET XL074-UPC-NBR-IS-ZERO TO TRUE                01050006
010600              END-IF                                              01060006
010700                                                                  01070006
010800         WHEN XL074-BY-INTERNAL-UPC                               01080006
010900              IF XL074-KEY-INTR-UPC = 0                           01090006
011000                 SET XL074-INTR-UPC-IS-ZERO TO TRUE               01100006
011100              END-IF                                              01110006
011200                                                                  01120006
011300         WHEN OTHER                                               01130006
011400              SET XL074-INVALID-ITEM-ACCESS TO TRUE               01140006
011500                                                                  01150006
011600     END-EVALUATE.                                                01160006
011700                                                                  01170006
011800     IF XL074-SUCCESSFUL                                          01180006
011900        EVALUATE TRUE                                             01190006
012000            WHEN XL074-BY-STORE                                   01200006
012100                 IF XL074-KEY-LOC-NBR = 0                         01210006
012200                    SET XL074-LOCATION-NBR-IS-ZERO TO TRUE        01220006
012300                 ELSE                                             01230006
012400                    MOVE XL074-KEY-LOC-NBR TO PV-LOCATION-NBR     01240006
012500                 END-IF                                           01250006
012600                                                                  01260006
012700            WHEN XL074-BY-ALL-LOCATIONS                           01270006
012800                 CONTINUE                                         01280006
012900                                                                  01290006
013000            WHEN OTHER                                            01300006
013100                 SET XL074-INVALID-LOCATION-ACCESS TO TRUE        01310006
013200                                                                  01320006
013300        END-EVALUATE.                                             01330006
013400                                                                  01340006
013500****************************************************************  01350006
013600*    CONVERT THE COMMAREA SKU, ITEM NUMBER, OR UPC NUMBER TO   *  01360006
013700*    THE INTERNAL UPC NUMBER SO THE PCT00014 TABLE CAN BE      *  01370006
013800*    READ.  IF THE COMMAREA INTERNAL UPC IS ENTERED, SEND IT   *  01380006
013900*    TO XLKUT001 TO VALIDATE IT.                               *  01390006
014000*                                                              *  01400006
014100*    WHEN COMING BACK FROM XLKUT001:                           *  01410006
014200*        IF THE XL001-RETURN-CODE WAS SUCCESSFUL, EVERYTHING   *  01420006
014300*           WAS OK, SO JUST CONTINUE ON.                       *  01430006
014400*                                                              *  01440006
014500*        IF THE XL001-SKU-SQLCODE IS +100, THE SKU, ITEM, OR   *  01450006
014600*           INTERNAL UPC WAS NOT FOUND SO SET THE APPROPRIATE  *  01460006
014700*           ERROR SWITCH.                                      *  01470006
014800*                                                              *  01480006
014900*        IF THE XL001-UPC-SQLCODE IS +100, THE UPC NUMBER      *  01490006
015000*           WASN'T FOUND SO SET THE APPROPRIATE ERROR SWITCH.  *  01500006
015100*                                                              *  01510006
015200*        IF NONE OF THE ABOVE CONDITIONS ARE TRUE, THEN THERE  *  01520006
015300*           IS SOME OTHER ERROR FROM XLKUT001, SO MOVE THE     *  01530006
015400*           APPROPRIATE SQLCODE TO THE XLWS074 COMMAREA.       *  01540006
015500*                                                              *  01550006
015600****************************************************************  01560006
015700                                                                  01570006
015800 2000-CALL-XLKUT001.                                              01580006
015900                                                                  01590006
016000     INITIALIZE XL001-ITEM-COMMAREA.                              01600006
016100     EVALUATE TRUE                                                01610006
016200         WHEN XL074-BY-SKU                                        01620006
016300              MOVE XL074-KEY-SKU        TO XL001-KEY-SKU          01630006
016400              SET XL001-BY-NUMERIC-SKU  TO TRUE                   01640006
016500                                                                  01650006
016600         WHEN XL074-BY-ITEM                                       01660006
016700              MOVE XL074-KEY-ITEM-NBR   TO XL001-KEY-ITM-NBR      01670006
016800              SET XL001-BY-ITEM         TO TRUE                   01680006
016900                                                                  01690006
017000         WHEN XL074-BY-UPC-NBR                                    01700006
017100              MOVE XL074-KEY-UPC-NBR    TO XL001-KEY-UPC-NBR      01710006
017200              SET XL001-BY-UPC-NBR      TO TRUE                   01720006
017300                                                                  01730006
017400         WHEN XL074-BY-INTERNAL-UPC                               01740006
017500              MOVE XL074-KEY-INTR-UPC   TO XL001-KEY-INTR-UPC-ID  01750006
017600              SET XL001-BY-INTR-UPC-ID  TO TRUE                   01760006
017700                                                                  01770006
017800     END-EVALUATE.                                                01780006
017900                                                                  01790006
018000     SET XL001-SELECT-SKU      TO  TRUE.                          01800008
018100*        XL001-SELECT-SKU-STR                                     01810007
018200*        XL001-SELECT-UPC      TO  TRUE.                          01820008
018300                                                                  01830006
018400     CALL XL001-VSM-PGM USING XL001-ITEM-COMMAREA.                01840006
018500                                                                  01850006
018600     EVALUATE TRUE                                                01860006
018700         WHEN XL001-SUCCESSFUL                                    01870006
018800              MOVE XL001-INTR-UPC-ID TO PV-INTR-UPC-ID            01880006
018900                                        XL074-INTR-UPC            01890006
019000                                                                  01900006
019100         WHEN XL001-SKU-SQLCODE = +100                            01910006
019200              EVALUATE TRUE                                       01920006
019300                  WHEN XL074-BY-SKU                               01930006
019400                       SET  XL074-SKU-NOT-FOUND TO TRUE           01940006
019500                                                                  01950006
019600                  WHEN XL074-BY-ITEM                              01960006
019700                       SET  XL074-ITEM-NBR-NOT-FOUND TO TRUE      01970006
019800                                                                  01980006
019900                  WHEN XL074-BY-INTERNAL-UPC                      01990006
020000                       SET  XL074-INTR-UPC-NOT-FOUND TO TRUE      02000006
020100                                                                  02010006
020200              END-EVALUATE                                        02020006
020300                                                                  02030006
020400         WHEN XL001-UPC-SQLCODE = +100                            02040006
020500              SET  XL074-UPC-NOT-FOUND TO TRUE                    02050006
020600                                                                  02060006
020700         WHEN OTHER                                               02070006
020800              MOVE XL001-INTR-UPC-ID TO PV-INTR-UPC-ID            02080006
020900                                        XL074-INTR-UPC            02090006
021000****************************************************************  02100006
021100*    FOLLOWING SQL ERROR CODES ARE SET IN XLKUT001 IN THESE    *  02110006
021200*        PARAGRAPHES.                                          *  02120006
021300*    XL001-SKU-SQLCODE - 1010-, 2010-, 7000-, 7010-, 7020-     *  02130006
021400*    XL001-UPC-SQLCODE - 3010-, 7300-, 7350-                   *  02140006
021500*    XL001-VND-STYL-SQLCODE - 7100-, 7110-                     *  02150006
021600*    XL001-SKU-STR-SQLCODE  - 7200-                            *  02160006
021700*    XL001-WEB-SKU-SQLCODE  - 7400-                            *  02170006
021800*                                                              *  02180006
021900****************************************************************  02190006
022000              EVALUATE TRUE                                       02200006
022100                  WHEN XL001-SKU-SQLCODE NOT = 0                  02210006
022200                       MOVE XL001-SKU-SQLCODE TO XL074-SQLCODE    02220006
022300                                                                  02230006
022400                  WHEN XL001-UPC-SQLCODE NOT = 0                  02240006
022500                       MOVE XL001-UPC-SQLCODE TO XL074-SQLCODE    02250006
022600                                                                  02260006
022700                  WHEN XL001-VND-STYL-SQLCODE NOT = 0             02270006
022800                       MOVE XL001-VND-STYL-SQLCODE TO             02280006
022900                                           XL074-SQLCODE          02290006
023000                                                                  02300006
023100                  WHEN XL001-SKU-STR-SQLCODE NOT = 0              02310006
023200                       MOVE XL001-SKU-STR-SQLCODE TO              02320006
023300                                           XL074-SQLCODE          02330006
023400                                                                  02340006
023500                  WHEN XL001-WEB-SKU-SQLCODE NOT = 0              02350006
023600                       MOVE XL001-WEB-SKU-SQLCODE TO              02360006
023700                                          XL074-SQLCODE           02370006
023800                                                                  02380006
023900              END-EVALUATE                                        02390006
024000                                                                  02400006
024100****************************************************************  02410006
024200*             IF ONE OF THE ABOVE SQLCODES WAS NON-ZERO        *  02420006
024300*                FILL IN THE PARAGRAPH NAME                    *  02430006
024400****************************************************************  02440006
024500              IF XL074-SQLCODE NOT = 0                            02450006
024600                 IF XL001-ERROR-PARAGRAPH-NBR = SPACES            02460006
024700                    MOVE XL001-CONTENTION-ERR-PARA-NBR TO         02470006
024800                                 XL074-CALLED-PROGRAM-PARA        02480006
024900                 ELSE                                             02490006
025000                    MOVE XL001-ERROR-PARAGRAPH-NBR TO             02500006
025100                                 XL074-CALLED-PROGRAM-PARA        02510006
025200                 END-IF                                           02520006
025300              END-IF                                              02530006
025400                                                                  02540006
025500              IF XL001-SKU-SQLCODE     NOT = 0                    02550006
025600                 SET  XL074-SQL-ERROR TO TRUE                     02560006
025700                 MOVE '2000-' TO XL074-ERROR-PARAGRAPH-NBR        02570006
025800                 MOVE XL001-ERROR-PARAGRAPH-NBR TO                02580006
025900                                 XL074-CALLED-PROGRAM-PARA        02590006
026000                 MOVE XL001-SQLCA   TO XL074-SQLCA                02600006
026100              END-IF                                              02610006
026200                                                                  02620006
026300     END-EVALUATE.                                                02630006
026400                                                                  02640006
026500****************************************************************  02650006
026600*    RETRIEVE THE INTRANSIT QUANTITY FIRST, THEN THE STORE     *  02660006
026700*        EXPECTED QUANTITY.                                    *  02670006
026800*                                                              *  02680006
026900****************************************************************  02690006
027000                                                                  02700006
027100 3000-RETRIEVE-QUANTITIES.                                        02710006
027200                                                                  02720006
027300     MOVE PC-IT  TO PV-TRN-CLSN-CDE.                              02730006
027400                                                                  02740006
027500     PERFORM 4000-SELECT-PCT00014.                                02750006
027600                                                                  02760006
027700     MOVE PCT00014-TRN-CLSN-QTY TO XL074-IT-QTY.                  02770006
027800                                                                  02780006
027900     MOVE PC-SE  TO PV-TRN-CLSN-CDE.                              02790006
028000                                                                  02800006
028100     PERFORM 4000-SELECT-PCT00014.                                02810006
028200                                                                  02820006
028300     MOVE PCT00014-TRN-CLSN-QTY TO XL074-SE-QTY.                  02830006
028400                                                                  02840006
028500****************************************************************  02850006
028600*    IF THIS IS A STORE REQUEST, RETRIEVE ONLY THE QUANTITY    *  02860006
028700*       FOR THAT STORE, OTHERWISE RETRIEVE THE SUM OF ALL      *  02870006
028800*       THE QUANTITIES FOR ALL LOCATIONS.                      *  02880006
028900*                                                              *  02890006
029000****************************************************************  02900006
029100                                                                  02910006
029200 4000-SELECT-PCT00014.                                            02920006
029300                                                                  02930006
029400     IF XL074-BY-STORE                                            02940006
029500        EXEC SQL                                                  02950006
029600         SELECT   TRN_CLSN_QTY                                    02960006
029700                                                                  02970006
029800           INTO  :PCT00014-TRN-CLSN-QTY                           02980006
029900                                                                  02990006
030000           FROM  PCT_TRN_CLSN_BAL                                 03000006
030100          WHERE  INTR_UPC_ID   = :PV-INTR-UPC-ID                  03010006
030200            AND  TRN_CLSN_CDE  = :PV-TRN-CLSN-CDE                 03020006
030300            AND  LOC_NBR       = :PV-LOCATION-NBR                 03030006
030400           WITH  UR                                               03040006
030500        END-EXEC                                                  03050006
030600     ELSE                                                         03060006
030700        EXEC SQL                                                  03070006
030800         SELECT   SUM(TRN_CLSN_QTY)                               03080006
030900                                                                  03090006
031000           INTO  :PCT00014-TRN-CLSN-QTY                           03100006
031100                                                                  03110006
031200           FROM  PCT_TRN_CLSN_BAL                                 03120006
031300          WHERE  INTR_UPC_ID   = :PV-INTR-UPC-ID                  03130006
031400            AND  TRN_CLSN_CDE  = :PV-TRN-CLSN-CDE                 03140006
031500           WITH  UR                                               03150006
031600        END-EXEC                                                  03160006
031700     END-IF.                                                      03170006
031800                                                                  03180006
031900     EVALUATE TRUE                                                03190006
032000         WHEN SQLCODE = ZERO                                      03200006
032100              CONTINUE                                            03210006
032200                                                                  03220006
032300         WHEN SQLCODE = +100                                      03230006
032400         WHEN SQLCODE = -305                                      03240006
032500              MOVE 0 TO PCT00014-TRN-CLSN-QTY                     03250006
032600                                                                  03260006
032700         WHEN OTHER                                               03270006
032800              SET  XL074-SQL-ERROR TO TRUE                        03280006
032900              MOVE '4000-' TO XL074-ERROR-PARAGRAPH-NBR           03290006
033000              MOVE SQLCODE TO XL074-SQLCODE                       03300006
033100              MOVE SQLCA   TO XL074-SQLCA                         03310006
033200                                                                  03320006
033300     END-EVALUATE.                                                03330006
033400                                                                  03340006
