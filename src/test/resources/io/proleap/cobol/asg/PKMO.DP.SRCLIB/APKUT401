000100 IDENTIFICATION DIVISION.                                         00010018
000200 PROGRAM-ID.     APKUT401.                                        00020018
000300 AUTHOR.         MARILYN WILKINSON.                               00030018
000400*DATE-WRITTEN.   10/28/96.                                        00040018
000500*DATE-COMPILED.                                                   00050018
000600*************************************************************     00060018
000700*    COBOL 2 WITH SQL                                       *     00070018
000800*                                                           *     00080018
000900*    PULL PURCHASE ITEM INFO PER INPUT FILE                 *     00090018
001000*                                                           *     00100018
001100*    TPURITM - PURCHASE ORDER ITEM TABLE                    *     00110018
001200*    TSKXREF - SKU CROSS REFERENCE TABLE                    *     00120018
001300*                                                           *     00130018
001400* INPUT:                                                    *     00140018
001500* 1.  PO NUMBER FILE                                        *     00150018
001600*                                                           *     00160018
001700* OUTPUT:                                                   *     00170018
001800* 1.  FLAT FILE OF PURCHASE ITEM DATA                       *     00180018
001900*                                                           *     00190018
002000*************************************************************     00200018
002100* CHANGE LOG:                                               *     00210018
002200*                                                           *     00220018
002300* 10/28/96    INITIAL VERSION.                              *     00230018
002400*                                                           *     00240018
002500* 04/20/2000  JILL JUEL                      WR# 20563      *     00250018
002600*             INCREASE SIZE OF INPUT RECORD, COPYBOOK       *     00260018
002700*             APRD400 WAS CHANGED.                          *     00270018
002800*                                                           *     00280018
002900*  DATE  05/02/2003                                         *     00290018
003000*      CHANGE MADE: CHANGE NEEDED FOR ARK PO NI-SKU.        *     00300018
003100*      REPLACED SKU-SEQ-NBR WITH SKU-NBR. ADDED TSKXREF TO  *     00310018
003200*      OBTAIN SKU NUMBER IF THE TPURITM RMS-PO-SKU-NBR IS   *     00320018
003300*      ZERO.                                                *     00330018
003400*      MADE BY: ROLLIN KRING            WR/IR #: WR22557    *     00340018
003500*                                                           *     00350018
003510*  DATE  02/04/2008                                         *     00351019
003520*      CHANGE MADE: USE 1ST COST FOR DOMESTIC POS.          *     00352018
003530*      MADE BY: CHRISTINE TWIEHAUS      WR/IR #: WR32664    *     00353018
003540*                                                           *     00354018
003541*  DATE  05/17/2011                                         *     00354122
003542*      CHANGE MADE: ADD 1ST COST FOR ALL.                   *     00354221
003543*      MADE BY: SCOTT KRUSCHKA          WR/IR #: WR39234    *     00354321
003544*                                                           *     00354421
003550*************************************************************     00355018
003560                                                                  00356018
003570 ENVIRONMENT DIVISION.                                            00357018
003580                                                                  00358018
003590 INPUT-OUTPUT SECTION.                                            00359018
003600                                                                  00360018
003700 FILE-CONTROL.                                                    00370018
003800                                                                  00380018
003900     SELECT PO-NBR-FILE                                           00390018
004000         ASSIGN         TO UT-S-INP01.                            00400018
004100     SELECT PURITM-OUT-AP401-FILE                                 00410018
004200         ASSIGN         TO UT-S-OUT01.                            00420018
004300                                                                  00430018
004400 DATA DIVISION.                                                   00440018
004500                                                                  00450018
004600 FILE SECTION.                                                    00460018
004700                                                                  00470018
004800 FD  PO-NBR-FILE                                                  00480018
004900     RECORDING MODE IS F                                          00490018
005000     LABEL RECORDS ARE STANDARD                                   00500018
005100     BLOCK CONTAINS 0 RECORDS                                     00510018
005200     DATA RECORD IS PO-NBR-REC.                                   00520018
005300 01  PO-NBR-REC.                                                  00530018
005400     05  FILLER                       PIC  X(800).                00540018
005500                                                                  00550018
005600 FD  PURITM-OUT-AP401-FILE                                        00560018
005700         LABEL RECORDS  ARE STANDARD                              00570018
005800         RECORDING MODE IS  F                                     00580018
005900         DATA RECORD    IS  PURITM-OUT-AP401-RECORD.              00590018
006000                                                                  00600018
006100 01  PURITM-OUT-AP401-RECORD PIC X(325).                          00610018
006200                                                                  00620018
006300                                                                  00630018
006400/                                                                 00640018
006500 WORKING-STORAGE SECTION.                                         00650018
006600                                                                  00660018
006700 01  FILLER                        PIC X(25) VALUE                00670018
006800                             'WS FOR APKUT401 BEGINS==>'.         00680018
006900 01  PV-RECORDS-WRITTEN            PIC 9(09) VALUE ZEROS.         00690018
007000                                                                  00700018
007100 01  HOLD-PO-NBR                   PIC S9(9) COMP SYNC            00710018
007200                                             VALUE ZEROS.         00720018
007300 01  ABEND-CODE                    PIC S9(4) COMP SYNC            00730018
007400                                             VALUE ZEROS.         00740018
007500     88 AP-DB2-ERROR               VALUE +4013.                   00750018
007600                                                                  00760018
007700     COPY APRD400.                                                00770018
007800                                                                  00780018
007900 01  PV-RETRY-COUNTER              PIC S9(4) COMP VALUE ZERO.     00790018
008000 01  PV-ABEND-FIELDS.                                             00800018
008100     05  PV-ABEND-PROGRAM             PIC X(8)  VALUE 'APKUT401'. 00810018
008200     05  PV-ABEND-PARAGRAPH           PIC X(50) VALUE SPACES.     00820018
008300     05  PV-ABEND-OPERATION           PIC X(50) VALUE SPACES.     00830018
008400     05  PV-ABEND-STRUCTURE-1         PIC X(8)  VALUE SPACES.     00840018
008500     05  PV-ABEND-STRUCTURE-2         PIC X(8)  VALUE SPACES.     00850018
008600     05  PV-ABEND-STRUCTURE-3         PIC X(8)  VALUE SPACES.     00860018
008700     05  PV-ABEND-STATUS              PIC XX    VALUE SPACES.     00870018
008800                                                                  00880018
008900 01  PV-SWITCHES.                                                 00890018
009000     05  END-OF-POS-SW                PIC X(03) VALUE 'NO '.      00900018
009100         88  PO-NBR-EOF               VALUE 'YES'.                00910018
009200     05  END-OF-JOB-SW                PIC X(03) VALUE 'NO '.      00920018
009300         88  END-OF-DATA              VALUE 'YES'.                00930018
009400         88  NOT-END-OF-DATA          VALUE 'NO '.                00940018
009500     05  PURITM-DATA-SW               PIC X(03) VALUE 'NO '.      00950018
009600         88  MORE-PURITM-DATA         VALUE 'YES'.                00960018
009700         88  NO-MORE-PURITM-DATA      VALUE 'NO '.                00970018
009800                                                                  00980018
009900 01  RUN-TIME.                                                    00990018
010000     05  R-HR                    PIC 99.                          01000018
010100     05  R-MIN                   PIC 99.                          01010018
010200     05  R-SEC                   PIC 99.                          01020018
010300     05  R-TH                    PIC 99.                          01030018
010400*                                                                 01040018
010500 01  DATE-IN.                                                     01050018
010600     05 DATE-IN-YY               PIC XX.                          01060018
010700     05 DATE-IN-MM               PIC XX.                          01070018
010800     05 DATE-IN-DD               PIC XX.                          01080018
010900                                                                  01090018
011000 01  PV-JULIAN-DATE              PIC 9(05)  VALUE ZEROS.          01100018
011100/                                                                 01110018
011200*                                                                 01120018
011300******************************************************************01130018
011400 01  FILLER                      PIC X(35)  VALUE                 01140018
011500     'BEGINNING OF AP401 OUTPUT FILE   **'.                       01150018
011600******************************************************************01160018
011700 01  PV-OUTFILE.                                                  01170018
011800     COPY APRD401.                                                01180018
011900******************************************************************01190018
012000*                                                                 01200018
012100******************************************************************01210018
012200     COPY DPWS004.                                                01220018
012300******************************************************************01230018
012400*                                                                 01240018
012500******************************************************************01250018
012600*  COMMUNICATIONS AREA2 FOR DB2                                   01260018
012700******************************************************************01270018
012800     COPY SQLCA2.                                                 01280018
012900******************************************************************01290018
013000     EXEC SQL                                                     01300018
013100          INCLUDE SQLCA                                           01310018
013200     END-EXEC.                                                    01320018
013300 EJECT                                                            01330018
013400******************************************************************01340018
013500*  DCLGEN FOR TPURITM                                             01350018
013600******************************************************************01360018
013700     EXEC SQL                                                     01370018
013800          INCLUDE TPURITM                                         01380018
013900     END-EXEC.                                                    01390018
014000 EJECT                                                            01400018
014100******************************************************************01410018
014200*  DCLGEN FOR TSKXREF                                             01420018
014300******************************************************************01430018
014400     EXEC SQL                                                     01440018
014500          INCLUDE TSKXREF                                         01450018
014600     END-EXEC.                                                    01460018
014700 EJECT                                                            01470018
014800******************************************************************01480018
014900*  CURSOR TO PULL BACK TPURITM DATA                               01490018
015000******************************************************************01500018
015100     EXEC SQL                                                     01510018
015200       DECLARE PURITM_CSR CURSOR FOR                              01520018
015300         SELECT                                                   01530018
015400               PO_NBR                                             01540018
015500              ,VER_NBR                                            01550018
015600              ,PO_LNE_NBR                                         01560018
015700              ,VER_STATUS_CDE                                     01570018
015800              ,RMS_PO_SKU_NBR                                     01580018
015900              ,CL_NBR                                             01590018
016000              ,VEND_STYL_NAME                                     01600018
016100              ,COLOR_DESC                                         01610018
016200              ,SIZE_DESC                                          01620018
016300              ,UM_IND                                             01630018
016400              ,UNT_QTY                                            01640018
016500              ,UNT_RTL_PR_AMT                                     01650018
016600              ,UNT_COST_AMT                                       01660018
016700              ,PRD_1ST_COST_AMT                                   01670018
016800              ,TOT_VAL_COST_AMT                                   01680018
016900              ,TOT_VAL_RTL_AMT                                    01690018
017000              ,MU_PCT                                             01700018
017100              ,CRE_TMST                                           01710018
017200              ,LAST_UPD_TMST                                      01720018
017300              ,ITM_NBR                                            01730018
017400              ,SKU_DESC                                           01740018
017500              ,COLOR_CDE                                          01750018
017600              ,SIZE_CDE                                           01760018
017700              ,AD_EVNT_DTE                                        01770018
017800              ,STATUS_CDE                                         01780018
017900              ,CRE_BY_UID                                         01790018
018000              ,LAST_UPD_BY_UID                                    01800018
018100              ,GP_RTL_AMT                                         01810018
018200              ,GP_QTY                                             01820018
018300              ,APP_PO_LNE_NBR                                     01830018
018400              ,PIC_ITM_IND                                        01840018
018500              ,PIC_PG_NBR                                         01850018
018600         FROM                                                     01860018
018700             TPURITM                                              01870018
018800         WHERE PO_NBR        = :HOLD-PO-NBR                       01880018
018900              AND VER_STATUS_CDE = 'A'                            01890018
019000         ORDER BY VER_NBR, PO_LNE_NBR                             01900018
019100     END-EXEC.                                                    01910018
019200 EJECT                                                            01920018
019300******************************************************************01930018
019400*LINKAGE SECTION.                                                 01940018
019500******************************************************************01950018
019600*                                                                 01960018
019700 PROCEDURE DIVISION.                                              01970018
019800                                                                  01980018
019900 A100-MAINLINE.                                                   01990018
020000                                                                  02000018
020100     PERFORM H100-HOUSEKEEPING.                                   02010018
020200                                                                  02020018
020300     PERFORM B100-PROCESSING                                      02030018
020400         UNTIL PO-NBR-EOF.                                        02040018
020500                                                                  02050018
020600     PERFORM Z900-END-OF-JOB.                                     02060018
020700                                                                  02070018
020800     GOBACK.                                                      02080018
020900        EJECT                                                     02090018
021000                                                                  02100018
021100 B100-PROCESSING.                                                 02110018
021200*                                                                 02120018
021300***************************************************************** 02130018
021400*     FOR EACH PO NBR IN RECORD, PULL PURITM DATA AND WRITE TO    02140018
021500*     FLAT FILE.                                                  02150018
021600***************************************************************** 02160018
021700*                                                                 02170018
021800     SET MORE-PURITM-DATA TO TRUE.                                02180018
021900     MOVE AP400-PO-NBR    TO HOLD-PO-NBR.                         02190018
022000                                                                  02200018
022100     PERFORM Y100-OPEN-PURITM-CSR.                                02210018
022200     PERFORM R100-FETCH-PURITM                                    02220018
022300         UNTIL NO-MORE-PURITM-DATA.                               02230018
022400     PERFORM Y200-CLOSE-PURITM-CSR.                               02240018
022500                                                                  02250018
022600     READ PO-NBR-FILE INTO AP400-PO-EXTRACT-RECORD                02260018
022700         AT END SET PO-NBR-EOF TO TRUE.                           02270018
022800                                                                  02280018
022900    EJECT                                                         02290018
023000 H100-HOUSEKEEPING.                                               02300018
023100*                                                                 02310018
023200***************************************************************** 02320018
023300*    GET DATE, TIME, OPEN FILES, SET UP CONTROLS, ETC             02330018
023400***************************************************************** 02340018
023500*                                                                 02350018
023600     ACCEPT RUN-TIME FROM TIME.                                   02360018
023700     ACCEPT DATE-IN  FROM DATE.                                   02370018
023800     ACCEPT PV-JULIAN-DATE FROM DAY.                              02380018
023900                                                                  02390018
024000     OPEN  INPUT   PO-NBR-FILE                                    02400018
024100           OUTPUT  PURITM-OUT-AP401-FILE.                         02410018
024200     INITIALIZE PV-OUTFILE.                                       02420018
024300                                                                  02430018
024400     READ PO-NBR-FILE INTO AP400-PO-EXTRACT-RECORD                02440018
024500         AT END SET PO-NBR-EOF TO TRUE.                           02450018
024600                                                                  02460018
024700*                                                                 02470018
024800***************************************************************** 02480018
024900*     FETCH PURCHASE ITEM DATA                                    02490018
025000***************************************************************** 02500018
025100*                                                                 02510018
025200 R100-FETCH-PURITM.                                               02520018
025300*                                                                 02530018
025400     PERFORM WITH TEST AFTER                                      02540018
025500        VARYING PV-RETRY-COUNTER FROM 1 BY 1                      02550018
025600        UNTIL   PV-RETRY-COUNTER > 3  OR                          02560018
025700                SQLCODE = ZERO OR                                 02570018
025800                SQLCODE = +100                                    02580018
025900        EXEC SQL                                                  02590018
026000            FETCH PURITM_CSR                                      02600018
026100            INTO                                                  02610018
026200                 :PURITM-PO-NBR                                   02620018
026300               , :PURITM-VER-NBR                                  02630018
026400               , :PURITM-PO-LNE-NBR                               02640018
026500               , :PURITM-VER-STATUS-CDE                           02650018
026600               , :PURITM-RMS-PO-SKU-NBR                           02660018
026700               , :PURITM-CL-NBR                                   02670018
026800               , :PURITM-VEND-STYL-NAME                           02680018
026900               , :PURITM-COLOR-DESC                               02690018
027000               , :PURITM-SIZE-DESC                                02700018
027100               , :PURITM-UM-IND                                   02710018
027200               , :PURITM-UNT-QTY                                  02720018
027300               , :PURITM-UNT-RTL-PR-AMT                           02730018
027400               , :PURITM-UNT-COST-AMT                             02740018
027500               , :PURITM-PRD-1ST-COST-AMT                         02750018
027600               , :PURITM-TOT-VAL-COST-AMT                         02760018
027700               , :PURITM-TOT-VAL-RTL-AMT                          02770018
027800               , :PURITM-MU-PCT                                   02780018
027900               , :PURITM-CRE-TMST                                 02790018
028000               , :PURITM-LAST-UPD-TMST                            02800018
028100               , :PURITM-ITM-NBR                                  02810018
028200               , :PURITM-SKU-DESC                                 02820018
028300               , :PURITM-COLOR-CDE                                02830018
028400               , :PURITM-SIZE-CDE                                 02840018
028500               , :PURITM-AD-EVNT-DTE                              02850018
028600               , :PURITM-STATUS-CDE                               02860018
028700               , :PURITM-CRE-BY-UID                               02870018
028800               , :PURITM-LAST-UPD-BY-UID                          02880018
028900               , :PURITM-GP-RTL-AMT                               02890018
029000               , :PURITM-GP-QTY                                   02900018
029100               , :PURITM-APP-PO-LNE-NBR                           02910018
029200               , :PURITM-PIC-ITM-IND                              02920018
029300               , :PURITM-PIC-PG-NBR                               02930018
029400        END-EXEC                                                  02940018
029500                                                                  02950018
029600        EVALUATE TRUE                                             02960018
029700            WHEN SQLCODE = ZERO                                   02970018
029800                 IF PURITM-RMS-PO-SKU-NBR = ZERO                  02980018
029900                    PERFORM R200-SELECT-SKU                       02990018
030000                    MOVE SKXREF-SKU            TO AP401-SKU-NBR   03000018
030100                 ELSE                                             03010018
030200                    MOVE PURITM-RMS-PO-SKU-NBR TO AP401-SKU-NBR   03020018
030300                 END-IF                                           03030018
030400                 PERFORM W100-WRITE-OUTFILE                       03040018
030500            WHEN SQLCODE = +100                                   03050018
030600                 SET NO-MORE-PURITM-DATA TO TRUE                  03060018
030700            WHEN SQLCODE = -904                                   03070018
030800            WHEN SQLCODE = -913                                   03080018
030900              CONTINUE                                            03090018
031000            WHEN SQLWARN0 NOT = SPACES                            03100018
031100            WHEN SQLCODE  NOT = ZERO                              03110018
031200              MOVE 'R100-FETCH-PURITM '                           03120018
031300                            TO PV-ABEND-PARAGRAPH                 03130018
031400              MOVE 'UNSUCCESSFUL FETCH  PURITM'                   03140018
031500                            TO PV-ABEND-OPERATION                 03150018
031600              MOVE 'TPURITM ' TO PV-ABEND-STRUCTURE-1             03160018
031700              MOVE SPACES     TO PV-ABEND-STRUCTURE-2             03170018
031800                                 PV-ABEND-STRUCTURE-3             03180018
031900              PERFORM Z999-SQL-ERROR                              03190018
032000           END-EVALUATE                                           03200018
032100         END-PERFORM.                                             03210018
032200                                                                  03220018
032300     IF PV-RETRY-COUNTER > 3                                      03230018
032400         MOVE 'R100-FETCH-PURITM '                                03240018
032500                       TO PV-ABEND-PARAGRAPH                      03250018
032600         MOVE 'MAX RETRIES EXCEEDED ON FETCH  PURITM'             03260018
032700                         TO PV-ABEND-OPERATION                    03270018
032800         PERFORM Z999-SQL-ERROR                                   03280018
032900     END-IF.                                                      03290018
033000 EJECT                                                            03300018
033100*                                                                 03310018
033200***************************************************************** 03320018
033300*     SELECT SKU FROM TSKXREF                                     03330018
033400***************************************************************** 03340018
033500*                                                                 03350018
033600 R200-SELECT-SKU.                                                 03360018
033700*                                                                 03370018
033800     PERFORM WITH TEST AFTER                                      03380018
033900        VARYING PV-RETRY-COUNTER FROM 1 BY 1                      03390018
034000        UNTIL   PV-RETRY-COUNTER > 3  OR                          03400018
034100                SQLCODE = ZERO OR                                 03410018
034200                SQLCODE = +100                                    03420018
034300                                                                  03430018
034400         EXEC SQL                                                 03440018
034500             SELECT  SKU                                          03450018
034600               INTO :SKXREF-SKU                                   03460018
034700             FROM TSKXREF                                         03470018
034800             WHERE ITM_NBR = :PURITM-ITM-NBR                      03480018
034900         END-EXEC                                                 03490018
035000                                                                  03500018
035100        EVALUATE TRUE                                             03510018
035200            WHEN SQLCODE = ZERO                                   03520018
035300              CONTINUE                                            03530018
035400            WHEN SQLCODE = +100                                   03540018
035500              MOVE ZEROS TO SKXREF-SKU                            03550018
035600            WHEN SQLCODE = -904                                   03560018
035700            WHEN SQLCODE = -913                                   03570018
035800              CONTINUE                                            03580018
035900            WHEN SQLWARN0 NOT = SPACES                            03590018
036000            WHEN SQLCODE  NOT = ZERO                              03600018
036100              MOVE 'R200-SELECT-SKU   '                           03610018
036200                            TO PV-ABEND-PARAGRAPH                 03620018
036300              MOVE 'UNSUCCESSFUL FETCH  TSKXREF'                  03630018
036400                            TO PV-ABEND-OPERATION                 03640018
036500              MOVE 'TSKXREF ' TO PV-ABEND-STRUCTURE-1             03650018
036600              MOVE SPACES     TO PV-ABEND-STRUCTURE-2             03660018
036700                                 PV-ABEND-STRUCTURE-3             03670018
036800              PERFORM Z999-SQL-ERROR                              03680018
036900           END-EVALUATE                                           03690018
037000         END-PERFORM.                                             03700018
037100                                                                  03710018
037200     IF PV-RETRY-COUNTER > 3                                      03720018
037300         MOVE 'R200-SELECT-SKU   '                                03730018
037400                       TO PV-ABEND-PARAGRAPH                      03740018
037500         MOVE 'MAX RETRIES EXCEEDED ON FETCH TSKXREF'             03750018
037600                         TO PV-ABEND-OPERATION                    03760018
037700         PERFORM Z999-SQL-ERROR                                   03770018
037800     END-IF.                                                      03780018
037900 EJECT                                                            03790018
038000*                                                                 03800018
038100 W100-WRITE-OUTFILE.                                              03810018
038200                                                                  03820018
038300     MOVE  PURITM-PO-NBR           TO AP401-PO-NBR.               03830018
038400     MOVE  PURITM-VER-NBR          TO AP401-VER-NBR.              03840018
038500     MOVE  PURITM-PO-LNE-NBR       TO AP401-PO-LNE-NBR.           03850018
038600     MOVE  PURITM-VER-STATUS-CDE   TO AP401-VER-STATUS-CDE.       03860018
038700     MOVE  PURITM-CL-NBR           TO AP401-CL-NBR.               03870018
038800     MOVE  PURITM-VEND-STYL-NAME   TO AP401-VEND-STYL-NAME.       03880018
038900     MOVE  PURITM-COLOR-DESC       TO AP401-COLOR-DESC.           03890018
039000     MOVE  PURITM-SIZE-DESC        TO AP401-SIZE-DESC.            03900018
039100     MOVE  PURITM-UM-IND           TO AP401-UM-IND.               03910018
039200     MOVE  PURITM-UNT-QTY          TO AP401-UNT-QTY.              03920018
039300     MOVE  PURITM-UNT-RTL-PR-AMT   TO AP401-UNT-RTL-PR-AMT.       03930018
039500     MOVE  PURITM-UNT-COST-AMT     TO AP401-UNT-COST-AMT.         03950020
039730     MOVE  PURITM-PRD-1ST-COST-AMT TO AP401-1ST-COST-AMT.         03973020
039760     MOVE  PURITM-TOT-VAL-COST-AMT TO AP401-TOT-VAL-COST-AMT.     03976018
039770     MOVE  PURITM-TOT-VAL-RTL-AMT  TO AP401-TOT-VAL-RTL-AMT.      03977018
039780     MOVE  PURITM-MU-PCT           TO AP401-MU-PCT.               03978018
039790     MOVE  PURITM-CRE-TMST         TO AP401-CRE-TMST.             03979018
039800     MOVE  PURITM-LAST-UPD-TMST    TO AP401-LAST-UPD-TMST.        03980018
039900     MOVE  PURITM-ITM-NBR          TO AP401-ITM-NBR.              03990018
040000     MOVE  PURITM-SKU-DESC         TO AP401-SKU-DESC.             04000018
040100     MOVE  PURITM-COLOR-CDE        TO AP401-COLOR-CDE.            04010018
040200     MOVE  PURITM-SIZE-CDE         TO AP401-SIZE-CDE.             04020018
040300     MOVE  PURITM-AD-EVNT-DTE      TO AP401-AD-EVNT-DTE.          04030018
040400     MOVE  PURITM-STATUS-CDE       TO AP401-STATUS-CDE.           04040018
040500     MOVE  PURITM-CRE-BY-UID       TO AP401-CRE-BY-UID.           04050018
040600     MOVE  PURITM-LAST-UPD-BY-UID  TO AP401-LAST-UPD-BY-UID.      04060018
040700     MOVE  PURITM-GP-RTL-AMT       TO AP401-GP-RTL-AMT.           04070018
040800     MOVE  PURITM-GP-QTY           TO AP401-GP-QTY.               04080018
040900     MOVE  PURITM-APP-PO-LNE-NBR   TO AP401-APP-PO-LNE-NBR.       04090018
041000     MOVE  PURITM-PIC-ITM-IND      TO AP401-PIC-ITM-IND.          04100018
041100     MOVE  PURITM-PIC-PG-NBR       TO AP401-PIC-PG-NBR.           04110018
041200                                                                  04120018
041300     WRITE PURITM-OUT-AP401-RECORD FROM PV-OUTFILE.               04130018
041400                                                                  04140018
041500     ADD 1 TO PV-RECORDS-WRITTEN.                                 04150018
041600     INITIALIZE PV-OUTFILE.                                       04160018
041700                                                                  04170018
041800 EJECT                                                            04180018
041900***************************************************************** 04190018
042000*     OPEN PURCHASE ITEM CURSOR                                   04200018
042100***************************************************************** 04210018
042200*                                                                 04220018
042300 Y100-OPEN-PURITM-CSR.                                            04230018
042400     PERFORM WITH TEST AFTER                                      04240018
042500             VARYING PV-RETRY-COUNTER FROM 1 BY 1                 04250018
042600             UNTIL   PV-RETRY-COUNTER > 3  OR                     04260018
042700                     SQLCODE = ZERO                               04270018
042800                                                                  04280018
042900             EXEC SQL                                             04290018
043000                OPEN PURITM_CSR                                   04300018
043100             END-EXEC                                             04310018
043200                                                                  04320018
043300             EVALUATE TRUE                                        04330018
043400                 WHEN SQLCODE = ZERO                              04340018
043500                 WHEN SQLCODE = -904                              04350018
043600                 WHEN SQLCODE = -913                              04360018
043700                      CONTINUE                                    04370018
043800                                                                  04380018
043900                 WHEN SQLWARN0 NOT = SPACES                       04390018
044000                 WHEN SQLCODE  NOT = ZERO                         04400018
044100                      MOVE 'Y100-OPEN-PURITM-CSR          '       04410018
044200                                    TO PV-ABEND-PARAGRAPH         04420018
044300                      MOVE 'UNSUCCESSFUL OPEN   PURITM  '         04430018
044400                                    TO PV-ABEND-OPERATION         04440018
044500                      MOVE 'TPURITM ' TO PV-ABEND-STRUCTURE-1     04450018
044600                      MOVE SPACES     TO PV-ABEND-STRUCTURE-2     04460018
044700                      MOVE SPACES     TO PV-ABEND-STRUCTURE-3     04470018
044800                      PERFORM Z999-SQL-ERROR                      04480018
044900             END-EVALUATE                                         04490018
045000     END-PERFORM.                                                 04500018
045100                                                                  04510018
045200     IF PV-RETRY-COUNTER > 3                                      04520018
045300         MOVE 'Y100-OPEN-PURITM-CSR          '                    04530018
045400                       TO PV-ABEND-PARAGRAPH                      04540018
045500         MOVE 'MAX RETRIES EXCEEDED ON OPEN   PURITM'             04550018
045600                         TO PV-ABEND-OPERATION                    04560018
045700         PERFORM Z999-SQL-ERROR.                                  04570018
045800                                                                  04580018
045900*                                                                 04590018
046000***************************************************************** 04600018
046100*     CLOSE PURCHASE ITEM CURSOR                                  04610018
046200***************************************************************** 04620018
046300*                                                                 04630018
046400 Y200-CLOSE-PURITM-CSR.                                           04640018
046500     PERFORM WITH TEST AFTER                                      04650018
046600             VARYING PV-RETRY-COUNTER FROM 1 BY 1                 04660018
046700             UNTIL   PV-RETRY-COUNTER > 3  OR                     04670018
046800                     SQLCODE = ZERO                               04680018
046900                                                                  04690018
047000             EXEC SQL                                             04700018
047100                CLOSE PURITM_CSR                                  04710018
047200             END-EXEC                                             04720018
047300                                                                  04730018
047400             EVALUATE TRUE                                        04740018
047500                 WHEN SQLCODE = ZERO                              04750018
047600                 WHEN SQLCODE = +100                              04760018
047700                 WHEN SQLCODE = -904                              04770018
047800                 WHEN SQLCODE = -913                              04780018
047900                      CONTINUE                                    04790018
048000                                                                  04800018
048100                 WHEN SQLWARN0 NOT = SPACES                       04810018
048200                 WHEN SQLCODE  NOT = ZERO                         04820018
048300                      MOVE 'Y200-CLOSE-PURITM-CSR          '      04830018
048400                                    TO PV-ABEND-PARAGRAPH         04840018
048500                      MOVE 'UNSUCCESSFUL CLOSE   PURITM  '        04850018
048600                                    TO PV-ABEND-OPERATION         04860018
048700                      MOVE 'TPURITM ' TO PV-ABEND-STRUCTURE-1     04870018
048800                      MOVE SPACES     TO PV-ABEND-STRUCTURE-2     04880018
048900                      MOVE SPACES     TO PV-ABEND-STRUCTURE-3     04890018
049000                      PERFORM Z999-SQL-ERROR                      04900018
049100             END-EVALUATE                                         04910018
049200     END-PERFORM.                                                 04920018
049300                                                                  04930018
049400     IF PV-RETRY-COUNTER > 3                                      04940018
049500         MOVE 'Y200-CLOSE-PURITM-CSR          '                   04950018
049600                       TO PV-ABEND-PARAGRAPH                      04960018
049700         MOVE 'MAX RETRIES EXCEEDED ON CLOSE  PURITM'             04970018
049800                         TO PV-ABEND-OPERATION                    04980018
049900         PERFORM Z999-SQL-ERROR.                                  04990018
050000                                                                  05000018
050100 EJECT                                                            05010018
050200***************************************************************** 05020018
050300*     FINISH THE ERROR PROCESS, REPORT ON NECESSARY TOTALS,       05030018
050400*     AND CLOSE ALL FILES                                         05040018
050500***************************************************************** 05050018
050600 Z900-END-OF-JOB.                                                 05060018
050700*                                                                 05070018
050800     CLOSE PO-NBR-FILE                                            05080018
050900           PURITM-OUT-AP401-FILE.                                 05090018
051000                                                                  05100018
051100     DISPLAY '************************************************'.  05110018
051200     DISPLAY 'TOTAL PURCHASE WRITTEN         = '                  05120018
051300              PV-RECORDS-WRITTEN.                                 05130018
051400     DISPLAY '************************************************'.  05140018
051500                                                                  05150018
051600     DISPLAY ' PROGRAM APKUT401 ENDS NORMALLY '.                  05160018
051700                                                                  05170018
051800     ACCEPT RUN-TIME FROM TIME.                                   05180018
051900     ACCEPT DATE-IN  FROM DATE.                                   05190018
052000                                                                  05200018
052100     DISPLAY ' RUN-DATE = ' DATE-IN '   RUN-TIME = ' RUN-TIME.    05210018
052200     DISPLAY '************************************************'.  05220018
052300 EJECT                                                            05230018
052400 Z999-SQL-ERROR.                                                  05240018
052500*                                                                 05250018
052600***************************************************************** 05260018
052700*     PROCESS DB2 ABENDS                                          05270018
052800***************************************************************** 05280018
052900*                                                                 05290018
053000     DISPLAY '*** DB2 ERROR '.                                    05300018
053100     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                 05310018
053200     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               05320018
053300     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               05330018
053400     DISPLAY '*** TABLE 1   = ' PV-ABEND-STRUCTURE-1.             05340018
053500     IF PV-ABEND-STRUCTURE-2 > SPACES                             05350018
053600         DISPLAY '*** TABLE 2   = ' PV-ABEND-STRUCTURE-2.         05360018
053700     IF PV-ABEND-STRUCTURE-3 > SPACES                             05370018
053800         DISPLAY '*** TABLE 3   = ' PV-ABEND-STRUCTURE-3.         05380018
053900                                                                  05390018
054000     MOVE +4013                    TO ABEND-CODE.                 05400018
054100                                                                  05410018
054200     COPY DPPD004.                                                05420018
054300     CALL 'ILBOABN0' USING ABEND-CODE.                            05430018
054400                                                                  05440018
