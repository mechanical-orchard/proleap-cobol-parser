000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400 PROGRAM-ID.         SVKUT024.                                    00040000
000500 AUTHOR.             BARB ERTL.                                   00050000
000600 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00060000
000700 DATE-WRITTEN.       SEPTEMBER 2001.                              00070000
000800 DATE-COMPILED.                                                   00080000
000900                                                                  00090000
001000******************************************************************00100000
001100* THIS PROGRAM PREPARES THE UPDATE ARCHIVE FILE TO BE PROCESSED  *00110000
001200* BY SVKUP013 UNDER THE DB2 CHECKPOINT RESTART SYSTEM.           *00120000
001300*                                                                *00130000
001400* THE PROGRAM READS THE UPDATE ARCHIVE FILE, REFORMATS THE       *00140000
001500* RECORDS AND SETS A CHECKPOINT INDICATOR ON THE RECORD BASED    *00150000
001600* ON HOW CHECKPOINTS WILL BE TAKEN BY THE MAINTENANCE PROGRAM.   *00160000
001700* AFTER A RECORD HAS BEEN REFORMATTED IT IS PASSED TO THE        *00170000
001800* TRANSACTION PREPARATION MODULE (DPKUT900) WHICH DOES SOME MORE *00180000
001900* PROCESSING ON THE RECORDS AND WRITES THE REFORMATTED RECORDS   *00190000
002000* OUT TO A SEQUENTIAL FILE.                                      *00200000
002100*                                                                *00210000
002200* THE PROGRAM COMMUNICATES WITH THE TRANSACTION PREPARATION      *00220000
002300* MODULE USING FUNCTION CODES (OPEN, WRITE, & CLOSE) AND CHECKS  *00230000
002400* THE RETURN CODE AFTER EACH REQUEST.  IF AN INVALID RETURN CODE *00240000
002500* IS RECEIVED, ANY INFORMATION THAT MAY BE HELPFUL IN RESOLVING  *00250000
002600* THE BAD RETURN CODE IS DISPLAYED ON SYSOUT AND THE PROGRAM     *00260000
002700* ABENDS.                                                        *00270000
002800*                                                                *00280000
002900* INPUT FILES:   UPDATE-ARCHIVE-FILE       DDNAME = INP01        *00290000
003000*                                                                *00300000
003100* OUTPUT FILES:  N/A                                             *00310000
003200*                                                                *00320000
003300******************************************************************00330000
260107* CHG0260107   JIM HUNTER   08-19-21   ADD COPYBOOK DPWS990 TO    00331009
260107*                                      MAKE DPKUT900 CALL DYNAMIC.00332009
003500******************************************************************00350000
003600 ENVIRONMENT DIVISION.                                            00360000
003700******************************************************************00370000
003800                                                                  00380000
003900 CONFIGURATION SECTION.                                           00390000
004000                                                                  00400000
004100 SOURCE-COMPUTER.    IBM-3090.                                    00410000
004200 OBJECT-COMPUTER.    IBM-3090.                                    00420000
004300                                                                  00430000
004400 INPUT-OUTPUT SECTION.                                            00440000
004500                                                                  00450000
004600 FILE-CONTROL.                                                    00460000
004700                                                                  00470000
004800     SELECT UPDATE-ARCHIVE-FILE  ASSIGN TO INP01.                 00480000
004900                                                                  00490000
005000******************************************************************00500000
005100 DATA DIVISION.                                                   00510000
005200******************************************************************00520000
005300                                                                  00530000
005400 FILE SECTION.                                                    00540000
005500                                                                  00550000
005600 FD  UPDATE-ARCHIVE-FILE                                          00560000
005700     RECORDING MODE IS F                                          00570000
005800     BLOCK CONTAINS 0 RECORDS                                     00580000
005900     LABEL RECORDS ARE OMITTED.                                   00590000
006000                                                                  00600000
006100 01  UPDATE-ARCHIVE-RECORD       PIC  X(26).                      00611007
006200                                                                  00620000
006300 WORKING-STORAGE SECTION.                                         00630000
006400                                                                  00640000
006500 01  ABEND-CODE                  PIC S9(04)     VALUE +0  COMP.   00650000
006600                                                                  00660000
006700******************************************************************00670000
006800*PC - PROGRAM CONSTANTS                                           00680000
006900******************************************************************00690000
007000 01  PROGRAM-CONSTANTS.                                           00700000
007100     05  PC-PROGRAM-NAME         PIC X(08)      VALUE 'SVKUT024'. 00710000
007200     05  PC-TRAN-PREP-FUNC-CODES.                                 00720000
007300         10  PC-TRAN-PREP-FUNC-OPEN                               00730000
007400                                 PIC X(05)      VALUE 'OPEN '.    00740000
007500         10  PC-TRAN-PREP-FUNC-WRITE                              00750000
007600                                 PIC X(05)      VALUE 'WRITE'.    00760000
007700         10  PC-TRAN-PREP-FUNC-CLOSE                              00770000
007800                                 PIC X(05)      VALUE 'CLOSE'.    00780000
007900     05  PC-JOB-NAME             PIC X(08)      VALUE 'SVK045  '. 00790000
008000     05  PC-PLAN-NAME            PIC X(08)      VALUE 'SVKUP013'. 00800000
008100     05  PC-TRANS-RECORD-LENGTH  PIC S9(04)     VALUE +26 COMP.   00810008
008200                                                                  00820000
008300******************************************************************00830000
008400*PV - PROGRAM VARIABLES                                           00840000
008500******************************************************************00850000
008600 01  PROGRAM-VARIABLES.                                           00860000
008700     05  PV-CHECKPOINT-TYPE      PIC X(01)      VALUE SPACE.      00870000
008800         88  CONTROL-BREAK                      VALUE 'C'.        00880000
008900         88  LOGICAL-TRANSACTION                VALUE 'L'.        00890000
009000         88  TIME-INTERVAL                      VALUE 'T'.        00900000
009100         88  REQUESTED-BY-PROGRAM               VALUE 'R'.        00910000
009200     05  PV-HOLD-KMC-CRD-NBR     PIC S9(12)V    VALUE ZERO COMP-3.00921003
009300                                                                  00930000
009400******************************************************************00940000
009500*PA - PROGRAM ACCUMULATORS                                        00950000
009600******************************************************************00960000
009700 01  PROGRAM-ACCUMULATORS.                                        00970000
009800     05  PA-ARCHIVE-RECORDS-READ PIC S9(11)     COMP-3            00980000
009900                                                VALUE ZEROES.     00990000
010000     05  PA-ARCHIVE-RECS-WRITTEN PIC S9(11)     COMP-3            01000000
010100                                                VALUE ZEROES.     01010000
010200                                                                  01020000
010300******************************************************************01030000
010400*PS - PROGRAM SWITCHES                                            01040000
010500******************************************************************01050000
010600 01  PROGRAM-SWITCHES.                                            01060000
010700     05  PS-UPD-ARCHIVE-EOF-SW   PIC X(01)      VALUE 'N'.        01070000
010800         88  PS-UPD-ARCHIVE-EOF                 VALUE 'Y'.        01080000
010900     05  PS-FIRST-TRANS-READ-SW  PIC X(01)      VALUE 'Y'.        01090000
011000         88  FIRST-TRANS-READ                   VALUE 'Y'.        01100000
011100                                                                  01110000
011200******************************************************************01120000
011300*  KMC UPDATE ARCHIVE RECORD LAYOUT                              *01130000
011400******************************************************************01140000
011500 01  KMCHTB-RCD.                                                  01150000
011600     05  KMCHTB-CRD-NBR          PIC S9(12)V COMP-3 VALUE 0.      01161003
011700     05  FILLER                  PIC X(19)          VALUE SPACES. 01170007
011800                                                                  01180000
011900******************************************************************01190000
012000*  TRANSACTION PREPARATION MODULE LINKAGE SECTION                *01200000
012100******************************************************************01210000
260107     COPY DPWS990.                                                01220009
012300                                                                  01230000
012200     COPY DPLS000.                                                01231009
012300                                                                  01232009
012400******************************************************************01240000
012500*  SQL COMMUNICATIONS WORK AREA                                  *01250000
012600******************************************************************01260000
012700     COPY SQLCA2.                                                 01270000
012800                                                                  01280000
012900 EJECT                                                            01290000
013000******************************************************************01300000
013100 PROCEDURE DIVISION.                                              01310000
013200******************************************************************01320000
013300* A100-MAINLINE-PROCESSING                                        01330000
013400*    CONTROLS FLOW OF THE PROGRAM                                *01340000
013500******************************************************************01350000
013600 A100-MAINLINE-PROCESSING.                                        01360000
013700                                                                  01370000
013800     PERFORM B100-INITIALIZE.                                     01380000
013900                                                                  01390000
014000     PERFORM B200-PROCESS-UPD-ARCHIVE-FILE                        01400000
014100         UNTIL PS-UPD-ARCHIVE-EOF.                                01410000
014200                                                                  01420000
014300     PERFORM B300-END-OF-JOB-ROUTINE.                             01430000
014400                                                                  01440000
014500     GOBACK.                                                      01450000
014600 EJECT                                                            01460000
014700******************************************************************01470000
014800* B100-INITIALIZE                                                *01480000
014900******************************************************************01490000
015000 B100-INITIALIZE.                                                 01500000
015100                                                                  01510000
015200     PERFORM C100-ISSUE-OPEN-REQUEST.                             01520000
015300                                                                  01530000
015400     OPEN INPUT UPDATE-ARCHIVE-FILE.                              01540000
015500                                                                  01550000
015600     PERFORM C200-READ-UPDATE-ARCHIVE-FILE.                       01560000
015700     IF PS-UPD-ARCHIVE-EOF                                        01570000
015800         DISPLAY ' '                                              01580000
015900         DISPLAY 'MESSAGES FOR PROGRAM ' PC-PROGRAM-NAME          01590000
016000         DISPLAY 'UPDATE ARCHIVE FILE IS EMPTY'                   01600000
016100         DISPLAY ' '                                              01610000
016200     END-IF.                                                      01620000
016300                                                                  01630000
016400******************************************************************01640000
016500* B200-PROCESS-UPD-ARCHIVE-FILE                                  *01650000
016600*     READ AN UPDATE ARCHIVE RECORD.  IF END-OF-FILE, STOP PRO-  *01660000
016700*     CESSING.  IF A RECORD IS READ, GATHER WHATEVER OTHER DATA  *01670000
016800*     IS NECESSARY TO TAKE CHECKPOINTS BASED ON THE TYPE OF      *01680000
016900*     CHECKPOINTS BEING TAKEN BY SVKUP013 AND ISSUE A WRITE      *01690000
017000*     REQUEST TO THE TRANSACTION PREPARATION PROGRAM.            *01700000
017100******************************************************************01710000
017200 B200-PROCESS-UPD-ARCHIVE-FILE.                                   01720000
017300                                                                  01730000
017400     IF FIRST-TRANS-READ                                          01740000
017500         MOVE KMCHTB-CRD-NBR TO PV-HOLD-KMC-CRD-NBR               01750000
017600         MOVE 'N' TO PS-FIRST-TRANS-READ-SW                       01760000
017700     END-IF.                                                      01770000
017800                                                                  01780000
017900     IF CONTROL-BREAK                                             01790000
018000         PERFORM C300-CKPT-BY-CNTL-BREAK                          01800000
018100     ELSE                                                         01810000
018200         IF LOGICAL-TRANSACTION                                   01820000
018300             PERFORM C400-CKPT-BY-LOGICAL-TRANS                   01830000
018400         ELSE                                                     01840000
018500             PERFORM C500-CKPT-BY-TIME-OR-REQUEST                 01850000
018600         END-IF                                                   01860000
018700     END-IF.                                                      01870000
018800                                                                  01880000
018900     PERFORM C200-READ-UPDATE-ARCHIVE-FILE.                       01890000
019000                                                                  01900000
019100 EJECT                                                            01910000
019200******************************************************************01920000
019300* B300-END-OF-JOB-ROUTINE                                        *01930000
019400*                                                                *01940000
019500*                                                                *01950000
019600******************************************************************01960000
019700 B300-END-OF-JOB-ROUTINE.                                         01970000
019800                                                                  01980000
019900     CLOSE UPDATE-ARCHIVE-FILE.                                   01990000
020000                                                                  02000000
020100     DISPLAY ' '.                                                 02010000
020200     DISPLAY 'MESSAGES FOR PROGRAM ' PC-PROGRAM-NAME.             02020000
020300     DISPLAY 'NUMBER OF ARCHIVE RECORDS READ:        '            02030000
020400             PA-ARCHIVE-RECORDS-READ.                             02040000
020500     DISPLAY 'NUMBER OF TRANS/PREP RECORDS WRITTEN:  '            02050000
020600             PA-ARCHIVE-RECS-WRITTEN.                             02060000
020700     DISPLAY ' '.                                                 02070000
020800                                                                  02080000
020900     PERFORM C600-ISSUE-CLOSE-REQUEST.                            02090000
021000                                                                  02100000
021100******************************************************************02110000
021200* C100-ISSUE-OPEN-REQUEST                                        *02120000
021300*     ISSUE AN 'OPEN' REQUEST TO THE TRANSACTION PREPARATION     *02130000
021400*     MODULE.                                                    *02140000
021500******************************************************************02150000
021600 C100-ISSUE-OPEN-REQUEST.                                         02160000
021700                                                                  02170000
021800     MOVE PC-TRAN-PREP-FUNC-OPEN TO DP000-FUNC-CODE.              02180000
021900     MOVE PC-JOB-NAME            TO DP000-JOB-NAME.               02190000
022000     MOVE PC-PLAN-NAME           TO DP000-PLAN-NAME.              02200000
022100                                                                  02210000
022200     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         02220000
022300                                                                  02230000
022400     MOVE DP000-CKPT-TYPE-CODE   TO PV-CHECKPOINT-TYPE.           02240000
022500                                                                  02250000
022600******************************************************************02260000
022700* C200-READ-UPDATE-ARCHIVE-FILE                                  *02270000
022800******************************************************************02280000
022900 C200-READ-UPDATE-ARCHIVE-FILE.                                   02290000
023000                                                                  02300000
023100     READ UPDATE-ARCHIVE-FILE INTO KMCHTB-RCD                     02310000
023200         AT END                                                   02320000
023300             SET PS-UPD-ARCHIVE-EOF TO TRUE.                      02330000
023400                                                                  02340000
023500     IF PS-UPD-ARCHIVE-EOF                                        02350000
023600         CONTINUE                                                 02360000
023700     ELSE                                                         02370000
023800         ADD +1 TO PA-ARCHIVE-RECORDS-READ                        02380000
023900     END-IF.                                                      02390000
024000                                                                  02400000
024100******************************************************************02410000
024200* C300-CKPT-BY-CNTL-BREAK                                        *02420000
024300*     THIS ROUTINE SETS THE CHECKPOINT INDICATOR ON THE TRANSAC- *02430000
024400*     TION RECORD "ON" IF THERE IS A CHANGE IN THE KMC CARD      *02440000
024500*     NUMBER.  AFTER THE TRANSACTION RECORD HAS BEEN FORMATTED,  *02450000
024600*     A WRITE REQUEST IS ISSUED TO THE TRANSACTION PREPARATION   *02460000
024700*     MODULE.                                                    *02470000
024800* NOTE: AT THIS TIME CONTROL/LOGIC BREAK PROCESSING IS IDENTICAL.*02480000
024900******************************************************************02490000
025000 C300-CKPT-BY-CNTL-BREAK.                                         02500000
025100                                                                  02510000
025200     IF KMCHTB-CRD-NBR = PV-HOLD-KMC-CRD-NBR                      02520000
025300         MOVE 'N' TO DP000-CHECKPOINT-IND                         02530000
025400     ELSE                                                         02540000
025500         MOVE 'Y' TO DP000-CHECKPOINT-IND                         02550000
025600         MOVE KMCHTB-CRD-NBR TO PV-HOLD-KMC-CRD-NBR               02560000
025700     END-IF.                                                      02570000
025800                                                                  02580000
025900     MOVE PC-TRANS-RECORD-LENGTH  TO DP000-TRANS-REC-LENGTH.      02590000
026000     MOVE KMCHTB-RCD                                              02600000
026100                                  TO DP000-TRANS-REC.             02610000
026200     MOVE PC-TRAN-PREP-FUNC-WRITE TO DP000-FUNC-CODE.             02620000
026300     MOVE PC-JOB-NAME             TO DP000-JOB-NAME.              02630000
026400     MOVE PC-PLAN-NAME            TO DP000-PLAN-NAME.             02640000
026500                                                                  02650000
026600     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         02660000
026700     ADD +1 TO PA-ARCHIVE-RECS-WRITTEN.                           02670000
026800                                                                  02680000
026900******************************************************************02690000
027000* C400-CKPT-BY-LOGICAL-TRANS.                                    *02700000
027100*     THIS ROUTINE SETS THE CHECKPOINT INDICATOR ON THE TRANSAC- *02710000
027200*     TION RECORD "ON".  THE UPDATE PROGRAM WILL CHECK THE       *02720001
027300*     CHECKPOINT FREQUENCY TO KNOW WHETHER A CHECKPOINT SHOULD BE*02730001
027310*     TAKEN.   AFTER THE TRANSACTION RECORD HAS BEEN FORMATTED,  *02731001
027400*     A WRITE REQUEST IS ISSUED TO THE TRANSACTION PREPARATION   *02740000
027500*     MODULE.                                                    *02750000
027700******************************************************************02770000
027800 C400-CKPT-BY-LOGICAL-TRANS.                                      02780000
027900                                                                  02790000
028300     MOVE 'Y'                     TO DP000-CHECKPOINT-IND.        02830001
028600                                                                  02860000
028700     MOVE PC-TRANS-RECORD-LENGTH  TO DP000-TRANS-REC-LENGTH.      02870000
028900     MOVE KMCHTB-RCD              TO DP000-TRANS-REC.             02890001
029000     MOVE PC-TRAN-PREP-FUNC-WRITE TO DP000-FUNC-CODE.             02900000
029100     MOVE PC-JOB-NAME             TO DP000-JOB-NAME.              02910000
029200     MOVE PC-PLAN-NAME            TO DP000-PLAN-NAME.             02920000
029300                                                                  02930000
029400     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         02940000
029500     ADD +1 TO PA-ARCHIVE-RECS-WRITTEN.                           02950000
029600                                                                  02960000
029700******************************************************************02970000
029800* C500-CKPT-BY-TIME-OR-REQUEST.                                  *02980000
029900*     THIS ROUTINE BUILDS THE TRANSACTION RECORD AND ISSUES A    *02990000
030000*     WRITE REQUEST TO THE TRANSACTION PREPARATION MODULE IF     *03000000
030100*     CHECKPOINTS ARE TAKEN BY TIME INTERVAL (SECONDS) OR        *03010000
030200*     REQUESTED BY THE MAINTENANCE PROGRAM.                      *03020000
030300******************************************************************03030000
030400 C500-CKPT-BY-TIME-OR-REQUEST.                                    03040000
030500                                                                  03050000
030600     MOVE 'N'                     TO DP000-CHECKPOINT-IND.        03060002
030700     MOVE PC-TRANS-RECORD-LENGTH  TO DP000-TRANS-REC-LENGTH.      03070000
030800     MOVE KMCHTB-RCD                                              03080000
030900                                  TO DP000-TRANS-REC.             03090000
031000     MOVE PC-TRAN-PREP-FUNC-WRITE TO DP000-FUNC-CODE.             03100000
031100     MOVE PC-JOB-NAME             TO DP000-JOB-NAME.              03110000
031200     MOVE PC-PLAN-NAME            TO DP000-PLAN-NAME.             03120000
031300                                                                  03130000
031400     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         03140000
031500     ADD +1 TO PA-ARCHIVE-RECS-WRITTEN.                           03150000
031600                                                                  03160000
031700******************************************************************03170000
031800* C600-ISSUE-CLOSE-REQUEST                                       *03180000
031900*     ISSUE A 'CLOSE' REQUEST TO THE TRANSACTION PREPARATION     *03190000
032000*     MODULE.                                                    *03200000
032100******************************************************************03210000
032200 C600-ISSUE-CLOSE-REQUEST.                                        03220000
032300                                                                  03230000
032400     MOVE PC-TRAN-PREP-FUNC-CLOSE TO DP000-FUNC-CODE.             03240000
032500     MOVE PC-JOB-NAME             TO DP000-JOB-NAME.              03250000
032600     MOVE PC-PLAN-NAME            TO DP000-PLAN-NAME.             03260000
032700                                                                  03270000
032800     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         03280000
032900                                                                  03290000
033000******************************************************************03300000
033100*  TRANSACTION PREPARATION MODULE CALL AND ERROR ROUTINES        *03310000
033200******************************************************************03320000
033300     COPY DPPD000.                                                03330000
033400                                                                  03340000
