000110******************************************************************00011001
000120 IDENTIFICATION DIVISION.                                         00012001
000130******************************************************************00013001
000140                                                                  00014001
000150 PROGRAM-ID.    SUKUT126.                                         00015099
000160 AUTHOR.        PAUL JORGENSEN.                                   00016068
000170 INSTALLATION.  KOHLS.                                            00017001
000180 DATE-WRITTEN   FEBRUARY, 2009.                                   00018099
000190 DATE-COMPILED.                                                   00019001
000191                                                                  00019101
000192******************************************************************00019201
000193*  THIS PROGRAM WILL PURGE OUTBOUND TRIP STATUS DATA FROM THE     00019399
000194*  TSUOBTS TABLE.                                                 00019499
000196******************************************************************00019602
000197******************************************************************00019702
000198 ENVIRONMENT DIVISION.                                            00019802
000199******************************************************************00019902
000200 CONFIGURATION SECTION.                                           00020015
000201                                                                  00020115
000203 SOURCE-COMPUTER.        IBM-3090.                                00020315
000204 OBJECT-COMPUTER.        IBM-3090.                                00020415
000205                                                                  00020515
000206 INPUT-OUTPUT SECTION.                                            00020615
000207                                                                  00020715
000208 FILE-CONTROL.                                                    00020815
000209*                                                                 00020915
000210     SELECT PURGE-FILE                                            00021099
000211         ASSIGN TO INP01.                                         00021115
000215                                                                  00021515
000216*                                                                 00021615
000218******************************************************************00021802
000219 DATA DIVISION.                                                   00021902
000220******************************************************************00022002
000221*                                                                 00022102
000222 FILE SECTION.                                                    00022215
000223*                                                                 00022315
000231 FD  PURGE-FILE                                                   00023199
000232     RECORDING MODE IS F                                          00023215
000233     RECORD CONTAINS 20 CHARACTERS                                00023399
000234     LABEL RECORDS ARE OMITTED                                    00023415
000235     DATA RECORD IS PURGE-RECORD.                                 00023599
000236 01  PURGE-RECORD                   PIC X(20).                    00023699
000237*                                                                 00023715
000238******************************************************************00023899
000239 WORKING-STORAGE SECTION.                                         00023999
000240******************************************************************00024099
000241*                                                                 00024199
000242******************************************************************00024299
000243*  DB2 FORMATTED MESSAGE AREA                                     00024399
000244******************************************************************00024499
000245     COPY DPWS004.                                                00024599
000246                                                                  00024699
000247*----------------------------------------------------------------*00024799
000248*  DCLGEN LAYOUT FOR THE OUTBOUND TRIP STATUS TABLE              *00024899
000249*----------------------------------------------------------------*00024999
000250     EXEC SQL                                                     00025099
000251         INCLUDE TSUOBTS                                          00025199
000252     END-EXEC.                                                    00025299
000260******************************************************************00026002
000261*    COMMUNICATIONS AREA FOR DB2                                  00026102
000262******************************************************************00026202
000263                                                                  00026302
000264     EXEC SQL                                                     00026402
000265          INCLUDE SQLCA                                           00026502
000266     END-EXEC.                                                    00026602
000267                                                                  00026702
000268******************************************************************00026802
000269*                                                                 00026902
000270 01  ABEND-CODE                      PIC S9(04)    VALUE +0.      00027099
000271                                                                  00027102
000272 01  PS-PROGRAM-SWITCHES.                                         00027202
000273     05  PS-COMMIT-SW                PIC X(03)     VALUE 'N'.     00027399
000274         88  PS-COMMIT-YES                         VALUE 'Y'.     00027499
000275         88  PS-COMMIT-NO                          VALUE 'N'.     00027599
000276     05  PS-FIRST-TIME-SW            PIC X(01)     VALUE 'N'.     00027699
000277         88  PS-FIRST-TIME-YES                     VALUE 'Y'.     00027799
000278         88  PS-FIRST-TIME-NO                      VALUE 'N'.     00027899
000279     05  PS-EOF-PROCESS-SW           PIC  X(01)    VALUE 'N'.     00027999
000280         88  PS-EOF-PROCESS-YES                    VALUE 'Y'.     00028099
000281         88  PS-EOF-PROCESS-NO                     VALUE 'N'.     00028199
000282                                                                  00028220
000283                                                                  00028320
000284 01  PC-PROGRAM-CONSTANTS.                                        00028420
000285     05  PC-ROW-NOT-FOUND            PIC S9(04)    VALUE +100     00028520
000286                                                   COMP SYNC.     00028620
000287     05  PC-PROGRAM-NAME             PIC  X(08)    VALUE          00028723
000288         'SUKUT126'.                                              00028899
000290     05  PC-MAX-RETRIES              PIC S9(04)    VALUE +3       00029020
000291                                                   COMP SYNC.     00029120
000293                                                                  00029320
000294 01  PV-PROGRAM-VARIABLES.                                        00029420
000295     05  PV-DELETE-TMST              PIC  X(26)    VALUE SPACES.  00029599
000296     05  PV-SQL-RETURN-CD            PIC 999-.                    00029620
000297     05  PV-CICS-MSG-AREA            PIC  X(80)    VALUE SPACES.  00029720
000298     05  PV-COMMAREA-LENGTH          PIC S9(04)    VALUE +0       00029820
000299                                                   COMP SYNC.     00029920
000300     05  PV-CICS-RESPONSE            PIC S9(9)     VALUE ZERO     00030020
000301                                                   COMP SYNC.     00030120
000302                                                                  00030220
000303     05  PV-OTBND-TRIP-ID-MSG.                                    00030399
000304         10  FILLER                  PIC  X(13)    VALUE          00030499
000305         'OTBND TRIP = '.                                         00030599
000306         10  PV-OTBND-TRIP-ID        PIC  9(15).                  00030699
000315     05  PV-DONE-PROCESSING-SW       PIC  X(01)    VALUE 'N'.     00031520
000316         88  PV-DONE-PROCESSING                    VALUE 'Y'.     00031620
000317     05  PV-ABEND-PARAGRAPH          PIC  X(30)    VALUE SPACE.   00031720
000318     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.  00031820
000319     05  PV-DB2-OPERATION-ATTEMPTED  PIC  X(30)    VALUE SPACES.  00031920
000320                                                                  00032020
000321     05  PV-ABEND-CODE               PIC S9(04)    VALUE ZERO     00032120
000322                                                   COMP SYNC.     00032220
000323     05  PV-ABEND-PARA-NAME          PIC X(30)     VALUE SPACES.  00032320
000324     05  PV-DB2-OPERATION-MSG-1      PIC X(40)     VALUE SPACES.  00032420
000325     05  PV-DB2-OPERATION-MSG-2      PIC X(40)     VALUE SPACES.  00032520
000326     05  PV-DB2-OPERATION-MSG-3      PIC X(40)     VALUE SPACES.  00032699
000327     05  PV-DB2-TABLE-NAME           PIC X(17)     VALUE SPACES.  00032799
000328     05  PV-SQLCODE                  PIC Z(8)9-.                  00032899
000329     05  PV-RETRY-COUNTER            PIC S9(04)    VALUE ZERO     00032999
000330                                                   COMP SYNC.     00033099
000340                                                                  00034020
000345     05  PV-DISPLAY-COUNT            PIC ZZZ,ZZZ,ZZ9.             00034547
000346                                                                  00034647
000349     05  PV-RECORDS-READ             PIC S9(07)    COMP-3         00034991
000350                                                   VALUE ZEROS.   00035047
000353     05  PV-ROWS-DELETED             PIC S9(07)    COMP-3         00035399
000354                                                   VALUE ZEROS.   00035499
000362 01  SD-SYSTEM-DATE.                                              00036247
000363     05  SD-SYSTEM-DATE-YY           PIC  9(02)      VALUE ZERO.  00036347
000364     05  SD-SYSTEM-DATE-MM           PIC  9(02)      VALUE ZERO.  00036447
000365     05  SD-SYSTEM-DATE-DD           PIC  9(02)      VALUE ZERO.  00036547
000366                                                                  00036647
000367 01  ST-SYSTEM-TIME.                                              00036747
000368     05  ST-SYSTEM-HOUR             PIC  9(02)      VALUE ZERO.   00036847
000369     05  ST-SYSTEM-MINUTE           PIC  9(02)      VALUE ZERO.   00036947
000370     05  FILLER                     PIC  9(04)      VALUE ZERO.   00037047
000371                                                                  00037147
000372******************************************************************00037247
000373*    ABEND PROCESSING COPYBOOK.                                   00037347
000374******************************************************************00037447
000375                                                                  00037547
000376     COPY DPWS013.                                                00037647
000377                                                                  00037747
000379******************************************************************00037947
000380*    INPUT RECORD LAYOUT.                                         00038099
000381******************************************************************00038147
000383     COPY SURD054.                                                00038399
000384                                                                  00038447
000477******************************************************************00047727
000478 PROCEDURE DIVISION.                                              00047827
000479******************************************************************00047927
000480*                                                                 00048027
000481******************************************************************00048127
000482* 0000-PROGRAM-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE     00048227
000483*      PROGRAM.                                                   00048327
000484******************************************************************00048427
000485 0000-PROGRAM-MAINLINE.                                           00048527
000486*                                                                 00048627
000487     DISPLAY '*** START OF SUKUT126 - TSUOBTS PURGE ***'          00048799
000488     DISPLAY ' '.                                                 00048827
000489                                                                  00048927
000490      PERFORM 1000-INITIALIZE                                     00049027
000491      PERFORM 2000-MAIN-PROCESS                                   00049127
000492              UNTIL PS-EOF-PROCESS-YES                            00049299
000493      PERFORM 9000-END-PROCESS.                                   00049327
000494*                                                                 00049427
000495     STOP RUN.                                                    00049527
000496*                                                                 00049627
000497******************************************************************00049727
000498*  DO FIRST TIME PROGRAM INITIALIZATION TASKS.                    00049827
000499*    -- OPEN FILES                                                00049927
000500******************************************************************00050027
000501 1000-INITIALIZE.                                                 00050127
000502                                                                  00050227
000504     OPEN INPUT  PURGE-FILE.                                      00050499
000509                                                                  00050999
000510*READ FIRST INPUT RECORD.                                         00051099
000511     PERFORM 7000-READ-PURGE-FILE.                                00051199
000513*                                                                 00051399
000514 2000-MAIN-PROCESS.                                               00051499
000629     PERFORM 5000-DELETE-OTBND-TRIP-STATUS                        00062999
000640                                                                  00064099
000650     PERFORM 7000-READ-PURGE-FILE.                                00065099
000658                                                                  00065899
000844 5000-DELETE-OTBND-TRIP-STATUS.                                   00084499
000845                                                                  00084599
000846     EXEC SQL                                                     00084699
000847     DELETE                                                       00084799
000851       FROM TSUOBTS                                               00085199
000852      WHERE OTBND_TRIP_ID =  :SU054-OTBND-TRIP-ID                 00085299
000854     END-EXEC                                                     00085499
000856                                                                  00085699
000857     EVALUATE TRUE                                                00085799
000858     WHEN SQLCODE = +0                                            00085899
000859         ADD SQLERRD(3)           TO PV-ROWS-DELETED              00085999
000860         PERFORM 5100-COMMIT                                      00086099
000861     WHEN SQLCODE = +100                                          00086199
000862         CONTINUE                                                 00086299
000863     WHEN OTHER                                                   00086399
000864         MOVE '5000-DELETE-OTBND-TRIP-STATUS'                     00086499
000865                                  TO PV-ABEND-PARA-NAME           00086599
000866         MOVE SU054-OTBND-TRIP-ID TO PV-OTBND-TRIP-ID             00086699
000867         MOVE PV-OTBND-TRIP-ID-MSG                                00086799
000868                                  TO PV-DB2-OPERATION-MSG-1       00086899
000870         MOVE 'TSUOBTS'           TO PV-DB2-TABLE-NAME            00087099
000871         PERFORM 9998-SQL-ABEND                                   00087199
000872     END-EVALUATE.                                                00087299
000873                                                                  00087399
000874 5100-COMMIT.                                                     00087499
000875                                                                  00087599
000876     EXEC SQL                                                     00087699
000877          COMMIT                                                  00087799
000878     END-EXEC                                                     00087899
000879                                                                  00087999
000880     IF SQLCODE = ZERO                                            00088099
000881         CONTINUE                                                 00088199
000882     ELSE                                                         00088299
000883         MOVE '5100-COMMIT'       TO PV-ABEND-PARA-NAME           00088399
000887         MOVE SU054-OTBND-TRIP-ID TO PV-OTBND-TRIP-ID             00088799
000888         MOVE PV-OTBND-TRIP-ID-MSG                                00088899
000889                                  TO PV-DB2-OPERATION-MSG-1       00088999
000891         MOVE 'TSUOBTS'           TO PV-DB2-TABLE-NAME            00089199
000893         PERFORM 9998-SQL-ABEND                                   00089399
000894     END-IF.                                                      00089499
000895*                                                                 00089599
000896 7000-READ-PURGE-FILE.                                            00089699
000897******************************************************************00089799
000898     READ PURGE-FILE INTO SU054-EXTRACT-RECORD                    00089899
000899        AT END                                                    00089999
000900           SET PS-EOF-PROCESS-YES TO TRUE                         00090099
000901        NOT AT END                                                00090199
000902            ADD  +1               TO PV-RECORDS-READ              00090299
000903     END-READ.                                                    00090399
000904*                                                                 00090499
000905                                                                  00090599
000906******************************************************************00090699
000907*     CLOSE FILES.                                              **00090799
000908******************************************************************00090899
000909 9000-END-PROCESS.                                                00090999
000910*                                                                 00091099
000911     CLOSE PURGE-FILE.                                            00091199
000912*                                                                 00091299
000913     PERFORM 9999-FINAL-DISPLAYS.                                 00091399
000916*                                                                 00091699
000917******************************************************************00091799
000918*     SQL ERROR PROCESSING                                      **00091899
000919******************************************************************00091999
000920 9998-SQL-ABEND.                                                  00092099
000921     PERFORM 9999-FINAL-DISPLAYS.                                 00092199
000922     MOVE SQLCODE     TO PV-SQLCODE.                              00092299
000923     DISPLAY '** ABEND           ** = SQLABEND'.                  00092399
000924     DISPLAY '** PROGRAM         ** = ' PC-PROGRAM-NAME.          00092499
000925     DISPLAY '** PARAGRAPH       ** = ' PV-ABEND-PARA-NAME        00092599
000926     DISPLAY '** TABLE AFFECTED  ** = ' PV-DB2-TABLE-NAME.        00092699
000927     DISPLAY '** OPERATIONAL MSG ** = ' PV-DB2-OPERATION-MSG-1.   00092799
000928     DISPLAY '** OPERATIONAL MSG ** = ' PV-DB2-OPERATION-MSG-2.   00092899
000930     DISPLAY '** SQLCODE         ** = ' PV-SQLCODE.               00093099
000931     COPY DPPD004.                                                00093199
000932                                                                  00093299
000933     MOVE +4013                  TO PV-ABEND-CODE.                00093399
000934     CALL 'ILBOABN0'   USING PV-ABEND-CODE.                       00093499
000940*                                                                 00094015
000950 9999-FINAL-DISPLAYS.                                             00095099
000970     DISPLAY '**********************************'.                00097099
000980     DISPLAY '** SUKUT126 SUMMARY **'.                            00098099
000990     MOVE PV-RECORDS-READ       TO PV-DISPLAY-COUNT               00099099
000991     DISPLAY 'TOTAL INPUT RECORDS         = ' PV-DISPLAY-COUNT.   00099199
000994     MOVE PV-ROWS-DELETED       TO PV-DISPLAY-COUNT               00099499
000995     DISPLAY 'TOTAL TSUOBTS ROWS DELETED  = ' PV-DISPLAY-COUNT.   00099599
000996     DISPLAY '**********************************'.                00099699
001000                                                                  00100013
