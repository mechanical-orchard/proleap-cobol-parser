000100***************************************************************** 00010005
000200 IDENTIFICATION DIVISION.                                         00020005
000300***************************************************************** 00030005
000400                                                                  00040005
000500 PROGRAM-ID.             SAKRP016.                                00050005
000600 AUTHOR.                 MATTHEW STIFF.                           00060005
000700 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00070005
000800 DATE-WRITTEN            MAY 1999.                                00080005
000900 DATE-COMPILED.                                                   00090005
001000                                                                  00100005
001100***************************************************************** 00110005
001200* * * *>>>   THIS PROGRAM MUST BE COMPILED COBOL/390   <<<* * * * 00120005
001300***************************************************************** 00130005
001400*                                                                 00140005
001500*  THIS PROGRAM WILL CREATE A DAILY MASTERCARD / VISA CORRECTIONS 00150005
001600*  AUDIT REPORT.                                                  00160005
001700*                                                                 00170005
001800*   INPUT: INP01 - CONTAINS POS DATE, WHICH IS USED AS THE        00180005
001900*                  PROCESS DATE TO CREATE THE REPORT.             00190005
002000*  OUTPUT: RPT01 - REPORT SHOWING MASTERCARD / VISA CORRECTIONS   00200005
002100*                  BY SALES DATE.                                 00210005
002200*                                                                 00220005
002300***************************************************************** 00230005
002400*                                                                 00240005
002500*  THIS PROGRAM USES THE TEPDKEY TABLE TO JOIN THE TEPTRN,        00250005
002600*  TEPTND, AND TEPCRD TABLES.  THE TEPDKEY TABLE CONTAINS ALL     00260005
002700*  KEY INFORMATION FOR TRANSACTIONS THAT HAVE BEEN PROCESSED FOR  00270005
002800*  A PROCESSING DAY THAT DO NOT HAVE SALES DATES FOR THAT         00280005
002900*  PROCESSING DAY.  THE MOST COMMON EXAMPLE OF THIS IS A SALES    00290005
003000*  CORRECTION.                                                    00300005
003100*                                                                 00310005
003200*  THE REPORT USES DATA FROM THE TEPTND, TEPCRD, AND TEPTRN       00320005
003300*  TABLES.  A DETAIL LINE IS WRITTEN FOR EACH ROW FETCHED.        00330005
003400*  THE REPORT BREAKS ON STORE NUMBER AND ALSO SALES DATE.         00340005
003500*  WHEN A NEW STORE IS ENCOUNTERED, THE STORE TABLE IS READ TO    00350005
003600*  GET THE BANKCARD MERCHANT NUMBER FOR THAT STORE.  WHEN A NEW   00360005
003700*  SALES DATE IS ENCOUNTERED, THE DATE IS PASSED TO THE CALENDAR  00370005
003800*  TO BE CHANGED INTO GREGORIAN FORMAT.                           00380005
003900*                                                                 00390005
004000*  WHEN THE FETCH IS COMPLETE, A TOTAL LINE IS PRINTED AT THE     00400005
004100*  END OF THE REPORT.                                             00410005
004200*                                                                 00420005
004300***************************************************************** 00430005
004400* CHANGED: 09/22/04                                               00440005
004500* PROJECT: XS DOMAIN CONSTRAINTS    WR/IR#: WR27107               00450005
004600* PROGRAMMER:  THOMAS HANSON                                      00460005
004700* DESCRIPTION: REPLACED TSTR000 WITH XST_LOC_ATTR TABLE.          00470005
004800*              PER USER REQUEST, REMOVED MERCH_NBR FROM RPT.      00480005
004300***************************************************************** 00481007
004400* CHANGED: 01/12/05     WR/IR#: WR28146     PAUL OMAN             00482008
004500* PROJECT: MASK CREDIT CARD NUMBERS.                              00483007
004700* DESCRIPTION: ONLY SHOW LAST 4 POSITIONS OF CREDIT CARD NUMBERS. 00485007
004900***************************************************************** 00490005
005000 ENVIRONMENT DIVISION.                                            00500005
005100***************************************************************** 00510005
005200                                                                  00520005
005300 CONFIGURATION SECTION.                                           00530005
005400                                                                  00540005
005500 SOURCE-COMPUTER.        IBM-3090.                                00550005
005600                                                                  00560005
005700 OBJECT-COMPUTER.        IBM-3090.                                00570005
005800                                                                  00580005
005900 INPUT-OUTPUT SECTION.                                            00590005
006000                                                                  00600005
006100 FILE-CONTROL.                                                    00610005
006200                                                                  00620005
006300     SELECT POS-DATE-CARD-FILE                                    00630005
006400         ASSIGN TO INP01.                                         00640005
006500                                                                  00650005
006600     SELECT BANKCARD-REPORT-FILE                                  00660005
006700         ASSIGN TO RPT01.                                         00670005
006800                                                                  00680005
006900 EJECT                                                            00690005
007000******************************************************************00700005
007100 DATA DIVISION.                                                   00710005
007200******************************************************************00720005
007300                                                                  00730005
007400 FILE SECTION.                                                    00740005
007500                                                                  00750005
007600 FD  POS-DATE-CARD-FILE                                           00760005
007700     RECORDING MODE IS F                                          00770005
007800     BLOCK CONTAINS 0 RECORDS                                     00780005
007900     LABEL RECORDS ARE STANDARD.                                  00790005
008000                                                                  00800005
008100 01  POS-DATE-CARD-RECORD            PIC X(80).                   00810005
008200                                                                  00820005
008300 FD  BANKCARD-REPORT-FILE                                         00830005
008400     RECORDING MODE IS F                                          00840005
008500     BLOCK CONTAINS 0  RECORDS.                                   00850005
008600                                                                  00860005
008700 01  BANKCARD-REPORT-RECORD          PIC  X(132).                 00870005
008800                                                                  00880005
008900 EJECT                                                            00890005
009000******************************************************************00900005
009100 WORKING-STORAGE SECTION.                                         00910005
009200******************************************************************00920005
009300 01  FILLER                            PIC X(50)  VALUE           00930005
009400     ' *** WORKING STORAGE STARTS HERE FOR SAKRP016 *** '.        00940005
009500                                                                  00950005
009600******************************************************************00960005
009700* RECORD LAYOUT FOR INPUT DATE CARD (POS DATE)                    00970005
009800******************************************************************00980005
009900 01  CC-CONTROL-CARD.                                             00990005
010000     05  CC-CONTROL-CARD-DISPLAY.                                 01000005
010100         10  CC-CONTROL-NAME     PIC X(14)    VALUE SPACE.        01010005
010200             88  CC-VALID-CONTROL-NAME        VALUE               01020005
010300                 'P.O.S. DATE = '.                                01030005
010400         10  CC-POS-DATE-MMDDYY  PIC 9(6)     VALUE ZERO.         01040005
010500     05  FILLER                  PIC X(60)    VALUE SPACE.        01050005
010600                                                                  01060005
010700******************************************************************01070005
010800*  PARAMETER LIST FOR THE CALENDAR ROUTINE (DPKUT500)             01080005
010900******************************************************************01090005
011000     COPY DPWS500.                                                01100005
011100                                                                  01110005
011200 01  AC-ABEND-CODE                     PIC S9(04) VALUE ZERO      01120005
011300                                                  COMP SYNC.      01130005
011400     88  AC-CONTROL-CARD-ERROR                    VALUE +4003.    01140005
011500     88  AC-DB2-ERROR                             VALUE +4013.    01150005
011600     88  AC-CALENDAR-ROUTINE-ERROR                VALUE +4019.    01160005
011700                                                                  01170005
011800                                                                  01180005
011900 EJECT                                                            01190005
012000 01  PS-PROGRAM-SWITCHES.                                         01200005
012100     05  PS-END-OF-CURSOR-SW           PIC X(01)  VALUE 'N'.      01210005
012200         88  PS-END-OF-CURSOR                     VALUE 'Y'.      01220005
012300     05  PS-END-OF-CARD-FILE-SW        PIC X(01)  VALUE 'N'.      01230005
012400         88  PS-END-OF-CARD-FILE                  VALUE 'Y'.      01240005
012500                                                                  01250005
012600 01  PC-CONSTANTS.                                                01260005
012700     05  PC-LINE-LIMIT               PIC S9(04)    VALUE +60.     01270005
012800     05  PC-ROW-NOT-FOUND            PIC S9(04)    VALUE +100     01280005
012900                                                   COMP SYNC.     01290005
013000     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          01300005
013100                                                   'SAKRP016'.    01310005
013200     05  PC-REPORT-NBR-1             PIC  9(01)    VALUE 1.       01320005
013300     05  PC-VISA-TENDER-TYPE         PIC  X(02)    VALUE '05'.    01330005
013400     05  PC-MASTERCARD-TENDER-TYPE   PIC  X(02)    VALUE '06'.    01340005
013500     05  PC-NEGATIVE-ONE             PIC S9(02)    VALUE -1       01350005
013600                                                   COMP.          01360005
013700     05  PC-SYSTEM-CORRECTION        PIC  X(01)    VALUE 'S'.     01370005
013800     05  PC-REVERSAL-CORRECTION      PIC  X(01)    VALUE 'R'.     01380005
013900     05  PC-SHORT-CARD-LENGTH        PIC S9(02)V   COMP-3         01390005
014000                                                   VALUE +13.     01400005
014100                                                                  01410005
014200 EJECT                                                            01420005
014300 01  PV-MISC-COUNT-FIELDS            COMP-3.                      01430005
014400     05  PV-PAGE-CNT                 PIC S9(05)    VALUE ZERO.    01440005
014500     05  PV-LINE-CNT                 PIC S9(03)    VALUE ZERO.    01450005
014600     05  PV-LINE-CNT-AHEAD           PIC S9(03)    VALUE ZERO.    01460005
014700     05  PV-CURSOR-CNT               PIC S9(07)    VALUE ZERO.    01470005
014800                                                                  01480005
014900******************************************************************01490005
015000*  ACCUMULATORS TO HOLD STORE AND COMPANY DOLLAR AMOUNTS.         01500005
015100******************************************************************01510005
015200 01  PA-PROGRAM-ACCUMULATORS.                                     01520005
015300     05  PA-STORE-SALES-AMOUNT       PIC S9(07)V99  VALUE ZERO    01530005
015400                                         COMP-3.                  01540005
015500     05  PA-STORE-RETURN-AMOUNT      PIC S9(07)V99  VALUE ZERO    01550005
015600                                         COMP-3.                  01560005
015700     05  PA-COMPANY-SALES-AMOUNT     PIC S9(07)V99  VALUE ZERO    01570005
015800                                         COMP-3.                  01580005
015900     05  PA-COMPANY-RETURN-AMOUNT    PIC S9(07)V99  VALUE ZERO    01590005
016000                                         COMP-3.                  01600005
016100                                                                  01610005
016200 01  PV-MISC-FIELDS.                                              01620005
016300     05  PV-PRINT-RECORD             PIC X(132)    VALUE SPACE.   01630005
016400     05  PV-LINE-SPACING             PIC S9(04)    VALUE ZERO     01640005
016500                                                   COMP SYNC.     01650005
016600     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACE.   01660005
016700     05  PV-OPERATION-MSG-1          PIC  X(40)    VALUE SPACE.   01670005
016800     05  PV-OPERATION-MSG-2          PIC  X(40)    VALUE SPACE.   01680005
016900     05  PV-DB2-OPERATION            PIC  X(30)    VALUE SPACE.   01690005
017000     05  PV-EDIT-MASK                PIC  Z,ZZZ,ZZ9.              01700005
017100     05  PV-HOLD-STORE               PIC  S9(04)  COMP VALUE ZERO.01710005
017200     05  PV-HOLD-SALES-DATE          PIC   X(10)  VALUE SPACE.    01720005
017300     05  PV-AMOUNT                   PIC  S9(07)V99 COMP-3        01730005
017400                                          VALUE ZERO.             01740005
017500     05  PV-AMOUNT-FORMATTED         PIC   ZZ,ZZ9.99-.            01750005
017600*    05  PV-MERCH-NMBR               PIC   9(18)  VALUE ZERO.     01760005
017700     05  PV-CARD-NBR-16.                                          01770005
017800         10  PV-CARD-NBR-16-FIRST-4  PIC   X(04)  VALUE SPACE.    01780005
017900         10  FILLER                  PIC   X(01)  VALUE '-'.      01790005
018000         10  PV-CARD-NBR-16-SECOND-4 PIC   X(04)  VALUE SPACE.    01800005
018100         10  FILLER                  PIC   X(01)  VALUE '-'.      01810005
018200         10  PV-CARD-NBR-16-THIRD-4  PIC   X(04)  VALUE SPACE.    01820005
018300         10  FILLER                  PIC   X(01)  VALUE '-'.      01830005
018400         10  PV-CARD-NBR-16-LAST-4   PIC   X(04)  VALUE SPACE.    01840005
018500     05  PV-CARD-NBR-13.                                          01850005
018600         10  PV-CARD-NBR-13-FIRST-4  PIC   X(04)  VALUE SPACE.    01860005
018700         10  FILLER                  PIC   X(01)  VALUE '-'.      01870005
018800         10  PV-CARD-NBR-13-SECOND-3 PIC   X(03)  VALUE SPACE.    01880005
018900         10  FILLER                  PIC   X(01)  VALUE '-'.      01890005
019000         10  PV-CARD-NBR-13-THIRD-3  PIC   X(03)  VALUE SPACE.    01900005
019100         10  FILLER                  PIC   X(01)  VALUE '-'.      01910005
019200         10  PV-CARD-NBR-13-LAST-3   PIC   X(03)  VALUE SPACE.    01920005
019300         10  FILLER                  PIC   X(03)  VALUE SPACE.    01930005
019400                                                                  01940005
019500 01  PV-DATE-AND-TIME-FIELDS.                                     01950005
019600     05  PV-POS-CCYY-MM-DD           PIC X(10)     VALUE SPACE.   01960005
019700     05  FILLER REDEFINES PV-POS-CCYY-MM-DD.                      01970005
019800         10  PV-POS-CCYY             PIC X(04).                   01980005
019900         10  FILLER                  PIC X(01).                   01990005
020000         10  PV-POS-MM               PIC X(02).                   02000005
020100         10  FILLER                  PIC X(01).                   02010005
020200         10  PV-POS-DD               PIC X(02).                   02020005
020300     05  PV-CURR-DATE-CCYYMMDD.                                   02030005
020400         10  PV-CURR-DATE-CCYY       PIC  9(04).                  02040005
020500         10  PV-CURR-DATE-MM         PIC  9(02).                  02050005
020600         10  PV-CURR-DATE-DD         PIC  9(02).                  02060005
020700     05  PV-CURR-TIME.                                            02070005
020800         10  PV-CURR-TIME-HH         PIC  9(02)    VALUE ZERO.    02080005
020900         10  PV-CURR-TIME-MM         PIC  9(02)    VALUE ZERO.    02090005
021000         10  PV-CURR-TIME-SSHH       PIC  9(04)    VALUE ZERO.    02100005
021100     05  PV-POS-DATE-FORMATTED       PIC  X(10)    VALUE SPACE.   02110005
021200     05  PV-SLS-DATE-FORMATTED       PIC  X(10)    VALUE SPACE.   02120005
021300 EJECT                                                            02130005
021400******************************************************************02140005
021500*  TOP OF PAGE HEADING LINE FOR PRINTING A 132 CHARACTER REPORT.  02150005
021600******************************************************************02160005
021700     COPY DPWS132.                                                02170005
021800                                                                  02180005
021900******************************************************************02190005
022000*  HEADING LINES FOR THE BANKCARD CORRECTIONS REPORT.             02200005
022100******************************************************************02210005
022200 01  HL2-HEADING-LINE-2.                                          02220005
022300     05  FILLER                      PIC  X(33)    VALUE SPACE.   02230005
022400     05  FILLER                      PIC  X(18)    VALUE          02240005
022500                                          'MASTERCARD / VISA '.   02250005
022600     05  FILLER                      PIC  X(12)    VALUE          02260005
022700                                          'CORRECTIONS '.         02270005
022800     05  FILLER                      PIC  X(10)    VALUE          02280005
022900                                          'AUDIT FOR '.           02290005
023000     05  FILLER                      PIC  X(11)    VALUE          02300005
023100                                          'PROCESSING '.          02310005
023200     05  FILLER                      PIC  X(06)    VALUE          02320005
023300                                          'DATE: '.               02330005
023400     05  HL2-DATE                    PIC  X(10)    VALUE SPACE.   02340005
023500     05  FILLER                      PIC  X(32)    VALUE SPACE.   02350005
023600                                                                  02360005
023700 01  HL3-HEADING-LINE-3.                                          02370005
023800     05  FILLER                      PIC  X(49)    VALUE ALL '-'. 02380005
023900     05  FILLER                      PIC  X(09)    VALUE          02390005
024000                                          ' STORE # '.            02400005
024100     05  HL3-STORE                   PIC  Z999.                   02410005
024200     05  FILLER                      PIC  X(01)    VALUE SPACE.   02420005
024300*    05  FILLER                      PIC  X(11)    VALUE          02430005
024400*                                         'MERCHANT # '.          02440005
024500*    05  HL3-MERCHANT                PIC  X(18)    VALUE SPACE.   02450005
024600*    05  FILLER                      PIC  X(01)    VALUE SPACE.   02460005
024700     05  FILLER                      PIC  X(70)    VALUE ALL '-'. 02470005
024800                                                                  02480005
024900 01  HL4-HEADING-LINE-4.                                          02490005
025000     05  FILLER                      PIC  X(50)    VALUE SPACE.   02500005
025100     05  FILLER                      PIC  X(04)    VALUE 'AUTH'.  02510005
025200     05  FILLER                      PIC  X(78)    VALUE SPACE.   02520005
025300                                                                  02530005
025400 01  HL5-HEADING-LINE-5.                                          02540005
025500     05  FILLER                      PIC  X(08)    VALUE SPACE.   02550005
025600     05  FILLER                      PIC  X(10)    VALUE          02560005
025700                                                   'SALES DATE'.  02570005
025800     05  FILLER                      PIC  X(04)    VALUE SPACE.   02580005
025900     05  FILLER                      PIC  X(05)    VALUE 'REG #'. 02590005
026000     05  FILLER                      PIC  X(02)    VALUE SPACE.   02600005
026100     05  FILLER                      PIC  X(07)    VALUE          02610005
026200                                                   'TRANS #'.     02620005
026300     05  FILLER                      PIC  X(02)    VALUE SPACE.   02630005
026400     05  FILLER                      PIC  X(08)    VALUE          02640005
026500                                                   'ASSOC ID'.    02650005
026600     05  FILLER                      PIC  X(02)    VALUE SPACE.   02660005
026700     05  FILLER                      PIC  X(06)    VALUE          02670005
026800                                                   'NUMBER'.      02680005
026900     05  FILLER                      PIC  X(11)    VALUE SPACE.   02690005
027000     05  FILLER                      PIC  X(06)    VALUE          02700005
027100                                                   'ACCT #'.      02710005
027200     05  FILLER                      PIC  X(12)    VALUE SPACE.   02720005
027300     05  FILLER                      PIC  X(04)    VALUE          02730005
027400                                                   'CODE'.        02740005
027500     05  FILLER                      PIC  X(08)    VALUE SPACE.   02750005
027600     05  FILLER                      PIC  X(05)    VALUE          02760005
027700                                                   'SALES'.       02770005
027800     05  FILLER                      PIC  X(06)    VALUE SPACE.   02780005
027900     05  FILLER                      PIC  X(07)    VALUE          02790005
028000                                                   'RETURNS'.     02800005
028100     05  FILLER                      PIC  X(04)    VALUE SPACE.   02810005
028200     05  FILLER                      PIC  X(10)    VALUE          02820005
028300                                                   'NET AMOUNT'.  02830005
028400     05  FILLER                      PIC  X(03)    VALUE SPACE.   02840005
028500                                                                  02850005
028600 01  HL6-HEADING-LINE-6.                                          02860005
028700     05  FILLER                      PIC  X(04)    VALUE SPACE.   02870005
028800     05  FILLER                      PIC  X(08)    VALUE          02880005
028900                                          'STORE # '.             02890005
029000     05  HL6-STORE                   PIC  Z999.                   02900005
029100     05  FILLER                      PIC  X(11)    VALUE          02910005
029200                                          ' TOTAL FOR '.          02920005
029300     05  HL6-DATE                    PIC  X(10)    VALUE SPACE.   02930005
029400     05  FILLER                      PIC  X(54)    VALUE SPACE.   02940005
029500     05  HL6-SALES-TOTAL             PIC  X(10)    VALUE SPACE.   02950005
029600     05  FILLER                      PIC  X(03)    VALUE SPACE.   02960005
029700     05  HL6-RETURN-TOTAL            PIC  X(10)    VALUE SPACE.   02970005
029800     05  FILLER                      PIC  X(04)    VALUE SPACE.   02980005
029900     05  HL6-NET-AMOUNT              PIC  X(10)    VALUE SPACE.   02990005
030000     05  FILLER                      PIC  X(04)    VALUE SPACE.   03000005
030100                                                                  03010005
030200******************************************************************03020005
030300*  DETAIL LINE PRINTED ON THE REPORT.                             03030005
030400******************************************************************03040005
030500 01  DL1-DETAIL-LINE-1.                                           03050005
030600     05  FILLER                      PIC  X(08)    VALUE SPACE.   03060005
030700     05  DL1-SALES-DATE              PIC  X(10)    VALUE SPACE.   03070005
030800     05  FILLER                      PIC  X(04)    VALUE SPACE.   03080005
030900     05  DL1-REGISTER                PIC  9(04)    VALUE ZERO.    03090005
031000     05  FILLER                      PIC  X(04)    VALUE SPACE.   03100005
031100     05  DL1-TRANSACTION             PIC  9(04)    VALUE ZERO.    03110005
031200     05  FILLER                      PIC  X(04)    VALUE SPACE.   03120005
031300     05  DL1-ASSOC-ID                PIC  X(08)    VALUE SPACE.   03130005
031400     05  FILLER                      PIC  X(02)    VALUE SPACE.   03140005
031500     05  DL1-AUTH-NBR                PIC  X(06)    VALUE SPACE.   03150005
031600     05  FILLER                      PIC  X(04)    VALUE SPACE.   03160005
031700     05  DL1-CARD-NBR                PIC  X(19)    VALUE SPACE.   03170005
031800     05  FILLER                      PIC  X(07)    VALUE SPACE.   03180005
031900     05  DL1-CODE                    PIC  X(01)    VALUE SPACE.   03190005
032000     05  FILLER                      PIC  X(06)    VALUE SPACE.   03200005
032100     05  DL1-SALES-AMOUNT            PIC  X(10)    VALUE SPACE.   03210005
032200     05  FILLER                      PIC  X(03)    VALUE SPACE.   03220005
032300     05  DL1-RETURN-AMOUNT           PIC  X(10)    VALUE SPACE.   03230005
032400     05  FILLER                      PIC  X(18)    VALUE SPACE.   03240005
032500                                                                  03250005
032600 EJECT                                                            03260005
032700******************************************************************03270005
032800*  TOTAL LINE PRINTED AT THE END OF THE REPORT                    03280005
032900******************************************************************03290005
033000 01 TL1-TOTAL-LINE-1.                                             03300005
033100    05  FILLER                       PIC X(01) VALUE SPACE.       03310005
033200    05  FILLER                       PIC X(08) VALUE              03320005
033300                                         'COMPANY '.              03330005
033400    05  FILLER                       PIC X(10) VALUE              03340005
033500                                         'TOTAL FOR '.            03350005
033600    05  FILLER                       PIC X(04) VALUE              03360005
033700                                         'ALL '.                  03370005
033800    05  FILLER                       PIC X(12) VALUE              03380005
033900                                         'CORRECTIONS '.          03390005
034000    05  FILLER                       PIC X(11) VALUE              03400005
034100                                         'ENTERED ON '.           03410005
034200    05  TL1-DATE                     PIC X(10) VALUE SPACE.       03420005
034300    05  FILLER                       PIC X(34) VALUE SPACE.       03430005
034400    05  TL1-SALES-AMOUNT             PIC ZZZ,ZZ9.99-.             03440005
034500    05  FILLER                       PIC X(02) VALUE SPACE.       03450005
034600    05  TL1-RETURN-AMOUNT            PIC ZZZ,ZZ9.99-.             03460005
034700    05  FILLER                       PIC X(03) VALUE SPACE.       03470005
034800    05  TL1-NET-AMOUNT               PIC ZZZ,ZZ9.99-.             03480005
034900    05  FILLER                       PIC X(04) VALUE SPACE.       03490005
035000                                                                  03500005
035100******************************************************************03510005
035200*  WS FIELDS FOR SQLCA MESSAGE ROUTINE                            03520005
035300******************************************************************03530005
035400     COPY DPWS004.                                                03540005
035500 EJECT                                                            03550005
035600******************************************************************03560005
035700*  DB2 COMMUNICATION AREA.                                        03570005
035800******************************************************************03580005
035900     EXEC SQL                                                     03590005
036000          INCLUDE SQLCA                                           03600005
036100     END-EXEC.                                                    03610005
036200 EJECT                                                            03620005
036300******************************************************************03630005
036400*  DB2 TABLE TEPTRN - TRANSACTION TABLE                           03640005
036500******************************************************************03650005
036600     EXEC SQL                                                     03660005
036700          INCLUDE TEPTRN                                          03670005
036800     END-EXEC.                                                    03680005
036900 EJECT                                                            03690005
037000******************************************************************03700005
037100*  DB2 TABLE TEPPART - PARTITION TABLE                            03710005
037200******************************************************************03720005
037300     EXEC SQL                                                     03730005
037400          INCLUDE TEPPART                                         03740005
037500     END-EXEC.                                                    03750005
037600 EJECT                                                            03760005
037700******************************************************************03770005
037800*  DB2 TABLE TEPTND - TENDER TABLE                                03780005
037900******************************************************************03790005
038000     EXEC SQL                                                     03800005
038100          INCLUDE TEPTND                                          03810005
038200     END-EXEC.                                                    03820005
038300 EJECT                                                            03830005
038400******************************************************************03840005
038500*  DB2 TABLE TEPCRD - CREDIT TENDER TABLE                         03850005
038600******************************************************************03860005
038700     EXEC SQL                                                     03870005
038800          INCLUDE TEPCRD                                          03880005
038900     END-EXEC.                                                    03890005
039000 EJECT                                                            03900005
039100******************************************************************03910005
039200*  DB2 TABLE TEPDKEY - CURRENT PROCESSING DAY KEYS                03920005
039300******************************************************************03930005
039400     EXEC SQL                                                     03940005
039500          INCLUDE TEPDKEY                                         03950005
039600     END-EXEC.                                                    03960005
039700 EJECT                                                            03970005
039800******************************************************************03980005
039900*  DB2 TABLE TEPSAT - SALES AUDIT USER ID TABLE                   03990005
040000******************************************************************04000005
040100     EXEC SQL                                                     04010005
040200          INCLUDE TEPSAT                                          04020005
040300     END-EXEC.                                                    04030005
040400 EJECT                                                            04040005
040500******************************************************************04050005
040600*  DB2 TABLE XST_LOC_ATTR - STORE LOCATION ATTRIBUTE TABLE        04060005
040700******************************************************************04070005
040800*    EXEC SQL                                                     04080005
040900*         INCLUDE XST00025                                        04090005
041000*    END-EXEC.                                                    04100005
041100*EJECT                                                            04110005
041200******************************************************************04120005
041300*  CURSOR TO RETRIEVE BANKCARD CORRECTION DATA                    04130005
041400******************************************************************04140005
041500     EXEC SQL                                                     04150005
041600       DECLARE BANKCARD-CURSOR CURSOR FOR                         04160005
041700            SELECT  T.PARTN_NBR                                   04170005
041800                   ,T.STR_NBR                                     04180005
041900                   ,T.RGST_ID                                     04190005
042000                   ,T.TRN_NBR                                     04200005
042100                   ,T.STRT_TM                                     04210005
042200                   ,T.SLS_CORR_SEQ_NBR                            04220005
042300                   ,TRN_STAT_CDE                                  04230005
042400                   ,T.SLS_DTE                                     04240005
042500                   ,ASSOC_ID                                      04250005
042600                   ,TNDR_ID                                       04260005
042700                   ,TNDR_AMT                                      04270005
042800                   ,TNDR_ID_LEN_NBR                               04280005
042900                   ,AUTH_NBR                                      04290005
043000            FROM    TEPDKEY D                                     04300005
043100                   ,TEPTRN T                                      04310005
043200                   ,TEPTND N                                      04320005
043300                   ,TEPCRD C                                      04330005
043400                   ,TEPPART A                                     04340005
043500            WHERE   D.PRCG_DTE         = :EPDKEY-PRCG-DTE         04350005
043600              AND   D.SLS_DTE          = A.SLS_DTE                04360005
043700              AND   A.PARTN_NBR        = T.PARTN_NBR              04370005
043800              AND   D.STR_NBR          = T.STR_NBR                04380005
043900              AND   D.RGST_ID          = T.RGST_ID                04390005
044000              AND   D.TRN_NBR          = T.TRN_NBR                04400005
044100              AND   D.STRT_TM          = T.STRT_TM                04410005
044200              AND   D.SLS_CORR_SEQ_NBR = T.SLS_CORR_SEQ_NBR       04420005
044300              AND   T.PARTN_NBR        = N.PARTN_NBR              04430005
044400              AND   T.STR_NBR          = N.STR_NBR                04440005
044500              AND   T.RGST_ID          = N.RGST_ID                04450005
044600              AND   T.TRN_NBR          = N.TRN_NBR                04460005
044700              AND   T.STRT_TM          = N.STRT_TM                04470005
044800              AND   T.SLS_CORR_SEQ_NBR = N.SLS_CORR_SEQ_NBR       04480005
044900              AND   N.PARTN_NBR        = C.PARTN_NBR              04490005
045000              AND   N.STR_NBR          = C.STR_NBR                04500005
045100              AND   N.RGST_ID          = C.RGST_ID                04510005
045200              AND   N.TRN_NBR          = C.TRN_NBR                04520005
045300              AND   N.STRT_TM          = C.STRT_TM                04530005
045400              AND   N.SLS_CORR_SEQ_NBR = C.SLS_CORR_SEQ_NBR       04540005
045500              AND   N.TNDR_SEQ_NBR     = C.TNDR_SEQ_NBR           04550005
045600              AND   D.SLS_CORR_SEQ_NBR <> 0                       04560005
045700              AND   VOID_ABRT_CDE      = 'N'                      04570005
045800              AND   TRN_STAT_CDE       IN ('V', 'R', 'L', 'Z')    04580005
045900              AND   TNDR_TYP_CDE       IN (:PC-VISA-TENDER-TYPE,  04590005
046000                                       :PC-MASTERCARD-TENDER-TYPE)04600005
046100              AND   TNDR_VOID_IND      = 'N'                      04610005
046200              AND   STTLMNT_PRCD_CDE   = 'P'                      04620005
046300           ORDER BY T.STR_NBR                                     04630005
046400                   ,T.SLS_DTE                                     04640005
046500                   ,T.RGST_ID                                     04650005
046600                   ,T.TRN_NBR                                     04660005
046700           WITH UR                                                04670005
046800     END-EXEC.                                                    04680005
046900                                                                  04690005
047000***************************************************************** 04700005
047100* PROCEDURE DIVISION.                                           * 04710005
047200***************************************************************** 04720005
047300 PROCEDURE DIVISION.                                              04730005
047400                                                                  04740005
047500******************************************************************04750005
047600* 0000-MAINLINE-PARAGRAPH                                         04760005
047700*      PRODUCE BANKCARD CORRECTIONS REPORT                        04770005
047800******************************************************************04780005
047900 0000-MAINLINE-PARAGRAPH.                                         04790005
048000                                                                  04800005
048100     PERFORM 1000-INITIALIZE-PROGRAM.                             04810005
048200                                                                  04820005
048300     PERFORM 2000-PRODUCE-REPORT-LINES                            04830005
048400         UNTIL PS-END-OF-CURSOR.                                  04840005
048500                                                                  04850005
048600     IF PV-CURSOR-CNT           GREATER THAN ZERO                 04860005
048700         PERFORM 5200-PRINT-STORE-TOTAL-LINE                      04870005
048800     END-IF.                                                      04880005
048900                                                                  04890005
049000     PERFORM 4000-PRINT-REPORT-TOTALS.                            04900005
049100                                                                  04910005
049200     DISPLAY '****************************************'           04920005
049300     DISPLAY '*************** SAKRP016 ***************'           04930005
049400     DISPLAY '****************************************'           04940005
049500     MOVE PV-CURSOR-CNT          TO PV-EDIT-MASK                  04950005
049600     INSPECT PV-EDIT-MASK REPLACING LEADING SPACE BY '.'          04960005
049700     DISPLAY 'CORRECTION ROWS FETCHED........'                    04970005
049800         PV-EDIT-MASK                                             04980005
049900     DISPLAY '****************************************'           04990005
050000     DISPLAY '****************************************'           05000005
050100     DISPLAY '****************************************'           05010005
050200                                                                  05020005
050300     STOP RUN.                                                    05030005
050400                                                                  05040005
050500 EJECT                                                            05050005
050600                                                                  05060005
050700******************************************************************05070005
050800* 1000-INITIALIZE-PROGRAM                                         05080005
050900*     OPEN FILES, PROCESS CONTROL CARD, FORMAT REPORT HEADINGS,   05090005
051000*     OPEN BANKCARD-CUROSR, ATTEMPT FIRST FETCH OF CURSOR         05100005
051100******************************************************************05110005
051200 1000-INITIALIZE-PROGRAM.                                         05120005
051300                                                                  05130005
051400     OPEN INPUT  POS-DATE-CARD-FILE                               05140005
051500          OUTPUT BANKCARD-REPORT-FILE.                            05150005
051600                                                                  05160005
051700     PERFORM 1100-PROCESS-CONTROL-CARD.                           05170005
051800                                                                  05180005
051900     PERFORM 1200-FORMAT-HEADINGS.                                05190005
052000                                                                  05200005
052100     PERFORM 1300-PREPARE-FOR-REPORT.                             05210005
052200                                                                  05220005
052300******************************************************************05230005
052400* 1100-PROCESS-CONTROL-CARD                                       05240005
052500*     READ CONTROL CARD TO GET POS DATE IN MMDDYY FORMAT.  CALL   05250005
052600*     DATE ROUTINE TO CONVERT DATE TO A CCYY-MM-DD PROCESS DATE.  05260005
052700******************************************************************05270005
052800 1100-PROCESS-CONTROL-CARD.                                       05280005
052900                                                                  05290005
053000     PERFORM 1110-READ-POS-DATE-CARD-FILE.                        05300005
053100     CLOSE POS-DATE-CARD-FILE.                                    05310005
053200     IF PS-END-OF-CARD-FILE                                       05320005
053300         MOVE '1100-PROCESS-CONTROL-CARD'  TO PV-PARAGRAPH-NAME   05330005
053400         MOVE 'NO CONTROL CARD TO PROCESS' TO PV-OPERATION-MSG-1  05340005
053500         SET AC-CONTROL-CARD-ERROR TO TRUE                        05350005
053600         PERFORM 9999-ABEND                                       05360005
053700     END-IF.                                                      05370005
053800     DISPLAY PC-CURRENT-PROGRAM-NAME                              05380005
053900             ' - CONTROL CARD = (' CC-CONTROL-CARD-DISPLAY  ')'.  05390005
054000     PERFORM 1115-CONVERT-INPUT-DATE.                             05400005
054100 EJECT                                                            05410005
054200                                                                  05420005
054300******************************************************************05430005
054400* 1110-READ-POS-DATE-CARD-FILE                                    05440005
054500*     READ DATE CONTROL CARD.                                     05450005
054600******************************************************************05460005
054700 1110-READ-POS-DATE-CARD-FILE.                                    05470005
054800     READ POS-DATE-CARD-FILE INTO CC-CONTROL-CARD                 05480005
054900        AT END                                                    05490005
055000           SET PS-END-OF-CARD-FILE TO TRUE.                       05500005
055100                                                                  05510005
055200******************************************************************05520005
055300* 1115-CONVERT-INPUT-DATE                                         05530005
055400*     CALL KOHLS CALENDAR ROUTINE:                                05540005
055500*         PASS: CONTROL CARD POS DATE (MMDDYY FORMAT).            05550005
055600*       RETURN: ACTUAL CALENDAR DB2 ISO DATE (CCYY-MM-DD FORMAT). 05560005
055700******************************************************************05570005
055800                                                                  05580005
055900 1115-CONVERT-INPUT-DATE.                                         05590005
056000                                                                  05600005
056100     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              05610005
056200                                                                  05620005
056300     SET  DPG51-ACTUAL-CALENDAR-ONLY   TO TRUE.                   05630005
056400     SET  DPG51-DO-NOT-INCR-DECR-DATE  TO TRUE.                   05640005
056500     SET  DPG52-LK-DTE-GREG            TO TRUE.                   05650005
056600     MOVE CC-POS-DATE-MMDDYY           TO DPG52-LK-DATE-INPUT.    05660005
056700     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    05670005
056800                                             DPG54 DPG55 DPG56.   05680005
056900     EVALUATE TRUE                                                05690005
057000         WHEN DPG54-SEVERE-ERROR                                  05700005
057100         WHEN DPG54-DATE-INVALID                                  05710005
057200             MOVE '1115-CONVERT-INPUT-DATE'                       05720005
057300                                   TO PV-PARAGRAPH-NAME           05730005
057400             MOVE 'ERROR CONVERTING INPUT CARD DATE'              05740005
057500                                   TO PV-OPERATION-MSG-1          05750005
057600             SET AC-CALENDAR-ROUTINE-ERROR                        05760005
057700                                   TO TRUE                        05770005
057800             MOVE DPG54-ERROR-MESSAGE                             05780005
057900                                   TO PV-OPERATION-MSG-2          05790005
058000             PERFORM 9999-ABEND                                   05800005
058100     END-EVALUATE.                                                05810005
058200                                                                  05820005
058300     MOVE DPG55-DB2-ISO-DATE-FMT   TO PV-POS-CCYY-MM-DD           05830005
058400                                      EPDKEY-PRCG-DTE.            05840005
058500     MOVE DPG55-GREG-CC-DATE-FMT   TO PV-POS-DATE-FORMATTED.      05850005
058600 EJECT                                                            05860005
058700                                                                  05870005
058800******************************************************************05880005
058900* 1200-FORMAT-HEADINGS                                            05890005
059000*     GET CURRENT DATE AND TIME FROM SYSTEM.                      05900005
059100*     FORMAT REPORT FIELDS IN THE TOP PAGE HEADING LINE.          05910005
059200*     FORMAT HEADING LINE 2 WITH CONVERTED POS DATE.              05920005
059300******************************************************************05930005
059400 1200-FORMAT-HEADINGS.                                            05940005
059500                                                                  05950005
059600     MOVE FUNCTION CURRENT-DATE (1:8)                             05960005
059700                                   TO PV-CURR-DATE-CCYYMMDD.      05970005
059800     ACCEPT PV-CURR-TIME FROM TIME.                               05980005
059900                                                                  05990005
060000     MOVE PV-CURR-DATE-MM          TO DP132-RUN-MONTH.            06000005
060100     MOVE PV-CURR-DATE-DD          TO DP132-RUN-DAY.              06010005
060200     MOVE PV-CURR-DATE-CCYY        TO DP132-RUN-YEAR.             06020005
060300                                                                  06030005
060400     MOVE PV-CURR-TIME-HH          TO DP132-RUN-HOUR.             06040005
060500     MOVE PV-CURR-TIME-MM          TO DP132-RUN-MINUTE.           06050005
060600     MOVE PC-CURRENT-PROGRAM-NAME  TO DP132-PROGRAM-NAME.         06060005
060700     MOVE PC-REPORT-NBR-1          TO DP132-REPORT-NUMBER.        06070005
060800                                                                  06080005
060900     MOVE PV-POS-DATE-FORMATTED    TO HL2-DATE.                   06090005
061000 EJECT                                                            06100005
061100                                                                  06110005
061200******************************************************************06120005
061300* 1300-PREPARE FOR REPORT                                         06130005
061400*     - OPEN THE CURSOR                                           06140005
061500*     - FETCH FIRST RECORD                                        06150005
061600*     - IF RECORD                                                 06160005
061700******************************************************************06170005
061800 1300-PREPARE-FOR-REPORT.                                         06180005
061900                                                                  06190005
062000     PERFORM 8000-PRINT-HEADINGS.                                 06200005
062100     PERFORM 2100-OPEN-BANKCARD-CURSOR.                           06210005
062200     PERFORM 2200-FETCH-BANKCARD-CURSOR.                          06220005
062300     IF PS-END-OF-CURSOR                                          06230005
062400         DISPLAY '*** NO DATA PRESENT FOR BANKCARD CORR ***'      06240005
062500                 '*** ON SALES DATE '                             06250005
062600                 PV-POS-DATE-FORMATTED                            06260005
062700     ELSE                                                         06270005
062800         PERFORM 2500-PROCESS-FIRST-RECORD                        06280005
062900     END-IF.                                                      06290005
063000                                                                  06300005
063100******************************************************************06310005
063200* 2000-PRODUCE-REPORT-LINES                                       06320005
063300*  PRODUCE THE ACTUAL REPORT LINES                                06330005
063400******************************************************************06340005
063500 2000-PRODUCE-REPORT-LINES.                                       06350005
063600                                                                  06360005
063700     IF EPTRN-STR-NBR              = PV-HOLD-STORE                06370005
063800         CONTINUE                                                 06380005
063900     ELSE                                                         06390005
064000         PERFORM 3000-STORE-BREAK                                 06400005
064100     END-IF.                                                      06410005
064200                                                                  06420005
064300     IF EPTRN-SLS-DTE              = PV-HOLD-SALES-DATE           06430005
064400         CONTINUE                                                 06440005
064500     ELSE                                                         06450005
064600         PERFORM 3500-SALES-DATE-BREAK                            06460005
064700     END-IF.                                                      06470005
064800                                                                  06480005
064900     PERFORM 5000-PRINT-DETAIL-LINE.                              06490005
065000     PERFORM 2200-FETCH-BANKCARD-CURSOR.                          06500005
065100                                                                  06510005
065200******************************************************************06520005
065300* 2100-OPEN-BANKCARD-CURSOR.                                      06530005
065400*     OPEN BANKCARD CURSOR                                        06540005
065500******************************************************************06550005
065600 2100-OPEN-BANKCARD-CURSOR.                                       06560005
065700                                                                  06570005
065800     EXEC SQL                                                     06580005
065900          OPEN BANKCARD-CURSOR                                    06590005
066000     END-EXEC.                                                    06600005
066100                                                                  06610005
066200     EVALUATE TRUE                                                06620005
066300         WHEN SQLCODE = ZERO                                      06630005
066400              CONTINUE                                            06640005
066500         WHEN SQLWARN0 NOT EQUAL SPACE                            06650005
066600         WHEN SQLCODE NOT EQUAL ZERO                              06660005
066700             MOVE '2100-OPEN BANKCARD CURSOR'                     06670005
066800                                   TO PV-PARAGRAPH-NAME           06680005
066900             MOVE 'ERROR ON OPEN OF BANKCARD-CURSOR'              06690005
067000                                   TO PV-DB2-OPERATION            06700005
067100             PERFORM 9100-SQL-ABEND                               06710005
067200     END-EVALUATE.                                                06720005
067300 EJECT                                                            06730005
067400                                                                  06740005
067500******************************************************************06750005
067600* 2200-FETCH-SUMMARY-CURSOR                                       06760005
067700*   -FETCH ROWS THAT QUALIFY FOR THE REPORT                       06770005
067800******************************************************************06780005
067900 2200-FETCH-BANKCARD-CURSOR.                                      06790005
068000                                                                  06800005
068100     EXEC SQL                                                     06810005
068200          FETCH BANKCARD-CURSOR                                   06820005
068300           INTO :EPTRN-PARTN-NBR                                  06830005
068400               ,:EPTRN-STR-NBR                                    06840005
068500               ,:EPTRN-RGST-ID                                    06850005
068600               ,:EPTRN-TRN-NBR                                    06860005
068700               ,:EPTRN-STRT-TM                                    06870005
068800               ,:EPTRN-SLS-CORR-SEQ-NBR                           06880005
068900               ,:EPTRN-TRN-STAT-CDE                               06890005
069000               ,:EPTRN-SLS-DTE                                    06900005
069100               ,:EPTRN-ASSOC-ID                                   06910005
069200               ,:EPTND-TNDR-ID                                    06920005
069300               ,:EPTND-TNDR-AMT                                   06930005
069400               ,:EPTND-TNDR-ID-LEN-NBR                            06940005
069500               ,:EPCRD-AUTH-NBR                                   06950005
069600     END-EXEC.                                                    06960005
069700                                                                  06970005
069800     EVALUATE TRUE                                                06980005
069900         WHEN SQLCODE = ZERO                                      06990005
070000             ADD 1                 TO PV-CURSOR-CNT               07000005
070100         WHEN SQLCODE = PC-ROW-NOT-FOUND                          07010005
070200             SET PS-END-OF-CURSOR  TO TRUE                        07020005
070300         WHEN SQLWARN0 NOT EQUAL SPACE                            07030005
070400         WHEN SQLCODE NOT EQUAL ZERO                              07040005
070500             MOVE '2200-FETCH-BANKCARD-CURSOR'                    07050005
070600                                   TO PV-PARAGRAPH-NAME           07060005
070700             MOVE 'ERROR ON FETCH OF SETTLEMENT-CURSOR'           07070005
070800                                   TO PV-DB2-OPERATION            07080005
070900             PERFORM 9100-SQL-ABEND                               07090005
071000     END-EVALUATE.                                                07100005
071100 EJECT                                                            07110005
071200                                                                  07120005
071300******************************************************************07130005
071400* 2300-CLOSE-BANKCARD-CURSOR                                      07140005
071500*   -CLOSE THE CURSOR                                             07150005
071600******************************************************************07160005
071700 2300-CLOSE-BANKCARD-CURSOR.                                      07170005
071800                                                                  07180005
071900     EXEC SQL                                                     07190005
072000          CLOSE BANKCARD-CURSOR                                   07200005
072100     END-EXEC.                                                    07210005
072200                                                                  07220005
072300     EVALUATE TRUE                                                07230005
072400         WHEN SQLCODE = ZERO                                      07240005
072500              CONTINUE                                            07250005
072600         WHEN SQLWARN0 NOT EQUAL SPACE                            07260005
072700         WHEN SQLCODE NOT EQUAL ZERO                              07270005
072800             MOVE '2300-CLOSE-BANKCARD-CURSOR'                    07280005
072900                                   TO PV-PARAGRAPH-NAME           07290005
073000             MOVE 'ERROR ON CLOSE OF BANKCARD-CURSOR'             07300005
073100                                   TO PV-DB2-OPERATION            07310005
073200             PERFORM 9100-SQL-ABEND                               07320005
073300     END-EVALUATE.                                                07330005
073400 EJECT                                                            07340005
073500                                                                  07350005
073600******************************************************************07360005
073700*  FIRST RECORD PROCESSING.  WRITE THE HEADER RECORDS AND MOVE    07370005
073800*  THE DATA INTO THE APPROPRIATE FIELDS.                          07380005
073900******************************************************************07390005
074000 2500-PROCESS-FIRST-RECORD.                                       07400005
074100                                                                  07410005
074200     MOVE EPTRN-STR-NBR            TO PV-HOLD-STORE.              07420005
074300     MOVE EPTRN-SLS-DTE            TO PV-HOLD-SALES-DATE.         07430005
074400*    PERFORM 3010-GET-MERCHANT-NUMBER.                            07440005
074500     PERFORM 5100-PRINT-STORE-MERCHANT-LINE.                      07450005
074600     PERFORM 3510-FORMAT-SALES-DATE.                              07460005
074700                                                                  07470005
074800******************************************************************07480005
074900*  PRINT THE STORE TOTAL WHEN A BREAK ON THE STORE NUMBER OCCURS  07490005
075000******************************************************************07500005
075100 3000-STORE-BREAK.                                                07510005
075200                                                                  07520005
075300     PERFORM 5200-PRINT-STORE-TOTAL-LINE.                         07530005
075400*    PERFORM 3010-GET-MERCHANT-NUMBER.                            07540005
075500     PERFORM 5100-PRINT-STORE-MERCHANT-LINE.                      07550005
075600                                                                  07560005
075700*** THE SALES DATE SHOULD ALWAYS BE PRINTED UNDER THE NEW STORE   07570005
075800*** INFORMATION.  THIS CHECKS TO SEE IF WE HAVE A DIFFERENT SALES 07580005
075900*** DATE WITH THE NEW STORE.                                      07590005
076000                                                                  07600005
076100     IF EPTRN-SLS-DTE              = PV-HOLD-SALES-DATE           07610005
076200         CONTINUE                                                 07620005
076300     ELSE                                                         07630005
076400         MOVE EPTRN-SLS-DTE        TO PV-HOLD-SALES-DATE          07640005
076500         PERFORM 3510-FORMAT-SALES-DATE                           07650005
076600     END-IF.                                                      07660005
076700                                                                  07670005
076800     MOVE ZERO TO                  PA-STORE-SALES-AMOUNT          07680005
076900                                   PA-STORE-RETURN-AMOUNT.        07690005
077000     MOVE EPTRN-STR-NBR            TO PV-HOLD-STORE.              07700005
077100                                                                  07710005
077200***************************************************************** 07720005
077300*  GET THE MERCHANT NUMBER FOR THE STORE                          07730005
077400***************************************************************** 07740005
077500*3010-GET-MERCHANT-NUMBER.                                        07750005
077600*                                                                 07760005
077700*    EXEC SQL                                                     07770005
077800*        SELECT  BNKCRD_MERCH_NBR                                 07780005
077900*        INTO    :XST00025-BNKCRD-MERCH-NBR                       07790005
078000*        FROM    XST_LOC_ATTR                                     07800005
078100*        WHERE   LOC_NBR = :EPTRN-STR-NBR                         07810005
078200*        WITH UR                                                  07820005
078300*    END-EXEC.                                                    07830005
078400*                                                                 07840005
078500*    EVALUATE TRUE                                                07850005
078600*        WHEN SQLCODE = ZERO                                      07860005
078700*            MOVE XST00025-BNKCRD-MERCH-NBR                       07870005
078800*                                  TO PV-MERCH-NMBR               07880005
078900*        WHEN SQLWARN0 NOT EQUAL SPACE                            07890005
079000*        WHEN SQLCODE NOT EQUAL ZERO                              07900005
079100*            MOVE '3010-GET-MERCHANT-NUMBER'                      07910005
079200*                                  TO PV-PARAGRAPH-NAME           07920005
079300*            MOVE 'ERROR ON GETTING MERCHANT NUMBER'              07930005
079400*                                  TO PV-DB2-OPERATION            07940005
079500*            PERFORM 9100-SQL-ABEND                               07950005
079600*    END-EVALUATE.                                                07960005
079700*                                                                 07970005
079800***************************************************************** 07980005
079900*  PRINT THE REQUIRED DATA ON A BREAK IN SALES DATE               07990005
080000***************************************************************** 08000005
080100 3500-SALES-DATE-BREAK.                                           08010005
080200                                                                  08020005
080300     PERFORM 5200-PRINT-STORE-TOTAL-LINE.                         08030005
080400     MOVE ZERO                     TO PA-STORE-SALES-AMOUNT       08040005
080500                                      PA-STORE-RETURN-AMOUNT.     08050005
080600     MOVE EPTRN-SLS-DTE            TO PV-HOLD-SALES-DATE.         08060005
080700     PERFORM 3510-FORMAT-SALES-DATE.                              08070005
080800                                                                  08080005
080900****************************************************************  08090005
081000*  CALL CALENDAR ROUTINE TO CONVERT THE SALES DATE FROM DB2       08100005
081100*  FORMAT INTO GREGORIAN FORMATTED FORMAT                         08110005
081200****************************************************************  08120005
081300 3510-FORMAT-SALES-DATE.                                          08130005
081400                                                                  08140005
081500     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              08150005
081600                                                                  08160005
081700     SET  DPG51-ACTUAL-CALENDAR-ONLY   TO TRUE.                   08170005
081800     SET  DPG51-DO-NOT-INCR-DECR-DATE  TO TRUE.                   08180005
081900     SET  DPG52-LK-DTE-ISO-FMT         TO TRUE.                   08190005
082000     MOVE EPTRN-SLS-DTE                TO DPG52-LK-DATE-INPUT.    08200005
082100     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    08210005
082200                                             DPG54 DPG55 DPG56.   08220005
082300     EVALUATE TRUE                                                08230005
082400         WHEN DPG54-SEVERE-ERROR                                  08240005
082500         WHEN DPG54-DATE-INVALID                                  08250005
082600             MOVE '3510-FORMAT-SALES-DATEE'                       08260005
082700                                   TO PV-PARAGRAPH-NAME           08270005
082800             MOVE 'ERROR CONVERTING SALES DATE'                   08280005
082900                                   TO PV-OPERATION-MSG-1          08290005
083000             SET AC-CALENDAR-ROUTINE-ERROR TO TRUE                08300005
083100             MOVE DPG54-ERROR-MESSAGE                             08310005
083200                                   TO PV-OPERATION-MSG-2          08320005
083300             PERFORM 9999-ABEND                                   08330005
083400     END-EVALUATE.                                                08340005
083500     MOVE DPG55-GREG-CC-DATE-FMT   TO PV-SLS-DATE-FORMATTED.      08350005
083600                                                                  08360005
083700******************************************************************08370005
083800* 4000-PRINT-REPORT-TOTALS                                        08380005
083900*     PRINT REPORT TOTALS (IF DATA WAS PRESENT & REPORT CREATED), 08390005
084000*     CLOSE REPORT FILE.                                          08400005
084100******************************************************************08410005
084200 4000-PRINT-REPORT-TOTALS.                                        08420005
084300                                                                  08430005
084400     PERFORM 2300-CLOSE-BANKCARD-CURSOR.                          08440005
084500     MOVE PV-POS-DATE-FORMATTED    TO TL1-DATE.                   08450005
084600     MOVE PA-COMPANY-SALES-AMOUNT                                 08460005
084700                                   TO TL1-SALES-AMOUNT.           08470005
084800     MOVE PA-COMPANY-RETURN-AMOUNT                                08480005
084900                                   TO TL1-RETURN-AMOUNT.          08490005
085000     COMPUTE PV-AMOUNT             = PA-COMPANY-RETURN-AMOUNT     08500005
085100                                   + PA-COMPANY-SALES-AMOUNT.     08510005
085200     MOVE PV-AMOUNT                TO TL1-NET-AMOUNT.             08520005
085300     MOVE +4                       TO PV-LINE-SPACING.            08530005
085400     MOVE TL1-TOTAL-LINE-1         TO PV-PRINT-RECORD.            08540005
085500     PERFORM 8200-WRITE-REPORT-LINE.                              08550005
085600     CLOSE BANKCARD-REPORT-FILE.                                  08560005
085700 EJECT                                                            08570005
085800                                                                  08580005
085900******************************************************************08590005
086000* 5000-PRINT-DETAIL-LINE                                          08600005
086100*     FORMAT AND PRINT REPORT DETAIL LINE.                        08610005
086200******************************************************************08620005
086300 5000-PRINT-DETAIL-LINE.                                          08630005
086400                                                                  08640005
086500     IF PV-LINE-CNT                > PC-LINE-LIMIT                08650005
086600         PERFORM 8000-PRINT-HEADINGS                              08660005
086700     END-IF.                                                      08670005
086800                                                                  08680005
086900     INITIALIZE                    DL1-SALES-AMOUNT               08690005
087000                                   DL1-RETURN-AMOUNT              08700005
087100                                   DL1-ASSOC-ID                   08710005
087200                                   DL1-CODE                       08720005
087300                                   PV-CARD-NBR-16-FIRST-4         08730005
087400                                   PV-CARD-NBR-16-SECOND-4        08740005
087500                                   PV-CARD-NBR-16-THIRD-4         08750005
087600                                   PV-CARD-NBR-16-LAST-4          08760005
087700                                   PV-CARD-NBR-13-FIRST-4         08770005
087800                                   PV-CARD-NBR-13-SECOND-3        08780005
087900                                   PV-CARD-NBR-13-THIRD-3         08790005
088000                                   PV-CARD-NBR-13-LAST-3.         08800005
088100     MOVE PV-SLS-DATE-FORMATTED    TO DL1-SALES-DATE.             08810005
088200     MOVE EPTRN-RGST-ID            TO DL1-REGISTER.               08820005
088300     MOVE EPTRN-TRN-NBR            TO DL1-TRANSACTION.            08830005
088400     MOVE EPCRD-AUTH-NBR           TO DL1-AUTH-NBR.               08840005
088500                                                                  08850005
088600****  SOME VISA CARDS ARE 13 DIGITS IN LENGTH.  THIS NEXT CHECK   08860005
088700****  IS DONE SO THE ACCOUNT NUMBER WILL BE PROPERLY FORMATTED ON 08870005
088800****  THE REPORT.                                                 08880005
088900                                                                  08890005
089000     IF EPTND-TNDR-ID-LEN-NBR      = PC-SHORT-CARD-LENGTH         08900005
               MOVE ALL '*'              TO PV-CARD-NBR-13-FIRST-4      08931009
                                            PV-CARD-NBR-13-SECOND-3     08932009
                                            PV-CARD-NBR-13-THIRD-3      08933009
089400         MOVE EPTND-TNDR-ID (11:3) TO PV-CARD-NBR-13-LAST-3       08940005
089500         MOVE PV-CARD-NBR-13       TO DL1-CARD-NBR                08950005
089600     ELSE                                                         08960005
               MOVE ALL '*'              TO PV-CARD-NBR-16-FIRST-4      08991009
                                            PV-CARD-NBR-16-SECOND-4     08992009
                                            PV-CARD-NBR-16-THIRD-4      08993009
090000         MOVE EPTND-TNDR-ID (13:4) TO PV-CARD-NBR-16-LAST-4       09000005
090100         MOVE PV-CARD-NBR-16       TO DL1-CARD-NBR                09010005
090200     END-IF.                                                      09020005
090300                                                                  09030005
090400     EVALUATE TRUE                                                09040005
090500         WHEN EPTND-TNDR-AMT       > ZERO                         09050005
090600             MOVE EPTND-TNDR-AMT   TO PV-AMOUNT-FORMATTED         09060005
090700             MOVE PV-AMOUNT-FORMATTED                             09070005
090800                                   TO DL1-SALES-AMOUNT            09080005
090900             MOVE SPACE            TO DL1-RETURN-AMOUNT           09090005
091000             ADD EPTND-TNDR-AMT    TO PA-STORE-SALES-AMOUNT       09100005
091100                                                                  09110005
091200         WHEN EPTND-TNDR-AMT       < ZERO                         09120005
091300             MOVE EPTND-TNDR-AMT   TO PV-AMOUNT-FORMATTED         09130005
091400             MOVE PV-AMOUNT-FORMATTED                             09140005
091500                                   TO DL1-RETURN-AMOUNT           09150005
091600             MOVE SPACE            TO DL1-SALES-AMOUNT            09160005
091700             ADD EPTND-TNDR-AMT    TO PA-STORE-RETURN-AMOUNT      09170005
091800                                                                  09180005
091900         WHEN OTHER                                               09190005
092000             MOVE ZERO             TO PV-AMOUNT-FORMATTED         09200005
092100             MOVE PV-AMOUNT-FORMATTED                             09210005
092200                                   TO DL1-RETURN-AMOUNT           09220005
092300                                      DL1-SALES-AMOUNT            09230005
092400     END-EVALUATE.                                                09240005
092500                                                                  09250005
092600**** A LATE TRANSACTION, INDICATED BY A -1 SEQUENCE NUMBER, WILL N09260005
092700**** HAVE A SALES AUDIT USER ID.  A REGULAR CORRECTION WILL HVAE A09270005
092800**** SALES AUDIT USER ID.                                         09280005
092900                                                                  09290005
093000     IF EPTRN-SLS-CORR-SEQ-NBR     < ZERO                         09300005
093100         MOVE PC-SYSTEM-CORRECTION TO DL1-CODE                    09310005
093200     ELSE                                                         09320005
093300         IF EPTRN-TRN-STAT-CDE     = PC-REVERSAL-CORRECTION       09330005
093400             MOVE PC-REVERSAL-CORRECTION                          09340005
093500                                   TO DL1-CODE                    09350005
093600         END-IF                                                   09360005
093700         PERFORM 5010-SELECT-SLS-AUD-USER-ID                      09370005
093800     END-IF.                                                      09380005
093900                                                                  09390005
094000     MOVE DL1-DETAIL-LINE-1        TO PV-PRINT-RECORD.            09400005
094100                                                                  09410005
094200**** FOLLOWING CODE CHECKS IF THE LAST LINE PRINTED WAS SINGLE    09420005
094300**** SPACED (LIKE A DETAIL LINE) OR GREATER THAN SINGLE SPACED    09430005
094400**** (LIKE A HEADING LINE).  IF LAST LINE WAS NOT SINGLE SPACED,  09440005
094500**** PRINT THE DETAIL LINE DOUBLE SPACED.                         09450005
094600                                                                  09460005
094700     IF PV-LINE-SPACING            > +1                           09470005
094800         MOVE +2                   TO  PV-LINE-SPACING            09480005
094900     ELSE                                                         09490005
095000         MOVE +1                   TO  PV-LINE-SPACING            09500005
095100     END-IF.                                                      09510005
095200     PERFORM 8200-WRITE-REPORT-LINE.                              09520005
095300     MOVE +1                       TO  PV-LINE-SPACING.           09530005
095400 EJECT                                                            09540005
095500                                                                  09550005
095600***************************************************************** 09560005
095700* 5010-SELECT-SLS-AUD-USER-ID                                     09570005
095800*   - SELECT THE SALES AUDIT USER ID WHEN THE SALES CORRECTION    09580005
095900*     CORRECTION SEQUNCE NUMBER IS GREATER THAN ZERO              09590005
096000***************************************************************** 09600005
096100 5010-SELECT-SLS-AUD-USER-ID.                                     09610005
096200                                                                  09620005
096300     EXEC SQL                                                     09630005
096400         SELECT SLS_AUD_USR_ID                                    09640005
096500           INTO :EPSAT-SLS-AUD-USR-ID                             09650005
096600           FROM TEPSAT                                            09660005
096700          WHERE PARTN_NBR          = :EPTRN-PARTN-NBR             09670005
096800            AND STR_NBR            = :EPTRN-STR-NBR               09680005
096900            AND RGST_ID            = :EPTRN-RGST-ID               09690005
097000            AND TRN_NBR            = :EPTRN-TRN-NBR               09700005
097100            AND STRT_TM            = :EPTRN-STRT-TM               09710005
097200            AND SLS_CORR_SEQ_NBR   = :EPTRN-SLS-CORR-SEQ-NBR      09720005
097300         WITH UR                                                  09730005
097400     END-EXEC.                                                    09740005
097500                                                                  09750005
097600     EVALUATE TRUE                                                09760005
097700         WHEN SQLCODE = ZERO                                      09770005
097800             MOVE EPSAT-SLS-AUD-USR-ID                            09780005
097900                                   TO DL1-ASSOC-ID                09790005
098000         WHEN SQLCODE = PC-ROW-NOT-FOUND                          09800005
098100             MOVE 'UNKNOWN'        TO DL1-ASSOC-ID                09810005
098200         WHEN SQLWARN0 NOT EQUAL SPACE                            09820005
098300         WHEN SQLCODE NOT EQUAL ZERO                              09830005
098400             MOVE '5010-SELECT-SLS-AUD-USER-ID'                   09840005
098500                                   TO PV-PARAGRAPH-NAME           09850005
098600             MOVE 'ERROR ON SELECTING SLS AUD USER ID'            09860005
098700                                   TO PV-DB2-OPERATION            09870005
098800             PERFORM 9100-SQL-ABEND                               09880005
098900     END-EVALUATE.                                                09890005
099000                                                                  09900005
099100***************************************************************** 09910005
099200*  PRINT THE LINE CONTAINING THE STORE ANDMERCHANT NUMBER         09920005
099300***************************************************************** 09930005
099400 5100-PRINT-STORE-MERCHANT-LINE.                                  09940005
099500                                                                  09950005
099600**** FOLLOWING CODE CHECKS FOR ENOUGH ROOM ON THE PAGE TO         09960005
099700**** PRINT THE STORE / MERCHANT LINE, SALES DATE LINE,            09970005
099800**** AND AT LEAST ONE DETAIL LINE.                                09980005
099900                                                                  09990005
100000     MOVE PV-LINE-CNT              TO  PV-LINE-CNT-AHEAD.         10000005
100100     ADD +8                        TO  PV-LINE-CNT-AHEAD.         10010005
100200     IF PV-LINE-CNT-AHEAD          > PC-LINE-LIMIT                10020005
100300         PERFORM 8000-PRINT-HEADINGS                              10030005
100400     END-IF.                                                      10040005
100500                                                                  10050005
100600     MOVE EPTRN-STR-NBR            TO HL3-STORE.                  10060005
100700*    MOVE PV-MERCH-NMBR            TO HL3-MERCHANT.               10070005
100800     MOVE +4                       TO PV-LINE-SPACING.            10080005
100900     MOVE HL3-HEADING-LINE-3       TO PV-PRINT-RECORD.            10090005
101000     PERFORM 8200-WRITE-REPORT-LINE.                              10100005
101100                                                                  10110005
101200******************************************************************10120005
101300*  PRINT THE STORE TOTAL LINE INFORMATION                         10130005
101400******************************************************************10140005
101500 5200-PRINT-STORE-TOTAL-LINE.                                     10150005
101600                                                                  10160005
101700     IF PV-LINE-CNT                > PC-LINE-LIMIT                10170005
101800         PERFORM 8000-PRINT-HEADINGS                              10180005
101900     END-IF.                                                      10190005
102000                                                                  10200005
102100     MOVE PV-HOLD-STORE            TO HL6-STORE.                  10210005
102200     MOVE PV-SLS-DATE-FORMATTED    TO HL6-DATE.                   10220005
102300                                                                  10230005
102400     IF PA-STORE-SALES-AMOUNT      > ZERO                         10240005
102500         MOVE PA-STORE-SALES-AMOUNT                               10250005
102600                                   TO PV-AMOUNT-FORMATTED         10260005
102700         MOVE PV-AMOUNT-FORMATTED  TO HL6-SALES-TOTAL             10270005
102800     ELSE                                                         10280005
102900         MOVE SPACE                TO HL6-SALES-TOTAL             10290005
103000     END-IF.                                                      10300005
103100                                                                  10310005
103200     ADD  PA-STORE-SALES-AMOUNT    TO PA-COMPANY-SALES-AMOUNT.    10320005
103300                                                                  10330005
103400     IF PA-STORE-RETURN-AMOUNT     < ZERO                         10340005
103500         MOVE PA-STORE-RETURN-AMOUNT                              10350005
103600                                   TO PV-AMOUNT-FORMATTED         10360005
103700         MOVE PV-AMOUNT-FORMATTED  TO HL6-RETURN-TOTAL            10370005
103800     ELSE                                                         10380005
103900         MOVE SPACE                TO HL6-RETURN-TOTAL            10390005
104000     END-IF.                                                      10400005
104100                                                                  10410005
104200     ADD PA-STORE-RETURN-AMOUNT    TO PA-COMPANY-RETURN-AMOUNT.   10420005
104300     COMPUTE PV-AMOUNT             = PA-STORE-RETURN-AMOUNT       10430005
104400                                   + PA-STORE-SALES-AMOUNT.       10440005
104500     MOVE PV-AMOUNT                TO PV-AMOUNT-FORMATTED.        10450005
104600     MOVE PV-AMOUNT-FORMATTED      TO HL6-NET-AMOUNT.             10460005
104700     MOVE +2                       TO PV-LINE-SPACING.            10470005
104800     MOVE HL6-HEADING-LINE-6       TO PV-PRINT-RECORD.            10480005
104900     PERFORM 8200-WRITE-REPORT-LINE.                              10490005
105000                                                                  10500005
105100******************************************************************10510005
105200* 8000-PRINT-HEADINGS                                             10520005
105300*     PRINT THE HEADINGS FOR THE REPORT.                          10530005
105400******************************************************************10540005
105500 8000-PRINT-HEADINGS.                                             10550005
105600                                                                  10560005
105700     ADD +1                        TO PV-PAGE-CNT.                10570005
105800     MOVE PV-PAGE-CNT TO DP132-PAGE-NUMBER.                       10580005
105900     MOVE DP132-STANDRD-HEADER-132-COLS                           10590005
106000                                   TO PV-PRINT-RECORD.            10600005
106100     PERFORM 8100-WRITE-RPT-TOP-OF-PAGE.                          10610005
106200                                                                  10620005
106300     MOVE HL2-HEADING-LINE-2       TO PV-PRINT-RECORD.            10630005
106400     MOVE +1                       TO PV-LINE-SPACING.            10640005
106500     PERFORM 8200-WRITE-REPORT-LINE.                              10650005
106600                                                                  10660005
106700     MOVE +2                       TO PV-LINE-SPACING.            10670005
106800     MOVE HL4-HEADING-LINE-4       TO PV-PRINT-RECORD.            10680005
106900     PERFORM 8200-WRITE-REPORT-LINE.                              10690005
107000                                                                  10700005
107100     MOVE +1                       TO PV-LINE-SPACING.            10710005
107200     MOVE HL5-HEADING-LINE-5       TO PV-PRINT-RECORD.            10720005
107300     PERFORM 8200-WRITE-REPORT-LINE.                              10730005
107400     MOVE +2                       TO PV-LINE-SPACING.            10740005
107500                                                                  10750005
107600 EJECT                                                            10760005
107700                                                                  10770005
107800******************************************************************10780005
107900* 8100-WRITE-RPT-TOP-OF-PAGE                                      10790005
108000*     WRITE FIRST REPORT LINE AFTER PAGE BREAK.                   10800005
108100******************************************************************10810005
108200 8100-WRITE-RPT-TOP-OF-PAGE.                                      10820005
108300                                                                  10830005
108400     WRITE BANKCARD-REPORT-RECORD                                 10840005
108500       FROM PV-PRINT-RECORD                                       10850005
108600         AFTER ADVANCING PAGE.                                    10860005
108700     MOVE +1                       TO PV-LINE-CNT.                10870005
108800 EJECT                                                            10880005
108900                                                                  10890005
109000******************************************************************10900005
109100* 8200-WRITE-REPORT-LINE                                          10910005
109200*     WRITE REPORT LINE AFTER ADVANCING LINE SPACING.             10920005
109300******************************************************************10930005
109400 8200-WRITE-REPORT-LINE.                                          10940005
109500                                                                  10950005
109600     WRITE BANKCARD-REPORT-RECORD                                 10960005
109700       FROM PV-PRINT-RECORD                                       10970005
109800         AFTER ADVANCING PV-LINE-SPACING.                         10980005
109900                                                                  10990005
110000     ADD PV-LINE-SPACING TO PV-LINE-CNT.                          11000005
110100 EJECT                                                            11010005
110200                                                                  11020005
110300******************************************************************11030005
110400* 9100-SQL-ABEND                                                  11040005
110500*     ABEND PROGRAM WHEN AN SQL ERROR CODE OR WARNING CODE OCCURS.11050005
110600******************************************************************11060005
110700 9100-SQL-ABEND.                                                  11070005
110800     DISPLAY '** ABEND     **'.                                   11080005
110900     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        11090005
111000     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              11100005
111100     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               11110005
111200                                                                  11120005
111300******************************************************************11130005
111400* COPY BOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED     11140005
111500* TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS.      11150005
111600******************************************************************11160005
111700     COPY DPPD004.                                                11170005
111800                                                                  11180005
111900     SET AC-DB2-ERROR TO TRUE.                                    11190005
112000     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         11200005
112100                                                                  11210005
112200******************************************************************11220005
112300* 9999-ABEND                                                      11230005
112400*     ABEND PROGRAM WHEN A NON-DB2 ERROR OCCURS.                  11240005
112500******************************************************************11250005
112600 9999-ABEND.                                                      11260005
112700     DISPLAY '** ABEND           **'.                             11270005
112800     DISPLAY '** PROGRAM         ** = ' PC-CURRENT-PROGRAM-NAME.  11280005
112900     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        11290005
113000     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       11300005
113100     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       11310005
113200     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         11320005
