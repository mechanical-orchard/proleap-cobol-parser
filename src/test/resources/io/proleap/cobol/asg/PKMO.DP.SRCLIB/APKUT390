000100*------------------------*                                        00010065
000200 IDENTIFICATION DIVISION.                                         00020065
000300*------------------------*                                        00030065
000400 PROGRAM-ID.     APKUT390.                                        00040068
000500 AUTHOR.         SRINATH JAYARAMAN.                               00050065
000600 DATE-WRITTEN.   AUGUST 2018.                                     00060069
000700*----------------------------------------------------------------*00070065
000800*                  FISCAL DATE CONTROL CARD CREATION             *00080065
000900*----------------------------------------------------------------*00090065
001000*                  COBOL II                                      *00100065
001100*----------------------------------------------------------------*00110065
001200*                                                                *00120065
001300*   THIS PROGRAM RUNS ON THE SECOND SUNDAY OF EVERY FISCAL       *00130065
001400*   MONTH. IT USES THE PREVIOUS FISCAL WEEK END DATE TO          *00140065
001500*   DETERMINE THE START AND END DATES OF THE PREVIOUS FISCAL     *00150065
001600*   MONTH. PREVIOUS FISCAL WEEK END DATE = LAST WEEK OF PREVIOUS *00160065
001600*   FISCAL MONTH.                                                *00170065
001700*----------------------------------------------------------------*00180065
003200* CHANGE LOG:                                                    *00190065
003700*                                                                *00200065
004240*---------------------------------------------------------------* 00210065
004300                                                                  00220065
004400*---------------------*                                           00230065
004500 ENVIRONMENT DIVISION.                                            00240065
004600*---------------------*                                           00250065
004700 CONFIGURATION SECTION.                                           00260065
004800 SOURCE-COMPUTER.    IBM-3090.                                    00270065
004900 OBJECT-COMPUTER.    IBM-3090.                                    00280065
005000                                                                  00290065
005100 INPUT-OUTPUT SECTION.                                            00300065
005200 FILE-CONTROL.                                                    00310065
005300                                                                  00320065
005400     SELECT FISCAL-DATE-CC          ASSIGN TO OUT01.              00330065
005500                                                                  00340065
005600*--------------*                                                  00350065
005700 DATA DIVISION.                                                   00360065
005800*--------------*                                                  00370065
005900 FILE SECTION.                                                    00380065
006000                                                                  00390065
006100 FD  FISCAL-DATE-CC                                               00400065
006200     RECORDING MODE IS F                                          00410065
006300     LABEL RECORDS ARE STANDARD                                   00420065
006400     BLOCK CONTAINS 0 RECORDS                                     00430065
006500     DATA RECORD IS FISCAL-DATE-REC.                              00440065
006600 01  FISCAL-DATE-REC           PIC  X(80).                        00450065
006700                                                                  00460065
006800 EJECT                                                            00470065
006900                                                                  00480065
007000 WORKING-STORAGE SECTION.                                         00490065
007100                                                                  00500065
007200 01  FILLER                      PIC  X(27)     VALUE             00510065
007300     '** START OF APKUT390 W/S **'.                               00520068
007400                                                                  00530065
007500 01  PROGRAM-CONSTANTS.                                           00540065
007600     05  PC-PROGRAM-NAME         PIC  X(08)    VALUE 'APKUT390'.  00550068
007700                                                                  00560065
018200******************************************************************00570065
018300*   THIS IS THE RECORD LAYOUT FOR THE EMAIL FILE - LRECL = 80    *00580065
018400******************************************************************00590065
018500 01  WS-FISCAL-RECORD.                                            00600065
018600     05  FISCAL-MONTH-START          PIC X(10).                   00610065
018700     05  FILLER                      PIC X(01).                   00620065
018800     05  FISCAL-MONTH-END            PIC X(10).                   00630065
018900     05  FILLER                      PIC X(59).                   00640065
009200 EJECT                                                            00650065
009300                                                                  00660065
010598     EXEC SQL BEGIN DECLARE SECTION END-EXEC.                     00670065
010599                                                                  00680065
014100*----------------------------------------------------------------*00690065
014200*    MERCHANDISE LEDGER - DATE RECORD TABLE                       00700065
014300*----------------------------------------------------------------*00710065
014400     EXEC SQL                                                     00720065
014500         INCLUDE TDTATTR                                          00730065
014600     END-EXEC.                                                    00740065
014700                                                                  00750065
014800*----------------------------------------------------------------*00760065
014900*    AP-PAYMENT CONTROL TABLE                                     00770065
015000*----------------------------------------------------------------*00780065
015100     EXEC SQL                                                     00790065
015200         INCLUDE TAPCNTL                                          00800065
015300     END-EXEC.                                                    00810065
015300                                                                  00820065
010300*    SQL COMMUNICATIONS AREA DCLGEN                               00830065
010400*                                                                 00840065
010500     EXEC SQL                                                     00850065
010600         INCLUDE SQLCA                                            00860065
010700     END-EXEC.                                                    00870065
010700                                                                  00880065
015497     EXEC SQL END DECLARE SECTION END-EXEC.                       00890065
019300*----------------------------------------------------------------*00900065
019400*    ABEND DATA AREAS                                             00910065
019500*----------------------------------------------------------------*00920065
023800*----------------------------------------------------------------*00930065
023900*    SQLCA FORMATTED MESSAGE AREA                                 00940065
024000*----------------------------------------------------------------*00950065
011200 01  ABEND-CODE                  PIC S9(04)  VALUE ZEROS          00960065
011300                                             COMP SYNC.           00970065
011400     88  AC-BAD-DATA                         VALUE +4003.         00980065
011500     88  AC-DB2-ERROR                        VALUE +4013.         00990065
011600     88  AC-DATE-ERROR                       VALUE +4019.         01000065
011700                                                                  01010065
011900 01  ABEND-AREAS.                                                 01020065
012000     05  AA-ABEND-LIT            PIC  X(40)  VALUE                01030065
012100             '*****       ABEND'.                                 01040065
012200     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                01050065
012300             '*****   PROGRAM: APKUT390'.                         01060068
012400     05  AA-PARAGRAPH-LIT.                                        01070065
012500         10  FILLER              PIC  X(17)  VALUE                01080065
012600             '***** PARAGRAPH: '.                                 01090065
012700         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        01100065
012800     05  AA-MESSAGE-LINE.                                         01110065
012900         10  FILLER              PIC  X(06)  VALUE '*****'.       01120065
013000         10  AA-MESSAGE          PIC  X(127) VALUE SPACES.        01130065
013100     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                01140065
013200             '*****    DB2 ERROR'.                                01150065
013300     05  AA-DB2-OPERATION-LIT.                                    01160065
013400         10  FILLER              PIC  X(17)  VALUE                01170065
013500             '***** OPERATION: '.                                 01180065
013600         10  AA-DB2-OPERATION.                                    01190065
013700             15  AA-DB2-OP-1     PIC  X(50)  VALUE SPACES.        01200065
013800             15  AA-DB2-OP-2     PIC  X(25)  VALUE SPACES.        01210065
013900     05  AA-DB2-TABLE-1          PIC  X(08)  VALUE SPACES.        01220065
014000     05  AA-DB2-TABLE-2          PIC  X(08)  VALUE SPACES.        01230065
014100     05  AA-DB2-TABLE-3          PIC  X(08)  VALUE SPACES.        01240065
014200                                                                  01250065
024100     COPY DPWS004.                                                01260065
024200                                                                  01270065
024300 01  FILLER                      PIC  X(25)     VALUE             01280065
024400     '** END OF APKUT390 W/S **'.                                 01290068
024500                                                                  01300065
024600*-------------------*                                             01310065
024700 PROCEDURE DIVISION.                                              01320065
024800*-------------------*                                             01330065
024900 A100-MAINLINE.                                                   01340065
025500                                                                  01350065
025100     PERFORM B100-INITIALIZE.                                     01360065
025500                                                                  01370065
028301     PERFORM B200-PROCESSING.                                     01380065
025500                                                                  01390065
025600     PERFORM B300-END-OF-PROGRAM.                                 01400065
026000                                                                  01410065
025800     GOBACK.                                                      01420065
026100*----------------------------------------------------------------*01430065
026200*    INITIALIZATION PROCESSING                                    01440065
026700*----------------------------------------------------------------*01450065
026800 B100-INITIALIZE.                                                 01460065
026900                                                                  01470065
027000     DISPLAY '**------ APKUT390 BEGINS ------**'.                 01480068
027100                                                                  01490065
027200     OPEN OUTPUT FISCAL-DATE-CC.                                  01500065
027300                                                                  01510065
027400     INITIALIZE DCLTAPCNTL                                        01520065
027900                DCLTDTATTR.                                       01530065
026100*----------------------------------------------------------------*01540065
026200*    MAIN PROCESSING PARAGRAPH                                    01550065
026700*----------------------------------------------------------------*01560065
026800 B200-PROCESSING.                                                 01570065
028200                                                                  01580065
028301     PERFORM S100-GET-FISCAL-DATES.                               01590065
028200                                                                  01600065
028301     PERFORM W100-WRITE-CC-DATA.                                  01610065
028200                                                                  01620065
031800*----------------------------------------------------------------*01630065
031900*    END OF PROGRAM                                               01640065
032000*    - CLOSE FILE                                                 01650065
032100*    - DISPLAY COUNTS                                             01660065
032200*----------------------------------------------------------------*01670065
032300 B300-END-OF-PROGRAM.                                             01680065
032400                                                                  01690065
032710     CLOSE FISCAL-DATE-CC.                                        01700065
032800                                                                  01710065
033600     DISPLAY ' '.                                                 01720065
033600     DISPLAY '***********************************************'.   01730066
028400     DISPLAY '** BEGIN FISCAL MONTH: '  DTATTR-FSCL-MN-BEG-DTE.   01750065
028500     DISPLAY '** END FISCAL MONTH: '    DTATTR-FSCL-MN-END-DTE.   01760065
033600     DISPLAY '***********************************************'.   01770066
033600     DISPLAY ' '.                                                 01780067
027000     DISPLAY '**------ APKUT390 ENDS ------**'.                   01781068
033900*----------------------------------------------------------------*01810065
034000*    GET FISCAL MONTH BEGIN AND END DATES                         01820065
034100*----------------------------------------------------------------*01830065
034200 S100-GET-FISCAL-DATES.                                           01840065
034300                                                                  01850065
034400     EXEC SQL                                                     01860065
034500         SELECT  TO_CHAR(B.FSCL_MN_BEG_DTE,'YYYY-MM-DD')          01870065
034600                ,TO_CHAR(B.FSCL_MN_END_DTE,'YYYY-MM-DD')          01880065
034700           INTO  :DTATTR-FSCL-MN-BEG-DTE                          01890065
034800                ,:DTATTR-FSCL-MN-END-DTE                          01900065
034900           FROM  TAPCNTL  A                                       01910065
035000                ,TDTATTR  B                                       01920065
035100          WHERE A.PREV_WK_END_DTE = B.KY_DTE                      01930065
035200     END-EXEC.                                                    01940065
035300                                                                  01950065
035400     EVALUATE TRUE                                                01960065
035600                                                                  01970065
035500         WHEN SQLCODE = ZERO                                      01980065
035600            MOVE DTATTR-FSCL-MN-BEG-DTE TO FISCAL-MONTH-START     01990065
035600            MOVE DTATTR-FSCL-MN-END-DTE TO FISCAL-MONTH-END       02000065
035600         CONTINUE                                                 02010065
035600                                                                  02020065
026700         WHEN SQLWARN0 NOT = SPACES                               02030065
026800         WHEN SQLCODE  NOT = ZERO                                 02040065
026900            MOVE 'S100-GET-FISCAL-DATES '                         02050065
027000                                TO AA-PARAGRAPH-NAME              02060065
027100            MOVE 'UNSUCCESSFUL SELECT OF FISCAL DATES'            02070065
027200                                TO AA-DB2-OPERATION               02080065
027300            MOVE 'TAPCNTL'      TO AA-DB2-TABLE-1                 02090065
027400            MOVE 'TDTATTR'      TO AA-DB2-TABLE-2                 02100065
027500            MOVE SPACES         TO AA-DB2-TABLE-3                 02110065
027600            PERFORM Z998-DB2-ABEND                                02120065
037100     END-EVALUATE.                                                02130065
041200*----------------------------------------------------------------*02140065
041300*    WRITE FISCAL START AND END DATES TO THE CONTROL CARD         02150065
041400*----------------------------------------------------------------*02160065
041500 W100-WRITE-CC-DATA.                                              02170065
041600                                                                  02180065
041700     WRITE FISCAL-DATE-REC FROM WS-FISCAL-RECORD.                 02190065
041800                                                                  02200065
028000***************************************************************** 02210065
028100*  ABEND ROUTINE FOR DB2 ERRORS                                   02220065
028200***************************************************************** 02230065
028300 Z998-DB2-ABEND.                                                  02240065
028400                                                                  02250065
032710     CLOSE FISCAL-DATE-CC.                                        02260065
028400                                                                  02270065
029200     DISPLAY AA-ABEND-LIT.                                        02280065
029300     DISPLAY AA-DB2-ERROR-LIT.                                    02290065
029400     DISPLAY AA-PROGRAM-LIT.                                      02300065
029500     DISPLAY AA-PARAGRAPH-LIT.                                    02310065
029600     DISPLAY AA-DB2-OPERATION-LIT.                                02320065
029700     DISPLAY AA-DB2-TABLE-1.                                      02330065
029800     DISPLAY AA-DB2-TABLE-2.                                      02340065
029900     DISPLAY AA-DB2-TABLE-3.                                      02350065
030000     SET AC-DB2-ERROR TO TRUE.                                    02360065
030100                                                                  02370065
030200     COPY DPPD004.                                                02380065
030300                                                                  02390065
030400     CALL 'ILBOABN0' USING ABEND-CODE.                            02400065
