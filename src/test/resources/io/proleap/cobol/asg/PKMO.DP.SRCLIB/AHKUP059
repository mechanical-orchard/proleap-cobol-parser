000100 IDENTIFICATION DIVISION.                                         00010010
000200 PROGRAM-ID.         AHKUP059.                                    00020010
000300 AUTHOR.             CINDY HANSEN.                                00030010
000400 DATE-WRITTEN.       OCTOBER 15, 2001.                            00040010
000500 DATE-COMPILED.                                                   00050010
000600*************************************************************     00060010
000700*    COBOL 2 WITH SQL                                       *     00070010
000800*                                                           *     00080010
000900*   AHKUP059 - ARCHIVE HISTORY DATA DELETION - TIMPORL      *     00090010
001000*                                                           *     00100010
001100*   PROGRAM OVERVIEW:                                       *     00110010
001200*                                                           *     00120010
001300*  THIS PROGRAM DELETES "OLD" ROWS FROM DB2 TABLE TIMPORL.  *     00130010
001400*  ROWS DELETED ARE THOSE PREVIOUSLY - IDENTIFIED/EXTRACTED *     00140010
001500*  WITHIN THE ARCHIVE/HISTORY SYSTEM.                       *     00150010
001600*                                                           *     00160010
001700*  THE EXTRACT FILE USED AS INPUT WILL BE SORTED BY THE     *     00170010
001800*  UNIQUE INDEX COLUMNS TO SPEED THE DELETION PROCESS.      *     00180010
001900*  THESE COLUMNS ARE PO_NBR, VER_NBR, VER_STATUS_CDE.       *     00190010
002000*                                                           *     00200010
002100*   INPUT:                                                  *     00210010
002200*                                                           *     00220010
002300*     1. TIMPORL DELETION FILE  COPYBOOK DCLTIMPORL         *     00230010
002400*                                                           *     00240010
002500*   DB2 TABLES:                                             *     00250010
002600*                                                           *     00260010
002700*        TIMPORL - PURCHASE ORDER IMPORT RELEASE TABLE      *     00270010
002800*        TCKRSTIN - CHECKPOINT/RESTART INFO TABLE           *     00280010
002900*        TCKRSTCN - CHECKPOINT/RESTART CONTROL TABLE        *     00290010
003000*                                                           *     00300010
003100*************************************************************     00310010
P5207 * DATE: 11/18/2013 CHANGE MADE BY: COGNIZANT(SHEBENA)       *     00320017
P5207 * CHANGE MADE: MODIFIED THE PROGRAM TO REMOVE THE           *     00321017
P5207 *              PO_IN_RMS_IND CHECK BEFORE DELETE.           *     00322017
P5207 * CHANGE TAG - P5207, CR NO - CHG0081355                    *     00323018
003300*************************************************************     00330010
003400 EJECT                                                            00340010
003500 ENVIRONMENT DIVISION.                                            00350010
003600 CONFIGURATION SECTION.                                           00360010
003700 SOURCE-COMPUTER.        IBM-370.                                 00370010
003800 OBJECT-COMPUTER.        IBM-370.                                 00380010
003900                                                                  00390010
004000 INPUT-OUTPUT SECTION.                                            00400010
004100 FILE-CONTROL.                                                    00410010
004200     SELECT TIMPORL-EXTRACT-FILE ASSIGN TO INP01.                 00420010
004300                                                                  00430010
004400 DATA DIVISION.                                                   00440010
004500 FILE SECTION.                                                    00450010
004600 FD  TIMPORL-EXTRACT-FILE                                         00460010
004700     RECORDING MODE IS F                                          00470010
004800     LABEL RECORDS ARE STANDARD                                   00480010
004900     BLOCK CONTAINS 0 RECORDS                                     00490010
005000     RECORD CONTAINS 159 CHARACTERS                               00500010
005100     DATA RECORD IS TIMPORL-EXTRACT-DATA.                         00510010
005200 01  TIMPORL-EXTRACT-DATA       PIC X(159).                       00520010
005300                                                                  00530010
005400                                                                  00540010
005500 EJECT                                                            00550010
005600 WORKING-STORAGE SECTION.                                         00560010
005700                                                                  00570010
005800 01  FILLER                       PIC X(58)     VALUE             00580010
005900     '************WORKING STORAGE STARTS HERE*******************'.00590010
006000                                                                  00600010
006100 01  PV-PROGRAM-VARIABLES.                                        00610010
006200     05  PV-PROGRAM-NAME          PIC  X(08)    VALUE 'AHKUP059'. 00620010
006300     05  PV-CKPT-STAT-CODE        PIC X(01)     VALUE SPACE.      00630010
006400     05  PV-CURRENT-PARAGRAPH     PIC X(50)     VALUE SPACES.     00640010
006500     05  PV-CURRENT-TMST          PIC X(26)     VALUE SPACES.     00650010
006600                                                                  00660010
006700     05  PV-TIMPORL-INPUT-COUNT   PIC 9(09)     VALUE ZERO        00670010
006800                                                COMP-3.           00680010
006900     05  PV-TIMPORL-DELETE-COUNT  PIC 9(09)     VALUE ZERO        00690010
007000                                                COMP-3.           00700010
007100     05  PV-SQL-DELETE-COUNT      PIC 9(09)     VALUE ZERO        00710010
007200                                                COMP-3.           00720010
007300     05  PV-SQLERRD3              PIC S9(09)    VALUE ZERO        00730010
007400                                                COMP-3.           00740010
007500     05  PV-DISP-PO-NBR           PIC X(09)    VALUE SPACES.      00750010
007600     05  PV-DISP-VER-NBR          PIC X(09)    VALUE SPACES.      00760010
007700     05  PV-DISP-VER-STATUS-CDE   PIC X(01)    VALUE SPACES.      00770010
007900     05  PV-SAVE-PO-NBR           PIC S9(09) COMP                 00790010
008000                                               VALUE ZEROES.      00800010
008100 01  PC-PROGRAM-CONSTANTS.                                        00810010
008200     05  PC-RETRY-MAX             PIC S9(04)    VALUE +3          00820010
008300                                                COMP SYNC.        00830010
008400     05  PC-RETRY-COUNT           PIC S9(04)    VALUE ZEROS.      00840010
008500     05  PC-IN-PROCESS-CODE       PIC X(01)     VALUE '9'.        00850010
008600     05  PC-RUN-COMPLETE-CODE     PIC X(01)     VALUE '0'.        00860010
008700                                                                  00870010
008800 01  PS-PROGRAM-SWITCHES.                                         00880010
008900     05  PS-COMMITS-TAKEN-SW      PIC  X(01)    VALUE 'N'.        00890010
009000         88  COMMITS-TAKEN                      VALUE 'T'.        00900010
009100         88  NO-COMMITS-TAKEN                   VALUE 'N'.        00910010
009200     05  PS-END-EXTRACT-SW        PIC  X(01)    VALUE 'M'.        00920010
009300         88  MORE-EXTRACT                       VALUE 'M'.        00930010
009400         88  END-OF-EXTRACT                     VALUE 'E'.        00940010
009500     05  PS-RUN-TYPE-SW           PIC  X(01)    VALUE ' '.        00950010
009600         88  NORMAL-RUN                         VALUE '0'.        00960010
009700         88  RESTART-RUN                        VALUE '9'.        00970010
010100                                                                  01010010
010200 01  WS-COUNTER.                                                  01020010
010300     05  WS-HOLD-TMST             PIC X(26)     VALUE SPACES.     01030010
010400     05  WS-TMST                  PIC X(26)     VALUE SPACES.     01040010
010500                                                                  01050010
010600 01  CKPT-RESTART-INFO.                                           01060010
010700     05  CR-EXTRACT-RECS-WORKED   PIC  9(9)     VALUE ZERO.       01070010
010800                                                                  01080010
010900*----------------------------------------------------------------*01090010
011000*  ABEND DATA AREAS                                              *01100010
011100*----------------------------------------------------------------*01110010
011200 01  ABEND-CODE                  PIC S9(04)  VALUE ZEROS          01120010
011300                                             COMP SYNC.           01130010
011400     88  AC-BAD-RECEIVE-DATA                 VALUE +4001.         01140010
011500     88  AC-BAD-DATA                         VALUE +4008.         01150010
011600     88  AC-DB2-ERROR                        VALUE +4013.         01160010
011700     88  AC-DATE-ERROR                       VALUE +4019.         01170010
011800                                                                  01180010
011900                                                                  01190010
012000 01  ABEND-AREAS.                                                 01200010
012100     05  AA-ABEND-LIT            PIC  X(40)  VALUE                01210010
012200             '*****       ABEND'.                                 01220010
012300     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                01230010
012400             '*****   PROGRAM: AHKUP059'.                         01240010
012500     05  AA-PARAGRAPH-LIT.                                        01250010
012600         10  FILLER              PIC  X(17)  VALUE                01260010
012700             '***** PARAGRAPH: '.                                 01270010
012800         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        01280010
012900     05  AA-MESSAGE-LINE-1.                                       01290010
013000         10  FILLER              PIC  X(06)  VALUE '*****'.       01300010
013100         10  AA-MESSAGE-1        PIC  X(127) VALUE SPACES.        01310010
013200     05  AA-MESSAGE-LINE-2.                                       01320010
013300         10  FILLER              PIC  X(06)  VALUE '*****'.       01330010
013400         10  AA-MESSAGE-2        PIC  X(127) VALUE SPACES.        01340010
013500     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                01350010
013600             '*****    DB2 ERROR'.                                01360010
013700     05  AA-DB2-OPERATION-LIT.                                    01370010
013800         10  FILLER              PIC  X(17)  VALUE                01380010
013900             '***** OPERATION: '.                                 01390010
014000         10  AA-DB2-OPERATION    PIC  X(50)  VALUE SPACES.        01400010
014100     05  AA-DB2-TABLE            PIC  X(08)  VALUE SPACES.        01410010
014200     EJECT                                                        01420010
014300                                                                  01430010
014400     COPY DPWS004.                                                01440010
014500     EJECT                                                        01450010
014600*----------------------------------------------------------------*01460010
014700*      TIMPORL TABLE LAYOUT                                       01470010
014800*----------------------------------------------------------------*01480010
014900         EXEC SQL                                                 01490010
015000             INCLUDE TIMPORL                                      01500010
015100         END-EXEC.                                                01510010
015200                                                                  01520010
015300*----------------------------------------------------------------*01530010
015400*      TPURCHS TABLE LAYOUT                                       01540010
015500*----------------------------------------------------------------*01550010
015600         EXEC SQL                                                 01560010
015700             INCLUDE TPURCHS                                      01570010
015800         END-EXEC.                                                01580010
015900                                                                  01590010
016000*----------------------------------------------------------------*01600010
016100*      TCKRSTCNTL TABLE LAYOUT                                    01610010
016200*----------------------------------------------------------------*01620010
016300         EXEC SQL                                                 01630010
016400             INCLUDE TCKRSTCN                                     01640010
016500         END-EXEC.                                                01650010
016600                                                                  01660010
016700*----------------------------------------------------------------*01670010
016800*      TCKRSTINF TABLE LAYOUT                                     01680010
016900*----------------------------------------------------------------*01690010
017000         EXEC SQL                                                 01700010
017100             INCLUDE TCKRSTIN                                     01710010
017200         END-EXEC.                                                01720010
017300 EJECT                                                            01730010
017400*----------------------------------------------------------------*01740010
017500*  DB2 COMMUNICATION AREA                                         01750010
017600*----------------------------------------------------------------*01760010
017700*                                                                 01770010
017800     EXEC SQL                                                     01780010
017900         INCLUDE SQLCA                                            01790010
018000     END-EXEC.                                                    01800010
018100                                                                  01810010
018200*----------------------------------------------------------------*01820010
018300*  DB2 COMMUNICATION AREA2                                        01830010
018400*----------------------------------------------------------------*01840010
018500*                                                                 01850010
018600     COPY SQLCA2.                                                 01860010
018700     EJECT                                                        01870010
018800 PROCEDURE DIVISION.                                              01880010
018900 A100-MAINLINE-ROUTINE.                                           01890010
019000                                                                  01900010
019100     PERFORM B100-INITIALIZATION.                                 01910010
019200                                                                  01920010
019300     PERFORM B200-TIMPORL-EXTRACT-PROCESS                         01930010
019400       UNTIL END-OF-EXTRACT.                                      01940010
019500                                                                  01950010
019600     PERFORM B300-EOJ-PROCESSING.                                 01960010
019700                                                                  01970010
019800     GOBACK.                                                      01980010
019900 EJECT                                                            01990010
020000 B100-INITIALIZATION.                                             02000010
020100                                                                  02010010
020200     EXEC SQL                                                     02020010
020300         SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                 02030010
020400     END-EXEC.                                                    02040010
020500                                                                  02050010
020600     PERFORM X300-GET-CHECKPOINT-CNTL.                            02060010
020700     MOVE PV-CKPT-STAT-CODE TO PS-RUN-TYPE-SW.                    02070010
020800                                                                  02080010
020900     OPEN INPUT TIMPORL-EXTRACT-FILE.                             02090010
021000                                                                  02100010
021100     IF RESTART-RUN                                               02110010
021200         PERFORM X200-CHECKPOINT-RESTART                          02120010
021300     ELSE                                                         02130010
021400         PERFORM R100-READ-EXTRACT-FILE                           02140010
021500     END-IF.                                                      02150010
021600                                                                  02160010
021700     PERFORM X500-SET-CHECKPOINT-TIME.                            02170010
021800                                                                  02180010
021900                                                                  02190010
022000     EJECT                                                        02200010
022100 B200-TIMPORL-EXTRACT-PROCESS.                                    02210010
022200                                                                  02220010
022300     MOVE IMPORL-PO-NBR             TO PV-DISP-PO-NBR.            02230010
022400     MOVE IMPORL-VER-NBR            TO PV-DISP-VER-NBR.           02240010
022500     MOVE IMPORL-VER-STATUS-CDE     TO PV-DISP-VER-STATUS-CDE.    02250010
022600     IF IMPORL-PO-NBR NOT = PV-SAVE-PO-NBR                        02260010
022700         MOVE IMPORL-PO-NBR TO PV-SAVE-PO-NBR                     02270010
022900     END-IF.                                                      02290010
023000                                                                  02300010
023200     PERFORM D100-DELETE-TIMPORL                                  02320016
023400                                                                  02340010
023500     PERFORM X100-CHECKPOINT-CHECK.                               02350010
023600                                                                  02360010
023700     PERFORM R100-READ-EXTRACT-FILE.                              02370010
023800     EJECT                                                        02380010
023900                                                                  02390010
024000                                                                  02400010
024100 B300-EOJ-PROCESSING.                                             02410010
024200                                                                  02420010
024300     DISPLAY '** AHKUP059 SUMMARY **'.                            02430010
024400     DISPLAY '** TIMPORL INPUT COUNT = ' PV-TIMPORL-INPUT-COUNT.  02440010
024500     DISPLAY '** TIMPORL DELETE COUNT = ' PV-TIMPORL-DELETE-COUNT.02450010
024600     DISPLAY '** SQL DELETE COUNT = ' PV-SQL-DELETE-COUNT.        02460010
024700                                                                  02470010
024800     CLOSE  TIMPORL-EXTRACT-FILE.                                 02480010
024900                                                                  02490010
025000     MOVE PC-RUN-COMPLETE-CODE TO PV-CKPT-STAT-CODE.              02500010
025100     PERFORM X600-UPDATE-TCKRSTCNTL.                              02510010
025200                                                                  02520010
025300     EJECT                                                        02530010
032500*                                                                 03250011
032600*----------------------------------------------------------------*03260010
032700*    DELETES FROM THE TIMPORL TABLE.                             *03270010
032800*----------------------------------------------------------------*03280010
032900 D100-DELETE-TIMPORL.                                             03290010
033000                                                                  03300010
033100     MOVE 'D100-DELETE-TIMPORL' TO PV-CURRENT-PARAGRAPH.          03310010
033200                                                                  03320010
033300     PERFORM WITH TEST AFTER                                      03330010
033400        VARYING PC-RETRY-COUNT FROM 1 BY 1                        03340010
033500          UNTIL PC-RETRY-COUNT > PC-RETRY-MAX                     03350010
033600             OR SQLCODE = ZERO                                    03360010
033700                                                                  03370010
033800         EXEC SQL                                                 03380010
033900              DELETE                                              03390010
034000                FROM TIMPORL                                      03400010
034100               WHERE PO_NBR         = :IMPORL-PO-NBR              03410010
034200                 AND VER_NBR        = :IMPORL-VER-NBR             03420010
034300                 AND VER_STATUS_CDE = :IMPORL-VER-STATUS-CDE      03430010
034400         END-EXEC                                                 03440010
034500                                                                  03450010
034600         EVALUATE TRUE                                            03460010
034700             WHEN SQLCODE = ZERO                                  03470010
034800                 ADD 1 TO PV-TIMPORL-DELETE-COUNT                 03480010
034900                 MOVE SQLERRD(3) TO PV-SQLERRD3                   03490010
035000                 ADD PV-SQLERRD3 TO PV-SQL-DELETE-COUNT           03500010
035100                                                                  03510010
035200             WHEN SQLCODE = -904                                  03520010
035300             WHEN SQLCODE = -913                                  03530010
035400             WHEN SQLCODE = +100                                  03540010
035500                  CONTINUE                                        03550010
035600                                                                  03560010
035700             WHEN SQLWARN0 NOT = SPACES                           03570010
035800             WHEN SQLCODE  NOT = ZERO                             03580010
035900                 MOVE PV-CURRENT-PARAGRAPH                        03590010
036000                                     TO AA-PARAGRAPH-NAME         03600010
036100                 DISPLAY '******** PO NUMBER:'                    03610010
036200                          PV-DISP-PO-NBR                          03620010
036300                 DISPLAY '******** PO VER NBR:'                   03630010
036400                          PV-DISP-VER-NBR                         03640010
036500                 DISPLAY '******** PO VER STATUS CDE:'            03650010
036600                          PV-DISP-VER-STATUS-CDE                  03660010
036700                 MOVE SPACES TO AA-MESSAGE-1                      03670010
036800                                AA-MESSAGE-2                      03680010
036900                 MOVE 'UNSUCCESSFUL DELETE'                       03690010
037000                                     TO AA-DB2-OPERATION          03700010
037100                 MOVE 'TIMPORL'      TO AA-DB2-TABLE              03710010
037200                 PERFORM Z999-DB2-ABEND                           03720010
037300         END-EVALUATE                                             03730010
037400     END-PERFORM.                                                 03740010
037500                                                                  03750010
037600     IF PC-RETRY-COUNT > PC-RETRY-MAX                             03760010
037700         MOVE PV-CURRENT-PARAGRAPH                                03770010
037800                             TO AA-PARAGRAPH-NAME                 03780010
037900         DISPLAY '******** PO NUMBER:'                            03790010
038000                          PV-DISP-PO-NBR                          03800010
038100         DISPLAY '******** PO VER NBR :'                          03810010
038200                          PV-DISP-VER-NBR                         03820010
038300         DISPLAY '******** PO VER STATUS CDE:'                    03830010
038400                          PV-DISP-VER-STATUS-CDE                  03840010
038500         MOVE SPACES TO AA-MESSAGE-1                              03850010
038600                        AA-MESSAGE-2                              03860010
038700         MOVE 'MAX RETRIES EXCEEDED ON DELETE'                    03870010
038800                             TO AA-DB2-OPERATION                  03880010
038900         MOVE 'TIMPORL'      TO AA-DB2-TABLE                      03890010
039000         PERFORM Z999-DB2-ABEND                                   03900010
039100     END-IF.                                                      03910010
039200                                                                  03920010
039300     EJECT                                                        03930010
039400 R100-READ-EXTRACT-FILE.                                          03940010
039500                                                                  03950010
039600     READ TIMPORL-EXTRACT-FILE                                    03960010
039700          INTO DCLTIMPORL                                         03970010
039800          AT END SET END-OF-EXTRACT TO TRUE.                      03980010
039900                                                                  03990010
040000     IF MORE-EXTRACT                                              04000010
040100         ADD 1 TO PV-TIMPORL-INPUT-COUNT                          04010010
040200     END-IF.                                                      04020010
040300                                                                  04030010
040400                                                                  04040010
040500     EJECT                                                        04050010
040600*----------------------------------------------------------------*04060010
040700*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *04070010
040800*----------------------------------------------------------------*04080010
040900 X100-CHECKPOINT-CHECK.                                           04090010
041000                                                                  04100010
041100     MOVE 'X100-CHECKPOINT-CHECK' TO PV-CURRENT-PARAGRAPH.        04110010
041200                                                                  04120010
041300     EXEC SQL                                                     04130010
041400       SET :WS-TMST = CURRENT TIMESTAMP                           04140010
041500     END-EXEC.                                                    04150010
041600                                                                  04160010
041700     IF SQLCODE = +0                                              04170010
041800         CONTINUE                                                 04180010
041900     ELSE                                                         04190010
042000         MOVE PV-CURRENT-PARAGRAPH                                04200010
042100                             TO AA-PARAGRAPH-NAME                 04210010
042200         MOVE SPACES TO AA-MESSAGE-1                              04220010
042300                        AA-MESSAGE-2                              04230010
042400         MOVE 'BAD SET COMMAND'                                   04240010
042500                             TO AA-DB2-OPERATION                  04250010
042600         MOVE SPACES             TO AA-DB2-TABLE                  04260010
042700         PERFORM Z999-DB2-ABEND                                   04270010
042800     END-IF.                                                      04280010
042900                                                                  04290010
043000     IF WS-TMST > WS-HOLD-TMST                                    04300010
043100         IF NO-COMMITS-TAKEN                                      04310010
043200             MOVE PC-IN-PROCESS-CODE TO PV-CKPT-STAT-CODE         04320010
043300             PERFORM X600-UPDATE-TCKRSTCNTL                       04330010
043400             SET COMMITS-TAKEN TO TRUE                            04340010
043500         END-IF                                                   04350010
043600         PERFORM X700-UPDATE-TCKRSTINF                            04360010
043700         PERFORM Y100-COMMIT                                      04370010
043800         PERFORM X500-SET-CHECKPOINT-TIME                         04380010
043900     END-IF.                                                      04390010
044000                                                                  04400010
044100 EJECT                                                            04410010
044200*----------------------------------------------------------------*04420010
044300*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *04430010
044400*----------------------------------------------------------------*04440010
044500 X200-CHECKPOINT-RESTART.                                         04450010
044600                                                                  04460010
044700     MOVE 'X200-CHECKPOINT-RESTART' TO PV-CURRENT-PARAGRAPH.      04470010
044800                                                                  04480010
044900     PERFORM X400-GET-CHECKPOINT-INFO.                            04490010
045000     MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO CKPT-RESTART-INFO.     04500010
045100                                                                  04510010
045200     DISPLAY '** AHKUP059 CHECKPOINT RESTART **'                  04520010
045300     DISPLAY '** EXTRACT RECS BYPASSED ON RESTART = '             04530010
045400              CR-EXTRACT-RECS-WORKED.                             04540010
045500     DISPLAY '***********************************************'    04550010
045600                                                                  04560010
045700     PERFORM R100-READ-EXTRACT-FILE                               04570010
045800         CR-EXTRACT-RECS-WORKED TIMES.                            04580010
045900     PERFORM R100-READ-EXTRACT-FILE.                              04590010
046000 EJECT                                                            04600010
046100*----------------------------------------------------------------*04610010
046200*    SELECT CHECKPOINT RESTART CONTROL INFO.                     *04620010
046300*----------------------------------------------------------------*04630010
046400 X300-GET-CHECKPOINT-CNTL.                                        04640010
046500                                                                  04650010
046600     MOVE 'X300-GET-CHECKPOINT-CNTL' TO PV-CURRENT-PARAGRAPH.     04660010
046700                                                                  04670010
046800     PERFORM WITH TEST AFTER                                      04680010
046900             VARYING PC-RETRY-COUNT FROM 1 BY 1                   04690010
047000             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             04700010
047100                     SQLCODE = ZERO                               04710010
047200                                                                  04720010
047300             EXEC SQL                                             04730010
047400              SELECT CKPT_STAT_CODE                               04740010
047500               INTO :PV-CKPT-STAT-CODE                            04750010
047600               FROM TCKRSTCNTL                                    04760010
047700               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 04770010
047800             END-EXEC                                             04780010
047900                                                                  04790010
048000             EVALUATE TRUE                                        04800010
048100                 WHEN SQLCODE = ZERO                              04810010
048200                 WHEN SQLCODE = -904                              04820010
048300                 WHEN SQLCODE = -913                              04830010
048400                      CONTINUE                                    04840010
048500                                                                  04850010
048600                 WHEN SQLWARN0 NOT = SPACES                       04860010
048700                 WHEN SQLCODE  NOT = ZERO                         04870010
048800                     MOVE PV-CURRENT-PARAGRAPH                    04880010
048900                                         TO AA-PARAGRAPH-NAME     04890010
049000                     DISPLAY '******** PLAN_NAME:'                04900010
049100                              PV-PROGRAM-NAME                     04910010
049200                     MOVE SPACES TO AA-MESSAGE-1                  04920010
049300                                    AA-MESSAGE-2                  04930010
049400                     MOVE 'UNSUCCESSFUL SELECT'                   04940010
049500                                         TO AA-DB2-OPERATION      04950010
049600                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          04960010
049700                     PERFORM Z999-DB2-ABEND                       04970010
049800             END-EVALUATE                                         04980010
049900     END-PERFORM.                                                 04990010
050000                                                                  05000010
050100     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05010010
050200         MOVE PV-CURRENT-PARAGRAPH                                05020010
050300                             TO AA-PARAGRAPH-NAME                 05030010
050400         DISPLAY '******** PLAN_NAME:'                            05040010
050500                  PV-PROGRAM-NAME                                 05050010
050600         MOVE SPACES TO AA-MESSAGE-1                              05060010
050700                        AA-MESSAGE-2                              05070010
050800         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    05080010
050900                             TO AA-DB2-OPERATION                  05090010
051000         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      05100010
051100         PERFORM Z999-DB2-ABEND                                   05110010
051200     END-IF.                                                      05120010
051300                                                                  05130010
051400 EJECT                                                            05140010
051500*----------------------------------------------------------------*05150010
051600*    SELECT CHECKPOINT RESTART WORKING STORAGE DESCRIPTION INFO  *05160010
051700*----------------------------------------------------------------*05170010
051800 X400-GET-CHECKPOINT-INFO.                                        05180010
051900                                                                  05190010
052000     MOVE 'X400-GET-CHECKPOINT-INFO' TO PV-CURRENT-PARAGRAPH.     05200010
052100                                                                  05210010
052200     PERFORM WITH TEST AFTER                                      05220010
052300             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05230010
052400             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05240010
052500                     SQLCODE = ZERO                               05250010
052600                                                                  05260010
052700             EXEC SQL                                             05270010
052800              SELECT WORK_STRG_DESC                               05280010
052900               INTO :TCKRSTINF-WORK-STRG-DESC                     05290010
053000               FROM TCKRSTINF                                     05300010
053100               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 05310010
053200             END-EXEC                                             05320010
053300                                                                  05330010
053400             EVALUATE TRUE                                        05340010
053500                 WHEN SQLCODE = ZERO                              05350010
053600                 WHEN SQLCODE = -904                              05360010
053700                 WHEN SQLCODE = -913                              05370010
053800                      CONTINUE                                    05380010
053900                                                                  05390010
054000                 WHEN SQLWARN0 NOT = SPACES                       05400010
054100                 WHEN SQLCODE  NOT = ZERO                         05410010
054200                     MOVE PV-CURRENT-PARAGRAPH                    05420010
054300                                         TO AA-PARAGRAPH-NAME     05430010
054400                     DISPLAY '******** PLAN_NAME:'                05440010
054500                              PV-PROGRAM-NAME                     05450010
054600                     MOVE SPACES TO AA-MESSAGE-1                  05460010
054700                                    AA-MESSAGE-2                  05470010
054800                     MOVE 'UNSUCCESSFUL SELECT'                   05480010
054900                                         TO AA-DB2-OPERATION      05490010
055000                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          05500010
055100                     PERFORM Z999-DB2-ABEND                       05510010
055200             END-EVALUATE                                         05520010
055300     END-PERFORM.                                                 05530010
055400                                                                  05540010
055500     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05550010
055600         MOVE PV-CURRENT-PARAGRAPH                                05560010
055700                             TO AA-PARAGRAPH-NAME                 05570010
055800         DISPLAY '******** PLAN_NAME:'                            05580010
055900                  PV-PROGRAM-NAME                                 05590010
056000         MOVE SPACES TO AA-MESSAGE-1                              05600010
056100                        AA-MESSAGE-2                              05610010
056200         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    05620010
056300                             TO AA-DB2-OPERATION                  05630010
056400         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      05640010
056500         PERFORM Z999-DB2-ABEND                                   05650010
056600     END-IF.                                                      05660010
056700                                                                  05670010
056800 EJECT                                                            05680010
056900*----------------------------------------------------------------*05690010
057000*    SET THE TIME FOR THE NEXT CHECKPOINT.                       *05700010
057100*----------------------------------------------------------------*05710010
057200 X500-SET-CHECKPOINT-TIME.                                        05720010
057300                                                                  05730010
057400     MOVE 'X500-SET-CHECKPOINT-TIME' TO PV-CURRENT-PARAGRAPH.     05740010
057500                                                                  05750010
057600     PERFORM WITH TEST AFTER                                      05760010
057700             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05770010
057800             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05780010
057900                     SQLCODE = ZERO                               05790010
058000                                                                  05800010
058100             EXEC SQL                                             05810010
058200              SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)05820010
058300               INTO :WS-HOLD-TMST                                 05830010
058400               FROM TCKRSTCNTL                                    05840010
058500               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 05850010
058600             END-EXEC                                             05860010
058700                                                                  05870010
058800             EVALUATE TRUE                                        05880010
058900                 WHEN SQLCODE = ZERO                              05890010
059000                 WHEN SQLCODE = -904                              05900010
059100                 WHEN SQLCODE = -913                              05910010
059200                      CONTINUE                                    05920010
059300                                                                  05930010
059400                 WHEN SQLWARN0 NOT = SPACES                       05940010
059500                 WHEN SQLCODE  NOT = ZERO                         05950010
059600                     MOVE PV-CURRENT-PARAGRAPH                    05960010
059700                                         TO AA-PARAGRAPH-NAME     05970010
059800                     DISPLAY '******** PLAN_NAME:'                05980010
059900                              PV-PROGRAM-NAME                     05990010
060000                     MOVE SPACES TO AA-MESSAGE-1                  06000010
060100                                    AA-MESSAGE-2                  06010010
060200                     MOVE 'UNSUCCESSFUL SELECT'                   06020010
060300                                         TO AA-DB2-OPERATION      06030010
060400                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          06040010
060500                     PERFORM Z999-DB2-ABEND                       06050010
060600             END-EVALUATE                                         06060010
060700     END-PERFORM.                                                 06070010
060800                                                                  06080010
060900     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06090010
061000         MOVE PV-CURRENT-PARAGRAPH                                06100010
061100                             TO AA-PARAGRAPH-NAME                 06110010
061200         DISPLAY '******** PLAN_NAME:'                            06120010
061300                  PV-PROGRAM-NAME                                 06130010
061400         MOVE SPACES TO AA-MESSAGE-1                              06140010
061500                        AA-MESSAGE-2                              06150010
061600         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    06160010
061700                             TO AA-DB2-OPERATION                  06170010
061800         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      06180010
061900         PERFORM Z999-DB2-ABEND                                   06190010
062000     END-IF.                                                      06200010
062100                                                                  06210010
062200 EJECT                                                            06220010
062300*----------------------------------------------------------------*06230010
062400*    UPDATES THE CHECKPOINT RESTART CONTROL TABLE.  THE STATUS   *06240010
062500*    CODE IS SET TO '9' (RUN IN PROGRESS) OR '0' (RUN COMPLETE). *06250010
062600*----------------------------------------------------------------*06260010
062700 X600-UPDATE-TCKRSTCNTL.                                          06270010
062800                                                                  06280010
062900     MOVE 'X600-UPDATE-TCKRSTCNTL' TO PV-CURRENT-PARAGRAPH.       06290010
063000                                                                  06300010
063100     PERFORM WITH TEST AFTER                                      06310010
063200             VARYING PC-RETRY-COUNT FROM 1 BY 1                   06320010
063300             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             06330010
063400                     SQLCODE = ZERO                               06340010
063500                                                                  06350010
063600             EXEC SQL                                             06360010
063700                 UPDATE TCKRSTCNTL                                06370010
063800                 SET CKPT_STAT_CODE = :PV-CKPT-STAT-CODE          06380010
063900                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          06390010
064000             END-EXEC                                             06400010
064100                                                                  06410010
064200             EVALUATE TRUE                                        06420010
064300                 WHEN SQLCODE = ZERO                              06430010
064400                 WHEN SQLCODE = -904                              06440010
064500                 WHEN SQLCODE = -913                              06450010
064600                      CONTINUE                                    06460010
064700                                                                  06470010
064800                 WHEN SQLWARN0 NOT = SPACES                       06480010
064900                 WHEN SQLCODE  NOT = ZERO                         06490010
065000                     MOVE PV-CURRENT-PARAGRAPH                    06500010
065100                                         TO AA-PARAGRAPH-NAME     06510010
065200                     DISPLAY '******** PLAN_NAME:'                06520010
065300                              PV-PROGRAM-NAME                     06530010
065400                     MOVE SPACES TO AA-MESSAGE-1                  06540010
065500                                    AA-MESSAGE-2                  06550010
065600                     MOVE 'UNSUCCESSFUL UPDATE'                   06560010
065700                                         TO AA-DB2-OPERATION      06570010
065800                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          06580010
065900                     PERFORM Z999-DB2-ABEND                       06590010
066000             END-EVALUATE                                         06600010
066100     END-PERFORM.                                                 06610010
066200                                                                  06620010
066300     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06630010
066400         MOVE PV-CURRENT-PARAGRAPH                                06640010
066500                             TO AA-PARAGRAPH-NAME                 06650010
066600         DISPLAY '******** PLAN_NAME:'                            06660010
066700                  PV-PROGRAM-NAME                                 06670010
066800         MOVE SPACES TO AA-MESSAGE-1                              06680010
066900                        AA-MESSAGE-2                              06690010
067000         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    06700010
067100                             TO AA-DB2-OPERATION                  06710010
067200         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      06720010
067300         PERFORM Z999-DB2-ABEND                                   06730010
067400     END-IF.                                                      06740010
067500                                                                  06750010
067600     EJECT                                                        06760010
067700*----------------------------------------------------------------*06770010
067800*    UPDATES THE CHECKPOINT RESTART INFO TABLE.  THE WORKING     *06780010
067900*    STORAGE DESCRIPTION FIELD IS UPDATED WITH THE CURRENT INPUT *06790010
068000*    FILE RECORD COUNTS AND THE FILE PROCESSOR INDICATOR.        *06800010
068100*----------------------------------------------------------------*06810010
068200 X700-UPDATE-TCKRSTINF.                                           06820010
068300                                                                  06830010
068400     MOVE 'X700-UPDATE-TCKRSTINF' TO PV-CURRENT-PARAGRAPH.        06840010
068500                                                                  06850010
068600     MOVE PV-TIMPORL-INPUT-COUNT TO CR-EXTRACT-RECS-WORKED.       06860010
068700     MOVE CKPT-RESTART-INFO   TO TCKRSTINF-WORK-STRG-DESC-TEXT.   06870010
068800     MOVE 4022                TO TCKRSTINF-WORK-STRG-DESC-LEN.    06880010
068900                                                                  06890010
069000     PERFORM WITH TEST AFTER                                      06900010
069100             VARYING PC-RETRY-COUNT FROM 1 BY 1                   06910010
069200             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             06920010
069300                     SQLCODE = ZERO                               06930010
069400                                                                  06940010
069500             EXEC SQL                                             06950010
069600                 UPDATE TCKRSTINF                                 06960010
069700                 SET WORK_STRG_DESC   = :TCKRSTINF-WORK-STRG-DESC 06970010
069800                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          06980010
069900             END-EXEC                                             06990010
070000                                                                  07000010
070100             EVALUATE TRUE                                        07010010
070200                 WHEN SQLCODE = ZERO                              07020010
070300                 WHEN SQLCODE = -904                              07030010
070400                 WHEN SQLCODE = -913                              07040010
070500                      CONTINUE                                    07050010
070600                                                                  07060010
070700                 WHEN SQLWARN0 NOT = SPACES                       07070010
070800                 WHEN SQLCODE  NOT = ZERO                         07080010
070900                     MOVE PV-CURRENT-PARAGRAPH                    07090010
071000                                         TO AA-PARAGRAPH-NAME     07100010
071100                     DISPLAY '******** PLAN_NAME:'                07110010
071200                              PV-PROGRAM-NAME                     07120010
071300                     MOVE SPACES TO AA-MESSAGE-1                  07130010
071400                                    AA-MESSAGE-2                  07140010
071500                     MOVE 'UNSUCCESSFUL UPDATE'                   07150010
071600                                         TO AA-DB2-OPERATION      07160010
071700                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          07170010
071800                     PERFORM Z999-DB2-ABEND                       07180010
071900             END-EVALUATE                                         07190010
072000     END-PERFORM.                                                 07200010
072100                                                                  07210010
072200     IF PC-RETRY-COUNT > PC-RETRY-MAX                             07220010
072300         MOVE PV-CURRENT-PARAGRAPH                                07230010
072400                             TO AA-PARAGRAPH-NAME                 07240010
072500         DISPLAY '******** PLAN_NAME:'                            07250010
072600                  PV-PROGRAM-NAME                                 07260010
072700         MOVE SPACES TO AA-MESSAGE-1                              07270010
072800                        AA-MESSAGE-2                              07280010
072900         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    07290010
073000                             TO AA-DB2-OPERATION                  07300010
073100         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      07310010
073200         PERFORM Z999-DB2-ABEND                                   07320010
073300     END-IF.                                                      07330010
073400                                                                  07340010
073500 EJECT                                                            07350010
073600                                                                  07360010
073700*----------------------------------------------------------------*07370010
073800*    ISSUES AN SQL COMMIT WORK AFTER A LUW HAS BEEN COMPLETED.   *07380010
073900*----------------------------------------------------------------*07390010
074000 Y100-COMMIT.                                                     07400010
074100                                                                  07410010
074200     MOVE 'Y100-COMMIT'    TO PV-CURRENT-PARAGRAPH.               07420010
074300                                                                  07430010
074400     EXEC SQL                                                     07440010
074500         COMMIT                                                   07450010
074600     END-EXEC.                                                    07460010
074700                                                                  07470010
074800     EVALUATE TRUE                                                07480010
074900         WHEN SQLCODE = ZEROS                                     07490010
075000             CONTINUE                                             07500010
075100         WHEN OTHER                                               07510010
075200             MOVE PV-CURRENT-PARAGRAPH                            07520010
075300                                 TO AA-PARAGRAPH-NAME             07530010
075400             MOVE SPACES TO AA-MESSAGE-1                          07540010
075500                            AA-MESSAGE-2                          07550010
075600             MOVE 'UNSUCCESSFUL COMMIT'                           07560010
075700                                 TO AA-DB2-OPERATION              07570010
075800             MOVE SPACES         TO AA-DB2-TABLE                  07580010
075900             PERFORM Z999-DB2-ABEND                               07590010
076000     END-EVALUATE.                                                07600010
076100 EJECT                                                            07610010
076200 Z999-DB2-ABEND.                                                  07620010
076300                                                                  07630010
076400     DISPLAY AA-ABEND-LIT.                                        07640010
076500     DISPLAY AA-DB2-ERROR-LIT.                                    07650010
076600     DISPLAY AA-PROGRAM-LIT.                                      07660010
076700     DISPLAY AA-PARAGRAPH-LIT.                                    07670010
076800     DISPLAY AA-DB2-OPERATION-LIT.                                07680010
076900     DISPLAY AA-DB2-TABLE.                                        07690010
077000     SET AC-DB2-ERROR TO TRUE.                                    07700010
077100                                                                  07710010
077200     COPY DPPD004.                                                07720010
077300                                                                  07730010
077400     CALL 'ILBOABN0' USING ABEND-CODE.                            07740010
