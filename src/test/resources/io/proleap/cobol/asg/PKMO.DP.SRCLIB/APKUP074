000100*-----------------------*                                         00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300*-----------------------*                                         00030000
000400 PROGRAM-ID.    APKUP074.                                         00040000
000500 AUTHOR.        MIKE BESKE.                                       00050089
000600 DATE-WRITTEN.  JULY 1998.                                        00060089
000700                                                                  00070000
000800*---------------------------------------------------------------* 00080000
000900*                           COBOL 2 WITH SQL                    * 00090000
000910*                                                               * 00091089
000920*        UPDATE IMPORT BALANCE TABLE FOR CURRENT TABLE          * 00092089
000930*                                                               * 00093089
000940*    THE PURPOSE OF THIS PROGRAM IS TO ESTABLISH ROWS FOR THE   * 00094089
000950*    CURRENT WEEK BALANCES AND ACTIVITY ON THE TIMPBAL TABLE.   * 00095089
000960*    ENDING BALANCES FROM THE PREVIOUS WEEK WILL BE ROLLED      * 00096089
000970*    FORWARD AS THE STARTING BALANCE FOR THE CURRENT WEEK, AND  * 00097089
000980*    ANY ACTIVITY AND AGING INFORMATION WILL BE APPLIED TO THE  * 00098089
000990*    NEW ROW, CALCULATING THE NEW ENDING BALANCE.  ANY PO/      * 00099089
001000*    ACCOUNTS THAT HAVE ACTIVITY RECORDS BUT NO PREVIOUS WEEK   * 00100089
001100*    BALANCE WILL BE ESTABLISHED WITH A STARTING BALANCE OF     * 00110089
001200*    ZERO.                                                      * 00120089
001300*                                                               * 00130089
001400*---------------------------------------------------------------* 00140089
001500*                                                               * 00150089
001600* DB2 TABLES:                                                   * 00160089
001700*  1. AP CONTROL TABLE                 (TAPCNTL)                * 00170089
001800*  2. IMPORT BALANCE TABLE             (TIMPBAL)                * 00180089
001900*  3. CHECKPOINT RESTART CONTROL TABLE (TCKRSTCNTL)             * 00190089
002000*  4. CHECKPOINT RESTART INFO TABLE    (TCKRSTINF)              * 00200089
003000*                                                               * 00300000
003100* INPUT:                                                        * 00310000
003200*                                                               * 00320000
003300*  1. PO/ACCOUNT ACTIVITY FILE         (APRD068)                * 00330000
003400*                                                               * 00340000
003500*---------------------------------------------------------------* 00350000
003600*   CHANGES:                                                    * 00360000
003700*                                                               * 00370000
003800*   09/06/01                                                    * 00380090
003900*        CHANGED IMPORT CURSOR TO ALLOW BOTH NEGATIVE AND       * 00390090
003910*        POSITIVE EOP BALANCE ROWS TO BE RETIEVED.              * 00391090
003920*        THIS WILL PREVENT A NEW ROW FROM BEING CREATED WITH A  * 00392090
003921*        ZERO BOP WHEN THE PREVIOUS WEEK THE PO/ACCT HAD A      * 00392190
003922*        NEGATIVE EOP.                                          * 00392290
003923*   MADE BY:  L SCHALLHORN                     PITS/WR#:20704   * 00392390
003924*                                                               * 00392490
003925*---------------------------------------------------------------* 00392590
003926 EJECT                                                            00392690
003927                                                                  00392790
003928 ENVIRONMENT DIVISION.                                            00392890
003929 CONFIGURATION SECTION.                                           00392990
003930 SOURCE-COMPUTER. IBM-3090.                                       00393090
003931 OBJECT-COMPUTER. IBM-3090.                                       00393190
003940                                                                  00394089
003950*                                                                 00395089
003960 INPUT-OUTPUT SECTION.                                            00396089
003970 FILE-CONTROL.                                                    00397089
003980*                                                                 00398089
003990     SELECT PO-ACCOUNT-ACT-FILE    ASSIGN TO UT-S-INP01.          00399089
004000*                                                                 00400089
004100 DATA DIVISION.                                                   00410089
004200 FILE SECTION.                                                    00420089
004300*                                                                 00430089
004400 FD  PO-ACCOUNT-ACT-FILE                                          00440089
004500     RECORDING MODE IS F                                          00450089
004600     BLOCK CONTAINS 0 CHARACTERS                                  00460089
004700     LABEL RECORDS ARE STANDARD                                   00470089
004800     DATA RECORD IS PO-ACCOUNT-ACT-RECORD.                        00480089
004900*                                                                 00490089
005000 01  PO-ACCOUNT-ACT-RECORD       PIC X(100).                      00500089
005100*                                                                 00510089
005200 EJECT                                                            00520089
005300 WORKING-STORAGE SECTION.                                         00530089
005400                                                                  00540089
005500 01  PC-PROGRAM-CONSTANTS.                                        00550089
005600     05  PC-WS-PROGRAM           PIC  X(40)  VALUE                00560089
005700         '**** WORKING STORAGE ** APKUP074 ****'.                 00570089
005800     05  PC-PROGRAM-NAME         PIC  X(08)  VALUE 'APKUP074'.    00580089
005900     05  PC-RETRY-MAX            PIC S9(04)  VALUE +3             00590089
006000                                             COMP SYNC.           00600089
006100     05  PC-RETRY-COUNT          PIC S9(04)  VALUE ZEROS.         00610089
008000     05  PC-IN-PROCESS-CODE      PIC  X(01)  VALUE '9'.           00800000
008100     05  PC-RUN-COMPLETE-CODE    PIC  X(01)  VALUE '0'.           00810000
008200                                                                  00820089
008300 01  PV-PROGRAM-VARIABLES.                                        00830089
008400     05  PV-CURRENT-PARAGRAPH    PIC X(35).                       00840089
008500     05  PV-NULL-IND             PIC S9(4)     VALUE ZERO         00850089
008600                                               COMP SYNC.         00860089
008700     05  PV-CKPT-STAT-CODE       PIC X(01)     VALUE SPACE.       00870089
008701                                                                  00870189
008702 01  PV-PROGRAM-VARIABLES-II.                                     00870200
008703     05  PV-PO-NBR-COMP          PIC S9(9)     VALUE ZEROS  COMP. 00870389
008704     05  PV-CSR-PO-NBR-COMP      PIC S9(9)     VALUE ZEROS  COMP. 00870489
008705     05  PV-PO-ACCT.                                              00870589
008706         10  PV-PO-NBR           PIC 9(9)       VALUE ZEROS.      00870689
008707         10  PV-GL-ACCT-NBR      PIC X(7)       VALUE SPACE.      00870789
008708     05  PV-CSR-PO-ACCT.                                          00870889
008709         10  PV-CSR-PO-NBR       PIC 9(9)       VALUE ZEROS.      00870989
008710         10  PV-CSR-GL-ACCT-NBR  PIC X(7)       VALUE SPACE.      00871089
008720     05  PV-PERD-END-DTE         PIC X(10)      VALUE SPACE.      00872089
008730     05  PV-BOP-BAL-AMT          PIC S9(9)V9(2) VALUE ZEROS       00873089
008740                                                COMP-3.           00874089
008750     05  PV-EOP-BAL-AMT          PIC S9(9)V9(2) VALUE ZEROS       00875089
008760                                                COMP-3.           00876089
008770     05  PV-DR-ACTVY-AMT         PIC S9(9)V9(2) VALUE ZEROS       00877089
008780                                                COMP-3.           00878089
008790     05  PV-CR-ACTVY-AMT         PIC S9(9)V9(2) VALUE ZEROS       00879089
008800                                                COMP-3.           00880089
008900     05  PV-AGE-30DAY-AMT        PIC S9(7)V9(2) VALUE ZEROS       00890089
009000                                                COMP-3.           00900089
009100     05  PV-AGE-60DAY-AMT        PIC S9(7)V9(2) VALUE ZEROS       00910089
009200                                                COMP-3.           00920089
009300     05  PV-AGE-90DAY-AMT        PIC S9(7)V9(2) VALUE ZEROS       00930089
009400                                                COMP-3.           00940089
009500     05  PV-AGE-120DAY-AMT       PIC S9(7)V9(2) VALUE ZEROS       00950089
009600                                                COMP-3.           00960089
009700     05  PV-AGE-OVR-120DAY-AMT   PIC S9(7)V9(2) VALUE ZEROS       00970089
009800                                                COMP-3.           00980089
009900     05  PV-ACTIVITY-COUNT       PIC S9(9)     VALUE ZEROS        00990089
010000                                               COMP.              01000089
010100     05  PV-IMP-BAL-COUNT        PIC S9(9)     VALUE ZEROS        01010089
010200                                               COMP.              01020089
010300     05  PV-INSERT-COUNT         PIC S9(9)     VALUE ZEROS        01030089
010400                                               COMP.              01040089
010500                                                                  01050089
010600                                                                  01060089
010700 01  PS-PROGRAM-SWITCHES.                                         01070089
010800     05  PS-END-ACTIVITY-SW      PIC  X(01)  VALUE ' '.           01080089
010900         88  PS-END-ACTIVITY                 VALUE 'Y'.           01090089
011000         88  PS-MORE-ACTIVITY                VALUE ' '.           01100089
011100     05  PS-END-IMP-BAL-SW       PIC  X(01)  VALUE ' '.           01110089
011200         88  PS-END-IMP-BAL                  VALUE 'Y'.           01120089
011300         88  PS-MORE-IMP-BAL                 VALUE ' '.           01130089
011400     05  PS-RUN-TYPE-SW          PIC  X(01)  VALUE ' '.           01140089
011500         88  NORMAL-RUN                      VALUE '0'.           01150089
011600         88  RESTART-RUN                     VALUE '9'.           01160089
011700     05  PS-COMPARE-SW           PIC  X(01)  VALUE ' '.           01170089
011800         88  PS-COMPARE-ONE                  VALUE '1'.           01180089
011900         88  PS-COMPARE-TWO                  VALUE '2'.           01190089
012000         88  PS-COMPARE-THREE                VALUE '3'.           01200089
012100                                                                  01210089
012200 01  HOLD-FIELDS.                                                 01220089
012300     05  HOLD-PO-NBR              PIC S9(9)      VALUE ZEROS COMP.01230089
012400     05  HOLD-GL-ACCT-NBR         PIC X(7)       VALUE SPACE.     01240089
012500     05  HOLD-EOP-BAL-AMT         PIC S9(9)V9(2) VALUE ZEROS      01250089
012600                                                   COMP-3.        01260089
012700                                                                  01270089
012800 01  CKPT-RESTART-INFO.                                           01280089
012900     05  CR-COMPARE-SW            PIC X(1)    VALUE SPACE.        01290089
013000     05  CR-PO-ACCT.                                              01300089
013100         10  CR-PO-NBR            PIC 9(9)    VALUE ZEROS.        01310089
013200         10  CR-GL-ACCT-NBR       PIC X(7)    VALUE SPACE.        01320089
013300     05  CR-CSR-PO-ACCT.                                          01330089
013400         10  CR-CSR-PO-NBR        PIC 9(9)    VALUE ZEROS.        01340089
013500         10  CR-CSR-GL-ACCT-NBR   PIC X(7)    VALUE SPACE.        01350089
013600     05  CR-IMP-BAL-COUNT         PIC S9(9)   VALUE ZEROS  COMP.  01360089
013700     05  CR-ACTIVITY-COUNT        PIC S9(9)   VALUE ZEROS  COMP.  01370089
013800     05  CR-INSERT-COUNT          PIC S9(9)   VALUE ZEROS  COMP.  01380089
013900                                                                  01390089
014000 01  CKPT-RESTART-TMST.                                           01400089
014100     05  CR-CURR-TMST             PIC X(26)     VALUE SPACES.     01410089
014200     05  CR-NEXT-TMST             PIC X(26)     VALUE SPACES.     01420089
014300*                                                                 01430089
014400 01  RUN-TIME.                                                    01440089
014500     05  R-HR                    PIC 99.                          01450089
014600     05  R-MIN                   PIC 99.                          01460089
014700     05  R-SEC                   PIC 99.                          01470089
014800     05  R-TH                    PIC 99.                          01480089
014900*                                                                 01490089
015000 01  DATE-IN.                                                     01500089
015100     05 DATE-IN-YY               PIC XX.                          01510089
015200     05 DATE-IN-MM               PIC XX.                          01520089
015300     05 DATE-IN-DD               PIC XX.                          01530089
015400                                                                  01540089
017300/                                                                 01730000
017400*                                                                 01740000
017500*    IMPORT-PO-EXTRACT-FILE                                       01750000
017600*                                                                 01760000
017700     COPY APRD068.                                                01770000
017800/                                                                 01780000
017900*                                                                 01790000
018000*    TAPCNTL DCLGEN                                               01800000
018100*                                                                 01810000
018200     EXEC SQL                                                     01820000
018300         INCLUDE TAPCNTL                                          01830000
018400     END-EXEC.                                                    01840000
018500/                                                                 01850089
018600*                                                                 01860089
018700*    TINVOIC DCLGEN                                               01870089
018800*                                                                 01880089
018900     EXEC SQL                                                     01890089
019000         INCLUDE TIMPBAL                                          01900089
019100     END-EXEC.                                                    01910089
019200/                                                                 01920089
019300*                                                                 01930089
019400*    TCKRSTCNTL TABLE LAYOUT                                      01940089
019500*                                                                 01950089
019600     EXEC SQL                                                     01960089
019700         INCLUDE TCKRSTCN                                         01970089
019800     END-EXEC.                                                    01980089
019900/                                                                 01990089
020000*                                                                 02000089
020100*    TCKRSTINF TABLE LAYOUT                                       02010089
020200*                                                                 02020089
020300     EXEC SQL                                                     02030089
020400         INCLUDE TCKRSTIN                                         02040089
020500     END-EXEC.                                                    02050089
020600/                                                                 02060089
020700*                                                                 02070089
020800*    SQL COMMUNICATIONS AREA DCLGEN                               02080089
020900*                                                                 02090089
021000     EXEC SQL                                                     02100089
021100         INCLUDE SQLCA                                            02110089
021200     END-EXEC.                                                    02120089
021300/                                                                 02130089
021400*---------------------------------------------------------------- 02140089
021500*    CURSOR DECLARATIONS                                          02150089
021600*---------------------------------------------------------------- 02160089
021700*---------------------------------------------------------------- 02170089
021800* IMP_BAL_CSR GETS ALL PO/ACCOUNT NUMBERS WITH A PERIOD ENDING    02180089
021900* DATE EQUAL TO THE PREVIOUS WEEK ENDING DATE.  THE PERIOD ENDING 02190089
022000* BALANCE IS GREATER THAN ZERO.                                   02200089
022010* 09/06/01 PERIOD ENDING BALANCE NOT EQUAL TO ZERO.               02201090
022100*---------------------------------------------------------------- 02210089
022200     EXEC SQL                                                     02220089
022300         DECLARE IMP_BAL_CSR CURSOR WITH HOLD FOR                 02230089
022400           SELECT                                                 02240089
022500                 IB.PO_NBR                                        02250089
022600                ,IB.GL_ACCT_NBR                                   02260089
022700                ,IB.EOP_BAL_AMT                                   02270089
022800             FROM                                                 02280089
022900                 TIMPBAL IB                                       02290089
023000             WHERE IB.PERD_END_DTE = :APCNTL-PREV-WK-END-DTE      02300089
023100               AND IB.EOP_BAL_AMT  <> 0                           02310090
023200          ORDER BY                                                02320089
023300                 IB.PO_NBR                                        02330089
023400                ,IB.GL_ACCT_NBR                                   02340089
023500     END-EXEC.                                                    02350089
023600/                                                                 02360089
023700*---------------------------------------------------------------- 02370089
023800*  ABEND DATA AREAS                                               02380089
023900*---------------------------------------------------------------- 02390089
024000 01  ABEND-CODE                  PIC S9(04)  VALUE ZEROS          02400089
024100                                             COMP SYNC.           02410089
024200     88  AC-DB2-ERROR                        VALUE +4013.         02420089
024300     88  AC-DATE-ERROR                       VALUE +4019.         02430089
024400                                                                  02440089
024500                                                                  02450089
024600 01  ABEND-AREAS.                                                 02460089
024700     05  AA-ABEND-LIT            PIC  X(40)  VALUE                02470089
024800             '*****       ABEND'.                                 02480089
024900     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                02490089
025000             '*****   PROGRAM: APKUP074'.                         02500089
025100     05  AA-PARAGRAPH-LIT.                                        02510089
025200         10  FILLER              PIC  X(17)  VALUE                02520089
025300             '***** PARAGRAPH: '.                                 02530089
025400         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        02540089
025500     05  AA-MESSAGE-LINE.                                         02550089
025600         10  FILLER              PIC  X(06)  VALUE '*****'.       02560089
025700         10  AA-MESSAGE          PIC  X(127) VALUE SPACES.        02570089
025800     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                02580089
025900             '*****    DB2 ERROR'.                                02590089
026000     05  AA-DB2-OPERATION-LIT.                                    02600089
026100         10  FILLER              PIC  X(17)  VALUE                02610089
026200             '***** OPERATION: '.                                 02620089
026300         10  AA-DB2-OPERATION.                                    02630089
026400             15  AA-DB2-OP-1     PIC  X(25)  VALUE SPACES.        02640089
026500             15  AA-DB2-OP-2     PIC  X(25)  VALUE SPACES.        02650089
026600     05  AA-DB2-TABLE-1          PIC  X(08)  VALUE SPACES.        02660089
026700     05  AA-DB2-TABLE-2          PIC  X(08)  VALUE SPACES.        02670089
026800     05  AA-DB2-TABLE-3          PIC  X(08)  VALUE SPACES.        02680089
026900                                                                  02690089
027000/                                                                 02700089
027100*---------------------------------------------------------------- 02710089
027200*  SQLCA FORMATTED MESSAGE AREA                                   02720089
027300*---------------------------------------------------------------- 02730089
027400     COPY DPWS004.                                                02740089
027500*                                                                 02750089
027600/                                                                 02760089
027700 01  FILLER                      PIC  X(35)  VALUE                02770089
027800     '**** END OF W/S ** APKUP074 ****'.                          02780089
027900 EJECT                                                            02790089
028000 PROCEDURE DIVISION.                                              02800089
028100                                                                  02810089
028200     PERFORM A100-MAINLINE.                                       02820089
028300     GOBACK.                                                      02830089
028400                                                                  02840089
028500 EJECT                                                            02850089
028600 A100-MAINLINE.                                                   02860089
028700                                                                  02870089
028800     MOVE 'A100-MAINLINE' TO PV-CURRENT-PARAGRAPH.                02880089
028900                                                                  02890089
029000     PERFORM B100-INITIALIZE.                                     02900089
029100                                                                  02910089
029200     PERFORM B200-PROCESS-EXTRACT-FILE                            02920089
029300         UNTIL PS-END-ACTIVITY                                    02930089
029400           AND PS-END-IMP-BAL.                                    02940089
029500                                                                  02950089
029600     PERFORM B300-END-OF-PROGRAM.                                 02960089
029700                                                                  02970089
029800 EJECT                                                            02980089
029900*---------------------------------------------------------------- 02990089
030000*    INITIALIZATION PROCESSING.                                   03000089
030100*---------------------------------------------------------------- 03010089
030200 B100-INITIALIZE.                                                 03020089
030300                                                                  03030089
030400     MOVE 'B100-INITIALIZE' TO PV-CURRENT-PARAGRAPH.              03040089
030500                                                                  03050089
030600     ACCEPT RUN-TIME FROM TIME.                                   03060089
030700     ACCEPT DATE-IN  FROM DATE.                                   03070089
030800                                                                  03080089
030900     DISPLAY ' RUN-DATE = ' DATE-IN '   RUN-TIME = ' RUN-TIME.    03090089
031000                                                                  03100089
031100     OPEN INPUT PO-ACCOUNT-ACT-FILE.                              03110089
031200                                                                  03120089
031300     INITIALIZE DCLTAPCNTL                                        03130089
031400                DCLTIMPBAL.                                       03140089
031500                                                                  03150089
031600     INITIALIZE PS-PROGRAM-SWITCHES.                              03160089
031700                                                                  03170089
031800     PERFORM S100-SELECT-AP-CONTROL.                              03180089
031900                                                                  03190089
032000     PERFORM X100-OPEN-IMP-BAL-CSR.                               03200089
032100                                                                  03210089
032200     PERFORM R400-GET-CHECKPOINT-CNTL.                            03220089
032300     MOVE PV-CKPT-STAT-CODE TO PS-RUN-TYPE-SW.                    03230089
032400                                                                  03240089
032500     IF RESTART-RUN                                               03250089
032600        PERFORM H200-CHECKPOINT-RESTART                           03260089
032700     ELSE                                                         03270089
032800        PERFORM R100-FETCH-IMP-BAL                                03280089
032900        PERFORM R200-READ-ACTIVITY-FILE                           03290089
033000     END-IF.                                                      03300089
033100                                                                  03310089
033200 EJECT                                                            03320089
033300*-----------------------------------------------------------------03330089
033400*    COMPARE THE CURSOR PO/ACCOUNT TO THE ACTIVITY FILE PO/ACCOUNT03340089
033500*    COMBINATION.                                                 03350089
033600*      - IF A MATCH IS MADE, CREATE A NEW ROW ON TIMBAL WITH THE  03360089
033700*        AMOUNTS AND AGING DATA FROM THE ACTIVITY RECORD.  THE BOP03370089
033800*        WILL BE THE EOP AMOUNT FROM THE CURSOR.  THE EOP AMOUNT  03380089
033900*        WILL BE THE BOP AMOUNT+(DEBIT ACTIVITY-CREDIT ACTIVITY). 03390089
034000*      - IF THERE IS ONLY AN ACTIVITY RECORD, CREATE A NEW ENTRY  03400089
034100*        FOR THE TIMBAL TABLE THAT WILL BE MADE UP OF THE ACTIVITY03410089
034200*        RECORD DATA. THE BOP AMOUNT WILL BE ZERO.  THE EOP AMOUNT03420089
034300*        WILL BE DEBIT ACTIVITY - CREDIT ACTIVITY.                03430089
034400*      - IF THERE IS ONLY A CURSOR RECORD, CREATE A NEW ENTRY FOR 03440089
034500*        TIMBAL WHERE THE BOP AND EOP AMOUNTS WILL BE THE SAME AS 03450089
034600*        THE CURSOR EOP AMOUNT.  ALL OF THE OTHER AMOUNTS AND     03460089
034700*        AGING DATA WILL BE ZERO.                                 03470089
034800*-----------------------------------------------------------------03480089
034900 B200-PROCESS-EXTRACT-FILE.                                       03490089
035000                                                                  03500089
035100     MOVE 'B200-PROCESS-EXTRACT-FILE' TO                          03510089
035200                             PV-CURRENT-PARAGRAPH.                03520089
035300                                                                  03530089
035400     IF PV-CSR-PO-ACCT = AP068-PO-ACCT                            03540089
035500        PERFORM C100-CREATE-MATCHED-ROW                           03550089
035600        PERFORM U200-INSERT-TIMPBAL-ROW                           03560089
035700        PERFORM H100-CHECKPOINT-COMMIT                            03570089
035800        IF PS-MORE-IMP-BAL                                        03580089
035900           PERFORM R100-FETCH-IMP-BAL                             03590089
036000        END-IF                                                    03600089
036100        IF PS-MORE-ACTIVITY                                       03610089
036200           PERFORM R200-READ-ACTIVITY-FILE                        03620089
036300        END-IF                                                    03630089
036400     ELSE                                                         03640089
036500        IF PV-CSR-PO-ACCT > AP068-PO-ACCT                         03650089
036600           PERFORM C200-CREATE-ACTIVITY-ROW                       03660089
036700           PERFORM U200-INSERT-TIMPBAL-ROW                        03670089
036800           PERFORM H100-CHECKPOINT-COMMIT                         03680089
036900           IF PS-MORE-ACTIVITY                                    03690089
037000              PERFORM R200-READ-ACTIVITY-FILE                     03700089
037100           END-IF                                                 03710089
037200        ELSE                                                      03720089
037300           IF PV-CSR-PO-ACCT < AP068-PO-ACCT                      03730089
037400              PERFORM C300-CREATE-CURSOR-ROW                      03740089
037500              PERFORM U200-INSERT-TIMPBAL-ROW                     03750089
037600              PERFORM H100-CHECKPOINT-COMMIT                      03760089
037700              IF PS-MORE-IMP-BAL                                  03770089
037800                 PERFORM R100-FETCH-IMP-BAL                       03780089
037900              END-IF                                              03790089
038000           END-IF                                                 03800089
038100        END-IF                                                    03810089
038200     END-IF.                                                      03820089
038300                                                                  03830089
038400 EJECT                                                            03840089
038500*---------------------------------------------------------------- 03850089
038600*    END OF PROGRAM.                                              03860089
038700*---------------------------------------------------------------- 03870089
038800 B300-END-OF-PROGRAM.                                             03880089
038900                                                                  03890089
039000     PERFORM Y100-CLOSE-IMP-BAL-CSR.                              03900089
039100     CLOSE PO-ACCOUNT-ACT-FILE.                                   03910089
039200                                                                  03920089
039300     DISPLAY '********************************'.                  03930089
039400     DISPLAY '*       APKUP074 COUNTS        *'.                  03940089
039500     DISPLAY '********************************'.                  03950089
039600     DISPLAY 'NBR OF TIMPBAL ROWS FETCHED   = ' PV-IMP-BAL-COUNT. 03960089
039700     DISPLAY 'NBR OF PO/ACCT ACT RECS READ  = ' PV-ACTIVITY-COUNT.03970089
039800     DISPLAY 'NBR OF TIMPBAL ROWS INSERTED  = ' PV-INSERT-COUNT.  03980089
039900     DISPLAY '** PROGRAM APKUP074 ENDS NORMALLY **'.              03990089
040000                                                                  04000089
040100     MOVE PC-RUN-COMPLETE-CODE TO PV-CKPT-STAT-CODE.              04010089
040200     MOVE ZERO                 TO PV-PROGRAM-VARIABLES-II.        04020089
040300     PERFORM U500-UPDATE-TCKRSTCNTL.                              04030089
040400     PERFORM U600-UPDATE-TCKRSTINF.                               04040089
040500     PERFORM U700-COMMIT.                                         04050089
040600                                                                  04060089
040700 EJECT                                                            04070089
040800*---------------------------------------------------------------- 04080089
040900*    MOVE THE DATA FROM THE CURSOR AND ACTIVITY RECORD TO CREATE  04090089
041000*    A NEW ROW FOR THE TIMPBAL TABLE WHEN A MATCH IS MADE BETWEEN 04100089
041100*    THE CURSOR AND ACTIVITY RECORD.                              04110089
041200*---------------------------------------------------------------- 04120089
041300 C100-CREATE-MATCHED-ROW.                                         04130089
041400                                                                  04140089
041500     MOVE 'C100-CREATE-MATCHED-ROW' TO PV-CURRENT-PARAGRAPH.      04150089
041600                                                                  04160089
041700     SET PS-COMPARE-ONE          TO TRUE.                         04170089
041800     MOVE HOLD-PO-NBR            TO PV-PO-NBR-COMP.               04180089
041900     MOVE HOLD-GL-ACCT-NBR       TO PV-GL-ACCT-NBR.               04190089
042000     MOVE APCNTL-CURR-WK-END-DTE TO PV-PERD-END-DTE.              04200089
042100     MOVE HOLD-EOP-BAL-AMT       TO PV-BOP-BAL-AMT.               04210089
042200     MOVE AP068-DR-ACTVTY-AMT    TO PV-DR-ACTVY-AMT.              04220089
042300     MOVE AP068-CR-ACTVTY-AMT    TO PV-CR-ACTVY-AMT.              04230089
042400     MOVE AP068-AGE-30-DAY-AMT   TO PV-AGE-30DAY-AMT.             04240089
042500     MOVE AP068-AGE-60-DAY-AMT   TO PV-AGE-60DAY-AMT.             04250089
042600     MOVE AP068-AGE-90-DAY-AMT   TO PV-AGE-90DAY-AMT.             04260089
042700     MOVE AP068-AGE-120-DAY-AMT  TO PV-AGE-120DAY-AMT.            04270089
042800     MOVE AP068-AGE-OVER120-AMT  TO PV-AGE-OVR-120DAY-AMT.        04280089
042900     COMPUTE PV-EOP-BAL-AMT = PV-BOP-BAL-AMT + PV-DR-ACTVY-AMT    04290089
043000                              - PV-CR-ACTVY-AMT.                  04300089
043100                                                                  04310089
043200 EJECT                                                            04320089
043300*---------------------------------------------------------------- 04330089
043400*    MOVE THE DATA FROM THE ACTIVITY RECORD TO CREATE A NEW ROW   04340089
043500*    FOR THE TIMPBAL TABLE WHEN ONLY AN ACTIVITY RECORD EXISTS    04350089
043600*    FOR THE PO/ACCOUNT COMBINATION.                              04360089
043700*---------------------------------------------------------------- 04370089
043800 C200-CREATE-ACTIVITY-ROW.                                        04380089
043900                                                                  04390089
044000     MOVE 'C200-CREATE-ACTIVITY-ROW' TO PV-CURRENT-PARAGRAPH.     04400089
044100                                                                  04410089
044200     SET PS-COMPARE-TWO          TO TRUE.                         04420089
044300     MOVE AP068-PO-NBR           TO PV-PO-NBR-COMP.               04430089
044400     MOVE AP068-GL-ACCT-NBR      TO PV-GL-ACCT-NBR.               04440089
044500     MOVE APCNTL-CURR-WK-END-DTE TO PV-PERD-END-DTE.              04450089
044600     MOVE ZEROS                  TO PV-BOP-BAL-AMT.               04460089
044700     MOVE AP068-DR-ACTVTY-AMT    TO PV-DR-ACTVY-AMT.              04470089
044800     MOVE AP068-CR-ACTVTY-AMT    TO PV-CR-ACTVY-AMT.              04480089
044900     MOVE AP068-AGE-30-DAY-AMT   TO PV-AGE-30DAY-AMT.             04490089
045000     MOVE AP068-AGE-60-DAY-AMT   TO PV-AGE-60DAY-AMT.             04500089
045100     MOVE AP068-AGE-90-DAY-AMT   TO PV-AGE-90DAY-AMT.             04510089
045200     MOVE AP068-AGE-120-DAY-AMT  TO PV-AGE-120DAY-AMT.            04520089
045300     MOVE AP068-AGE-OVER120-AMT  TO PV-AGE-OVR-120DAY-AMT.        04530089
045400     COMPUTE PV-EOP-BAL-AMT = PV-DR-ACTVY-AMT - PV-CR-ACTVY-AMT.  04540089
045500                                                                  04550089
045600 EJECT                                                            04560089
045700*---------------------------------------------------------------- 04570089
045800*    CREATE A NEW ROW FOR THE TIMPBAL TABLE BY USING THE EOP      04580089
045900*    AMOUNT FROM THE CURSOR. ALL OTHER AMOUNT FIELDS WILL BE ZERO.04590089
046000*    THIS IS DONE WHEN THERE IS NO ACTIVITY EXISTING FOR THE PO/  04600089
046100*    ACCOUNT COMBINATION.                                         04610089
046200*---------------------------------------------------------------- 04620089
046300 C300-CREATE-CURSOR-ROW.                                          04630089
046400                                                                  04640089
046500     MOVE 'C300-CREATE-CURSOR-ROW' TO PV-CURRENT-PARAGRAPH.       04650089
046600                                                                  04660089
046700     SET PS-COMPARE-THREE        TO TRUE.                         04670089
046800     MOVE HOLD-PO-NBR            TO PV-PO-NBR-COMP.               04680089
046900     MOVE HOLD-GL-ACCT-NBR       TO PV-GL-ACCT-NBR.               04690089
047000     MOVE APCNTL-CURR-WK-END-DTE TO PV-PERD-END-DTE.              04700089
047100     MOVE HOLD-EOP-BAL-AMT       TO PV-BOP-BAL-AMT                04710089
047200                                    PV-EOP-BAL-AMT.               04720089
047300     MOVE ZEROS                  TO PV-DR-ACTVY-AMT               04730089
047400                                    PV-CR-ACTVY-AMT               04740089
047500                                    PV-AGE-30DAY-AMT              04750089
047600                                    PV-AGE-60DAY-AMT              04760089
047700                                    PV-AGE-90DAY-AMT              04770089
047800                                    PV-AGE-120DAY-AMT             04780089
047900                                    PV-AGE-OVR-120DAY-AMT.        04790089
048000                                                                  04800089
048100 EJECT                                                            04810089
048200*----------------------------------------------------------------*04820089
048300*    DO THE CHECKPOINT RESTART AND THE COMMIT.                   *04830089
048400*----------------------------------------------------------------*04840089
048500 H100-CHECKPOINT-COMMIT.                                          04850089
048600                                                                  04860089
048700     MOVE 'H100-CHECKPOINT-COMMIT' TO PV-CURRENT-PARAGRAPH.       04870089
048800                                                                  04880089
048900     EXEC SQL                                                     04890089
049000       SET :CR-CURR-TMST = CURRENT TIMESTAMP                      04900089
049100     END-EXEC.                                                    04910089
049200                                                                  04920089
049300     EVALUATE TRUE                                                04930089
049400         WHEN SQLCODE = ZERO                                      04940089
049500              CONTINUE                                            04950089
049600                                                                  04960089
049700        WHEN SQLWARN0 NOT = SPACES                                04970089
049800        WHEN SQLCODE  NOT = ZERO                                  04980089
049900            MOVE 'UNSUCCESSFUL SET TMST'                          04990089
050000                                TO AA-DB2-OPERATION               05000089
050100            PERFORM Z999-DB2-ABEND                                05010089
050200     END-EVALUATE.                                                05020089
050300                                                                  05030089
050400     IF CR-CURR-TMST > CR-NEXT-TMST                               05040089
050500        MOVE PC-IN-PROCESS-CODE      TO PV-CKPT-STAT-CODE         05050089
050600        PERFORM U500-UPDATE-TCKRSTCNTL                            05060089
050700        PERFORM U600-UPDATE-TCKRSTINF                             05070089
050800        PERFORM U700-COMMIT                                       05080089
050900                                                                  05090089
051000        EXEC SQL                                                  05100089
051100         SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)     05110089
051200          INTO :CR-NEXT-TMST                                      05120089
051300          FROM TCKRSTCNTL                                         05130089
051400          WHERE PLAN_NAME = :PC-PROGRAM-NAME                      05140089
051500        END-EXEC                                                  05150089
051600                                                                  05160089
051700          EVALUATE TRUE                                           05170089
051800              WHEN SQLCODE = ZERO                                 05180089
051900                   CONTINUE                                       05190089
052000                                                                  05200089
052100          WHEN SQLWARN0 NOT = SPACES                              05210089
052200          WHEN SQLCODE  NOT = ZERO                                05220089
052300              MOVE 'UNSUCCESSFUL NEXT TMST'                       05230089
052400                                  TO AA-DB2-OPERATION             05240089
052500              PERFORM Z999-DB2-ABEND                              05250089
052600       END-EVALUATE                                               05260089
052700     END-IF.                                                      05270089
052800                                                                  05280089
052900*----------------------------------------------------------------*05290089
053000*    GET THE RESTART INFO.                                       *05300089
053100*----------------------------------------------------------------*05310089
053200 H200-CHECKPOINT-RESTART.                                         05320089
053300                                                                  05330089
053400     MOVE 'H200-CHECKPOINT-RESTART' TO PV-CURRENT-PARAGRAPH.      05340089
053500                                                                  05350089
053600     PERFORM R500-GET-CHECKPOINT-INFO.                            05360089
053700     MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO CKPT-RESTART-INFO.     05370089
053800                                                                  05380089
053900     DISPLAY '***********************************************'.   05390089
054000     DISPLAY '** APKUP074 CHECKPOINT RESTART **'                  05400089
054100     DISPLAY '** CURSOR PO/ACCT NBR ON RESTART = ' CR-CSR-PO-ACCT.05410089
054200     DISPLAY '** AP068 PO/ACCT NBR ON RESTART  = ' CR-PO-ACCT.    05420089
054300     DISPLAY '***********************************************'.   05430089
054400                                                                  05440089
054500     IF CR-COMPARE-SW = '1'                                       05450089
054600        PERFORM R100-FETCH-IMP-BAL                                05460089
054700           WITH TEST AFTER                                        05470089
054800                UNTIL PS-END-IMP-BAL                              05480089
054900                  OR (PV-CSR-PO-ACCT > CR-CSR-PO-ACCT)            05490089
055000        PERFORM R200-READ-ACTIVITY-FILE                           05500089
055100           WITH TEST AFTER                                        05510089
055200                UNTIL PS-END-ACTIVITY                             05520089
055300                  OR (AP068-PO-ACCT > CR-PO-ACCT)                 05530089
055400     END-IF.                                                      05540089
055500                                                                  05550089
055600     IF CR-COMPARE-SW = '2'                                       05560089
055700        PERFORM R100-FETCH-IMP-BAL                                05570089
055800           WITH TEST AFTER                                        05580089
055900                UNTIL PS-END-IMP-BAL                              05590089
056000                  OR (PV-CSR-PO-ACCT = CR-CSR-PO-ACCT)            05600089
056100        PERFORM R200-READ-ACTIVITY-FILE                           05610089
056200           WITH TEST AFTER                                        05620089
056300                UNTIL PS-END-ACTIVITY                             05630089
056400                  OR (AP068-PO-ACCT > CR-PO-ACCT)                 05640089
056500     END-IF.                                                      05650089
056600                                                                  05660089
056700     IF CR-COMPARE-SW = '3'                                       05670089
056800        PERFORM R100-FETCH-IMP-BAL                                05680089
056900           WITH TEST AFTER                                        05690089
057000                UNTIL PS-END-IMP-BAL                              05700089
057100                  OR (PV-CSR-PO-ACCT > CR-CSR-PO-ACCT)            05710089
057200        PERFORM R200-READ-ACTIVITY-FILE                           05720089
057300           WITH TEST AFTER                                        05730089
057400                UNTIL PS-END-ACTIVITY                             05740089
057500                  OR (AP068-PO-ACCT = CR-PO-ACCT)                 05750089
057600     END-IF.                                                      05760089
057700                                                                  05770089
057800     MOVE ZEROS             TO PV-IMP-BAL-COUNT                   05780089
057900                               PV-ACTIVITY-COUNT                  05790089
058000                               PV-INSERT-COUNT.                   05800089
058100                                                                  05810089
058200     MOVE CR-IMP-BAL-COUNT  TO PV-IMP-BAL-COUNT.                  05820089
058300     MOVE CR-ACTIVITY-COUNT TO PV-ACTIVITY-COUNT.                 05830089
058400     MOVE CR-INSERT-COUNT   TO PV-INSERT-COUNT.                   05840089
058500                                                                  05850089
058600     IF CR-COMPARE-SW = '1' OR '2'                                05860089
058700        ADD 1 TO PV-ACTIVITY-COUNT                                05870089
058800     END-IF.                                                      05880089
058900                                                                  05890089
059000     IF CR-COMPARE-SW = '1' OR '3'                                05900089
059100        ADD 1 TO PV-IMP-BAL-COUNT                                 05910089
059200     END-IF.                                                      05920089
059300                                                                  05930089
059400*---------------------------------------------------------------- 05940089
059500*    FETCH ALL IMPORT BALANCE ROWS FOR THE CURRENT PERIOD.        05950089
059600*---------------------------------------------------------------- 05960089
059700 R100-FETCH-IMP-BAL.                                              05970089
059800                                                                  05980089
059900     MOVE 'R100-FETCH-IMP-BAL' TO PV-CURRENT-PARAGRAPH.           05990089
060000                                                                  06000089
060100     EXEC SQL                                                     06010089
060200         FETCH IMP_BAL_CSR                                        06020089
060300         INTO :HOLD-PO-NBR                                        06030089
060400             ,:HOLD-GL-ACCT-NBR                                   06040089
060500             ,:HOLD-EOP-BAL-AMT                                   06050089
060600     END-EXEC.                                                    06060089
060700                                                                  06070089
060800     EVALUATE TRUE                                                06080089
060900         WHEN SQLCODE = ZERO                                      06090089
061000              MOVE HOLD-PO-NBR        TO PV-CSR-PO-NBR-COMP       06100089
061100              MOVE PV-CSR-PO-NBR-COMP TO PV-CSR-PO-NBR            06110089
061200              MOVE HOLD-GL-ACCT-NBR   TO PV-CSR-GL-ACCT-NBR       06120089
061300              ADD 1 TO PV-IMP-BAL-COUNT                           06130089
061400                                                                  06140089
061500         WHEN SQLCODE = +100                                      06150089
061600              MOVE ALL '9' TO PV-CSR-PO-ACCT                      06160089
061700              SET PS-END-IMP-BAL TO TRUE                          06170089
061800                                                                  06180089
061900         WHEN SQLWARN0 NOT = SPACES                               06190089
062000         WHEN SQLCODE  NOT = ZERO                                 06200089
062100             MOVE PV-CURRENT-PARAGRAPH                            06210089
062200                                TO AA-PARAGRAPH-NAME              06220089
062300             MOVE 'BAD FETCH WITH IMP_BAL_CSR'                    06230089
062400                                TO AA-DB2-OPERATION               06240089
062500             MOVE 'TIMPBAL'     TO AA-DB2-TABLE-1                 06250089
062600             MOVE 'TPAYREQ'     TO AA-DB2-TABLE-2                 06260089
062700             MOVE SPACES        TO AA-DB2-TABLE-3                 06270089
062800             PERFORM Z999-DB2-ABEND                               06280089
062900     END-EVALUATE.                                                06290089
063000                                                                  06300089
063100 EJECT                                                            06310089
063200*---------------------------------------------------------------- 06320089
063300*    READ THE PO-ACCOUNT-ACT-FILE INTO COPYBOOK APRD068.          06330089
063400*---------------------------------------------------------------- 06340089
063500 R200-READ-ACTIVITY-FILE.                                         06350089
063600                                                                  06360089
063700     MOVE 'R200-READ-ACTIVITY-FILE' TO                            06370089
063800                             PV-CURRENT-PARAGRAPH.                06380089
063900                                                                  06390089
064000     READ PO-ACCOUNT-ACT-FILE INTO AP068-RECORD                   06400089
064100         AT END                                                   06410089
064200             MOVE ALL '9' TO AP068-RECORD                         06420089
064300             SET PS-END-ACTIVITY TO TRUE.                         06430089
064400                                                                  06440089
064500     IF PS-MORE-ACTIVITY                                          06450089
064600        ADD 1 TO PV-ACTIVITY-COUNT                                06460089
064700     END-IF.                                                      06470089
064800                                                                  06480089
064900 EJECT                                                            06490089
065000*----------------------------------------------------------------*06500089
065100*    SELECT CHECKPOINT RESTART CONTROL INFO.                     *06510089
065200*----------------------------------------------------------------*06520089
065300 R400-GET-CHECKPOINT-CNTL.                                        06530089
065400                                                                  06540089
065500     MOVE 'R400-GET-CHECKPOINT-CNTL' TO PV-CURRENT-PARAGRAPH.     06550089
065600                                                                  06560089
065700     PERFORM WITH TEST AFTER                                      06570089
065800             VARYING PC-RETRY-COUNT FROM 1 BY 1                   06580089
065900             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             06590089
066000                     SQLCODE = ZERO                               06600089
066100                                                                  06610089
066200             EXEC SQL                                             06620089
066300              SELECT CKPT_STAT_CODE                               06630089
066400               INTO :PV-CKPT-STAT-CODE                            06640089
066500               FROM TCKRSTCNTL                                    06650089
066600               WHERE PLAN_NAME = :PC-PROGRAM-NAME                 06660089
066700             END-EXEC                                             06670089
066800                                                                  06680089
066900             EVALUATE TRUE                                        06690089
067000                 WHEN SQLCODE = ZERO                              06700089
067100                 WHEN SQLCODE = -904                              06710089
067200                 WHEN SQLCODE = -913                              06720089
067300                      CONTINUE                                    06730089
067400                                                                  06740089
067500                 WHEN SQLWARN0 NOT = SPACES                       06750089
067600                 WHEN SQLCODE  NOT = ZERO                         06760089
067700                     MOVE PV-CURRENT-PARAGRAPH                    06770089
067800                                         TO AA-PARAGRAPH-NAME     06780089
067900                     DISPLAY '******** PLAN_NAME:'                06790089
068000                              PC-WS-PROGRAM                       06800089
068100                     MOVE 'UNSUCCESSFUL SELECT'                   06810089
068200                                         TO AA-DB2-OPERATION      06820089
068300                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE-1        06830089
068400                     MOVE SPACES         TO AA-DB2-TABLE-2        06840089
068500                                            AA-DB2-TABLE-3        06850089
068600                     PERFORM Z999-DB2-ABEND                       06860089
068700             END-EVALUATE                                         06870089
068800     END-PERFORM.                                                 06880089
068900                                                                  06890089
069000     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06900089
069100         MOVE PV-CURRENT-PARAGRAPH                                06910089
069200                             TO AA-PARAGRAPH-NAME                 06920089
069300         DISPLAY '******** PLAN_NAME:'                            06930089
069400                  PC-PROGRAM-NAME                                 06940089
069500         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    06950089
069600                             TO AA-DB2-OPERATION                  06960089
069700         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE-1                    06970089
069800         PERFORM Z999-DB2-ABEND                                   06980089
069900     END-IF.                                                      06990089
070000                                                                  07000089
070100 EJECT                                                            07010089
070200*----------------------------------------------------------------*07020089
070300*    SELECT CHECKPOINT RESTART WORKING STORAGE DESCRIPTION INFO.  07030089
070400*----------------------------------------------------------------*07040089
070500 R500-GET-CHECKPOINT-INFO.                                        07050089
070600                                                                  07060089
070700     MOVE 'R500-GET-CHECKPOINT-INFO' TO PV-CURRENT-PARAGRAPH.     07070089
070800                                                                  07080089
070900     PERFORM WITH TEST AFTER                                      07090089
071000             VARYING PC-RETRY-COUNT FROM 1 BY 1                   07100089
071100             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             07110089
071200                     SQLCODE = ZERO                               07120089
071300                                                                  07130089
071400             EXEC SQL                                             07140089
071500              SELECT WORK_STRG_DESC                               07150089
071600               INTO :TCKRSTINF-WORK-STRG-DESC                     07160089
071700               FROM TCKRSTINF                                     07170089
071800               WHERE PLAN_NAME = :PC-PROGRAM-NAME                 07180089
071900             END-EXEC                                             07190089
072000                                                                  07200089
072100             EVALUATE TRUE                                        07210089
072200                 WHEN SQLCODE = ZERO                              07220089
072300                 WHEN SQLCODE = -904                              07230089
072400                 WHEN SQLCODE = -913                              07240089
072500                      CONTINUE                                    07250089
072600                                                                  07260089
072700                 WHEN SQLWARN0 NOT = SPACES                       07270089
072800                 WHEN SQLCODE  NOT = ZERO                         07280089
072900                     MOVE PV-CURRENT-PARAGRAPH                    07290089
073000                                         TO AA-PARAGRAPH-NAME     07300089
073100                     DISPLAY '******** PLAN_NAME:'                07310089
073200                              PC-PROGRAM-NAME                     07320089
073300                     MOVE 'UNSUCCESSFUL SELECT'                   07330089
073400                                         TO AA-DB2-OPERATION      07340089
073500                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE-1        07350089
073600                     MOVE SPACES         TO AA-DB2-TABLE-2        07360089
073700                                            AA-DB2-TABLE-3        07370089
073800                     PERFORM Z999-DB2-ABEND                       07380089
073900             END-EVALUATE                                         07390089
074000     END-PERFORM.                                                 07400089
074100                                                                  07410089
074200     IF PC-RETRY-COUNT > PC-RETRY-MAX                             07420089
074300         MOVE PV-CURRENT-PARAGRAPH                                07430089
074400                             TO AA-PARAGRAPH-NAME                 07440089
074500         DISPLAY '******** PLAN_NAME:'                            07450089
074600                  PC-PROGRAM-NAME                                 07460089
074700         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    07470089
074800                             TO AA-DB2-OPERATION                  07480089
074900         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE-1                    07490089
075000         MOVE SPACES         TO AA-DB2-TABLE-2                    07500089
075100                                AA-DB2-TABLE-3                    07510089
075200         PERFORM Z999-DB2-ABEND                                   07520089
075300     END-IF.                                                      07530089
075400                                                                  07540089
075500 EJECT                                                            07550089
075600*---------------------------------------------------------------- 07560089
075700*    RETRIEVES THE PREVIOUS AND CURRENT WEEK ENDING DATES FROM    07570089
075800*    THE AP CONTROL TABLE.  THE PREVIOUS WEEK ENDING DATE WILL    07580089
075900*    BE USED IN THE IMP_BAL_CSR TO FETCH ALL ROWS THAT WERE       07590089
076000*    USED ON THE PREVIOUS WEEK'S REPORTS.  THE CURRENT WEEK       07600089
076100*    ENDING DATE WILL BE USED FOR THE PERD_END_DTE WHEN INSERTING 07610089
076200*    NEW ROWS INTO TIMPBAL.                                       07620089
076300*---------------------------------------------------------------- 07630089
076400 S100-SELECT-AP-CONTROL.                                          07640089
076500                                                                  07650089
076600     MOVE 'S100-SELECT-AP-CONTROL' TO PV-CURRENT-PARAGRAPH.       07660089
076700                                                                  07670089
076800     EXEC SQL                                                     07680089
076900         SELECT PREV_WK_END_DTE                                   07690089
077000               ,CURR_WK_END_DTE                                   07700089
077100         INTO   :APCNTL-PREV-WK-END-DTE                           07710089
077200               ,:APCNTL-CURR-WK-END-DTE                           07720089
077300         FROM TAPCNTL                                             07730089
077400     END-EXEC.                                                    07740089
077500                                                                  07750089
077600     EVALUATE TRUE                                                07760089
077700         WHEN SQLCODE = ZERO                                      07770089
077800              CONTINUE                                            07780089
077900                                                                  07790089
078000         WHEN SQLWARN0 NOT = SPACES                               07800089
078100         WHEN SQLCODE  NOT = ZERO                                 07810089
078200         MOVE PV-CURRENT-PARAGRAPH                                07820089
078300                            TO AA-PARAGRAPH-NAME                  07830089
078400         MOVE 'UNSUCCESSFUL SELECT OF PAYMENT CONTROL TBL'        07840089
078500                            TO AA-DB2-OPERATION                   07850089
078600         MOVE 'TAPCNTL'     TO AA-DB2-TABLE-1                     07860089
078700         MOVE SPACES        TO AA-DB2-TABLE-2                     07870089
078800                               AA-DB2-TABLE-3                     07880089
078900                                                                  07890089
079000         PERFORM Z999-DB2-ABEND                                   07900089
079100     END-EVALUATE.                                                07910089
079200                                                                  07920089
079300 EJECT                                                            07930089
079400*---------------------------------------------------------------- 07940089
079500*  CREATE A NEW ROW ON TIMPBAL FOR THE PO/ACCOUNT NUMBER FOR      07950089
079600*  THE NEW PERIOD.                                                07960089
079700*---------------------------------------------------------------- 07970089
079800 U200-INSERT-TIMPBAL-ROW.                                         07980089
079900                                                                  07990089
080000     MOVE 'U200-INSERT-TIMPBAL-ROW' TO PV-CURRENT-PARAGRAPH.      08000089
080100                                                                  08010089
080200     INITIALIZE DCLTIMPBAL.                                       08020089
080300                                                                  08030089
080400     PERFORM WITH TEST AFTER                                      08040089
080500             VARYING PC-RETRY-COUNT FROM 1 BY 1                   08050089
080600             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             08060089
080700                     SQLCODE = ZERO                               08070089
080800                                                                  08080089
080900             EXEC SQL                                             08090089
081000                 INSERT INTO TIMPBAL                              08100089
081100                         (PO_NBR                                  08110089
081200                        , GL_ACCT_NBR                             08120089
081300                        , PERD_END_DTE                            08130089
081400                        , BOP_BAL_AMT                             08140089
081500                        , EOP_BAL_AMT                             08150089
081600                        , DR_ACTVY_AMT                            08160089
081700                        , CR_ACTVY_AMT                            08170089
081800                        , AGE_30DAY_AMT                           08180089
081900                        , AGE_60DAY_AMT                           08190089
082000                        , AGE_90DAY_AMT                           08200089
082100                        , AGE_120DAY_AMT                          08210089
082200                        , AGE_OVR_120DAY_AMT)                     08220089
082300                 VALUES  (:PV-PO-NBR-COMP                         08230089
082400                        , :PV-GL-ACCT-NBR                         08240089
082500                        , :PV-PERD-END-DTE                        08250089
082600                        , :PV-BOP-BAL-AMT                         08260089
082700                        , :PV-EOP-BAL-AMT                         08270089
082800                        , :PV-DR-ACTVY-AMT                        08280089
082900                        , :PV-CR-ACTVY-AMT                        08290089
083000                        , :PV-AGE-30DAY-AMT                       08300089
083100                        , :PV-AGE-60DAY-AMT                       08310089
083200                        , :PV-AGE-90DAY-AMT                       08320089
083300                        , :PV-AGE-120DAY-AMT                      08330089
083400                        , :PV-AGE-OVR-120DAY-AMT)                 08340089
083500             END-EXEC                                             08350089
083600                                                                  08360089
083700             EVALUATE TRUE                                        08370089
083800                 WHEN SQLCODE = ZERO                              08380089
083900                      ADD 1 TO PV-INSERT-COUNT                    08390089
084000                 WHEN SQLCODE = -904                              08400089
084100                 WHEN SQLCODE = -913                              08410089
084200                      CONTINUE                                    08420089
084300                                                                  08430089
084400                 WHEN SQLWARN0 NOT = SPACES                       08440089
084500                 WHEN SQLCODE  NOT = ZERO                         08450089
084600                     MOVE PV-CURRENT-PARAGRAPH                    08460089
084700                                         TO AA-PARAGRAPH-NAME     08470089
084800                     MOVE 'UNSUCCESSFUL INSERT'                   08480089
084900                                         TO AA-DB2-OPERATION      08490089
085000                     MOVE 'TIMPBAL'      TO AA-DB2-TABLE-1        08500089
085100                     MOVE SPACES         TO AA-DB2-TABLE-2        08510089
085200                                            AA-DB2-TABLE-3        08520089
085300                     PERFORM Z999-DB2-ABEND                       08530089
085400             END-EVALUATE                                         08540089
085500     END-PERFORM.                                                 08550089
085600                                                                  08560089
085700     IF PC-RETRY-COUNT > PC-RETRY-MAX                             08570089
085800         MOVE PV-CURRENT-PARAGRAPH                                08580089
085900                             TO AA-PARAGRAPH-NAME                 08590089
086000         MOVE 'MAX RETRIES EXCEEDED ON INSERT'                    08600089
086100                             TO AA-DB2-OPERATION                  08610089
086200         MOVE 'TIMPBAL'      TO AA-DB2-TABLE-1                    08620089
086300         MOVE SPACES         TO AA-DB2-TABLE-2                    08630089
086400                                AA-DB2-TABLE-3                    08640089
086500         PERFORM Z999-DB2-ABEND                                   08650089
086600     END-IF.                                                      08660089
086700                                                                  08670089
086800     EVALUATE TRUE                                                08680089
086900         WHEN SQLCODE = ZEROS                                     08690089
087000              CONTINUE                                            08700089
087100         WHEN OTHER                                               08710089
087200             MOVE PV-CURRENT-PARAGRAPH                            08720089
087300                                 TO AA-PARAGRAPH-NAME             08730089
087400             MOVE 'UNSUCCESSFUL INSERT'                           08740089
087500                                 TO AA-DB2-OPERATION              08750089
087600             MOVE 'TIMPBAL'      TO AA-DB2-TABLE-1                08760089
087700             MOVE SPACES         TO AA-DB2-TABLE-2                08770089
087800                                    AA-DB2-TABLE-3                08780089
087900             PERFORM Z999-DB2-ABEND                               08790089
088000     END-EVALUATE.                                                08800089
088100                                                                  08810089
088200 EJECT                                                            08820089
088300*----------------------------------------------------------------*08830089
088400*    UPDATES THE CHECKPOINT RESTART CONTROL TABLE.  THE STATUS   *08840089
088500*    CODE IS SET TO '9' (RUN IN PROGRESS) OR '0' (RUN COMPLETE). *08850089
088600*----------------------------------------------------------------*08860089
088700 U500-UPDATE-TCKRSTCNTL.                                          08870089
088800                                                                  08880089
088900     MOVE 'U500-UPDATE-TCKRSTCNTL' TO PV-CURRENT-PARAGRAPH.       08890089
089000                                                                  08900089
089100     PERFORM WITH TEST AFTER                                      08910089
089200             VARYING PC-RETRY-COUNT FROM 1 BY 1                   08920089
089300             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             08930089
089400                     SQLCODE = ZERO                               08940089
089500                                                                  08950089
089600             EXEC SQL                                             08960089
089700                 UPDATE TCKRSTCNTL                                08970089
089800                 SET CKPT_STAT_CODE = :PV-CKPT-STAT-CODE          08980089
089900                 WHERE PLAN_NAME      = :PC-PROGRAM-NAME          08990089
090000             END-EXEC                                             09000089
090100                                                                  09010089
090200             EVALUATE TRUE                                        09020089
090300                 WHEN SQLCODE = ZERO                              09030089
090400                 WHEN SQLCODE = -904                              09040089
090500                 WHEN SQLCODE = -913                              09050089
090600                      CONTINUE                                    09060089
090700                                                                  09070089
090800                 WHEN SQLWARN0 NOT = SPACES                       09080089
090900                 WHEN SQLCODE  NOT = ZERO                         09090089
091000                     MOVE PV-CURRENT-PARAGRAPH                    09100089
091100                                         TO AA-PARAGRAPH-NAME     09110089
091200                     DISPLAY '******** PLAN_NAME:'                09120089
091300                              PC-PROGRAM-NAME                     09130089
091400                     MOVE 'UNSUCCESSFUL UPDATE'                   09140089
091500                                         TO AA-DB2-OPERATION      09150089
091600                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE-1        09160089
091700                     MOVE SPACES         TO AA-DB2-TABLE-2        09170089
091800                                            AA-DB2-TABLE-3        09180089
091900                     PERFORM Z999-DB2-ABEND                       09190089
092000             END-EVALUATE                                         09200089
092100     END-PERFORM.                                                 09210089
092200                                                                  09220089
092300     IF PC-RETRY-COUNT > PC-RETRY-MAX                             09230089
092400         MOVE PV-CURRENT-PARAGRAPH                                09240089
092500                             TO AA-PARAGRAPH-NAME                 09250089
092600         DISPLAY '******** PLAN_NAME:'                            09260089
092700                  PC-PROGRAM-NAME                                 09270089
092800         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    09280089
092900                             TO AA-DB2-OPERATION                  09290089
093000         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE-1                    09300089
093100         MOVE SPACES         TO AA-DB2-TABLE-2                    09310089
093200                                AA-DB2-TABLE-3                    09320089
093300         PERFORM Z999-DB2-ABEND                                   09330089
093400     END-IF.                                                      09340089
093500                                                                  09350089
093600     EJECT                                                        09360089
093700*----------------------------------------------------------------*09370089
093800*    UPDATES THE CHECKPOINT RESTART INFO TABLE.  THE WORKING     *09380089
093900*    STORAGE DESCRIPTION FIELD IS UPDATED WITH THE CURRENT INPUT *09390089
094000*    FILE RECORD COUNTS AND THE FILE PROCESSOR INDICATOR.        *09400089
094100*----------------------------------------------------------------*09410089
094200 U600-UPDATE-TCKRSTINF.                                           09420089
094300                                                                  09430089
094400     MOVE 'U600-UPDATE-TCKRSTINF' TO PV-CURRENT-PARAGRAPH.        09440089
094500                                                                  09450089
094600     MOVE PS-COMPARE-SW      TO CR-COMPARE-SW.                    09460089
094700     MOVE PV-CSR-PO-NBR      TO CR-CSR-PO-NBR.                    09470089
094800     MOVE PV-CSR-GL-ACCT-NBR TO CR-CSR-GL-ACCT-NBR.               09480089
094900     MOVE AP068-PO-NBR       TO CR-PO-NBR.                        09490089
095000     MOVE AP068-GL-ACCT-NBR  TO CR-GL-ACCT-NBR.                   09500089
095100     MOVE PV-IMP-BAL-COUNT   TO CR-IMP-BAL-COUNT.                 09510089
095200     MOVE PV-ACTIVITY-COUNT  TO CR-ACTIVITY-COUNT.                09520089
095300     MOVE PV-INSERT-COUNT    TO CR-INSERT-COUNT.                  09530089
095400     MOVE CKPT-RESTART-INFO  TO TCKRSTINF-WORK-STRG-DESC-TEXT.    09540089
095500     MOVE 4022               TO TCKRSTINF-WORK-STRG-DESC-LEN.     09550089
095600                                                                  09560089
095700     PERFORM WITH TEST AFTER                                      09570089
095800             VARYING PC-RETRY-COUNT FROM 1 BY 1                   09580089
095900             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             09590089
096000                     SQLCODE = ZERO                               09600089
096100                                                                  09610089
096200             EXEC SQL                                             09620089
096300                 UPDATE TCKRSTINF                                 09630089
096400                 SET WORK_STRG_DESC   = :TCKRSTINF-WORK-STRG-DESC 09640089
096500                 WHERE PLAN_NAME      = :PC-PROGRAM-NAME          09650089
096600             END-EXEC                                             09660089
096700                                                                  09670089
096800             EVALUATE TRUE                                        09680089
096900                 WHEN SQLCODE = ZERO                              09690089
097000                 WHEN SQLCODE = -904                              09700089
097100                 WHEN SQLCODE = -913                              09710089
097200                      CONTINUE                                    09720089
097300                                                                  09730089
097400                 WHEN SQLWARN0 NOT = SPACES                       09740089
097500                 WHEN SQLCODE  NOT = ZERO                         09750089
097600                     MOVE PV-CURRENT-PARAGRAPH                    09760089
097700                                         TO AA-PARAGRAPH-NAME     09770089
097800                     DISPLAY '******** PLAN_NAME:'                09780089
097900                              PC-PROGRAM-NAME                     09790089
098000                     MOVE 'UNSUCCESSFUL UPDATE'                   09800089
098100                                         TO AA-DB2-OPERATION      09810089
098200                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE-1        09820089
098300                     MOVE SPACES         TO AA-DB2-TABLE-2        09830089
098400                                            AA-DB2-TABLE-3        09840089
098500                     PERFORM Z999-DB2-ABEND                       09850089
098600             END-EVALUATE                                         09860089
098700     END-PERFORM.                                                 09870089
098800                                                                  09880089
098900     IF PC-RETRY-COUNT > PC-RETRY-MAX                             09890089
099000         MOVE PV-CURRENT-PARAGRAPH                                09900089
099100                             TO AA-PARAGRAPH-NAME                 09910089
099200         DISPLAY '******** PLAN_NAME:'                            09920089
099300                  PC-PROGRAM-NAME                                 09930089
099400         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    09940089
099500                             TO AA-DB2-OPERATION                  09950089
099600         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE-1                    09960089
099700         MOVE SPACES         TO AA-DB2-TABLE-2                    09970089
099800                                AA-DB2-TABLE-3                    09980089
099900         PERFORM Z999-DB2-ABEND                                   09990089
100000     END-IF.                                                      10000089
100100                                                                  10010089
100200 EJECT                                                            10020089
100300*----------------------------------------------------------------*10030089
100400*    COMMITS DB2 UPDATES FOR THE PO PROCESSED.                   *10040089
100500*----------------------------------------------------------------*10050089
100600 U700-COMMIT.                                                     10060089
100700                                                                  10070089
100800     MOVE 'U700-COMMIT'         TO PV-CURRENT-PARAGRAPH.          10080089
100900                                                                  10090089
101000     EXEC SQL                                                     10100089
101100         COMMIT                                                   10110089
101200     END-EXEC.                                                    10120089
101300                                                                  10130089
101400     EVALUATE TRUE                                                10140089
101500         WHEN SQLCODE = ZEROS                                     10150089
101600              CONTINUE                                            10160089
101700         WHEN OTHER                                               10170089
101800             MOVE PV-CURRENT-PARAGRAPH                            10180089
101900                                 TO AA-PARAGRAPH-NAME             10190089
102000             MOVE 'UNSUCCESSFUL COMMIT'                           10200089
102100                                 TO AA-DB2-OPERATION              10210089
102200             MOVE SPACES         TO AA-DB2-TABLE-1                10220089
102300                                    AA-DB2-TABLE-2                10230089
102400                                    AA-DB2-TABLE-3                10240089
102500             PERFORM Z999-DB2-ABEND                               10250089
102600     END-EVALUATE.                                                10260089
102700                                                                  10270089
102800 EJECT                                                            10280089
102900*---------------------------------------------------------------- 10290089
103000*    OPENS THE IMPORT BALANCE CURSOR.                             10300089
103100*---------------------------------------------------------------- 10310089
103200 X100-OPEN-IMP-BAL-CSR.                                           10320089
103300                                                                  10330089
103400     MOVE 'X100-OPEN-IMP-BAL-CSR '      TO PV-CURRENT-PARAGRAPH.  10340089
103500                                                                  10350089
103600     EXEC SQL                                                     10360089
103700         OPEN IMP_BAL_CSR                                         10370089
103800     END-EXEC.                                                    10380089
103900                                                                  10390089
104000     EVALUATE TRUE                                                10400089
104100         WHEN SQLCODE = ZERO                                      10410089
104200              CONTINUE                                            10420089
104300                                                                  10430089
104400         WHEN SQLWARN0 NOT = SPACES                               10440089
104500         WHEN SQLCODE  NOT = ZERO                                 10450089
104600             MOVE PV-CURRENT-PARAGRAPH                            10460089
104700                                TO AA-PARAGRAPH-NAME              10470089
104800             MOVE 'UNSUCCESSFUL OPEN ON IMP_BAL_CSR'              10480089
104900                                TO AA-DB2-OPERATION               10490089
105000             MOVE 'TIMPBAL'     TO AA-DB2-TABLE-1                 10500089
105100             MOVE 'TPAYREQ'     TO AA-DB2-TABLE-2                 10510089
105200             MOVE SPACES        TO AA-DB2-TABLE-3                 10520089
105300             PERFORM Z999-DB2-ABEND                               10530089
105400     END-EVALUATE.                                                10540089
105500                                                                  10550089
105600 EJECT                                                            10560089
105700*---------------------------------------------------------------- 10570089
105800*    CLOSES THE IMPORT BALANCE CURSOR.                            10580089
105900*---------------------------------------------------------------- 10590089
106000 Y100-CLOSE-IMP-BAL-CSR.                                          10600089
106100                                                                  10610089
106200     MOVE 'Y100-CLOSE-IMP-BAL-CSR'       TO PV-CURRENT-PARAGRAPH. 10620089
106300                                                                  10630089
106400     EXEC SQL                                                     10640089
106500         CLOSE IMP_BAL_CSR                                        10650089
106600     END-EXEC.                                                    10660089
106700                                                                  10670089
106800     EVALUATE TRUE                                                10680089
106900         WHEN SQLCODE = ZERO                                      10690089
107000              CONTINUE                                            10700089
107100                                                                  10710089
107200         WHEN SQLWARN0 NOT = SPACES                               10720089
107300         WHEN SQLCODE  NOT = ZERO                                 10730089
107400             MOVE PV-CURRENT-PARAGRAPH                            10740089
107500                                   TO AA-PARAGRAPH-NAME           10750089
107600             MOVE 'UNSUCCESSFUL CLOSE OF IMP_BAL_CSR'             10760089
107700                                   TO AA-DB2-OPERATION            10770089
107800             MOVE 'TIMPBAL'        TO AA-DB2-TABLE-1              10780089
107900             MOVE 'TPAYREQ'        TO AA-DB2-TABLE-2              10790089
108000             MOVE SPACES           TO AA-DB2-TABLE-3              10800089
108100             PERFORM Z999-DB2-ABEND                               10810089
108200     END-EVALUATE.                                                10820089
108300                                                                  10830089
108400 EJECT                                                            10840089
108500*---------------------------------------------------------------- 10850089
108600*    ABEND ROUTINE FOR DB2 ERRORS.                                10860089
108700*---------------------------------------------------------------- 10870089
108800 Z999-DB2-ABEND.                                                  10880089
108900                                                                  10890089
109000     CLOSE PO-ACCOUNT-ACT-FILE.                                   10900089
109100                                                                  10910089
109200     DISPLAY '** CURSOR PO/ACCT NBR BEING PROCESSED = '           10920089
109300                                         PV-CSR-PO-ACCT.          10930089
109400     DISPLAY '** AP068 PO/ACCT NBR BEING PROCESSED= '             10940089
109500                                         AP068-PO-ACCT.           10950089
109600     DISPLAY '** COMPARE SWITCH VALUE= ' PS-COMPARE-SW.           10960089
109700     DISPLAY AA-ABEND-LIT.                                        10970089
109800     DISPLAY AA-DB2-ERROR-LIT.                                    10980089
109900     DISPLAY AA-PROGRAM-LIT.                                      10990089
110000     DISPLAY AA-PARAGRAPH-LIT.                                    11000089
110100     DISPLAY AA-DB2-OPERATION-LIT.                                11010089
110200     DISPLAY AA-DB2-TABLE-1.                                      11020089
110300     DISPLAY AA-DB2-TABLE-2.                                      11030089
110400     DISPLAY AA-DB2-TABLE-3.                                      11040089
110500     SET AC-DB2-ERROR TO TRUE.                                    11050089
110600                                                                  11060089
110700     COPY DPPD004.                                                11070089
110800                                                                  11080089
110900     CALL 'ILBOABN0' USING ABEND-CODE.                            11090089
