      ****************************************************************  00010000
       IDENTIFICATION DIVISION.                                         00020000
      ****************************************************************  00030000
       PROGRAM-ID.      FSKUP888.                                       00040000
       AUTHOR.          COGNIZANT.                                      00050000
       INSTALLATION.    KOHLS DEPARTMENT STORES.                        00060000
       DATE-WRITTEN.    09/28/11.                                       00070000
       DATE-COMPILED.                                                   00080000
      ****************************************************************  00090000
       ENVIRONMENT DIVISION.                                            00100000
      ****************************************************************  00110000
                                                                        00120000
       CONFIGURATION SECTION.                                           00130000
       SOURCE-COMPUTER. IBM-3090.                                       00140000
       OBJECT-COMPUTER. IBM-3090.                                       00150000
                                                                        00160000
       INPUT-OUTPUT SECTION.                                            00170000
       FILE-CONTROL.                                                    00180000
                                                                        00190000
           SELECT INPUT-FILE                                            00200000
               ASSIGN                       TO INP01.                   00210000
           EJECT                                                        00220000
                                                                        00230000
      ****************************************************************  00240000
       DATA DIVISION.                                                   00250000
      ****************************************************************  00260000
                                                                        00270000
       FILE SECTION.                                                    00280000
                                                                        00290000
       FD  INPUT-FILE                                                   00300000
           RECORDING MODE F                                             00310000
           BLOCK CONTAINS 0 RECORDS                                     00320000
           RECORD CONTAINS 14 CHARACTERS                                00330000
           LABEL RECORDS ARE OMITTED                                    00340000
           DATA RECORD IS INPUT-REC.                                    00350000
                                                                        00360000
       01 INPUT-FILE-REC                         PIC X(14).             00370000
                                                                        00380000
           EJECT                                                        00390000
                                                                        00400000
       WORKING-STORAGE SECTION.                                         00410000
                                                                        00420000
           EJECT                                                        00430000
       01 INPUT-REC.                                                    00440000
          05 PV-ITEM-NMBR                 PIC  S9(15)V COMP-3.          00450000
          05 PV-STR-NBR                   PIC  S9(4) COMP.              00460000
          05 PV-SALES-UNIT-QTY            PIC  S9(7)V COMP-3.           00470000
                                                                        00490000
       01 PV-PARAGRAPH-NAME         PIC X(30)     VALUE SPACES.         00500000
       01 PV-PROGRAM-VARIABLES.                                         00510000
017800     05  PV-DB2-OPERATION-ATTEMPTED                               00520000
017900                                   PIC X(30)     VALUE SPACES.    00530000
018000     05  PV-COMMIT-TIMESTAMP       PIC X(26)     VALUE SPACES.    00531000
018100     05  PV-CURRENT-TIMESTAMP      PIC X(26)     VALUE SPACES.    00532000
           05  PV-PREV-ITM-NBR           PIC S9(15)V   VALUE +0 COMP-3. 00540000
           05  PV-ITEM-NBR-HOLD          PIC S9(15)V   VALUE +0 COMP-3. 00550000
           05  PV-ITEM-TOT-RCPT-QTY      PIC S9(11)    VALUE +0 COMP-3. 00560000
           05  PV-ITEM-TOT-SLD-QTY       PIC S9(11)    VALUE +0 COMP-3. 00570000
           05  PV-ITEM-TOT-CHRGD-AMT     PIC S9(11)V99 VALUE +0 COMP-3. 00580000
013100     05  PV-FILE-READ-CNT   PIC S9(09)    VALUE +0 COMP-3.        00590000
013400     05  PV-TSKST-READ-CNT     PIC S9(09)    VALUE +0 COMP-3.     00600000
013600     05  PV-LOC-TSKST-UPDT-CNT PIC S9(09)    VALUE +0 COMP-3.     00610000
013700     05  PV-000-TSKST-UPDT-CNT PIC S9(09)    VALUE +0 COMP-3.     00620000
           05  PV-DISPLAY-COUNT         PIC ZZZ,ZZZ,ZZ9                 00630000
                                                       VALUE ZEROES.    00640000
           05  PV-RETRY-CNT              PIC S9(04)    VALUE +0.        00650000
                                                                        00660000
       01  PC-PROGRAM-CONSTANTS.                                        00670000
010500     05  PC-PROGRAM-NAME           PIC X(08)     VALUE 'FSKUP004'.00671000
010600     05  PC-JOB-NAME               PIC X(08)     VALUE 'FSK148  '.00672000
           05  PC-MAX-RETRY-CNT          PIC S9(04)    VALUE  3         00690000
                                                       COMP SYNC.       00700000
           05  PC-MORE-THAN-MAX-RETRY    PIC S9(04)    VALUE  4         00710000
                                                       COMP SYNC.       00720000
       01 PS-END-FILE-SW                  PIC X(1) VALUE 'N'.           00730000
          88 PS-END-FILE                           VALUE 'Y'.           00740000
                                                                        00750000
017000 01  PS-FIRST-COMMIT-SW             PIC X(1) VALUE 'N'.           00751000
017100    88  PS-FIRST-COMMIT                      VALUE 'Y'.           00752000
                                                                        00753000
       01 PS-REC-FND-SW                   PIC X(1) VALUE 'N'.           00760000
          88 PS-REC-NOT-FND                        VALUE 'Y'.           00770000
                                                                        00780000
       01  ABEND-CODE                     PIC S9(04)   VALUE ZERO       00790000
                                                       COMP             00800000
                                                       SYNC.            00810000
                                                                        00820000
       01  WS-SUM-TOT-SLD-QTY        PIC S9(09)    VALUE +0 COMP-3.     00830000
       01  WS-SUM-TOT-CHRGD-AMT      PIC S9(9)V99  VALUE +0 COMP-3.     00840000
                                                                        00840100
012700 01  CR-CHECKPOINT-RESTART-AREA.                                  00841000
012800     05  CR-AREA-LEN               PIC S9(04)    VALUE +24  COMP. 00842000
           05  CR-CHECKPOINT-RESTART-VAR.                               00842100
               10  CR-ITEM-NMBR             PIC S9(15)V COMP-3.         00842404
               10  CR-STR-NBR               PIC S9(4)   COMP.           00842504
               10  CR-COMMIT-CNT            PIC S9(09)  COMP-3.         00842604
               10  CR-INPUT-READ-COUNT      PIC  9(09)  VALUE ZEROES.   00842800
      *                                                                 00842900
015000                                                                  00850500
           EJECT                                                        00851000
      ******************************************************************00860000
      *  DCLGEN MEMBER FOR TABLE TSKST                                  00870000
      ******************************************************************00880000
           EXEC SQL                                                     00890000
               INCLUDE TSKST                                            00900000
           END-EXEC.                                                    00910000
                                                                        00920000
027100******************************************************************00921000
027200*  DCLGEN FOR CHECKPOINT RESTART CONTROL TABLE                    00922000
027300******************************************************************00923000
027400     EXEC SQL                                                     00924000
027500         INCLUDE TCKRSTCN                                         00925000
027600     END-EXEC.                                                    00926000
027700                                                                  00927000
027800******************************************************************00928000
027900*  DCLGEN FOR CHECKPOINT RESTART INFORMATION TABLE                00929000
028000******************************************************************00929100
028100     EXEC SQL                                                     00929200
028200         INCLUDE TCKRSTIN                                         00929300
028300     END-EXEC.                                                    00929400
028400                                                                  00929500
      ******************************************************************00930000
      *  COMMUNICATIONS AREA FOR DB2                                    00940000
      ******************************************************************00950000
           EXEC SQL                                                     00960000
               INCLUDE SQLCA                                            00970000
           END-EXEC.                                                    00980000
                                                                        00990000
      ******************************************************************01000000
      *  SQL ERROR AREA                                                 01010000
      ******************************************************************01020000
           COPY DPWS004.                                                01030000
                                                                        01040000
           COPY SQLCA2.                                                 01050000
      ****************************************************************  01060000
       PROCEDURE DIVISION.                                              01070000
      ****************************************************************  01080000
       A100-MAINLINE-PROCESSING.                                        01090000
           OPEN INPUT INPUT-FILE.                                       01100000
                                                                        01110000
           INITIALIZE DCLTSKST                                          01120000
                      DCLTCKRSTCNTL                                     01121000
                      DCLTCKRSTINF.                                     01122000
           MOVE 'N' TO PS-END-FILE-SW.                                  01130000
           MOVE 'N' TO PS-REC-FND-SW.                                   01140000
                                                                        01141303
040300     PERFORM 8000-INIT-CHECKPOINT-SELECT.                         01142000
040400                                                                  01143000
040500******************************************************************01144000
040600*  IF THE PROGRAM IS IN A RESTART STATUS, SELECT SAVED DATA       01145000
040700*  FROM THE RESTART INFO TABLE.                                   01146000
040800******************************************************************01147000
040900     IF  TCKRSTCNTL-CKPT-STAT-CODE = '9'                          01148000
041000         PERFORM 8100-SELECT-RESTART-INFO                         01149000
041100         MOVE TCKRSTINF-WORK-STRG-DESC-TEXT                       01149100
041200           TO CR-CHECKPOINT-RESTART-VAR                           01149200
041300         DISPLAY SPACES                                           01149400
041400         DISPLAY '** FSKUP888 IS BEING RESTARTED'                 01149500
               DISPLAY 'CHECKPOINT RESTART INFORMATION:'                01149600
               DISPLAY 'ITEM NUMBER     ' CR-ITEM-NMBR                  01149700
               DISPLAY 'STORE NUMBER    ' CR-STR-NBR                    01149800
               DISPLAY 'INPUT RECS READ ' CR-INPUT-READ-COUNT           01149900
041500     ELSE                                                         01150000
041600         SET PS-FIRST-COMMIT TO TRUE                              01150100
               INITIALIZE CR-ITEM-NMBR                                  01150204
                          CR-STR-NBR                                    01150304
                          CR-COMMIT-CNT                                 01150404
                          CR-INPUT-READ-COUNT                           01150504
041700     END-IF.                                                      01150600
041800                                                                  01150700
           PERFORM F100-READ-TRANSACTION                                01160100
               UNTIL PV-FILE-READ-CNT > CR-INPUT-READ-COUNT             01160200
            OR PS-END-FILE.                                             01160300
      *                                                                 01160400
           IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                           01160500
               DISPLAY 'INPUT FILE RESTARTED ON RECORD '                01160600
                        PV-FILE-READ-CNT                                01160700
               DISPLAY 'ITEM NUMBER     ' PV-ITEM-NMBR                  01160800
               DISPLAY 'STORE NUMBER    ' PV-STR-NBR                    01160900
               DISPLAY 'SALES UNIT QTY  ' PV-SALES-UNIT-QTY             01161100
           END-IF.                                                      01161200
                                                                        01161300
           IF PS-END-FILE                                               01161400
               IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                       01161500
                   CONTINUE                                             01161600
               ELSE                                                     01161700
                   DISPLAY '** NO RECORDS ON INPUT FILE **'             01161800
           ELSE                                                         01161900
               PERFORM 8400-GET-COMMIT-TIMESTAMP                        01162000
           END-IF.                                                      01162300
                                                                        01163000
           PERFORM B200-PROCESS-TRANSACTIONS                            01170000
                   UNTIL PS-END-FILE.                                   01180000
                                                                        01190000
           PERFORM 8600-COMMIT.                                         01190102
           MOVE '0' TO TCKRSTCNTL-CKPT-STAT-CODE.                       01191002
           PERFORM 8300-UPDATE-CHECKPOINT-STATUS.                       01192002
                                                                        01193002
           CLOSE INPUT-FILE.                                            01200000
                                                                        01210000
219900     DISPLAY SPACES.                                              01220000
220000     DISPLAY '****************************************'.          01230000
220100     DISPLAY '***** PROCESSING TOTALS *****'.                     01240000
220200     DISPLAY '****************************************'.          01250000
220300                                                                  01260000
220400     MOVE PV-FILE-READ-CNT        TO PV-DISPLAY-COUNT.            01270000
220500     DISPLAY 'NBR OF FETCHES FROM INPUT FILE             = '      01280000
220600                                     PV-DISPLAY-COUNT.            01290000
220700                                                                  01300000
220800     MOVE PV-TSKST-READ-CNT       TO PV-DISPLAY-COUNT.            01310000
220900     DISPLAY 'NBR OF TSKST SELECTS                       = '      01320000
221000                                     PV-DISPLAY-COUNT.            01330000
221100                                                                  01340000
221200     MOVE PV-LOC-TSKST-UPDT-CNT   TO PV-DISPLAY-COUNT.            01350000
221300     DISPLAY 'NBR OF TSKST ITM/LOC UPDATES               = '      01360000
221400                                     PV-DISPLAY-COUNT.            01370000
221500                                                                  01380000
221600     MOVE PV-000-TSKST-UPDT-CNT   TO PV-DISPLAY-COUNT.            01390000
221700     DISPLAY 'NBR OF TSKST STR 000 UPDATES               = '      01400000
221800                                     PV-DISPLAY-COUNT.            01410000
221900                                                                  01420000
                                                                        01430000
           GOBACK.                                                      01440000
                                                                        01450000
       F100-READ-TRANSACTION.                                           01460000
                                                                        01470000
           READ INPUT-FILE INTO INPUT-REC                               01480000
              AT END                                                    01490000
                  SET PS-END-FILE TO TRUE                               01490100
              NOT AT END                                                01491000
                  ADD  +1 TO PV-FILE-READ-CNT                           01500000
           END-READ.                                                    01501000
                                                                        01502000
       B200-PROCESS-TRANSACTIONS.                                       01510000
           MOVE PV-ITEM-NMBR         TO TSKST-ITEM-NMBR.                01530000
           MOVE PV-STR-NBR           TO TSKST-LOC-NBR.                  01540000
           MOVE PV-SALES-UNIT-QTY    TO WS-SUM-TOT-SLD-QTY.             01550000
           PERFORM B210-READ-TSKST.                                     01570000
           EVALUATE SQLCODE                                             01580000
               WHEN 000                                                 01590000
      ********      UPDATE THE SPECIFIC ITEM/STORE ROW                  01600000
                    PERFORM B220-FRMT-FOR-UPD                           01610000
                    PERFORM B230-UPD-TSKST                              01620000
               WHEN +100                                                01630000
                    DISPLAY 'NO RECORD FOUND FOR FOR ITM: ' PV-ITEM-NMBR01640000
                    DISPLAY 'STORE: ' PV-STR-NBR                        01650000
           END-EVALUATE.                                                01660000
                                                                        01670000
056600     PERFORM 8200-COMMIT-PROCESSING.                              01671000
056700                                                                  01672000
           PERFORM F100-READ-TRANSACTION.                               01680000
                                                                        01690000
      ******************************************************************01700000
      *  SELECT ONE ROW FROM TSKST FOR A SPECIFIC ITEM/STORE.           01710000
      *  THIS PARAGRAPH IS USED FOR PROCESSING SALES.                   01720000
      ******************************************************************01730000
       B210-READ-TSKST.                                                 01740000
                                                                        01750000
           PERFORM VARYING PV-RETRY-CNT FROM 1 BY 1                     01760000
               UNTIL PV-RETRY-CNT > PC-MAX-RETRY-CNT                    01770000
                                                                        01780000
             EXEC SQL                                                   01790000
                 SELECT                                                 01800000
                        YTD_SALES_UNIT_QTY                              01810000
                   INTO                                                 01830000
                        :TSKST-YTD-SALES-UNIT-QTY                       01840000
                   FROM TSKST                                           01860000
                  WHERE ITEM_NMBR  = :TSKST-ITEM-NMBR                   01870000
                    AND LOC_NBR    = :TSKST-LOC-NBR                     01880000
             END-EXEC                                                   01890000
                                                                        01900000
             EVALUATE TRUE                                              01910000
                 WHEN SQLWARN0 NOT = SPACES                             01920000
                      MOVE 'B210-READ-TSKST'                            01930000
                        TO  PV-PARAGRAPH-NAME                           01940000
                      MOVE 'READ TSKST RECORD'                          01950000
                        TO  PV-DB2-OPERATION-ATTEMPTED                  01960000
                      PERFORM 9999-SQL-ABEND                            01970000
                 WHEN SQLCODE = ZERO                                    01980000
                      ADD  +1 TO PV-TSKST-READ-CNT                      01990000
                      MOVE PC-MORE-THAN-MAX-RETRY TO PV-RETRY-CNT       02000000
                 WHEN SQLCODE = +100                                    02010000
      *               ADD  +1 TO PV-TSKST-READ-CNT                      02020000
                      MOVE PC-MORE-THAN-MAX-RETRY TO PV-RETRY-CNT       02030000
                 WHEN SQLCODE = -904                                    02040000
      *          WHEN SQLCODE = -911                                    02050000
                 WHEN SQLCODE = -913                                    02060000
                      CONTINUE                                          02070000
                 WHEN ANY                                               02080000
                      MOVE 'B210-READ-TSKST'                            02090000
                        TO  PV-PARAGRAPH-NAME                           02100000
                      MOVE 'READ TSKST RECORD'                          02110000
                        TO  PV-DB2-OPERATION-ATTEMPTED                  02120000
                      PERFORM 9999-SQL-ABEND                            02130000
             END-EVALUATE                                               02140000
                                                                        02150000
           END-PERFORM.                                                 02160000
                                                                        02170000
           IF  (SQLWARN0 NOT = SPACES                                   02180000
           OR  (SQLCODE > 0 AND SQLCODE NOT = +100)                     02190000
           OR   SQLCODE < 0)                                            02200000
               DISPLAY '**********************************'             02210000
               DISPLAY 'ITEM_NMBR  = ' TSKST-ITEM-NMBR                  02220000
               DISPLAY 'LOC_NBR = ' TSKST-LOC-NBR                       02230000
               DISPLAY '**********************************'             02240000
               MOVE 'B210-READ-TSKST'                                   02250000
                 TO  PV-PARAGRAPH-NAME                                  02260000
               MOVE 'MAX RETRIES EXCEEDED'                              02270000
                 TO  PV-DB2-OPERATION-ATTEMPTED                         02280000
               PERFORM 9999-SQL-ABEND                                   02290000
           END-IF.                                                      02300000
                                                                        02310000
      ******************************************************************02320000
      *  FORMAT THE SALES DATA TO UPDATE A SPECIFIC ITEM/STORE ROW      02330000
      *  ON TSKST.                                                      02340000
      ******************************************************************02350000
       B220-FRMT-FOR-UPD.                                               02360000
                                                                        02370000
           ADD WS-SUM-TOT-SLD-QTY   TO TSKST-YTD-SALES-UNIT-QTY.        02380000
                                                                        02400000
      ******************************************************************02410000
      *  UPDATE THE SPECIFIC ITEM/STORE ROW ON TSKST.                   02420000
      *  THIS PARAGRAPH IS USED FOR PROCESSING SALES.                   02430000
      ******************************************************************02440000
       B230-UPD-TSKST.                                                  02450000
                                                                        02460000
           PERFORM VARYING PV-RETRY-CNT FROM 1 BY 1                     02470000
             UNTIL PV-RETRY-CNT > PC-MAX-RETRY-CNT                      02480000
                                                                        02490000
             EXEC SQL                                                   02500000
                 UPDATE TSKST                                           02510000
                    SET                                                 02520000
                        YTD_SALES_UNIT_QTY = :TSKST-YTD-SALES-UNIT-QTY  02530000
                  WHERE ITEM_NMBR   = :TSKST-ITEM-NMBR                  02550000
                    AND LOC_NBR  = :TSKST-LOC-NBR                       02560000
             END-EXEC                                                   02570000
                                                                        02580000
             EVALUATE TRUE                                              02590000
                 WHEN SQLWARN0 NOT = SPACES                             02600000
                      MOVE 'B230-UPD-TSKST'                             02610000
                        TO  PV-PARAGRAPH-NAME                           02620000
                      MOVE 'UPDATE TSKST RECORD'                        02630000
                        TO  PV-DB2-OPERATION-ATTEMPTED                  02640000
                      PERFORM 9999-SQL-ABEND                            02650000
                 WHEN SQLCODE = ZERO                                    02660000
                      IF  TSKST-LOC-NBR = ZERO                          02670000
                          ADD +1 TO PV-000-TSKST-UPDT-CNT               02680000
                      ELSE                                              02690000
                          ADD +1 TO PV-LOC-TSKST-UPDT-CNT               02700000
                      END-IF                                            02710000
                      MOVE PC-MORE-THAN-MAX-RETRY TO PV-RETRY-CNT       02720000
                 WHEN SQLCODE = -904                                    02730000
      *          WHEN SQLCODE = -911                                    02740000
                 WHEN SQLCODE = -913                                    02750000
                      CONTINUE                                          02760000
                 WHEN ANY                                               02770000
                      DISPLAY '**********************************'      02780000
                      DISPLAY 'ITEM_NMBR  = ' TSKST-ITEM-NMBR           02790000
                      DISPLAY 'LOC_NBR = ' TSKST-LOC-NBR                02800000
                      DISPLAY '**********************************'      02810000
                      MOVE 'B230-UPD-TSKST'                             02820000
                        TO  PV-PARAGRAPH-NAME                           02830000
                      MOVE 'UPDATE TSKST RECORD'                        02840000
                        TO  PV-DB2-OPERATION-ATTEMPTED                  02850000
                      PERFORM 9999-SQL-ABEND                            02860000
             END-EVALUATE                                               02870000
           END-PERFORM.                                                 02880000
                                                                        02890000
           IF (SQLWARN0 NOT = SPACES                                    02900000
           OR  SQLCODE > 0                                              02910000
           OR  SQLCODE < 0)                                             02920000
               DISPLAY '**********************************'             02930000
               DISPLAY 'ITEM_NMBR  = ' TSKST-ITEM-NMBR                  02940000
               DISPLAY 'LOC_NBR = ' TSKST-LOC-NBR                       02950000
               DISPLAY '**********************************'             02960000
               MOVE 'B230-UPD-TSKST'                                    02970000
                 TO  PV-PARAGRAPH-NAME                                  02980000
               MOVE 'MAX RETRIES EXCEEDED'                              02990000
                 TO  PV-DB2-OPERATION-ATTEMPTED                         03000000
               PERFORM 9999-SQL-ABEND                                   03010000
           END-IF.                                                      03020000
                                                                        03030000
                                                                        03040000
201100******************************************************************03040100
201200*  SELECT FROM THE CHECKPOINT RESTART CONTROL TABLE TO SEE IF     03040200
201300*  THE PROGRAM IS IN A RESTART CONDITION.                         03040300
201400******************************************************************03040400
201500 8000-INIT-CHECKPOINT-SELECT.                                     03040500
201600                                                                  03040600
201700     EXEC SQL                                                     03040700
201800       SELECT                                                     03040800
201900            CKPT_STAT_CODE                                        03040900
202000         INTO                                                     03041000
202100           :TCKRSTCNTL-CKPT-STAT-CODE                             03041100
202200         FROM  TCKRSTCNTL                                         03041200
202300        WHERE  JOB_NAME  = :PC-JOB-NAME                           03041300
202400          AND  PLAN_NAME = :PC-PROGRAM-NAME                       03041400
202500     END-EXEC.                                                    03041500
202600                                                                  03041600
202700     EVALUATE TRUE                                                03041700
202800         WHEN SQLCODE = ZERO                                      03041800
202900             CONTINUE                                             03041900
203000         WHEN OTHER                                               03042000
203100             MOVE '8000-INIT-CHECKPOINT-SELECT '                  03042100
203200               TO  PV-PARAGRAPH-NAME                              03042200
203300             MOVE 'ERROR ON SELECT OF TCKRSTCNTL '                03042300
203400               TO  PV-DB2-OPERATION-ATTEMPTED                     03042400
203500             PERFORM 9999-SQL-ABEND                               03042500
203600     END-EVALUATE.                                                03042600
203700                                                                  03042700
203800******************************************************************03042800
203900*  SELECT FROM THE CHECKPOINT RESTART INFORMATION TABLE TO        03042900
204000*  OBTAIN THE PROGRAMS SAVED VARIABLES.                           03043000
204100******************************************************************03043100
204200 8100-SELECT-RESTART-INFO.                                        03043200
204300                                                                  03043300
204400     EXEC SQL                                                     03043400
204500         SELECT                                                   03043500
204600            WORK_STRG_DESC                                        03043600
204700         INTO                                                     03043700
204800           :TCKRSTINF-WORK-STRG-DESC                              03043800
204900         FROM  TCKRSTINF                                          03043900
205000        WHERE  JOB_NAME  = :PC-JOB-NAME                           03044000
205100          AND  PLAN_NAME = :PC-PROGRAM-NAME                       03044100
205200     END-EXEC.                                                    03044200
205300                                                                  03044300
205400     EVALUATE TRUE                                                03044400
205500         WHEN SQLCODE = ZERO                                      03044500
205600             CONTINUE                                             03044600
205700         WHEN OTHER                                               03044700
205800             MOVE '8100-SELECT-RESTART-INFO '                     03044800
205900               TO  PV-PARAGRAPH-NAME                              03044900
206000             MOVE 'ERROR ON SELECT OF TCKRSTINF '                 03045000
206100               TO  PV-DB2-OPERATION-ATTEMPTED                     03045100
206200             PERFORM 9999-SQL-ABEND                               03045200
206300     END-EVALUATE.                                                03045300
206400                                                                  03045400
206500     EJECT                                                        03045500
206600******************************************************************03045600
206700*  CHECK IF WE NEED TO TAKE A COMMIT.  IF SO, COMMIT THIS UNIT    03045700
206800*  OF WORK.                                                       03045800
206900******************************************************************03045900
207000 8200-COMMIT-PROCESSING.                                          03046000
207100                                                                  03046100
207200     PERFORM 8500-SET-CURRENT-TIMESTAMP.                          03046200
207300                                                                  03046300
207400     IF PV-CURRENT-TIMESTAMP > PV-COMMIT-TIMESTAMP                03046400
207500         IF PS-FIRST-COMMIT                                       03046500
207600             MOVE '9'        TO TCKRSTCNTL-CKPT-STAT-CODE         03046600
207700             PERFORM 8300-UPDATE-CHECKPOINT-STATUS                03046700
207800             MOVE 'N'        TO PS-FIRST-COMMIT-SW                03046800
207900         END-IF                                                   03046900
208000         PERFORM 8600-COMMIT                                      03047000
208100         PERFORM 8400-GET-COMMIT-TIMESTAMP                        03047100
208200     END-IF.                                                      03047200
208300                                                                  03047300
208400******************************************************************03047400
208500*  UPDATE THE STATUS ON THE CHECKPOINT CONTROL TABLE              03047500
208600******************************************************************03047600
208700 8300-UPDATE-CHECKPOINT-STATUS.                                   03047700
208800                                                                  03047800
208900     EXEC SQL                                                     03047900
209000       UPDATE  TCKRSTCNTL                                         03048000
209100          SET  CKPT_STAT_CODE = :TCKRSTCNTL-CKPT-STAT-CODE        03048100
209200        WHERE  JOB_NAME  = :PC-JOB-NAME                           03048200
209300          AND  PLAN_NAME = :PC-PROGRAM-NAME                       03048300
209400     END-EXEC.                                                    03048400
209500                                                                  03048500
209600     EVALUATE TRUE                                                03048600
209700         WHEN SQLCODE = ZERO                                      03048700
209800             CONTINUE                                             03048800
209900         WHEN OTHER                                               03048900
210000             MOVE '8300-UPDATE-CHECKPOINT-STATUS '                03049000
210100               TO  PV-PARAGRAPH-NAME                              03049100
210200             MOVE 'ERROR ON UPDATE OF TCKRSTCNTL '                03049200
210300               TO  PV-DB2-OPERATION-ATTEMPTED                     03049300
210400             PERFORM 9999-SQL-ABEND                               03049400
210500     END-EVALUATE.                                                03049500
210600                                                                  03049600
210700                                                                  03049700
210800******************************************************************03049800
210900*  GET THE COMMIT TIMESTAMP FROM THE CHECKPOINT CONTROL TABLE     03049900
211000******************************************************************03050000
211100 8400-GET-COMMIT-TIMESTAMP.                                       03050100
211200                                                                  03050200
211300     EXEC SQL                                                     03050300
211400       SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)       03050400
211500         INTO :PV-COMMIT-TIMESTAMP                                03050500
211600         FROM TCKRSTCNTL                                          03050600
211700        WHERE JOB_NAME  = :PC-JOB-NAME                            03050700
211800          AND PLAN_NAME = :PC-PROGRAM-NAME                        03050800
211900     END-EXEC.                                                    03050900
212000                                                                  03051000
212100     IF SQLCODE = 0                                               03051100
212200         CONTINUE                                                 03051200
212300     ELSE                                                         03051300
212400         MOVE '8400-GET-COMMIT-TIMESTAMP '                        03051400
212500           TO  PV-PARAGRAPH-NAME                                  03051500
212600         MOVE 'ERROR ON SELECT OF TIMESTAMP '                     03051600
212700           TO  PV-DB2-OPERATION-ATTEMPTED                         03051700
212800         PERFORM 9999-SQL-ABEND                                   03051800
212900     END-IF.                                                      03051900
213000                                                                  03052000
213100                                                                  03052100
213200******************************************************************03052200
213300*  GET THE CURRENT TIMESTAMP FROM DB2                             03052300
213400******************************************************************03052400
213500 8500-SET-CURRENT-TIMESTAMP.                                      03052500
213600                                                                  03052600
213700     EXEC SQL                                                     03052700
213800          SET :PV-CURRENT-TIMESTAMP = CURRENT TIMESTAMP           03052800
213900     END-EXEC.                                                    03052900
214000                                                                  03053000
214100     IF SQLCODE = 0                                               03053100
214200         CONTINUE                                                 03053200
214300     ELSE                                                         03053300
214400         MOVE '8500-SET-CURRENT-TIMESTAMP '                       03053400
214500           TO  PV-PARAGRAPH-NAME                                  03053500
214600         MOVE 'ERROR ON SET OF TIMESTAMP '                        03053600
214700           TO  PV-DB2-OPERATION-ATTEMPTED                         03053700
214800         PERFORM 9999-SQL-ABEND                                   03053800
214900     END-IF.                                                      03053900
215000                                                                  03054000
215100                                                                  03054100
215200******************************************************************03054200
215300*  PERFORM UPDATE OF CHECKPOINT INFORMATION TABLE.                03054300
215400*  TAKE A COMMIT.                                                 03054400
215500******************************************************************03054500
215600 8600-COMMIT.                                                     03054600
215700                                                                  03054700
           MOVE PV-ITEM-NMBR              TO CR-ITEM-NMBR.              03054800
           MOVE PV-STR-NBR                TO CR-STR-NBR.                03054900
           MOVE PV-FILE-READ-CNT          TO CR-INPUT-READ-COUNT.       03055200
      *        MOVE COMMIT INFO TO WORKING STORAGE ROW                  03055300
215800     MOVE CR-CHECKPOINT-RESTART-AREA TO TCKRSTINF-WORK-STRG-DESC. 03055400
215900                                                                  03055500
216000     EXEC SQL                                                     03055600
216100       UPDATE TCKRSTINF                                           03055700
216200          SET WORK_STRG_DESC = :TCKRSTINF-WORK-STRG-DESC          03055800
216300        WHERE JOB_NAME  = :PC-JOB-NAME                            03055900
216400          AND PLAN_NAME = :PC-PROGRAM-NAME                        03056000
216500     END-EXEC.                                                    03056100
216600                                                                  03056200
216700     IF SQLCODE = 0                                               03056300
216800         CONTINUE                                                 03056400
216900     ELSE                                                         03056500
217000         MOVE '8600-COMMIT '                                      03056600
217100           TO  PV-PARAGRAPH-NAME                                  03056700
217200         MOVE 'ERROR ON UPDATE OF TCKRSTINF '                     03056800
217300           TO  PV-DB2-OPERATION-ATTEMPTED                         03056900
217400         PERFORM 9999-SQL-ABEND                                   03057000
217500     END-IF.                                                      03057100
217600                                                                  03057200
217700     EXEC SQL                                                     03057300
217800         COMMIT                                                   03057400
217900     END-EXEC.                                                    03057500
218000                                                                  03057600
218100     IF SQLCODE = 0                                               03057700
218200         ADD +1 TO CR-COMMIT-CNT                                  03057800
218300     ELSE                                                         03057900
218400         MOVE '8600-COMMIT '                                      03058000
218500           TO  PV-PARAGRAPH-NAME                                  03058100
218600         MOVE 'ERROR ON COMMIT '                                  03058200
218700           TO  PV-DB2-OPERATION-ATTEMPTED                         03058300
218800         PERFORM 9999-SQL-ABEND                                   03058400
218900     END-IF.                                                      03058500
219000                                                                  03058600
                                                                        03058700
       9999-SQL-ABEND.                                                  03059000
                                                                        03060000
           DISPLAY '** ABEND     **'.                                   03070000
           DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              03080000
           DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.     03090000
                                                                        03100000
      ***************************************************************** 03110000
      * THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    03120000
      * MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         03130000
      * 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     03140000
      * FORMAT.                                                         03150000
      ***************************************************************** 03160000
           COPY DPPD004.                                                03170000
                                                                        03180000
           MOVE +4013 TO ABEND-CODE.                                    03190000
           CALL 'ILBOABN0' USING ABEND-CODE.                            03200005
