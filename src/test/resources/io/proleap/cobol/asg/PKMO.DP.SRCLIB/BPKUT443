000100******************************************************************00010050
000200******************************************************************00020050
000300 IDENTIFICATION DIVISION.                                         00030050
000400******************************************************************00040050
000500******************************************************************00050050
000600                                                                  00060050
000700 PROGRAM-ID.     BPKUT443.                                        00070062
000800 AUTHOR.         COGNIZANT.                                       00080062
000900 INSTALLATION.   KOHLS DEPARTMENT STORES.                         00090050
001000 DATE-WRITTEN.   04/29/2010.                                      00100062
001100 DATE-COMPILED.                                                   00110050
001200                                                                  00120050
001300******************************************************************00130050
001400*                                                                *00140050
001500*                  EP SALES/TMKD PROGRAM                         *00150062
001600*                                                                *00160050
001700******************************************************************00170050
001800                                                                  00180050
001900******************************************************************00190050
002000*  CHANGES:                                                       00200050
002100*                                                                 00210050
002200*  04/29/2010    COGNIZANT    WR# 2344                            00220077
002300*     -  CHANGED THE PROGRAM FOR EP UPGRADE PROCESS.              00230063
002400*        PICKUP THE SALES RETAIL AMOUNTS FOR ACTUAL SALES EP      00240063
002500*        STAGING TABLE.POPULATED BASEDON THE COPYBOOK BPRD150.    00250075
002600******************************************************************00260050
002700                                                                  00270050
002800******************************************************************00280050
002900******************************************************************00290050
003000 ENVIRONMENT DIVISION.                                            00300050
003100******************************************************************00310050
003200******************************************************************00320050
003300                                                                  00330050
003400******************************************************************00340050
003500 CONFIGURATION SECTION.                                           00350050
003600******************************************************************00360050
003700                                                                  00370050
003800 SOURCE-COMPUTER.        IBM-3090.                                00380050
003900 OBJECT-COMPUTER.        IBM-3090.                                00390050
004000                                                                  00400050
004100******************************************************************00410050
004200 INPUT-OUTPUT SECTION.                                            00420050
004300******************************************************************00430050
004400                                                                  00440050
004500 FILE-CONTROL.                                                    00450050
004600                                                                  00460050
004700     SELECT STORE-FILE                                            00470050
004800         ASSIGN TO INP01.                                         00480050
004900                                                                  00490050
005000     SELECT ECOMM-FILE                                            00500050
005100         ASSIGN TO INP02.                                         00510050
005200                                                                  00520050
005300     SELECT MTD-FILE                                              00530050
005400         ASSIGN TO OUT01.                                         00540050
005500                                                                  00550050
005600******************************************************************00560050
005700******************************************************************00570050
005800 DATA DIVISION.                                                   00580050
005900******************************************************************00590050
006000******************************************************************00600050
006100                                                                  00610050
006200******************************************************************00620050
006300 FILE SECTION.                                                    00630050
006400******************************************************************00640050
006500                                                                  00650050
006600 FD  STORE-FILE                                                   00660050
006700     RECORDING MODE IS F                                          00670050
006800     LABEL RECORDS ARE STANDARD                                   00680050
006900     BLOCK CONTAINS 0 RECORDS.                                    00690050
007000                                                                  00700050
007100 01  STORE-RECORD                     PIC X(22).                  00710069
007200                                                                  00720050
007300 FD  ECOMM-FILE                                                   00730050
007400     RECORDING MODE IS F                                          00740050
007500     LABEL RECORDS ARE STANDARD                                   00750050
007600     BLOCK CONTAINS 0 RECORDS.                                    00760050
007700                                                                  00770050
007800 01  ECOMM-RECORD                     PIC X(22).                  00780069
007900                                                                  00790050
008000 FD  MTD-FILE                                                     00800050
008100     RECORDING MODE IS F                                          00810050
008200     LABEL RECORDS ARE STANDARD                                   00820050
008300     BLOCK CONTAINS 0 RECORDS.                                    00830050
008400                                                                  00840050
008500 01  MTD-RECORD                       PIC X(700).                 00850063
008600                                                                  00860050
008700                                                                  00870050
008800******************************************************************00880050
008900 WORKING-STORAGE SECTION.                                         00890050
009000******************************************************************00900050
009100                                                                  00910050
009200 01  PC-PROGRAM-CONSTANTS.                                        00920050
009300     05  PC-PHYSSTR                   PIC X(07)  VALUE 'PHYSSTR'. 00930050
009400     05  PC-VIRTSTR                   PIC X(07)  VALUE 'VIRTSTR'. 00940050
009500                                                                  00950050
009600 01  PS-PROGRAM-SWITCHES.                                         00960050
009700     05  PS-END-OF-STORE-DATA-SW      PIC X(01)  VALUE 'N'.       00970050
009800         88  PS-END-OF-STORE-DATA                VALUE 'Y'.       00980050
009900                                                                  00990050
010000     05  PS-END-OF-ECOMM-DATA-SW      PIC X(01)  VALUE 'N'.       01000050
010100         88  PS-END-OF-ECOMM-DATA                VALUE 'Y'.       01010050
010200                                                                  01020050
010300                                                                  01030050
010400 01  PV-PROGRAM-VARIABLES.                                        01040050
010500     05  PV-FSCL-WK-END-DTE           PIC X(10).                  01050050
010600     05  PV-DB2-OPER-ATTEMPTED        PIC X(30).                  01060050
010700     05  PV-PARAGRAPH-NAME            PIC X(30).                  01070050
010800     05  PV-ABEND-CODE                PIC S9(04) COMP             01080050
010900                                                 VALUE ZERO.      01090050
011000     05  PV-SUM-OTHER-ADJ-DLR         PIC S9(11)V9(2) COMP-3.     01100050
011100     05  PV-PLANNING-BUYER-DLR        PIC S9(11)V9(2) COMP-3.     01110050
011200     05 SW-STR-IND                    PIC X(01)  VALUE SPACES.    01120066
011300         88 SW-PHYSSTR                 VALUE 'P'.                 01130064
011400         88 SW-VIRTSTR                 VALUE 'V'.                 01140064
011500                                                                  01150064
011600     EJECT                                                        01160050
011700     COPY BPRD430.                                                01170050
011800                                                                  01180050
011900     COPY BPRD435.                                                01190050
012000     EJECT                                                        01200050
012100* OUTPUT EP COPY BOOK LAYOUT                                      01210063
012200     COPY BPRD150.                                                01220063
012300     EJECT                                                        01230063
012400****************************************************************  01240050
012500* DATE ATTRIBUTE TABLE                                            01250050
012600****************************************************************  01260050
012700                                                                  01270050
012800     EXEC SQL                                                     01280050
012900         INCLUDE TDTATTR                                          01290050
013000     END-EXEC.                                                    01300050
013100                                                                  01310050
013200****************************************************************  01320050
013300*  COMMUNICATION AREAS FOR DB2                                    01330050
013400****************************************************************  01340050
013500                                                                  01350050
013600     EXEC SQL                                                     01360050
013700         INCLUDE SQLCA                                            01370050
013800     END-EXEC.                                                    01380050
013900                                                                  01390050
014000******************************************************************01400050
014100* DB2 COMMUNICATION AREA 2                                        01410050
014200******************************************************************01420050
014300                                                                  01430050
014400     COPY SQLCA2.                                                 01440050
014500                                                                  01450050
014600                                                                  01460050
014700******************************************************************01470050
014800******************************************************************01480050
014900 PROCEDURE DIVISION.                                              01490050
015000******************************************************************01500050
015100******************************************************************01510050
015200                                                                  01520050
015300 0000-MAINLINE.                                                   01530050
015400                                                                  01540050
015500     PERFORM 1000-INITIALIZE-FOR-STORE.                           01550050
015600                                                                  01560050
015700     PERFORM 2000-PROCESS-STORE-DATA                              01570050
015800             UNTIL PS-END-OF-STORE-DATA.                          01580050
015900                                                                  01590050
016000     PERFORM 1100-INITIALIZE-FOR-ECOMM.                           01600050
016100                                                                  01610050
016200     PERFORM 3000-PROCESS-ECOMM-DATA                              01620050
016300             UNTIL PS-END-OF-ECOMM-DATA.                          01630050
016400                                                                  01640050
016500     PERFORM 6000-END-OF-JOB.                                     01650050
016600                                                                  01660050
016700     STOP RUN.                                                    01670050
016800     EJECT                                                        01680050
016900******************************************************************01690050
017000*                                                                *01700050
017100*   OPEN INPUT AND OUTPUT FILE AND PERFORM THE INITIAL READ.     *01710050
017200*                                                                *01720050
017300******************************************************************01730050
017400 1000-INITIALIZE-FOR-STORE.                                       01740050
017500                                                                  01750050
017600     OPEN INPUT  STORE-FILE                                       01760050
017700     OPEN OUTPUT MTD-FILE.                                        01770068
017800                                                                  01780050
017900     PERFORM 8000-READ-STORE-RECORD.                              01790050
018000                                                                  01800050
018100******************************************************************01810050
018200*                                                                *01820050
018300*   OPEN INPUT ECOMM FILE AND PERFORM THE INITIAL READ.          *01830050
018400*                                                                *01840050
018500******************************************************************01850050
018600 1100-INITIALIZE-FOR-ECOMM.                                       01860050
018700                                                                  01870050
018800     OPEN INPUT  ECOMM-FILE.                                      01880050
018900                                                                  01890050
019000     PERFORM 8100-READ-ECOMM-RECORD.                              01900050
019100                                                                  01910050
019200******************************************************************01920050
019300*                                                                *01930050
019400*                     PROCESS ALL STORE DATA.                    *01940050
019500*                                                                *01950050
019600******************************************************************01960050
019700 2000-PROCESS-STORE-DATA.                                         01970050
019800                                                                  01980050
019900     SET SW-PHYSSTR    TO TRUE                                    01990065
020000                                                                  02000050
020100     PERFORM 4000-FORMAT-OUPTUT-RECORD.                           02010050
020200                                                                  02020050
020300     PERFORM 8000-READ-STORE-RECORD.                              02030050
020400                                                                  02040050
020500******************************************************************02050050
020600*                                                                *02060050
020700*                     PROCESS ALL ECOMM DATA.                    *02070050
020800*                                                                *02080050
020900******************************************************************02090050
021000 3000-PROCESS-ECOMM-DATA.                                         02100050
021100                                                                  02110050
021200     SET SW-VIRTSTR    TO TRUE                                    02120065
021300                                                                  02130050
021400     PERFORM 4000-FORMAT-OUPTUT-RECORD.                           02140050
021500                                                                  02150050
021600     PERFORM 8100-READ-ECOMM-RECORD.                              02160050
021700                                                                  02170050
021800******************************************************************02180050
021900*                                                                *02190050
022000*                     FORMAT ALL DATA                            *02200050
022100*                                                                *02210050
022200******************************************************************02220050
022300                                                                  02230050
022400 4000-FORMAT-OUPTUT-RECORD.                                       02240050
022500*                                                                 02250065
022600     INITIALIZE MTD-RECORD.                                       02260065
022700     INITIALIZE BP150-RECORD.                                     02270065
022800     INITIALIZE BP150-ACTUAL-SALES.                               02280071
022900     INITIALIZE BP150-ACTUAL-RECEIPTS.                            02290071
023000     IF SW-PHYSSTR                                                02300065
023100        MOVE PC-PHYSSTR TO BP150-ORGANIZATION-NAME1               02310065
023200     ELSE                                                         02320065
023300        MOVE PC-VIRTSTR TO BP150-ORGANIZATION-NAME1               02330065
023400     END-IF.                                                      02340065
023500                                                                  02350050
023600     MOVE BP430-DEPT-NBR TO BP150-DEPARTMENT-NBR1.                02360063
023700     MOVE BP430-MAJ-CL-NBR TO BP150-CLASS-NBR1.                   02370063
023800                                                                  02380050
023900     MOVE BP430-FSCL-WK-END-DTE TO PV-FSCL-WK-END-DTE.            02390050
024000                                                                  02400050
024100     PERFORM 7000-GET-TIME-PERIOD                                 02410050
024200                                                                  02420050
024300******************************************************************02430050
024400*    ENTERPRISE PLANNING ML DATA IN THOUSANDTHS (/ BY 1000)    *  02440063
024500******************************************************************02450050
024600     MOVE ZEROES TO BP150-C-SLS-DLR                               02460074
024700     MOVE ZEROES TO BP150-N-SLS-DLR                               02470074
024800     DIVIDE BP430-SLS-RTL-AMT BY 1000 GIVING BP150-SLS-DLR        02480063
024900     PERFORM 9000-WRITE-OUTPUT-RECORD.                            02490061
025000                                                                  02500050
025100                                                                  02510050
025200******************************************************************02520050
025300*                                                                *02530050
025400*                     CLOSE ALL OPEN FILES.                      *02540050
025500*                                                                *02550050
025600******************************************************************02560050
025700 6000-END-OF-JOB.                                                 02570050
025800                                                                  02580050
025900     CLOSE STORE-FILE                                             02590050
026000           ECOMM-FILE                                             02600050
026100           MTD-FILE.                                              02610050
026200                                                                  02620050
026300******************************************************************02630050
026400*                                                                *02640050
026500* USING THE FSCL-WK-END-DTE, GET THE SEASON DESCRIPTION, FISCAL  *02650050
026600* YEAR # AND FISCAL WEEK # FROM THE DATE ATTRIBUTE TABLE FOR     *02660050
026700* CREATING THE TIME MEMBER FOR THE FORMATTED EP SALES FILE.     * 02670063
026800*                                                                *02680050
026900******************************************************************02690050
027000 7000-GET-TIME-PERIOD.                                            02700050
027100     EXEC SQL                                                     02710050
027200          SELECT                                                  02720050
027300              SEA_DESC                                            02730050
027400             ,FSCL_YR_NBR                                         02740050
027500             ,FSCL_WK_NBR                                         02750050
027600          INTO                                                    02760050
027700              :DTATTR-SEA-DESC                                    02770050
027800             ,:DTATTR-FSCL-YR-NBR                                 02780050
027900             ,:DTATTR-FSCL-WK-NBR                                 02790050
028000          FROM                                                    02800050
028100              TDTATTR                                             02810050
028200          WHERE                                                   02820050
028300              KY_DTE = :PV-FSCL-WK-END-DTE                        02830050
028400     END-EXEC.                                                    02840050
028500                                                                  02850050
028600     EVALUATE TRUE                                                02860050
028700         WHEN SQLCODE = ZERO                                      02870050
028800             MOVE DTATTR-SEA-DESC    TO BP150-SEASON1             02880063
028900             MOVE DTATTR-FSCL-YR-NBR TO BP150-YEAR1               02890063
029000             MOVE DTATTR-FSCL-WK-NBR TO BP150-WEEK-NBR1           02900063
029100         WHEN OTHER                                               02910050
029200             MOVE    '7000-GET-TIME-PERIOD'                       02920050
029300                                          TO PV-PARAGRAPH-NAME    02930050
029400             MOVE    'SELECT ROW FROM TDTATTR'                    02940050
029500                                          TO PV-DB2-OPER-ATTEMPTED02950050
029600             PERFORM 9999-SQL-ABEND                               02960050
029700     END-EVALUATE.                                                02970050
029800                                                                  02980050
029900                                                                  02990050
030000******************************************************************03000050
030100*                                                                *03010050
030200*                     READ IN STORE RECORDS                      *03020050
030300*                                                                *03030050
030400******************************************************************03040050
030500 8000-READ-STORE-RECORD.                                          03050050
030600     READ STORE-FILE INTO BP430-RECORD                            03060050
030700       AT END SET PS-END-OF-STORE-DATA TO TRUE.                   03070050
030800                                                                  03080050
030900                                                                  03090050
031000******************************************************************03100050
031100*                                                                *03110050
031200*                     READ IN E-COMM RECORDS                     *03120050
031300*                                                                *03130050
031400******************************************************************03140050
031500 8100-READ-ECOMM-RECORD.                                          03150050
031600     READ ECOMM-FILE INTO BP430-RECORD                            03160050
031700       AT END SET PS-END-OF-ECOMM-DATA TO TRUE.                   03170050
031800                                                                  03180050
031900                                                                  03190050
032000******************************************************************03200050
032100*                                                                *03210050
032200*                     WRITE OUTPUT RECORDS                       *03220050
032300*                                                                *03230050
032400******************************************************************03240050
032500 9000-WRITE-OUTPUT-RECORD.                                        03250050
032600     INITIALIZE MTD-RECORD.                                       03260071
032700     WRITE MTD-RECORD FROM BP150-ACTUAL-SALES.                    03270071
032800                                                                  03280050
032900                                                                  03290050
033000******************************************************************03300050
033100*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL   *03310050
033200*                 ERROR OR WARNING CODE OCCURS.                  *03320050
033300******************************************************************03330050
033400 9999-SQL-ABEND.                                                  03340050
033500                                                                  03350050
033600     MOVE SQLCODE        TO  SQLCODE2.                            03360050
033700     MOVE SQLERRD(3)     TO  SQLERRD3.                            03370050
033800                                                                  03380050
033900     DISPLAY '***************************'                        03390050
034000     DISPLAY '**       ABEND           **'                        03400050
034100     DISPLAY '**  IN PROGRAM BPKUT443   **'                       03410063
034200     DISPLAY '***************************'                        03420050
034300     DISPLAY '** PARAGRAPH **      = ' PV-PARAGRAPH-NAME          03430050
034400     DISPLAY '** OPERATION **      = ' PV-DB2-OPER-ATTEMPTED      03440050
034500     DISPLAY '** ROWS PROCESSED ** = ' SQLERRD3.                  03450050
034600     DISPLAY '** SQLCODE **        = ' SQLCODE2.                  03460050
034700                                                                  03470050
034800     MOVE +4013         TO PV-ABEND-CODE                          03480050
034900     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         03490050
