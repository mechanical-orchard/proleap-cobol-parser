000100*----------------------------------------------------------------*00010009
000200 IDENTIFICATION DIVISION.                                         00020007
000300*----------------------------------------------------------------*00030007
000400 PROGRAM-ID.           EPKUT074.                                  00040007
000500 AUTHOR.               DOUG JONES.                                00050007
000600 INSTALLATION.         KOHLS DEPARTMENT STORES.                   00060007
000700 DATE-WRITTEN          JANUARY 2003.                              00070007
000800 DATE-COMPILED.                                                   00080007
000900                                                                  00090007
001000******************************************************************00100007
001100*     THIS PROGRAM WILL RUN NIGHTLY AND EVALUATE SALES DATA      *00110007
001200*     FOR THE CURRENT DAY.  RESULTS WILL BE COMPARED             *00120007
001300*     TO EXISTING DATA TRACKED FOR THE LAST 13 WEEKS.            *00130012
001400*     DEPENDING ON HOW CURRENT DAY SALES INFORMATION COMPARES    *00140007
001500*     TO THE LOWEST PRICE TABLE, TWO PROMOTIONAL OUTPUT FILES    *00150007
001600*     MAY BE CREATED.  ONE THAT WILL FEED THE UPDATE/LOAD        *00160007
001700*     PROCESS FOR THE LOWEST PRICE TABLE, AND ONE THAT WOULD     *00170007
001800*     FEED THE PLU CHANGE PROCESS.                               *00180007
001900*                                                                *00190007
002000*     THIS PROGRAM WILL CONSIDER ALL SALE AND POSITIVE MIX       *00200007
002100*     MODE TRANSACTIONS, SPECIFICALLY FOCUSING ON SALE ITEMS.    *00210007
002200*     THE LOGIC WILL BE PERFORMED ONCE FOR EACH AD VERSION.      *00220007
002300*                                                                *00230010
N2I201*     NEXT GEN PHASE 2 - 03/25/2008                              *00240011
N2I201*     EXCLUDE THIRD PARTY CARD SALES (DEPARTMENTS 833 AND 834)   *00250011
000999*-----------------------------------------------------------      00260017
001000* HISTORY LOG:                                                    00270017
001100*-----------------------------------------------------------      00280017
001200* DATE:        12/05/11                                           00290017
001300* WR/IR#:      WR#25149                                           00300099
001400* PROGRAMMER:  ROB SWAGER                                         00310017
001500* DESCRIPTION: EXTEND LOWEST 6 WEEK RETURN PRICE PROCESSING       00320017
001510*              TO 13 WEEKS.                                       00330019
001600*                                                                 00340017
001700*----------------------------------------------------------       00350017
FSH12 * DATE:        08/17/12                                           00360099
FSH12 * WR/IR#:      FSH 2012 - WR40932                                 00370099
FSH12 * PROGRAMMER:  JIM HUNTER                                         00380099
FSH12 * DESCRIPTION: REMOVE THE INCLUDE FOR TEPITP WHICH IS BEING       00390099
FSH12 *              OBSOLETED.  THE INCLUDE, BUT NOT THE TABLE, WAS    00400099
FSH12 *              USED BY THIS PROGRAM.                              00410099
FSH12 *----------------------------------------------------------       00420099
P8612 * DATE:        10/09/14                                           00421099
P8612 * WR/IR#:      CHG0092405                                         00421199
P8612 * PROGRAMMER:  COGNIZANT                                          00422099
P8612 * DESCRIPTION: EXCLUDE NEW MARKET PLACE DEPARTMENT 070 AND WAYFAIR00424099
P8612 *              CLASS 91.                                          00425099
002600******************************************************************00430007
SEPHOR* DATE:        04/28/22                                           00431099
SEPHOR* WR/IR#:      CHG0269500                                         00432099
SEPHOR* PROGRAMMER:  JIM HUNTER                                         00433099
SEPHOR* DESCRIPTION: EXCLUDE NEW SEPHORA GIFT CARD DEPARTMENT 712       00434099
SEPHOR*              FROM SALEITM-CSR.                                  00435099
SEPHOR*              DUE TO VOLUME, REDUCE DISPLAY RECORDS FROM 7 TO 1  00435199
SEPHOR*              IN PARA 3450-RETRV-ANY-GOLDSTAR-MKDN.              00435299
SEPHOR******************************************************************00436099
002700 ENVIRONMENT DIVISION.                                            00440007
002800******************************************************************00450007
002900                                                                  00460007
003000 CONFIGURATION SECTION.                                           00470007
003100 INPUT-OUTPUT SECTION.                                            00480007
003200 FILE-CONTROL.                                                    00490007
003300                                                                  00500007
003400     SELECT POS-DATE-FILE                                         00510007
003500         ASSIGN TO INP01.                                         00520007
003600                                                                  00530007
003700     SELECT LWST-W13-WEEK-LOAD-FILE                               00540012
003800         ASSIGN TO OUT01.                                         00550007
003900                                                                  00560007
004000     SELECT PLU-CHGS-EXTRACT-FILE                                 00570007
004100         ASSIGN TO OUT02.                                         00580007
004200                                                                  00590007
004300*----------------------------------------------------------------*00600007
004400 DATA DIVISION.                                                   00610007
004500*----------------------------------------------------------------*00620007
004600                                                                  00630007
004700 FILE SECTION.                                                    00640007
004800                                                                  00650007
004900 FD POS-DATE-FILE                                                 00660007
005000     RECORDING MODE IS F                                          00670007
005100     LABEL RECORDS ARE STANDARD                                   00680007
005200     RECORD CONTAINS 80 CHARACTERS                                00690007
005300     BLOCK CONTAINS 0 RECORDS                                     00700007
005400     DATA RECORD IS POS-DATE-RECORD.                              00710007
005500                                                                  00720007
005600 01 POS-DATE-RECORD        PIC X(80).                             00730007
005700                                                                  00740007
005800 FD  LWST-W13-WEEK-LOAD-FILE                                      00750012
005900     RECORDING MODE IS F                                          00760007
006000     LABEL RECORDS ARE STANDARD                                   00770007
006100     BLOCK CONTAINS 0 RECORDS                                     00780007
006200     RECORD CONTAINS 023 CHARACTERS                               00790007
006300     DATA RECORD IS LWST-W13-WEEK-LOAD-RECORD.                    00800012
006400                                                                  00810007
006500 01  LWST-W13-WEEK-LOAD-RECORD        PIC X(23).                  00820012
006600                                                                  00830007
006700 FD  PLU-CHGS-EXTRACT-FILE                                        00840007
006800     RECORDING MODE IS F                                          00850007
006900     LABEL RECORDS ARE STANDARD                                   00860007
007000     BLOCK CONTAINS 0 RECORDS                                     00870007
007100     RECORD CONTAINS 023 CHARACTERS                               00880007
007200     DATA RECORD IS PLU-CHGS-EXTRACT-RECORD.                      00890007
007300                                                                  00900007
007400 01  PLU-CHGS-EXTRACT-RECORD          PIC X(23).                  00910007
007500                                                                  00920007
007600 WORKING-STORAGE SECTION.                                         00930007
007700                                                                  00940007
007800 01  FILLER                           PIC X(32)    VALUE          00950007
007900     '   WORKING STORAGE STARTS HERE  '.                          00960007
008000                                                                  00970007
008100 01  PC-PROGRAM-CONSTANTS.                                        00980007
008200     05  PC-AD-VERSION              PIC S9(04)   VALUE 4000       00990019
008300                                                 COMP.            01000007
008400     05  PC-ROW-NOT-FOUND           PIC S9(04)   VALUE +100       01010007
008500                                                 COMP SYNC.       01020007
008600     05  PC-CURRENT-PROGRAM-NAME    PIC X(08)    VALUE            01030007
008700                                                 'EPKUT074'.      01040007
008800     05  PC-MISC-DEPT               PIC  X(03)   VALUE '099'.     01050007
008900     05  PC-GIFT-CERT-DEPT          PIC  X(03)   VALUE '981'.     01060007
009000     05  PC-GIFT-CARD-DEPT          PIC  X(03)   VALUE '983'.     01070007
SEPHOR     05  PC-SEPHORA-GC-DEPT         PIC  X(03)   VALUE '712'.     01071099
N2I201     05  PC-TPC-DEPT-833            PIC  X(03)   VALUE '833'.     01080011
N2I201     05  PC-TPC-DEPT-834            PIC  X(03)   VALUE '834'.     01090011
P8612      05  PC-WAYFAIR-DEPT-070        PIC  X(03)   VALUE '070'.     01091099
009300     05  PC-DEPT-850                PIC  X(03)   VALUE '850'.     01100007
009400     05  PC-DUMMY                   PIC  X(03)   VALUE '000'.     01110007
009500     05  PC-ISP                     PIC  X(01)   VALUE 'I'.       01120007
009600     05  PC-KEYED-BY-OPERATOR       PIC  X(01)   VALUE 'K'.       01130007
009700     05  PC-CLEARANCE               PIC  X(02)   VALUE '30'.      01140007
009800     05  PC-GOLDSTAR-RSN-CDE        PIC  X(03)   VALUE '753'.     01150007
009900     05  PC-GOLDSTAR-SAL-TYP-CDE    PIC  X(01)   VALUE 'G'.       01160007
010000     05  PC-POS-CAP-LVL-PRE-PROMO   PIC  S9(04)  VALUE 11         01170007
010100                                                 COMP.            01180007
010200     05  PC-DECREMENT-DAYS          PIC  X(05)   VALUE '00091'.   01190012
010300                                                                  01200007
010400 01  PV-PROGRAM-VARIABLES.                                        01210007
010500     05  PV-PARAGRAPH-NAME          PIC  X(30)   VALUE SPACE.     01220007
010600     05  PV-OPERATION-MSG-1         PIC  X(40)   VALUE SPACE.     01230007
010700     05  PV-OPERATION-MSG-2         PIC  X(40)   VALUE SPACE.     01240007
010800     05  PV-DB2-OPERATION           PIC  X(30)   VALUE SPACE.     01250007
010900     05  PV-DB2-CCYY-MM-DD          PIC  X(10)   VALUE SPACE.     01260007
011000     05  PV-TEMP-VALUE              PIC  X(01)   VALUE SPACES.    01270007
011100     05  PV-GRP-EACH-PRICE          PIC  S9(07)V9(02) VALUE ZEROS 01280007
011200                                                      COMP-3.     01290007
011300     05  PV-LWST-W13-WK-VALUE       PIC  S9(07)V9(02) VALUE ZEROS 01300012
011400                                                      COMP-3.     01310007
011500     05  PV-LWST-W13-WK-VALUE-SVD   PIC  S9(07)V9(02) VALUE ZEROS 01320012
011600                                                      COMP-3.     01330007
011700     05  PV-SAVED-SKU-NBR           PIC  S9(08)V      VALUE ZEROS 01340007
011800                                                      COMP-3.     01350007
011900     05  PV-HISTRC-LW13WK-PR        PIC  S9(07)V9(02) VALUE ZEROS 01360012
012000                                                      COMP-3.     01370007
012100                                                                  01380007
012200     05  PV-CUR-WK-LW13WK-PR        PIC  S9(07)V9(02) VALUE ZEROS 01390012
012300                                                      COMP-3.     01400007
012400     05  PV-SKU-CHAR                PIC   X(08)      VALUE SPACES.01410007
012500     05  FILLER  REDEFINES  PV-SKU-CHAR.                          01420007
012600         10 FILLER                   PIC   X(05).                 01430007
012700         10 PV-LAST-3-CHAR-SKU       PIC   X(03).                 01440007
012800     05  PV-NBR-GRP-ITMS-PURCH-CNT   PIC S9(09)    COMP-3         01450007
012900                                                   VALUE ZEROS.   01460007
013000     05  PV-PRICING-SCHEME           PIC S9(04)V   VALUE ZEROS    01470007
013100                                                   COMP-3.        01480007
013200         88 GROUP-PRICING-SCHEME     VALUES 300, 301, 101, 0.     01490007
013300     05  PV-EXISTS-BYTE              PIC  X(001)   VALUE SPACES.  01500010
013400                                                                  01510010
013500 01  PV-DATE-AND-TIME-FIELDS.                                     01520010
013600     05  PV-WEEK-BEG-DT-CCYY-MM-DD     PIC X(10)  VALUE SPACE.    01530010
013700     05  PV-OLDEST-WEEK-BEG-DT         PIC X(10)  VALUE SPACE.    01540010
013800                                                                  01550010
013900                                                                  01560010
014000 01  AC-ABEND-CODE                     PIC S9(04) VALUE ZERO      01570010
014100                                                  COMP SYNC.      01580010
014200     88  AC-CONTROL-CARD-ERROR                    VALUE +4003.    01590010
014300     88  AC-DB2-ERROR                             VALUE +4013.    01600010
014400     88  AC-CALENDAR-ROUTINE-ERROR                VALUE +4019.    01610010
014500                                                                  01620010
014600 01  PS-PROGRAM-SWITCHES.                                         01630010
014700     05  PS-PS-END-OF-DATE-SW         PIC X(1)       VALUE 'N'.   01640010
014800         88  PS-END-OF-DATE-FILE                     VALUE 'Y'.   01650010
014900     05  PS-END-OF-AD-VERSION-SW      PIC X(1)       VALUE 'N'.   01660010
015000         88  PS-END-OF-AD-VERSION-CSR                VALUE 'Y'.   01670010
015100         88  PS-NOT-END-OF-AD-VERSION-CSR            VALUE 'N'.   01680010
015200     05  PS-END-OF-SALEITM-SW         PIC X(1)       VALUE 'N'.   01690010
015300         88  PS-END-OF-SALEITM-CSR                   VALUE 'Y'.   01700010
015400         88  PS-NOT-END-OF-SALEITM-CSR               VALUE 'N'.   01710010
015500     05  PS-FIRST-AD-VERSION-SKU-SW   PIC X(1)       VALUE 'N'.   01720010
015600         88  PS-FIRST-AD-VERSION-SKU                 VALUE 'Y'.   01730010
015700         88  PS-NOT-FIRST-AD-VERSION-SKU             VALUE 'N'.   01740010
015800     05  PS-GROUP-PRICING-SW          PIC X(1)       VALUE 'N'.   01750010
015900         88  PS-HAS-GROUP-PRICING                    VALUE 'Y'.   01760010
016000         88  PS-NO-GROUP-PRICING                     VALUE 'N'.   01770010
016100     05  PS-BOGO-ITEM-SW              PIC X(1)       VALUE 'N'.   01780010
016200         88  PS-BOGO-ITEM                            VALUE 'Y'.   01790010
016300         88  PS-NOT-BOGO-ITEM                        VALUE 'N'.   01800010
016400     05  PS-TIER-PRICING-SW           PIC X(1)       VALUE 'N'.   01810010
016500         88  PS-HAS-TIER-PRICING                     VALUE 'Y'.   01820010
016600         88  PS-NO-TIER-PRICING                      VALUE 'N'.   01830010
016700     05  PS-SKU-FOUND-SW              PIC X(1)       VALUE 'N'.   01840010
016800         88  PS-SKU-FOUND                            VALUE 'Y'.   01850010
016900         88  PS-SKU-NOT-FOUND                        VALUE 'N'.   01860010
017000     05  PS-INVALID-SKU-SW            PIC X(1)       VALUE 'N'.   01870010
017100         88  PS-INVALID-SKU                          VALUE 'Y'.   01880010
017200         88  PS-SKU-NOT-INVALID                      VALUE 'N'.   01890010
017300     05  PS-CUR-WK-LW13WK-PRIC-SW     PIC X(1)       VALUE 'N'.   01900012
017400         88  PS-HAS-CUR-WK-LW13WK-PRIC               VALUE 'Y'.   01910012
017500         88  PS-NO-CUR-WK-LW13WK-PRIC                VALUE 'N'.   01920012
017600     05  PS-HISTORY-LW13WK-PRIC-SW    PIC X(1)       VALUE 'N'.   01930012
017700         88  PS-HAS-HISTRY-LW13WK-PRIC               VALUE 'Y'.   01940012
017800         88  PS-NO-HISTRY-LW13WK-PRIC                VALUE 'N'.   01950012
017900     05  PS-MAN-LID-SW                PIC X(1)       VALUE 'N'.   01960010
018000         88  PS-MAN-LID-Y                            VALUE 'Y'.   01970010
018100         88  PS-MAN-LID-N                            VALUE 'N'.   01980010
017300     05  PS-GET-ALL-STR-GP-IDS-SW     PIC X(1)       VALUE 'Y'.   01990045
017400         88  PS-HAS-ALL-STR-GP-IDS                   VALUE 'Y'.   02000037
017500         88  PS-NO-STR-GP-IDS                        VALUE 'N'.   02010037
018200                                                                  02020010
018300 01  PA-PROGRAM-ACCUMULATORS.                                     02030010
018400     05  PA-AD-VERSION-CNT            PIC S9(09)     VALUE ZEROS  02040010
018500                                                     COMP-3.      02050010
018600     05  PA-AD-VERSION-ITM-CNT        PIC  9(09)     VALUE ZEROS. 02060010
018700     05  PA-SALE-ITEM-CNT             PIC  9(09)     VALUE ZEROS. 02070010
018800     05  PA-INVALID-ITEM-CNT          PIC S9(09)     VALUE ZEROS  02080010
018900                                                     COMP-3.      02090010
019000     05  PA-DISTN-ADVER-SKU-CNT       PIC S9(09)     VALUE ZEROS  02100010
019100                                                     COMP-3.      02110010
019200     05  PA-TOT-LOAD-RCDS-WRITTEN     PIC S9(09)     VALUE ZEROS  02120010
019300                                                     COMP-3.      02130010
019400     05  PA-TOT-PLU-RCDS-WRITTEN      PIC S9(09)     VALUE ZEROS  02140010
019500                                                     COMP-3.      02150010
019600                                                                  02160010
019700 01  PV-ABEND-CODE   COMP  SYNC       PIC S9(04)     VALUE +0000. 02170010
019800     88  PV-ABEND-4009-CARD-ERROR                    VALUE +4009. 02180010
019900     88  PV-ABEND-4013-DB2-ERROR                     VALUE +4013. 02190010
020000                                                                  02200010
020100******************************************************************02210010
020200* RECORD LAYOUT FOR INPUT DATE CARD (POS DATE)                    02220010
020300******************************************************************02230010
020400 01  CC-CONTROL-CARD.                                             02240010
020500     05  CC-PROCDT-CCYY-MM-DD.                                    02250010
020600         10 CC-PROCESS-DT-CCYY       PIC X(04)  VALUE SPACES.     02260010
020700         10 FILLER                   PIC X(01)  VALUE SPACES.     02270010
020800         10 CC-PROCESS-DT-MM         PIC X(02)  VALUE SPACES.     02280010
020900         10 FILLER                   PIC X(01)  VALUE SPACES.     02290010
021000         10 CC-PROCESS-DT-DD         PIC X(02)  VALUE SPACES.     02300010
021100     05  FILLER                      PIC X(70)  VALUE SPACES.     02310010
021200                                                                  02320010
021300*----------------------------------------------------------------*02330010
021400* EPRD119 LOWEST 13 WEEK PRICE CHANGE COPYBOOK                   *02340012
021500*----------------------------------------------------------------*02350010
021600                                                                  02360010
021700     COPY EPRD119.                                                02370010
021800                                                                  02380010
021900*----------------------------------------------------------------*02390010
022000*  PARAMETER LIST FOR THE CALENDAR ROUTINE (DPKUT500)             02400010
022100*----------------------------------------------------------------*02410010
022200     COPY DPWS500.                                                02420010
022300                                                                  02430010
022400*----------------------------------------------------------------*02440010
022500* DPWS004 VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004*02450010
022600*----------------------------------------------------------------*02460010
022700                                                                  02470010
022800     COPY DPWS004.                                                02480010
022900                                                                  02490010
023000*----------------------------------------------------------------*02500010
023100* DB2 TABLE DB2PDBA.EPT_LO_RTL LOWEST 13  WEEK RETAIL TABLE      *02510012
023200*----------------------------------------------------------------*02520010
023300                                                                  02530010
023400     EXEC SQL                                                     02540010
023500         INCLUDE EPT00011                                         02550010
023600     END-EXEC.                                                    02560010
023700                                                                  02570010
023800*----------------------------------------------------------------*02580010
023900* DB2 TABLE DB2PDBA.XST_LOC   LOCATION TABLE                     *02590010
024000*----------------------------------------------------------------*02600010
024100                                                                  02610010
024200     EXEC SQL                                                     02620010
024300         INCLUDE XST00001                                         02630010
024400     END-EXEC.                                                    02640010
024500                                                                  02650010
024600*----------------------------------------------------------------*02660010
024700* DB2 TABLE DB2PDBA.XST_SKU   SKU TABLE                          *02670010
024800*----------------------------------------------------------------*02680010
024900                                                                  02690010
025000     EXEC SQL                                                     02700010
025100         INCLUDE XST00010                                         02710010
025200     END-EXEC.                                                    02720010
025300                                                                  02730010
025400*----------------------------------------------------------------*02740010
025500* DB2 TABLE DB2PDBA.XST_STR_GP_MBSHP STORE GROUP MEMBERSHIP TBL  *02750010
025600*----------------------------------------------------------------*02760010
025700                                                                  02770010
025800     EXEC SQL                                                     02780010
025900         INCLUDE XST00023                                         02790010
026000     END-EXEC.                                                    02800010
026100                                                                  02810010
026200*----------------------------------------------------------------*02820010
026300* DB2 TABLE DB2PDBA.TEPPART - PARTITION CONTROL TABLE            *02830010
026400*----------------------------------------------------------------*02840010
026500                                                                  02850010
026600     EXEC SQL                                                     02860010
026700         INCLUDE TEPPART                                          02870010
026800     END-EXEC.                                                    02880010
026900                                                                  02890010
027000*----------------------------------------------------------------*02900010
027100* DB2 TABLE DB2PDBA.TEPDKEY - CURRENT PROCESSING DAY KEY TABLE   *02910010
027200*----------------------------------------------------------------*02920010
027300                                                                  02930010
027400     EXEC SQL                                                     02940010
027500         INCLUDE TEPDKEY                                          02950010
027600     END-EXEC.                                                    02960010
027700                                                                  02970010
027800*----------------------------------------------------------------*02980010
027900* DB2 TABLE DB2PDBA.TEPTRN - TRANSACTION TABLE                   *02990010
028000*----------------------------------------------------------------*03000010
028100                                                                  03010010
028200     EXEC SQL                                                     03020010
028300         INCLUDE TEPTRN                                           03030010
028400     END-EXEC.                                                    03040010
028500                                                                  03050010
028600*----------------------------------------------------------------*03060010
028700* DB2 TABLE DB2PDBA.TEPITM - ITEM TABLE                          *03070010
028800*----------------------------------------------------------------*03080010
028900                                                                  03090010
029000     EXEC SQL                                                     03100010
029100         INCLUDE TEPITM                                           03110010
029200     END-EXEC.                                                    03120010
029300                                                                  03130010
029400*----------------------------------------------------------------*03140010
029500* DB2 TABLE DB2PDBA.TEPIGP - COSA GROUP TABLE                    *03150010
029600*----------------------------------------------------------------*03160010
029700                                                                  03170010
029800     EXEC SQL                                                     03180010
029900         INCLUDE TEPIGP                                           03190010
030000     END-EXEC.                                                    03200010
030100                                                                  03210010
031000*----------------------------------------------------------------*03220010
031100* DB2 TABLE DB2PDBA.TEPLID - LINE ITEM DISCOUNT TABLE            *03230010
031200*----------------------------------------------------------------*03240010
031300                                                                  03250010
031400     EXEC SQL                                                     03260010
031500         INCLUDE TEPLID                                           03270010
031600     END-EXEC.                                                    03280010
031700                                                                  03290010
031800*----------------------------------------------------------------*03300010
031900* DB2 TABLE DB2PDBA.TEPTTD - COSA TRANSACTION TIERED TABLE       *03310010
032000*----------------------------------------------------------------*03320010
032100                                                                  03330010
032200     EXEC SQL                                                     03340010
032300         INCLUDE TEPTTD                                           03350010
032400     END-EXEC.                                                    03360010
032500                                                                  03370010
032600*----------------------------------------------------------------*03380010
032700* STANDARD LAYOUT FOR THE SQL COMMUNICATIONS AREA                *03390010
032800*----------------------------------------------------------------*03400010
032900                                                                  03410010
033000     EXEC SQL                                                     03420010
033100         INCLUDE SQLCA                                            03430010
033200     END-EXEC.                                                    03440010
033300                                                                  03450010
033400     COPY SQLCA2.                                                 03460010
033500                                                                  03470010
033600*----------------------------------------------------------------*03480010
033700* THIS CURSOR SELECTS ALL UNIQUE AD VERSIONS                     *03490010
033800*----------------------------------------------------------------*03500010
033900                                                                  03510010
034000     EXEC SQL                                                     03520010
034100                                                                  03530010
034200       DECLARE AD-VERSION-CSR  CURSOR FOR                         03540010
034300                                                                  03550010
034400        SELECT STR_GP_ID                                          03560010
034500                                                                  03570010
034600          FROM XST_STR_GP_MBSHP                                   03580010
034700                                                                  03590010
034800           WHERE STR_GP_TYP_CDE = :PC-AD-VERSION                  03600010
034900                                                                  03610010
035000             AND  (                                               03620010
035100                   EFF_BEG_DTE <= :PV-DB2-CCYY-MM-DD              03630010
035200                   AND (EFF_END_DTE >= :PV-DB2-CCYY-MM-DD         03640010
035300                        OR EFF_END_DTE IS NULL)                   03650010
035400                   )                                              03660010
035500                                                                  03670010
035600           GROUP BY STR_GP_ID                                     03680010
035700           ORDER BY STR_GP_ID                                     03690010
035800                                                                  03700010
035900        WITH UR                                                   03710010
036000     END-EXEC.                                                    03720010
036100                                                                  03730010
036200*----------------------------------------------------------------*03740010
036300* MAIN CURSOR THAT SELECTS ALL SALE ITEMS FOR THE CURRENT DAY    *03750010
036400* AS WELL AS LATES AND CORRECTIONS FOR PREVIOUS DAYS             *03760010
036500*----------------------------------------------------------------*03770010
036600                                                                  03780010
036700     EXEC SQL                                                     03790010
036800         DECLARE SALEITM-CSR CURSOR FOR                           03800010
036900                                                                  03810010
037000**> FIRST HALF OF THE UNION SELECTS CURRENT DAY DATA              03820010
037100             SELECT  ITM.PARTN_NBR                                03830010
037200                    ,ITM.STR_NBR                                  03840010
037300                    ,ITM.RGST_ID                                  03850010
037400                    ,ITM.TRN_NBR                                  03860010
037500                    ,ITM.STRT_TM                                  03870010
037600                    ,ITM.SLS_CORR_SEQ_NBR                         03880010
037700                    ,ITM.LNE_ITM_SEQ_NBR                          03890010
037800                    ,ITM.SLD_QTY                                  03900010
037900                    ,ITM.SAL_TYP_CDE                              03910010
038000                    ,ITM.ITM_STAT_CDE                             03920010
038100                    ,ITM.SRC_TYP_CDE                              03930010
038200                    ,ITM.PRIC_SRC_CDE                             03940010
038300                    ,ITM.CUST_CHRGD_AMT                           03950010
038400                    ,ITM.REG_RTL_AMT                              03960010
038500                    ,ITM.PROMO_CDE                                03970010
038600                    ,ITM.OWND_UNT_RTL_AMT                         03980010
038700                    ,ITM.SKU_NBR                                  03990010
038800                    ,ITM.RET_AMT                                  04000010
038900                    ,ITM.PROMO_INTFC_ID                           04010010
039000                    ,ITM.PROMO_SCHM_CDE                           04020010
039100                                                                  04030010
039200             FROM TEPPART PRT,                                    04040010
039300                  TEPTRN  TRN,                                    04050010
039400                  TEPITM  ITM,                                    04060010
039500                  XST_LOC LOC,                                    04070010
039600                  XST_STR_GP_MBSHP SGM                            04080010
039700                                                                  04090010
039800              WHERE PRT.SLS_DTE = :PV-DB2-CCYY-MM-DD              04100010
039900                AND PRT.STR_GP_CDE = 'A'                          04110010
040000                AND PRT.DB_STRUC_CDE = 'O'                        04120010
040100                                                                  04130010
040200                AND PRT.PARTN_NBR = TRN.PARTN_NBR                 04140010
040300                                                                  04150010
040400                AND TRN.STR_NBR = LOC.LOC_NBR                     04160010
040500                AND LOC.LOC_NBR = SGM.STR_NBR                     04170010
040600                AND SGM.STR_GP_TYP_CDE = :PC-AD-VERSION           04180010
040700                AND SGM.STR_GP_ID = :XST00023-STR-GP-ID           04190010
040800                AND  (                                            04200010
040900                       SGM.EFF_BEG_DTE <= :PV-DB2-CCYY-MM-DD      04210010
041000                        AND (SGM.EFF_END_DTE >= :PV-DB2-CCYY-MM-DD04220010
041100                             OR EFF_END_DTE IS NULL)              04230010
041200                     )                                            04240010
041300                                                                  04250010
041400                AND TRN.VOID_ABRT_CDE = 'N'                       04260010
041500                AND TRN.TRN_STAT_CDE = 'Z'                        04270010
041600                AND TRN_TYP_CDE IN ('01','02','22','23')          04280010
041700                                                                  04290010
041800                AND TRN.PARTN_NBR = ITM.PARTN_NBR                 04300010
041900                AND TRN.STR_NBR   = ITM.STR_NBR                   04310010
042000                AND TRN.RGST_ID   = ITM.RGST_ID                   04320010
042100                AND TRN.TRN_NBR   = ITM.TRN_NBR                   04330010
042200                AND TRN.STRT_TM   = ITM.STRT_TM                   04340010
042300                AND TRN.SLS_CORR_SEQ_NBR = ITM.SLS_CORR_SEQ_NBR   04350010
042400                                                                  04360010
042500                AND ITM.LIV_RSLU_CDE = '+'                        04370010
042600                AND ITM.CUST_CHRGD_AMT > 0                        04380010
042700                AND ITM.SAL_RET_CDE = 'S'                         04390010
042800                AND ITM.SRVR_ONLN_IND = 'Y'                       04400010
042900                                                                  04410010
043000                AND ITM.DEPT_NBR <> :PC-MISC-DEPT                 04420010
043100                AND ITM.DEPT_NBR <> :PC-GIFT-CERT-DEPT            04430010
043200                AND ITM.DEPT_NBR <> :PC-GIFT-CARD-DEPT            04440010
SEPHOR                AND ITM.DEPT_NBR <> :PC-SEPHORA-GC-DEPT           04441099
043300                AND ITM.DEPT_NBR <> :PC-DEPT-850                  04450010
N2I201                AND ITM.DEPT_NBR <> :PC-TPC-DEPT-833              04460011
N2I201                AND ITM.DEPT_NBR <> :PC-TPC-DEPT-834              04470011
P8612                 AND ITM.DEPT_NBR <> :PC-WAYFAIR-DEPT-070          04471099
043600                                                                  04480010
043700       UNION                                                      04490010
043800                                                                  04500010
043900**> SECOND HALF OF THE UNION SELECTS LATEST AND SALE CORRECTIONS  04510010
044000                                                                  04520010
044100             SELECT  ITM.PARTN_NBR                                04530010
044200                    ,ITM.STR_NBR                                  04540010
044300                    ,ITM.RGST_ID                                  04550010
044400                    ,ITM.TRN_NBR                                  04560010
044500                    ,ITM.STRT_TM                                  04570010
044600                    ,ITM.SLS_CORR_SEQ_NBR                         04580010
044700                    ,ITM.LNE_ITM_SEQ_NBR                          04590010
044800                    ,ITM.SLD_QTY                                  04600010
044900                    ,ITM.SAL_TYP_CDE                              04610010
045000                    ,ITM.ITM_STAT_CDE                             04620010
045100                    ,ITM.SRC_TYP_CDE                              04630010
045200                    ,ITM.PRIC_SRC_CDE                             04640010
045300                    ,ITM.CUST_CHRGD_AMT                           04650010
045400                    ,ITM.REG_RTL_AMT                              04660010
045500                    ,ITM.PROMO_CDE                                04670010
045600                    ,ITM.OWND_UNT_RTL_AMT                         04680010
045700                    ,ITM.SKU_NBR                                  04690010
045800                    ,ITM.RET_AMT                                  04700010
045900                    ,ITM.PROMO_INTFC_ID                           04710010
046000                    ,ITM.PROMO_SCHM_CDE                           04720010
046100                                                                  04730010
046200             FROM TEPPART PRT,                                    04740010
046300                  TEPTRN  TRN,                                    04750010
046400                  TEPITM  ITM,                                    04760010
046500                  TEPDKEY DKY,                                    04770010
046600                  XST_LOC LOC,                                    04780010
046700                  XST_STR_GP_MBSHP SGM                            04790010
046800                                                                  04800010
046900              WHERE DKY.PRCG_DTE = :PV-DB2-CCYY-MM-DD             04810010
047000                                                                  04820010
047100                AND DKY.SLS_DTE  = PRT.SLS_DTE                    04830010
047200                AND PRT.STR_GP_CDE = 'A'                          04840010
047300                AND PRT.DB_STRUC_CDE = 'O'                        04850010
047400                                                                  04860010
047500                AND PRT.PARTN_NBR = TRN.PARTN_NBR                 04870010
047600                                                                  04880010
047700                AND DKY.STR_NBR   = TRN.STR_NBR                   04890010
047800                AND DKY.RGST_ID   = TRN.RGST_ID                   04900010
047900                AND DKY.TRN_NBR   = TRN.TRN_NBR                   04910010
048000                AND DKY.STRT_TM   = TRN.STRT_TM                   04920010
048100                AND DKY.SLS_CORR_SEQ_NBR = TRN.SLS_CORR_SEQ_NBR   04930010
048200                                                                  04940010
048300                AND TRN.STR_NBR = LOC.LOC_NBR                     04950010
048400                AND LOC.LOC_NBR = SGM.STR_NBR                     04960010
048500                AND SGM.STR_GP_TYP_CDE = :PC-AD-VERSION           04970010
048600                AND SGM.STR_GP_ID = :XST00023-STR-GP-ID           04980010
048700                AND  (                                            04990010
048800                       SGM.EFF_BEG_DTE <= :PV-DB2-CCYY-MM-DD      05000010
048900                        AND (SGM.EFF_END_DTE >= :PV-DB2-CCYY-MM-DD05010010
049000                             OR EFF_END_DTE IS NULL)              05020010
049100                     )                                            05030010
049200                                                                  05040010
049300                AND TRN.VOID_ABRT_CDE = 'N'                       05050010
049400                AND TRN.TRN_STAT_CDE IN ('V','L')                 05060010
049500                AND TRN_TYP_CDE IN ('01','02','22','23')          05070010
049600                                                                  05080010
049700                AND TRN.PARTN_NBR = ITM.PARTN_NBR                 05090010
049800                AND TRN.STR_NBR   = ITM.STR_NBR                   05100010
049900                AND TRN.RGST_ID   = ITM.RGST_ID                   05110010
050000                AND TRN.TRN_NBR   = ITM.TRN_NBR                   05120010
050100                AND TRN.STRT_TM   = ITM.STRT_TM                   05130010
050200                AND TRN.SLS_CORR_SEQ_NBR = ITM.SLS_CORR_SEQ_NBR   05140010
050300                                                                  05150010
050400                AND ITM.LIV_RSLU_CDE = '+'                        05160010
050500                AND ITM.CUST_CHRGD_AMT > 0                        05170010
050600                AND ITM.SAL_RET_CDE = 'S'                         05180010
050700                AND ITM.SRVR_ONLN_IND = 'Y'                       05190010
050800                                                                  05200010
050900                AND ITM.DEPT_NBR <> :PC-MISC-DEPT                 05210010
051000                AND ITM.DEPT_NBR <> :PC-GIFT-CERT-DEPT            05220010
051100                AND ITM.DEPT_NBR <> :PC-GIFT-CARD-DEPT            05230010
SEPHOR                AND ITM.DEPT_NBR <> :PC-SEPHORA-GC-DEPT           05231099
051200                AND ITM.DEPT_NBR <> :PC-DEPT-850                  05240010
N2I201                AND ITM.DEPT_NBR <> :PC-TPC-DEPT-833              05250011
N2I201                AND ITM.DEPT_NBR <> :PC-TPC-DEPT-834              05260011
P8612                 AND ITM.DEPT_NBR <> :PC-WAYFAIR-DEPT-070          05261099
051500                                                                  05270010
051600        ORDER BY SKU_NBR                                          05280010
051700                                                                  05290010
051800        WITH UR                                                   05300010
051900                                                                  05310010
052000     END-EXEC.                                                    05320010
052100                                                                  05330010
052200 01  EW-END-WORKING-STORAGE           PIC X(32)      VALUE        05340096
052300     ' END OF WORKING STORAGE SECTION '.                          05350010
052400                                                                  05360010
052500*----------------------------------------------------------------*05370010
052600 PROCEDURE DIVISION.                                              05380010
052700*----------------------------------------------------------------*05390010
052800                                                                  05400010
052900 0000-MAINLINE-LOGIC.                                             05410010
053000     PERFORM 1000-INITIALIZE.                                     05420010
053100     PERFORM 2000-PROCESS-AD-VERSIONS.                            05430010
053200     PERFORM 8000-CLOSING-ROUTINE.                                05440010
053300     GOBACK.                                                      05450010
053400                                                                  05460010
053500*----------------------------------------------------------------*05470010
053600*1000-INITIALIZE.                                                *05480010
053700*    THE INITIALIZTION ROUTINE OPENS FILES AND READS IN THE      *05490010
053800*    CONTROL CARD DATE.                                          *05500010
053900*----------------------------------------------------------------*05510010
054000 1000-INITIALIZE.                                                 05520010
054100                                                                  05530010
054200     OPEN INPUT   POS-DATE-FILE.                                  05540010
054300                                                                  05550010
054400     OPEN OUTPUT  LWST-W13-WEEK-LOAD-FILE                         05560012
054500                  PLU-CHGS-EXTRACT-FILE.                          05570010
054600                                                                  05580010
054700     READ POS-DATE-FILE INTO CC-CONTROL-CARD                      05590010
054800         AT END                                                   05600010
054900             SET PS-END-OF-DATE-FILE TO TRUE.                     05610010
055000                                                                  05620010
055100     IF PS-END-OF-DATE-FILE                                       05630010
055200         MOVE '1000-INITIALIZE'         TO PV-PARAGRAPH-NAME      05640010
055300         MOVE 'DATE CARD MISSING      ' TO PV-OPERATION-MSG-1     05650010
055400         SET AC-CONTROL-CARD-ERROR TO TRUE                        05660010
055500         PERFORM 9999-ABEND                                       05670010
055600     END-IF.                                                      05680010
055700                                                                  05690010
055800     DISPLAY PC-CURRENT-PROGRAM-NAME                              05700010
055900             ' - CONTROL CARD = (' CC-PROCDT-CCYY-MM-DD ')'.      05710010
056000                                                                  05720010
056100     MOVE CC-PROCDT-CCYY-MM-DD TO PV-DB2-CCYY-MM-DD.              05730010
056200                                                                  05740010
056300     CLOSE POS-DATE-FILE.                                         05750010
056400                                                                  05760010
056500     PERFORM 1100-FIND-FISCAL-WK-BEG-DT.                          05770010
056600     PERFORM 1200-FIND-OLDEST-13WK-PRD-DT.                        05780012
056700                                                                  05790010
056800*----------------------------------------------------------------*05800010
056900*1100-FIND-FISCAL-WK-BEG-DT.                                     *05810010
057000*    USES THE CONTROL CARD DATE TO OBTAIN THE FIRST FISCAL DAY   *05820010
057100*    OF THE WEEK.                                                *05830010
057200*----------------------------------------------------------------*05840010
057300 1100-FIND-FISCAL-WK-BEG-DT.                                      05850010
057400                                                                  05860010
057500     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              05870010
057600                                                                  05880010
057700     SET  DPG51-ACTUAL-CALENDAR-ONLY   TO TRUE.                   05890010
057800     SET  DPG51-DO-NOT-INCR-DECR-DATE  TO TRUE.                   05900010
057900     SET  DPG52-LK-DTE-ISO-FMT         TO TRUE.                   05910010
058000     MOVE CC-PROCDT-CCYY-MM-DD         TO DPG52-LK-DATE-INPUT.    05920010
058100     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    05930010
058200                                             DPG54 DPG55 DPG56.   05940010
058300     EVALUATE TRUE                                                05950010
058400         WHEN DPG54-SEVERE-ERROR                                  05960010
058500         WHEN DPG54-DATE-INVALID                                  05970010
058600             MOVE '1100-FIND-FISCAL-WK-BEG-DT'                    05980010
058700                                           TO PV-PARAGRAPH-NAME   05990010
058800             MOVE 'ERROR CONVERTING INPUT CARD DATE'              06000010
058900                                           TO PV-OPERATION-MSG-1  06010010
059000             SET AC-CALENDAR-ROUTINE-ERROR TO TRUE                06020010
059100             MOVE DPG54-ERROR-MESSAGE      TO PV-OPERATION-MSG-2  06030010
059200             PERFORM 9999-ABEND                                   06040010
059300     END-EVALUATE.                                                06050010
059400                                                                  06060010
059500     MOVE DPG55-1ST-WKDY-DB2ISO-FMT  TO                           06070010
059600                                       PV-WEEK-BEG-DT-CCYY-MM-DD  06080010
059700                                                                  06090010
059800     DISPLAY 'WEEK BEGIN DATE= ' PV-WEEK-BEG-DT-CCYY-MM-DD.       06100010
059900                                                                  06110010
060000*----------------------------------------------------------------*06120010
060100*1200-FIND-OLDEST-13WK-PRD-DT.                                   *06130012
060200*    THIS SECTION FINDS THE WEEK BEGIN DATE LOOKING BACK 13      *06140012
060300*    WEEKS.                                                      *06150010
060400*----------------------------------------------------------------*06160010
060500 1200-FIND-OLDEST-13WK-PRD-DT.                                    06170012
060600                                                                  06180010
060700     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              06190010
060800                                                                  06200010
060900     SET  DPG51-ACTUAL-CALENDAR-ONLY   TO TRUE.                   06210010
061000     SET  DPG51-DECREMENT-DATE         TO TRUE.                   06220010
061100     MOVE PC-DECREMENT-DAYS            TO DPG51-INCR-DECR-DAYS-X. 06230010
061200     SET  DPG52-LK-DTE-ISO-FMT         TO TRUE.                   06240010
061300     MOVE CC-PROCDT-CCYY-MM-DD         TO DPG52-LK-DATE-INPUT.    06250010
061400     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    06260010
061500                                             DPG54 DPG55 DPG56.   06270010
061600     EVALUATE TRUE                                                06280010
061700         WHEN DPG54-SEVERE-ERROR                                  06290010
061800         WHEN DPG54-DATE-INVALID                                  06300010
061900             MOVE '1100-FIND-FISCAL-WK-BEG-DT'                    06310010
062000                                           TO PV-PARAGRAPH-NAME   06320010
062100             MOVE 'ERROR CONVERTING INPUT CARD DATE'              06330010
062200                                           TO PV-OPERATION-MSG-1  06340010
062300             SET AC-CALENDAR-ROUTINE-ERROR TO TRUE                06350010
062400             MOVE DPG54-ERROR-MESSAGE      TO PV-OPERATION-MSG-2  06360010
062500             PERFORM 9999-ABEND                                   06370010
062600     END-EVALUATE.                                                06380010
062700     MOVE DPG55-1ST-WKDY-DB2ISO-FMT  TO                           06390010
062800                                        PV-OLDEST-WEEK-BEG-DT.    06400010
062900                                                                  06410010
063000     DISPLAY 'OLDEST WEEK BEGIN DATE= ' PV-OLDEST-WEEK-BEG-DT.    06420010
063100                                                                  06430010
063200*----------------------------------------------------------------*06440010
063300*2000-PROCESS-AD-VERSIONS.                                       *06450010
063400*    THIS SECTION PERFORMS THE LOGIC TO CYCLE THROUGH SALE ITEMS *06460010
063500*    FOR THE DAY, EXECUTING ONCE PER AD VERSION.  IT WILL        *06470010
063600*    DETERMINE IF AN ITEM NEEDS TO BE INCORPORATED ONTO THE      *06480010
063700*    LOWEST 13  WEEK PRICE EXTRACT FILE, AS WELL AS POSSIBLY     *06490012
063800*    THE PLU CHANGES FILE IF A NEW LOWEST PRICE OVER HISTORY     *06500010
063900*    IS ENCOUNTERED.                                             *06510010
064000*----------------------------------------------------------------*06520010
064100 2000-PROCESS-AD-VERSIONS.                                        06530010
064200                                                                  06540010
064300     PERFORM 2100-OPEN-AD-VERSION-CSR.                            06550010
064400     PERFORM 2200-PROCESS-AD-VERSION-CSR                          06560010
064500               UNTIL PS-END-OF-AD-VERSION-CSR.                    06570010
064600     PERFORM 2900-CLOSE-AD-VERSION-CSR.                           06580010
064700                                                                  06590010
064800*----------------------------------------------------------------*06600010
064900*2100-OPEN-AD-VERSION-CSR.                                       *06610010
065000*    THIS SECTION OPENS THE AD VERSION CURSOR                    *06620010
065100*----------------------------------------------------------------*06630010
065200 2100-OPEN-AD-VERSION-CSR.                                        06640010
065300                                                                  06650010
065400     EXEC SQL                                                     06660010
065500          OPEN AD-VERSION-CSR                                     06670010
065600     END-EXEC.                                                    06680010
065700                                                                  06690010
065800     EVALUATE TRUE                                                06700010
065900         WHEN SQLCODE = ZERO                                      06710010
066000              SET PS-NOT-END-OF-AD-VERSION-CSR TO TRUE            06720010
066100              PERFORM 2800-FETCH-AD-VERSION-CSR                   06730010
066200         WHEN SQLWARN0 NOT EQUAL SPACE                            06740010
066300         WHEN SQLCODE NOT EQUAL ZERO                              06750010
066400             MOVE '2100-OPEN-AD-VERSION-CSR'                      06760010
066500                                   TO PV-PARAGRAPH-NAME           06770010
066600             MOVE 'ERROR ON OPEN OF ADVER CSR'                    06780010
066700                                   TO PV-DB2-OPERATION            06790010
066800             DISPLAY 'SQLCODE= ' SQLCODE                          06800010
066900             PERFORM 9900-SQL-ABEND                               06810010
067000     END-EVALUATE.                                                06820010
067100                                                                  06830010
067200*----------------------------------------------------------------*06840010
067300*2200-PROCESS-AD-VERSION-CSR                                     *06850010
067400*    THIS SECTION WILL PERFORM ONE TIME FOR EACH AD VERSION.     *06860010
067500*    IT WILL PROCESS ALL ITEMS WITHING AN AD VERSION TO DETERMINE*06870010
067600*    WHAT IF ANY OUTPUT RECORDS NEED TO BE CREATED.              *06880010
067700*----------------------------------------------------------------*06890010
067800 2200-PROCESS-AD-VERSION-CSR.                                     06900010
067900                                                                  06910010
068000     PERFORM 3000-PROCESS-ITEMS.                                  06920010
068100     PERFORM 2800-FETCH-AD-VERSION-CSR.                           06930010
068200                                                                  06940010
068300***************************************************************** 06950010
068400**2800-FETCH-AD-VERSION-CSR.                                      06960010
068500**    FETCH THE NEXT ROW FROM AD VERSION CURSOR.  WHEN NO MORE    06970010
068600**    AD VERSIONS SETS END OF ADVERSION CURSOR TO TRUE.           06980010
068700***************************************************************** 06990010
068800 2800-FETCH-AD-VERSION-CSR.                                       07000010
068900                                                                  07010010
069000     EXEC SQL                                                     07020010
069100          FETCH AD-VERSION-CSR                                    07030010
069200           INTO :XST00023-STR-GP-ID                               07040010
069300     END-EXEC.                                                    07050010
069400                                                                  07060010
069500     EVALUATE TRUE                                                07070010
069600         WHEN SQLCODE = ZERO                                      07080010
069700             ADD +1 TO PA-AD-VERSION-CNT                          07090010
069800             DISPLAY 'FETCHED NEW AD VERSION: ' XST00023-STR-GP-ID07100010
069900         WHEN SQLCODE = PC-ROW-NOT-FOUND                          07110010
070000             SET PS-END-OF-AD-VERSION-CSR TO TRUE                 07120010
070100         WHEN SQLWARN0 NOT EQUAL SPACE                            07130010
070200         WHEN SQLCODE NOT EQUAL ZERO                              07140010
070300             MOVE '2800-FETCH-AD-VERSION-CSR'                     07150010
070400                                   TO PV-PARAGRAPH-NAME           07160010
070500             MOVE 'ERROR ON FETCH OF STORE CSR'                   07170010
070600                                   TO PV-DB2-OPERATION            07180010
070700             DISPLAY 'SQLCODE= ' SQLCODE                          07190010
070800             PERFORM 9900-SQL-ABEND                               07200010
070900     END-EVALUATE.                                                07210010
071000                                                                  07220010
071100*----------------------------------------------------------------*07230010
071200*2900-CLOSE-AD-VERSION-CSR.                                      *07240010
071300*    THIS SECTION CLOSES THE AD VERSION CURSOR                   *07250010
071400*----------------------------------------------------------------*07260010
071500 2900-CLOSE-AD-VERSION-CSR.                                       07270010
071600                                                                  07280010
071700     EXEC SQL                                                     07290010
071800          CLOSE AD-VERSION-CSR                                    07300010
071900     END-EXEC.                                                    07310010
072000                                                                  07320010
072100     EVALUATE TRUE                                                07330010
072200         WHEN SQLCODE = ZERO                                      07340010
072300              CONTINUE                                            07350010
072400         WHEN SQLWARN0 NOT EQUAL SPACE                            07360010
072500         WHEN SQLCODE NOT EQUAL ZERO                              07370010
072600             MOVE '2900-CLOSE-AD-VERSION-CSR'                     07380010
072700                                   TO PV-PARAGRAPH-NAME           07390010
072800             MOVE 'ERROR ON CLOSE OF ADVER CSR'                   07400010
072900                                   TO PV-DB2-OPERATION            07410010
073000             DISPLAY 'SQLCODE= ' SQLCODE                          07420010
073100             PERFORM 9900-SQL-ABEND                               07430010
073200     END-EVALUATE.                                                07440010
073300                                                                  07450010
073400*----------------------------------------------------------------*07460010
073500*3000-PROCESS-ITEMS.                                             *07470010
073600*    THIS SECTION WILL WORK WITH A CURSOR SELECTING ALL SALE     *07480010
073700*    ITEMS FOR THE DAY WITHIN THE CURRENT AD VERSION.            *07490010
073800*----------------------------------------------------------------*07500010
073900 3000-PROCESS-ITEMS.                                              07510010
074000                                                                  07520010
074100     PERFORM 3100-OPEN-SALEITM-CSR.                               07530010
074200     PERFORM 3200-PROCESS-SALEITM-CSR                             07540010
074300               UNTIL PS-END-OF-SALEITM-CSR.                       07550010
074400                                                                  07560010
074500**** PROCESS THE LAST SKU FOR AN AD VERSION                       07570010
074600     IF PA-AD-VERSION-ITM-CNT > 0                                 07580010
074700       IF PS-SKU-NOT-INVALID                                      07590010
074800          PERFORM 3500-SELECT-INTR-UPC-ID                         07600010
074900          IF PS-SKU-FOUND                                         07610010
075000            PERFORM 3600-FORMAT-OUTPUT-FILES                      07620010
075100          END-IF                                                  07630010
075200       END-IF                                                     07640010
075300     END-IF.                                                      07650010
075400                                                                  07660010
075500     DISPLAY 'ADVERSION ' XST00023-STR-GP-ID ' CNT= '             07670010
075600          PA-AD-VERSION-ITM-CNT.                                  07680010
075700     PERFORM 3900-CLOSE-SALEITM-CSR .                             07690010
075800     MOVE ZEROS TO PA-AD-VERSION-ITM-CNT.                         07700010
075900                                                                  07710010
076000*----------------------------------------------------------------*07720010
076100*3100-OPEN-SALEITM-CSR.                                          *07730010
076200*    THIS SECTION OPENS THE SALE ITEM CURSOR                     *07740010
076300*----------------------------------------------------------------*07750010
076400 3100-OPEN-SALEITM-CSR.                                           07760010
076500                                                                  07770010
076600     EXEC SQL                                                     07780010
076700          OPEN SALEITM-CSR                                        07790010
076800     END-EXEC.                                                    07800010
076900                                                                  07810010
077000     EVALUATE TRUE                                                07820010
077100         WHEN SQLCODE = ZERO                                      07830010
077200              SET PS-FIRST-AD-VERSION-SKU                         07840010
077300                  PS-NOT-END-OF-SALEITM-CSR TO TRUE               07850010
077400              PERFORM 3800-FETCH-SALEITM-CSR                      07860010
077500         WHEN SQLWARN0 NOT EQUAL SPACE                            07870010
077600         WHEN SQLCODE NOT EQUAL ZERO                              07880010
077700             MOVE '3100-OPEN-SALEITM-CSR'                         07890010
077800                                   TO PV-PARAGRAPH-NAME           07900010
077900             MOVE 'ERROR ON OPEN OF ADVER CSR'                    07910010
078000                                   TO PV-DB2-OPERATION            07920010
078100             DISPLAY 'SQLCODE= ' SQLCODE                          07930010
078200             PERFORM 9900-SQL-ABEND                               07940010
078300     END-EVALUATE.                                                07950010
078400                                                                  07960010
078500*----------------------------------------------------------------*07970010
078600*3200-PROCESS-SALEITM-CSR                                        *07980010
078700*    THIS SECTION PROCESSES EACH ITEM FETCHED FROM THE SALEITM   *07990010
078800*    CURSOR, AND FOR EACH ONE CALCULATES A 'LOWEST 13  WEEK PRIC'*08000012
078900*    VALUE, DEFINED AS THE SALE PRICE, EXCLUDING GROUP PRICING,  *08010010
079000*    MANUAL MARKDOWNS OR TLD'S, EMPLOYEE DISCOUNTS, AND TIERED   *08020010
079100*    IS EXCLUDED UNLESS A TIERED QTY OF 1 PROMOTION IS IN EFFECT.*08030010
079200*    IN ADDITION KEYED ITEMS ARE DISREGARDED UNLESS THE REGISTER *08040010
079300*    IS ONLINE AND THE ITEM HAS A CLEARANCE STATUS.              *08050010
079400*----------------------------------------------------------------*08060010
079500 3200-PROCESS-SALEITM-CSR.                                        08070010
079600                                                                  08080010
079700     IF PS-NOT-FIRST-AD-VERSION-SKU                               08090010
079800        IF EPITM-SKU-NBR = PV-SAVED-SKU-NBR                       08100010
079900           CONTINUE                                               08110010
080000        ELSE                                                      08120010
080100           IF PS-SKU-NOT-INVALID                                  08130010
080200             PERFORM 3500-SELECT-INTR-UPC-ID                      08140010
080300             IF PS-SKU-FOUND                                      08150010
080400               PERFORM 3600-FORMAT-OUTPUT-FILES                   08160010
080500             END-IF                                               08170010
080600           END-IF                                                 08180010
080700           MOVE ZEROS TO PV-LWST-W13-WK-VALUE                     08190012
080800                         PV-LWST-W13-WK-VALUE-SVD                 08200012
080900           MOVE EPITM-SKU-NBR TO PV-SAVED-SKU-NBR                 08210010
081000           ADD +1             TO PA-DISTN-ADVER-SKU-CNT           08220010
081100        END-IF                                                    08230010
081200     ELSE                                                         08240010
081300        MOVE ZEROS TO PV-LWST-W13-WK-VALUE                        08250012
081400                      PV-LWST-W13-WK-VALUE-SVD                    08260012
081500        MOVE EPITM-SKU-NBR TO PV-SAVED-SKU-NBR                    08270010
081600        ADD +1             TO PA-DISTN-ADVER-SKU-CNT              08280010
081700        SET PS-NOT-FIRST-AD-VERSION-SKU TO TRUE                   08290010
081800     END-IF.                                                      08300010
081900                                                                  08310010
082000     PERFORM 3300-FILTER-INVALID-SKUS.                            08320010
082100     PERFORM 3800-FETCH-SALEITM-CSR.                              08330010
082200                                                                  08340010
082300*----------------------------------------------------------------*08350010
082400*3300-FILTER-INVALID-SKUS.                                       *08360010
082500*    FILTERS OUT INVALID SKUS, INCLUDING:                        *08370010
082600*   -DUMMY SKUS                                                  *08380010
082700*   -HAND KEYED SKUS UNLESS CLEARANCE, ONLINE, AND KEYED         *08390010
082800*----------------------------------------------------------------*08400010
082900 3300-FILTER-INVALID-SKUS.                                        08410010
083000                                                                  08420010
083100     MOVE EPITM-SKU-NBR     TO PV-SKU-CHAR.                       08430010
083200     SET PS-SKU-NOT-INVALID TO TRUE.                              08440010
083300                                                                  08450010
083400     IF PV-LAST-3-CHAR-SKU  NOT EQUAL PC-DUMMY                    08460010
083500        IF (EPITM-PRIC-SRC-CDE = PC-ISP) OR                       08470010
083600             (EPITM-PRIC-SRC-CDE = PC-KEYED-BY-OPERATOR AND       08480010
083700              EPITM-ITM-STAT-CDE = PC-CLEARANCE)                  08490010
083800           PERFORM 3400-CALC-LWST-13WK-VALUE                      08500012
083900        ELSE                                                      08510010
084000           SET PS-INVALID-SKU TO TRUE                             08520010
084100           ADD +1 TO PA-INVALID-ITEM-CNT                          08530010
084200        END-IF                                                    08540010
084300     ELSE                                                         08550010
084400        SET PS-INVALID-SKU TO TRUE                                08560010
084500        ADD +1 TO PA-INVALID-ITEM-CNT                             08570010
084600     END-IF.                                                      08580010
084700                                                                  08590010
084800***************************************************************** 08600010
084900**3400-CALC-LWST-13WK-VALUE.                                      08610012
085000**    CALCULATES THE LOWEST 13  WEEK PRICE VALUE AND STORES IT    08620012
085100**    IF IT'S LESS THAN THE PREVIOUS VALUE.                       08630010
085200**    THIS PARAGRAPH WILL CALCULATE THE VALUE DIFFERENTLY         08640010
085300**    DEPENDING ON IF THE STORE HAS BEEN CONVERTED TO NEW PROMO   08650010
085400**    OR NOT (USING POS CAP LEVEL TO KNOW THE DIFFERENCE)         08660010
085500**                                                                08670010
085600***************************************************************** 08680010
085700 3400-CALC-LWST-13WK-VALUE.                                       08690012
085800                                                                  08700010
085900     MOVE ZEROS TO PV-LWST-W13-WK-VALUE.                          08710012
086000                                                                  08720010
086100     PERFORM 3410-SELECT-ITM-GRP-INFO.                            08730010
086200                                                                  08740010
086300     COMPUTE EPITM-CUST-CHRGD-AMT =                               08750010
086400        EPITM-CUST-CHRGD-AMT / EPITM-SLD-QTY.                     08760010
086500                                                                  08770010
088800     SET PS-MAN-LID-N       TO TRUE.                              08780056
086500                                                                  08790056
086600     PERFORM 3420-CALC-LW13WKPR.                                  08800013
086700                                                                  08810010
086800     IF PS-MAN-LID-N                                              08820010
086900*** FACTOR IN ANY GOLDSTAR DISCOUNTS AS THEY ARE NOT REFLECTED IN 08830010
087000*** THE CUSTOMER CHARGED AMOUNT FIELD.                            08840010
087100                                                                  08850010
087200        IF EPITM-SAL-TYP-CDE = PC-GOLDSTAR-SAL-TYP-CDE            08860010
087300           PERFORM 3450-RETRV-ANY-GOLDSTAR-MKDN                   08870010
087400           COMPUTE PV-LWST-W13-WK-VALUE = PV-LWST-W13-WK-VALUE +  08880012
087500                      EPLID-LID-AMT                               08890010
087600        END-IF                                                    08900010
087700                                                                  08910010
087800*** FACTOR IN ANY TIERED DISCOUNTS AT A QUANTITY OF ONE AS THEY   08920010
087900*** ARE NOT INCLUDED INSDIE OF CUSTOMER CHARGED AMOUNT.           08930010
088000                                                                  08940010
088100        PERFORM 3460-SLCT-TIER-INFO                               08950010
088200                                                                  08960010
088300        IF PV-LWST-W13-WK-VALUE < PV-LWST-W13-WK-VALUE-SVD        08970012
088400             OR PV-LWST-W13-WK-VALUE-SVD = 0                      08980012
088500           MOVE PV-LWST-W13-WK-VALUE TO PV-LWST-W13-WK-VALUE-SVD  08990012
088600        END-IF                                                    09000010
088700     ELSE                                                         09010010
088800        SET PS-MAN-LID-N       TO TRUE                            09020010
088900     END-IF.                                                      09030010
089000                                                                  09040010
089100     IF PV-LWST-W13-WK-VALUE-SVD < 0                              09050012
089200        DISPLAY 'ERROR - 13  WEEK VALUE < 0!!'                    09060012
089300        DISPLAY 'SKU= ' EPITM-SKU-NBR                             09070010
089400        DISPLAY 'STR= ' EPITM-STR-NBR                             09080010
089500        DISPLAY 'RGST= ' EPITM-RGST-ID                            09090010
089600        DISPLAY 'TRAN= ' EPITM-TRN-NBR                            09100010
089700        DISPLAY 'LNE #= ' EPITM-LNE-ITM-SEQ-NBR                   09110010
089800        DISPLAY 'PV-LWST-W13-WK-VALUE= ' PV-LWST-W13-WK-VALUE-SVD 09120012
089900        SET PS-INVALID-SKU TO TRUE                                09130010
090000        ADD +1 TO PA-INVALID-ITEM-CNT                             09140010
090100     END-IF.                                                      09150010
090200                                                                  09160010
090300***************************************************************** 09170010
090400**3410-SELECT-ITM-GRP-INFO.                                       09180010
090500**    SELECTS ANY PROMOTIONAL OR REGULAR GROUP PRICING INFORMATION09190010
090600**    IF AVAILABLE ON THE GROUP TABLE                             09200010
090700***************************************************************** 09210010
090800 3410-SELECT-ITM-GRP-INFO.                                        09220010
090900                                                                  09230010
091000     MOVE ZEROS TO EPIGP-GP-QTY                                   09240010
091100                   EPIGP-GP-AMT                                   09250010
091200                   PV-GRP-EACH-PRICE.                             09260010
091300                                                                  09270010
091400     EXEC SQL                                                     09280010
091500                                                                  09290010
091600        SELECT  GP_NBR                                            09300010
091700               ,GP_QTY                                            09310010
091800               ,GP_AMT                                            09320010
091900                                                                  09330010
092000          INTO :EPIGP-GP-NBR                                      09340010
092100              ,:EPIGP-GP-QTY                                      09350010
092200              ,:EPIGP-GP-AMT                                      09360010
092300                                                                  09370010
092400          FROM  TEPIGP                                            09380010
092500                                                                  09390010
092600         WHERE  PARTN_NBR        = :EPITM-PARTN-NBR               09400010
092700           AND  STR_NBR          = :EPITM-STR-NBR                 09410010
092800           AND  RGST_ID          = :EPITM-RGST-ID                 09420010
092900           AND  TRN_NBR          = :EPITM-TRN-NBR                 09430010
093000           AND  STRT_TM          = :EPITM-STRT-TM                 09440010
093100           AND  SLS_CORR_SEQ_NBR = :EPITM-SLS-CORR-SEQ-NBR        09450010
093200           AND  LNE_ITM_SEQ_NBR  = :EPITM-LNE-ITM-SEQ-NBR         09460010
093300       WITH UR                                                    09470010
093400     END-EXEC.                                                    09480010
093500                                                                  09490010
093600     EVALUATE TRUE                                                09500010
093700        WHEN SQLCODE = ZERO                                       09510010
093800           SET PS-HAS-GROUP-PRICING TO TRUE                       09520010
093900           COMPUTE PV-GRP-EACH-PRICE =                            09530010
094000           EPIGP-GP-AMT / EPIGP-GP-QTY                            09540010
094100        WHEN SQLCODE = PC-ROW-NOT-FOUND                           09550010
094200           SET PS-NO-GROUP-PRICING TO TRUE                        09560010
094300        WHEN OTHER                                                09570010
094400           MOVE '3410-SELECT-ITM-GRP-INFO'                        09580010
094500                                TO PV-PARAGRAPH-NAME              09590010
094600           MOVE 'ERROR ON SEL OF GRP INFO'                        09600010
094700                                TO PV-DB2-OPERATION               09610010
094800           DISPLAY 'SQLCODE= ' SQLCODE                            09620010
094900           DISPLAY 'PART= ' EPITM-PARTN-NBR                       09630010
095000           DISPLAY 'STR= ' EPITM-STR-NBR                          09640010
095100           DISPLAY 'RGST= ' EPITM-RGST-ID                         09650010
095200           DISPLAY 'TRN= ' EPITM-TRN-NBR                          09660010
095300           DISPLAY 'STRT TM= ' EPITM-STRT-TM                      09670010
095400           DISPLAY 'SLS CORR SEQ= ' EPITM-SLS-CORR-SEQ-NBR        09680010
095500           DISPLAY 'LNE ITEM SEQ = ' EPITM-LNE-ITM-SEQ-NBR        09690010
095600           PERFORM 9900-SQL-ABEND                                 09700010
095700     END-EVALUATE.                                                09710010
095800                                                                  09720010
095900***************************************************************** 09730010
096000**3420-CALC-LW13WKPR.                                             09740013
096100**    CALCULATE THE LOWEST 13  WEEK PRICE IF A STORE HAS BEEN     09750012
096200**    CONVERTED TO NEW PROMO.  IF NO GROUP PRICING EXISTS, THEN   09760010
096300**    THE PROGRAM CAN USE THE CUSTOMER CHARGED AMOUNT.  IF GROUP  09770010
096400**    PRICING IS PRSENT ON THE GROUP TABLE, CUSTOMER CHARGED AMOUN09780010
096500**    CAN ONLY BE USED IF A NON-GROUP PRICING SCHEME IS PRESENT   09790010
096600**    (IN ADDITION PRICING SCHEME CANNOT = 0).  IF THAT IS NOT    09800010
096700**    THE CASE REGULAR RETAIL IS USED, UNLESS IT'S 0 IN WHICH     09810010
096800**    CASE THE OWNED AMOUNT IS USED.                              09820010
096900***************************************************************** 09830010
097000 3420-CALC-LW13WKPR.                                              09840013
097100                                                                  09850010
097200     IF EPITM-RET-AMT NOT EQUAL TO ZERO                           09860010
097300        PERFORM 3430-CHECK-MAN-LID                                09870010
097400        IF PS-MAN-LID-N                                           09880010
097500           MOVE EPITM-RET-AMT           TO PV-LWST-W13-WK-VALUE   09890012
097600        END-IF                                                    09900010
097700     ELSE                                                         09910010
097800        IF PS-NO-GROUP-PRICING                                    09920010
097900           MOVE EPITM-CUST-CHRGD-AMT    TO PV-LWST-W13-WK-VALUE   09930012
098000        ELSE                                                      09940010
098100                                                                  09950010
098200** THIS IS SO BECAUSE CAN HAVE PERMANENT GROUP PRICING INFO       09960010
098300** TIED TO AN ITEM THAT RECEIVED A SIMPLE PROMOTION AND NOT THE   09970010
098400** PERM GRP PRICING                                               09980010
098500           IF NOT GROUP-PRICING-SCHEME                            09990010
098600              MOVE EPITM-CUST-CHRGD-AMT TO PV-LWST-W13-WK-VALUE   10000012
098700           ELSE                                                   10010010
098800              IF EPITM-REG-RTL-AMT > 0                            10020010
098900                 MOVE EPITM-REG-RTL-AMT      TO                   10030010
099000                                       PV-LWST-W13-WK-VALUE       10040012
099100              ELSE                                                10050010
099200                 MOVE EPITM-OWND-UNT-RTL-AMT TO                   10060010
099300                                       PV-LWST-W13-WK-VALUE       10070012
099400              END-IF                                              10080010
099500                                                                  10090010
099600           END-IF                                                 10100010
099700        END-IF                                                    10110010
099800     END-IF.                                                      10120010
099900                                                                  10130010
100000***************************************************************** 10140010
100100***************************************************************** 10150007
100200**3430-CHECK-MAN-LID.                                             10160007
100300**    CHECKS TO SEE IF A MANUAL LID EXISTS FOR BOGO ITEMS.        10170007
100400**    IF A MANUAL LID EXISTS, THIS ITEM WILL NOT BE USED IN       10180007
100500**    THE LOWEST 13 WEEKS PRICE LOGIC.                            10190018
100600***************************************************************** 10200007
100700 3430-CHECK-MAN-LID.                                              10210007
100800                                                                  10220007
100900     EXEC SQL                                                     10230007
101000         SELECT 'X'                                               10240007
101100           INTO :PV-EXISTS-BYTE                                   10250007
101200           FROM TEPLID                                            10260007
101300         WHERE PARTN_NBR         = :EPITM-PARTN-NBR               10270007
101400           AND  STR_NBR          = :EPITM-STR-NBR                 10280007
101500           AND  RGST_ID          = :EPITM-RGST-ID                 10290007
101600           AND  TRN_NBR          = :EPITM-TRN-NBR                 10300007
101700           AND  STRT_TM          = :EPITM-STRT-TM                 10310007
101800           AND  SLS_CORR_SEQ_NBR = :EPITM-SLS-CORR-SEQ-NBR        10320007
101900           AND  LNE_ITM_SEQ_NBR  = :EPITM-LNE-ITM-SEQ-NBR         10330007
102000           AND  LID_RSN_CDE     IN ('701','702','703','704','705',10340007
102100                                    '706','707','708','709')      10350007
102200         WITH UR                                                  10360007
102300     END-EXEC.                                                    10370007
102400                                                                  10380007
102500     EVALUATE TRUE                                                10390007
102600        WHEN SQLCODE = ZERO                                       10400007
102700        WHEN SQLCODE = -811                                       10410007
102800           SET PS-MAN-LID-Y     TO TRUE                           10420007
102900        WHEN SQLCODE = PC-ROW-NOT-FOUND                           10430007
103000           SET PS-MAN-LID-N     TO TRUE                           10440007
103100        WHEN OTHER                                                10450007
103200           MOVE '3430-CHECK-MAN-LID'                              10460007
103300                                 TO PV-PARAGRAPH-NAME             10470007
103400           MOVE 'ERROR CHECKING FOR MANUAL LID'                   10480007
103500                                 TO PV-DB2-OPERATION              10490007
103600           DISPLAY 'SQLCODE= ' SQLCODE                            10500007
103700           DISPLAY 'PART= ' EPITM-PARTN-NBR                       10510007
103800           DISPLAY 'STR= ' EPITM-STR-NBR                          10520007
103900           DISPLAY 'RGST= ' EPITM-RGST-ID                         10530007
104000           DISPLAY 'TRN= ' EPITM-TRN-NBR                          10540007
104100           DISPLAY 'STRT TM= ' EPITM-STRT-TM                      10550007
104200           DISPLAY 'SLS CORR SEQ= ' EPITM-SLS-CORR-SEQ-NBR        10560007
104300           DISPLAY 'LNE ITEM SEQ NBR= ' EPITM-LNE-ITM-SEQ-NBR     10570007
104400           PERFORM 9900-SQL-ABEND                                 10580007
104500     END-EVALUATE.                                                10590007
104600                                                                  10600007
104700                                                                  10610007
104800***************************************************************** 10620007
104900***************************************************************** 10630007
105000**3450-RETRV-ANY-GOLDSTAR-MKDN.                                   10640007
105100**    THIS SECTION WILL RETRIEVE ANY GOLDSTAR MARKDOWN GIVEN FOR  10650007
105200**    THE ITEM.  GOLDSTAR IS THE FIRST MARKDOWN, SO THERE IS      10660007
105300**    NO NEED TO RECALCULATE IT USING THE PERCENTAGE.             10670007
105400***************************************************************** 10680007
105500 3450-RETRV-ANY-GOLDSTAR-MKDN.                                    10690007
105600                                                                  10700007
105700     EXEC SQL                                                     10710007
105800                                                                  10720007
105900        SELECT  LID_AMT                                           10730007
106000                                                                  10740007
106100          INTO :EPLID-LID-AMT                                     10750007
106200                                                                  10760007
106300          FROM  TEPLID                                            10770007
106400                                                                  10780007
106500         WHERE  PARTN_NBR        = :EPITM-PARTN-NBR               10790007
106600           AND  STR_NBR          = :EPITM-STR-NBR                 10800007
106700           AND  RGST_ID          = :EPITM-RGST-ID                 10810007
106800           AND  TRN_NBR          = :EPITM-TRN-NBR                 10820007
106900           AND  STRT_TM          = :EPITM-STRT-TM                 10830007
107000           AND  SLS_CORR_SEQ_NBR = :EPITM-SLS-CORR-SEQ-NBR        10840007
107100           AND  LNE_ITM_SEQ_NBR  = :EPITM-LNE-ITM-SEQ-NBR         10850007
107200                                                                  10860007
107300           AND  LID_RSN_CDE      = :PC-GOLDSTAR-RSN-CDE           10870007
107400       WITH UR                                                    10880007
107500     END-EXEC.                                                    10890007
107600                                                                  10900007
107700     EVALUATE TRUE                                                10910007
107800        WHEN SQLCODE = ZERO                                       10920007
107900           COMPUTE EPLID-LID-AMT = EPLID-LID-AMT / EPITM-SLD-QTY  10930007
108000        WHEN SQLCODE = PC-ROW-NOT-FOUND                           10940007
108100           MOVE ZEROS TO EPLID-LID-AMT                            10950007
108200**         DISPLAY 'GOLDSTAR WITHOUT MATCHING LID'                10960099
108300**         DISPLAY 'PART= ' EPITM-PARTN-NBR                       10970099
108400**         DISPLAY ' STR= ' EPITM-STR-NBR                         10980099
108500**         DISPLAY 'RGST= ' EPITM-RGST-ID                         10990099
108600**         DISPLAY 'TRAN= ' EPITM-TRN-NBR                         11000099
108700**         DISPLAY 'STRT TM= ' EPITM-STRT-TM                      11010099
108800**         DISPLAY 'LNE ITEM SEQ NBR= ' EPITM-LNE-ITM-SEQ-NBR     11020099
108800**         DUE TO VOLUME, REDUCE DISPLAY RECORDS FROM 7 TO 1      11020199
108200           DISPLAY 'GOLDSTAR WITHOUT MATCHING LID: '              11021099
108300           EPITM-PARTN-NBR ',' EPITM-STR-NBR ',' EPITM-RGST-ID    11022099
108600           ',' EPITM-TRN-NBR ',' EPITM-STRT-TM ','                11025099
108800           EPITM-LNE-ITM-SEQ-NBR                                  11027099
108900        WHEN OTHER                                                11030007
109000           MOVE '3450-RETRV-ANY-GOLDSTAR-MKDN'                    11040007
109100                                 TO PV-PARAGRAPH-NAME             11050007
109200           MOVE 'ERROR SELECTING GOLDSTAR'                        11060007
109300                                 TO PV-DB2-OPERATION              11070007
109400           DISPLAY 'SQLCODE= ' SQLCODE                            11080007
109500           DISPLAY 'PART= ' EPITM-PARTN-NBR                       11090007
109600           DISPLAY 'STR= ' EPITM-STR-NBR                          11100007
109700           DISPLAY 'RGST= ' EPITM-RGST-ID                         11110007
109800           DISPLAY 'TRN= ' EPITM-TRN-NBR                          11120007
109900           DISPLAY 'STRT TM= ' EPITM-STRT-TM                      11130007
110000           DISPLAY 'SLS CORR SEQ= ' EPITM-SLS-CORR-SEQ-NBR        11140007
110100           DISPLAY 'LNE ITEM SEQ NBR= ' EPITM-LNE-ITM-SEQ-NBR     11150007
110200           PERFORM 9900-SQL-ABEND                                 11160007
110300     END-EVALUATE.                                                11170007
110400                                                                  11180007
110500***************************************************************** 11190007
110600**3460-SLCT-TIER-INFO.                                            11200007
110700**    SELECTS A TIERED PROMO AND GROUP NUMBER IF THE ITEM HAS     11210007
110800**    TIERED PRICING.                                             11220007
110900**    NOTE:  TIERED PRICING AT A QTY OF ONE IS THE ONLY INFO      11230007
111000**           THAT IS UTILIZED AS PART OF THE LOWEST 13WK PROCESS. 11240012
111100***************************************************************** 11250007
111200 3460-SLCT-TIER-INFO.                                             11260007
111300                                                                  11270007
111400     IF EPITM-RET-AMT NOT EQUAL TO ZERO                           11280007
111500        PERFORM 3465-SLCT-BOGO-TIER                               11290007
111600                                                                  11300007
111700     ELSE                                                         11310007
111800        PERFORM 3470-SLCT-PROMO-STR-TIER                          11320007
111900     END-IF.                                                      11330007
112000                                                                  11340007
112100     IF PS-HAS-TIER-PRICING                                       11350007
112200        COMPUTE PV-LWST-W13-WK-VALUE = PV-LWST-W13-WK-VALUE +     11360012
112300                   EPLID-LID-AMT                                  11370007
112400     END-IF.                                                      11380007
112500                                                                  11390007
112600***************************************************************** 11400007
112700**3465-SLCT-BOGO-TIER.                                            11410007
112800**    SELECTS TIERED INFORMATION FOR BOGO.                        11420007
112900**                                                                11430007
113000**    NOTE:  TIERED PRICING AT A QTY OF ONE IS THE ONLY INFO      11440007
113100**           THAT IS UTILIZED AS PART OF THE LOWEST 13WK PROCESS. 11450012
113200***************************************************************** 11460007
113300 3465-SLCT-BOGO-TIER.                                             11470007
113400                                                                  11480007
113500     EXEC SQL                                                     11490007
113600                                                                  11500007
113700        SELECT  LID_AMT                                           11510007
113800                                                                  11520007
113900          INTO  :EPLID-LID-AMT                                    11530007
114000                                                                  11540007
114100          FROM  TEPLID LID,                                       11550007
114200                TEPTTD TTD                                        11560007
114300                                                                  11570007
114400         WHERE  LID.PARTN_NBR        = :EPITM-PARTN-NBR           11580007
114500           AND  LID.STR_NBR          = :EPITM-STR-NBR             11590007
114600           AND  LID.RGST_ID          = :EPITM-RGST-ID             11600007
114700           AND  LID.TRN_NBR          = :EPITM-TRN-NBR             11610007
114800           AND  LID.STRT_TM          = :EPITM-STRT-TM             11620007
114900           AND  LID.SLS_CORR_SEQ_NBR = :EPITM-SLS-CORR-SEQ-NBR    11630007
115000           AND  LID.LNE_ITM_SEQ_NBR  = :EPITM-LNE-ITM-SEQ-NBR     11640007
115100                                                                  11650007
115200           AND  LID.LID_TYP_CDE      = 'T'                        11660007
115300                                                                  11670007
115400           AND  LID.PARTN_NBR        = TTD.PARTN_NBR              11680007
115500           AND  LID.STR_NBR          = TTD.STR_NBR                11690007
115600           AND  LID.RGST_ID          = TTD.RGST_ID                11700007
115700           AND  LID.TRN_NBR          = TTD.TRN_NBR                11710007
115800           AND  LID.STRT_TM          = TTD.STRT_TM                11720007
115900           AND  LID.SLS_CORR_SEQ_NBR = TTD.SLS_CORR_SEQ_NBR       11730007
116000                                                                  11740007
116100           AND  LID.PROMO_INTFC_SUB_ID   = TTD.PROMO_INTFC_SUB_ID 11750007
116200           AND  LID.PROMO_SCHM_CDE   = TTD.PROMO_SCHM_CDE         11760007
116300                                                                  11770007
116400           AND  LID.PROMO_SCHM_CDE IN (402,403)                   11780007
116500           AND  TIER_RCHD_QTY    > 1                              11790007
116600                                                                  11800007
116700       WITH UR                                                    11810007
116800                                                                  11820007
116900     END-EXEC.                                                    11830007
117000                                                                  11840007
117100     EVALUATE TRUE                                                11850007
117200        WHEN SQLCODE = ZERO                                       11860007
117300           COMPUTE EPLID-LID-AMT = EPLID-LID-AMT * -1             11870007
117400           SET PS-HAS-TIER-PRICING TO TRUE                        11880007
117500        WHEN SQLCODE = PC-ROW-NOT-FOUND                           11890007
117600           SET PS-NO-TIER-PRICING TO TRUE                         11900007
117700        WHEN OTHER                                                11910007
117800           MOVE '3470-SLCT-PROMO-STR-TIER'                        11920007
117900                                 TO PV-PARAGRAPH-NAME             11930007
118000           MOVE 'ERROR ON SEL NON PROMO TIER'                     11940007
118100                                 TO PV-DB2-OPERATION              11950007
118200           DISPLAY 'SQLCODE= ' SQLCODE                            11960007
118300           DISPLAY 'PART= ' EPITM-PARTN-NBR                       11970007
118400           DISPLAY 'STR= ' EPITM-STR-NBR                          11980007
118500           DISPLAY 'RGST= ' EPITM-RGST-ID                         11990007
118600           DISPLAY 'TRN= ' EPITM-TRN-NBR                          12000007
118700           DISPLAY 'STRT TM= ' EPITM-STRT-TM                      12010007
118800           DISPLAY 'SLS CORR SEQ= ' EPITM-SLS-CORR-SEQ-NBR        12020007
118900           DISPLAY 'LNE ITEM SEQ NBR= ' EPITM-LNE-ITM-SEQ-NBR     12030007
119000           PERFORM 9900-SQL-ABEND                                 12040007
119100     END-EVALUATE.                                                12050007
119200                                                                  12060007
119300                                                                  12070007
119400***************************************************************** 12080007
119500**3470-SLCT-PROMO-STR-TIER.                                       12090007
119600**    SELECTS TIERED INFORMATION FOR PROMO STORES.                12100007
119700**                                                                12110007
119800**    NOTE:  TIERED PRICING AT A QTY OF ONE IS THE ONLY INFO      12120007
119900**           THAT IS UTILIZED AS PART OF THE LOWEST 13WK PROCESS. 12130012
120000***************************************************************** 12140007
120100 3470-SLCT-PROMO-STR-TIER.                                        12150007
120200                                                                  12160007
120300     EXEC SQL                                                     12170007
120400                                                                  12180007
120500        SELECT  LID_AMT                                           12190007
120600                                                                  12200007
120700          INTO  :EPLID-LID-AMT                                    12210007
120800                                                                  12220007
120900          FROM  TEPLID LID,                                       12230007
121000                TEPTTD TTD                                        12240007
121100                                                                  12250007
121200         WHERE  LID.PARTN_NBR        = :EPITM-PARTN-NBR           12260007
121300           AND  LID.STR_NBR          = :EPITM-STR-NBR             12270007
121400           AND  LID.RGST_ID          = :EPITM-RGST-ID             12280007
121500           AND  LID.TRN_NBR          = :EPITM-TRN-NBR             12290007
121600           AND  LID.STRT_TM          = :EPITM-STRT-TM             12300007
121700           AND  LID.SLS_CORR_SEQ_NBR = :EPITM-SLS-CORR-SEQ-NBR    12310007
121800           AND  LID.LNE_ITM_SEQ_NBR  = :EPITM-LNE-ITM-SEQ-NBR     12320007
121900                                                                  12330007
122000           AND  LID.LID_TYP_CDE      = 'T'                        12340007
122100                                                                  12350007
122200           AND  LID.PARTN_NBR        = TTD.PARTN_NBR              12360007
122300           AND  LID.STR_NBR          = TTD.STR_NBR                12370007
122400           AND  LID.RGST_ID          = TTD.RGST_ID                12380007
122500           AND  LID.TRN_NBR          = TTD.TRN_NBR                12390007
122600           AND  LID.STRT_TM          = TTD.STRT_TM                12400007
122700           AND  LID.SLS_CORR_SEQ_NBR = TTD.SLS_CORR_SEQ_NBR       12410007
122800                                                                  12420007
122900           AND  LID.PROMO_INTFC_SUB_ID   = TTD.PROMO_INTFC_SUB_ID 12430007
123000           AND  LID.PROMO_SCHM_CDE   = TTD.PROMO_SCHM_CDE         12440007
123100                                                                  12450007
123200           AND  LID.PROMO_SCHM_CDE IN (402,403)                   12460007
123300           AND  TIER_RCHD_QTY    = 1                              12470007
123400                                                                  12480007
123500       WITH UR                                                    12490007
123600                                                                  12500007
123700     END-EXEC.                                                    12510007
123800                                                                  12520007
123900     EVALUATE TRUE                                                12530007
124000        WHEN SQLCODE = ZERO                                       12540007
124100           COMPUTE EPLID-LID-AMT = EPLID-LID-AMT / EPITM-SLD-QTY  12550007
124200           SET PS-HAS-TIER-PRICING TO TRUE                        12560007
124300        WHEN SQLCODE = PC-ROW-NOT-FOUND                           12570007
124400           SET PS-NO-TIER-PRICING TO TRUE                         12580007
124500        WHEN OTHER                                                12590007
124600           MOVE '3470-SLCT-PROMO-STR-TIER'                        12600007
124700                                 TO PV-PARAGRAPH-NAME             12610007
124800           MOVE 'ERROR ON SEL NON PROMO TIER'                     12620007
124900                                 TO PV-DB2-OPERATION              12630007
125000           DISPLAY 'SQLCODE= ' SQLCODE                            12640007
125100           DISPLAY 'PART= ' EPITM-PARTN-NBR                       12650007
125200           DISPLAY 'STR= ' EPITM-STR-NBR                          12660007
125300           DISPLAY 'RGST= ' EPITM-RGST-ID                         12670007
125400           DISPLAY 'TRN= ' EPITM-TRN-NBR                          12680007
125500           DISPLAY 'STRT TM= ' EPITM-STRT-TM                      12690007
125600           DISPLAY 'SLS CORR SEQ= ' EPITM-SLS-CORR-SEQ-NBR        12700007
125700           DISPLAY 'LNE ITEM SEQ NBR= ' EPITM-LNE-ITM-SEQ-NBR     12710007
125800           PERFORM 9900-SQL-ABEND                                 12720007
125900     END-EVALUATE.                                                12730007
126000                                                                  12740007
126100                                                                  12750007
126200***************************************************************** 12760007
126300**3500-SELECT-INTR-UPC-ID.                                        12770007
126400**    SELECTS THE INTERNAL UPC ID FOR THE SKU.                    12780007
126500**    THE SAVED SKU NUMBER IS USED BECAUSE THIS IS PERFORMED WHEN 12790007
126600**    A CHANGE IN SKU NUMBER IS DETECTED, SO IT ONLY OCCURS ONCE  12800007
126700**    PER DISTINCT SKU.                                           12810007
126800***************************************************************** 12820007
126900 3500-SELECT-INTR-UPC-ID.                                         12830007
127000                                                                  12840007
127100     EXEC SQL                                                     12850007
127200                                                                  12860007
127300        SELECT INTR_UPC_ID                                        12870007
127400                                                                  12880007
127500          INTO :XST00010-INTR-UPC-ID                              12890007
127600                                                                  12900007
127700          FROM  XST_SKU                                           12910007
127800                                                                  12920007
127900         WHERE  SKU_NBR          = :PV-SAVED-SKU-NBR              12930007
128000                                                                  12940007
128100       WITH UR                                                    12950007
128200                                                                  12960007
128300     END-EXEC.                                                    12970007
128400                                                                  12980007
128500     EVALUATE TRUE                                                12990007
128600        WHEN SQLCODE = ZERO                                       13000007
128700           SET PS-SKU-FOUND         TO TRUE                       13010007
128800        WHEN SQLCODE = PC-ROW-NOT-FOUND                           13020007
128900           SET PS-SKU-NOT-FOUND    TO TRUE                        13030007
129000           DISPLAY 'NO SKU FOUND ON XST_SKU'                      13040007
129100           DISPLAY 'SKU= ' EPITM-SKU-NBR                          13050007
129200        WHEN OTHER                                                13060007
129300           MOVE '3500-SELECT-INTR-UPC-ID'                         13070007
129400                                 TO PV-PARAGRAPH-NAME             13080007
129500           MOVE 'ERROR ON SEL OF INT UPC ID'                      13090007
129600                                 TO PV-DB2-OPERATION              13100007
129700           DISPLAY 'SQLCODE= ' SQLCODE                            13110007
129800           DISPLAY 'SKU= ' EPITM-SKU-NBR                          13120007
129900           PERFORM 9900-SQL-ABEND                                 13130007
130000     END-EVALUATE.                                                13140007
130100                                                                  13150007
130200***************************************************************** 13160007
130300**3600-FORMAT-OUTPUT-FILES.                                       13170007
130400**    DETERMINES WHICH OUTPUT FILES NEED TO BE CREATED.           13180007
130500***************************************************************** 13190007
130600 3600-FORMAT-OUTPUT-FILES.                                        13200007
130700                                                                  13210007
130800     PERFORM 3610-SELECT-CUR-WK-LWST-13WK.                        13220012
130900                                                                  13230007
131000     IF PV-LWST-W13-WK-VALUE-SVD NOT EQUAL ZERO                   13240012
131100                                                                  13250008
131200        IF PS-NO-CUR-WK-LW13WK-PRIC OR                            13260012
131300             PV-LWST-W13-WK-VALUE-SVD < PV-CUR-WK-LW13WK-PR       13270012
131400                                                                  13280007
131500           MOVE XST00010-INTR-UPC-ID      TO EP119-INTR-UPC-ID    13290007
131600           MOVE PC-AD-VERSION             TO EP119-STR-GP-TYP-CDE 13300007
131700           MOVE XST00023-STR-GP-ID        TO EP119-STR-GP-ID      13310007
131800           MOVE PV-WEEK-BEG-DT-CCYY-MM-DD TO EP119-SLS-WK-BEG-DTE 13320007
131900           MOVE PV-LWST-W13-WK-VALUE-SVD  TO EP119-UNT-RTL-AMT    13330057
132000                                                                  13340007
132100           PERFORM 3620-WRITE-LOW13WK-LOAD-FILE                   13350016
132800        END-IF                                                    13360007
132900     END-IF.                                                      13370008
133000                                                                  13380007
132200     PERFORM 3630-SELECT-MIN-LOWST-13W-PRIC.                      13390057
132300                                                                  13400057
131000     IF PV-LWST-W13-WK-VALUE-SVD NOT EQUAL ZERO                   13410061
132400        IF PV-LWST-W13-WK-VALUE-SVD < PV-HISTRC-LW13WK-PR         13420061
132500           OR PS-NO-HISTRY-LW13WK-PRIC                            13430061
132600              PERFORM 3640-WRITE-PLU-CHGS-EXT-FILE                13440061
132700        END-IF                                                    13450061
           END-IF.                                                      13460061
133100***************************************************************** 13470007
133200**3610-SELECT-CUR-WK-LWST-13WK.                                   13480012
133300**    SELECTS THE LOWEST 13  WEEK PRICE FOR THE AD VERSION FOR    13490012
133400** THE CURRENT WEEK IF IT EXISTS.                                 13500007
133500**                                                                13510007
133600***************************************************************** 13520007
133700 3610-SELECT-CUR-WK-LWST-13WK.                                    13530012
133800                                                                  13540007
133900     EXEC SQL                                                     13550007
134000                                                                  13560007
134100        SELECT UNT_RTL_AMT                                        13570007
134200                                                                  13580007
134300          INTO :EPT00011-UNT-RTL-AMT                              13590007
134400                                                                  13600007
134500          FROM  EPT_LO_RTL                                        13610007
134600                                                                  13620007
134700         WHERE  INTR_UPC_ID      = :XST00010-INTR-UPC-ID          13630007
134800           AND  STR_GP_TYP_CDE   = :PC-AD-VERSION                 13640007
134900           AND  STR_GP_ID        = :XST00023-STR-GP-ID            13650022
135000           AND  SLS_WK_BEG_DTE   = :PV-WEEK-BEG-DT-CCYY-MM-DD     13660007
135100                                                                  13670007
135200       WITH UR                                                    13680007
135300     END-EXEC.                                                    13690007
135400                                                                  13700007
135500     EVALUATE TRUE                                                13710007
135600        WHEN SQLCODE = ZERO                                       13720007
135700           SET PS-HAS-CUR-WK-LW13WK-PRIC TO TRUE                  13730012
135800           MOVE EPT00011-UNT-RTL-AMT TO PV-CUR-WK-LW13WK-PR       13740012
135900        WHEN SQLCODE = +100 OR -305                               13750007
136000           SET PS-NO-CUR-WK-LW13WK-PRIC TO TRUE                   13760012
136100           MOVE ZEROS TO PV-CUR-WK-LW13WK-PR                      13770012
136200        WHEN OTHER                                                13780007
136300           MOVE '3610-SELECT-CUR-WK-LWST-13WK'                    13790012
136400                                 TO PV-PARAGRAPH-NAME             13800007
136500           MOVE 'ERROR ON SEL OF 13WK PRIC'                       13810012
136600                                 TO PV-DB2-OPERATION              13820007
136700           DISPLAY 'SQLCODE= ' SQLCODE                            13830007
136800           DISPLAY 'INTR UPC ID = ' XST00010-INTR-UPC-ID          13840007
136900           DISPLAY 'STR GP ID= ' XST00023-STR-GP-ID               13850007
137000           DISPLAY 'SLS WK BEG DTE= ' PV-WEEK-BEG-DT-CCYY-MM-DD   13860007
137100           PERFORM 9900-SQL-ABEND                                 13870007
137200     END-EVALUATE.                                                13880007
137300                                                                  13890007
137400***************************************************************** 13900007
137500**3620-WRITE-LOW13WK-LOAD-FILE.                                   13910016
137600** THIS SECTION WILL WRITE A RECORD TO THE LOWEST RETAIL PRICE    13920007
137700** TABLE LOAD FILE, SINCE IT'S BEEN DETERMINED THAT THE PRICE     13930007
137800** FOR THE INTERNAL UPC ID DOES NOT EXIST FOR THE WEEK, OR THAT   13940007
137900** THE 'LOEST PRICE VALUE' LOOKING AT CURRENT SALES IS LESS THAN  13950007
138000** THE ROW ALREADY ON THE TABLE.                                  13960007
138100***************************************************************** 13970007
138200 3620-WRITE-LOW13WK-LOAD-FILE.                                    13980016
138300                                                                  13990007
138400     WRITE LWST-W13-WEEK-LOAD-RECORD FROM                         14000012
138500                           EP119-LWST-W13-WK-CHG-RCD.             14010012
138600                                                                  14020007
138700     ADD 1                            TO PA-TOT-LOAD-RCDS-WRITTEN.14030007
138800                                                                  14040007
138900***************************************************************** 14050007
139000**3630-SELECT-MIN-LOWST-13W-PRIC.                                 14060014
139100** SELECTS THE MINIMUN 13  WEEK PRICE FOR A SKU/AD VERSION LOOKING14070012
139200** ACCROSS ALL HISTORICAL DATA ON THE LOWEST RETAIL AMOUNT TABLE. 14080007
139300**                                                                14090007
139400** ONLY WANT TO CONSIDER THE LAST 14 WEEKS. ON SUNDAY AN 15TH WEEK14100015
139500** WILL BE PRESENT UNTIL THE DELETE PROCESS TAKES EFFECT FOR THE  14110007
139600** OLDEST ROWS THAT WERE PROCESSED ON SAT AS WEEK END.  THIS IS   14120007
139700** NEEDED TO KEEP THE TABLE IN SYNCH WITH FILES AT THE STORE.     14130007
139800***************************************************************** 14140007
139900 3630-SELECT-MIN-LOWST-13W-PRIC.                                  14150014
140000                                                                  14160007
140100     EXEC SQL                                                     14170007
140200                                                                  14180007
140300        SELECT MIN(UNT_RTL_AMT)                                   14190007
140400                                                                  14200007
140500          INTO :EPT00011-UNT-RTL-AMT                              14210007
140600                                                                  14220007
140700          FROM  EPT_LO_RTL                                        14230007
140800                                                                  14240007
140900         WHERE  INTR_UPC_ID      = :XST00010-INTR-UPC-ID          14250007
141000           AND  STR_GP_TYP_CDE   = :PC-AD-VERSION                 14260007
141200           AND  SLS_WK_BEG_DTE  BETWEEN :PV-OLDEST-WEEK-BEG-DT    14270007
141300                AND :PV-WEEK-BEG-DT-CCYY-MM-DD                    14280007
141400                                                                  14290007
141500       WITH UR                                                    14300007
141600     END-EXEC.                                                    14310007
141700                                                                  14320007
141800     EVALUATE TRUE                                                14330007
141900        WHEN SQLCODE = ZERO                                       14340007
142000           SET PS-HAS-HISTRY-LW13WK-PRIC TO TRUE                  14350012
142100           MOVE EPT00011-UNT-RTL-AMT TO PV-HISTRC-LW13WK-PR       14360012
142200        WHEN SQLCODE = +100 OR -305                               14370007
142300           SET PS-NO-HISTRY-LW13WK-PRIC TO TRUE                   14380012
142400           MOVE ZEROS TO PV-HISTRC-LW13WK-PR                      14390012
142500        WHEN OTHER                                                14400007
142600             MOVE '3630-SELECT-MIN-LOWST-13W-PRIC'                14410014
142700                                   TO PV-PARAGRAPH-NAME           14420007
142800             MOVE 'ERROR SELCT MIN LWST 13WK'                     14430012
142900                                   TO PV-DB2-OPERATION            14440007
143000             DISPLAY 'SQLCODE= ' SQLCODE                          14450007
143100             DISPLAY 'INTR UPC ID= ' XST00010-INTR-UPC-ID         14460007
143200             DISPLAY 'STR GP ID= ' XST00023-STR-GP-ID             14470007
143300             DISPLAY 'OLD WK BEG DT= ' PV-OLDEST-WEEK-BEG-DT      14480007
143400             DISPLAY 'WEEK BEG DT = '  PV-WEEK-BEG-DT-CCYY-MM-DD  14490007
143500             PERFORM 9900-SQL-ABEND                               14500007
143600     END-EVALUATE.                                                14510007
143700                                                                  14520007
143800***************************************************************** 14530007
143900**3640-WRITE-PLU-CHGS-EXT-FILE.                                   14540007
144000** THIS SECTION WILL WRITE A RECORD TO THE PLU CHANGES EXTRACT    14550007
144100** FILE SINCE IT'S BEEN DETERMINED THAT THE PRICE REPRESENTS      14560007
144200** A NEW "LOWEST 13  WEEK" VALUE THAT THE STORES WOULD NOT ALREADY14570012
144300** BE AWARE OF.                                                   14580007
144400***************************************************************** 14590007
144500 3640-WRITE-PLU-CHGS-EXT-FILE.                                    14600007
145100                                                                  14610039
131500     MOVE XST00010-INTR-UPC-ID      TO EP119-INTR-UPC-ID.         14620099
131600     MOVE 1000                      TO EP119-STR-GP-TYP-CDE.      14630099
131700     MOVE 1                         TO EP119-STR-GP-ID.           14640099
131800     MOVE PV-WEEK-BEG-DT-CCYY-MM-DD TO EP119-SLS-WK-BEG-DTE.      14650099
131900     MOVE PV-LWST-W13-WK-VALUE-SVD  TO EP119-UNT-RTL-AMT.         14660099
144700     WRITE PLU-CHGS-EXTRACT-RECORD FROM                           14670099
144800                        EP119-LWST-W13-WK-CHG-RCD                 14680057
145000     ADD 1          TO PA-TOT-PLU-RCDS-WRITTEN.                   14690099
145100                                                                  14700048
133100***************************************************************** 14710036
145200***************************************************************** 14720007
145300**3800-FETCH-SALEITM-CSR.                                         14730007
145400**    FETCH THE NEXT ROW FROM THE SALE ITEM CURSOR.  WHEN NO MORE 14740007
145500**    ITEMS REMAIN, END OF SALE ITEM CURSOR IS SET TO TRUE.       14750007
145600***************************************************************** 14760007
145700 3800-FETCH-SALEITM-CSR.                                          14770007
145800                                                                  14780007
145900     EXEC SQL                                                     14790007
146000          FETCH SALEITM-CSR                                       14800007
146100           INTO :EPITM-PARTN-NBR                                  14810007
146200               ,:EPITM-STR-NBR                                    14820007
146300               ,:EPITM-RGST-ID                                    14830007
146400               ,:EPITM-TRN-NBR                                    14840007
146500               ,:EPITM-STRT-TM                                    14850007
146600               ,:EPITM-SLS-CORR-SEQ-NBR                           14860007
146700               ,:EPITM-LNE-ITM-SEQ-NBR                            14870007
146800               ,:EPITM-SLD-QTY                                    14880007
146900               ,:EPITM-SAL-TYP-CDE                                14890007
147000               ,:EPITM-ITM-STAT-CDE                               14900007
147100               ,:EPITM-SRC-TYP-CDE                                14910007
147200               ,:EPITM-PRIC-SRC-CDE                               14920007
147300               ,:EPITM-CUST-CHRGD-AMT                             14930007
147400               ,:EPITM-REG-RTL-AMT                                14940007
147500               ,:EPITM-PROMO-CDE                                  14950007
147600               ,:EPITM-OWND-UNT-RTL-AMT                           14960007
147700               ,:EPITM-SKU-NBR                                    14970007
147800               ,:EPITM-RET-AMT                                    14980007
147900               ,:EPITM-PROMO-INTFC-ID                             14990007
148000               ,:EPITM-PROMO-SCHM-CDE                             15000007
148100     END-EXEC.                                                    15010007
148200                                                                  15020007
148300     EVALUATE TRUE                                                15030007
148400         WHEN SQLCODE = ZERO                                      15040007
148500                 ADD +1 TO PA-SALE-ITEM-CNT                       15050007
148600                 ADD +1 TO PA-AD-VERSION-ITM-CNT                  15060007
148700                 MOVE EPITM-PROMO-SCHM-CDE TO                     15070007
148800                      PV-PRICING-SCHEME                           15080007
148900         WHEN SQLCODE = PC-ROW-NOT-FOUND                          15090007
149000             SET PS-END-OF-SALEITM-CSR TO TRUE                    15100007
149100         WHEN SQLWARN0 NOT EQUAL SPACE                            15110007
149200         WHEN SQLCODE NOT EQUAL ZERO                              15120007
149300             MOVE '3800-FETCH-SALEITM-CSR'                        15130007
149400                                   TO PV-PARAGRAPH-NAME           15140007
149500             MOVE 'ERROR ON FETCH OF SALEITM CSR'                 15150007
149600                                   TO PV-DB2-OPERATION            15160007
149700             DISPLAY 'SQLCODE= ' SQLCODE                          15170007
149800             PERFORM 9900-SQL-ABEND                               15180007
149900     END-EVALUATE.                                                15190007
150000                                                                  15200007
150100*----------------------------------------------------------------*15210007
150200*3900-CLOSE-SALEITM-CSR.                                         *15220007
150300*    THIS SECTION CLOSES THE SALE ITEM CURSOR                    *15230007
150400*----------------------------------------------------------------*15240007
150500 3900-CLOSE-SALEITM-CSR.                                          15250007
150600                                                                  15260007
150700     EXEC SQL                                                     15270007
150800          CLOSE SALEITM-CSR                                       15280007
150900     END-EXEC.                                                    15290007
151000                                                                  15300007
151100     EVALUATE TRUE                                                15310007
151200         WHEN SQLCODE = ZERO                                      15320007
151300              CONTINUE                                            15330007
151400         WHEN SQLWARN0 NOT EQUAL SPACE                            15340007
151500         WHEN SQLCODE NOT EQUAL ZERO                              15350007
151600             MOVE '3900-CLOSE-SALEITM-CSR'                        15360007
151700                                   TO PV-PARAGRAPH-NAME           15370007
151800             MOVE 'ERROR ON CLOSE OF SALEITM CSR'                 15380007
151900                                   TO PV-DB2-OPERATION            15390007
152000             DISPLAY 'SQLCODE= ' SQLCODE                          15400007
152100             PERFORM 9900-SQL-ABEND                               15410007
152200     END-EVALUATE.                                                15420007
152300                                                                  15430007
152400*----------------------------------------------------------------*15440007
152500*8000-CLOSING-ROUTINE.                                           *15450007
152600*    DISPLAYS PROGRAM ACCUMULATORS AND CLOSES OUTPUT FILES       *15460007
152700*----------------------------------------------------------------*15470007
152800 8000-CLOSING-ROUTINE.                                            15480007
152900                                                                  15490007
153000     CLOSE LWST-W13-WEEK-LOAD-FILE                                15500012
153100           PLU-CHGS-EXTRACT-FILE.                                 15510007
153200                                                                  15520007
153300     DISPLAY '**************************************'.            15530007
153400     DISPLAY 'AD VERSION COUNTER= ' PA-AD-VERSION-CNT.            15540007
153500     DISPLAY 'SALE ITEM COUNTER=  ' PA-SALE-ITEM-CNT.             15550007
153600     DISPLAY '**************************************'.            15560007
153700     DISPLAY 'TOT LOAD RECORDS= ' PA-TOT-LOAD-RCDS-WRITTEN.       15570007
153800     DISPLAY 'TOT PLU  RECORDS= ' PA-TOT-PLU-RCDS-WRITTEN.        15580007
153900     DISPLAY 'TOT INVALID ITEM= ' PA-INVALID-ITEM-CNT.            15590007
154000     DISPLAY 'DSTNCT ADVER SKU CNT= ' PA-DISTN-ADVER-SKU-CNT.     15600007
154100                                                                  15610007
154200*----------------------------------------------------------------*15620007
154300*     9900-SQL-ABEND                                             *15630007
154400* ==> PROCESSES:                                                 *15640007
154500*     -PERFORMS ABEND PROCESSING FOR SQL ERRORS.                 *15650007
154600* ==> PERFORMED FROM:                                            *15660007
154700*----------------------------------------------------------------*15670007
154800 9900-SQL-ABEND.                                                  15680007
154900                                                                  15690007
155000     DISPLAY '9900-SQL-ABEND'.                                    15700007
155100     DISPLAY '**  ABEND     **'.                                  15710007
155200     DISPLAY '**  PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.       15720007
155300     DISPLAY '**  PARAGRAPH ** = ' PV-PARAGRAPH-NAME.             15730007
155400     DISPLAY '**  OPERATION ** = ' PV-DB2-OPERATION.              15740007
155500                                                                  15750007
155600*----------------------------------------------------------------*15760007
155700* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-   *15770007
155800* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE        *15780007
155900* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE    *15790007
156000* FORMAT.                                                        *15800007
156100*----------------------------------------------------------------*15810007
156200     COPY DPPD004.                                                15820007
156300                                                                  15830007
156400     SET PV-ABEND-4013-DB2-ERROR TO TRUE.                         15840007
156500     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         15850099
156600                                                                  15860007
156700******************************************************************15870007
156800* 9999-ABEND                                                      15880007
156900*     ABEND PROGRAM WHEN A NON-DB2 ERROR OCCURS.                  15890007
157000******************************************************************15900007
157100 9999-ABEND.                                                      15910007
157200     DISPLAY '** ABEND           **'.                             15920007
157300     DISPLAY '** PROGRAM         ** = ' PC-CURRENT-PROGRAM-NAME.  15930007
157400     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        15940007
157500     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       15950007
157600     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       15960007
157700     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         15970007
