000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400 PROGRAM-ID.         RDKUT030.                                    00040001
000500 AUTHOR.             JIM LEIKNESS.                                00050001
000600 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00060000
000700 DATE-WRITTEN.       JULY 2003.                                   00070002
000800 DATE-COMPILED.                                                   00080000
000900                                                                  00090000
001000******************************************************************00100000
001100* THIS PROGRAM PREPARES THE UPDATE REFUND FILE TO BE PROCESSED   *00110000
001200* BY RDKUP008 UNDER THE DB2 CHECKPOINT RESTART SYSTEM.           *00120002
001300*                                                                *00130000
001400* THE PROGRAM READS THE UPDATE REFUND FILE, REFORMATS THE        *00140000
001500* RECORDS AND SETS A CHECKPOINT INDICATOR ON THE RECORD BASED    *00150000
001600* ON HOW CHECKPOINTS WILL BE TAKEN BY THE MAINTENANCE PROGRAM.   *00160000
001700* AFTER A RECORD HAS BEEN REFORMATTED IT IS PASSED TO THE        *00170000
001800* TRANSACTION PREPARATION MODULE (DPKUT900) WHICH DOES SOME MORE *00180000
001900* PROCESSING ON THE RECORDS AND WRITES THE REFORMATTED RECORDS   *00190000
002000* OUT TO A SEQUENTIAL FILE.                                      *00200000
002100*                                                                *00210000
002200* THE PROGRAM COMMUNICATES WITH THE TRANSACTION PREPARATION      *00220000
002300* MODULE USING FUNCTION CODES (OPEN, WRITE, & CLOSE) AND CHECKS  *00230000
002400* THE RETURN CODE AFTER EACH REQUEST.  IF AN INVALID RETURN CODE *00240000
002500* IS RECEIVED, ANY INFORMATION THAT MAY BE HELPFUL IN RESOLVING  *00250000
002600* THE BAD RETURN CODE IS DISPLAYED ON SYSOUT AND THE PROGRAM     *00260000
002700* ABENDS.                                                        *00270000
002800*                                                                *00280000
002900* INPUT FILES:   UPDATE-REFUND-FILE        DDNAME = INP01        *00290000
003000*                                                                *00300000
003100* OUTPUT FILES:  CHECKPOINT/RESTART FILE   DDNAME = OUT01        *00310000
003200*                                                                *00320000
260107*========================== CHANGE LOG ===========================00322010
260107* CHANGE          BY          DATE     DESCRIPTION                00323010
260107*=================================================================00324010
260107* CHG0260107   JIM HUNTER   08-15-21   ADD COPYBOOK DPWS990 TO    00327010
260107*                                      MAKE DPKUT900 CALL DYNAMIC.00328010
003300******************************************************************00330000
003400 ENVIRONMENT DIVISION.                                            00340000
003500******************************************************************00350000
003600                                                                  00360000
003700 CONFIGURATION SECTION.                                           00370000
003800                                                                  00380000
003900 SOURCE-COMPUTER.    IBM-3090.                                    00390000
004000 OBJECT-COMPUTER.    IBM-3090.                                    00400000
004100                                                                  00410000
004200 INPUT-OUTPUT SECTION.                                            00420000
004300                                                                  00430000
004400 FILE-CONTROL.                                                    00440000
004500                                                                  00450000
004600     SELECT UPDATE-REFUND-FILE   ASSIGN TO INP01.                 00460000
004700                                                                  00470000
004800******************************************************************00480000
004900 DATA DIVISION.                                                   00490000
005000******************************************************************00500000
005100                                                                  00510000
005200 FILE SECTION.                                                    00520000
005300                                                                  00530000
005400 FD  UPDATE-REFUND-FILE                                           00540000
005500     RECORDING MODE IS F                                          00550000
005600     BLOCK CONTAINS 0 RECORDS                                     00560000
005700     LABEL RECORDS ARE OMITTED.                                   00570000
005800                                                                  00580000
005900 01  UPDATE-REFUND-RECORD        PIC  X(36).                      00590007
006000                                                                  00600000
006100 WORKING-STORAGE SECTION.                                         00610000
006200                                                                  00620000
006300 01  ABEND-CODE                  PIC S9(04)     VALUE +0  COMP.   00630000
006400                                                                  00640000
006500******************************************************************00650000
006600*PC - PROGRAM CONSTANTS                                           00660000
006700******************************************************************00670000
006800 01  PROGRAM-CONSTANTS.                                           00680000
006900     05  PC-PROGRAM-NAME         PIC X(08)      VALUE 'RDKUT030'. 00690001
007000     05  PC-TRAN-PREP-FUNC-CODES.                                 00700000
007100         10  PC-TRAN-PREP-FUNC-OPEN                               00710000
007200                                 PIC X(05)      VALUE 'OPEN '.    00720000
007300         10  PC-TRAN-PREP-FUNC-WRITE                              00730000
007400                                 PIC X(05)      VALUE 'WRITE'.    00740000
007500         10  PC-TRAN-PREP-FUNC-CLOSE                              00750000
007600                                 PIC X(05)      VALUE 'CLOSE'.    00760000
007700     05  PC-JOB-NAME             PIC X(08)      VALUE 'RDK920  '. 00770002
007800     05  PC-PLAN-NAME            PIC X(08)      VALUE 'RDKUP008'. 00780009
007900     05  PC-TRANS-RECORD-LENGTH  PIC S9(04)     VALUE +36 COMP.   00790008
008000                                                                  00800000
008100******************************************************************00810000
008200*PV - PROGRAM VARIABLES                                           00820000
008300******************************************************************00830000
008400 01  PROGRAM-VARIABLES.                                           00840000
008500     05  PV-CHECKPOINT-TYPE      PIC X(01)      VALUE SPACE.      00850000
008600         88  CONTROL-BREAK                      VALUE 'C'.        00860000
008700         88  LOGICAL-TRANSACTION                VALUE 'L'.        00870000
008800         88  TIME-INTERVAL                      VALUE 'T'.        00880000
008900         88  REQUESTED-BY-PROGRAM               VALUE 'R'.        00890000
009000                                                                  00900000
009100     05  PV-KEY-FIELDS.                                           00910000
009200         10  PV-CUST-ID          PIC S9(10)V    COMP-3            00920002
009300                                                VALUE ZERO.       00930003
009400         10  PV-STR-RGST-ID      PIC  9(04)     VALUE ZERO.       00940004
009500         10  PV-RGST-TRN-NBR     PIC  9(04)     VALUE ZERO.       00950002
009600         10  PV-RFND-SEQ-NBR     PIC  9(03)     VALUE ZERO.       00960004
009700         10  PV-CHECK-NBR        PIC  9(09)     VALUE ZERO.       00970002
009800         10  PV-CHECK-DATE       PIC  X(10)     VALUE SPACE.      00980004
009900                                                                  00990004
010200******************************************************************01020000
010300*PA - PROGRAM ACCUMULATORS                                        01030000
010400******************************************************************01040000
010500 01  PROGRAM-ACCUMULATORS.                                        01050000
010600     05  PA-REFUND-RECORDS-READ PIC S9(11)      COMP-3            01060000
010700                                                VALUE ZEROES.     01070000
010800     05  PA-REFUND-RECS-WRITTEN PIC S9(11)      COMP-3            01080000
010900                                                VALUE ZEROES.     01090000
011000                                                                  01100000
011100******************************************************************01110000
011200*PS - PROGRAM SWITCHES                                            01120000
011300******************************************************************01130000
011400 01  PROGRAM-SWITCHES.                                            01140000
011500     05  PS-UPD-REFUND-EOF-SW    PIC X(01)      VALUE 'N'.        01150000
011600         88  PS-UPD-REFUND-EOF                  VALUE 'Y'.        01160000
011700     05  PS-PS-FIRST-TRANS-READ-SW PIC X(01)    VALUE 'Y'.        01170000
011800         88  PS-FIRST-TRANS-READ                VALUE 'Y'.        01180000
011900         88  PS-FIRST-TRANS-NOT-READ            VALUE 'N'.        01190000
012000                                                                  01200000
012100******************************************************************01210000
012200*  RECORD LAYOUT FOR INPUT FILE                                  *01220004
012300******************************************************************01230000
012340     COPY RDRD039.                                                01234010
012341                                                                  01234104
012600******************************************************************01260000
012700*  TRANSACTION PREPARATION MODULE LINKAGE SECTION                *01270000
012800******************************************************************01280000
260107     COPY DPWS990.                                                01281010
013000                                                                  01282010
012900     COPY DPLS000.                                                01290000
013000                                                                  01300000
013100******************************************************************01310000
013200*  SQL COMMUNICATIONS WORK AREA                                  *01320000
013300******************************************************************01330000
013400     COPY SQLCA2.                                                 01340000
013500                                                                  01350000
013600 EJECT                                                            01360000
013700******************************************************************01370000
013800 PROCEDURE DIVISION.                                              01380000
013900******************************************************************01390000
014000* A100-MAINLINE-PROCESSING                                        01400000
014100*    CONTROLS FLOW OF THE PROGRAM                                *01410000
014200******************************************************************01420000
014300 A100-MAINLINE-PROCESSING.                                        01430000
014400                                                                  01440000
014500     PERFORM B100-INITIALIZE.                                     01450000
014600                                                                  01460000
014700     PERFORM B200-PROCESS-UPD-REFUND-FILE                         01470000
014800         UNTIL PS-UPD-REFUND-EOF.                                 01480000
014900                                                                  01490000
015000     PERFORM B300-END-OF-JOB-ROUTINE.                             01500000
015100                                                                  01510000
015200     GOBACK.                                                      01520000
015300 EJECT                                                            01530000
015400******************************************************************01540000
015500* B100-INITIALIZE                                                *01550000
015600******************************************************************01560000
015700 B100-INITIALIZE.                                                 01570000
015800                                                                  01580000
015900     PERFORM C100-ISSUE-OPEN-REQUEST.                             01590000
016000                                                                  01600000
016100     OPEN INPUT UPDATE-REFUND-FILE.                               01610000
016200                                                                  01620000
016300     PERFORM C200-READ-UPDATE-REFUND-FILE.                        01630000
016400                                                                  01640000
016500     IF PS-UPD-REFUND-EOF                                         01650000
016600         DISPLAY ' '                                              01660000
016700         DISPLAY 'MESSAGES FOR PROGRAM ' PC-PROGRAM-NAME          01670000
016800         DISPLAY 'UPDATE REFUND FILE IS EMPTY'                    01680000
016900         DISPLAY ' '                                              01690000
017000     END-IF.                                                      01700000
017100                                                                  01710000
017200******************************************************************01720000
017300* B200-PROCESS-UPD-REFUND-FILE                                   *01730000
017400*     READ AN UPDATE REFUND RECORD.   IF END-OF-FILE, STOP PRO-  *01740000
017500*     CESSING.  IF A RECORD IS READ, GATHER WHATEVER OTHER DATA  *01750000
017600*     IS NECESSARY TO TAKE CHECKPOINTS BASED ON THE TYPE OF      *01760000
017700*     CHECKPOINTS BEING TAKEN BY RDKUP010 AND ISSUE A WRITE      *01770000
017800*     REQUEST TO THE TRANSACTION PREPARATION PROGRAM.            *01780000
017900******************************************************************01790000
018000 B200-PROCESS-UPD-REFUND-FILE.                                    01800000
018100                                                                  01810000
018200     IF PS-FIRST-TRANS-READ                                       01820000
018300         MOVE RD039-CUST-ID          TO PV-CUST-ID                01830004
018500         MOVE RD039-STR-RGST-ID      TO PV-STR-RGST-ID            01850005
018600         MOVE RD039-RGST-TRN-NBR     TO PV-RGST-TRN-NBR           01860006
018700         MOVE RD039-RFND-SEQ-NBR     TO PV-RFND-SEQ-NBR           01870005
018800         MOVE RD039-CHECK-NBR        TO PV-CHECK-NBR              01880004
018900         MOVE RD039-CHECK-DATE       TO PV-CHECK-DATE             01890004
019300         SET PS-FIRST-TRANS-NOT-READ TO TRUE                      01930000
019400     END-IF.                                                      01940000
019500                                                                  01950000
019600     IF CONTROL-BREAK                                             01960000
019700         PERFORM C300-CKPT-BY-CNTL-BREAK                          01970000
019800     ELSE                                                         01980000
019900         IF LOGICAL-TRANSACTION                                   01990000
020000             PERFORM C400-CKPT-BY-LOGICAL-TRANS                   02000000
020100         ELSE                                                     02010000
020200             PERFORM C500-CKPT-BY-TIME-OR-REQUEST                 02020000
020300         END-IF                                                   02030000
020400     END-IF.                                                      02040000
020500                                                                  02050000
020600     PERFORM C200-READ-UPDATE-REFUND-FILE.                        02060000
020700                                                                  02070000
020800 EJECT                                                            02080000
020900******************************************************************02090000
021000* B300-END-OF-JOB-ROUTINE                                        *02100000
021100******************************************************************02110000
021200 B300-END-OF-JOB-ROUTINE.                                         02120000
021300                                                                  02130000
021400     CLOSE UPDATE-REFUND-FILE.                                    02140000
021500                                                                  02150000
021600     DISPLAY ' '.                                                 02160000
021700     DISPLAY 'MESSAGES FOR PROGRAM ' PC-PROGRAM-NAME.             02170000
021800     DISPLAY 'NUMBER OF REFUND RECORDS READ:        '             02180000
021900             PA-REFUND-RECORDS-READ.                              02190000
022000     DISPLAY 'NUMBER OF TRANS/PREP RECORDS WRITTEN:  '            02200000
022100             PA-REFUND-RECS-WRITTEN.                              02210000
022200     DISPLAY ' '.                                                 02220000
022300                                                                  02230000
022400     PERFORM C600-ISSUE-CLOSE-REQUEST.                            02240000
022500                                                                  02250000
022600******************************************************************02260000
022700* C100-ISSUE-OPEN-REQUEST                                        *02270000
022800*     ISSUE AN 'OPEN' REQUEST TO THE TRANSACTION PREPARATION     *02280000
022900*     MODULE.                                                    *02290000
023000******************************************************************02300000
023100 C100-ISSUE-OPEN-REQUEST.                                         02310000
023200                                                                  02320000
023300     MOVE PC-TRAN-PREP-FUNC-OPEN TO DP000-FUNC-CODE.              02330000
023400     MOVE PC-JOB-NAME            TO DP000-JOB-NAME.               02340000
023500     MOVE PC-PLAN-NAME           TO DP000-PLAN-NAME.              02350000
023600                                                                  02360000
023700     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         02370000
023800                                                                  02380000
023900     MOVE DP000-CKPT-TYPE-CODE   TO PV-CHECKPOINT-TYPE.           02390000
024000                                                                  02400000
024100******************************************************************02410000
024200* C200-READ-UPDATE-REFUND-FILE                                   *02420000
024300******************************************************************02430000
024400 C200-READ-UPDATE-REFUND-FILE.                                    02440000
024500                                                                  02450000
024600     READ UPDATE-REFUND-FILE INTO RD039-RECORD                    02460004
024700         AT END                                                   02470000
024800             SET PS-UPD-REFUND-EOF TO TRUE.                       02480000
024900                                                                  02490000
025000     IF PS-UPD-REFUND-EOF                                         02500000
025100         CONTINUE                                                 02510000
025200     ELSE                                                         02520000
025300         ADD +1 TO PA-REFUND-RECORDS-READ                         02530000
025400     END-IF.                                                      02540000
025500                                                                  02550000
025600******************************************************************02560000
025700* C300-CKPT-BY-CNTL-BREAK                                        *02570000
025800*     THIS ROUTINE SETS THE CHECKPOINT INDICATOR ON THE TRANSAC- *02580000
025900*     TION RECORD "ON" IF THERE IS A CHANGE IN THE KEY INFO.     *02590000
026000*     AFTER THE TRANSACTION RECORD HAS BEEN FORMATTED, A WRITE   *02600000
026100*     REQUEST IS ISSUED TO THE TRANSACTION PREPARATION MODULE.   *02610000
026200* NOTE: AT THIS TIME CONTROL/LOGIC BREAK PROCESSING IS IDENTICAL.*02620000
026300******************************************************************02630000
026400 C300-CKPT-BY-CNTL-BREAK.                                         02640000
026500                                                                  02650000
026600     IF RD039-CUST-ID              = PV-CUST-ID                   02660004
026700       AND RD039-STR-RGST-ID       = PV-STR-RGST-ID               02670005
026800       AND RD039-RGST-TRN-NBR      = PV-RGST-TRN-NBR              02680004
026900       AND RD039-RFND-SEQ-NBR      = PV-RFND-SEQ-NBR              02690005
027000       AND RD039-CHECK-NBR         = PV-CHECK-NBR                 02700004
027100       AND RD039-CHECK-DATE        = PV-CHECK-DATE                02710004
027600         MOVE 'N'                    TO DP000-CHECKPOINT-IND      02760000
027700     ELSE                                                         02770000
027800         MOVE 'Y'                    TO DP000-CHECKPOINT-IND      02780000
027900         MOVE RD039-CUST-ID          TO PV-CUST-ID                02790004
028000         MOVE RD039-STR-RGST-ID      TO PV-STR-RGST-ID            02800005
028100         MOVE RD039-RGST-TRN-NBR     TO PV-RGST-TRN-NBR           02810004
028200         MOVE RD039-RFND-SEQ-NBR     TO PV-RFND-SEQ-NBR           02820005
028300         MOVE RD039-CHECK-NBR        TO PV-CHECK-NBR              02830004
028400         MOVE RD039-CHECK-DATE       TO PV-CHECK-DATE             02840004
028900     END-IF.                                                      02890000
029000                                                                  02900000
029100     MOVE PC-TRANS-RECORD-LENGTH  TO DP000-TRANS-REC-LENGTH.      02910000
029200     MOVE RD039-RECORD            TO DP000-TRANS-REC.             02920004
029300     MOVE PC-TRAN-PREP-FUNC-WRITE TO DP000-FUNC-CODE.             02930000
029400     MOVE PC-JOB-NAME             TO DP000-JOB-NAME.              02940000
029500     MOVE PC-PLAN-NAME            TO DP000-PLAN-NAME.             02950000
029600                                                                  02960000
029700     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         02970000
029800     ADD +1 TO PA-REFUND-RECS-WRITTEN.                            02980000
029900                                                                  02990000
030000******************************************************************03000000
030100* C400-CKPT-BY-LOGICAL-TRANS.                                    *03010000
030200*     THIS ROUTINE SETS THE CHECKPOINT INDICATOR ON THE TRANSAC- *03020000
030300*     TION RECORD "ON" IF THERE IS A CHANGE IN THE KEY INFO.     *03030000
030400*     AFTER THE TRANSACTION RECORD HAS BEEN FORMATTED, A WRITE   *03040000
030500*     REQUEST IS ISSUED TO THE TRANSACTION PERPARATION MODULE.   *03050000
030600* NOTE: AT THIS TIME CONTROL/LOGIC BREAK PROCESSING IS IDENTICAL.*03060000
030700******************************************************************03070000
030800 C400-CKPT-BY-LOGICAL-TRANS.                                      03080000
030900                                                                  03090000
031000     IF RD039-CUST-ID              = PV-CUST-ID                   03100004
031100       AND RD039-STR-RGST-ID       = PV-STR-RGST-ID               03110005
031200       AND RD039-RGST-TRN-NBR      = PV-RGST-TRN-NBR              03120004
031300       AND RD039-RFND-SEQ-NBR      = PV-RFND-SEQ-NBR              03130005
031400       AND RD039-CHECK-NBR         = PV-CHECK-NBR                 03140004
031500       AND RD039-CHECK-DATE        = PV-CHECK-DATE                03150004
032000         MOVE 'N'                    TO DP000-CHECKPOINT-IND      03200000
032100     ELSE                                                         03210000
032200         MOVE 'Y'                    TO DP000-CHECKPOINT-IND      03220000
032300         MOVE RD039-CUST-ID          TO PV-CUST-ID                03230004
032310         MOVE RD039-STR-RGST-ID      TO PV-STR-RGST-ID            03231005
032400         MOVE RD039-RGST-TRN-NBR     TO PV-RGST-TRN-NBR           03240004
032500         MOVE RD039-RFND-SEQ-NBR     TO PV-RFND-SEQ-NBR           03250005
032600         MOVE RD039-CHECK-NBR        TO PV-CHECK-NBR              03260004
032700         MOVE RD039-CHECK-DATE       TO PV-CHECK-DATE             03270004
033300     END-IF.                                                      03330000
033400                                                                  03340000
033500     MOVE PC-TRANS-RECORD-LENGTH  TO DP000-TRANS-REC-LENGTH.      03350000
033600     MOVE RD039-RECORD            TO DP000-TRANS-REC.             03360004
033700     MOVE PC-TRAN-PREP-FUNC-WRITE TO DP000-FUNC-CODE.             03370000
033800     MOVE PC-JOB-NAME             TO DP000-JOB-NAME.              03380000
033900     MOVE PC-PLAN-NAME            TO DP000-PLAN-NAME.             03390000
034000                                                                  03400000
034100     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         03410000
034200     ADD +1 TO PA-REFUND-RECS-WRITTEN.                            03420000
034300                                                                  03430000
034400******************************************************************03440000
034500* C500-CKPT-BY-TIME-OR-REQUEST.                                  *03450000
034600*     THIS ROUTINE BUILDS THE TRANSACTION RECORD AND ISSUES A    *03460000
034700*     WRITE REQUEST TO THE TRANSACTION PREPARATION MODULE IF     *03470000
034800*     CHECKPOINTS ARE TAKEN BY TIME INTERVAL (SECONDS) OR        *03480000
034900*     REQUESTED BY THE MAINTENANCE PROGRAM.                      *03490000
035000******************************************************************03500000
035100 C500-CKPT-BY-TIME-OR-REQUEST.                                    03510000
035200                                                                  03520000
035300     MOVE 'N' TO DP000-CHECKPOINT-IND.                            03530000
035400     MOVE PC-TRANS-RECORD-LENGTH  TO DP000-TRANS-REC-LENGTH.      03540000
035500     MOVE RD039-RECORD            TO DP000-TRANS-REC.             03550004
035600     MOVE PC-TRAN-PREP-FUNC-WRITE TO DP000-FUNC-CODE.             03560000
035700     MOVE PC-JOB-NAME             TO DP000-JOB-NAME.              03570000
035800     MOVE PC-PLAN-NAME            TO DP000-PLAN-NAME.             03580000
035900                                                                  03590000
036000     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         03600000
036100     ADD +1 TO PA-REFUND-RECS-WRITTEN.                            03610000
036200                                                                  03620000
036300******************************************************************03630000
036400* C600-ISSUE-CLOSE-REQUEST                                       *03640000
036500*     ISSUE A 'CLOSE' REQUEST TO THE TRANSACTION PREPARATION     *03650000
036600*     MODULE.                                                    *03660000
036700******************************************************************03670000
036800 C600-ISSUE-CLOSE-REQUEST.                                        03680000
036900                                                                  03690000
037000     MOVE PC-TRAN-PREP-FUNC-CLOSE TO DP000-FUNC-CODE.             03700000
037100     MOVE PC-JOB-NAME             TO DP000-JOB-NAME.              03710000
037200     MOVE PC-PLAN-NAME            TO DP000-PLAN-NAME.             03720000
037300                                                                  03730000
037400     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         03740000
037500                                                                  03750000
037600******************************************************************03760000
037700*  TRANSACTION PREPARATION MODULE CALL AND ERROR ROUTINES        *03770000
037800******************************************************************03780000
037900     COPY DPPD000.                                                03790000
038000                                                                  03800000
