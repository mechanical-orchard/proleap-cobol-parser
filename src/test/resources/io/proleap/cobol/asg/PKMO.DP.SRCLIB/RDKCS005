000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400 PROGRAM-ID.    RDKCS005.                                         00040000
000500 AUTHOR.        CHUCK ALBERTY -- EXACTA.                          00050000
000600 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00060000
000700 DATE-WRITTEN.  10-06-91.                                         00070000
000800 DATE-COMPILED.                                                   00080000
000900                                                                  00090000
001000******************************************************************00100000
001100*               CICS PROGRAM - RDKCS005 - U005                   *00110000
001200*                                                                *00120000
001300*      CASH REFUND SYSTEM - AUTHORIZATION CONTROL INQUIRY        *00130000
001400*                                                                *00140000
001500*   THIS PROGRAM WILL ALLOW THE INQUIRY OF THE CASH REFUND       *00150000
001600*   AUTHORIZATION CONTROLS GIVEN A STORE GROUP NUMBER.  IF A     *00160000
001700*   STORE GROUP NUMBER IS NOT GIVEN, THE PROGRAM WILL DISPLAY    *00170000
001800*   THE STORE GROUP NUMBER '00'.                                 *00180000
001900*                                                                *00190000
002000*   THIS PROGRAM WILL XCNTL TO  RDKCS009 WHEN UPDATES ARE TO     *00200000
002100*   BE MADE, I.E., FUNCTION = 'C', 'D' OR 'A'.                   *00210000
002200*                                                                *00220000
002300*   PF3  WILL EXIT THIS PROGRAM AND RETURN TO THE CASH REFUND    *00230000
002400*        MENU                                                    *00240000
002500*   PF4  WILL EXIT THIS PROGRAM AND RETURN TO THE MAIN MENU      *00250000
002600*   PF8  WILL DISPLAY THE NEXT STORE GROUP NUMBER                *00260000
002700*                                                                *00270000
002710* 10/11/2021 GERMAN BANDA                    WR/IR #: CHG0262418* 00271001
002720*            - CHANGE CALL OF DPKUT100 TO                       * 00272001
002730*              CALL DP010I-NUMERIC-EDIT-ROUTINE                 * 00273001
002740*              MAKING THE CALL DYNAMIC VS STATIC                * 00274001
002750*                                                               * 00275001
002760*---------------------------------------------------------------* 00276001
002800******************************************************************00280000
002900 ENVIRONMENT DIVISION.                                            00290000
003000******************************************************************00300000
003100 DATA DIVISION.                                                   00310000
003200******************************************************************00320000
003300*                                                                 00330000
003400 WORKING-STORAGE SECTION.                                         00340000
003500*                                                                 00350000
003600******************************************************************00360000
003700*    COPY BOOK FOR THE CICSAUTH SUBROUTINE                        00370000
003800******************************************************************00380000
003900     COPY DPWS008.                                                00390000
004000******************************************************************00400000
004100*  SENDING/RECEIVING AREA FOR THE NUMERIC EDIT ROUTINE (DPKUT100) 00410000
004200******************************************************************00420000
004300     COPY DPWS010I.                                               00430000
004400******************************************************************00440000
004500*  STANDARD ATTENTION IDENTIFIER LIST                             00450000
004600******************************************************************00460000
004700     COPY DFHAID.                                                 00470000
004800******************************************************************00480000
004900*  KOHLS STANDARD ATTRIBUTE LIST                                  00490000
005000******************************************************************00500000
005100     COPY DPWS015.                                                00510000
005200******************************************************************00520000
005300*   BECAUSE OF THE DIFFERENCE IN NAMING BETWEEN THE MAP FIELDS,   00530000
005400*   THE DB2 TABLE COLUMNS AND THE SCREEN DESCRIPTIONS, THE        00540000
005500*   FOLLOWING CROSS REFERENCE SHOULD BE MOST HELPFUL.  A CASE IN  00550000
005600*   POINT IS THE FOLLOWING:                                       00560000
005700*                                                                 00570000
005800*       SCREEN -- MAXIMUM REFUNDS PER ACTIVITY PERIOD             00580000
005900*                 ---             ---          -                  00590000
006000*                                                                 00600000
006100*   THE LETTERS MAX PER P ARE UNDERLINED, SO THE MAP FIELD IS     00610000
006200*   SET UP AS   MAXPERP   WITH THE APPROPRIATE ONE LETTER SUFFIX. 00620000
006300*                                                                 00630000
006400*   THE DB2 COLUMN USED FOR THAT MAP FIELD IS MAX_RET_PER_NBR.    00640000
006500*   AS BEST I CAN FIGURE IS THAT MEANS THE MAXIMUM NUMBER OF      00650000
006600*   REFUNDS FOR THE ACTIVITY PERIOD.  THE 'PER' IN THE COLUMN     00660000
006700*   DEFINITION MEANS 'PERIOD' INSTEAD OF 'PER'.                   00670000
006800*                                                                 00680000
006900*                                                                 00690000
007000*   MAP FIELD     DB2 TABLE                                       00700000
007100*   DEFINITION    DEFINITION            SCREEN DESCRIPTION        00710000
007200*   ----------    ----------            ------------------        00720000
007300*   STRGRP        AUTH_GP_NBR           STORE GROUP NUMBER        00730000
007400*                                                                 00740000
007500*   GRPDESC       AUTH_GP_DESC          DESCRIPTION               00750000
007600*                                                                 00760000
007700*   ACTPRD        ACTVY_PER_DAY_NBR     REFUND ACTIVITY PERIOD    00770000
007800*                                                                 00780000
007900*   MAXPERP       MAX_RET_PER_NBR       MAX REFUNDS PER           00790000
008000*                                       ACTIVITY PERIOD           00800000
008100*                                                                 00810000
008200*   MAXAMTP       MAX_DOL_RT_PER_AMT    MAX REFUND AMOUNT PER     00820000
008300*                                       ACTIVITY PERIOD           00830000
008400*                                                                 00840000
008500*   MAXPERD       MAX_RET_DAY_NBR       MAX REFUNDS PER DAY       00850000
008600*                                                                 00860000
008700*   MAXAMTD       MAX_DOL_RT_DAY_AMT    MAX REFUND AMOUNT PER DAY 00870000
008800*                                                                 00880000
008900*   MAXSTRD       MAX_STR_DAY_NBR       MAX NUMBER OF STORES      00890000
009000*                                       PER DAY                   00900000
009100*                                                                 00910000
009200*   LOWRFND       LO_RFND_AUTH_AMT      LOWEST AUTHORIZED REFUND  00920000
009300*                                       AMOUNT (ANY AMOUNT <=     00930000
009400*                                       TO THIS AMOUNT WILL BE    00940000
009500*                                       GIVEN A CASH REFUND)      00950000
009600*                                                                 00960000
009700*   HGHRFND       HGH_RFND_AUTH_AMT     HIGHEST AUTHORIZED REFUND 00970000
009800*                                       AMOUNT (ANY AMOUNT >=     00980000
009900*                                       TO THIS AMOUNT WILL BE    00990000
010000*                                       MAILED A CHECK)           01000000
010100*                                                                 01010000
010200*   CSHBACK       MAX_CSH_BCK_AMT       MAXIMUM KMRC CASH BACK    01020000
010300******************************************************************01030000
010400*  DSECT FOR THE RDKM005 MAPSET.  THIS IS HARD-CODED TO MAKE      01040000
010500*  USE OF ARRAYS FOR THE ASSOCIATED STORES.  ANY CHANGES TO       01050000
010600*  THE MAP SHOULD BE REFLECTED HERE ACCORDINGLY.                  01060000
010700******************************************************************01070000
010800 01  RD005AI.                                                     01080000
010900     05  FILLER                      PIC  X(12).                  01090000
011000*                                                                 01100000
011100     05  ADATEL                      PIC S9(04)      COMP.        01110000
011200     05  ADATEA                      PIC  X(01).                  01120000
011300     05  FILLER                      PIC  X(02).                  01130000
011400     05  ADATEI                      PIC  X(08).                  01140000
011500*                                                                 01150000
011600     05  ATIMEL                      PIC S9(04)      COMP.        01160000
011700     05  ATIMEA                      PIC  X(01).                  01170000
011800     05  FILLER                      PIC  X(02).                  01180000
011900     05  ATIMEI                      PIC  X(05).                  01190000
012000*                                                                 01200000
012100     05  ATERML                      PIC S9(04)      COMP.        01210000
012200     05  ATERMA                      PIC  X(01).                  01220000
012300     05  FILLER                      PIC  X(02).                  01230000
012400     05  ATERMI                      PIC  X(04).                  01240000
012500*                                                                 01250000
012600     05  FUNCTL                      PIC S9(04)      COMP.        01260000
012700     05  FUNCTA                      PIC  X(01).                  01270000
012800     05  FILLER                      PIC  X(02).                  01280000
012900     05  FUNCTI                      PIC  X(01).                  01290000
013000*                                                                 01300000
013100     05  STRGRPL                     PIC S9(04)      COMP.        01310000
013200     05  STRGRPA                     PIC  X(01).                  01320000
013300     05  FILLER                      PIC  X(02).                  01330000
013400     05  STRGRPI                     PIC  X(02).                  01340000
013500*                                                                 01350000
013600     05  GRPDESCL                    PIC S9(04)      COMP.        01360000
013700     05  GRPDESCA                    PIC  X(01).                  01370000
013800     05  FILLER                      PIC  X(02).                  01380000
013900     05  GRPDESCI                    PIC  X(20).                  01390000
014000*                                                                 01400000
014100     05  ACTPRDL                     PIC S9(04)      COMP.        01410000
014200     05  ACTPRDA                     PIC  X(01).                  01420000
014300     05  FILLER                      PIC  X(02).                  01430000
014400     05  ACTPRDI                     PIC  X(02).                  01440000
014500*                                                                 01450000
014600     05  MAXPERPL                    PIC S9(04)      COMP.        01460000
014700     05  MAXPERPA                    PIC  X(01).                  01470000
014800     05  FILLER                      PIC  X(02).                  01480000
014900     05  MAXPERPI                    PIC  X(01).                  01490000
015000*                                                                 01500000
015100     05  MAXAMTPL                    PIC S9(04)      COMP.        01510000
015200     05  MAXAMTPA                    PIC  X(01).                  01520000
015300     05  FILLER                      PIC  X(02).                  01530000
015400     05  MAXAMTPI                    PIC  X(05).                  01540000
015500*                                                                 01550000
015600     05  MAXPERDL                    PIC S9(04)      COMP.        01560000
015700     05  MAXPERDA                    PIC  X(01).                  01570000
015800     05  FILLER                      PIC  X(02).                  01580000
015900     05  MAXPERDI                    PIC  X(01).                  01590000
016000*                                                                 01600000
016100     05  MAXAMTDL                    PIC S9(04)      COMP.        01610000
016200     05  MAXAMTDA                    PIC  X(01).                  01620000
016300     05  FILLER                      PIC  X(02).                  01630000
016400     05  MAXAMTDI                    PIC  X(05).                  01640000
016500*                                                                 01650000
016600     05  MAXSTRDL                    PIC S9(04)      COMP.        01660000
016700     05  MAXSTRDA                    PIC  X(01).                  01670000
016800     05  FILLER                      PIC  X(02).                  01680000
016900     05  MAXSTRDI                    PIC  X(01).                  01690000
017000*                                                                 01700000
017100     05  LOWRFNDL                    PIC S9(04)      COMP.        01710000
017200     05  LOWRFNDA                    PIC  X(01).                  01720000
017300     05  FILLER                      PIC  X(02).                  01730000
017400     05  LOWRFNDI                    PIC  X(08).                  01740000
017500*                                                                 01750000
017600     05  HGHRFNDL                    PIC S9(04)      COMP.        01760000
017700     05  HGHRFNDA                    PIC  X(01).                  01770000
017800     05  FILLER                      PIC  X(02).                  01780000
017900     05  HGHRFNDI                    PIC  X(08).                  01790000
018000*                                                                 01800000
018100     05  CSHBACKL                    PIC S9(04)      COMP.        01810000
018200     05  CSHBACKA                    PIC  X(01).                  01820000
018300     05  FILLER                      PIC  X(02).                  01830000
018400     05  CSHBACKI                    PIC  X(08).                  01840000
018500*                                                                 01850000
018600     05  STORERI          OCCURS  6.                              01860000
018700         10  STORECI      OCCURS 13.                              01870000
018800             15  STRNBRL             PIC S9(04)      COMP.        01880000
018900             15  STRNBRA             PIC  X(01).                  01890000
019000             15  FILLER              PIC  X(02).                  01900000
019100             15  STRNBRI             PIC  9(05).                  01910000
019200*                                                                 01920000
019300     05  AMSGL                       PIC S9(04)      COMP.        01930000
019400     05  AMSGA                       PIC  X(01).                  01940000
019500     05  FILLER                      PIC  X(02).                  01950000
019600     05  AMSGI                       PIC  X(75).                  01960000
019700*                                                                 01970000
019800*                                                                 01980000
019900 01  RD005AO  REDEFINES  RD005AI.                                 01990000
020000     05  FILLER                      PIC  X(12).                  02000000
020100*                                                                 02010000
020200     05  FILLER                      PIC  X(03).                  02020000
020300     05  ADATEC                      PIC  X(01).                  02030000
020400     05  ADATEH                      PIC  X(01).                  02040000
020500     05  ADATEO                      PIC  X(08).                  02050000
020600*                                                                 02060000
020700     05  FILLER                      PIC  X(03).                  02070000
020800     05  ATIMEC                      PIC  X(01).                  02080000
020900     05  ATIMEH                      PIC  X(01).                  02090000
021000     05  ATIMEO                      PIC  X(05).                  02100000
021100*                                                                 02110000
021200     05  FILLER                      PIC  X(03).                  02120000
021300     05  ATERMC                      PIC  X(01).                  02130000
021400     05  ATERMH                      PIC  X(01).                  02140000
021500     05  ATERMO                      PIC  X(04).                  02150000
021600*                                                                 02160000
021700     05  FILLER                      PIC  X(03).                  02170000
021800     05  FUNCTC                      PIC  X(01).                  02180000
021900     05  FUNCTH                      PIC  X(01).                  02190000
022000     05  FUNCTO                      PIC  X(01).                  02200000
022100*                                                                 02210000
022200     05  FILLER                      PIC  X(03).                  02220000
022300     05  STRGRPC                     PIC  X(01).                  02230000
022400     05  STRGRPH                     PIC  X(01).                  02240000
022500     05  STRGRPO                     PIC  X(02).                  02250000
022600*                                                                 02260000
022700     05  FILLER                      PIC  X(03).                  02270000
022800     05  GRPDESCC                    PIC  X(01).                  02280000
022900     05  GRPDESCH                    PIC  X(01).                  02290000
023000     05  GRPDESCO                    PIC  X(20).                  02300000
023100*                                                                 02310000
023200     05  FILLER                      PIC  X(03).                  02320000
023300     05  ACTPRDC                     PIC  X(01).                  02330000
023400     05  ACTPRDH                     PIC  X(01).                  02340000
023500     05  ACTPRDO                     PIC  X(02).                  02350000
023600*                                                                 02360000
023700     05  FILLER                      PIC  X(03).                  02370000
023800     05  MAXPERPC                    PIC  X(01).                  02380000
023900     05  MAXPERPH                    PIC  X(01).                  02390000
024000     05  MAXPERPO                    PIC  X(01).                  02400000
024100*                                                                 02410000
024200     05  FILLER                      PIC  X(03).                  02420000
024300     05  MAXAMTPC                    PIC  X(01).                  02430000
024400     05  MAXAMTPH                    PIC  X(01).                  02440000
024500     05  MAXAMTPO                    PIC  X(05).                  02450000
024600*                                                                 02460000
024700     05  FILLER                      PIC  X(03).                  02470000
024800     05  MAXPERDC                    PIC  X(01).                  02480000
024900     05  MAXPERDH                    PIC  X(01).                  02490000
025000     05  MAXPERDO                    PIC  X(01).                  02500000
025100*                                                                 02510000
025200     05  FILLER                      PIC  X(03).                  02520000
025300     05  MAXAMTDC                    PIC  X(01).                  02530000
025400     05  MAXAMTDH                    PIC  X(01).                  02540000
025500     05  MAXAMTDO                    PIC  X(05).                  02550000
025600*                                                                 02560000
025700     05  FILLER                      PIC  X(03).                  02570000
025800     05  MAXSTRDC                    PIC  X(01).                  02580000
025900     05  MAXSTRDH                    PIC  X(01).                  02590000
026000     05  MAXSTRDO                    PIC  X(01).                  02600000
026100*                                                                 02610000
026200     05  FILLER                      PIC  X(03).                  02620000
026300     05  LOWRFNDC                    PIC  X(01).                  02630000
026400     05  LOWRFNDH                    PIC  X(01).                  02640000
026500     05  LOWRFNDO                    PIC  X(08).                  02650000
026600*                                                                 02660000
026700     05  FILLER                      PIC  X(03).                  02670000
026800     05  HGHRFNDC                    PIC  X(01).                  02680000
026900     05  HGHRFNDH                    PIC  X(01).                  02690000
027000     05  HGHRFNDO                    PIC  X(08).                  02700000
027100*                                                                 02710000
027200     05  FILLER                      PIC  X(03).                  02720000
027300     05  CSHBACKC                    PIC  X(01).                  02730000
027400     05  CSHBACKH                    PIC  X(01).                  02740000
027500     05  CSHBACKO                    PIC  X(08).                  02750000
027600*                                                                 02760000
027700     05  STORERO          OCCURS  6.                              02770000
027800         10  STORECO      OCCURS 13.                              02780000
027900             15  FILLER              PIC  X(03).                  02790000
028000             15  STRNBRC             PIC  X(01).                  02800000
028100             15  STRNBRH             PIC  X(01).                  02810000
028200             15  STRNBRO             PIC  9(05).                  02820000
028300*                                                                 02830000
028400     05  FILLER                      PIC  X(03).                  02840000
028500     05  AMSGC                       PIC  X(01).                  02850000
028600     05  AMSGH                       PIC  X(01).                  02860000
028700     05  AMSGO                       PIC  X(75).                  02870000
028800******************************************************************02880000
028900*   COMMUNICATION AREA                                            02890000
029000*     THE CA- FIELDS ARE ADDED FOR THIS PROGRAM'S USE.            02900000
029100******************************************************************02910000
029200     COPY RDRD000I.                                               02920000
029300     05  CA-COMM-FOR-RDKCS005.                                    02930000
029400         10  CA-LAST-STORE-GROUP     PIC S9(02)      COMP-3.      02940000
029500         10  CA-FUNCTION             PIC  X(01).                  02950000
029600         10  CA-RECORD.                                           02960000
029700             15  CA-STORE-GROUP-NMBR PIC S9(02)      COMP-3.      02970000
029800             15  CA-STORE-GROUP-NMBR-X  REDEFINES                 02980000
029900                 CA-STORE-GROUP-NMBR PIC  X(02).                  02990000
030000             15  CA-DESCRIPTION      PIC  X(20).                  03000000
030100             15  CA-REFUND-ACTIVITY-PRD                           03010000
030200                                     PIC S9(02)      COMP-3.      03020000
030300             15  CA-REFUND-ACTIVITY-PRD-X  REDEFINES              03030000
030400                 CA-REFUND-ACTIVITY-PRD                           03040000
030500                                     PIC  X(02).                  03050000
030600             15  CA-MAX-REFUND-PER-DAY                            03060000
030700                                     PIC S9(01)      COMP-3.      03070000
030800             15  CA-MAX-REFUND-PER-DAY-X  REDEFINES               03080000
030900                 CA-MAX-REFUND-PER-DAY                            03090000
031000                                     PIC  X(01).                  03100000
031100             15  CA-MAX-REFUND-PER-PRD                            03110000
031200                                     PIC S9(01)      COMP-3.      03120000
031300             15  CA-MAX-REFUND-PER-PRD-X  REDEFINES               03130000
031400                 CA-MAX-REFUND-PER-PRD                            03140000
031500                                     PIC  X(01).                  03150000
031600             15  CA-MAX-REFUND-AMT-PER-DAY                        03160000
031700                                     PIC S9(05).                  03170000
031800             15  CA-MAX-REFUND-AMT-PER-DAY-X  REDEFINES           03180000
031900                 CA-MAX-REFUND-AMT-PER-DAY                        03190000
032000                                     PIC  X(05).                  03200000
032100             15  CA-MAX-REFUND-AMT-PER-PRD                        03210000
032200                                     PIC S9(05).                  03220000
032300             15  CA-MAX-REFUND-AMT-PER-PRD-X  REDEFINES           03230000
032400                 CA-MAX-REFUND-AMT-PER-PRD                        03240000
032500                                     PIC  X(05).                  03250000
032600             15  CA-MAX-NMBR-OF-STORES                            03260000
032700                                     PIC S9(01)      COMP-3.      03270000
032800             15  CA-MAX-NMBR-OF-STORES-X  REDEFINES               03280000
032900                 CA-MAX-NMBR-OF-STORES                            03290000
033000                                     PIC  X(01).                  03300000
033100             15  CA-LO-RFND-AUTH-AMT PIC S9(05)V9(02).            03310000
033200             15  CA-LO-RFND-AUTH-AMT-X REDEFINES                  03320000
033300                 CA-LO-RFND-AUTH-AMT PIC X(07).                   03330000
033400             15  CA-HGH-RFND-AUTH-AMT PIC S9(05)V9(02).           03340000
033500             15  CA-HGH-RFND-AUTH-AMT-X REDEFINES                 03350000
033600                 CA-HGH-RFND-AUTH-AMT PIC X(07).                  03360000
033700             15  CA-MAX-CSH-BCK-AMT  PIC S9(05)V9(02).            03370000
033800             15  CA-MAX-CSH-BCK-AMT-X REDEFINES                   03380000
033900                 CA-MAX-CSH-BCK-AMT  PIC X(07).                   03390000
034000             15  CA-STORES.                                       03400000
034100                 20  CA-LIST-STORES  OCCURS 78.                   03410000
034200                     25  CA-ASSOCIATED-STORES                     03420000
034300                                     PIC 9(05).                   03430000
034400                     25  CA-ASSOCIATED-STORES-X  REDEFINES        03440000
034500                         CA-ASSOCIATED-STORES                     03450000
034600                                     PIC  X(05).                  03460000
034700                     25  CA-STORE-UPDATE-SW                       03470000
034800                                     PIC  X(01).                  03480000
034900         10  CA-UPDATE-SW            PIC  X(01).                  03490000
035000             88  CA-CAN-UPDATE                       VALUE 'Y'.   03500000
035100             88  CA-CANNOT-UPDATE                    VALUE 'N'.   03510000
035200******************************************************************03520000
035300*   UNFORMATTED MESSAGES FOR DB2 ERRORS/WARNINGS                  03530000
035400******************************************************************03540000
035500 01  DM-DB2-MESSAGES.                                             03550000
035600     05  DM-RESOURCE-UNAVAIL-MSG.                                 03560000
035700         10  FILLER                  PIC  X(48)      VALUE        03570000
035800             'A RESOURCE WAS NOT AVAILABLE.  PLEASE TRY AGAIN.'.  03580000
035900         10  FILLER                  PIC  X(36)      VALUE        03590000
036000             'IF THE PROBLEM PERSISTS, CONTACT DP '.              03600000
036100     05  DM-DEADLOCK-TIMEOUT-MSG.                                 03610000
036200         10  FILLER                  PIC  X(48)      VALUE        03620000
036300             'DEADLOCK OR TIMEOUT.  PLEASE TRY AGAIN.         '.  03630000
036400         10  FILLER                  PIC  X(36)      VALUE        03640000
036500             'IF THE PROBLEM PERSISTS, CONTACT DP '.              03650000
036600     05  DM-NOT-AUTHORIZED-MSG.                                   03660000
036700         10  FILLER                  PIC  X(48)      VALUE        03670000
036800             'CONNECTION AUTHORIZATION FAILURE.  CONTACT DP.  '.  03680000
036900     05  DM-NOT-CONNECTED-MSG.                                    03690000
037000         10  FILLER                  PIC  X(48)      VALUE        03700000
037100             'CONNECTION NOT ESTABLISHED.  TRY AGAIN.         '.  03710000
037200         10  FILLER                  PIC  X(36)      VALUE        03720000
037300             'IF PROBLEM PERSISTS, CONTACT DP.    '.              03730000
037400     05  DM-OTHER-DB2-ERROR-MSG.                                  03740000
037500         10  FILLER                  PIC  X(48)      VALUE        03750000
037600             'A DB2 ERROR HAS OCCURRED - CONTACT DP - '.          03760000
037700     05  DM-DB2-ERROR-MSG.                                        03770000
037800         10  DM-ERROR-MSG            PIC  X(84).                  03780000
037900         10  FILLER                  PIC  X(45)      VALUE        03790000
038000             'PROGRAM RDKCS005'.                                  03800000
038100         10  FILLER                  PIC  X(11)      VALUE        03810000
038200             'SQLCODE = ('.                                       03820000
038300         10  DM-SQLCODE              PIC Z(8)9-      VALUE ZERO.  03830000
038400         10  FILLER                  PIC  X(22)      VALUE        03840000
038500             ')   ROWS PROCESSED = ('.                            03850000
038600         10  DM-ROWS-ERR-PROCESSED   PIC Z(8)9-      VALUE ZERO.  03860000
038700         10  FILLER                  PIC  X(02)      VALUE ')'.   03870000
038800         10  FILLER                  PIC  X(11)      VALUE        03880000
038900             'SQLERRML= ('.                                       03890000
039000         10  DM-SQLERRML             PIC Z(8)9-      VALUE ZERO.  03900000
039100         10  FILLER                  PIC  X(15)      VALUE        03910000
039200             ')   SQLERRMC = '.                                   03920000
039300         10  DM-SQLERRMC             PIC  X(70)      VALUE SPACES.03930000
039400     05  DM-DB2-WARNING-MSG.                                      03940000
039500         10  FILLER                  PIC  X(42)      VALUE        03950000
039600             'A DB2 WARNING HAS OCCURRED - CONTACT DP - '.        03960000
039700         10  FILLER                  PIC  X(43)      VALUE        03970000
039800             'PROGRAM RDKCS005'.                                  03980000
039900         10  FILLER                  PIC  X(11)      VALUE        03990000
040000             'SQLWARN = ('.                                       04000000
040100         10  DM-SQLWARN              PIC  X(08)      VALUE SPACES.04010000
040200         10  FILLER                  PIC  X(14)      VALUE        04020000
040300             ')  SQLCODE = ('.                                    04030000
040400         10  DM-SQLCODE1             PIC Z(8)9-      VALUE ZERO.  04040000
040500         10  FILLER                  PIC  X(22)      VALUE        04050000
040600             ')   ROWS PROCESSED = ('.                            04060000
040700         10  DM-ROWS-WRN-PROCESSED   PIC Z(8)9-      VALUE ZERO.  04070000
040800         10  FILLER                  PIC  X(04)      VALUE ')'.   04080000
040900                                                                  04090000
041000 01  PA-PROGRAM-ACCUMULATORS.                                     04100000
041100     05  PA-SUB1                     PIC S9(04)      COMP         04110000
041200                                                     VALUE +0.    04120000
041300     05  PA-SUB2                     PIC S9(04)      COMP         04130000
041400                                                     VALUE +0.    04140000
041500     05  PA-SUB3                     PIC S9(04)      COMP         04150000
041600                                                     VALUE +0.    04160000
041700     05  PA-RETRY-COUNT              PIC S9(04)      COMP         04170000
041800                                                     VALUE +0.    04180000
041900     05  PA-STORE-ACCUM              PIC S9(04)      COMP         04190000
042000                                                     VALUE +0.    04200000
042100                                                                  04210000
042200                                                                  04220000
042300 01  PC-PROGRAM-CONSTANTS.                                        04230000
042400     05  PC-THIS-PROGRAM             PIC  X(08)      VALUE        04240000
042500         'RDKCS005'.                                              04250000
042600     05  PC-MAIN-MENU-PROG           PIC  X(08)      VALUE        04260000
042700         'RDKCS000'.                                              04270000
042800     05  PC-CNTL-MAINT-PROG          PIC  X(08)      VALUE        04280000
042900         'RDKCS009'.                                              04290000
043000     05  PC-U005                     PIC  X(04)      VALUE 'U005'.04300000
043100     05  PC-OPERATING-COMPANY        PIC  X(02)      VALUE '03'.  04310000
043200     05  PC-DEPARTMENT-STORE         PIC  X(02)      VALUE 'DS'.  04320000
043300     05  PC-STORE-COLUMNS            PIC S9(04)      VALUE +13    04330000
043400                                                     COMP SYNC.   04340000
043500     05  PC-MAX-STORES               PIC S9(04)      VALUE +78    04350000
043600                                                     COMP SYNC.   04360000
043700     05  PC-MAX-RETRY                PIC S9(04)      VALUE +3     04370000
043800                                                     COMP SYNC.   04380000
043900     05  PC-MORE-THAN-MAX-RETRY      PIC S9(04)      VALUE +4     04390000
044000                                                     COMP SYNC.   04400000
044100     05  PC-COMMAREA-LENGTH          PIC S9(04)      VALUE +635   04410000
044200                                                     COMP SYNC.   04420000
044300     05  PC-MSG-LENGTH               PIC S9(04)      VALUE +54    04430000
044400                                                     COMP SYNC.   04440000
044500     05  PC-DB2-ERROR-LENGTH         PIC S9(04)      VALUE +290   04450000
044600                                                     COMP SYNC.   04460000
044700     05  PC-DB2-WARNING-LENGTH       PIC S9(04)      VALUE +162   04470000
044800                                                     COMP SYNC.   04480000
044900     05  PC-HEX-80                   PIC  X(01)      VALUE 'ø'.   04490000
045000     05  PC-ADD                      PIC  X(01)      VALUE 'A'.   04500000
045100     05  PC-CHANGE                   PIC  X(01)      VALUE 'C'.   04510000
045200     05  PC-DELETE                   PIC  X(01)      VALUE 'D'.   04520000
045300     05  PC-INQUIRE                  PIC  X(01)      VALUE 'I'.   04530000
045400     05  PC-EOF-KEYED-COMP           PIC S9(04)      VALUE +128   04540000
045500                                                     COMP SYNC.   04550000
045600     05  FILLER  REDEFINES  PC-EOF-KEYED-COMP.                    04560000
045700         10  FILLER                  PIC  X(01).                  04570000
045800         10  PC-EOF-KEYED            PIC  X(01).                  04580000
045900                                                                  04590000
046000                                                                  04600000
046100 01  PE-PROGRAM-EDIT-MASKS.                                       04610000
046200     05  PE-STORE-GROUP-MASK         PIC  ZZ.                     04620000
046300     05  PE-CASH-MASK                PIC  Z,ZZZ.                  04630000
046400     05  PE-AUTH-AMT-MASK            PIC  ZZZZZ.99.               04640000
046500                                                                  04650000
046600                                                                  04660000
046700 01  PM-PGM-MSG-DATA.                                             04670000
046800** 01                                                             04680000
046900     05  FILLER                      PIC  X(54)      VALUE        04690000
047000         '                                                      '.04700000
047100** 02                                                             04710000
047200     05  FILLER                      PIC  X(54)      VALUE        04720000
047300         'FUNCTION CODE SHOULD BE A, C, D OR I                  '.04730000
047400** 03                                                             04740000
047500     05  FILLER                      PIC  X(54)      VALUE        04750000
047600         'ERROR - INVALID PF REQUEST                            '.04760000
047700** 04                                                             04770000
047800     05  FILLER                      PIC  X(54)      VALUE        04780000
047900         'ERROR - STORE GROUP NUMBER DOES NOT EXIST             '.04790000
048000** 05                                                             04800000
048100     05  FILLER                      PIC  X(54)      VALUE        04810000
048200         'NO MORE STORE GROUPS TO DISPLAY                       '.04820000
048300** 06                                                             04830000
048400     05  FILLER                      PIC  X(54)      VALUE        04840000
048500         'STOP!!  SCREEN READ FAILED!!  CONTACT SYSTEMS!!       '.04850000
048600** 07                                                             04860000
048700     05  FILLER                      PIC  X(54)      VALUE        04870000
048800         'USER HAS NO UPDATE AUTHORITY                          '.04880000
048900** 08                                                             04890000
049000     05  FILLER                      PIC  X(54)      VALUE        04900000
049100         'PROGRAM ID ERROR !!  CONTACT SYSTEMS!!                '.04910000
049200** 09                                                             04920000
049300     05  FILLER                      PIC  X(54)      VALUE        04930000
049400         'STORE GROUP NUMBER INVALID                            '.04940000
049500** 10                                                             04950000
049600     05  FILLER                      PIC  X(54)      VALUE        04960000
049700         'BAD LINK TO RACF PROGRAM  -  NOTIFY DP                '.04970000
049800 01  PM-PGM-MSG-TABLE  REDEFINES  PM-PGM-MSG-DATA.                04980000
049900     05  PM-PGM-MSG OCCURS 10 TIMES                               04990000
050000                    INDEXED BY PM-INDX                            05000000
050100                                     PIC  X(54).                  05010000
050200                                                                  05020000
050300 01  PM-CICSAUTH-MSG.                                             05030000
050400     05  FILLER                      PIC  X(36)      VALUE        05040000
050500         'INVALID RETURN CODE FROM CICSAUTH - '.                  05050000
050600     05  PM-CM-RETURN-CODE           PIC  9(04).                  05060000
050700                                                                  05070000
050800                                                                  05080000
050900 01  PS-PROGRAM-SWITCHES.                                         05090000
051000     05  PS-MAPFAIL-ERROR-IND        PIC  X(01)      VALUE 'N'.   05100000
051100         88  PS-NO-MAPFAIL                           VALUE 'N'.   05110000
051200         88  PS-MAPFAIL                              VALUE 'Y'.   05120000
051300     05  PS-FIELD-ERROR              PIC  X(01)      VALUE 'N'.   05130000
051400         88  PS-NO-ERROR                             VALUE 'N'.   05140000
051500         88  PS-ERROR                                VALUE 'Y'.   05150000
051600     05  PS-ACCESS-IND               PIC  X(01)      VALUE 'N'.   05160000
051700         88  PS-NO-ACCESS                            VALUE 'N'.   05170000
051800         88  PS-ACCESS                               VALUE 'Y'.   05180000
051900                                                                  05190000
052000                                                                  05200000
052100 01  PV-PROGRAM-VARIABLES.                                        05210000
052200     05  PV-CICS-RESPONSE            PIC S9(09)      VALUE ZERO   05220000
052300                                                     COMP SYNC.   05230000
052400     05  PV-RESP                     PIC S9(04)      VALUE ZERO   05240000
052500                                                     COMP.        05250000
052600     05  PV-FUNCTION                 PIC  X(01)      VALUE SPACE. 05260000
052700         88  PV-VALID-FUNCTION                       VALUE 'A'    05270000
052800                                                           'I'    05280000
052900                                                           'C'    05290000
053000                                                           'D'.   05300000
053100 01  ST-SYSTEM-TIME-AREA.                                         05310000
053200     05  ST-ABSTIME                  PIC S9(18)      VALUE ZERO   05320000
053300                                                     COMP SYNC.   05330000
053400     05  ST-TIME-EDIT.                                            05340000
053500         10  ST-TIME-HHMM            PIC  X(05)      VALUE SPACES.05350000
053600         10  FILLER                  PIC  X(03)      VALUE SPACES.05360000
054310******************************************************************05431000
054320*  SQL AND COBOL DECLARATIONS FOR XST_LOC TABLE                   05432000
054330******************************************************************05433000
054340     EXEC SQL                                                     05434000
054350          INCLUDE XST00001                                        05435000
054360     END-EXEC.                                                    05436000
054370                                                                  05437000
054380******************************************************************05438000
054390*  SQL AND COBOL DECLARATIONS FOR XST_LOC_ATTR TABLE              05439000
054391******************************************************************05439100
054392     EXEC SQL                                                     05439200
054393          INCLUDE XST00025                                        05439300
054394     END-EXEC.                                                    05439400
054395                                                                  05439500
054400******************************************************************05440000
054500*  SQL AND COBOL DECLARATIONS FOR THE CASH REFUND AUTHORIZATION   05450000
054600*  CONTROL TABLE (TRDCNTL)                                        05460000
054700******************************************************************05470000
054800     EXEC SQL                                                     05480000
054900          INCLUDE TRDCNTL                                         05490000
055000     END-EXEC.                                                    05500000
055100                                                                  05510000
055200******************************************************************05520000
055300*  STANDARD LAYOUT FOR THE SQL COMMUNICATIONS AREA                05530000
055400******************************************************************05540000
055500     EXEC SQL                                                     05550000
055600          INCLUDE SQLCA                                           05560000
055700     END-EXEC.                                                    05570000
055800******************************************************************05580000
055910*  DECLARE CURSOR FOR XST_LOC TO GET STR-NBR                      05591000
056000******************************************************************05600000
056100     EXEC SQL                                                     05610000
056200          DECLARE STORE_CSR CURSOR FOR                            05620000
056300           SELECT A.LOC_NBR                                       05630000
056400             FROM XST_LOC A,                                      05640000
056410                  XST_LOC_ATTR B                                  05641000
056420            WHERE A.LOC_NBR         = B.LOC_NBR                   05642000
056430              AND A.LOC_TYP_CDE     = :PC-DEPARTMENT-STORE        05643000
056500              AND B.CSH_RFND_GP_NBR = :RDCNTL-AUTH-GP-NBR         05650000
056800            ORDER BY A.LOC_NBR                                    05680000
056900     END-EXEC.                                                    05690000
057000                                                                  05700000
057100******************************************************************05710000
057200*  DECLARE CURSOR FOR TRDCNTL TO GET PARAMETERS                   05720000
057300******************************************************************05730000
057400     EXEC SQL                                                     05740000
057500          DECLARE REFUND_CSR CURSOR FOR                           05750000
057600           SELECT AUTH_GP_NBR,                                    05760000
057700                  AUTH_GP_DESC,                                   05770000
057800                  ACTVY_PER_DAY_NBR,                              05780000
057900                  MAX_RET_PER_NBR,                                05790000
058000                  MAX_DOL_RT_PER_AMT,                             05800000
058100                  MAX_STR_DAY_NBR,                                05810000
058200                  MAX_RET_DAY_NBR,                                05820000
058300                  MAX_DOL_RT_DAY_AMT,                             05830000
058400                  LO_RFND_AUTH_AMT,                               05840000
058500                  HGH_RFND_AUTH_AMT,                              05850000
058600                  MAX_CSH_BCK_AMT                                 05860000
058700             FROM TRDCNTL                                         05870000
058800            WHERE AUTH_GP_NBR > :CA-STORE-GROUP-NMBR              05880000
058900            ORDER BY AUTH_GP_NBR                                  05890000
059000     END-EXEC.                                                    05900000
059100******************************************************************05910000
059200 LINKAGE SECTION.                                                 05920000
059300******************************************************************05930000
059400 01  DFHCOMMAREA                     PIC  X(635).                 05940000
059500                                                                  05950000
059600 01  DF-ADDRESS-AREA.                                             05960000
059700     05  DF-TRANID                   PIC  X(04).                  05970000
059800     05  DF-RESULT                   PIC  X(01).                  05980000
059900     05  FILLER                      PIC  X(95).                  05990000
060000******************************************************************06000000
060100 PROCEDURE DIVISION.                                              06010000
060200******************************************************************06020000
060300                                                                  06030000
060400******************************************************************06040000
060500*   DETERMINES WHAT PF KEY WAS HIT TO DO THE APPROPRIATE ACTION.  06050000
060600*   DISPLAYS MAP AND RETURNS TO ITS OWN TRANS-ID.                 06060000
060700******************************************************************06070000
060800 0000-MAINLINE.                                                   06080000
060900                                                                  06090000
061000     SET PM-INDX                     TO 1.                        06100000
061100                                                                  06110000
061200     MOVE DFHCOMMAREA                TO RD000I-COMMUNICATION-AREA.06120000
061300                                                                  06130000
061400     EVALUATE TRUE                                                06140000
061500         WHEN EIBAID = DFHPF3                                     06150000
061600              PERFORM 9300-RETURN-TO-SYSTEM-MENU                  06160000
061700         WHEN EIBAID = DFHPF4                                     06170000
061800              PERFORM 9200-RETURN-TO-MAIN-MENU                    06180000
061900         WHEN RD000I-INITIALIZE-SCREEN                            06190000
062000         WHEN EIBAID = DFHCLEAR                                   06200000
062100              PERFORM 1000-SEND-INITIAL-MAP                       06210000
062200         WHEN EIBAID = DFHPF8                                     06220000
062300              PERFORM 2500-DISPLAY-NEXT-RECORD                    06230000
062400         WHEN EIBAID = DFHENTER                                   06240000
062500              PERFORM 2000-PROCESS-FUNCTION                       06250000
062600         WHEN OTHER                                               06260000
062700              SET PM-INDX            TO 3                         06270000
062800              SET PS-ERROR           TO TRUE                      06280000
062900              MOVE -1                TO FUNCTL                    06290000
063000     END-EVALUATE.                                                06300000
063100                                                                  06310000
063200     IF  PS-ERROR                                                 06320000
063300         PERFORM 8200-SEND-DATA-ONLY                              06330000
063400     ELSE                                                         06340000
063500         MOVE CA-STORE-GROUP-NMBR    TO CA-LAST-STORE-GROUP       06350000
063600         PERFORM 8100-SEND-MAP                                    06360000
063700     END-IF.                                                      06370000
063800                                                                  06380000
063900     EXEC CICS RETURN                                             06390000
064000               TRANSID('U005')                                    06400000
064100               COMMAREA(RD000I-COMMUNICATION-AREA)                06410000
064200               LENGTH(PC-COMMAREA-LENGTH)                         06420000
064300     END-EXEC.                                                    06430000
064400                                                                  06440000
064500     GOBACK.                                                      06450000
064600******************************************************************06460000
064700*  INITIALIZE SCREEN FIELDS AND SEND THE INITIAL MAP.            *06470000
064800******************************************************************06480000
064900 1000-SEND-INITIAL-MAP.                                           06490000
065000                                                                  06500000
065100     MOVE LOW-VALUES                 TO RD005AI.                  06510000
065200     SET PM-INDX                     TO 1.                        06520000
065300                                                                  06530000
065400     MOVE -1                         TO FUNCTL.                   06540000
065500                                                                  06550000
065600     EVALUATE TRUE                                                06560000
065700         WHEN RD000I-LAST-PROGRAM = PC-CNTL-MAINT-PROG            06570000
065800              PERFORM 2400-DISPLAY-RECORD                         06580000
065900              MOVE CA-STORE-GROUP-NMBR                            06590000
066000                                     TO CA-LAST-STORE-GROUP       06600000
066100         WHEN RD000I-LAST-PROGRAM = PC-MAIN-MENU-PROG             06610000
066200              INITIALIZE RD000I-DRIVER-LCNSE-NMBR                 06620000
066300                         CA-COMM-FOR-RDKCS005                     06630000
066400         WHEN ANY                                                 06640000
066500              INITIALIZE CA-COMM-FOR-RDKCS005                     06650000
066600     END-EVALUATE.                                                06660000
066700                                                                  06670000
066800     SET RD000I-PROCESS-SCREEN       TO TRUE.                     06680000
066900     PERFORM 8100-SEND-MAP.                                       06690000
067000                                                                  06700000
067100     EXEC CICS RETURN                                             06710000
067200               TRANSID('U005')                                    06720000
067300               COMMAREA(RD000I-COMMUNICATION-AREA)                06730000
067400               LENGTH(PC-COMMAREA-LENGTH)                         06740000
067500     END-EXEC.                                                    06750000
067600******************************************************************06760000
067700*  PROCESS THE FUNCTION REQUESTED.                               *06770000
067800******************************************************************06780000
067900 2000-PROCESS-FUNCTION.                                           06790000
068000                                                                  06800000
068100     PERFORM 8000-RECEIVE-MAP.                                    06810000
068200                                                                  06820000
068300     EVALUATE TRUE                                                06830000
068400         WHEN CA-FUNCTION = PC-ADD                                06840000
068500              IF  PS-NO-ERROR                                     06850000
068600                  PERFORM 9400-XCTL-MAINT-PROGRAM                 06860000
068700              END-IF                                              06870000
068800         WHEN CA-FUNCTION = PC-CHANGE                             06880000
068900              IF  PS-NO-ERROR                                     06890000
069000                  PERFORM 9400-XCTL-MAINT-PROGRAM                 06900000
069100              END-IF                                              06910000
069200         WHEN CA-FUNCTION = PC-DELETE                             06920000
069300              IF  PS-NO-ERROR                                     06930000
069400                  PERFORM 9400-XCTL-MAINT-PROGRAM                 06940000
069500              END-IF                                              06950000
069600         WHEN CA-FUNCTION = PC-INQUIRE                            06960000
069700              IF  PS-NO-ERROR                                     06970000
069800                  PERFORM 2400-DISPLAY-RECORD                     06980000
069900              END-IF                                              06990000
070000         WHEN OTHER                                               07000000
070100              SET PM-INDX            TO 2                         07010000
070200              SET PS-ERROR           TO TRUE                      07020000
070300              MOVE DP015-RED         TO FUNCTC                    07030000
070400              MOVE DP015-REVERSE     TO FUNCTH                    07040000
070500              MOVE -1                TO FUNCTL                    07050000
070600     END-EVALUATE.                                                07060000
070700                                                                  07070000
070800     IF  CA-STORE-GROUP-NMBR NOT NUMERIC                          07080000
070900         MOVE 0                      TO CA-STORE-GROUP-NMBR       07090000
071000     END-IF.                                                      07100000
071100******************************************************************07110000
071200*  DISPLAY CHECK AUTH PARAMETERS FOR THE STORE-GROUP REQUESTED   *07120000
071300******************************************************************07130000
071400 2400-DISPLAY-RECORD.                                             07140000
071500                                                                  07150000
071600     MOVE CA-FUNCTION                TO FUNCTO.                   07160000
071700     MOVE CA-STORE-GROUP-NMBR        TO STRGRPO.                  07170000
071800     INITIALIZE CA-STORES.                                        07180000
071900     MOVE PC-THIS-PROGRAM            TO RD000I-LAST-PROGRAM.      07190000
072000                                                                  07200000
072100     PERFORM 8400-GET-REFUND-AUTH.                                07210000
072200                                                                  07220000
072300     IF  SQLCODE = 0                                              07230000
072400         PERFORM 2520-RECORD-FOUND                                07240000
072500     END-IF.                                                      07250000
072600******************************************************************07260000
072700*  DISPLAY CHECK AUTH PARAMETERS FOR THE NEXT STORE-GROUP NMBR   *07270000
072800******************************************************************07280000
072900 2500-DISPLAY-NEXT-RECORD.                                        07290000
073000                                                                  07300000
073100     PERFORM 8500-OPEN-REFUND-CURSOR.                             07310000
073200                                                                  07320000
073300     PERFORM 8900-FETCH-REFUND-CSR.                               07330000
073400     IF  SQLCODE = 0                                              07340000
073500         PERFORM 2520-RECORD-FOUND                                07350000
073600     END-IF.                                                      07360000
073700                                                                  07370000
073800     PERFORM 8600-CLOSE-REFUND-CURSOR.                            07380000
073900******************************************************************07390000
074000*  BUILD MAP TO DISPLAY THE CASH REFUND AUTHORIZATION CONTROL    *07400000
074100*  PARAMETERS AND SAVE IN THE COMMUNICATION AREA                 *07410000
074200******************************************************************07420000
074300 2520-RECORD-FOUND.                                               07430000
074400                                                                  07440000
074500     MOVE LOW-VALUES                 TO RD005AI.                  07450000
074600*                                                                 07460000
074700     MOVE CA-FUNCTION                TO FUNCTO.                   07470000
074800     MOVE RDCNTL-AUTH-GP-NBR         TO STRGRPO                   07480000
074900                                        CA-STORE-GROUP-NMBR.      07490000
075000     MOVE RDCNTL-AUTH-GP-DESC        TO GRPDESCO                  07500000
075100                                        CA-DESCRIPTION.           07510000
075200***                                                               07520000
075300***  SCREEN FIELDS FOR THE PERIOD                                 07530000
075400***                                                               07540000
075500     MOVE RDCNTL-ACTVY-PER-DAY-NBR   TO ACTPRDO                   07550000
075600                                        CA-REFUND-ACTIVITY-PRD.   07560000
075700     MOVE RDCNTL-MAX-RET-PER-NBR     TO MAXPERPO                  07570000
075800                                        CA-MAX-REFUND-PER-PRD.    07580000
075900     MOVE RDCNTL-MAX-DOL-RT-PER-AMT  TO PE-CASH-MASK              07590000
076000                                        CA-MAX-REFUND-AMT-PER-PRD.07600000
076100     MOVE PE-CASH-MASK               TO MAXAMTPO.                 07610000
076200***                                                               07620000
076300***  SCREEN FIELDS FOR ONE DAY                                    07630000
076400***                                                               07640000
076500     MOVE RDCNTL-MAX-RET-DAY-NBR     TO MAXPERDO                  07650000
076600                                        CA-MAX-REFUND-PER-DAY.    07660000
076700     MOVE RDCNTL-MAX-DOL-RT-DAY-AMT  TO PE-CASH-MASK              07670000
076800                                        CA-MAX-REFUND-AMT-PER-DAY.07680000
076900     MOVE PE-CASH-MASK               TO MAXAMTDO.                 07690000
077000     MOVE RDCNTL-MAX-STR-DAY-NBR     TO MAXSTRDO                  07700000
077100                                        CA-MAX-NMBR-OF-STORES.    07710000
077200***                                                               07720000
077300***  SCREEN FIELDS FOR CASH REFUND VS. MAIL CHECK AUTH. AMOUNTS   07730000
077400***                                                               07740000
077500     MOVE RDCNTL-LO-RFND-AUTH-AMT    TO PE-AUTH-AMT-MASK          07750000
077600                                        CA-LO-RFND-AUTH-AMT.      07760000
077700     MOVE PE-AUTH-AMT-MASK           TO LOWRFNDO.                 07770000
077800     MOVE RDCNTL-HGH-RFND-AUTH-AMT   TO PE-AUTH-AMT-MASK          07780000
077900                                        CA-HGH-RFND-AUTH-AMT.     07790000
078000     MOVE PE-AUTH-AMT-MASK           TO HGHRFNDO.                 07800000
078100                                                                  07810000
078200     MOVE RDCNTL-MAX-CSH-BCK-AMT     TO PE-AUTH-AMT-MASK          07820000
078300                                        CA-MAX-CSH-BCK-AMT.       07830000
078400     MOVE PE-AUTH-AMT-MASK           TO CSHBACKO.                 07840000
078500                                                                  07850000
078600     MOVE 1                          TO PA-SUB1                   07860000
078700                                        PA-SUB2                   07870000
078800                                        PA-SUB3.                  07880000
078900                                                                  07890000
079000     PERFORM 8700-OPEN-STORE-CSR.                                 07900000
079100                                                                  07910000
079200     MOVE ZERO TO PA-STORE-ACCUM.                                 07920000
079300                                                                  07930000
079400     INITIALIZE CA-STORES.                                        07940000
079500     PERFORM 2521-FETCH-STORE                                     07950000
079600       UNTIL SQLCODE = +100                                       07960000
079700          OR PA-STORE-ACCUM > PC-MAX-STORES.                      07970000
079800                                                                  07980000
079900     PERFORM 8800-CLOSE-STORE-CSR.                                07990000
080000     MOVE -1                         TO FUNCTL.                   08000000
080100******************************************************************08010000
080200*  FETCH THE NEXT STORE NUMBER BELONGING TO THE CURRENT          *08020000
080300*    STORE-GROUP NUMBER BEING DISPLAY.                           *08030000
080400******************************************************************08040000
080500 2521-FETCH-STORE.                                                08050000
080600                                                                  08060000
080700     PERFORM                                                      08070000
080800       VARYING PA-RETRY-COUNT FROM 1 BY 1                         08080000
080900         UNTIL PA-RETRY-COUNT > PC-MAX-RETRY                      08090000
081000                                                                  08100000
081100         EXEC SQL                                                 08110000
081200              FETCH STORE_CSR                                     08120000
081310               INTO :XST00001-LOC-NBR                             08131000
081400         END-EXEC                                                 08140000
081500                                                                  08150000
081600         EVALUATE TRUE                                            08160000
081700             WHEN SQLCODE = 0                                     08170000
081800                  ADD +1                      TO PA-STORE-ACCUM   08180000
081900                  MOVE PC-MORE-THAN-MAX-RETRY TO PA-RETRY-COUNT   08190000
082000             WHEN SQLCODE = +100                                  08200000
082100                  MOVE PC-MORE-THAN-MAX-RETRY TO PA-RETRY-COUNT   08210000
082200             WHEN SQLCODE = -904                                  08220000
082300             WHEN SQLCODE = -913                                  08230000
082400                  CONTINUE                                        08240000
082500             WHEN SQLCODE < 0                                     08250000
082600                  PERFORM 9000-SQL-ERROR                          08260000
082700             WHEN SQLCODE > 0                                     08270000
082800             WHEN SQLWARN0 = 'W'                                  08280000
082900                  PERFORM 9100-SQL-WARNING                        08290000
083000         END-EVALUATE                                             08300000
083100                                                                  08310000
083200     END-PERFORM.                                                 08320000
083300                                                                  08330000
083400     EVALUATE TRUE                                                08340000
083500         WHEN SQLCODE = 0                                         08350000
083600              PERFORM 2522-LOAD-STORES                            08360000
083700         WHEN SQLCODE = +100                                      08370000
083800              CONTINUE                                            08380000
083900         WHEN ANY                                                 08390000
084000              PERFORM 9000-SQL-ERROR                              08400000
084100     END-EVALUATE.                                                08410000
084200******************************************************************08420000
084300*  MOVE STORE NUMBER TO MAP.  THE MAP HAS 6 ROWS WITH 16 STORE   *08430000
084400*  NUMBERS EACH AND THE ARRAY IS USED HERE TO MOVE THE STORE     *08440000
084500*  NUMBER TO THE PROPER PLACE.                                   *08450000
084600*                                                                *08460000
084700*    PA-SUB1  =  ROW NUMBER    (THERE IS A MAX OF 6 ROWS)        *08470000
084800*    PA-SUB2  =  COLUMN NUMBER (THERE IS A MAX OF 13 COLUMNS)    *08480000
084900*    PA-SUB3  =  USED AS SUBSCRIPT IS A 1-DIMENSIONAL TABLE      *08490000
085000*                AT THE COMMUNICATION-AREA                       *08500000
085100*                                                                *08510000
085200*    ROW 1 (PA-SUB1), COLUMN 1  (PA-SUB2)  = 1  (PA-SUB3)        *08520000
085300*    ROW 1 (PA-SUB1), COLUMN 13 (PA-SUB2)  = 13 (PA-SUB3)        *08530000
085400*    ROW 2 (PA-SUB1), COLUMN 1  (PA-SUB2)  = 14 (PA-SUB3)        *08540000
085500*    ROW 2 (PA-SUB1), COLUMN 13 (PA-SUB2)  = 26 (PA-SUB3)        *08550000
085600*    ROW 3 (PA-SUB1), COLUMN 1  (PA-SUB2)  = 27 (PA-SUB3)        *08560000
085700*    ROW 3 (PA-SUB1), COLUMN 13 (PA-SUB2)  = 39 (PA-SUB3)        *08570000
085800*    AND SO ON AND SO FORTH                                      *08580000
085900******************************************************************08590000
086000 2522-LOAD-STORES.                                                08600000
086110     MOVE XST00001-LOC-NBR                                        08611000
086200       TO STRNBRI (PA-SUB1, PA-SUB2).                             08620000
086310     MOVE XST00001-LOC-NBR                                        08631000
086400       TO CA-ASSOCIATED-STORES (PA-SUB3).                         08640000
086500                                                                  08650000
086600     ADD 1                           TO PA-SUB2.                  08660000
086700     IF  PA-SUB2 > PC-STORE-COLUMNS                               08670000
086800         MOVE 1                      TO PA-SUB2                   08680000
086900         ADD 1                       TO PA-SUB1                   08690000
087000     END-IF.                                                      08700000
087100                                                                  08710000
087200     IF  PA-SUB1 > 1                                              08720000
087300         COMPUTE PA-SUB3 = ((PA-SUB1 - 1) * PC-STORE-COLUMNS)     08730000
087400                           + PA-SUB2                              08740000
087500     ELSE                                                         08750000
087600         COMPUTE PA-SUB3 = PA-SUB1 * PA-SUB2                      08760000
087700     END-IF.                                                      08770000
087800******************************************************************08780000
087900*  RECEIVE MAP AND EDIT THE FUNCTION CODE AND STORE-GROUP NMBR   *08790000
088000******************************************************************08800000
088100 8000-RECEIVE-MAP.                                                08810000
088200                                                                  08820000
088300     SET PS-NO-ERROR                 TO TRUE.                     08830000
088400                                                                  08840000
088500     EXEC CICS RECEIVE                                            08850000
088600               MAP('RD005A')                                      08860000
088700               MAPSET('RDKM005')                                  08870000
088800               RESP(PV-RESP)                                      08880000
088900     END-EXEC.                                                    08890000
089000                                                                  08900000
089100***                                                               08910000
089200***  DETERMINE IF FUNCTION-CODE IS ENTERED                        08920000
089300***                                                               08930000
089400     EVALUATE TRUE                                                08940000
089500         WHEN PV-RESP NOT = DFHRESP(NORMAL)                       08950000
089600              SET PS-ERROR           TO TRUE                      08960000
089700              SET PM-INDX            TO 6                         08970000
089800         WHEN FUNCTL > 0                                          08980000
089900              MOVE FUNCTI            TO PV-FUNCTION               08990000
090000                                        CA-FUNCTION               09000000
090100              IF  PV-VALID-FUNCTION                               09010000
090200                  CONTINUE                                        09020000
090300              ELSE                                                09030000
090400                  SET PM-INDX        TO 2                         09040000
090500                  SET PS-ERROR       TO TRUE                      09050000
090600                  MOVE DP015-RED     TO FUNCTC                    09060000
090700                  MOVE DP015-REVERSE TO FUNCTH                    09070000
090800                  MOVE -1            TO FUNCTL                    09080000
090900              END-IF                                              09090000
091000         WHEN FUNCTA = PC-EOF-KEYED                               09100000
091100              SET PM-INDX            TO 2                         09110000
091200              SET PS-ERROR           TO TRUE                      09120000
091300              MOVE DP015-RED         TO FUNCTC                    09130000
091400              MOVE DP015-REVERSE     TO FUNCTH                    09140000
091500              MOVE -1                TO FUNCTL                    09150000
091600              MOVE SPACES            TO CA-FUNCTION               09160000
091700     END-EVALUATE.                                                09170000
091800                                                                  09180000
091900***                                                               09190000
092000***  DETERMINE IF STORE-GROUP NUMBER IS ENTERED                   09200000
092100***                                                               09210000
092200     EVALUATE TRUE                                                09220000
092300         WHEN STRGRPL = 0                                         09230000
092400              IF  CA-STORE-GROUP-NMBR NOT NUMERIC                 09240000
092500                  MOVE ZERO          TO CA-STORE-GROUP-NMBR       09250000
092600              END-IF                                              09260000
092700         WHEN STRGRPL > 0                                         09270000
092800              PERFORM 8010-EDIT-STORE-GROUP                       09280000
092900         WHEN STRGRPA = PC-EOF-KEYED                              09290000
093000              SET PM-INDX            TO 9                         09300000
093100              SET PS-ERROR           TO TRUE                      09310000
093200              MOVE DP015-RED         TO STRGRPC                   09320000
093300              MOVE DP015-REVERSE     TO STRGRPH                   09330000
093400              MOVE -1                TO STRGRPL                   09340000
093500              MOVE ZERO              TO CA-STORE-GROUP-NMBR       09350000
093600                                        PE-STORE-GROUP-MASK       09360000
093700              MOVE PE-STORE-GROUP-MASK                            09370000
093800                                     TO STRGRPO                   09380000
093900     END-EVALUATE.                                                09390000
094000******************************************************************09400000
094100*    EDIT THE STORE-GROUP NUMBER                                  09410000
094200******************************************************************09420000
094300 8010-EDIT-STORE-GROUP.                                           09430000
094400                                                                  09440000
094500     MOVE STRGRPI                    TO DP010I-UNEDITED-FIELD.    09450000
094600     MOVE 2                          TO DP010I-MAXIMUM-DIGITS.    09460000
094700     MOVE 0                          TO DP010I-MAXIMUM-DECIMALS.  09470000
094800     SET DP010I-NEGATIVE-NOT-ALLOWED TO TRUE.                     09480000
094910     CALL DP010I-NUMERIC-EDIT-ROUTINE                             09491000
094920                         USING DP010I-NUMERIC-EDIT-AREA           09492000
095000                                                                  09500000
095100     IF  DP010I-ERROR-DETECTED                                    09510000
095200         SET PM-INDX                 TO 9                         09520000
095300         SET PS-ERROR                TO TRUE                      09530000
095400         MOVE DP015-RED              TO STRGRPC                   09540000
095500         MOVE DP015-REVERSE          TO STRGRPH                   09550000
095600         MOVE -1                     TO STRGRPL                   09560000
095700         MOVE STRGRPI                TO CA-STORE-GROUP-NMBR-X     09570000
095800     ELSE                                                         09580000
095900         MOVE DP010I-NUMERIC-FIELD   TO CA-STORE-GROUP-NMBR       09590000
096000     END-IF.                                                      09600000
096100******************************************************************09610000
096200*    DISPLAY ENTIRE MAP                                           09620000
096300******************************************************************09630000
096400 8100-SEND-MAP.                                                   09640000
096500                                                                  09650000
096600     IF  PS-ERROR                                                 09660000
096700         MOVE DP015-RED              TO AMSGC                     09670000
096800     END-IF.                                                      09680000
096900                                                                  09690000
097000     MOVE PM-PGM-MSG (PM-INDX)       TO AMSGO.                    09700000
097100     PERFORM 8300-UPDATE-SCREEN-HEADER.                           09710000
097200                                                                  09720000
097300     EXEC CICS SEND                                               09730000
097400               MAP('RD005A')                                      09740000
097500               MAPSET('RDKM005')                                  09750000
097600               ERASE                                              09760000
097700               CURSOR                                             09770000
097800               FORMFEED                                           09780000
097900               FREEKB                                             09790000
098000     END-EXEC.                                                    09800000
098100                                                                  09810000
098200******************************************************************09820000
098300*    SEND DATA PORTION OF THE MAP THAT HAS BEEN CHANGED.  PREVIOUS09830000
098400*    MAP THAT WAS DISPLAY IS STILL THERE.                         09840000
098500******************************************************************09850000
098600 8200-SEND-DATA-ONLY.                                             09860000
098700                                                                  09870000
098800     IF  PS-ERROR                                                 09880000
098900         MOVE DP015-RED              TO AMSGC                     09890000
099000     END-IF.                                                      09900000
099100                                                                  09910000
099200     MOVE PM-PGM-MSG (PM-INDX)       TO AMSGO.                    09920000
099300     PERFORM 8300-UPDATE-SCREEN-HEADER.                           09930000
099400                                                                  09940000
099500     EXEC CICS SEND                                               09950000
099600               MAP('RD005A')                                      09960000
099700               MAPSET('RDKM005')                                  09970000
099800               CURSOR                                             09980000
099900               FORMFEED                                           09990000
100000               FREEKB                                             10000000
100100     END-EXEC.                                                    10010000
100200******************************************************************10020000
100300*    FILL IN THE SCREEN HEADER WITH THE DATA, TIME, AND TERMINAL  10030000
100400*    NUMBER.                                                      10040000
100500******************************************************************10050000
100600 8300-UPDATE-SCREEN-HEADER.                                       10060000
100700                                                                  10070000
100800     EXEC CICS ASKTIME                                            10080000
100900               ABSTIME(ST-ABSTIME)                                10090000
101000     END-EXEC.                                                    10100000
101100                                                                  10110000
101200     EXEC CICS FORMATTIME                                         10120000
101300               ABSTIME(ST-ABSTIME)                                10130000
101400               MMDDYY(ADATEO)                                     10140000
101500               DATESEP                                            10150000
101600               TIME(ST-TIME-EDIT)                                 10160000
101700               TIMESEP                                            10170000
101800     END-EXEC.                                                    10180000
101900                                                                  10190000
102000     MOVE ST-TIME-HHMM               TO ATIMEO.                   10200000
102100     MOVE 'Z'                        TO ATIMEA.                   10210000
102200     MOVE 'Z'                        TO ADATEA.                   10220000
102300     MOVE EIBTRMID                   TO ATERMO.                   10230000
102400******************************************************************10240000
102500*    GET CASH REFUND AUTHORIZATION CONTROL PARAMETERS USING       10250000
102600*    STORE GROUP ENTERED                                          10260000
102700******************************************************************10270000
102800 8400-GET-REFUND-AUTH.                                            10280000
102900                                                                  10290000
103000     PERFORM                                                      10300000
103100       VARYING PA-RETRY-COUNT FROM 1 BY 1                         10310000
103200         UNTIL PA-RETRY-COUNT > PC-MAX-RETRY                      10320000
103300                                                                  10330000
103400         EXEC SQL                                                 10340000
103500              SELECT AUTH_GP_NBR,                                 10350000
103600                     AUTH_GP_DESC,                                10360000
103700                     ACTVY_PER_DAY_NBR,                           10370000
103800                     MAX_RET_PER_NBR,                             10380000
103900                     MAX_DOL_RT_PER_AMT,                          10390000
104000                     MAX_STR_DAY_NBR,                             10400000
104100                     MAX_RET_DAY_NBR,                             10410000
104200                     MAX_DOL_RT_DAY_AMT,                          10420000
104300                     LO_RFND_AUTH_AMT,                            10430000
104400                     HGH_RFND_AUTH_AMT,                           10440000
104500                     MAX_CSH_BCK_AMT                              10450000
104600                INTO :RDCNTL-AUTH-GP-NBR,                         10460000
104700                     :RDCNTL-AUTH-GP-DESC,                        10470000
104800                     :RDCNTL-ACTVY-PER-DAY-NBR,                   10480000
104900                     :RDCNTL-MAX-RET-PER-NBR,                     10490000
105000                     :RDCNTL-MAX-DOL-RT-PER-AMT,                  10500000
105100                     :RDCNTL-MAX-STR-DAY-NBR,                     10510000
105200                     :RDCNTL-MAX-RET-DAY-NBR,                     10520000
105300                     :RDCNTL-MAX-DOL-RT-DAY-AMT,                  10530000
105400                     :RDCNTL-LO-RFND-AUTH-AMT,                    10540000
105500                     :RDCNTL-HGH-RFND-AUTH-AMT,                   10550000
105600                     :RDCNTL-MAX-CSH-BCK-AMT                      10560000
105700                FROM TRDCNTL                                      10570000
105800               WHERE AUTH_GP_NBR = :CA-STORE-GROUP-NMBR           10580000
105900         END-EXEC                                                 10590000
106000                                                                  10600000
106100         EVALUATE TRUE                                            10610000
106200             WHEN SQLCODE = 0                                     10620000
106300                  MOVE PC-MORE-THAN-MAX-RETRY                     10630000
106400                                     TO PA-RETRY-COUNT            10640000
106500             WHEN SQLCODE = -904                                  10650000
106600             WHEN SQLCODE = -913                                  10660000
106700                  CONTINUE                                        10670000
106800             WHEN SQLCODE < 0                                     10680000
106900                  PERFORM 9000-SQL-ERROR                          10690000
107000             WHEN SQLCODE = +100                                  10700000
107100                  SET PM-INDX        TO 4                         10710000
107200                  SET PS-ERROR       TO TRUE                      10720000
107300                  MOVE DP015-RED     TO STRGRPC                   10730000
107400                  MOVE DP015-REVERSE TO STRGRPH                   10740000
107500                  MOVE -1            TO STRGRPL                   10750000
107600                  MOVE PC-MORE-THAN-MAX-RETRY                     10760000
107700                                     TO PA-RETRY-COUNT            10770000
107800             WHEN SQLCODE > 0                                     10780000
107900             WHEN SQLWARN0 = 'W'                                  10790000
108000                  PERFORM 9100-SQL-WARNING                        10800000
108100         END-EVALUATE                                             10810000
108200                                                                  10820000
108300     END-PERFORM.                                                 10830000
108400                                                                  10840000
108500     IF  SQLCODE = 0                                              10850000
108600      OR SQLCODE = +100                                           10860000
108700         CONTINUE                                                 10870000
108800     ELSE                                                         10880000
108900         PERFORM 9000-SQL-ERROR                                   10890000
109000     END-IF.                                                      10900000
109100                                                                  10910000
109200******************************************************************10920000
109300*    OPEN CURSOR TO GET NEXT STORE GROUP                          10930000
109400******************************************************************10940000
109500 8500-OPEN-REFUND-CURSOR.                                         10950000
109600                                                                  10960000
109700     PERFORM                                                      10970000
109800       VARYING PA-RETRY-COUNT FROM 1 BY 1                         10980000
109900         UNTIL PA-RETRY-COUNT > PC-MAX-RETRY                      10990000
110000                                                                  11000000
110100         EXEC SQL                                                 11010000
110200              OPEN REFUND_CSR                                     11020000
110300         END-EXEC                                                 11030000
110400                                                                  11040000
110500         EVALUATE TRUE                                            11050000
110600             WHEN SQLCODE = 0                                     11060000
110700                  MOVE PC-MORE-THAN-MAX-RETRY                     11070000
110800                                     TO PA-RETRY-COUNT            11080000
110900             WHEN SQLCODE = -904                                  11090000
111000             WHEN SQLCODE = -913                                  11100000
111100                  CONTINUE                                        11110000
111200             WHEN SQLCODE < 0                                     11120000
111300                  PERFORM 9000-SQL-ERROR                          11130000
111400             WHEN SQLCODE > 0                                     11140000
111500             WHEN SQLWARN0 = 'W'                                  11150000
111600                  PERFORM 9100-SQL-WARNING                        11160000
111700         END-EVALUATE                                             11170000
111800                                                                  11180000
111900     END-PERFORM.                                                 11190000
112000                                                                  11200000
112100     IF  SQLCODE = 0                                              11210000
112200         CONTINUE                                                 11220000
112300     ELSE                                                         11230000
112400         PERFORM 9000-SQL-ERROR                                   11240000
112500     END-IF.                                                      11250000
112600                                                                  11260000
112700******************************************************************11270000
112800*    CLOSE CURSOR TO GET NEXT STORE GROUP                         11280000
112900******************************************************************11290000
113000 8600-CLOSE-REFUND-CURSOR.                                        11300000
113100                                                                  11310000
113200     PERFORM                                                      11320000
113300       VARYING PA-RETRY-COUNT FROM 1 BY 1                         11330000
113400         UNTIL PA-RETRY-COUNT > PC-MAX-RETRY                      11340000
113500                                                                  11350000
113600         EXEC SQL                                                 11360000
113700              CLOSE REFUND_CSR                                    11370000
113800         END-EXEC                                                 11380000
113900                                                                  11390000
114000         EVALUATE TRUE                                            11400000
114100             WHEN SQLCODE = 0                                     11410000
114200                  MOVE PC-MORE-THAN-MAX-RETRY                     11420000
114300                                     TO PA-RETRY-COUNT            11430000
114400             WHEN SQLCODE = -904                                  11440000
114500             WHEN SQLCODE = -913                                  11450000
114600                  CONTINUE                                        11460000
114700             WHEN SQLCODE < 0                                     11470000
114800                  PERFORM 9000-SQL-ERROR                          11480000
114900             WHEN SQLCODE > 0                                     11490000
115000             WHEN SQLWARN0 = 'W'                                  11500000
115100                  PERFORM 9100-SQL-WARNING                        11510000
115200         END-EVALUATE                                             11520000
115300                                                                  11530000
115400     END-PERFORM.                                                 11540000
115500                                                                  11550000
115600     IF  SQLCODE = 0                                              11560000
115700         CONTINUE                                                 11570000
115800     ELSE                                                         11580000
115900         PERFORM 9000-SQL-ERROR                                   11590000
116000     END-IF.                                                      11600000
116100                                                                  11610000
116200******************************************************************11620000
116300*    OPEN CURSOR TO GET STORES ASSIGNED TO STORE GROUP            11630000
116400******************************************************************11640000
116500 8700-OPEN-STORE-CSR.                                             11650000
116600                                                                  11660000
116700     PERFORM                                                      11670000
116800       VARYING PA-RETRY-COUNT FROM 1 BY 1                         11680000
116900         UNTIL PA-RETRY-COUNT > PC-MAX-RETRY                      11690000
117000                                                                  11700000
117100         EXEC SQL                                                 11710000
117200              OPEN STORE_CSR                                      11720000
117300         END-EXEC                                                 11730000
117400                                                                  11740000
117500         EVALUATE TRUE                                            11750000
117600             WHEN SQLCODE = 0                                     11760000
117700                  MOVE PC-MORE-THAN-MAX-RETRY                     11770000
117800                                     TO PA-RETRY-COUNT            11780000
117900             WHEN SQLCODE = -904                                  11790000
118000             WHEN SQLCODE = -913                                  11800000
118100                  CONTINUE                                        11810000
118200             WHEN SQLCODE < 0                                     11820000
118300                  PERFORM 9000-SQL-ERROR                          11830000
118400             WHEN SQLCODE > 0                                     11840000
118500             WHEN SQLWARN0 = 'W'                                  11850000
118600                  PERFORM 9100-SQL-WARNING                        11860000
118700         END-EVALUATE                                             11870000
118800                                                                  11880000
118900     END-PERFORM.                                                 11890000
119000                                                                  11900000
119100     IF  SQLCODE = 0                                              11910000
119200         CONTINUE                                                 11920000
119300     ELSE                                                         11930000
119400         PERFORM 9000-SQL-ERROR                                   11940000
119500     END-IF.                                                      11950000
119600                                                                  11960000
119700******************************************************************11970000
119800*    CLOSE CURSOR TO GET STORES ASSIGNED TO STORE GROUP           11980000
119900******************************************************************11990000
120000 8800-CLOSE-STORE-CSR.                                            12000000
120100                                                                  12010000
120200     PERFORM                                                      12020000
120300       VARYING PA-RETRY-COUNT FROM 1 BY 1                         12030000
120400         UNTIL PA-RETRY-COUNT > PC-MAX-RETRY                      12040000
120500                                                                  12050000
120600         EXEC SQL                                                 12060000
120700              CLOSE STORE_CSR                                     12070000
120800         END-EXEC                                                 12080000
120900                                                                  12090000
121000         EVALUATE TRUE                                            12100000
121100             WHEN SQLCODE = 0                                     12110000
121200                  MOVE PC-MORE-THAN-MAX-RETRY                     12120000
121300                                     TO PA-RETRY-COUNT            12130000
121400             WHEN SQLCODE = -904                                  12140000
121500             WHEN SQLCODE = -913                                  12150000
121600                  CONTINUE                                        12160000
121700             WHEN SQLCODE < 0                                     12170000
121800                  PERFORM 9000-SQL-ERROR                          12180000
121900             WHEN SQLCODE > 0                                     12190000
122000             WHEN SQLWARN0 = 'W'                                  12200000
122100                  PERFORM 9100-SQL-WARNING                        12210000
122200         END-EVALUATE                                             12220000
122300                                                                  12230000
122400     END-PERFORM.                                                 12240000
122500                                                                  12250000
122600     IF  SQLCODE = 0                                              12260000
122700         CONTINUE                                                 12270000
122800     ELSE                                                         12280000
122900         PERFORM 9000-SQL-ERROR                                   12290000
123000     END-IF.                                                      12300000
123100                                                                  12310000
123200******************************************************************12320000
123300*    GET CASH REFUND AUTHORIZATION CONTROL PARAMETERS FOR THE     12330000
123400*    NEXT STORE GROUP                                             12340000
123500******************************************************************12350000
123600 8900-FETCH-REFUND-CSR.                                           12360000
123700                                                                  12370000
123800     PERFORM                                                      12380000
123900       VARYING PA-RETRY-COUNT FROM 1 BY 1                         12390000
124000         UNTIL PA-RETRY-COUNT > PC-MAX-RETRY                      12400000
124100                                                                  12410000
124200         EXEC SQL                                                 12420000
124300              FETCH REFUND_CSR                                    12430000
124400               INTO :RDCNTL-AUTH-GP-NBR,                          12440000
124500                    :RDCNTL-AUTH-GP-DESC,                         12450000
124600                    :RDCNTL-ACTVY-PER-DAY-NBR,                    12460000
124700                    :RDCNTL-MAX-RET-PER-NBR,                      12470000
124800                    :RDCNTL-MAX-DOL-RT-PER-AMT,                   12480000
124900                    :RDCNTL-MAX-STR-DAY-NBR,                      12490000
125000                    :RDCNTL-MAX-RET-DAY-NBR,                      12500000
125100                    :RDCNTL-MAX-DOL-RT-DAY-AMT,                   12510000
125200                    :RDCNTL-LO-RFND-AUTH-AMT,                     12520000
125300                    :RDCNTL-HGH-RFND-AUTH-AMT,                    12530000
125400                    :RDCNTL-MAX-CSH-BCK-AMT                       12540000
125500         END-EXEC                                                 12550000
125600                                                                  12560000
125700         EVALUATE TRUE                                            12570000
125800             WHEN SQLCODE = 0                                     12580000
125900                  MOVE PC-MORE-THAN-MAX-RETRY                     12590000
126000                                     TO PA-RETRY-COUNT            12600000
126100             WHEN SQLCODE = -904                                  12610000
126200             WHEN SQLCODE = -913                                  12620000
126300                  CONTINUE                                        12630000
126400             WHEN SQLCODE < 0                                     12640000
126500                  PERFORM 9000-SQL-ERROR                          12650000
126600             WHEN SQLCODE = +100                                  12660000
126700                  SET PM-INDX        TO 5                         12670000
126800                  SET PS-ERROR       TO TRUE                      12680000
126900                  MOVE -1            TO FUNCTL                    12690000
127000                  MOVE PC-MORE-THAN-MAX-RETRY                     12700000
127100                                     TO PA-RETRY-COUNT            12710000
127200             WHEN SQLCODE > 0                                     12720000
127300             WHEN SQLWARN0 = 'W'                                  12730000
127400                  PERFORM 9100-SQL-WARNING                        12740000
127500         END-EVALUATE                                             12750000
127600                                                                  12760000
127700     END-PERFORM.                                                 12770000
127800                                                                  12780000
127900     IF  SQLCODE = 0                                              12790000
128000      OR SQLCODE = +100                                           12800000
128100         CONTINUE                                                 12810000
128200     ELSE                                                         12820000
128300         PERFORM 9000-SQL-ERROR                                   12830000
128400     END-IF.                                                      12840000
128500******************************************************************12850000
128600*    DB2 SQL WARNING AND SQL ERROR PARAGRAPHS                     12860000
128700*    -911 IS NOT EVALUATED BECAUSE IT IS NOT POSSIBLE.  IT IS     12870000
128800*         EITHER A -913 OR -911 DEPENDING ON HOW DB2 WAS          12880000
128900*         INITIALLY INSTALLED.  AT KOHLS -911 DOES NOT APPLY      12890000
129000*         TO CICS PROGRAMS.                                       12900000
129100******************************************************************12910000
129200 9000-SQL-ERROR.                                                  12920000
129300                                                                  12930000
129400     EVALUATE SQLCODE                                             12940000
129500         WHEN -904                                                12950000
129600              MOVE DM-RESOURCE-UNAVAIL-MSG                        12960000
129700                                     TO DM-ERROR-MSG              12970000
129800         WHEN -913                                                12980000
129900              MOVE DM-DEADLOCK-TIMEOUT-MSG                        12990000
130000                                     TO DM-ERROR-MSG              13000000
130100         WHEN -922                                                13010000
130200              MOVE DM-NOT-AUTHORIZED-MSG                          13020000
130300                                     TO DM-ERROR-MSG              13030000
130400         WHEN -923                                                13040000
130500              MOVE DM-NOT-CONNECTED-MSG                           13050000
130600                                     TO DM-ERROR-MSG              13060000
130700         WHEN ANY                                                 13070000
130800              MOVE DM-OTHER-DB2-ERROR-MSG                         13080000
130900                                     TO DM-ERROR-MSG              13090000
131000     END-EVALUATE.                                                13100000
131100                                                                  13110000
131200     MOVE SQLCODE                    TO DM-SQLCODE.               13120000
131300     MOVE SQLERRD (3)                TO DM-ROWS-ERR-PROCESSED.    13130000
131400     MOVE SQLERRML                   TO DM-SQLERRML.              13140000
131500     MOVE SQLERRMC                   TO DM-SQLERRMC.              13150000
131600                                                                  13160000
131700     EXEC CICS SYNCPOINT                                          13170000
131800     END-EXEC.                                                    13180000
131900                                                                  13190000
132000     EXEC CICS SEND                                               13200000
132100               FROM(DM-DB2-ERROR-MSG)                             13210000
132200               LENGTH(PC-DB2-ERROR-LENGTH)                        13220000
132300               ERASE                                              13230000
132400     END-EXEC.                                                    13240000
132500                                                                  13250000
132600     EXEC CICS RETURN                                             13260000
132700     END-EXEC.                                                    13270000
132800                                                                  13280000
132900                                                                  13290000
133000******************************************************************13300000
133100*  EXIT THE CHECK AUTH SYSTEM, DISPLAYING A FORMATTED DB2        *13310000
133200*  WARNING MESSAGE.                                              *13320000
133300******************************************************************13330000
133400 9100-SQL-WARNING.                                                13340000
133500                                                                  13350000
133600     MOVE SQLCODE                    TO DM-SQLCODE1.              13360000
133700     MOVE SQLWARN                    TO DM-SQLWARN.               13370000
133800     MOVE SQLERRD (3)                TO DM-ROWS-WRN-PROCESSED.    13380000
133900                                                                  13390000
134000     EXEC CICS SYNCPOINT                                          13400000
134100     END-EXEC.                                                    13410000
134200                                                                  13420000
134300     EXEC CICS SEND                                               13430000
134400               FROM(DM-DB2-WARNING-MSG)                           13440000
134500               LENGTH(PC-DB2-WARNING-LENGTH)                      13450000
134600               ERASE                                              13460000
134700     END-EXEC.                                                    13470000
134800                                                                  13480000
134900     EXEC CICS RETURN                                             13490000
135000     END-EXEC.                                                    13500000
135100******************************************************************13510000
135200*   EXIT THE CASH REFUND SYSTEM AND RETURN TO THE MAIN MENU      *13520000
135300******************************************************************13530000
135400 9200-RETURN-TO-MAIN-MENU.                                        13540000
135500                                                                  13550000
135600     EXEC CICS SYNCPOINT                                          13560000
135700     END-EXEC.                                                    13570000
135800                                                                  13580000
135900     EXEC CICS START                                              13590000
136000               TRANSID ('MENU')                                   13600000
136100               TERMID  (EIBTRMID)                                 13610000
136200     END-EXEC.                                                    13620000
136300                                                                  13630000
136400     EXEC CICS RETURN                                             13640000
136500     END-EXEC.                                                    13650000
136600******************************************************************13660000
136700*   EXIT THE PROGRAM AND RETURN TO THE CASH REFUND SYSTEM MENU   *13670000
136800******************************************************************13680000
136900 9300-RETURN-TO-SYSTEM-MENU.                                      13690000
137000                                                                  13700000
137100     EXEC CICS SYNCPOINT                                          13710000
137200     END-EXEC.                                                    13720000
137300                                                                  13730000
137400     EXEC CICS XCTL                                               13740000
137500               PROGRAM('RDKCS000')                                13750000
137600               RESP(PV-RESP)                                      13760000
137700     END-EXEC.                                                    13770000
137800                                                                  13780000
137900     IF  PV-RESP NOT = DFHRESP(NORMAL)                            13790000
138000         PERFORM 9800-ID-ERROR                                    13800000
138100     END-IF.                                                      13810000
138200******************************************************************13820000
138300*  EXIT THE CHECK AUTH SYSTEM, AND TRANSFER TO THE MAINTENANCE   *13830000
138400*  PROGRAM IF USER HAS THE ACCESS AUTHORITY, ELSE A MESSAGE      *13840000
138500*  IS DISPLAYED.                                                 *13850000
138600******************************************************************13860000
138700 9400-XCTL-MAINT-PROGRAM.                                         13870000
138800                                                                  13880000
138900     EXEC CICS SYNCPOINT                                          13890000
139000     END-EXEC.                                                    13900000
139100                                                                  13910000
139200     MOVE PC-THIS-PROGRAM            TO RD000I-LAST-PROGRAM.      13920000
139300                                                                  13930000
139400     SET PS-NO-ACCESS                TO TRUE.                     13940000
139500     PERFORM 9410-CHECK-RACF.                                     13950000
139600     IF  PS-ACCESS                                                13960000
139700         SET RD000I-INITIALIZE-SCREEN                             13970000
139800                                     TO TRUE                      13980000
139900         EXEC CICS XCTL                                           13990000
140000                   PROGRAM('RDKCS009')                            14000000
140100                   COMMAREA(RD000I-COMMUNICATION-AREA)            14010000
140200                   LENGTH(PC-COMMAREA-LENGTH)                     14020000
140300         END-EXEC                                                 14030000
140400     ELSE                                                         14040000
140500         SET PS-ERROR                TO TRUE                      14050000
140600     END-IF.                                                      14060000
140700                                                                  14070000
140800                                                                  14080000
140900     IF  PV-RESP NOT = DFHRESP(NORMAL)                            14090000
141000         PERFORM 9800-ID-ERROR                                    14100000
141100     END-IF.                                                      14110000
141200                                                                  14120000
141300                                                                  14130000
141400******************************************************************14140000
141500*  CHECK ACCESSS AUTHORITY OF USER                               *14150000
141600******************************************************************14160000
141700 9410-CHECK-RACF.                                                 14170000
141800                                                                  14180000
141900     SET DP008-RSRC-TYPE-TRAN        TO TRUE.                     14190000
142000     SET DP008-ACCESS-TYPE-USE       TO TRUE.                     14200000
142100     MOVE PC-U005                    TO DP008-RESOURCE-NAME.      14210000
142200                                                                  14220000
142300     EXEC CICS                                                    14230000
142400          LINK PROGRAM  (DP008-SECURITY-SUBROUTINE)               14240000
142500               COMMAREA (DP008-SECURITY-COMMAREA)                 14250000
142600               LENGTH   (DP008-SECURITY-COMMAREA-LENGTH)          14260000
142700               RESP     (PV-CICS-RESPONSE)                        14270000
142800     END-EXEC.                                                    14280000
142900                                                                  14290000
143000     IF  PV-CICS-RESPONSE = DFHRESP(NORMAL)                       14300000
143100         IF  DP008-CALL-SUCCESSFUL                                14310000
143200             IF  DP008-ACCESS-ALLOWED                             14320000
143300                 SET PS-ACCESS       TO TRUE                      14330000
143400             ELSE                                                 14340000
143500                 SET PM-INDX         TO 7                         14350000
143600             END-IF                                               14360000
143700         ELSE                                                     14370000
143800             SET PM-INDX             TO 1                         14380000
143900             MOVE DP008-ERROR-CODE   TO PM-CM-RETURN-CODE         14390000
144000             MOVE PM-CICSAUTH-MSG    TO PM-PGM-MSG (1)            14400000
144100         END-IF                                                   14410000
144200     ELSE                                                         14420000
144300         SET PM-INDX                 TO 10                        14430000
144400     END-IF.                                                      14440000
144500******************************************************************14450000
144600*  SEND FORMATED MESSAGE WHE TRANS-ID THIS PROGRAM IS            *14460000
144700*    X-CONTROLLING TO IS NOT DEFINED.  THEN EXIT TO CICS.        *14470000
144800******************************************************************14480000
144900 9800-ID-ERROR.                                                   14490000
145000                                                                  14500000
145100     SET PM-INDX                     TO 8.                        14510000
145200                                                                  14520000
145300     EXEC CICS SEND                                               14530000
145400               FROM(PM-PGM-MSG(PM-INDX))                          14540000
145500               LENGTH(PC-MSG-LENGTH)                              14550000
145600               ERASE                                              14560000
145700     END-EXEC.                                                    14570000
145800                                                                  14580000
145900     EXEC CICS RETURN                                             14590000
146000     END-EXEC.                                                    14600000
