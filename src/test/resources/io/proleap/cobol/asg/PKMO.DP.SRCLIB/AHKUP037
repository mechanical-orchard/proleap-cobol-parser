000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.         AHKUP037.                                    00020000
000300 AUTHOR.             NANCY EILBES.                                00030000
000400 DATE-WRITTEN.       APRIL 2000.                                  00040000
000500 DATE-COMPILED.                                                   00050000
000600*************************************************************     00060000
000700*    COBOL 2 WITH SQL                                       *     00070000
000800*                                                           *     00080000
000900*   AHKUP037 - ARCHIVE HISTORY DATA DELETION - TPURITM      *     00090000
001000*                                                           *     00100000
001100*   PROGRAM OVERVIEW:                                       *     00110000
001200*                                                           *     00120000
001300*  THIS PROGRAM DELETES "OLD" ROWS FROM DB2 TABLE TPURITM.  *     00130000
001400*  ROWS DELETED ARE THOSE PREVIOUSLY - IDENTIFIED/EXTRACTED *     00140000
001500*  WITHIN THE ARCHIVE/HISTORY SYSTEM.                       *     00150000
001600*                                                           *     00160000
001700*  THE EXTRACT FILE USED AS INPUT WILL BE SORTED BY THE     *     00170000
001800*  UNIQUE INDEX COLUMNS TO SPEED THE DELETION PROCESS.      *     00180000
001900*  THESE COLUMNS ARE PO_NBR, VER_NBR, PO_LNE_NBR.           *     00190000
002000*                                                           *     00200000
002100*   INPUT:                                                  *     00210000
002200*                                                           *     00220000
002300*     1. TPURITM DELETION FILE  COPYBOOK DCLTPURITM         *     00230000
002400*                                                           *     00240000
002500*   DB2 TABLES:                                             *     00250000
002600*                                                           *     00260000
002700*        TPURITM - PURCHASE ORDER ITEM TABLE                *     00270000
002800*        TCKRSTIN - CHECKPOINT/RESTART INFO TABLE           *     00280000
002900*        TCKRSTCN - CHECKPOINT/RESTART CONTROL TABLE        *     00290000
003000*                                                           *     00300000
003100*************************************************************     00310000
003200* DATE: 06/20/2002 CHANGE MADE BY: RYAN STAUFFACHER.        *     00320000
003300* CHANGE MADE: MODIFIED SIZE OF INPUT FILE TO INCLUDE RMS-  *     00330000
003400* SKU-XREF.                                                 *     00340000
003500*************************************************************     00350000
003600*************************************************************     00360000
003700* DATE: 04/28/2003 CHANGE MADE BY: CINDY HANSEN.            *     00370000
003800* CHANGE MADE: MODIFIED SIZE OF INPUT FILE TO INCLUDE RMS-  *     00380000
003900* SKU-XREF. (ABOVE CHANGE PUT LRECL TO 287.  IT S/B 291).   *     00390000
004000*************************************************************     00400000
004100* DATE: 01/12/2005 CHANGE MADE BY: SUE BARTELT.             *     00410000
004200* CHANGE MADE: MODIFIED SIZE OF INPUT FILE TO INCLUDE       *     00420000
004300* CNCLD-UNT-QTY CHANGED FROM 291 TO 295.                    *     00430000
004400*************************************************************     00440000
P5207 * DATE: 11/18/2013 CHANGE MADE BY: COGNIZANT(SHEBENA)       *     00440126
P5207 * CHANGE MADE: MODIFIED THE PROGRAM TO REMOVE THE           *     00440226
P5207 *              PO_IN_RMS_IND CHECK BEFORE DELETE.           *     00440326
P5207 * CHANGE TAG - P5207, CR NO - CHG0081355                    *     00440427
004600*************************************************************     00460000
004700 EJECT                                                            00470000
004800 ENVIRONMENT DIVISION.                                            00480000
004900 CONFIGURATION SECTION.                                           00490000
005000 SOURCE-COMPUTER.        IBM-370.                                 00500000
005100 OBJECT-COMPUTER.        IBM-370.                                 00510000
005200                                                                  00520000
005300 INPUT-OUTPUT SECTION.                                            00530000
005400 FILE-CONTROL.                                                    00540000
005500     SELECT TPURITM-EXTRACT-FILE ASSIGN TO INP01.                 00550000
005600                                                                  00560000
005700 DATA DIVISION.                                                   00570000
005800 FILE SECTION.                                                    00580000
005900 FD  TPURITM-EXTRACT-FILE                                         00590000
006000     RECORDING MODE IS F                                          00600000
006100     LABEL RECORDS ARE STANDARD                                   00610000
006200     BLOCK CONTAINS 0 RECORDS                                     00620000
006300     RECORD CONTAINS 295 CHARACTERS                               00630000
006400     DATA RECORD IS TPURITM-EXTRACT-DATA.                         00640000
006500 01  TPURITM-EXTRACT-DATA       PIC X(295).                       00650000
006600                                                                  00660000
006700                                                                  00670000
006800 EJECT                                                            00680000
006900 WORKING-STORAGE SECTION.                                         00690000
007000                                                                  00700000
007100 01  FILLER                       PIC X(58)     VALUE             00710000
007200     '************WORKING STORAGE STARTS HERE*******************'.00720000
007300                                                                  00730000
007400 01  PV-PROGRAM-VARIABLES.                                        00740000
007500     05  PV-PROGRAM-NAME          PIC  X(08)    VALUE 'AHKUP037'. 00750000
007600     05  PV-CKPT-STAT-CODE        PIC X(01)     VALUE SPACE.      00760000
007700     05  PV-CURRENT-PARAGRAPH     PIC X(50)     VALUE SPACES.     00770000
007800     05  PV-CURRENT-TMST          PIC X(26)     VALUE SPACES.     00780000
007900                                                                  00790000
008000     05  PV-TPURITM-INPUT-COUNT   PIC 9(09)     VALUE ZERO        00800000
008100                                                COMP-3.           00810000
008200     05  PV-TPURITM-DELETE-COUNT  PIC 9(09)     VALUE ZERO        00820000
008300                                                COMP-3.           00830000
008400     05  PV-SQL-DELETE-COUNT      PIC 9(09)     VALUE ZERO        00840000
008500                                                COMP-3.           00850000
008600     05  PV-SQLERRD3              PIC S9(09)    VALUE ZERO        00860000
008700                                                COMP-3.           00870000
008800     05  PV-DISP-PO-NBR           PIC X(09)    VALUE SPACES.      00880000
008900     05  PV-DISP-VER-NBR          PIC X(09)    VALUE SPACES.      00890000
009000     05  PV-DISP-LNE-NBR          PIC X(09)    VALUE SPACES.      00900000
009200     05  PV-SAVE-PO-NBR           PIC S9(09) COMP                 00920000
009300                                               VALUE ZEROES.      00930000
009400 01  PC-PROGRAM-CONSTANTS.                                        00940000
009500     05  PC-RETRY-MAX             PIC S9(04)    VALUE +3          00950000
009600                                                COMP SYNC.        00960000
009700     05  PC-RETRY-COUNT           PIC S9(04)    VALUE ZEROS.      00970000
009800     05  PC-IN-PROCESS-CODE       PIC X(01)     VALUE '9'.        00980000
009900     05  PC-RUN-COMPLETE-CODE     PIC X(01)     VALUE '0'.        00990000
010000                                                                  01000000
010100 01  PS-PROGRAM-SWITCHES.                                         01010000
010200     05  PS-COMMITS-TAKEN-SW      PIC  X(01)    VALUE 'N'.        01020000
010300         88  COMMITS-TAKEN                      VALUE 'T'.        01030000
010400         88  NO-COMMITS-TAKEN                   VALUE 'N'.        01040000
010500     05  PS-END-EXTRACT-SW        PIC  X(01)    VALUE 'M'.        01050000
010600         88  MORE-EXTRACT                       VALUE 'M'.        01060000
010700         88  END-OF-EXTRACT                     VALUE 'E'.        01070000
010800     05  PS-RUN-TYPE-SW           PIC  X(01)    VALUE ' '.        01080000
010900         88  NORMAL-RUN                         VALUE '0'.        01090000
011000         88  RESTART-RUN                        VALUE '9'.        01100000
011400                                                                  01140000
011500 01  WS-COUNTER.                                                  01150000
011600     05  WS-HOLD-TMST             PIC X(26)     VALUE SPACES.     01160000
011700     05  WS-TMST                  PIC X(26)     VALUE SPACES.     01170000
011800                                                                  01180000
011900 01  CKPT-RESTART-INFO.                                           01190000
012000     05  CR-EXTRACT-RECS-WORKED   PIC  9(9)     VALUE ZERO.       01200000
012100                                                                  01210000
012200*----------------------------------------------------------------*01220000
012300*  ABEND DATA AREAS                                              *01230000
012400*----------------------------------------------------------------*01240000
012500 01  ABEND-CODE                  PIC S9(04)  VALUE ZEROS          01250000
012600                                             COMP SYNC.           01260000
012700     88  AC-BAD-RECEIVE-DATA                 VALUE +4001.         01270000
012800     88  AC-BAD-DATA                         VALUE +4008.         01280000
012900     88  AC-DB2-ERROR                        VALUE +4013.         01290000
013000     88  AC-DATE-ERROR                       VALUE +4019.         01300000
013100                                                                  01310000
013200                                                                  01320000
013300 01  ABEND-AREAS.                                                 01330000
013400     05  AA-ABEND-LIT            PIC  X(40)  VALUE                01340000
013500             '*****       ABEND'.                                 01350000
013600     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                01360000
013700             '*****   PROGRAM: AHKUP037'.                         01370000
013800     05  AA-PARAGRAPH-LIT.                                        01380000
013900         10  FILLER              PIC  X(17)  VALUE                01390000
014000             '***** PARAGRAPH: '.                                 01400000
014100         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        01410000
014200     05  AA-MESSAGE-LINE-1.                                       01420000
014300         10  FILLER              PIC  X(06)  VALUE '*****'.       01430000
014400         10  AA-MESSAGE-1        PIC  X(127) VALUE SPACES.        01440000
014500     05  AA-MESSAGE-LINE-2.                                       01450000
014600         10  FILLER              PIC  X(06)  VALUE '*****'.       01460000
014700         10  AA-MESSAGE-2        PIC  X(127) VALUE SPACES.        01470000
014800     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                01480000
014900             '*****    DB2 ERROR'.                                01490000
015000     05  AA-DB2-OPERATION-LIT.                                    01500000
015100         10  FILLER              PIC  X(17)  VALUE                01510000
015200             '***** OPERATION: '.                                 01520000
015300         10  AA-DB2-OPERATION    PIC  X(50)  VALUE SPACES.        01530000
015400     05  AA-DB2-TABLE            PIC  X(08)  VALUE SPACES.        01540000
015500     EJECT                                                        01550000
015600                                                                  01560000
015700     COPY DPWS004.                                                01570000
015800     EJECT                                                        01580000
015900*----------------------------------------------------------------*01590000
016000*      TPURITM TABLE LAYOUT                                       01600000
016100*----------------------------------------------------------------*01610000
016200         EXEC SQL                                                 01620000
016300             INCLUDE TPURITM                                      01630000
016400         END-EXEC.                                                01640000
016500                                                                  01650000
016600*----------------------------------------------------------------*01660000
016700*      TPURCHS TABLE LAYOUT                                       01670000
016800*----------------------------------------------------------------*01680000
016900         EXEC SQL                                                 01690000
017000             INCLUDE TPURCHS                                      01700000
017100         END-EXEC.                                                01710000
017200                                                                  01720000
017300*----------------------------------------------------------------*01730000
017400*      TCKRSTCNTL TABLE LAYOUT                                    01740000
017500*----------------------------------------------------------------*01750000
017600         EXEC SQL                                                 01760000
017700             INCLUDE TCKRSTCN                                     01770000
017800         END-EXEC.                                                01780000
017900                                                                  01790000
018000*----------------------------------------------------------------*01800000
018100*      TCKRSTINF TABLE LAYOUT                                     01810000
018200*----------------------------------------------------------------*01820000
018300         EXEC SQL                                                 01830000
018400             INCLUDE TCKRSTIN                                     01840000
018500         END-EXEC.                                                01850000
018600 EJECT                                                            01860000
018700*----------------------------------------------------------------*01870000
018800*  DB2 COMMUNICATION AREA                                         01880000
018900*----------------------------------------------------------------*01890000
019000*                                                                 01900000
019100     EXEC SQL                                                     01910000
019200         INCLUDE SQLCA                                            01920000
019300     END-EXEC.                                                    01930000
019400                                                                  01940000
019500*----------------------------------------------------------------*01950000
019600*  DB2 COMMUNICATION AREA2                                        01960000
019700*----------------------------------------------------------------*01970000
019800*                                                                 01980000
019900     COPY SQLCA2.                                                 01990000
020000     EJECT                                                        02000000
020100 PROCEDURE DIVISION.                                              02010000
020200 A100-MAINLINE-ROUTINE.                                           02020000
020300                                                                  02030000
020400     PERFORM B100-INITIALIZATION.                                 02040000
020500                                                                  02050000
020600     PERFORM B200-TPURITM-EXTRACT-PROCESS                         02060000
020700       UNTIL END-OF-EXTRACT.                                      02070000
020800                                                                  02080000
020900     PERFORM B300-EOJ-PROCESSING.                                 02090000
021000                                                                  02100000
021100     GOBACK.                                                      02110000
021200 EJECT                                                            02120000
021300 B100-INITIALIZATION.                                             02130000
021400                                                                  02140000
021500     EXEC SQL                                                     02150000
021600         SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                 02160000
021700     END-EXEC.                                                    02170000
021800                                                                  02180000
021900     PERFORM X300-GET-CHECKPOINT-CNTL.                            02190000
022000     MOVE PV-CKPT-STAT-CODE TO PS-RUN-TYPE-SW.                    02200000
022100                                                                  02210000
022200     OPEN INPUT TPURITM-EXTRACT-FILE.                             02220000
022300                                                                  02230000
022400     IF RESTART-RUN                                               02240000
022500         PERFORM X200-CHECKPOINT-RESTART                          02250000
022600     ELSE                                                         02260000
022700         PERFORM R100-READ-EXTRACT-FILE                           02270000
022800     END-IF.                                                      02280000
022900                                                                  02290000
023000     PERFORM X500-SET-CHECKPOINT-TIME.                            02300000
023100                                                                  02310000
023200                                                                  02320000
023300     EJECT                                                        02330000
023400 B200-TPURITM-EXTRACT-PROCESS.                                    02340000
023500                                                                  02350000
023600     MOVE PURITM-PO-NBR             TO PV-DISP-PO-NBR.            02360000
023700     MOVE PURITM-VER-NBR            TO PV-DISP-VER-NBR.           02370000
023800     MOVE PURITM-PO-LNE-NBR         TO PV-DISP-LNE-NBR.           02380000
023900     IF PURITM-PO-NBR NOT = PV-SAVE-PO-NBR                        02390000
024000         MOVE PURITM-PO-NBR TO PV-SAVE-PO-NBR                     02400000
024200     END-IF.                                                      02420000
024300                                                                  02430000
024500     PERFORM D100-DELETE-TPURITM                                  02450025
024700                                                                  02470000
024800     PERFORM X100-CHECKPOINT-CHECK.                               02480000
024900                                                                  02490000
025000     PERFORM R100-READ-EXTRACT-FILE.                              02500000
025100     EJECT                                                        02510000
025200                                                                  02520000
025300                                                                  02530000
025400 B300-EOJ-PROCESSING.                                             02540000
025500                                                                  02550000
025600     DISPLAY '** AHKUP037 SUMMARY **'.                            02560000
025700     DISPLAY '** TPURITM INPUT COUNT = ' PV-TPURITM-INPUT-COUNT.  02570000
025800     DISPLAY '** TPURITM DELETE COUNT = ' PV-TPURITM-DELETE-COUNT.02580000
025900     DISPLAY '** SQL DELETE COUNT = ' PV-SQL-DELETE-COUNT.        02590000
026000                                                                  02600000
026100     CLOSE  TPURITM-EXTRACT-FILE.                                 02610000
026200                                                                  02620000
026300     MOVE PC-RUN-COMPLETE-CODE TO PV-CKPT-STAT-CODE.              02630000
026400     PERFORM X600-UPDATE-TCKRSTCNTL.                              02640000
026500                                                                  02650000
026600     EJECT                                                        02660000
033800                                                                  03380000
033900*----------------------------------------------------------------*03390000
034000*    DELETES FROM THE TPURITM TABLE.  CASCADE DELETE WILL ALSO   *03400000
034100*    CAUSE ROWS TO BE DELETED FROM TMIITEM, TVNDINV AND TEXINVC  *03410000
034200*    TABLES.                                                     *03420000
034300*----------------------------------------------------------------*03430000
034400 D100-DELETE-TPURITM.                                             03440000
034500                                                                  03450000
034600     MOVE 'D100-DELETE-TPURITM' TO PV-CURRENT-PARAGRAPH.          03460000
034700                                                                  03470000
034800     PERFORM WITH TEST AFTER                                      03480000
034900        VARYING PC-RETRY-COUNT FROM 1 BY 1                        03490000
035000          UNTIL PC-RETRY-COUNT > PC-RETRY-MAX                     03500000
035100             OR SQLCODE = ZERO                                    03510000
035200                                                                  03520000
035300         EXEC SQL                                                 03530000
035400              DELETE                                              03540000
035500                FROM TPURITM                                      03550000
035600               WHERE PO_NBR     = :PURITM-PO-NBR                  03560000
035700                 AND VER_NBR    = :PURITM-VER-NBR                 03570000
035800                 AND PO_LNE_NBR = :PURITM-PO-LNE-NBR              03580000
035900         END-EXEC                                                 03590000
036000                                                                  03600000
036100         EVALUATE TRUE                                            03610000
036200             WHEN SQLCODE = ZERO                                  03620000
036300                 ADD 1 TO PV-TPURITM-DELETE-COUNT                 03630000
036400                 MOVE SQLERRD(3) TO PV-SQLERRD3                   03640000
036500                 ADD PV-SQLERRD3 TO PV-SQL-DELETE-COUNT           03650000
036600                                                                  03660000
036700             WHEN SQLCODE = -904                                  03670000
036800             WHEN SQLCODE = -913                                  03680000
036900             WHEN SQLCODE = +100                                  03690000
037000                  CONTINUE                                        03700000
037100                                                                  03710000
037200             WHEN SQLWARN0 NOT = SPACES                           03720000
037300             WHEN SQLCODE  NOT = ZERO                             03730000
037400                 MOVE PV-CURRENT-PARAGRAPH                        03740000
037500                                     TO AA-PARAGRAPH-NAME         03750000
037600                 DISPLAY '******** PO NUMBER:'                    03760000
037700                          PV-DISP-PO-NBR                          03770000
037800                 DISPLAY '******** PO VER NBR:'                   03780000
037900                          PV-DISP-VER-NBR                         03790000
038000                 DISPLAY '******** PO LNE NBR:'                   03800000
038100                          PV-DISP-LNE-NBR                         03810000
038200                 MOVE SPACES TO AA-MESSAGE-1                      03820000
038300                                AA-MESSAGE-2                      03830000
038400                 MOVE 'UNSUCCESSFUL DELETE'                       03840000
038500                                     TO AA-DB2-OPERATION          03850000
038600                 MOVE 'TPURITM'      TO AA-DB2-TABLE              03860000
038700                 PERFORM Z999-DB2-ABEND                           03870000
038800         END-EVALUATE                                             03880000
038900     END-PERFORM.                                                 03890000
039000                                                                  03900000
039100     IF PC-RETRY-COUNT > PC-RETRY-MAX                             03910000
039200         MOVE PV-CURRENT-PARAGRAPH                                03920000
039300                             TO AA-PARAGRAPH-NAME                 03930000
039400         DISPLAY '******** PO NUMBER:'                            03940000
039500                          PV-DISP-PO-NBR                          03950000
039600         DISPLAY '******** PO VER NBR :'                          03960000
039700                          PV-DISP-VER-NBR                         03970000
039800         DISPLAY '******** PO LNE NBR :'                          03980000
039900                          PV-DISP-LNE-NBR                         03990000
040000         MOVE SPACES TO AA-MESSAGE-1                              04000000
040100                        AA-MESSAGE-2                              04010000
040200         MOVE 'MAX RETRIES EXCEEDED ON DELETE'                    04020000
040300                             TO AA-DB2-OPERATION                  04030000
040400         MOVE 'TPURITM'      TO AA-DB2-TABLE                      04040000
040500         PERFORM Z999-DB2-ABEND                                   04050000
040600     END-IF.                                                      04060000
040700                                                                  04070000
040800     EJECT                                                        04080000
040900 R100-READ-EXTRACT-FILE.                                          04090000
041000                                                                  04100000
041100     READ TPURITM-EXTRACT-FILE                                    04110000
041200          INTO DCLTPURITM                                         04120000
041300          AT END SET END-OF-EXTRACT TO TRUE.                      04130000
041400                                                                  04140000
041500     IF MORE-EXTRACT                                              04150000
041600         ADD 1 TO PV-TPURITM-INPUT-COUNT                          04160000
041700     END-IF.                                                      04170000
041800                                                                  04180000
041900                                                                  04190000
042000     EJECT                                                        04200000
042100*----------------------------------------------------------------*04210000
042200*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *04220000
042300*----------------------------------------------------------------*04230000
042400 X100-CHECKPOINT-CHECK.                                           04240000
042500                                                                  04250000
042600     MOVE 'X100-CHECKPOINT-CHECK' TO PV-CURRENT-PARAGRAPH.        04260000
042700                                                                  04270000
042800     EXEC SQL                                                     04280000
042900       SET :WS-TMST = CURRENT TIMESTAMP                           04290000
043000     END-EXEC.                                                    04300000
043100                                                                  04310000
043200     IF SQLCODE = +0                                              04320000
043300         CONTINUE                                                 04330000
043400     ELSE                                                         04340000
043500         MOVE PV-CURRENT-PARAGRAPH                                04350000
043600                             TO AA-PARAGRAPH-NAME                 04360000
043700         MOVE SPACES TO AA-MESSAGE-1                              04370000
043800                        AA-MESSAGE-2                              04380000
043900         MOVE 'BAD SET COMMAND'                                   04390000
044000                             TO AA-DB2-OPERATION                  04400000
044100         MOVE SPACES             TO AA-DB2-TABLE                  04410000
044200         PERFORM Z999-DB2-ABEND                                   04420000
044300     END-IF.                                                      04430000
044400                                                                  04440000
044500     IF WS-TMST > WS-HOLD-TMST                                    04450000
044600         IF NO-COMMITS-TAKEN                                      04460000
044700             MOVE PC-IN-PROCESS-CODE TO PV-CKPT-STAT-CODE         04470000
044800             PERFORM X600-UPDATE-TCKRSTCNTL                       04480000
044900             SET COMMITS-TAKEN TO TRUE                            04490000
045000         END-IF                                                   04500000
045100         PERFORM X700-UPDATE-TCKRSTINF                            04510000
045200         PERFORM Y100-COMMIT                                      04520000
045300         PERFORM X500-SET-CHECKPOINT-TIME                         04530000
045400     END-IF.                                                      04540000
045500                                                                  04550000
045600 EJECT                                                            04560000
045700*----------------------------------------------------------------*04570000
045800*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *04580000
045900*----------------------------------------------------------------*04590000
046000 X200-CHECKPOINT-RESTART.                                         04600000
046100                                                                  04610000
046200     MOVE 'X200-CHECKPOINT-RESTART' TO PV-CURRENT-PARAGRAPH.      04620000
046300                                                                  04630000
046400     PERFORM X400-GET-CHECKPOINT-INFO.                            04640000
046500     MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO CKPT-RESTART-INFO.     04650000
046600                                                                  04660000
046700     DISPLAY '** AHKUP037 CHECKPOINT RESTART **'                  04670000
046800     DISPLAY '** EXTRACT RECS BYPASSED ON RESTART = '             04680000
046900              CR-EXTRACT-RECS-WORKED.                             04690000
047000     DISPLAY '***********************************************'    04700000
047100                                                                  04710000
047200     PERFORM R100-READ-EXTRACT-FILE                               04720000
047300         CR-EXTRACT-RECS-WORKED TIMES.                            04730000
047400     PERFORM R100-READ-EXTRACT-FILE.                              04740000
047500 EJECT                                                            04750000
047600*----------------------------------------------------------------*04760000
047700*    SELECT CHECKPOINT RESTART CONTROL INFO.                     *04770000
047800*----------------------------------------------------------------*04780000
047900 X300-GET-CHECKPOINT-CNTL.                                        04790000
048000                                                                  04800000
048100     MOVE 'X300-GET-CHECKPOINT-CNTL' TO PV-CURRENT-PARAGRAPH.     04810000
048200                                                                  04820000
048300     PERFORM WITH TEST AFTER                                      04830000
048400             VARYING PC-RETRY-COUNT FROM 1 BY 1                   04840000
048500             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             04850000
048600                     SQLCODE = ZERO                               04860000
048700                                                                  04870000
048800             EXEC SQL                                             04880000
048900              SELECT CKPT_STAT_CODE                               04890000
049000               INTO :PV-CKPT-STAT-CODE                            04900000
049100               FROM TCKRSTCNTL                                    04910000
049200               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 04920000
049300             END-EXEC                                             04930000
049400                                                                  04940000
049500             EVALUATE TRUE                                        04950000
049600                 WHEN SQLCODE = ZERO                              04960000
049700                 WHEN SQLCODE = -904                              04970000
049800                 WHEN SQLCODE = -913                              04980000
049900                      CONTINUE                                    04990000
050000                                                                  05000000
050100                 WHEN SQLWARN0 NOT = SPACES                       05010000
050200                 WHEN SQLCODE  NOT = ZERO                         05020000
050300                     MOVE PV-CURRENT-PARAGRAPH                    05030000
050400                                         TO AA-PARAGRAPH-NAME     05040000
050500                     DISPLAY '******** PLAN_NAME:'                05050000
050600                              PV-PROGRAM-NAME                     05060000
050700                     MOVE SPACES TO AA-MESSAGE-1                  05070000
050800                                    AA-MESSAGE-2                  05080000
050900                     MOVE 'UNSUCCESSFUL SELECT'                   05090000
051000                                         TO AA-DB2-OPERATION      05100000
051100                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          05110000
051200                     PERFORM Z999-DB2-ABEND                       05120000
051300             END-EVALUATE                                         05130000
051400     END-PERFORM.                                                 05140000
051500                                                                  05150000
051600     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05160000
051700         MOVE PV-CURRENT-PARAGRAPH                                05170000
051800                             TO AA-PARAGRAPH-NAME                 05180000
051900         DISPLAY '******** PLAN_NAME:'                            05190000
052000                  PV-PROGRAM-NAME                                 05200000
052100         MOVE SPACES TO AA-MESSAGE-1                              05210000
052200                        AA-MESSAGE-2                              05220000
052300         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    05230000
052400                             TO AA-DB2-OPERATION                  05240000
052500         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      05250000
052600         PERFORM Z999-DB2-ABEND                                   05260000
052700     END-IF.                                                      05270000
052800                                                                  05280000
052900 EJECT                                                            05290000
053000*----------------------------------------------------------------*05300000
053100*    SELECT CHECKPOINT RESTART WORKING STORAGE DESCRIPTION INFO  *05310000
053200*----------------------------------------------------------------*05320000
053300 X400-GET-CHECKPOINT-INFO.                                        05330000
053400                                                                  05340000
053500     MOVE 'X400-GET-CHECKPOINT-INFO' TO PV-CURRENT-PARAGRAPH.     05350000
053600                                                                  05360000
053700     PERFORM WITH TEST AFTER                                      05370000
053800             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05380000
053900             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05390000
054000                     SQLCODE = ZERO                               05400000
054100                                                                  05410000
054200             EXEC SQL                                             05420000
054300              SELECT WORK_STRG_DESC                               05430000
054400               INTO :TCKRSTINF-WORK-STRG-DESC                     05440000
054500               FROM TCKRSTINF                                     05450000
054600               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 05460000
054700             END-EXEC                                             05470000
054800                                                                  05480000
054900             EVALUATE TRUE                                        05490000
055000                 WHEN SQLCODE = ZERO                              05500000
055100                 WHEN SQLCODE = -904                              05510000
055200                 WHEN SQLCODE = -913                              05520000
055300                      CONTINUE                                    05530000
055400                                                                  05540000
055500                 WHEN SQLWARN0 NOT = SPACES                       05550000
055600                 WHEN SQLCODE  NOT = ZERO                         05560000
055700                     MOVE PV-CURRENT-PARAGRAPH                    05570000
055800                                         TO AA-PARAGRAPH-NAME     05580000
055900                     DISPLAY '******** PLAN_NAME:'                05590000
056000                              PV-PROGRAM-NAME                     05600000
056100                     MOVE SPACES TO AA-MESSAGE-1                  05610000
056200                                    AA-MESSAGE-2                  05620000
056300                     MOVE 'UNSUCCESSFUL SELECT'                   05630000
056400                                         TO AA-DB2-OPERATION      05640000
056500                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          05650000
056600                     PERFORM Z999-DB2-ABEND                       05660000
056700             END-EVALUATE                                         05670000
056800     END-PERFORM.                                                 05680000
056900                                                                  05690000
057000     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05700000
057100         MOVE PV-CURRENT-PARAGRAPH                                05710000
057200                             TO AA-PARAGRAPH-NAME                 05720000
057300         DISPLAY '******** PLAN_NAME:'                            05730000
057400                  PV-PROGRAM-NAME                                 05740000
057500         MOVE SPACES TO AA-MESSAGE-1                              05750000
057600                        AA-MESSAGE-2                              05760000
057700         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    05770000
057800                             TO AA-DB2-OPERATION                  05780000
057900         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      05790000
058000         PERFORM Z999-DB2-ABEND                                   05800000
058100     END-IF.                                                      05810000
058200                                                                  05820000
058300 EJECT                                                            05830000
058400*----------------------------------------------------------------*05840000
058500*    SET THE TIME FOR THE NEXT CHECKPOINT.                       *05850000
058600*----------------------------------------------------------------*05860000
058700 X500-SET-CHECKPOINT-TIME.                                        05870000
058800                                                                  05880000
058900     MOVE 'X500-SET-CHECKPOINT-TIME' TO PV-CURRENT-PARAGRAPH.     05890000
059000                                                                  05900000
059100     PERFORM WITH TEST AFTER                                      05910000
059200             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05920000
059300             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05930000
059400                     SQLCODE = ZERO                               05940000
059500                                                                  05950000
059600             EXEC SQL                                             05960000
059700              SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)05970000
059800               INTO :WS-HOLD-TMST                                 05980000
059900               FROM TCKRSTCNTL                                    05990000
060000               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 06000000
060100             END-EXEC                                             06010000
060200                                                                  06020000
060300             EVALUATE TRUE                                        06030000
060400                 WHEN SQLCODE = ZERO                              06040000
060500                 WHEN SQLCODE = -904                              06050000
060600                 WHEN SQLCODE = -913                              06060000
060700                      CONTINUE                                    06070000
060800                                                                  06080000
060900                 WHEN SQLWARN0 NOT = SPACES                       06090000
061000                 WHEN SQLCODE  NOT = ZERO                         06100000
061100                     MOVE PV-CURRENT-PARAGRAPH                    06110000
061200                                         TO AA-PARAGRAPH-NAME     06120000
061300                     DISPLAY '******** PLAN_NAME:'                06130000
061400                              PV-PROGRAM-NAME                     06140000
061500                     MOVE SPACES TO AA-MESSAGE-1                  06150000
061600                                    AA-MESSAGE-2                  06160000
061700                     MOVE 'UNSUCCESSFUL SELECT'                   06170000
061800                                         TO AA-DB2-OPERATION      06180000
061900                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          06190000
062000                     PERFORM Z999-DB2-ABEND                       06200000
062100             END-EVALUATE                                         06210000
062200     END-PERFORM.                                                 06220000
062300                                                                  06230000
062400     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06240000
062500         MOVE PV-CURRENT-PARAGRAPH                                06250000
062600                             TO AA-PARAGRAPH-NAME                 06260000
062700         DISPLAY '******** PLAN_NAME:'                            06270000
062800                  PV-PROGRAM-NAME                                 06280000
062900         MOVE SPACES TO AA-MESSAGE-1                              06290000
063000                        AA-MESSAGE-2                              06300000
063100         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    06310000
063200                             TO AA-DB2-OPERATION                  06320000
063300         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      06330000
063400         PERFORM Z999-DB2-ABEND                                   06340000
063500     END-IF.                                                      06350000
063600                                                                  06360000
063700 EJECT                                                            06370000
063800*----------------------------------------------------------------*06380000
063900*    UPDATES THE CHECKPOINT RESTART CONTROL TABLE.  THE STATUS   *06390000
064000*    CODE IS SET TO '9' (RUN IN PROGRESS) OR '0' (RUN COMPLETE). *06400000
064100*----------------------------------------------------------------*06410000
064200 X600-UPDATE-TCKRSTCNTL.                                          06420000
064300                                                                  06430000
064400     MOVE 'X600-UPDATE-TCKRSTCNTL' TO PV-CURRENT-PARAGRAPH.       06440000
064500                                                                  06450000
064600     PERFORM WITH TEST AFTER                                      06460000
064700             VARYING PC-RETRY-COUNT FROM 1 BY 1                   06470000
064800             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             06480000
064900                     SQLCODE = ZERO                               06490000
065000                                                                  06500000
065100             EXEC SQL                                             06510000
065200                 UPDATE TCKRSTCNTL                                06520000
065300                 SET CKPT_STAT_CODE = :PV-CKPT-STAT-CODE          06530000
065400                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          06540000
065500             END-EXEC                                             06550000
065600                                                                  06560000
065700             EVALUATE TRUE                                        06570000
065800                 WHEN SQLCODE = ZERO                              06580000
065900                 WHEN SQLCODE = -904                              06590000
066000                 WHEN SQLCODE = -913                              06600000
066100                      CONTINUE                                    06610000
066200                                                                  06620000
066300                 WHEN SQLWARN0 NOT = SPACES                       06630000
066400                 WHEN SQLCODE  NOT = ZERO                         06640000
066500                     MOVE PV-CURRENT-PARAGRAPH                    06650000
066600                                         TO AA-PARAGRAPH-NAME     06660000
066700                     DISPLAY '******** PLAN_NAME:'                06670000
066800                              PV-PROGRAM-NAME                     06680000
066900                     MOVE SPACES TO AA-MESSAGE-1                  06690000
067000                                    AA-MESSAGE-2                  06700000
067100                     MOVE 'UNSUCCESSFUL UPDATE'                   06710000
067200                                         TO AA-DB2-OPERATION      06720000
067300                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          06730000
067400                     PERFORM Z999-DB2-ABEND                       06740000
067500             END-EVALUATE                                         06750000
067600     END-PERFORM.                                                 06760000
067700                                                                  06770000
067800     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06780000
067900         MOVE PV-CURRENT-PARAGRAPH                                06790000
068000                             TO AA-PARAGRAPH-NAME                 06800000
068100         DISPLAY '******** PLAN_NAME:'                            06810000
068200                  PV-PROGRAM-NAME                                 06820000
068300         MOVE SPACES TO AA-MESSAGE-1                              06830000
068400                        AA-MESSAGE-2                              06840000
068500         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    06850000
068600                             TO AA-DB2-OPERATION                  06860000
068700         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      06870000
068800         PERFORM Z999-DB2-ABEND                                   06880000
068900     END-IF.                                                      06890000
069000                                                                  06900000
069100     EJECT                                                        06910000
069200*----------------------------------------------------------------*06920000
069300*    UPDATES THE CHECKPOINT RESTART INFO TABLE.  THE WORKING     *06930000
069400*    STORAGE DESCRIPTION FIELD IS UPDATED WITH THE CURRENT INPUT *06940000
069500*    FILE RECORD COUNTS AND THE FILE PROCESSOR INDICATOR.        *06950000
069600*----------------------------------------------------------------*06960000
069700 X700-UPDATE-TCKRSTINF.                                           06970000
069800                                                                  06980000
069900     MOVE 'X700-UPDATE-TCKRSTINF' TO PV-CURRENT-PARAGRAPH.        06990000
070000                                                                  07000000
070100     MOVE PV-TPURITM-INPUT-COUNT TO CR-EXTRACT-RECS-WORKED.       07010000
070200     MOVE CKPT-RESTART-INFO   TO TCKRSTINF-WORK-STRG-DESC-TEXT.   07020000
070300     MOVE 4022                TO TCKRSTINF-WORK-STRG-DESC-LEN.    07030000
070400                                                                  07040000
070500     PERFORM WITH TEST AFTER                                      07050000
070600             VARYING PC-RETRY-COUNT FROM 1 BY 1                   07060000
070700             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             07070000
070800                     SQLCODE = ZERO                               07080000
070900                                                                  07090000
071000             EXEC SQL                                             07100000
071100                 UPDATE TCKRSTINF                                 07110000
071200                 SET WORK_STRG_DESC   = :TCKRSTINF-WORK-STRG-DESC 07120000
071300                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          07130000
071400             END-EXEC                                             07140000
071500                                                                  07150000
071600             EVALUATE TRUE                                        07160000
071700                 WHEN SQLCODE = ZERO                              07170000
071800                 WHEN SQLCODE = -904                              07180000
071900                 WHEN SQLCODE = -913                              07190000
072000                      CONTINUE                                    07200000
072100                                                                  07210000
072200                 WHEN SQLWARN0 NOT = SPACES                       07220000
072300                 WHEN SQLCODE  NOT = ZERO                         07230000
072400                     MOVE PV-CURRENT-PARAGRAPH                    07240000
072500                                         TO AA-PARAGRAPH-NAME     07250000
072600                     DISPLAY '******** PLAN_NAME:'                07260000
072700                              PV-PROGRAM-NAME                     07270000
072800                     MOVE SPACES TO AA-MESSAGE-1                  07280000
072900                                    AA-MESSAGE-2                  07290000
073000                     MOVE 'UNSUCCESSFUL UPDATE'                   07300000
073100                                         TO AA-DB2-OPERATION      07310000
073200                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          07320000
073300                     PERFORM Z999-DB2-ABEND                       07330000
073400             END-EVALUATE                                         07340000
073500     END-PERFORM.                                                 07350000
073600                                                                  07360000
073700     IF PC-RETRY-COUNT > PC-RETRY-MAX                             07370000
073800         MOVE PV-CURRENT-PARAGRAPH                                07380000
073900                             TO AA-PARAGRAPH-NAME                 07390000
074000         DISPLAY '******** PLAN_NAME:'                            07400000
074100                  PV-PROGRAM-NAME                                 07410000
074200         MOVE SPACES TO AA-MESSAGE-1                              07420000
074300                        AA-MESSAGE-2                              07430000
074400         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    07440000
074500                             TO AA-DB2-OPERATION                  07450000
074600         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      07460000
074700         PERFORM Z999-DB2-ABEND                                   07470000
074800     END-IF.                                                      07480000
074900                                                                  07490000
075000 EJECT                                                            07500000
075100                                                                  07510000
075200*----------------------------------------------------------------*07520000
075300*    ISSUES AN SQL COMMIT WORK AFTER A LUW HAS BEEN COMPLETED.   *07530000
075400*----------------------------------------------------------------*07540000
075500 Y100-COMMIT.                                                     07550000
075600                                                                  07560000
075700     MOVE 'Y100-COMMIT'    TO PV-CURRENT-PARAGRAPH.               07570000
075800                                                                  07580000
075900     EXEC SQL                                                     07590000
076000         COMMIT                                                   07600000
076100     END-EXEC.                                                    07610000
076200                                                                  07620000
076300     EVALUATE TRUE                                                07630000
076400         WHEN SQLCODE = ZEROS                                     07640000
076500             CONTINUE                                             07650000
076600         WHEN OTHER                                               07660000
076700             MOVE PV-CURRENT-PARAGRAPH                            07670000
076800                                 TO AA-PARAGRAPH-NAME             07680000
076900             MOVE SPACES TO AA-MESSAGE-1                          07690000
077000                            AA-MESSAGE-2                          07700000
077100             MOVE 'UNSUCCESSFUL COMMIT'                           07710000
077200                                 TO AA-DB2-OPERATION              07720000
077300             MOVE SPACES         TO AA-DB2-TABLE                  07730000
077400             PERFORM Z999-DB2-ABEND                               07740000
077500     END-EVALUATE.                                                07750000
077600 EJECT                                                            07760000
077700 Z999-DB2-ABEND.                                                  07770000
077800                                                                  07780000
077900     DISPLAY AA-ABEND-LIT.                                        07790000
078000     DISPLAY AA-DB2-ERROR-LIT.                                    07800000
078100     DISPLAY AA-PROGRAM-LIT.                                      07810000
078200     DISPLAY AA-PARAGRAPH-LIT.                                    07820000
078300     DISPLAY AA-DB2-OPERATION-LIT.                                07830000
078400     DISPLAY AA-DB2-TABLE.                                        07840000
078500     SET AC-DB2-ERROR TO TRUE.                                    07850000
078600                                                                  07860000
078700     COPY DPPD004.                                                07870000
078800                                                                  07880000
078900     CALL 'ILBOABN0' USING ABEND-CODE.                            07890000
