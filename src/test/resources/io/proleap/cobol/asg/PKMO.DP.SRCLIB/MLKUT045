000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400*                                                                 00040000
000500 PROGRAM-ID.    MLKUT045.                                         00050001
000600 AUTHOR.        CINDY ROMENESKO.                                  00060000
000700 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00070000
000800 DATE-WRITTEN.  MAY 27,1997.                                      00080000
000900 DATE-COMPILED.                                                   00090000
001000*                                                                 00100000
001100******************************************************************00110000
001200*  THIS PROGRAM WILL CREATE THE FORMATED FREIGHT DATA FOR        *00120001
001300*  FINANCE DOWNLOAD.                                             *00130000
001400******************************************************************00140006
      *                                                                 00150008
      *CHANGE HISTORY:                                                  00160009
      * WR/PROJ     DATE       PGMR        DESCRIPTION OF CHANGES       00170013
      * -------     ---------- ----------- ---------------------------- 00180013
      * 03/12/02    23511                  MARKDOWN/MARKUP TRUNCATION   00190013
W26603* W26603      03-08-2004 ROD JANSSEN MERCH LEDGER STORE EXPANSION 00200013
C41875*                                                                 00210012
C41875* C41875      03-08-2013 COGNIZANT   INCREASED INTERNAL TABLE SIZE00220013
207210* CHG0207210  08-22-2018 JIM HUNTER  RENAME KDM2810 TO MLWS051    00230015
00006 ******************************************************************00240008
                                                                        00250009
001500 ENVIRONMENT DIVISION.                                            00260000
001800 CONFIGURATION SECTION.                                           00270000
001900 SOURCE-COMPUTER.    IBM-3090.                                    00280000
002000 OBJECT-COMPUTER.    IBM-3090.                                    00290000
002200 INPUT-OUTPUT SECTION.                                            00300000
002300 FILE-CONTROL.                                                    00310000
002700*                                                                 00320000
002800     SELECT SORTED-FREIGHT-FILE                                   00330001
002900         ASSIGN TO INP01.                                         00340000
003000*                                                                 00350000
002800     SELECT FINANCE-DOWNLOAD-FILE                                 00360000
002900         ASSIGN TO OUT01.                                         00370000
003000*                                                                 00380000
003300 DATA DIVISION.                                                   00390000
003600 FILE SECTION.                                                    00400000
003700*                                                                 00410000
003800 FD  SORTED-FREIGHT-FILE                                          00420001
003900     RECORDING MODE IS F                                          00430000
004000     LABEL RECORDS ARE STANDARD                                   00440000
004100     BLOCK CONTAINS 0 RECORDS.                                    00450000
004200 01  INPUT-SORTED-FREIGHT-RECORD     PIC X(100).                  00460001
004300*                                                                 00470000
003800 FD  FINANCE-DOWNLOAD-FILE                                        00480000
003900     RECORDING MODE IS F                                          00490000
004000     LABEL RECORDS ARE STANDARD                                   00500000
004100     BLOCK CONTAINS 0 RECORDS.                                    00510000
W26603 01  FINANCE-DOWNLOAD-RECORD       PIC X(4205).                   00520009
                                                                        00530000
      ******************************************************************00540000
      *WORKING-STORAGE SECTION.                                         00550000
      ******************************************************************00560000
       WORKING-STORAGE SECTION.                                         00570000
                                                                        00580000
      *    COPYBOOK FOR THE INPUT FILE.                                 00590000
207210     COPY MLWS051.                                                00600015
                                                                        00610000
           COPY DPWS004.                                                00620000
                                                                        00630000
           EXEC SQL                                                     00640000
                INCLUDE SQLCA                                           00650000
           END-EXEC.                                                    00660000
                                                                        00670000
           EXEC SQL                                                     00680000
                INCLUDE TMDSEAR                                         00690000
           END-EXEC.                                                    00700000
                                                                        00710000
           EXEC SQL                                                     00720000
                DECLARE ACTIVE_DEPT_CURSOR CURSOR FOR                   00730000
                SELECT DEPT_NBR                                         00740000
                FROM TMDSEAR                                            00750000
                WHERE MDSELV_CDE = 'DPT'      AND                       00760000
                     STRT_DTE <= CURRENT_DATE AND                       00770000
                     END_DTE > CURRENT_DATE                             00780000
                ORDER BY DEPT_NBR                                       00790000
           END-EXEC.                                                    00800000
                                                                        00810000
       01  MISC-WORK-FIELDS.                                            00820000
                                                                        00830000
           05  WS-NBR-DEPTS                PIC S9(9) COMP VALUE +0.     00840000
           05  WS-CUMM-FREIGHT-AMT         PIC S9(9)V99 VALUE 0.        00850001
           05  WS-DIFFERENCE               PIC S9(7)V99 VALUE ZERO.     00860000
                                                                        00870000
                                                                        00880000
           05  HOLD-DEPT                   PIC X(03).                   00890000
W26603     05  HOLD-STORE                  PIC X(05).                   00900009
                                                                        00910000
           05  WS-ABEND-CODE               PIC X(04).                   00920000
           05  WS-ABEND-PARAGRAPH          PIC X(20).                   00930000
           05  WS-DB2-OPERATION-ATTEMPTED  PIC X(30).                   00940000
                                                                        00950000
       01  WS-PROGRAM-ERROR-MESSAGES.                                   00960000
           05  PE-MSG-1                    PIC  X(30)    VALUE          00970000
               'OPEN ACTIVE_DEPT CURSOR       '.                        00980000
           05  PE-MSG-2                    PIC  X(30)    VALUE          00990000
               'FETCH OF ACTIVE_DEPT CURSOR   '.                        01000000
           05  PE-MSG-3                    PIC  X(30)    VALUE          01010000
               '                              '.                        01020000
           05  PE-MSG-4                    PIC  X(30)    VALUE          01030000
               'CLOSE ACTIVE_DEPT CURSOR      '.                        01040000
                                                                        01050000
       01  CONSTANTS.                                                   01060000
           05  C-HEADER-RECORD.                                         01070000
               10  FILLER                  PIC X(6)    VALUE            01080000
                   'STORES'.                                            01090000
               10  FILLER                  PIC X(01)   VALUE ','.       01100000
               10  FILLER                  PIC X(11)   VALUE            01110000
                   'DEPARTMENTS'.                                       01120000
                                                                        01130000
       01  SWITCHES.                                                    01140000
           05  SW-MORE-FREIGHT-RECORDS     PIC X(1)     VALUE 'Y'.      01150001
               88  SW-NO-MORE-FREIGHT-RECORDS           VALUE 'N'.      01160001
                                                                        01170000
           05  SW-MORE-ACTIVE-DEPTS        PIC X(1)     VALUE 'Y'.      01180000
               88  SW-NO-MORE-ACTIVE-DEPTS              VALUE 'N'.      01190000
                                                                        01200000
       01  TABLES.                                                      01210000
                                                                        01220000
           05  T-STORE-DATA-TABLE.                                      01230000
W26603         10  T-STORE-NUMBER        PIC X(4)    VALUE SPACES.      01240009
               10  FILLER                PIC X       VALUE ','.         01250000
               10  T-DEPT-FREIGHT-TABLE OCCURS 600 TIMES                01260010
                      INDEXED BY T-FRT-IDX.                             01270001
                   15  T-DEPT-FREIGHT    PIC +999999999.99  VALUE       01280001
                                                          SPACES.       01290000
                   15  FILLER            PIC X       VALUE ','.         01300000
                                                                        01310000
           05  T-DEPT-HEADER-RECORD.                                    01320000
               10  FILLER                   PIC X(2) VALUE ' ,'.        01330000
               10  T-DEPT-COLUMNS OCCURS 600 TIMES                      01340012
                      ASCENDING T-DEPARTMENT-NUMBER                     01350000
                      INDEXED BY T-DEPT-IDX.                            01360000
                   15  T-DEPARTMENT-NUMBER  PIC X(3) VALUE HIGH-VALUES. 01370000
                   15  FILLER               PIC X    VALUE ','.         01380000
                                                                        01390000
      ******************************************************************01400000
      *   PROCEDURE DIVISION.                                           01410000
      ******************************************************************01420000
                                                                        01430000
           EJECT                                                        01440000
       PROCEDURE DIVISION.                                              01450000
                                                                        01460000
       A000-MAINLINE-PROCESSING.                                        01470000
      ******************************************************************01480000
      * MAIN PROCESSING ROUTINE                                        *01490000
      ******************************************************************01500000
                                                                        01510000
           OPEN INPUT  SORTED-FREIGHT-FILE                              01520001
                OUTPUT FINANCE-DOWNLOAD-FILE.                           01530000
                                                                        01540000
           PERFORM 1000-INITIALIZATION.                                 01550000
                                                                        01560000
           PERFORM 2000-FORMAT-FREIGHTS                                 01570001
             UNTIL SW-NO-MORE-FREIGHT-RECORDS.                          01580001
                                                                        01590000
      **** LAST RECORD PROCESSING                                       01600000
           PERFORM 2400-LOAD-DEPT-WITH-FREIGHT.                         01610001
           WRITE FINANCE-DOWNLOAD-RECORD FROM T-STORE-DATA-TABLE.       01620000
                                                                        01630000
           CLOSE SORTED-FREIGHT-FILE                                    01640001
                 FINANCE-DOWNLOAD-FILE.                                 01650000
                                                                        01660000
                                                                        01670000
           GOBACK.                                                      01680000
                                                                        01690000
           EJECT                                                        01700000
                                                                        01710000
       1000-INITIALIZATION.                                             01720000
                                                                        01730000
                                                                        01740000
           EXEC SQL                                                     01750000
               OPEN ACTIVE_DEPT_CURSOR                                  01760000
           END-EXEC.                                                    01770000
                                                                        01780000
           EVALUATE TRUE                                                01790000
               WHEN SQLCODE = ZERO                                      01800000
                    CONTINUE                                            01810000
               WHEN OTHER                                               01820000
                    MOVE '1000-INITIALIZATION'                          01830000
                                       TO WS-ABEND-PARAGRAPH            01840000
                    MOVE PE-MSG-1      TO WS-DB2-OPERATION-ATTEMPTED    01850000
                    PERFORM 9200-SQL-ABEND                              01860000
           END-EVALUATE.                                                01870000
                                                                        01880000
           PERFORM 1900-FETCH-ACTIVE-DEPT.                              01890000
                                                                        01900000
           SET T-DEPT-IDX    TO +1.                                     01910000
           PERFORM 1800-LOAD-DEPT-TABLES                                01920000
              UNTIL SW-NO-MORE-ACTIVE-DEPTS.                            01930000
                                                                        01940000
           WRITE FINANCE-DOWNLOAD-RECORD FROM C-HEADER-RECORD.          01950000
           WRITE FINANCE-DOWNLOAD-RECORD FROM T-DEPT-HEADER-RECORD.     01960000
                                                                        01970000
           PERFORM 2100-READ-FREIGHT-REC.                               01980001
                                                                        01990000
           MOVE D090-DEPT-10             TO HOLD-DEPT.                  02000003
W26603     MOVE D090-STORE-10(2:4)       TO T-STORE-NUMBER              02010009
W26603     MOVE D090-STORE-10            TO HOLD-STORE.                 02020009
                                                                        02030000
       1800-LOAD-DEPT-TABLES.                                           02040000
                                                                        02050000
            MOVE MDSEAR-DEPT-NBR  TO  T-DEPARTMENT-NUMBER(T-DEPT-IDX)   02060000
                                                                        02070000
            PERFORM 1900-FETCH-ACTIVE-DEPT.                             02080000
                                                                        02090000
            SET T-DEPT-IDX UP BY +1.                                    02100000
                                                                        02110000
       1900-FETCH-ACTIVE-DEPT.                                          02120000
                                                                        02130000
           EXEC SQL                                                     02140000
                FETCH ACTIVE_DEPT_CURSOR                                02150000
                INTO :MDSEAR-DEPT-NBR                                   02160000
           END-EXEC.                                                    02170000
                                                                        02180000
           EVALUATE TRUE                                                02190000
               WHEN SQLCODE = ZERO                                      02200000
                    CONTINUE                                            02210000
               WHEN SQLCODE = +100                                      02220000
                    SET SW-NO-MORE-ACTIVE-DEPTS TO TRUE                 02230000
               WHEN OTHER                                               02240000
                    MOVE '1900-FETCH-ACTIVE-DPT'                        02250000
                                       TO WS-ABEND-PARAGRAPH            02260000
                    MOVE PE-MSG-2      TO WS-DB2-OPERATION-ATTEMPTED    02270000
                    PERFORM 9200-SQL-ABEND                              02280000
           END-EVALUATE.                                                02290000
                                                                        02300000
       2000-FORMAT-FREIGHTS.                                            02310001
                                                                        02320000
W26603     IF D090-STORE-10              = HOLD-STORE                   02330009
              IF D090-DEPT-10            = HOLD-DEPT                    02340003
                 ADD  D090-FREIGHT-AMT  TO WS-CUMM-FREIGHT-AMT          02350005
              ELSE                                                      02360000
                 PERFORM 2400-LOAD-DEPT-WITH-FREIGHT                    02370001
                 MOVE D090-FREIGHT-AMT  TO WS-CUMM-FREIGHT-AMT          02380005
                 MOVE D090-DEPT-10      TO HOLD-DEPT                    02390003
           ELSE                                                         02400000
              PERFORM 2400-LOAD-DEPT-WITH-FREIGHT                       02410001
              WRITE FINANCE-DOWNLOAD-RECORD FROM T-STORE-DATA-TABLE     02420000
              INITIALIZE T-STORE-DATA-TABLE                             02430000
W26603        MOVE D090-STORE-10(2:4)   TO T-STORE-NUMBER               02440009
W26603        MOVE D090-STORE-10        TO HOLD-STORE                   02450009
              MOVE D090-DEPT-10         TO HOLD-DEPT                    02460003
              MOVE D090-FREIGHT-AMT     TO WS-CUMM-FREIGHT-AMT.         02470005
                                                                        02480000
           PERFORM 2100-READ-FREIGHT-REC.                               02490001
                                                                        02500000
           EJECT                                                        02510000
                                                                        02520000
       2100-READ-FREIGHT-REC.                                           02530001
                                                                        02540000
           READ SORTED-FREIGHT-FILE INTO D090-PURCH-JRNL                02550004
             AT END                                                     02560000
                SET SW-NO-MORE-FREIGHT-RECORDS TO TRUE.                 02570001
                                                                        02580000
                                                                        02590000
       2400-LOAD-DEPT-WITH-FREIGHT.                                     02600001
                                                                        02610000
           SEARCH ALL T-DEPT-COLUMNS                                    02620000
              AT END                                                    02630000
                  DISPLAY 'DEPARTMENT NUMBER NOT FOUND'                 02640000
                  DISPLAY 'DEPARTMENT NUMBER = ' HOLD-DEPT              02650000
                  PERFORM 9400-PROGRAM-ABEND                            02660000
              WHEN T-DEPARTMENT-NUMBER(T-DEPT-IDX) = HOLD-DEPT          02670000
                   SET T-FRT-IDX           TO  T-DEPT-IDX               02680001
                   MOVE WS-CUMM-FREIGHT-AMT                             02690001
                                      TO T-DEPT-FREIGHT(T-FRT-IDX)      02700002
           END-SEARCH.                                                  02710000
                                                                        02720000
       9200-SQL-ABEND.                                                  02730000
      ******************************************************************02740000
      *  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    02750000
      *  ERROR OR WARNING CODE OCCURS.                                  02760000
      ******************************************************************02770000
           DISPLAY '***************************'.                       02780000
           DISPLAY '**       ABEND           **'.                       02790000
           DISPLAY '**  IN PROGRAM MLKUT045  **'.                       02800001
           DISPLAY '***************************'.                       02810000
           DISPLAY '** PARAGRAPH ** = ' WS-ABEND-PARAGRAPH.             02820000
           DISPLAY '** OPERATION ** = ' WS-DB2-OPERATION-ATTEMPTED.     02830000
                                                                        02840000
      ******************************************************************02850000
      *  THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-   02860000
      *  MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE        02870000
      *  'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE    02880000
      *  FORMAT.                                                        02890000
      ******************************************************************02900000
           COPY DPPD004.                                                02910000
                                                                        02920000
           EXEC SQL                                                     02930000
                COMMIT                                                  02940000
           END-EXEC.                                                    02950000
                                                                        02960000
           MOVE +4013                  TO WS-ABEND-CODE.                02970000
           CALL 'ILBOABN0' USING WS-ABEND-CODE.                         02980000
      ******************************************************************02990000
      *  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN        03000000
      *  ERROR OCCURS.                                                  03010000
      ******************************************************************03020000
                                                                        03030000
       9400-PROGRAM-ABEND.                                              03040000
           DISPLAY 'MLKUT045- ABORTING'.                                03050001
           MOVE 4004 TO WS-ABEND-CODE.                                  03060000
           CALL 'ILBOABN0' USING WS-ABEND-CODE.                         03070000
                                                                        03080000
