000100***************************************************************** 00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300***************************************************************** 00030000
000400                                                                  00040000
000500 PROGRAM-ID.             TCKUT009.                                00050000
000600 AUTHOR.                 J MYERS.                                 00060000
000700 INSTALLATION.           KOHLS.                                   00070000
000800 DATE-WRITTEN            04/2002.                                 00080000
000900 DATE-COMPILED.                                                   00090000
001000                                                                  00100000
001100***************************************************************** 00110000
001200*  PURPOSE:                                                       00120000
001300*  CREATE A FLAT FILE OF DAILY CREDIT SETTLEMENT INFORMATION FROM 00130000
001400*  THE COSA TABLES.  THIS FILE WILL BE USED TO MATCH AGAINST WHAT 00140000
001500*  WAS SEND TO FIFTH THIRD BANK FOR THE DAILY PROCESSING.  THIS   00150000
001600*  FILE WILL INCLUDE LATES, CORRECTIONS, VOIDS, AND REGULAR SALES.00160000
001700*  REPORTING ON THIS DATA WILL HAPPEN IN A LATER PROGRAM.         00170000
001710*  AMERICAN EXPRESS AND DISCOVER TRANSACTIONS ARE ALSO ON THE     00180000
001720*  OUTPUT FILE BUT ARE SORTED OFF BEFORE THIS FILE IS SENT TO     00190000
001730*  FIFTH THIRD BANK.                                              00200000
001800***************************************************************** 00210000
P9696 *                                                                *00220000
P9696 * DATE:        2014-01-16                                        *00230000
P9696 * WR/IR#:      P9696 - AJB SETTLEMENT                            *00240000
P9696 * PROGRAMMER:  COGNIZANT                                         *00250000
P9696 * DESCRIPTION: REMOVED 'SFS' EPTRN-OMNI-CHNL-FFLMT-TYP-CDE CHECK *00260000
P9696 *              FOR RETURN IN 2100-CHECK-ECOMMERCE-STORE PARA.    *00270000
P9696 *              BECASUE RETURN TRANSACTIONS NOT MARKED WITH       *00280000
P9696 *              OMNI-CHNL-FFLMT-TYP-CDE AS 'SFS'.                 *00290000
P9696 *              BOPUS (BPS) TRANSACTIONS WILL ALSO BE PROCESSED   *00300000
P9696 *              AS LIKE SFS TRANSACTIONS. I.E., E-BUS-IND SET TO  *00310000
P9696 *              'Y', STORE 873 TO SETTLE STORE NUMBER, ORDER NUM  *00320000
P9696 *              MOVED TO TC005-ECOMM-ORD-NBR.                     *00330000
P9696 *              INCLUDED TC007-ORG-STR-NBR & TC007-AUTH-REF-NBR   *00340000
P9696 *              IN TCRD007 COPYBOOK AND ADDED LOGIC TO POPULATE.  *00350000
P9696 *              ADDED NEW PARA 2160-SELECT-TEPCRR TO GET AUTH     *00360000
P9696 *              REFERENCE NUMBER FROM TEPCRR TABLE.               *00370000
P9696 *              INCREASED LRECL OF OUTPUT FILE TO 266.            *00380000
P9696 *                                                                *00390000
P9696 *----------------------------------------------------------------*00400000
001800***************************************************************** 00410000
CHGFIX*                                                                *00420000
CHGFIX* DATE:        2014-07-23                                        *00430000
CHGFIX* WR/IR#:      CHG0087518                                         00440000
CHGFIX* PROGRAMMER:  COGNIZANT                                         *00450000
CHGFIX* DESCRIPTION:ADDED WITH UR IN THE SQLS TO AVOID THE CONTENTION  *00460000
CHGFIX*             ISSUES.                                            *00470000
CHGFIX*             FIND THE TAG CHGFIX TO SEE THE CHANGES.            *00480000
CHGFIX*----------------------------------------------------------------*00490000
C03486* DATE:        01/29/2015                                        *00500000
C03486* WR/IR#:      CHG0103486                                        *00510000
C03486* PROGRAMMER:  COGNIZANT                                         *00520000
C03486* DESCRIPTION: FIX FOR SALES CORRECTION SEQUENCE NUMBER ISSUE    *00530000
C03486*              IN TEPCRR TABLE.                                  *00540000
004000*----------------------------------------------------------------*00550000
004100* DATE:        03/35/2015                                        *00560000
004200* WR/IR#:      CHG0108147                                        *00570000
004300* PROGRAMMER:  COGNIZANT                                         *00580000
004400* DESCRIPTION: FIX FOR SALES CORRECTION SEQUENCE NUMBER AND      *00590000
004500*              TENDER SEQUENCE NUMBER MISMATCH ISSUE IN TEPCRR   *00600000
004500*              TABLE.                                            *00610000
004600*----------------------------------------------------------------*00620000
P10237* DATE:        03/27/2015                                        *00621000
P10237* WR/IR#:      CHG0104429                                        *00622000
P10237* PROGRAMMER:  COGNIZANT                                         *00623000
P10237* DESCRIPTION: REMOVED EXPIRATION DATE FIELD AS IT IS NOT USED IN*00624000
P10237*              DOWNSTREAM. CHANGES ARE MADE AS PART OF COSA DATA *00625000
P10237*              SECURITY PROJECT.                                 *00625100
W10849*----------------------------------------------------------------*00625200
W10849* DATE:        05/18/2016                                         00625300
W10849* WR/IR#:      CHG0139454                                         00625400
W10849* PROGRAMMER:  ACCENTURE                                          00625500
W10849* DESCRIPTION: MODIFIED EXTRACT-CURSOR TO NOT EXTRACT OUTLET TRXS*00625600
W10849*              '001' IS AN OUTLET TRANSACTION.                   *00625700
P10237*----------------------------------------------------------------*00625800
SHIP  * DATE:        04/18/2019                                        *00625900
SHIP  * WR/IR#:      CHG0220426                                        *00626000
SHIP  * PROGRAMMER:  BARB SCHULTZ                                      *00627000
SHIP  * DESCRIPTION: MOVED 4 NEW FIELDS FROM TEPTRN TO TCRD007.        *00628000
SHIP  *              THIS WAS DONE FOR THE SETTLE BY SHIP PROJECT.     *00629000
SHIP  *----------------------------------------------------------------*00629100
SHIP2 * DATE:        01/21/2020                                        *00629200
SHIP2 * WR/IR#:      CHG0233046                                        *00629300
SHIP2 * PROGRAMMER:  BARB SCHULTZ                                      *00629400
SHIP2 * DESCRIPTION: DELETED THE MC FIELDS TO NOW USE THE VISA         *00629500
SHIP2 *              FIELDS. BOTH VISA AND MC ARE GOING TO BE USING    *00629600
SHIP2 *              THE SAME MULT CLEAR FIELDS FROM THE DATABASE.     *00629700
SHIP2 *              MOVED SPACES TO THE PARTIAL SHIPMENT INDICATOR.   *00629800
052523*----------------------------------------------------------------*00630000
052523*  CHANGE MADE: ADD CHANGES FOR NEW COBRAND TENDER TYPE           00630100
052523*               ADD CHANGES FOR PLCC TRAILING TRANSACTIONS        00630200
052523*  DATE: 05/25/2023                                               00630300
052523*  MADE BY: DAN PAYNTER              WR/IR #: CHG0289014          00630400
SHIP  *----------------------------------------------------------------*00630500
001900 ENVIRONMENT DIVISION.                                            00630600
002000***************************************************************** 00630700
002100                                                                  00630800
002200 CONFIGURATION SECTION.                                           00630900
002300                                                                  00631000
002400 SOURCE-COMPUTER.        IBM-3090.                                00631100
002500                                                                  00631200
002600 OBJECT-COMPUTER.        IBM-3090.                                00631300
002700                                                                  00632000
002800 INPUT-OUTPUT SECTION.                                            00640000
002900                                                                  00650000
003000 FILE-CONTROL.                                                    00660000
003100                                                                  00670000
003200     SELECT DATE-CARD-FILE                                        00680000
003300         ASSIGN TO INP01.                                         00690000
003400                                                                  00700000
003500     SELECT COSA-EXTRACT-FILE                                     00710000
003600         ASSIGN TO OUT01.                                         00720000
003700                                                                  00730000
003800 EJECT                                                            00740000
003900******************************************************************00750000
004000 DATA DIVISION.                                                   00760000
004100******************************************************************00770000
004200                                                                  00780000
004300 FILE SECTION.                                                    00790000
004400                                                                  00800000
004500 FD  DATE-CARD-FILE                                               00810000
004600     RECORDING MODE IS F                                          00820000
004700     BLOCK CONTAINS 0 RECORDS                                     00830000
004800     LABEL RECORDS ARE STANDARD.                                  00840000
004900                                                                  00850000
005000 01  DATE-CARD-RECORD            PIC X(80).                       00860000
005100                                                                  00870000
005200 FD  COSA-EXTRACT-FILE                                            00880000
005300     RECORDING MODE IS F                                          00890000
005400     LABEL RECORDS ARE STANDARD                                   00900000
005500     BLOCK CONTAINS 0 RECORDS                                     00910000
SHIP       RECORD CONTAINS 288 CHARACTERS.                              00920000
005700                                                                  00930000
SHIP   01  COSA-EXTRACT-RECORD           PIC X(288).                    00940000
005900                                                                  00950000
006000 EJECT                                                            00960000
006100******************************************************************00970000
006200 WORKING-STORAGE SECTION.                                         00980000
006300******************************************************************00990000
006400 01  FILLER                            PIC X(50)  VALUE           01000000
006500     ' *** WORKING STORAGE STARTS HERE FOR TCKUT009 *** '.        01010000
006600                                                                  01020000
006700******************************************************************01030000
006800* RECORD LAYOUT FOR INPUT DATE CARD (POS DATE)                   *01040000
006900******************************************************************01050000
007000 01  CC-CONTROL-CARD.                                             01060000
007100     05  CC-CONTROL-CARD-DISPLAY.                                 01070000
007200         10  CC-CONTROL-NAME     PIC X(14)    VALUE SPACE.        01080000
007300             88  CC-VALID-CONTROL-NAME        VALUE               01090000
007400                 'P.O.S. DATE = '.                                01100000
007500         10  CC-POS-DATE-MMDDYY  PIC 9(6)     VALUE ZERO.         01110000
007600     05  FILLER                  PIC X(60)    VALUE SPACE.        01120000
007700                                                                  01130000
007800******************************************************************01140000
007900*  PARAMETER LIST FOR THE CALENDAR ROUTINE (DPKUT500)            *01150000
008000******************************************************************01160000
008100     COPY DPWS500.                                                01170000
008200                                                                  01180000
008300 01  AC-ABEND-CODE                      PIC S9(04) VALUE ZERO     01190000
008400                                                  COMP SYNC.      01200000
008500     88  AC-CONTROL-CARD-ERROR                    VALUE +4003.    01210000
008600     88  AC-DB2-ERROR                             VALUE +4013.    01220000
008700     88  AC-CALENDAR-ROUTINE-ERROR                VALUE +4019.    01230000
008800                                                                  01240000
008900  01  PS-PROGRAM-SWITCHES.                                        01250000
009000     05  PS-END-OF-EXTRACT-SW          PIC X(01)  VALUE 'N'.      01260000
009100         88  PS-NOT-END-OF-EXTRACT                VALUE 'N'.      01270000
009200         88  PS-END-OF-EXTRACT                    VALUE 'Y'.      01280000
052523     05  PS-END-OF-PAYMENT-SW          PIC X(01)  VALUE 'N'.      01281000
052523         88  PS-NOT-END-OF-PAYMENT                VALUE 'N'.      01282000
052523         88  PS-END-OF-PAYMENT                    VALUE 'Y'.      01283000
009300     05  PS-END-OF-DATE-FILE-SW        PIC X(01)  VALUE 'N'.      01290000
009400         88  PS-END-OF-DATE-FILE                  VALUE 'Y'.      01300000
009410     05  PS-RETURN-INFO-SW             PIC X(01) VALUE 'N'.       01310000
009420         88  PS-RETURN-INFO                      VALUE 'Y'.       01320000
009430         88  PS-NO-RETURN-INFO                   VALUE 'N'.       01330000
TEST       05  PS-TEPCRR-FOUND-SW            PIC X(01) VALUE 'N'.       01340000
TEST           88  PS-TEPCRR-FOUND                     VALUE 'Y'.       01350000
TEST           88  PS-TEPCRR-NOT-FOUND                 VALUE 'N'.       01360000
009500                                                                  01370000
009600 01  PC-CONSTANTS.                                                01380000
009700     05  PC-ROW-NOT-FOUND              PIC S9(04) VALUE +100      01390000
009800                                                  COMP SYNC.      01400000
009900     05  PC-CURRENT-PROGRAM-NAME       PIC  X(08) VALUE           01410000
010000                                                 'TCKUT009'.      01420000
010010     05  PC-RETURN-TRANS              PIC X(02)      VALUE '11'.  01430000
010100 01  PV-PROGRAM-VARIABLES.                                        01440000
010200     05  PV-MISC-COUNT-FIELDS                         COMP-3.     01450000
010300          10  PV-PAGE-CNT1             PIC S9(05) VALUE ZERO.     01460000
010400          10  PV-PAGE-CNT2             PIC S9(05) VALUE ZERO.     01470000
010500                                                                  01480000
010600     05  PV-PARAGRAPH-NAME             PIC  X(30) VALUE SPACE.    01490000
010700     05  PV-OPERATION-MSG-1            PIC  X(40) VALUE SPACE.    01500000
010800     05  PV-OPERATION-MSG-2            PIC  X(40) VALUE SPACE.    01510000
010900     05  PV-DB2-OPERATION              PIC  X(30) VALUE SPACE.    01520000
011000     05  PV-POS-CCYY-MM-DD             PIC  X(10).                01530000
011001     05  PV-CRD-LVL-RSLT-CDE.                                     01540000
011002         10  PV-CRD-LVL-RSLT-CDE-1     PIC X(01)  VALUE SPACES.   01550000
011003         10  PV-CRD-LVL-RSLT-CDE-2     PIC X(01)  VALUE SPACES.   01560000
011004     05  PV-ORIG-PARTN-NBR           PIC S9(04)     COMP.         01570000
011005     05  PV-ORIG-STR-NBR             PIC S9(04)     COMP.         01580000
011006     05  PV-ORIG-RGST-ID             PIC S9(04)     COMP.         01590000
011007     05  PV-ORIG-TRN-NBR             PIC S9(04)     COMP.         01600000
011008     05  PV-ORIG-STRT-TM             PIC X(8).                    01610000
011009     05  PV-ORIG-SLS-DTE             PIC X(10).                   01620000
011010     05  PV-SAVE-E-BUS-IND           PIC X(01) VALUE 'N'.         01630000
SHIP       05  PV-FULFILLMENT-TYPE         PIC X(01)    VALUE SPACES.   01640000
SHIP           88  PV-OMNI-BPS-BOS                       VALUE 'O'.     01650000
SHIP           88  PV-SHIP-TO-HOME                       VALUE 'S'.     01660000
SHIP       05  PV-VISA-MULT-CLR-SEQ-NBR    PIC 9(04)  VALUE ZEROES.     01670000
SHIP       05  PV-VISA-TOT-SHP-NBR         PIC 9(04)  VALUE ZEROES.     01680000
011100 EJECT                                                            01700000
011200***************************************************************** 01710000
011300*  COSA EXTRACT FLAT FILE LAYOUT                                  01720000
011400******************************************************************01730000
011500     COPY TCRD007.                                                01740000
011600 EJECT                                                            01750000
011700***************************************************************** 01760000
011800*  WS FIELDS FOR SQLCA MESSAGE ROUTINE                            01770000
011900******************************************************************01780000
012000     COPY DPWS004.                                                01790000
012100 EJECT                                                            01800000
012200******************************************************************01810000
012300*  DB2 COMMUNICATION AREA.                                        01820000
012400******************************************************************01830000
012500     EXEC SQL                                                     01840000
012600          INCLUDE SQLCA                                           01850000
012700     END-EXEC.                                                    01860000
012800 EJECT                                                            01870000
012900******************************************************************01880000
013000*  DB2 TABLE DB2PDBA.TEPPART - PARTITION CONTROL TABLE            01890000
013100******************************************************************01900000
013200     EXEC SQL                                                     01910000
013300          INCLUDE TEPPART                                         01920000
013400     END-EXEC.                                                    01930000
013500 EJECT                                                            01940000
013600******************************************************************01950000
013700*  DB2 TABLE DB2PDBA.TEPDKEY         PROCESING DAY KEY TABLE      01960000
013800******************************************************************01970000
013900     EXEC SQL                                                     01980000
014000          INCLUDE TEPDKEY                                         01990000
014100     END-EXEC.                                                    02000000
014200 EJECT                                                            02010000
014300******************************************************************02020000
014400*  DB2 TABLE DB2PDBA.TEPCRD  - CREDIT CARD TABLE                  02030000
014500******************************************************************02040000
014600     EXEC SQL                                                     02050000
014700          INCLUDE TEPCRD                                          02060000
014800     END-EXEC.                                                    02070000
014900 EJECT                                                            02080000
052523******************************************************************02081000
052523*  DB2 TABLE DB2PDBA.TEPPAY  - CC PAYMENT TABLE                   02082000
052523******************************************************************02083000
052523     EXEC SQL                                                     02084000
052523          INCLUDE TEPPAY                                          02085000
052523     END-EXEC.                                                    02086000
052523                                                                  02087000
015000******************************************************************02090000
015100*  DB2 TABLE DB2PDBA.TEPTND - TENDER TABLE                        02100000
015200******************************************************************02110000
015300     EXEC SQL                                                     02120000
015400          INCLUDE TEPTND                                          02130000
015500     END-EXEC.                                                    02140000
015600 EJECT                                                            02150000
015700******************************************************************02160000
015800*  DB2 TABLE DB2PDBA.TEPTRN - TRANSACTION TABLE                   02170000
015900******************************************************************02180000
016000     EXEC SQL                                                     02190000
016100          INCLUDE TEPTRN                                          02200000
016200     END-EXEC.                                                    02210000
016207******************************************************************02220000
016208*  DB2 TABLE DB2PDBA.TEPIRT                                       02230000
016209******************************************************************02240000
016210     EXEC SQL                                                     02250000
016211          INCLUDE TEPIRT                                          02260000
016212     END-EXEC.                                                    02270000
P9696 ******************************************************************02280000
P9669 *  DB2 TABLE DB2PDBA.TEPCRR  - CREDIT RETURN AUTHORIZATION TABLE  02290000
P9696 ******************************************************************02300000
P9696      EXEC SQL                                                     02310000
P9696           INCLUDE TEPCRR                                          02320000
P9696      END-EXEC.                                                    02330000
016213******************************************************************02340000
016220*  DB2 TABLE DB2PDBA.EPT_CR_CRD_VRFN TABLE                        02350000
016230******************************************************************02360000
016240     EXEC SQL                                                     02370000
016250          INCLUDE EPT00056                                        02380000
016260     END-EXEC.                                                    02390000
016310******************************************************************02400000
016320*  LOCATION DOMAIN TABLE                                          02410000
016330******************************************************************02420000
016340     EXEC SQL                                                     02430000
016350          INCLUDE XST00001                                        02440000
016360     END-EXEC.                                                    02450000
016361******************************************************************02460000
016362*  DB2 TABLE DB2PDBA.TEPORD - ORDER TABLE                         02470000
016364******************************************************************02480000
016365     EXEC SQL                                                     02490000
016366          INCLUDE TEPORD                                          02500000
016367     END-EXEC.                                                    02510000
052523******************************************************************02540100
052523*  CREATE CURSOR FOR COBRAND PAYMENTS EXTRACT                     02540200
052523******************************************************************02540300
052523     EXEC SQL                                                     02540400
052523         DECLARE PAYMENT-CURSOR  CURSOR                           02540500
052523                                                                  02540600
052523         FOR SELECT A.PARTN_NBR                                   02540700
052523             ,A.STR_NBR                                           02540800
052523             ,A.RGST_ID                                           02540900
052523             ,A.TRN_NBR                                           02541000
052523             ,A.STRT_TM                                           02541100
052523             ,A.SLS_CORR_SEQ_NBR                                  02541200
052523             ,A.TRN_TYP_CDE                                       02541300
052523             ,A.SLS_DTE                                           02541400
052523             ,A.TRN_DTE                                           02541500
052523             ,A.VOID_ABRT_CDE                                     02541600
052523             ,B.TNDR_SEQ_NBR                                      02541700
052523             ,B.TNDR_TYP_CDE                                      02541800
052523             ,P.KC_ACCT_NBR                                       02541900
052523             ,B.TNDR_AMT                                          02542000
052523             ,P.KC_ACCT_SRC_CDE                                   02542100
052523             ,P.AUTH_NBR                                          02542200
052523             ,P.AUTH_SRC_CDE                                      02542300
052523             ,0.00                                                02542400
052523             ,' '                                                 02542500
052523             ,' '                                                 02542600
052523             ,' '                                                 02542700
052523             ,' '                                                 02542800
052523             ,1                                                   02542900
052523             ,' '                                                 02543000
052523             ,A.SLS_TX_AMT                                        02543100
052523             ,A.VISA_TOT_SHP_NBR                                  02543200
052523             ,'  '                                                02543300
052523             ,' '                                                 02543400
052523             ,' '                                                 02543500
052523             ,'2008-01-01-01.00.00.000000'                        02543600
052523             ,0.00                                                02543700
052523             ,'  '                                                02543800
052523             ,'   '                                               02543900
052523             ,P.TRLING_TRN_IND                                    02544000
052523             ,P.COBRND_IND                                        02544100
052523             ,P.PAYT_AMT                                          02544200
052523          FROM TEPPART D                                          02544300
052523              ,TEPTRN A                                           02544400
052523              ,TEPTND B                                           02544500
052523              ,TEPPAY P                                           02544600
052523          WHERE D.SLS_DTE = :PV-POS-CCYY-MM-DD                    02544700
052523          AND D.DB_STRUC_CDE = 'O'                                02544800
052523          AND D.STR_GP_CDE       = 'A'                            02544900
052523          AND D.PARTN_NBR = A.PARTN_NBR                           02545000
052523          AND D.PARTN_NBR = B.PARTN_NBR                           02545100
052523          AND D.PARTN_NBR = P.PARTN_NBR                           02545200
052523          AND A.STR_NBR = B.STR_NBR                               02545300
052523          AND A.STR_NBR = P.STR_NBR                               02545400
052523          AND A.RGST_ID = B.RGST_ID                               02545500
052523          AND A.RGST_ID = P.RGST_ID                               02545600
052523          AND A.TRN_NBR = B.TRN_NBR                               02545700
052523          AND A.TRN_NBR = P.TRN_NBR                               02545800
052523          AND A.STRT_TM = B.STRT_TM                               02545900
052523          AND A.STRT_TM = P.STRT_TM                               02546000
052523          AND A.SLS_CORR_SEQ_NBR = B.SLS_CORR_SEQ_NBR             02546100
052523          AND A.SLS_CORR_SEQ_NBR = P.SLS_CORR_SEQ_NBR             02546200
052523          AND A.TRN_TYP_CDE     = '30'                            02546300
052523          AND A.VOID_ABRT_CDE = 'N'                               02546400
052523          AND A.TRN_STAT_CDE = 'Z'                                02546500
052523          AND ((A.POS_TYP_CDE <> '001')                           02546600
052523           OR  (A.POS_TYP_CDE IS NULL))                           02546700
052523          AND B.TNDR_VOID_IND = 'N'                               02546800
052523          AND (P.COBRND_IND     = 'Y'                             02546900
052523               OR P.TRLING_TRN_IND = 'Y')                         02547000
052523   UNION ALL                                                      02547100
052523             SELECT A.PARTN_NBR                                   02547200
052523             ,A.STR_NBR                                           02547300
052523             ,A.RGST_ID                                           02547400
052523             ,A.TRN_NBR                                           02547500
052523             ,A.STRT_TM                                           02547600
052523             ,A.SLS_CORR_SEQ_NBR                                  02547700
052523             ,A.TRN_TYP_CDE                                       02547800
052523             ,A.SLS_DTE                                           02547900
052523             ,A.TRN_DTE                                           02548000
052523             ,A.VOID_ABRT_CDE                                     02548100
052523             ,B.TNDR_SEQ_NBR                                      02548200
052523             ,B.TNDR_TYP_CDE                                      02548300
052523             ,P.KC_ACCT_NBR                                       02548400
052523             ,B.TNDR_AMT                                          02548500
052523             ,P.KC_ACCT_SRC_CDE                                   02548600
052523             ,P.AUTH_NBR                                          02548700
052523             ,P.AUTH_SRC_CDE                                      02548800
052523             ,0.00                                                02548900
052523             ,' '                                                 02549000
052523             ,' '                                                 02549100
052523             ,' '                                                 02549200
052523             ,' '                                                 02549300
052523             ,1                                                   02549400
052523             ,' '                                                 02549500
052523             ,A.SLS_TX_AMT                                        02549600
052523             ,A.VISA_TOT_SHP_NBR                                  02549700
052523             ,'  '                                                02549800
052523             ,' '                                                 02549900
052523             ,' '                                                 02550000
052523             ,'2008-01-01-01.00.00.000000'                        02550100
052523             ,0.00                                                02550200
052523             ,'  '                                                02550300
052523             ,'   '                                               02550400
052523             ,P.TRLING_TRN_IND                                    02550500
052523             ,P.COBRND_IND                                        02550600
052523             ,P.PAYT_AMT                                          02550700
052523          FROM TEPPART D                                          02550800
052523              ,TEPTRN A                                           02550900
052523              ,TEPTND B                                           02551000
052523              ,TEPPAY P                                           02551100
052523          WHERE D.SLS_DTE = :PV-POS-CCYY-MM-DD                    02551200
052523          AND D.DB_STRUC_CDE = 'O'                                02551300
052523          AND D.STR_GP_CDE       = 'A'                            02551400
052523          AND D.PARTN_NBR = A.PARTN_NBR                           02551500
052523          AND D.PARTN_NBR = B.PARTN_NBR                           02551600
052523          AND D.PARTN_NBR = P.PARTN_NBR                           02551700
052523          AND A.STR_NBR = B.STR_NBR                               02551800
052523          AND A.STR_NBR = P.STR_NBR                               02551900
052523          AND A.RGST_ID = B.RGST_ID                               02552000
052523          AND A.RGST_ID = P.RGST_ID                               02552100
052523          AND A.TRN_NBR = B.TRN_NBR                               02552200
052523          AND A.TRN_NBR = P.TRN_NBR                               02552300
052523          AND A.STRT_TM = B.STRT_TM                               02552400
052523          AND A.STRT_TM = P.STRT_TM                               02552500
052523          AND A.SLS_CORR_SEQ_NBR = B.SLS_CORR_SEQ_NBR             02552600
052523          AND A.SLS_CORR_SEQ_NBR = P.SLS_CORR_SEQ_NBR             02552700
052523          AND A.TRN_TYP_CDE      = '30'                           02552800
052523          AND A.VOID_ABRT_CDE    = 'N'                            02552900
052523          AND B.TNDR_VOID_IND    = 'N'                            02553000
052523          AND A.TRN_STAT_CDE IN ('V','L')                         02553100
052523          AND ((A.POS_TYP_CDE <> '001')                           02553200
052523           OR  (A.POS_TYP_CDE IS NULL))                           02553300
052523          AND P.STTLMNT_PRCD_CDE = 'U'                            02553400
052523          AND (P.COBRND_IND     = 'Y'                             02553500
052523               OR P.TRLING_TRN_IND = 'Y')                         02553600
052523   UNION ALL                                                      02553700
052523             SELECT A.PARTN_NBR                                   02553800
052523             ,A.STR_NBR                                           02553900
052523             ,A.RGST_ID                                           02554000
052523             ,A.TRN_NBR                                           02554100
052523             ,A.STRT_TM                                           02554200
052523             ,A.SLS_CORR_SEQ_NBR                                  02554300
052523             ,A.TRN_TYP_CDE                                       02554400
052523             ,A.SLS_DTE                                           02554500
052523             ,A.TRN_DTE                                           02554600
052523             ,A.VOID_ABRT_CDE                                     02554700
052523             ,B.TNDR_SEQ_NBR                                      02554800
052523             ,B.TNDR_TYP_CDE                                      02554900
052523             ,P.KC_ACCT_NBR                                       02555000
052523             ,B.TNDR_AMT                                          02555100
052523             ,P.KC_ACCT_SRC_CDE                                   02555200
052523             ,P.AUTH_NBR                                          02555300
052523             ,P.AUTH_SRC_CDE                                      02555400
052523             ,0.00                                                02555500
052523             ,' '                                                 02555600
052523             ,' '                                                 02555700
052523             ,' '                                                 02555800
052523             ,' '                                                 02555900
052523             ,1                                                   02556000
052523             ,' '                                                 02556100
052523             ,A.SLS_TX_AMT                                        02556200
052523             ,A.VISA_TOT_SHP_NBR                                  02556300
052523             ,'  '                                                02556400
052523             ,' '                                                 02556500
052523             ,' '                                                 02556600
052523             ,'2008-01-01-01.00.00.000000'                        02556700
052523             ,0.00                                                02556800
052523             ,'  '                                                02556900
052523             ,'   '                                               02557000
052523             ,P.TRLING_TRN_IND                                    02557100
052523             ,P.COBRND_IND                                        02557200
052523             ,P.PAYT_AMT                                          02557300
052523          FROM TEPPART D                                          02557400
052523              ,TEPTRN A                                           02557500
052523              ,TEPTND B                                           02557600
052523              ,TEPPAY P                                           02557700
052523          WHERE D.SLS_DTE = :PV-POS-CCYY-MM-DD                    02557800
052523          AND D.DB_STRUC_CDE = 'O'                                02557900
052523          AND D.STR_GP_CDE       = 'A'                            02558000
052523          AND D.PARTN_NBR = A.PARTN_NBR                           02558100
052523          AND D.PARTN_NBR = B.PARTN_NBR                           02558200
052523          AND D.PARTN_NBR = P.PARTN_NBR                           02558300
052523          AND A.STR_NBR = B.STR_NBR                               02558400
052523          AND A.STR_NBR = P.STR_NBR                               02558500
052523          AND A.RGST_ID = B.RGST_ID                               02558600
052523          AND A.RGST_ID = P.RGST_ID                               02558700
052523          AND A.TRN_NBR = B.TRN_NBR                               02558800
052523          AND A.TRN_NBR = P.TRN_NBR                               02558900
052523          AND A.STRT_TM = B.STRT_TM                               02559000
052523          AND A.STRT_TM = P.STRT_TM                               02559100
052523          AND A.SLS_CORR_SEQ_NBR = B.SLS_CORR_SEQ_NBR             02559200
052523          AND A.SLS_CORR_SEQ_NBR = P.SLS_CORR_SEQ_NBR             02559300
052523          AND A.TRN_TYP_CDE      = '30'                           02559400
052523          AND A.VOID_ABRT_CDE    = 'N'                            02559500
052523          AND B.TNDR_VOID_IND    = 'N'                            02559600
052523          AND A.TRN_STAT_CDE   = 'R'                              02559700
052523          AND ((A.POS_TYP_CDE <> '001')                           02559800
052523           OR  (A.POS_TYP_CDE IS NULL))                           02559900
052523          AND P.STTLMNT_PRCD_CDE = 'U'                            02560000
052523          AND (P.COBRND_IND     = 'Y'                             02560100
052523               OR P.TRLING_TRN_IND = 'Y')                         02560200
052523          AND NOT EXISTS                                          02560300
052523          (SELECT 1 FROM TEPTRN T1                                02560400
052523           WHERE  T1.PARTN_NBR     = A.PARTN_NBR                  02560500
052523           AND T1.SLS_DTE          = A.SLS_DTE                    02560600
052523           AND T1.PRCG_DTE         = A.PRCG_DTE                   02560700
052523           AND T1.STR_NBR          = A.STR_NBR                    02560800
052523           AND T1.RGST_ID          = A.RGST_ID                    02560900
052523           AND T1.TRN_NBR          = A.TRN_NBR                    02561000
052523           AND T1.STRT_TM          = A.STRT_TM                    02561100
052523           AND T1.TRN_TYP_CDE      = '30'                         02561200
052523           AND T1.VOID_ABRT_CDE    = 'R'                          02561300
052523           AND T1.TRN_STAT_CDE     = 'V' )                        02561400
052523      WITH UR                                                     02561600
052523     END-EXEC.                                                    02561700
016368******************************************************************02561800
016369*  CREATE CURSOR FOR EXTRACT                                      02561900
016370******************************************************************02562000
016380     EXEC SQL                                                     02562100
016390         DECLARE EXTRACT-CURSOR  CURSOR                           02563000
016400         FOR SELECT TND.PARTN_NBR                                 02570000
016500                  , TND.STR_NBR                                   02580000
016600                  , TND.RGST_ID                                   02590000
016700                  , TND.TRN_NBR                                   02600000
016800                  , TND.STRT_TM                                   02610000
016900                  , TND.SLS_CORR_SEQ_NBR                          02620000
017000                  , TND.TNDR_SEQ_NBR                              02630000
017100                  , TND.TNDR_ID                                   02640000
017200                  , TND.TNDR_AMT                                  02650000
017300                  , TND.TNDR_TYP_CDE                              02660000
017400                  , TND.TNDR_ID_SRC_CDE                           02670000
017500                  , TND.TNDR_ID_LEN_NBR                           02680000
017600                  , PRT.SLS_DTE                                   02690000
017700                  , CRD.AUTH_NBR                                  02700000
017710                  , CRD.AUTH_TYP_CDE                              02710000
017800                  , CRD.AUTH_SRC_CDE                              02720000
017900                  , CRD.CPS_TRN_ID                                02730000
018000                  , CRD.MC_CMPLIN_CDE                             02740000
018100                  , CRD.VIP_SRC_CDE                               02750000
018200                  , CRD.VIP_RSPN_CDE                              02760000
018300                  , CRD.BNKNET_NBR                                02770000
018310                  , COALESCE(EPT.AVS_RSPN_CDE,'  ')               02780000
018600                  , TRN.VOID_ABRT_CDE                             02790000
018700                  , TRN.TRN_TYP_CDE                               02800000
018800                  , TRN.TRN_DTE                                   02810000
018900                  , TRN.SLS_TX_AMT                                02820000
019000                  , XST.ST_CDE                                    02830000
019001                  , XST.E_BUS_IND                                 02840000
019003          , COALESCE(ORD.ORD_NBR, ' ')                            02850000
019010          , COALESCE(EPT.CVV_RSPN_CDE, ' ')                       02860000
019020                  , CRD.CRD_LVL_RSLT_CDE                          02870000
019030                  , CRD.NETWK_REF_ID                              02880000
019040          , COALESCE(CRD.TRSM_TMST, '2008-01-01-00.00.00.000000') 02890000
019050                  , CRD.SYS_TRC_AUD_NBR                           02900000
019060                  , COALESCE(CRD.TRK_DAT_CND_CDE,'  ')            02910000
019080                  , COALESCE(TRN.OMNI_CHNL_FFLMT_TYP_CDE,'   ')   02920000
SHIP                    , VISA_MULT_CLR_SEQ_NBR                         02930000
SHIP                    , VISA_TOT_SHP_NBR                              02940000
052523                  , CRD.TRLING_TRN_IND                            02950000
019100                FROM TEPPART  PRT                                 02960000
019200                   , TEPTND   TND                                 02970000
019400                   , TEPTRN   TRN                                 02980000
019500                   , XST_LOC  XST                                 02990000
019510                   , TEPCRD   CRD                                 03000000
019520                LEFT OUTER JOIN                                   03010000
019530                     EPT_CR_CRD_VRFN EPT                          03020000
019540                ON  CRD.PARTN_NBR  = EPT.PARTN_NBR                03030000
019550                   AND CRD.STR_NBR = EPT.STR_NBR                  03040000
019560                   AND CRD.RGST_ID = EPT.RGST_ID                  03050000
019570                   AND CRD.TRN_NBR = EPT.TRN_NBR                  03060000
019580                   AND CRD.STRT_TM = EPT.STRT_TM                  03070000
019590                   AND CRD.SLS_CORR_SEQ_NBR = EPT.SLS_CORR_SEQ_NBR03080000
019591                   AND CRD.TNDR_SEQ_NBR = EPT.TNDR_SEQ_NBR        03090000
019592                LEFT OUTER JOIN                                   03100000
019593                     TEPORD          ORD                          03110000
019594                ON  CRD.PARTN_NBR  = ORD.PARTN_NBR                03120000
019595                   AND CRD.STR_NBR = ORD.STR_NBR                  03130000
019596                   AND CRD.RGST_ID = ORD.RGST_ID                  03140000
019597                   AND CRD.TRN_NBR = ORD.TRN_NBR                  03150000
019598                   AND CRD.STRT_TM = ORD.STRT_TM                  03160000
019599                   AND CRD.SLS_CORR_SEQ_NBR = ORD.SLS_CORR_SEQ_NBR03170000
019610                WHERE PRT.SLS_DTE          = :PV-POS-CCYY-MM-DD   03180000
019700                  AND TND.PARTN_NBR        = PRT.PARTN_NBR        03190000
019800                  AND CRD.PARTN_NBR        = TND.PARTN_NBR        03200000
019900                  AND CRD.STR_NBR          = TND.STR_NBR          03210000
020000                  AND CRD.RGST_ID          = TND.RGST_ID          03220000
020100                  AND CRD.TRN_NBR          = TND.TRN_NBR          03230000
020200                  AND CRD.STRT_TM          = TND.STRT_TM          03240000
020300                  AND CRD.SLS_CORR_SEQ_NBR = TND.SLS_CORR_SEQ_NBR 03250000
020400                  AND CRD.TNDR_SEQ_NBR     = TND.TNDR_SEQ_NBR     03260000
052523            AND (TND.TNDR_TYP_CDE IN ('05', '06', '07', '08','24')03271000
052523                 OR (TND.TNDR_TYP_CDE = '04'                      03272000
052523                     AND CRD.TRLING_TRN_IND = 'Y'))               03273000
020600                  AND TRN.PARTN_NBR        = TND.PARTN_NBR        03280000
020700                  AND TRN.STR_NBR          = TND.STR_NBR          03290000
020800                  AND TRN.RGST_ID          = TND.RGST_ID          03300000
020900                  AND TRN.TRN_NBR          = TND.TRN_NBR          03310000
021000                  AND TRN.STRT_TM          = TND.STRT_TM          03320000
021100                  AND TRN.SLS_CORR_SEQ_NBR = TND.SLS_CORR_SEQ_NBR 03330000
021110                  AND XST.LOC_NBR          = TND.STR_NBR          03340000
021120                  AND TRN.VOID_ABRT_CDE   IN ('N', 'V')           03350000
021130                  AND TND.TNDR_VOID_IND    = 'N'                  03360000
021140******            AND TRN.TRN_STAT_CDE     = 'L'                  03370000
021141                  AND TRN.TRN_STAT_CDE     = 'Z'                  03380000
W10849                  AND ((TRN.POS_TYP_CDE      <>'001')             03381000
W10849                   OR (TRN.POS_TYP_CDE  IS NULL))                 03382000
021150                 UNION ALL                                        03383000
021160             SELECT PRT.PARTN_NBR                                 03384000
021170                  , TND.STR_NBR                                   03385000
021180                  , TND.RGST_ID                                   03386000
021190                  , TND.TRN_NBR                                   03387000
021200                  , TND.STRT_TM                                   03388000
021300                  , TND.SLS_CORR_SEQ_NBR                          03389000
021400                  , TND.TNDR_SEQ_NBR                              03390000
021500                  , TND.TNDR_ID                                   03400000
021600                  , TND.TNDR_AMT                                  03410000
021700                  , TND.TNDR_TYP_CDE                              03420000
021800                  , TND.TNDR_ID_SRC_CDE                           03430000
021900                  , TND.TNDR_ID_LEN_NBR                           03440000
022000                  , PRT.SLS_DTE                                   03450000
022100                  , CRD.AUTH_NBR                                  03460000
022110                  , CRD.AUTH_TYP_CDE                              03470000
022200                  , CRD.AUTH_SRC_CDE                              03480000
022300                  , CRD.CPS_TRN_ID                                03490000
022400                  , CRD.MC_CMPLIN_CDE                             03500000
022500                  , CRD.VIP_SRC_CDE                               03510000
022600                  , CRD.VIP_RSPN_CDE                              03520000
022700                  , CRD.BNKNET_NBR                                03530000
022710                  , COALESCE(EPT.AVS_RSPN_CDE,' ')                03540000
023000                  , TRN.VOID_ABRT_CDE                             03550000
023100                  , TRN.TRN_TYP_CDE                               03560000
023200                  , TRN.TRN_DTE                                   03570000
023300                  , TRN.SLS_TX_AMT                                03580000
023400                  , XST.ST_CDE                                    03590000
023410                  , XST.E_BUS_IND                                 03600000
023411          , COALESCE(ORD.ORD_NBR, ' ')                            03610000
023420          , COALESCE(EPT.CVV_RSPN_CDE, ' ')                       03620000
023421                  , CRD.CRD_LVL_RSLT_CDE                          03630000
023430                  , CRD.NETWK_REF_ID                              03640000
023441          , COALESCE(CRD.TRSM_TMST,'2008-01-01-01.00.00.000000')  03650000
023442                  , CRD.SYS_TRC_AUD_NBR                           03660000
023444                  , COALESCE(CRD.TRK_DAT_CND_CDE,'  ')            03670000
023446                  , COALESCE(TRN.OMNI_CHNL_FFLMT_TYP_CDE,'   ')   03680000
SHIP                    , VISA_MULT_CLR_SEQ_NBR                         03690000
SHIP                    , VISA_TOT_SHP_NBR                              03700000
052523                  , CRD.TRLING_TRN_IND                            03701000
023500                FROM TEPDKEY   DKEY                               03720000
023600                   , TEPPART   PRT                                03730000
023700                   , TEPTND    TND                                03740000
023900                   , TEPTRN    TRN                                03750000
024000                   , XST_LOC   XST                                03760000
024001                   , TEPCRD    CRD                                03770000
024010                LEFT OUTER JOIN                                   03780000
024020                     EPT_CR_CRD_VRFN EPT                          03790000
024030                ON  CRD.PARTN_NBR  = EPT.PARTN_NBR                03800000
024040                   AND CRD.STR_NBR = EPT.STR_NBR                  03810000
024050                   AND CRD.RGST_ID = EPT.RGST_ID                  03820000
024060                   AND CRD.TRN_NBR = EPT.TRN_NBR                  03830000
024070                   AND CRD.STRT_TM = EPT.STRT_TM                  03840000
024080                   AND CRD.SLS_CORR_SEQ_NBR = EPT.SLS_CORR_SEQ_NBR03850000
024090                   AND CRD.TNDR_SEQ_NBR = EPT.TNDR_SEQ_NBR        03860000
024091                LEFT OUTER JOIN                                   03870000
024092                     TEPORD          ORD                          03880000
024093                ON  CRD.PARTN_NBR  = ORD.PARTN_NBR                03890000
024094                   AND CRD.STR_NBR = ORD.STR_NBR                  03900000
024095                   AND CRD.RGST_ID = ORD.RGST_ID                  03910000
024096                   AND CRD.TRN_NBR = ORD.TRN_NBR                  03920000
024097                   AND CRD.STRT_TM = ORD.STRT_TM                  03930000
024098                   AND CRD.SLS_CORR_SEQ_NBR = ORD.SLS_CORR_SEQ_NBR03940000
024100                WHERE DKEY.PRCG_DTE        = :PV-POS-CCYY-MM-DD   03950000
024200                  AND PRT.SLS_DTE          = DKEY.SLS_DTE         03960000
024300                  AND TND.PARTN_NBR        = PRT.PARTN_NBR        03970000
024400                  AND TND.STR_NBR          = DKEY.STR_NBR         03980000
024500                  AND TND.RGST_ID          = DKEY.RGST_ID         03990000
024600                  AND TND.TRN_NBR          = DKEY.TRN_NBR         04000000
024700                  AND TND.STRT_TM          = DKEY.STRT_TM         04010000
024800                  AND TND.SLS_CORR_SEQ_NBR = DKEY.SLS_CORR_SEQ_NBR04020000
052523            AND (TND.TNDR_TYP_CDE IN ('05', '06', '07', '08','24')04032000
052523                 OR (TND.TNDR_TYP_CDE = '04'                      04033000
052523                     AND CRD.TRLING_TRN_IND = 'Y'))               04034000
025000                  AND TND.TNDR_VOID_IND    = 'N'                  04040000
025100                  AND CRD.PARTN_NBR        = TND.PARTN_NBR        04050000
025200                  AND CRD.STR_NBR          = TND.STR_NBR          04060000
025300                  AND CRD.RGST_ID          = TND.RGST_ID          04070000
025400                  AND CRD.TRN_NBR          = TND.TRN_NBR          04080000
025500                  AND CRD.STRT_TM          = TND.STRT_TM          04090000
025600                  AND CRD.SLS_CORR_SEQ_NBR = TND.SLS_CORR_SEQ_NBR 04100000
025700                  AND CRD.TNDR_SEQ_NBR     = TND.TNDR_SEQ_NBR     04110000
025800                  AND TRN.PARTN_NBR        = TND.PARTN_NBR        04120000
025900                  AND TRN.STR_NBR          = TND.STR_NBR          04130000
026000                  AND TRN.RGST_ID          = TND.RGST_ID          04140000
026100                  AND TRN.TRN_NBR          = TND.TRN_NBR          04150000
026200                  AND TRN.STRT_TM          = TND.STRT_TM          04160000
026300                  AND TRN.SLS_CORR_SEQ_NBR = TND.SLS_CORR_SEQ_NBR 04170000
026400                  AND XST.LOC_NBR          = TND.STR_NBR          04180000
026500                  AND TRN.VOID_ABRT_CDE   IN ('N', 'V')           04190000
026600                  AND TND.TNDR_VOID_IND    = 'N'                  04200000
026700                  AND TRN.TRN_STAT_CDE                            04210000
026800                      IN ('V','R','L')                            04220000
W10849                  AND ((TRN.POS_TYP_CDE     <> '001')             04230000
W10849                   OR (TRN.POS_TYP_CDE  IS NULL))                 04240000
CHGFIX                  WITH UR                                         04250000
026900     END-EXEC.                                                    04260000
026910*----------------------------------------------------------------*04270000
026920*    CURSOR TO OBTAIN ORIGINAL STORE AND TRANS INFO              *04280000
026930*----------------------------------------------------------------*04290000
026940     EXEC SQL                                                     04300000
026950         DECLARE ORIG-INFO-CSR CURSOR                             04310000
026960         FOR SELECT ORIG_SLS_DTE                                  04320000
026970                   ,ORIG_STR_NBR                                  04330000
026980                   ,ORIG_RGST_ID                                  04340000
026990                   ,ORIG_TRN_NBR                                  04350000
026991                   ,ORIG_STRT_TM                                  04360000
026992          FROM  TEPIRT   A                                        04370000
026993               ,XST_LOC  B                                        04380000
026994          WHERE ((A.PARTN_NBR        = :EPTND-PARTN-NBR)          04390000
026995            AND (A.STR_NBR           = :EPTND-STR-NBR)            04400000
026996            AND (A.RGST_ID           = :EPTND-RGST-ID)            04410000
026997            AND (A.TRN_NBR           = :EPTND-TRN-NBR)            04420000
026998            AND (A.STRT_TM           = :EPTND-STRT-TM)            04430000
026999            AND (A.SLS_CORR_SEQ_NBR  = :EPTND-SLS-CORR-SEQ-NBR)   04440000
027000            AND (A.ORIG_STR_NBR      = B.LOC_NBR))                04450000
027002          WITH UR                                                 04460000
027003     END-EXEC.                                                    04470000
027004******************************************************************04480000
027010                                                                  04490000
027100 PROCEDURE DIVISION.                                              04500000
027200                                                                  04510000
027300 0000-MAINLINE-PARAGRAPH.                                         04520000
027400                                                                  04530000
027500     PERFORM 1000-INITIALIZE-PROGRAM.                             04540000
052523     PERFORM 3001-OPEN-PAYMENT-CURSOR.                            04541000
052523     PERFORM 3101-FETCH-PAYMENT-CURSOR.                           04542000
052523                                                                  04543000
052523     PERFORM 2001-PROCESS-PAYMENT                                 04544000
052523           UNTIL PS-END-OF-PAYMENT.                               04545000
052523                                                                  04546000
052523     PERFORM 3301-CLOSE-PAYMENT-CURSOR.                           04547000
052523                                                                  04548000
027600     PERFORM 3000-OPEN-EXTRACT-CURSOR.                            04550000
027700                                                                  04560000
027800     PERFORM 3100-FETCH-EXTRACT-CURSOR.                           04570000
027900                                                                  04580000
028000     PERFORM 2000-PROCESS                                         04590000
028100           UNTIL PS-END-OF-EXTRACT.                               04600000
028200                                                                  04610000
028300     PERFORM 3300-CLOSE-EXTRACT-CURSOR.                           04620000
028400                                                                  04630000
028500     CLOSE DATE-CARD-FILE                                         04640000
028600           COSA-EXTRACT-FILE.                                     04650000
028700                                                                  04660000
028800     GOBACK.                                                      04670000
028900                                                                  04680000
029000******************************************************************04690000
029100* 1000-INITIALIZE-PROGRAM                                         04700000
029200*     OPEN FILES, PROCESS CONTROL CARD                            04710000
029300******************************************************************04720000
029400 1000-INITIALIZE-PROGRAM.                                         04730000
029500                                                                  04740000
029600     OPEN INPUT  DATE-CARD-FILE                                   04750000
029700          OUTPUT COSA-EXTRACT-FILE.                               04760000
029800                                                                  04770000
029900     PERFORM 1300-PROCESS-DATE-CARD.                              04780000
030000                                                                  04790000
030100     SET PS-NOT-END-OF-EXTRACT              TO TRUE.              04800000
052523     SET PS-NOT-END-OF-PAYMENT              TO TRUE.              04801000
030200                                                                  04810000
030300******************************************************************04820000
030400* 1300-PROCESS-DATE-CARD                                          04830000
030500******************************************************************04840000
030600 1300-PROCESS-DATE-CARD.                                          04850000
030700                                                                  04860000
030800     READ DATE-CARD-FILE INTO CC-CONTROL-CARD                     04870000
030900         AT END                                                   04880000
031000             SET PS-END-OF-DATE-FILE TO TRUE.                     04890000
031100                                                                  04900000
031200     IF PS-END-OF-DATE-FILE                                       04910000
031300         MOVE '1300-PROCESS-DATE-CARD'  TO PV-PARAGRAPH-NAME      04920000
031400         MOVE 'DATE CARD MISSING      ' TO PV-OPERATION-MSG-1     04930000
031500         SET AC-CONTROL-CARD-ERROR TO TRUE                        04940000
031600         PERFORM 9999-ABEND                                       04950000
031700     END-IF.                                                      04960000
031800                                                                  04970000
031900     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              04980000
032000                                                                  04990000
032100     SET  DPG51-ACTUAL-CALENDAR-ONLY   TO TRUE.                   05000000
032200     SET  DPG51-DO-NOT-INCR-DECR-DATE  TO TRUE.                   05010000
032300     SET  DPG52-LK-DTE-GREG            TO TRUE.                   05020000
032400     MOVE CC-POS-DATE-MMDDYY           TO DPG52-LK-DATE-INPUT.    05030000
032500     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    05040000
032600                                             DPG54 DPG55 DPG56.   05050000
032700     EVALUATE TRUE                                                05060000
032800         WHEN DPG54-SEVERE-ERROR                                  05070000
032900         WHEN DPG54-DATE-INVALID                                  05080000
033000             MOVE '1300-PROCESS-DATE-CARD'                        05090000
033100                                           TO PV-PARAGRAPH-NAME   05100000
033200             MOVE 'ERROR CONVERTING INPUT CARD DATE'              05110000
033300                                           TO PV-OPERATION-MSG-1  05120000
033400             SET AC-CALENDAR-ROUTINE-ERROR TO TRUE                05130000
033500             MOVE DPG54-ERROR-MESSAGE      TO PV-OPERATION-MSG-2  05140000
033600             PERFORM 9999-ABEND                                   05150000
033700     END-EVALUATE.                                                05160000
033800                                                                  05170000
033900     MOVE DPG55-DB2-ISO-DATE-FMT       TO PV-POS-CCYY-MM-DD.      05180000
034000                                                                  05190000
034100***************************************************************** 05200000
034200* 2000-PROCESS                                                    05210000
034300*      PROCESS THE CURSOR TO BUILD THE EXTRACT RECORD             05220000
034400***************************************************************** 05230000
034500  2000-PROCESS.                                                   05240000
034600                                                                  05250000
034700******************************************************************05260000
034800*  THIS COPYBOOK IS THE LAYOUT FOR THE EXTRACT FILE TO BE USED   *05270000
034900*  FOR THE LATE EXTRACT OF CREDIT TRANSACTIONS FOR SETTLEMENT    *05280000
035000*  WITH FIFTH THIRD BANK.                                        *05290000
035100******************************************************************05300000
035200     INITIALIZE TC007-EXTRACT-RECORD.                             05310000
035210     MOVE 'N' TO PV-SAVE-E-BUS-IND.                               05320000
035300                                                                  05330000
052523     MOVE EPTRN-TRN-TYP-CDE      TO TC007-TRN-TYP-CDE.            05331000
035400     MOVE EPTND-PARTN-NBR        TO TC007-PARTN-NBR.              05340000
P9696      MOVE EPTND-STR-NBR          TO TC007-ORG-STR-NBR.            05350000
035510     PERFORM 2100-CHECK-ECOMMERCE-STORE.                          05360000
035600     MOVE EPTND-RGST-ID          TO TC007-RGST-ID.                05370000
035700     MOVE EPTND-TRN-NBR          TO TC007-TRN-NBR.                05380000
035800     MOVE EPTND-STRT-TM          TO TC007-STRT-TM.                05390000
035900     MOVE EPTND-SLS-CORR-SEQ-NBR TO TC007-SLS-CORR-SEQ-NBR.       05400000
036000     MOVE EPTND-TNDR-SEQ-NBR     TO TC007-TNDR-SEQ-NBR.           05410000
036100     MOVE EPTND-TNDR-ID          TO TC007-TNDR-ID.                05420000
036200     MOVE EPTND-TNDR-AMT         TO TC007-TNDR-AMT.               05430000
036300     MOVE EPTND-TNDR-TYP-CDE     TO TC007-TNDR-TYP-CDE.           05440000
036400     MOVE EPTND-TNDR-ID-SRC-CDE  TO TC007-TNDR-ID-SRC-CDE.        05450000
036500     MOVE EPTND-TNDR-ID-LEN-NBR  TO TC007-TNDR-ID-LEN-NBR.        05460000
036600     MOVE EPPART-SLS-DTE         TO TC007-SLS-DTE.                05470000
036700     MOVE EPTRN-TRN-DTE          TO TC007-TRN-DTE.                05480000
036800     MOVE EPCRD-AUTH-NBR         TO TC007-AUTH-NBR.               05490000
036810     MOVE EPCRD-AUTH-TYP-CDE     TO TC007-AUTH-TYP-CDE.           05500000
036900     MOVE EPCRD-AUTH-SRC-CDE     TO TC007-AUTH-SRC-CDE.           05510000
037000     MOVE EPCRD-CPS-TRN-ID       TO TC007-CPS-TRN-ID.             05520000
037100     MOVE EPCRD-MC-CMPLIN-CDE    TO TC007-MC-CMPLIN-CDE.          05530000
037200     MOVE EPCRD-VIP-SRC-CDE      TO TC007-VIP-SRC-CDE.            05540000
037300     MOVE EPCRD-VIP-RSPN-CDE     TO TC007-VIP-RSPN-CDE.           05550000
037400     MOVE EPCRD-BNKNET-NBR       TO TC007-BNKNET-NBR.             05560000
037500     MOVE EPT00056-AVS-RSPN-CDE  TO TC007-AVS-RSPN-CDE.           05570000
037700     MOVE EPTRN-VOID-ABRT-CDE    TO TC007-VOID-ABRT-CDE.          05580000
037800     MOVE EPTRN-TRN-TYP-CDE      TO TC007-TRN-TYP-CDE.            05590000
037801     MOVE XST00001-ST-CDE        TO TC007-STATE-CODE.             05600000
037802     MOVE EPT00056-CVV-RSPN-CDE  TO TC007-CVV-RSPN-CDE.           05610000
037803     MOVE SPACES                 TO PV-CRD-LVL-RSLT-CDE.          05620000
037804     MOVE EPCRD-CRD-LVL-RSLT-CDE TO PV-CRD-LVL-RSLT-CDE.          05630000
037805     IF PV-CRD-LVL-RSLT-CDE-1 = SPACES AND                        05640000
037806        PV-CRD-LVL-RSLT-CDE-2 NOT = SPACES                        05650000
037807       MOVE PV-CRD-LVL-RSLT-CDE-2 TO PV-CRD-LVL-RSLT-CDE-1        05660000
037808       MOVE SPACES                TO PV-CRD-LVL-RSLT-CDE-2        05670000
037809       MOVE PV-CRD-LVL-RSLT-CDE  TO TC007-CRD-LVL-RSLT-CDE        05680000
037810     ELSE                                                         05690000
037811       MOVE PV-CRD-LVL-RSLT-CDE  TO TC007-CRD-LVL-RSLT-CDE        05700000
037812     END-IF.                                                      05710000
037817     IF PV-SAVE-E-BUS-IND = 'Y'                                   05720000
037818        MOVE SPACES              TO TC007-AVS-RSPN-CDE            05730000
037819                                    TC007-CRD-LVL-RSLT-CDE        05740000
037820                                    TC007-CVV-RSPN-CDE            05750000
037821     END-IF.                                                      05760000
037822     MOVE EPCRD-NETWK-REF-ID     TO TC007-NETWK-REF-ID.           05770000
037823     IF EPCRD-TRSM-TMST = '2008-01-01-01.00.00.000000'            05780000
037824         MOVE SPACES TO TC007-TRSM-TMST                           05790000
037825     ELSE                                                         05800000
037826         MOVE EPCRD-TRSM-TMST    TO TC007-TRSM-TMST               05810000
037827     END-IF.                                                      05820000
037828     MOVE EPCRD-SYS-TRC-AUD-NBR  TO TC007-SYS-TRC-AUD-NBR.        05830000
037829     MOVE EPCRD-TRK-DAT-CND-CDE  TO TC007-TRK-DAT-CND-CDE.        05840000
037837     IF PV-SAVE-E-BUS-IND = 'Y'                                   05850000
037838         MOVE 'Y' TO  TC007-E-BUS-IND                             05860000
037839     ELSE                                                         05870000
037840         MOVE 'N' TO  TC007-E-BUS-IND                             05880000
037841     END-IF.                                                      05890000
037842     MOVE EPTRN-OMNI-CHNL-FFLMT-TYP-CDE TO                        05900000
037843                                  TC007-OMNI-CHNL-FFLMT-TYP-CDE.  05910000
SHIP       MOVE EPTRN-VISA-MULT-CLR-SEQ-NBR TO                          05920000
SHIP                                    TC007-VISA-MULT-CLR-SEQ-NBR.    05930000
SHIP       MOVE EPTRN-VISA-TOT-SHP-NBR TO TC007-VISA-TOT-SHP-NBR.       05940000
052523     MOVE EPCRD-TRLING-TRN-IND   TO TC007-TRLING-TRN-IND.         05940100
052523     MOVE EPPAY-COBRND-IND       TO TC007-COBRAND-PYMT-IND.       05940200
SHIP2      MOVE SPACES                 TO TC007-PAR-SHIP-IND.           05941000
SHIP  * SET A SWITCH TO INDICATE OMNI TYPE ORDERS                       05950000
SHIP       IF EPTRN-OMNI-CHNL-FFLMT-TYP-CDE = SPACES OR                 05960000
SHIP          EPTRN-OMNI-CHNL-FFLMT-TYP-CDE = 'SFS' OR                  05961000
SHIP          EPTRN-OMNI-CHNL-FFLMT-TYP-CDE = 'SDD'                     05962000
SHIP             SET PV-SHIP-TO-HOME TO TRUE                            05963000
SHIP       ELSE                                                         05964000
SHIP             SET PV-OMNI-BPS-BOS TO TRUE                            05965000
SHIP       END-IF.                                                      05966000
SHIP       MOVE PV-FULFILLMENT-TYPE    TO TC007-FULFILLMENT-TYPE.       05967000
SHIP                                                                    05968000
037845* ****************************************************************05969300
037846*    AT THIS TIME WE ARE TAKING ENTIRE SLS TAX AMOUNT.  THIS MAY  05969400
037847*    HAVE TO BE CHANGED FOR SPLIT TENDERS                         05969500
037848* ****************************************************************05969600
037849     MOVE EPTRN-SLS-TX-AMT       TO TC007-SLS-TX-AMT.             05969700
037850                                                                  05969800
037851     PERFORM 4000-WRITE-EXTRACT-FILE.                             05969900
037852                                                                  05970000
037853     PERFORM 3100-FETCH-EXTRACT-CURSOR.                           05980000
037854                                                                  05990000
052523***************************************************************** 05991000
052523* 2001-PROCESS-PAYMENT                                            05992000
052523*      PROCESS THE CURSOR TO BUILD THE EXTRACT RECORD             05993000
052523***************************************************************** 05994000
052523  2001-PROCESS-PAYMENT.                                           05995000
052523                                                                  05996000
052523******************************************************************05997000
052523*  THIS COPYBOOK IS THE LAYOUT FOR THE EXTRACT FILE TO BE USED   *05998000
052523*  FOR THE LATE EXTRACT OF CREDIT TRANSACTIONS FOR SETTLEMENT    *05999000
052523*  WITH FIFTH THIRD BANK.                                        *05999100
052523******************************************************************05999200
052523     INITIALIZE TC007-EXTRACT-RECORD.                             05999300
052523     MOVE 'N' TO PV-SAVE-E-BUS-IND.                               05999400
052523                                                                  05999500
052523     MOVE EPTRN-TRN-TYP-CDE      TO TC007-TRN-TYP-CDE.            05999600
052523     MOVE EPTND-PARTN-NBR        TO TC007-PARTN-NBR.              05999700
052523     MOVE EPTND-STR-NBR          TO TC007-ORG-STR-NBR.            05999800
052523     PERFORM 2100-CHECK-ECOMMERCE-STORE.                          05999900
052523     MOVE EPTND-RGST-ID          TO TC007-RGST-ID.                06000000
052523     MOVE EPTND-TRN-NBR          TO TC007-TRN-NBR.                06000100
052523     MOVE EPTND-STRT-TM          TO TC007-STRT-TM.                06000200
052523     MOVE EPTND-SLS-CORR-SEQ-NBR TO TC007-SLS-CORR-SEQ-NBR.       06000300
052523     MOVE EPTND-TNDR-SEQ-NBR     TO TC007-TNDR-SEQ-NBR.           06000400
052523     MOVE EPTND-TNDR-ID          TO TC007-TNDR-ID.                06000500
052523     MOVE EPTND-TNDR-AMT         TO TC007-TNDR-AMT.               06000600
052523     MOVE EPTND-TNDR-TYP-CDE     TO TC007-TNDR-TYP-CDE.           06000700
052523     MOVE EPTND-TNDR-ID-SRC-CDE  TO TC007-TNDR-ID-SRC-CDE.        06000800
052523     MOVE EPTND-TNDR-ID-LEN-NBR  TO TC007-TNDR-ID-LEN-NBR.        06000900
052523     MOVE EPPART-SLS-DTE         TO TC007-SLS-DTE.                06001000
052523     MOVE EPTRN-TRN-DTE          TO TC007-TRN-DTE.                06001100
052523     MOVE EPCRD-AUTH-NBR         TO TC007-AUTH-NBR.               06001200
052523     MOVE EPCRD-AUTH-TYP-CDE     TO TC007-AUTH-TYP-CDE.           06001300
052523     MOVE EPCRD-AUTH-SRC-CDE     TO TC007-AUTH-SRC-CDE.           06001400
052523     MOVE EPCRD-CPS-TRN-ID       TO TC007-CPS-TRN-ID.             06001500
052523     MOVE EPCRD-MC-CMPLIN-CDE    TO TC007-MC-CMPLIN-CDE.          06001600
052523     MOVE EPCRD-VIP-SRC-CDE      TO TC007-VIP-SRC-CDE.            06001700
052523     MOVE EPCRD-VIP-RSPN-CDE     TO TC007-VIP-RSPN-CDE.           06001800
052523     MOVE EPCRD-BNKNET-NBR       TO TC007-BNKNET-NBR.             06001900
052523     MOVE EPT00056-AVS-RSPN-CDE  TO TC007-AVS-RSPN-CDE.           06002000
052523     MOVE EPTRN-VOID-ABRT-CDE    TO TC007-VOID-ABRT-CDE.          06002100
052523     MOVE EPTRN-TRN-TYP-CDE      TO TC007-TRN-TYP-CDE.            06002200
052523     MOVE XST00001-ST-CDE        TO TC007-STATE-CODE.             06002300
052523     MOVE EPT00056-CVV-RSPN-CDE  TO TC007-CVV-RSPN-CDE.           06002400
052523     MOVE SPACES                 TO PV-CRD-LVL-RSLT-CDE.          06002500
052523     MOVE EPCRD-CRD-LVL-RSLT-CDE TO PV-CRD-LVL-RSLT-CDE.          06002600
052523     IF PV-CRD-LVL-RSLT-CDE-1 = SPACES AND                        06002700
052523        PV-CRD-LVL-RSLT-CDE-2 NOT = SPACES                        06002800
052523       MOVE PV-CRD-LVL-RSLT-CDE-2 TO PV-CRD-LVL-RSLT-CDE-1        06002900
052523       MOVE SPACES                TO PV-CRD-LVL-RSLT-CDE-2        06003000
052523       MOVE PV-CRD-LVL-RSLT-CDE  TO TC007-CRD-LVL-RSLT-CDE        06003100
052523     ELSE                                                         06003200
052523       MOVE PV-CRD-LVL-RSLT-CDE  TO TC007-CRD-LVL-RSLT-CDE        06003300
052523     END-IF.                                                      06003400
052523     IF PV-SAVE-E-BUS-IND = 'Y'                                   06003500
052523        MOVE SPACES              TO TC007-AVS-RSPN-CDE            06003600
052523                                    TC007-CRD-LVL-RSLT-CDE        06003700
052523                                    TC007-CVV-RSPN-CDE            06003800
052523     END-IF.                                                      06003900
052523     MOVE EPCRD-NETWK-REF-ID     TO TC007-NETWK-REF-ID.           06004000
052523     IF EPCRD-TRSM-TMST = '2008-01-01-01.00.00.000000'            06004100
052523         MOVE SPACES TO TC007-TRSM-TMST                           06004200
052523     ELSE                                                         06004300
052523         MOVE EPCRD-TRSM-TMST    TO TC007-TRSM-TMST               06004400
052523     END-IF.                                                      06004500
052523     MOVE EPCRD-SYS-TRC-AUD-NBR  TO TC007-SYS-TRC-AUD-NBR.        06004600
052523     MOVE EPCRD-TRK-DAT-CND-CDE  TO TC007-TRK-DAT-CND-CDE.        06004700
052523     IF PV-SAVE-E-BUS-IND = 'Y'                                   06004800
052523         MOVE 'Y' TO  TC007-E-BUS-IND                             06004900
052523     ELSE                                                         06005000
052523         MOVE 'N' TO  TC007-E-BUS-IND                             06005100
052523     END-IF.                                                      06005200
052523     MOVE EPTRN-OMNI-CHNL-FFLMT-TYP-CDE TO                        06005300
052523                                  TC007-OMNI-CHNL-FFLMT-TYP-CDE.  06005400
052523     MOVE EPTRN-VISA-MULT-CLR-SEQ-NBR TO                          06005500
052523                                  TC007-VISA-MULT-CLR-SEQ-NBR.    06005600
052523     MOVE EPTRN-VISA-TOT-SHP-NBR TO TC007-VISA-TOT-SHP-NBR.       06005700
052523     MOVE EPCRD-TRLING-TRN-IND   TO TC007-TRLING-TRN-IND.         06005800
052523     MOVE EPPAY-COBRND-IND       TO TC007-COBRAND-PYMT-IND.       06005900
052523     MOVE SPACES                 TO TC007-PAR-SHIP-IND.           06006000
052523* SET A SWITCH TO INDICATE OMNI TYPE ORDERS                       06006100
052523     IF EPTRN-OMNI-CHNL-FFLMT-TYP-CDE = SPACES OR                 06006200
052523        EPTRN-OMNI-CHNL-FFLMT-TYP-CDE = 'SFS' OR                  06006300
052523        EPTRN-OMNI-CHNL-FFLMT-TYP-CDE = 'SDD'                     06006400
052523           SET PV-SHIP-TO-HOME TO TRUE                            06006500
052523     ELSE                                                         06006600
052523           SET PV-OMNI-BPS-BOS TO TRUE                            06006700
052523     END-IF.                                                      06006800
052523     MOVE PV-FULFILLMENT-TYPE    TO TC007-FULFILLMENT-TYPE.       06006900
052523                                                                  06007000
052523* ****************************************************************06007100
052523*    AT THIS TIME WE ARE TAKING ENTIRE SLS TAX AMOUNT.  THIS MAY  06007200
052523*    HAVE TO BE CHANGED FOR SPLIT TENDERS                         06007300
052523* ****************************************************************06007400
052523     MOVE EPTRN-SLS-TX-AMT       TO TC007-SLS-TX-AMT.             06007500
052523                                                                  06007600
052523     PERFORM 4000-WRITE-EXTRACT-FILE.                             06007700
052523                                                                  06007800
052523     PERFORM 3101-FETCH-PAYMENT-CURSOR.                           06007900
052523                                                                  06008000
037855******************************************************************06009000
037856*    CHECK IF ECOMMERCE STORE                                    *06010000
037857******************************************************************06020000
037858 2100-CHECK-ECOMMERCE-STORE.                                      06030000
037859                                                                  06040000
037870     IF XST00001-E-BUS-IND = 'Y' OR                               06050000
037871       EPTRN-OMNI-CHNL-FFLMT-TYP-CDE NOT EQUAL SPACES             06060000
037888         MOVE '873' TO TC007-STR-NBR                              06070000
037889         MOVE 'Y' TO  PV-SAVE-E-BUS-IND                           06080000
037890         PERFORM 2150-SELECT-TEPORD                               06090000
P9696          IF SQLCODE = 0                                           06100000
TEST            SET PS-TEPCRR-NOT-FOUND TO TRUE                         06110000
P9696           PERFORM 2160-SELECT-TEPCRR                              06120000
TEST            IF PS-TEPCRR-NOT-FOUND                                  06130000
TEST                PERFORM 2910-SELECT-TEPCRR-WO-TNDR-SEQ              06140000
TEST                IF PS-TEPCRR-NOT-FOUND                              06150000
TEST                    MOVE SPACES TO TC007-AUTH-REF-NBR               06160000
TEST                END-IF                                              06170000
TEST            END-IF                                                  06180000
P9696          END-IF                                                   06190000
037891         MOVE EPORD-ORD-NBR-TEXT (1:EPORD-ORD-NBR-LEN)            06200000
037892                           TO  TC007-ECOMM-ORD-NBR                06210000
037893         MOVE SPACES TO TC007-AVS-RSPN-CDE                        06220000
037894                        TC007-CVV-RSPN-CDE                        06230000
037896     ELSE                                                         06240000
037897         MOVE EPTND-STR-NBR TO TC007-STR-NBR                      06250000
037898         MOVE 'N'           TO PV-SAVE-E-BUS-IND                  06260000
037899     END-IF.                                                      06270000
037900                                                                  06280000
037969******************************************************************06290000
037970*    SELECT-TEPORD.                                              *06300000
037971******************************************************************06310000
037972 2150-SELECT-TEPORD.                                              06320000
037973                                                                  06330000
037974     EXEC SQL                                                     06340000
037975          SELECT ORD_NBR                                          06350000
037976          INTO  :EPORD-ORD-NBR                                    06360000
037977          FROM  TEPORD                                            06370000
037978          WHERE ((PARTN_NBR   = :EPTND-PARTN-NBR)                 06380000
037979            AND  (STR_NBR     = :EPTND-STR-NBR)                   06390000
037980            AND  (RGST_ID     = :EPTND-RGST-ID)                   06400000
037981            AND  (TRN_NBR     = :EPTND-TRN-NBR)                   06410000
*FIX**            AND  (STRT_TM     = :EPTND-STRT-TM)                   06420000
*FIX**            AND  (SLS_CORR_SEQ_NBR  = :EPTND-SLS-CORR-SEQ-NBR))   06430000
037984             WITH UR                                              06440000
037985     END-EXEC.                                                    06450000
037986                                                                  06460000
037987     EVALUATE TRUE                                                06470000
037988         WHEN SQLCODE EQUAL ZERO                                  06480000
037989             MOVE EPORD-ORD-NBR-TEXT (1:EPORD-ORD-NBR-LEN) TO     06490000
037990                                 TC007-ECOMM-ORD-NBR              06500000
037991         WHEN SQLCODE EQUAL +100                                  06510000
037992             MOVE SPACES TO TC007-ECOMM-ORD-NBR                   06520000
037993         WHEN OTHER                                               06530000
037994             MOVE '2150-SELECT-TEPORD'                            06540000
037995                                            TO PV-PARAGRAPH-NAME  06550000
037996             MOVE 'SELECT FROM TEPORD  '                          06560000
037997                                            TO PV-DB2-OPERATION   06570000
037998             DISPLAY 'PARTITION NBR     : ' EPTND-PARTN-NBR       06580000
037999             DISPLAY 'STORE NUMBER      : ' EPTND-STR-NBR         06590000
038000             DISPLAY 'REGISTER ID       : ' EPTND-RGST-ID         06600000
038001             DISPLAY 'TRANSACTION NUMBER: ' EPTND-TRN-NBR         06610000
038002             DISPLAY 'START TIME        : ' EPTND-STRT-TM         06620000
038003             DISPLAY 'SALES CORR SEQ NBR: ' EPTND-SLS-CORR-SEQ-NBR06630000
038004             PERFORM 9100-SQL-ABEND                               06640000
038005     END-EVALUATE.                                                06650000
038006                                                                  06660000
P9696 ******************************************************************06670000
P9696 *    2160-SELECT-TEPCRR.                                         *06680000
P9696 *    SELECT TEPCRR FOR AUTH REF NBR                              *06690000
P9696 ******************************************************************06700000
P9696  2160-SELECT-TEPCRR.                                              06710000
P9696                                                                   06720000
P9696      EXEC SQL                                                     06730000
P9696           SELECT AUTH_REF_NBR                                     06740000
P9696           INTO :EPCRR-AUTH-REF-NBR                                06750000
C03486          FROM  TEPCRR A                                          06760000
C03486          WHERE A.PARTN_NBR        = :EPTND-PARTN-NBR             06770000
C03486            AND A.STR_NBR          = :EPTND-STR-NBR               06780000
C03486            AND A.RGST_ID          = :EPTND-RGST-ID               06790000
C03486            AND A.TRN_NBR          = :EPTND-TRN-NBR               06800000
C03486            AND A.STRT_TM          = :EPTND-STRT-TM               06810000
C03486            AND A.TNDR_SEQ_NBR     = :EPTND-TNDR-SEQ-NBR          06820000
C03486            AND A.SLS_CORR_SEQ_NBR =                              06830000
C03486               (SELECT MAX(B.SLS_CORR_SEQ_NBR)                    06840000
C03486                FROM TEPCRR B                                     06850000
C03486                WHERE A.PARTN_NBR = B.PARTN_NBR                   06860000
C03486                  AND A.STR_NBR   = B.STR_NBR                     06870000
C03486                  AND A.RGST_ID   = B.RGST_ID                     06880000
C03486                  AND A.TRN_NBR   = B.TRN_NBR                     06890000
C03486                  AND A.STRT_TM   = B.STRT_TM                     06900000
C03486                  AND A.TNDR_SEQ_NBR = B.TNDR_SEQ_NBR)            06910000
CHGFIX          WITH UR                                                 06920000
P9696      END-EXEC.                                                    06930000
P9696                                                                   06940000
P9696      EVALUATE TRUE                                                06950000
P9696          WHEN SQLCODE = 0                                         06960000
P9696            MOVE EPCRR-AUTH-REF-NBR-TEXT (1:EPCRR-AUTH-REF-NBR-LEN)06970000
P9696                                TO TC007-AUTH-REF-NBR              06980000
TEST             SET PS-TEPCRR-FOUND TO TRUE                            06990000
TEST           WHEN SQLCODE = +100                                      07000000
TEST               SET PS-TEPCRR-NOT-FOUND TO TRUE                      07010000
P9696          WHEN SQLWARN0 NOT EQUAL SPACE                            07020000
P9696          WHEN SQLCODE NOT EQUAL ZERO                              07030000
P9696              MOVE '2160-SELECT-TEPCRR'                            07040000
P9696                                             TO PV-PARAGRAPH-NAME  07050000
P9696              MOVE 'TO SELECT FROM TEPCRR  '                       07060000
P9696                                             TO PV-DB2-OPERATION   07070000
P9696              DISPLAY 'PARTITION NBR     : ' EPTND-PARTN-NBR       07080000
P9696              DISPLAY 'STORE NBR  :  '    EPTND-STR-NBR            07090000
P9696              DISPLAY 'REGISTER ID:  '    EPTND-RGST-ID            07100000
P9696              DISPLAY 'TRANS NBR  :  '    EPTND-TRN-NBR            07110000
P9696              DISPLAY 'START TIME :  '    EPTND-STRT-TM            07120000
P9696              DISPLAY 'SALES CORR SEQ NBR: ' EPTND-SLS-CORR-SEQ-NBR07130000
P9696              PERFORM 9100-SQL-ABEND                               07140000
P9696      END-EVALUATE.                                                07150000
P9696                                                                   07160000
TEST  ******************************************************************07170000
TEST  *    SELECT TEPCRR FOR AUTH REF NBR WO TNDR-SEQ-NBR              *07180000
TEST  ******************************************************************07190000
TEST   2910-SELECT-TEPCRR-WO-TNDR-SEQ.                                  07200000
TEST                                                                    07210000
TEST       EXEC SQL                                                     07220000
TEST            SELECT AUTH_REF_NBR                                     07230000
TEST            INTO :EPCRR-AUTH-REF-NBR                                07240000
TEST            FROM  TEPCRR A                                          07250000
TEST            WHERE A.PARTN_NBR        =  :EPTND-PARTN-NBR            07260000
TEST              AND  A.STR_NBR          = :EPTND-STR-NBR              07270000
TEST              AND  A.RGST_ID          = :EPTND-RGST-ID              07280000
TEST              AND  A.TRN_NBR          = :EPTND-TRN-NBR              07290000
TEST              AND  A.STRT_TM          = :EPTND-STRT-TM              07300000
TEST              AND  A.TNDR_SEQ_NBR     =                             07310000
TEST                 (SELECT MAX(C.TNDR_SEQ_NBR)                        07320000
TEST                  FROM TEPCRR C                                     07330000
TEST                  WHERE A.PARTN_NBR = C.PARTN_NBR                   07340000
TEST                    AND A.STR_NBR   = C.STR_NBR                     07350000
TEST                    AND A.RGST_ID   = C.RGST_ID                     07360000
TEST                    AND A.TRN_NBR   = C.TRN_NBR                     07370000
TEST                    AND A.STRT_TM   = C.STRT_TM)                    07380000
TEST              AND  A.SLS_CORR_SEQ_NBR =                             07390000
TEST                 (SELECT MAX(B.SLS_CORR_SEQ_NBR)                    07400000
TEST                  FROM TEPCRR B                                     07410000
TEST                  WHERE A.PARTN_NBR = B.PARTN_NBR                   07420000
TEST                    AND A.STR_NBR   = B.STR_NBR                     07430000
TEST                    AND A.RGST_ID   = B.RGST_ID                     07440000
TEST                    AND A.TRN_NBR   = B.TRN_NBR                     07450000
TEST                    AND A.STRT_TM   = B.STRT_TM                     07460000
TEST                    AND A.TNDR_SEQ_NBR = B.TNDR_SEQ_NBR)            07470000
TEST                WITH UR                                             07480000
TEST       END-EXEC.                                                    07490000
TEST                                                                    07500000
TEST       EVALUATE TRUE                                                07510000
TEST           WHEN SQLCODE = 0                                         07520000
TEST             MOVE EPCRR-AUTH-REF-NBR-TEXT (1:EPCRR-AUTH-REF-NBR-LEN)07530000
TEST                                 TO TC007-AUTH-REF-NBR              07540000
TEST             SET PS-TEPCRR-FOUND TO TRUE                            07550000
TEST           WHEN SQLCODE = +100                                      07560000
TEST               SET PS-TEPCRR-NOT-FOUND TO TRUE                      07570000
TEST           WHEN SQLWARN0 NOT EQUAL SPACE                            07580000
TEST           WHEN SQLCODE NOT EQUAL ZERO                              07590000
TEST               MOVE '2910-SELECT-TEPCRR-WO-TNDR-SEQ'                07600000
TEST                                              TO PV-PARAGRAPH-NAME  07610000
TEST               MOVE 'TO SELECT FROM TEPCRR  '                       07620000
TEST                                              TO PV-OPERATION-MSG-1 07630000
TEST               DISPLAY 'STORE NBR  :  '    EPTND-STR-NBR            07640000
TEST               DISPLAY 'REGISTER ID:  '    EPTND-RGST-ID            07650000
TEST               DISPLAY 'TRANS NBR  :  '    EPTND-TRN-NBR            07660000
TEST               DISPLAY 'START TIME :  '    EPTND-STRT-TM            07670000
TEST               PERFORM 9100-SQL-ABEND                               07680000
TEST       END-EVALUATE.                                                07690000
TEST                                                                    07700000
038088******************************************************************07710000
038089* 3000-OPEN-EXTRACT-CURSOR.                                       07720000
038090*     OPEN EXTRACT CURSOR                                         07730000
038091******************************************************************07740000
038092 3000-OPEN-EXTRACT-CURSOR.                                        07750000
038093                                                                  07760000
038094     EXEC SQL                                                     07770000
038095          OPEN EXTRACT-CURSOR                                     07780000
038096     END-EXEC.                                                    07790000
038100                                                                  07800000
038200     EVALUATE TRUE                                                07810000
038300         WHEN SQLCODE = ZERO                                      07820000
038400              CONTINUE                                            07830000
038500         WHEN SQLWARN0 NOT EQUAL SPACE                            07840000
038600         WHEN SQLCODE NOT EQUAL ZERO                              07850000
038700             MOVE '3000-OPEN-EXTRACT-CURSOR'                      07860000
038800                                            TO PV-PARAGRAPH-NAME  07870000
038900             MOVE 'ERROR ON OPEN OF EXTRACT-CURSOR'               07880000
039000                                            TO PV-DB2-OPERATION   07890000
039100             PERFORM 9100-SQL-ABEND                               07900000
039200     END-EVALUATE.                                                07910000
039300                                                                  07920000
052523******************************************************************07921000
052523* 3001-OPEN-PAYMENT-CURSOR.                                       07922000
052523*     OPEN PAYMENT CURSOR                                         07923000
052523******************************************************************07924000
052523 3001-OPEN-PAYMENT-CURSOR.                                        07925000
052523                                                                  07926000
052523     EXEC SQL                                                     07927000
052523          OPEN PAYMENT-CURSOR                                     07928000
052523     END-EXEC.                                                    07929000
052523                                                                  07929100
052523     EVALUATE TRUE                                                07929200
052523         WHEN SQLCODE = ZERO                                      07929300
052523              CONTINUE                                            07929400
052523         WHEN SQLWARN0 NOT EQUAL SPACE                            07929500
052523         WHEN SQLCODE NOT EQUAL ZERO                              07929600
052523             MOVE '3001-OPEN-PAYMENT-CURSOR'                      07929700
052523                                            TO PV-PARAGRAPH-NAME  07929800
052523             MOVE 'ERROR ON OPEN OF PAYMENT-CURSOR'               07929900
052523                                            TO PV-DB2-OPERATION   07930000
052523             PERFORM 9100-SQL-ABEND                               07930100
052523     END-EVALUATE.                                                07930200
052523                                                                  07930300
039400******************************************************************07931000
039500* 3100-FETCH-EXTRACT-CURSOR                                       07940000
039600******************************************************************07950000
039700 3100-FETCH-EXTRACT-CURSOR.                                       07960000
039800                                                                  07970000
039900     EXEC SQL                                                     07980000
040000          FETCH EXTRACT-CURSOR                                    07990000
040100           INTO :EPTND-PARTN-NBR                                  08000000
040200               ,:EPTND-STR-NBR                                    08010000
040300               ,:EPTND-RGST-ID                                    08020000
040400               ,:EPTND-TRN-NBR                                    08030000
040500               ,:EPTND-STRT-TM                                    08040000
040600               ,:EPTND-SLS-CORR-SEQ-NBR                           08050000
040700               ,:EPTND-TNDR-SEQ-NBR                               08060000
040800               ,:EPTND-TNDR-ID                                    08070000
040900               ,:EPTND-TNDR-AMT                                   08080000
041000               ,:EPTND-TNDR-TYP-CDE                               08090000
041100               ,:EPTND-TNDR-ID-SRC-CDE                            08100000
041200               ,:EPTND-TNDR-ID-LEN-NBR                            08110000
041300               ,:EPPART-SLS-DTE                                   08120000
041400               ,:EPCRD-AUTH-NBR                                   08130000
041410               ,:EPCRD-AUTH-TYP-CDE                               08140000
041500               ,:EPCRD-AUTH-SRC-CDE                               08150000
041600               ,:EPCRD-CPS-TRN-ID                                 08160000
041700               ,:EPCRD-MC-CMPLIN-CDE                              08170000
041800               ,:EPCRD-VIP-SRC-CDE                                08180000
041900               ,:EPCRD-VIP-RSPN-CDE                               08190000
042000               ,:EPCRD-BNKNET-NBR                                 08200000
042100               ,:EPT00056-AVS-RSPN-CDE                            08210000
042300               ,:EPTRN-VOID-ABRT-CDE                              08220000
042400               ,:EPTRN-TRN-TYP-CDE                                08230000
042500               ,:EPTRN-TRN-DTE                                    08240000
042600               ,:EPTRN-SLS-TX-AMT                                 08250000
042700               ,:XST00001-ST-CDE                                  08260000
042701               ,:XST00001-E-BUS-IND                               08270000
042702               ,:EPORD-ORD-NBR                                    08280000
042710               ,:EPT00056-CVV-RSPN-CDE                            08290000
042720               ,:EPCRD-CRD-LVL-RSLT-CDE                           08300000
042730               ,:EPCRD-NETWK-REF-ID                               08310000
042740               ,:EPCRD-TRSM-TMST                                  08320000
042750               ,:EPCRD-SYS-TRC-AUD-NBR                            08330000
042760               ,:EPCRD-TRK-DAT-CND-CDE                            08340000
042770               ,:EPTRN-OMNI-CHNL-FFLMT-TYP-CDE                    08350000
SHIP                 ,:EPTRN-VISA-MULT-CLR-SEQ-NBR                      08360000
SHIP                 ,:EPTRN-VISA-TOT-SHP-NBR                           08370000
052523               ,:EPCRD-TRLING-TRN-IND                             08380000
042800     END-EXEC.                                                    08390000
042900                                                                  08400000
043000     EVALUATE TRUE                                                08410000
043100         WHEN SQLCODE = ZERO                                      08420000
052523              IF EPTND-TNDR-TYP-CDE = '04'                        08431000
052523                  MOVE '24' TO EPTND-TNDR-TYP-CDE                 08432000
052523              END-IF                                              08433000
043300                                                                  08440000
043310**       WHEN SQLCODE = -305                                      08450000
043320**            CONTINUE                                            08460000
043330                                                                  08470000
043400         WHEN SQLCODE = PC-ROW-NOT-FOUND                          08480000
043500             SET PS-END-OF-EXTRACT          TO TRUE               08490000
043600         WHEN SQLWARN0 NOT EQUAL SPACE                            08500000
043700         WHEN SQLCODE NOT EQUAL ZERO                              08510000
043800             MOVE '3100-FETCH-EXTRACT-CURSOR'                     08520000
043900                                            TO PV-PARAGRAPH-NAME  08530000
044000             MOVE 'ERROR ON FETCH OF EXTRACT-CURSOR'              08540000
044100                                            TO PV-DB2-OPERATION   08550000
044200             PERFORM 9100-SQL-ABEND                               08560000
044300     END-EVALUATE.                                                08570000
044400                                                                  08580000
052523******************************************************************08581000
052523* 3101-FETCH-PAYMENT-CURSOR                                       08582000
052523******************************************************************08583000
052523 3101-FETCH-PAYMENT-CURSOR.                                       08584000
052523                                                                  08585000
052523     EXEC SQL                                                     08586000
052523          FETCH PAYMENT-CURSOR                                    08587000
052523           INTO :EPTND-PARTN-NBR                                  08588000
052523               ,:EPTND-STR-NBR                                    08589000
052523               ,:EPTND-RGST-ID                                    08589100
052523               ,:EPTND-TRN-NBR                                    08589200
052523               ,:EPTND-STRT-TM                                    08589300
052523               ,:EPTND-SLS-CORR-SEQ-NBR                           08589400
052523               ,:EPTRN-TRN-TYP-CDE                                08589500
052523               ,:EPPART-SLS-DTE                                   08589600
052523               ,:EPTRN-TRN-DTE                                    08589700
052523               ,:EPTRN-VOID-ABRT-CDE                              08589800
052523               ,:EPTND-TNDR-SEQ-NBR                               08589900
052523               ,:EPTND-TNDR-TYP-CDE                               08590000
052523               ,:EPPAY-KC-ACCT-NBR                                08590100
052523               ,:EPTND-TNDR-AMT                                   08590200
052523               ,:EPPAY-KC-ACCT-SRC-CDE                            08590300
052523               ,:EPPAY-AUTH-NBR                                   08590400
052523               ,:EPPAY-AUTH-SRC-CDE                               08590500
052523               ,:EPCRD-CPS-TRN-ID                                 08590600
052523               ,:EPCRD-MC-CMPLIN-CDE                              08590700
052523               ,:EPCRD-VIP-SRC-CDE                                08590800
052523               ,:EPCRD-VIP-RSPN-CDE                               08590900
052523               ,:EPCRD-BNKNET-NBR                                 08591000
052523               ,:EPTRN-VISA-MULT-CLR-SEQ-NBR                      08591100
052523               ,:EPT00056-AVS-RSPN-CDE                            08591200
052523               ,:EPTRN-SLS-TX-AMT                                 08591300
052523               ,:EPTRN-VISA-TOT-SHP-NBR                           08591400
052523               ,:EPCRD-CRD-LVL-RSLT-CDE                           08591500
052523               ,:EPT00056-CVV-RSPN-CDE                            08591600
052523               ,:EPCRD-NETWK-REF-ID                               08591700
052523               ,:EPCRD-TRSM-TMST                                  08591800
052523               ,:EPCRD-SYS-TRC-AUD-NBR                            08591900
052523               ,:EPCRD-TRK-DAT-CND-CDE                            08592000
052523               ,:EPTRN-OMNI-CHNL-FFLMT-TYP-CDE                    08592100
052523               ,:EPPAY-TRLING-TRN-IND                             08592200
052523               ,:EPPAY-COBRND-IND                                 08592300
052523               ,:EPPAY-PAYT-AMT                                   08592400
052523     END-EXEC.                                                    08592500
052523                                                                  08592600
052523     EVALUATE TRUE                                                08592700
052523         WHEN SQLCODE = ZERO                                      08592800
052523             MOVE EPPAY-KC-ACCT-NBR      TO EPTND-TNDR-ID         08592900
052523             MOVE EPPAY-KC-ACCT-SRC-CDE  TO EPTND-TNDR-ID-SRC-CDE 08593000
052523             MOVE EPPAY-AUTH-NBR         TO EPCRD-AUTH-NBR        08593100
052523             MOVE EPPAY-AUTH-SRC-CDE     TO EPCRD-AUTH-SRC-CDE    08593200
052523             MOVE EPPAY-TRLING-TRN-IND   TO EPCRD-TRLING-TRN-IND  08593300
052523                                                                  08593400
052523         WHEN SQLCODE = -305                                      08593500
052523             CONTINUE                                             08593600
052523                                                                  08593700
052523         WHEN SQLCODE = PC-ROW-NOT-FOUND                          08593800
052523             SET PS-END-OF-PAYMENT          TO TRUE               08593900
052523         WHEN SQLWARN0 NOT EQUAL SPACE                            08594000
052523         WHEN SQLCODE NOT EQUAL ZERO                              08594100
052523             MOVE '3101-FETCH-PAYMENT-CURSOR'                     08594200
052523                                            TO PV-PARAGRAPH-NAME  08594300
052523             MOVE 'ERROR ON FETCH OF PAYMENT-CURSOR'              08594400
052523                                            TO PV-DB2-OPERATION   08594500
052523             PERFORM 9100-SQL-ABEND                               08594600
052523     END-EVALUATE.                                                08594700
052523                                                                  08594800
044500***************************************************************** 08595000
044600* 3300-CLOSE-EXTRACT-CURSOR                                       08600000
044700*      CLOSE CURSOR                                               08610000
044800***************************************************************** 08620000
044900 3300-CLOSE-EXTRACT-CURSOR.                                       08630000
045000                                                                  08640000
045100     EXEC SQL                                                     08650000
045200          CLOSE EXTRACT-CURSOR                                    08660000
045300     END-EXEC.                                                    08670000
045400                                                                  08680000
045500     EVALUATE TRUE                                                08690000
045600         WHEN SQLCODE = ZERO                                      08700000
045700              CONTINUE                                            08710000
045800         WHEN SQLWARN0 NOT EQUAL SPACE                            08720000
045900         WHEN SQLCODE NOT EQUAL ZERO                              08730000
046000             MOVE '3300-CLOSE-EXTRACT-CURSOR'                     08740000
046100                                            TO PV-PARAGRAPH-NAME  08750000
046200             MOVE 'ERROR ON CLOSE OF EXTRACT-CURSOR'              08760000
046300                                            TO PV-DB2-OPERATION   08770000
046400             PERFORM 9100-SQL-ABEND                               08780000
046500     END-EVALUATE.                                                08790000
046600                                                                  08800000
052523***************************************************************** 08801000
052523* 3301-CLOSE-PAYMENT-CURSOR                                       08802000
052523*      CLOSE CURSOR                                               08803000
052523***************************************************************** 08804000
052523 3301-CLOSE-PAYMENT-CURSOR.                                       08805000
052523                                                                  08806000
052523     EXEC SQL                                                     08807000
052523          CLOSE PAYMENT-CURSOR                                    08808000
052523     END-EXEC.                                                    08809000
052523                                                                  08809100
052523     EVALUATE TRUE                                                08809200
052523         WHEN SQLCODE = ZERO                                      08809300
052523              CONTINUE                                            08809400
052523         WHEN SQLWARN0 NOT EQUAL SPACE                            08809500
052523         WHEN SQLCODE NOT EQUAL ZERO                              08809600
052523             MOVE '3301-CLOSE-PAYMENT-CURSOR'                     08809700
052523                                            TO PV-PARAGRAPH-NAME  08809800
052523             MOVE 'ERROR ON CLOSE OF PAYMENT-CURSOR'              08809900
052523                                            TO PV-DB2-OPERATION   08810000
052523             PERFORM 9100-SQL-ABEND                               08810100
052523     END-EVALUATE.                                                08810200
052523     MOVE 'N'                    TO EPPAY-COBRND-IND.             08810300
052523                                                                  08810400
046700******************************************************************08811000
046800* 4000-WRITE-EXTRACT-FILE                                         08820000
046900*     WRITE THE EXTRACT FILE FROM COPYBOOK TCRD007                08830000
047000******************************************************************08840000
047100 4000-WRITE-EXTRACT-FILE.                                         08850000
047200                                                                  08860000
047300     WRITE COSA-EXTRACT-RECORD  FROM TC007-EXTRACT-RECORD.        08870000
047400                                                                  08880000
047500******************************************************************08890000
047600* 9100-SQL-ABEND                                                  08900000
047700*     ABEND PROGRAM WHEN AN SQL ERROR CODE OR WARNING CODE OCCURS.08910000
047800******************************************************************08920000
047900 9100-SQL-ABEND.                                                  08930000
048000     DISPLAY '** ABEND     **'.                                   08940000
048100     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        08950000
048200     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              08960000
048300     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               08970000
048400                                                                  08980000
048500******************************************************************08990000
048600* COPY BOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED     09000000
048700* TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS.      09010000
048800******************************************************************09020000
048900     COPY DPPD004.                                                09030000
049000                                                                  09040000
049100     SET AC-DB2-ERROR TO TRUE.                                    09050000
049200     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         09060000
049300                                                                  09070000
049400******************************************************************09080000
049500* 9999-ABEND                                                      09090000
049600*     ABEND PROGRAM WHEN A NON-DB2 ERROR OCCURS.                  09100000
049700******************************************************************09110000
049800 9999-ABEND.                                                      09120000
049900                                                                  09130000
050000     DISPLAY '** ABEND           **'.                             09140000
050100     DISPLAY '** PROGRAM         ** = ' PC-CURRENT-PROGRAM-NAME.  09150000
050200     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        09160000
050300     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       09170000
050400     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       09180000
050500     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         09190000
