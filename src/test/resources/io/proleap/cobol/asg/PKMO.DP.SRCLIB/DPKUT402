000100*************************                                         05/20/96
000200 IDENTIFICATION DIVISION.                                         DPKUT402
000300*************************                                            LV001
000400 PROGRAM-ID.      DPKUT402.                                               
000500 AUTHOR.          PAUL KEBER - STRATAGEM.                                 
000600 INSTALLATION.    KOHLS DEPARTMENT STORES.                                
000700 DATE-WRITTEN.    05/20/96.                                               
000800 DATE-COMPILED.                                                           
000900                                                                          
001300*****************************************************************         
001400*    ****** NOTE!! - THIS PROGRAM IS CALLED BY CICS PROGRAMS    *         
001500*    ****** AND MUST BE COMPILED AS A CICS PROGRAM.                       
001602*                  COBOL II WITH ORACLE                         *         
001603*****************************************************************         
001800*                                                               *         
001900*               --- GET ORACLE TABLE INFO ---                   *         
002000*                                                               *         
002100*    THIS PROGRAM RETURNS THE ENTERPRISE ID FOR AN EXPENSE PO   *         
002200*    FROM THE PO HEADER ORACLE TABLE.                           *         
002500*                                                               *         
002600*---------------------------------------------------------------*         
002500* DATASETS USED:                                                     CL**6
002600*  DSN                                 COPY USED  I/O  VSAM?  DB?    CL**6
002700* --------------------------------    ----------- ---- -----  ---    CL**6
002800*  FUNCTION USER SECURITY              TFNCUSR     I     N    ORA    CL**6
003000*  PO HEADER                           TPOHEAD     I     N    ORA    CL*45
003200*---------------------------------------------------------------*         
003300*   CHANGES:                                                    *         
000350*   DATE: 01/10/97                                                        
000360*   ADDED LOGIC TO DETERMINE IF A USER HAS AUTHORITY TO ACCESS            
000370*   A STORE CONSTRUCTION TYPE STORE.                                      
000380*   MADE BY: P. KEBER - STRATAGEM       WR #: 4252                        
003200*                                                                 RCK00071
003600*---------------------------------------------------------------*         
003700 EJECT                                                                    
003800                                                                          
003900 ENVIRONMENT DIVISION.                                                    
004000*                                                                         
004100 DATA DIVISION.                                                           
004200*                                                                         
004300 WORKING-STORAGE SECTION.                                                 
004400                                                                          
004500 01  PV-PROGRAM-VARIABLES.                                                
004600     05  FILLER                  PIC  X(30)  VALUE                        
004700         '** BEGINING OF DPKUT402 W/S **'.                                
004800     05  PV-CURRENT-PARAGRAPH    PIC  X(35)  VALUE SPACES.                
004000*                                                                 RCK00071
004100 01  PC-PROGRAM-CONSTANTS.                                        RCK00071
004800     05  PC-PROD-FUNCGP          PIC  X(08)  VALUE  'CSPROD  '.   RCKCL*97
004800     05  PC-TEST-FUNCGP          PIC  X(08)  VALUE  'CSTEST  '.   RCKCL*97
077500                                                                  07220002
008400*----------------------------------------------------------------*        
008500*  BAD SQL CALL DATA AREAS                                       *        
008600*----------------------------------------------------------------*        
008700 01  BAD-SQL-CALL-AREA.                                                   
008800     05  BAD-POHEAD-CALL-MSG     PIC  X(38)  VALUE                        
008900      'UNSUCCESSFUL SELECT ON TPOHEAD TABLE'.                             
008800     05  BAD-LOGON-CALL-MSG      PIC  X(38)  VALUE                        
008900      'UNSUCCESSFUL LOGON TO ORACLE        '.                             
009400     05  NOT-FOUND-CALL-MSG      PIC  X(38)  VALUE                        
009500      'ROW NOT FOUND ON TPOHEAD ORACLE TABLE'.                            
009800     05  INVALID-FUNCTION-CODE-MSG PIC  X(79)  VALUE                      
009900      'INVALID FUNCTION CODE PASSED'.                                     
010000                                                                          
008700 01  BAD-SQL-ERR-MSG.                                                     
008800     05  BAD-SQL-ERROR-MSG       PIC  X(60)  VALUE SPACES.                
009000     05  FILLER                  PIC  X(11)  VALUE ' SQLCODE = '.         
009000     05  BAD-SQL-CODE            PIC  ----9  VALUE ZERO.                  
008800     05  FILLER                  PIC  X(03)  VALUE SPACES.                
005500 EJECT                                                                    
077400     EXEC SQL BEGIN DECLARE SECTION END-EXEC.                     07210002
077500                                                                  07220002
077600     COPY DPWS202.                                                07230002
077700                                                                  07240002
077800 01  OC-CORPORATE-HIER-CDE        PIC X(03)   VALUE  'CO '.       01020002
030300 01  OC-TYPE                      PIC  X      VALUE SPACE.                
077700                                                                  07240002
089200*---------------------------------------------------------------* 08340002
089300*    DB2 AREA FOR TPOHEAD                                       * 08350002
089400*---------------------------------------------------------------* 08360002
089500     EXEC SQL                                                     08370002
089600          INCLUDE TPOHEAD                                         08380002
089700     END-EXEC.                                                    08390002
089800                                                                  08400002
089200*---------------------------------------------------------------* 08340002
089300*    DB2 AREA FOR TFNCUSR                                       * 08350002
089400*---------------------------------------------------------------* 08360002
089500     EXEC SQL                                                     08370002
089600          INCLUDE TFNCUSR                                         08380002
089700     END-EXEC.                                                    08390002
089800                                                                  08400002
093500     EXEC SQL END DECLARE SECTION END-EXEC.                       08770002
093600                                                                  08780002
093700* ORACLE COMMUNICATION AREA                                       08790002
093800*                                                                 08800002
093900  01       SQLCA.                                                 08810002
094000           05  SQLCAID               PIC X(8).                    08820002
094100           05  SQLCABC               PIC S9(9) COMPUTATIONAL.     08830002
094200           05  SQLCODE               PIC S9(9) COMPUTATIONAL.     08840002
094300           05  SQLERRM.                                           08850002
094400               49 SQLERRML           PIC S9(4) COMPUTATIONAL.     08860002
094500               49 SQLERRMC           PIC X(70).                   08870002
094600           05  SQLERRP               PIC X(8).                    08880002
094700           05  SQLERRD OCCURS 6 TIMES                             08890002
094800                                     PIC S9(9) COMPUTATIONAL.     08900002
094900           05  SQLWARN.                                           08910002
095000               10 SQLWARN0           PIC X(1).                    08920002
095100               10 SQLWARN1           PIC X(1).                    08930002
095200               10 SQLWARN2           PIC X(1).                    08940002
095300               10 SQLWARN3           PIC X(1).                    08950002
095400               10 SQLWARN4           PIC X(1).                    08960002
095500               10 SQLWARN5           PIC X(1).                    08970002
095600               10 SQLWARN6           PIC X(1).                    08980002
095700               10 SQLWARN7           PIC X(1).                    08990002
095800           05  SQLEXT                PIC X(8).                    09000002
010300 EJECT                                                                    
010400*                                                                         
010500 LINKAGE SECTION.                                                         
010600*                                                                         
010700     COPY DPWS402.                                                   CL**4
010800*                                                                         
010900*                                                                         
011000 PROCEDURE DIVISION USING DP402-PARAMETERS.                          CL**3
011100                                                                          
011200 A100-MAIN.                                                               
011300                                                                          
011400     MOVE 'A100-MAIN' TO PV-CURRENT-PARAGRAPH.                            
011500                                                                          
097900*----------------------------------------------------------------*09210002
098000* LOGON TO ORACLE, DECLARE CURSORS                               *09220002
098100*----------------------------------------------------------------*09230002
098200                                                                  09240002
098300     COPY DPPD027.                                                09250002
098400                                                                  09260002
098500     EVALUATE TRUE                                                09270002
098600         WHEN SQLCODE = ZERO                                      09280002
098700             CONTINUE                                             09290002
098800         WHEN OTHER                                               09300002
017300             MOVE ZEROES               TO DP402-ENT-ID               CL**3
018100             MOVE BAD-LOGON-CALL-MSG   TO BAD-SQL-ERROR-MSG          CL**3
018400             MOVE SQLCODE              TO BAD-SQL-CODE               CL**3
018100             MOVE BAD-SQL-ERR-MSG      TO DP402-ERROR-MESSAGE        CL**3
018100             MOVE SQLCA                TO DP402-SQLCA                CL**3
012700             SET DP402-ERROR-CALL      TO TRUE                       CL**3
013200             GOBACK                                                       
099700     END-EVALUATE.                                                09390002
099800                                                                  09400002
099800     IF DP402-SELECT-POHEAD-INFO                                  09400002
011700         PERFORM B100-POHEAD-SELECT                                       
012400     ELSE                                                                 
099800       IF DP402-GET-STRCONST-AUTH                                 09400002
011700           PERFORM C100-GET-STRCONST-AUTH                                 
012400       ELSE                                                               
018400         MOVE ZERO               TO DP402-SQLCODE                    CL**3
012600         MOVE INVALID-FUNCTION-CODE-MSG                                   
012700                                 TO DP402-ERROR-MESSAGE              CL**3
018400         MOVE SPACES             TO DP402-SQLCA                      CL**3
012700         SET DP402-ERROR-CALL    TO TRUE                             CL**3
013100     END-IF.                                                              
013100                                                                          
013200     GOBACK.                                                              
013300                                                                          
013400 EJECT                                                                    
013500*----------------------------------------------------------------*        
002100*    USE THE PO NUMBER TO SELECT THE TPOHEAD ROW.                *        
013800*----------------------------------------------------------------*        
013900 B100-POHEAD-SELECT.                                                      
014000                                                                          
014100     MOVE 'B100-POHEAD-SELECT' TO PV-CURRENT-PARAGRAPH.                   
014200                                                                          
014903     MOVE DP402-PO-NBR            TO POHEAD-PO-NBR.               APKUP254
014200                                                                          
323300     EXEC SQL                                                     31140002
323400          SELECT                                                  31150002
323500                ENT_ID                                            31160002
323700          INTO                                                    31180002
323800                :POHEAD-ENT-ID                                    31190002
324000          FROM  TPOHEAD                                           31210002
324100          WHERE PO_NBR = :POHEAD-PO-NBR                           31220002
324200            AND VER_STATUS_CDE = 'A'                              31240002
324400     END-EXEC.                                                    31250002
014200                                                                          
016600     EVALUATE TRUE                                                        
016700         WHEN SQLCODE = ZEROS                                             
017100             MOVE POHEAD-ENT-ID        TO DP402-ENT-ID               CL**3
017100             MOVE SPACES               TO DP402-ERROR-MESSAGE        CL**3
017100             MOVE SQLCA                TO DP402-SQLCA                CL**3
017110             SET DP402-SUCCESSFUL-CALL TO TRUE                       CL**3
017200         WHEN SQLCODE = +1403                                             
017300             MOVE ZEROES               TO DP402-ENT-ID               CL**3
017600             MOVE NOT-FOUND-CALL-MSG   TO DP402-ERROR-MESSAGE        CL**3
017100             MOVE SQLCA                TO DP402-SQLCA                CL**3
012700             SET DP402-ROW-NOT-FOUND   TO TRUE                       CL**3
017700         WHEN OTHER                                                       
017300             MOVE ZEROES               TO DP402-ENT-ID               CL**3
018100             MOVE BAD-POHEAD-CALL-MSG  TO BAD-SQL-ERROR-MSG          CL**3
018400             MOVE SQLCODE              TO BAD-SQL-CODE               CL**3
018100             MOVE BAD-SQL-ERR-MSG      TO DP402-ERROR-MESSAGE        CL**3
018100             MOVE SQLCA                TO DP402-SQLCA                CL**3
012700             SET DP402-ERROR-CALL      TO TRUE                       CL**3
018200     END-EVALUATE.                                                        
018300                                                                          
018400     MOVE SQLCODE TO DP402-SQLCODE.                                  CL**3
013400 EJECT                                                                    
013500*----------------------------------------------------------------*        
226801*   DETERMINE IF THE USER IS AUTHORIZED FOR CN (CONSTRUCTION)    *        
226802*   TYPE STORES.                                                 *        
013800*----------------------------------------------------------------*        
013900 C100-GET-STRCONST-AUTH.                                                  
014000                                                                          
014100     MOVE 'C100-GET-STRCONST-AUTH' TO PV-CURRENT-PARAGRAPH.               
014200                                                                          
161601     MOVE DP402-USERID         TO  FNCUSR-USER-ID.                        
160100     IF  DP402-CICS-REGION-PRODUCTION                                CL*60
160300         MOVE PC-PROD-FUNCGP   TO  FNCUSR-FUNCGP-ID                  CL*95
160500     ELSE                                                            CL*60
160300         MOVE PC-TEST-FUNCGP   TO  FNCUSR-FUNCGP-ID                  CL*95
160500     END-IF.                                                         CL*60
167500                                                                          
226810     EXEC SQL                                                        CL235
226820         SELECT 1                                                       70
226830         INTO  :OC-TYPE                                              CL235
226840         FROM  TFNCUSR                                               CL235
226841         WHERE RTRIM(USER_ID)   = :FNCUSR-USER-ID                         
226841           AND RTRIM(FUNCGP_ID) = :FNCUSR-FUNCGP-ID                       
226841           AND RTRIM(FUNC_ID)   = 'STRCONST'                              
226850     END-EXEC.                                                       CL235
014200                                                                          
016600     EVALUATE TRUE                                                        
016700         WHEN SQLCODE = ZEROS                                             
017100             MOVE SPACES               TO DP402-ERROR-MESSAGE        CL**3
017100             MOVE SQLCA                TO DP402-SQLCA                CL**3
017110             SET DP402-SUCCESSFUL-CALL TO TRUE                       CL**3
017200         WHEN SQLCODE = +1403                                             
017300             MOVE ZEROES               TO DP402-ENT-ID               CL**3
017600             MOVE NOT-FOUND-CALL-MSG   TO DP402-ERROR-MESSAGE        CL**3
017100             MOVE SQLCA                TO DP402-SQLCA                CL**3
012700             SET DP402-ROW-NOT-FOUND   TO TRUE                       CL**3
017700         WHEN OTHER                                                       
017300             MOVE ZEROES               TO DP402-ENT-ID               CL**3
018100             MOVE BAD-POHEAD-CALL-MSG  TO BAD-SQL-ERROR-MSG          CL**3
018400             MOVE SQLCODE              TO BAD-SQL-CODE               CL**3
018100             MOVE BAD-SQL-ERR-MSG      TO DP402-ERROR-MESSAGE        CL**3
018100             MOVE SQLCA                TO DP402-SQLCA                CL**3
012700             SET DP402-ERROR-CALL      TO TRUE                       CL**3
018200     END-EVALUATE.                                                        
018300                                                                          
018400     MOVE SQLCODE TO DP402-SQLCODE.                                  CL**3
