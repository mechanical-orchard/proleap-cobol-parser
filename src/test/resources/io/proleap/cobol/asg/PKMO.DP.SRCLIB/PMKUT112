000100******************************************************************00010025
000200 IDENTIFICATION DIVISION.                                         00020025
000300******************************************************************00030025
000400                                                                  00040025
000500 PROGRAM-ID.      PMKUT112.                                       00050025
000600 AUTHOR.          MARTIN BRADLEY.                                 00060025
000700 INSTALLATION.    KOHLS DEPARTMENT STORES.                        00070025
000800 DATE-WRITTEN.    SEP 2003.                                       00080025
000900 DATE-COMPILED.                                                   00090025
001000                                                                  00100025
001100******************************************************************00110025
001200* THIS PROGRAM READS IN A FILE WITH A DATE, PROMOTION ID,        *00120025
001300* PROMO TYPE INDICATOR, AND A HISTORY/FUTURE INDICATOR.          *00130025
001400* THE PROMOTION TYPE INDICATOR IS USED TO DETERMINE WHICH COLUMNS*00140025
001500* OF XST_LPS_MIN_PRIC_W TABLE TO POPULATE (MAIN, NON-MAIN, OR    *00150025
001600* PROMOTION).                                                    *00160025
001700* THE HISTORY/FUTURE INDICATOR IS USED TO DETERMINE IF THE HIST  *00170025
001800* OR FUTURE COLUMNS OF THE XST_LPS_MIN_PRIC_W TABLE SHOULD BE    *00180025
001900* UPDATED.                                                       *00190025
002000* THE CLEAR COLUMNS FLAG TELLS US WHETHER ALL THE DATA IN THE    *00200025
002100* SPECIFIED COLUMNS TYPE SHOULD BE SET TO NULL (SUCH AS THE FIRST*00210025
002200* TIME A FUTURE PROMOTION IS RUN BEFORE THE REPORT IS GENERATED).*00220025
002300******************************************************************00230025
002400******************************************************************00240025
002500*----------------------------------------------------------       00250041
002600* HISTORY LOG:                                                    00260041
002700*----------------------------------------------------------       00270041
002800* DATE:        10/19/2004                                         00280041
002900* WR/IR#:      P000708282                                         00290042
003000* PROGRAMMER:  COLLEEN CUMMINGS                                   00300041
003100* DESCRIPTION: CHANGED "F400-UPDATE-LPS" TO ALSO UPDATE THE LPS   00310041
003200* PRICE IF THE CURRENT PRICE ON THE TABLE IS AN UNADVERTISED      00320041
003200* LPS PRICE.  HAD AN ISSUE WITH THE OCTOBER RUN WHERE A SKU WAS   00330041
003200* UNADVERTISED IN THE LPS MAIN @ 16.99 - BUT ADVERTISED IN THE    00340041
003200* LPS SPECIAL PROMOTION @ 16.99 - SO WE KEPT THE UNADVERTISED     00350041
003200* LPS MAIN PRICE ON THE TABLE - BUT BECAUSE WE DON'T EVALUATE     00360041
003200* UNADVERTISED LPS PRICES - THIS ERROR WAS MISSED (BECAUSE IT     00370041
003200* PROMOTED @ 14.99 IN ANOTHER NON-LPS).                           00380041
003310*----------------------------------------------------------       00390041
002800* DATE:        11/23/2004                                         00400046
002900* WR/IR#:      P000713613                                         00410043
003000* PROGRAMMER:  COLLEEN CUMMINGS                                   00420043
003100* DESCRIPTION: FIX TO APPLYING TIERED PRICING.                    00430043
003100*              WAS ONLY BEING APPLIED TO FIRST RECORD OF FILE.    00440043
003100*              CHANGED TO CREATE NEW PARAGRAPH (E300) AND CALL    00450043
003100*              FOR EACH RECORD.                                   00460043
003310*----------------------------------------------------------       00470043
002800* DATE:        11/24/2004                                         00480046
002900* WR/IR#:      P000713613                                         00490046
003000* PROGRAMMER:  COLLEEN CUMMINGS                                   00500046
003100* DESCRIPTION: FIX TO APPLYING TIERED PRICING.                    00510046
003100*              WAS NOT DIVIDING PERCENT BY 100 BEFORE APPLYING.   00520047
003100*              COMMENTED OUT WITH *CGC BECAUSE CANNOT APPLY       00530047
003100*              AFTER HISTORY HAS BEEN LOADED.  UNCOMMENT AFTER    00540047
003100*              THIS LPS IS FINISHED.                              00550047
003310*----------------------------------------------------------       00560046
002800* DATE:        01/20/2005                                         00570050
002900* WR/IR#:      WR28178                                            00580050
003000* PROGRAMMER:  COLLEEN CUMMINGS                                   00590049
003100* DESCRIPTION: UNCOMMENT TIERED PRICING LOGIC.                    00600049
003310*----------------------------------------------------------       00610049
002800* DATE:        05/17/2022                                         00611051
002900* WR/IR#:      CHG0269972                                         00612052
003000* PROGRAMMER:  JEAN KURK                                          00613051
003100* DESCRIPTION: CHANGE COMMIT FREQUENCY                            00614051
003310*----------------------------------------------------------       00615051
002600******************************************************************00620025
002700 ENVIRONMENT DIVISION.                                            00630025
002800******************************************************************00640025
002900                                                                  00650025
003000 CONFIGURATION SECTION.                                           00660025
003100                                                                  00670025
003200 SOURCE-COMPUTER. IBM-3090.                                       00680025
003300 OBJECT-COMPUTER. IBM-3090.                                       00690025
003400                                                                  00700025
003500 INPUT-OUTPUT SECTION.                                            00710025
003600                                                                  00720025
003700 FILE-CONTROL.                                                    00730025
003800                                                                  00740025
003900     SELECT PROMO-ID-FILE                                         00750025
004000         ASSIGN                       TO INP01.                   00760025
004100                                                                  00770025
004200     SELECT PRICE-DETERMINATION-FILE                              00780025
004300         ASSIGN                       TO INP02.                   00790025
004400                                                                  00800025
004500******************************************************************00810025
004600 DATA DIVISION.                                                   00820025
004700******************************************************************00830025
004800                                                                  00840025
004900 FILE SECTION.                                                    00850025
005000                                                                  00860025
005100 FD  PROMO-ID-FILE                                                00870025
005200     RECORDING MODE F                                             00880025
005300     BLOCK CONTAINS 0 RECORDS                                     00890025
005400     LABEL RECORDS ARE STANDARD.                                  00900025
005500                                                                  00910025
005600 01  PROMO-ID-RECORD             PIC X(80).                       00920025
005700                                                                  00930025
005800 FD  PRICE-DETERMINATION-FILE                                     00940025
005900     RECORDING MODE F                                             00950025
006000     BLOCK CONTAINS 0 RECORDS                                     00960025
006100     LABEL RECORDS ARE STANDARD.                                  00970025
006200                                                                  00980025
006300 01  PRICE-DETERMINATION-REC     PIC X(778).                      00990025
006400                                                                  01000025
006500 WORKING-STORAGE SECTION.                                         01010025
006600                                                                  01020025
006700******************************************************************01030025
006800* PC PROGRAM CONSTANTS                                           *01040025
006900******************************************************************01050025
007000 01  PC-PROGRAM-CONSTANTS.                                        01060025
007100     05  PC-PROGRAM-NAME              PIC X(08)      VALUE        01070025
007200                                                     'PMKUT112'.  01080025
007300*    05  PC-NBR-ROWS-TO-COMMIT-AFTER  PIC S9(09)     VALUE +100   01090051
007300     05  PC-NBR-ROWS-TO-COMMIT-AFTER  PIC S9(09)     VALUE +50    01091051
007400                                                     COMP-3.      01100025
007410     05  PC-QTY-ONE                   PIC S9(04)     VALUE +1     01110026
007411                                                     COMP.        01120037
007420     05  PC-MAX-RETRIES               PIC S9(04)     VALUE +5     01130037
007500                                                     COMP.        01140026
007600******************************************************************01150025
007700* PV PROGRAM VARIABLES                                           *01160025
007800******************************************************************01170025
007900 01  PV-PROGRAM-VARIABLES.                                        01180025
008000     05  PV-PARAGRAPH-NAME            PIC X(40)      VALUE SPACES.01190025
008010     05  PV-SQL-SUB                   PIC S9(4)      VALUE +0     01200037
008020                                                     COMP.        01210037
008100     05  PV-DB2-OPERATION-ATTEMPTED   PIC X(40)      VALUE SPACES.01220025
008200                                                                  01230025
008300     05  PV-RUN-DATE                  PIC X(10)    VALUE SPACES.  01240025
008400     05  PV-RUN-DATE-RDF REDEFINES PV-RUN-DATE.                   01250025
008500         10  PV-RUN-DATE-CCYY         PIC X(04).                  01260025
008600         10  PV-RUN-DATE-D1           PIC X(01).                  01270025
008700         10  PV-RUN-DATE-MM           PIC X(02).                  01280025
008800         10  PV-RUN-DATE-D2           PIC X(01).                  01290025
008900         10  PV-RUN-DATE-DD           PIC X(02).                  01300025
009000     05  PV-RUN-PROMO-ID              PIC S9(10)V COMP-3.         01310025
009100                                                                  01320025
009200     05  PV-RUN-PROMO-IND             PIC X(01)    VALUE SPACES.  01330025
009300         88 PS-RUN-MAIN-PROMO                      VALUE 'M'.     01340025
009400         88 PS-RUN-NON-MAIN-PROMO                  VALUE 'N'.     01350025
009500         88 PS-RUN-LPS-PROMO                       VALUE 'L'.     01360025
009600                                                                  01370025
009700     05  PV-RUN-HISTORY-IND           PIC X(01)    VALUE SPACES.  01380025
009800         88 PS-RUN-HISTORY                         VALUE 'H'.     01390025
009900         88 PS-RUN-FUTURE                          VALUE 'F'.     01400025
010000         88 PS-RUN-LPS                             VALUE 'L'.     01410025
010100                                                                  01420025
010200     05  PV-PD-INTR-UPC-ID-DISPLAY    PIC S9(10)   COMP           01430044
010300                                                   VALUE ZEROS.   01440044
010200     05  PV-PD-INTR-UPC-ID            PIC S9(09)   COMP           01450025
010300                                                   VALUE ZEROS.   01460025
010400     05  PV-PD-PRICE                  PIC S9(7)V9(02) COMP-3      01470025
010500                                                   VALUE ZEROS.   01480025
010510     05  PV-PD-PRICE-CALC             PIC S9(7)V9(02) COMP-3      01490027
010520                                                   VALUE ZEROS.   01500027
010510     05  PV-GET-PCT                   PIC S9(03)V9(05) COMP-3     01510044
010520                                                   VALUE ZEROS.   01520044
010530     05  PV-DISC-AMT                  PIC S9(7)V9(03) COMP-3      01530027
010540                                                   VALUE ZEROS.   01540027
010541     05  PV-FINAL-DISC-AMT            PIC S9(7)V9(02) COMP-3      01550027
010542                                                   VALUE ZEROS.   01560027
010550     05  PV-DISC-AMT-PRT              PIC S9(7)V9(02) COMP-3      01570027
010560                                                   VALUE ZEROS.   01580027
010570     05  PV-DISC-AMT-CHK              PIC S9(7)V9(03)             01590027
010580                                                   VALUE ZEROS.   01600027
010590     05  PV-DISC-AMT-CHK-X REDEFINES PV-DISC-AMT-CHK              01610027
010591                                      PIC 9(10).                  01620027
010592     05  PV-DISC-AMT-FIELDS.                                      01630027
010593         10 PV-DISCT-AMT-FIRST        PIC 9(09) VALUE ZEROES.     01640027
010594         10 PV-DISC-AMT-LAST          PIC 9(01) VALUE ZEROES.     01650027
010600     05  PV-PD-INTFC-ID               PIC S9(10)V  COMP-3         01660025
010700                                                   VALUE ZEROS.   01670025
010800     05  PV-PD-MDSE-LNE-ID            PIC S9(10)V  COMP-3         01680025
010900                                                   VALUE ZEROS.   01690025
011000     05  PV-PD-PROMO-ID               PIC S9(10)V  COMP-3         01700025
011100                                                   VALUE ZEROS.   01710025
011200     05  PV-MODULUS-NBR               PIC S9(9)V  COMP-3.         01720025
011210     05  PV-STR-NBR                   PIC X(03) VALUE '000'.      01730025
011300                                                                  01740025
011400******************************************************************01750025
011500* PS PROGRAM SWITCHES                                            *01760025
011600******************************************************************01770025
011700 01  PS-PROGRAM-SWITCHES.                                         01780025
011800     05  PS-END-OF-PROMO-ID-FILE-SW      PIC X(01)     VALUE 'N'. 01790025
011900         88  PS-END-OF-PROMO-ID-FILE                   VALUE 'Y'. 01800025
012000     05  PS-END-OF-PRICING-SW            PIC X(01)     VALUE 'N'. 01810025
012100         88  PS-END-OF-PRICING                         VALUE 'Y'. 01820025
012200         88  PS-NOT-END-OF-PRICING                     VALUE 'N'. 01830025
012300     05  PS-INVALID-PROMO-SW             PIC X(01)     VALUE 'N'. 01840025
012400         88  PS-INVALID-PROMO                          VALUE 'Y'. 01850025
012500                                                                  01860025
012600******************************************************************01870025
012700* PA PROGRAM ACCUMULATORS                                        *01880025
012800******************************************************************01890025
012900 01  PA-PROGRAM-ACCUMULATORS.                                     01900025
013000     05  PA-PROMO-RECS-READ              PIC S9(11)     COMP-3    01910025
013100                                                     VALUE ZEROES.01920025
013200     05  PA-ELIG-UPC-RECS-READ           PIC S9(11)     COMP-3    01930025
013300                                                     VALUE ZEROES.01940025
013400     05  PA-ROWS-INSERTED                PIC S9(11)     COMP-3    01950025
013500                                                     VALUE ZEROES.01960025
013600     05  PA-LPS-UPDATES                  PIC S9(11) COMP-3        01970025
013700                                                     VALUE ZEROES.01980025
013800     05  PA-LPS-UPDATES-FAILED           PIC S9(11) COMP-3        01990025
013900                                                     VALUE ZEROES.02000025
014000     05  PA-DUP-INSERTS                  PIC S9(11) COMP-3        02010025
014100                                                     VALUE ZEROES.02020025
014200     05  PA-MAIN-HIST-UPDATES            PIC S9(11) COMP-3        02030025
014300                                                     VALUE ZEROES.02040025
014400     05  PA-MAIN-HIST-UPDATES-FAILED     PIC S9(11) COMP-3        02050025
014500                                                     VALUE ZEROES.02060025
014600     05  PA-MAIN-FUT-UPDATES             PIC S9(11) COMP-3        02070025
014700                                                     VALUE ZEROES.02080025
014800     05  PA-MAIN-FUT-UPDATES-FAILED      PIC S9(11) COMP-3        02090025
014900                                                     VALUE ZEROES.02100025
015000     05  PA-NMAIN-HIST-UPDATES           PIC S9(11) COMP-3        02110025
015100                                                     VALUE ZEROES.02120025
015200     05  PA-NMAIN-HIST-UPDATES-FAILED    PIC S9(11) COMP-3        02130025
015300                                                     VALUE ZEROES.02140025
015400     05  PA-NMAIN-FUT-UPDATES            PIC S9(11) COMP-3        02150025
015500                                                     VALUE ZEROES.02160025
015600     05  PA-NMAIN-FUT-UPDATES-FAILED     PIC S9(11) COMP-3        02170025
015700                                                     VALUE ZEROES.02180025
015800     05  PA-UNCOMMITTED-DML              PIC S9(11) COMP-3        02190025
015900                                                     VALUE ZEROES.02200025
016000     05  PA-COMMIT-CNT                   PIC S9(11) COMP-3        02210025
016100                                                     VALUE ZEROES.02220025
016200     05  PA-PRICE-RECS-READ              PIC S9(11) COMP-3        02230025
016300                                                     VALUE ZEROES.02240025
016400                                                                  02250025
016500******************************************************************02260025
016600* CC CONTROL CARD RECORDS                                         02270025
016700******************************************************************02280025
016800 01  CC-RUN-CONTROL-CARD-RECORD.                                  02290025
016900     05  CC-RUN-DTE.                                              02300025
017000         10  CC-RUN-DATE-CCYY         PIC  X(04)     VALUE SPACES.02310025
017100         10  CC-RUN-DATE-MM           PIC  X(02)     VALUE SPACES.02320025
017200         10  CC-RUN-DATE-DD           PIC  X(02)     VALUE SPACES.02330025
017300     05  FILLER                       PIC  X(01)     VALUE SPACES.02340025
017400     05  CC-RUN-PROMO-ID              PIC  X(10)     VALUE SPACES.02350025
017500     05  FILLER                       PIC  X(01)     VALUE SPACES.02360025
017600     05  CC-PROMO-IND                 PIC  X(01)     VALUE SPACES.02370025
017700     05  FILLER                       PIC  X(01)     VALUE SPACES.02380025
017800     05  CC-HISTORY-IND               PIC  X(01)     VALUE SPACES.02390025
017900     05  FILLER                       PIC  X(01)     VALUE SPACES.02400025
018000     05  CC-CLEAR-COLUMNS             PIC  X(01)     VALUE SPACES.02410025
018100     05  FILLER                       PIC  X(55)     VALUE SPACES.02420025
018200                                                                  02430025
018300******************************************************************02440025
018400*    PRICE DETERMINATION INPUT RECORD                            *02450025
018500******************************************************************02460025
018600     COPY XSRD044.                                                02470025
018700                                                                  02480025
018800******************************************************************02490025
018900*    PROMO ID INPUT RECORD                                       *02500025
019000******************************************************************02510025
019100     COPY PMRD122.                                                02520025
019200                                                                  02530025
019300******************************************************************02540025
019400*    VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004     *02550025
019500******************************************************************02560025
019600     COPY DPWS004.                                                02570025
019700                                                                  02580025
019800******************************************************************02590025
019900*  TABLE INCLUDES                                                *02600025
020000******************************************************************02610025
020100*  TABLE XST_LPS_MIN_PRIC_W                                       02620025
020200     EXEC SQL INCLUDE XST00051  END-EXEC.                         02630025
020300******************************************************************02640025
020400*  TABLE XST_PROMO                                                02650025
020500     EXEC SQL INCLUDE XST00026  END-EXEC.                         02660025
020600******************************************************************02670025
020700*  TABLE XST_MDSE_LNE_SELN                                        02680025
020800     EXEC SQL INCLUDE XST00028  END-EXEC.                         02690025
020900******************************************************************02700025
021000                                                                  02710025
021100******************************************************************02720025
021200*    SQL COMMUNICATIONS AREA DCLGEN                              *02730025
021300******************************************************************02740025
021400     EXEC SQL                                                     02750025
021500         INCLUDE SQLCA                                            02760025
021600     END-EXEC.                                                    02770025
021700                                                                  02780025
021800     COPY SQLCA2.                                                 02790025
021900                                                                  02800025
022000******************************************************************02810025
022100* AC ABEND CODES                                                 *02820025
022200******************************************************************02830025
022300 01  ABEND-CODE                       PIC S9(04)   COMP VALUE +0. 02840025
022400     88  ABEND-4001-WRITE-ERROR                    VALUE +4001.   02850025
022500     88  ABEND-4002-READ-ERROR                     VALUE +4002.   02860025
022600     88  ABEND-4003-CTRL-CARD-ERROR                VALUE +4003.   02870025
022700     88  ABEND-4004-TABLE-ERROR                    VALUE +4004.   02880025
022800     88  ABEND-4005-OPEN-ERROR                     VALUE +4005.   02890025
022900     88  ABEND-4006-CLOSE-ERROR                    VALUE +4006.   02900025
023000     88  ABEND-4007-SEQUENCE-ERROR                 VALUE +4007.   02910025
023100     88  ABEND-4008-DATA-ERROR                     VALUE +4008.   02920025
023200     88  ABEND-4009-KEY-DATA-ERROR                 VALUE +4009.   02930025
023300     88  ABEND-4013-DB2-ERROR                      VALUE +4013.   02940025
023400     88  ABEND-4019-DATE-ROUTINE-ERROR             VALUE +4019.   02950025
023500     88  ABEND-4444-FORCED-ABEND                   VALUE +4444.   02960025
023600                                                                  02970025
023700 PROCEDURE DIVISION.                                              02980025
023800                                                                  02990025
023900******************************************************************03000025
024000* MAIN PROCESSING                                                 03010025
024100******************************************************************03020025
024200                                                                  03030025
024300 A100-PROGRAM-MAINLINE.                                           03040025
024400                                                                  03050025
024500     PERFORM B100-OPEN-FILES.                                     03060025
024600     PERFORM B150-READ-PROMO-ID-FILE.                             03070025
024700                                                                  03080025
024800     IF NOT PS-END-OF-PROMO-ID-FILE                               03090025
024900                                                                  03100025
025000*        VALIDATE THE INPUT PARAMETERS                            03110025
025100         PERFORM D100-VALIDATE-PROMO                              03120048
025200                                                                  03130025
025300         IF PS-INVALID-PROMO                                      03140025
025400             DISPLAY ' '                                          03150025
025500             DISPLAY '** ABEND     **'                            03160025
025600             DISPLAY '** PROGRAM   **  = ' PC-PROGRAM-NAME        03170025
025700             DISPLAY '** PARAGRAPH **  = A100-PROGRAM-MAINLINE'   03180025
025800             DISPLAY '** RUN DATE DOES NOT FALL WITHIN THE    **' 03190025
025900             DISPLAY '** SPECIFIED PROMO, OR PROMO IS INVALID **' 03200025
026000             DISPLAY ' '                                          03210025
026100             MOVE +4003 TO ABEND-CODE                             03220025
026200             CALL 'ILBOABN0' USING ABEND-CODE                     03230025
026300         END-IF                                                   03240025
026400                                                                  03250025
026500         PERFORM D200-VALIDATE-PROMO-IND                          03260025
026600         PERFORM D300-VALIDATE-HIST-IND                           03270025
026700                                                                  03280025
026800*        COMMIT THE MASS UPDATE WE JUST PERFORMED                 03290025
026900         PERFORM H600-COMMIT                                      03300025
027000                                                                  03310025
027100         PERFORM E100-PROCESS-UPC-PRICES                          03320025
027200                                                                  03330025
027300*        UPDATE THE LAST PROMO IF WE ARE RUNNING A HISTORY PROMO  03340025
027400*        IF PS-RUN-HISTORY                                        03350040
027500*            IF PS-RUN-MAIN-PROMO                                 03360040
027600*                PERFORM G100-UPDATE-LAST-MAIN-PROMO              03370040
027700*            ELSE                                                 03380040
027800*                PERFORM G200-UPDATE-LAST-NMAIN-PROMO             03390040
027900*            END-IF                                               03400040
028000*        END-IF                                                   03410040
028100                                                                  03420025
028200*        COMMIT ANY REMAINING TRANSACTIONS                        03430025
028300         PERFORM H600-COMMIT                                      03440025
028400     END-IF.                                                      03450025
028500                                                                  03460025
028600     PERFORM B900-EOJ-ROUTINE.                                    03470025
028700                                                                  03480025
028800     GOBACK.                                                      03490025
028900                                                                  03500025
029000***************************************************************** 03510025
029100* B100-OPEN-FILES.                                              * 03520025
029200* ==> PROCESSES:                                                * 03530025
029300*  - OPEN TWO INPUT FILES AND ONE OUTPUT FILE                   * 03540025
029400* ==> PERFORMED FROM: A100-MAINLINE                             * 03550025
029500******************************************************************03560025
029600 B100-OPEN-FILES.                                                 03570025
029700                                                                  03580025
029800     OPEN INPUT PROMO-ID-FILE                                     03590025
029900                PRICE-DETERMINATION-FILE.                         03600025
030000                                                                  03610025
030100***************************************************************** 03620025
030200* B150-READ-PROMO-ID-FILE.                                      * 03630025
030300* ==> PROCESSES:                                                * 03640025
030400*  - READ IN THE RUN CONTROL CARD                               * 03650025
030500* ==> PERFORMED FROM: A100-MAINLINE                             * 03660025
030600***************************************************************** 03670025
030700 B150-READ-PROMO-ID-FILE.                                         03680025
030800                                                                  03690025
030900     READ PROMO-ID-FILE INTO PM122-PROMO-ID-REC                   03700025
031000         AT END                                                   03710025
031100             SET PS-END-OF-PROMO-ID-FILE TO TRUE.                 03720025
031200                                                                  03730025
031300     IF PS-END-OF-PROMO-ID-FILE                                   03740025
031400         DISPLAY ' '                                              03750025
031500         DISPLAY '** EMPTY PROMO ID INPUT FILE.'                  03760025
031600         DISPLAY ' '                                              03770025
031700     ELSE                                                         03780025
031800         MOVE PM122-RUN-DTE-CCYY   TO PV-RUN-DATE-CCYY            03790025
031900         MOVE PM122-RUN-DTE-MM     TO PV-RUN-DATE-MM              03800025
032000         MOVE PM122-RUN-DTE-DD     TO PV-RUN-DATE-DD              03810025
032100         MOVE '-'                  TO PV-RUN-DATE-D1              03820025
032200                                      PV-RUN-DATE-D2              03830025
032300         MOVE PM122-PROMO-ID       TO PV-RUN-PROMO-ID             03840025
032400         MOVE PM122-PROMO-TYP-IND  TO PV-RUN-PROMO-IND            03850025
032500         MOVE PM122-HIST-FUT-IND   TO PV-RUN-HISTORY-IND          03860025
032600                                                                  03870025
032700         DISPLAY ' '                                              03880025
032800         DISPLAY 'CONTROLS FOR PROGRAM ' PC-PROGRAM-NAME ': '     03890025
032900         DISPLAY '  RUN DATE:          ' PV-RUN-DATE              03900025
033000         DISPLAY '  RUN PROMO ID:      ' PV-RUN-PROMO-ID          03910025
033100         DISPLAY '  PROMO INDICATOR:   ' PV-RUN-PROMO-IND         03920025
033200         DISPLAY '  HISTORY INDICATOR: ' PV-RUN-HISTORY-IND       03930025
033300         DISPLAY ' '                                              03940025
033400     END-IF.                                                      03950025
033500                                                                  03960025
033600***************************************************************** 03970025
033700* B900-EOJ-ROUTINE.                                             * 03980025
033800* ==> PROCESSES:                                                * 03990025
033900*  - CLOSE FILES AND DISPLAY TOTALS                             * 04000025
034000* ==> PERFORMED FROM: A100-MAINLINE                             * 04010025
034100******************************************************************04020025
034200 B900-EOJ-ROUTINE.                                                04030025
034300                                                                  04040025
034400     CLOSE PROMO-ID-FILE                                          04050025
034500           PRICE-DETERMINATION-FILE.                              04060025
034600                                                                  04070025
034700     DISPLAY ' '                                                  04080025
034800     DISPLAY 'ELIGIBLE UPC/STR RECORDS READ: '                    04090025
034900         PA-ELIG-UPC-RECS-READ                                    04100025
035000     DISPLAY 'ROWS INSERTED:                 '                    04110025
035100         PA-ROWS-INSERTED                                         04120025
035200     DISPLAY 'DUPLICATE INSERTS ATTEMPTED:   '                    04130025
035300         PA-DUP-INSERTS                                           04140025
035400     DISPLAY 'LPS MAIN PRICES UPDATED:           '                04150025
035500         PA-LPS-UPDATES                                           04160025
035600     DISPLAY 'FAILED LPS MAIN PRICE UPDATES:     '                04170025
035700         PA-LPS-UPDATES-FAILED                                    04180025
035800     DISPLAY 'MAIN PROMO HISTORY PRICES UPDATED: '                04190025
035900         PA-MAIN-HIST-UPDATES                                     04200025
036000     DISPLAY 'MAIN PROMO HISTORY UPDATES FAILED: '                04210025
036100         PA-MAIN-HIST-UPDATES-FAILED                              04220025
036200     DISPLAY 'MAIN PROMO FUTURE PRICES UPDATED:  '                04230025
036300         PA-MAIN-FUT-UPDATES                                      04240025
036400     DISPLAY 'MAIN PROMO FUTURE UPDATES FAILED:  '                04250025
036500         PA-MAIN-FUT-UPDATES-FAILED                               04260025
036600     DISPLAY 'NON-MAIN HISTORY PRICES UPDATED:   '                04270025
036700         PA-NMAIN-HIST-UPDATES                                    04280025
036800     DISPLAY 'NON-MAIN HISTORY UPDATES FAILED:   '                04290025
036900         PA-NMAIN-HIST-UPDATES-FAILED                             04300025
037000     DISPLAY 'NON-MAIN FUTURE PRICES UPDATED:    '                04310025
037100         PA-NMAIN-FUT-UPDATES                                     04320025
037200     DISPLAY 'NON-MAIN FUTURE UPDATES FAILED:    '                04330025
037300         PA-NMAIN-FUT-UPDATES-FAILED                              04340025
037400     DISPLAY 'COMMITS PERFORMED: ' PA-COMMIT-CNT.                 04350025
037500     DISPLAY ' '.                                                 04360025
037600                                                                  04370025
037700******************************************************************04380025
037800 D100-VALIDATE-PROMO.                                             04390025
037900* VERIFY THAT THE RUN DATE SPECIFIED FALLS WITHIN THE PROMO ID    04400025
038000* SPECIFIED.                                                      04410025
038100******************************************************************04420025
038200                                                                  04430025
038300     EXEC SQL                                                     04440025
038400         SELECT PROMO_ID                                          04450025
038500         INTO :XST00026-PROMO-ID                                  04460025
038600         FROM XST_PROMO                                           04470025
038700         WHERE PROMO_ID = :PV-RUN-PROMO-ID                        04480025
038800             AND :PV-RUN-DATE >= DATE(DFLT_STRT_TMST)             04490025
038900             AND :PV-RUN-DATE <= DATE(DFLT_END_TMST)              04500025
039000             AND STAT_CDE = 'S'                                   04510025
039100         WITH UR                                                  04520025
039200     END-EXEC.                                                    04530025
039300                                                                  04540025
039400     EVALUATE TRUE                                                04550025
039500         WHEN SQLCODE = +0                                        04560025
039600             CONTINUE                                             04570025
039700                                                                  04580025
039800         WHEN SQLCODE = +100                                      04590025
039900             SET PS-INVALID-PROMO TO TRUE                         04600025
040000                                                                  04610025
040100         WHEN OTHER                                               04620025
040200             MOVE 'D100-VALIDATE-PROMO'                           04630025
040300                               TO PV-PARAGRAPH-NAME               04640025
040400             MOVE 'ERROR SELECTING XST_PROMO'                     04650025
040500                               TO PV-DB2-OPERATION-ATTEMPTED      04660025
040600             PERFORM Z900-SQL-ABEND                               04670025
040700     END-EVALUATE.                                                04680025
040800                                                                  04690025
040900******************************************************************04700025
041000 D200-VALIDATE-PROMO-IND.                                         04710025
041100* VERIFY THAT THE PROMO TYPE INDICATOR IS VALID.  MUST BE ONE OF  04720025
041200* THE FOLLOWING: 'M' = MAIN, 'N' = NON-MAIN, 'L' = LPS            04730025
041300******************************************************************04740025
041400                                                                  04750025
041500     EVALUATE TRUE                                                04760025
041600         WHEN PS-RUN-MAIN-PROMO                                   04770025
041700         WHEN PS-RUN-NON-MAIN-PROMO                               04780025
041800         WHEN PS-RUN-LPS-PROMO                                    04790025
041900             CONTINUE                                             04800025
042000                                                                  04810025
042100         WHEN OTHER                                               04820025
042200             MOVE 'D200-VALIDATE-PROMO-IND' TO PV-PARAGRAPH-NAME  04830025
042300                                                                  04840025
042400             MOVE 'PROMO TYPE INDICATOR IS NOT VALID'             04850025
042500                           TO PV-DB2-OPERATION-ATTEMPTED          04860025
042600             PERFORM Z900-SQL-ABEND                               04870025
042700     END-EVALUATE.                                                04880025
042800                                                                  04890025
042900******************************************************************04900025
043000 D300-VALIDATE-HIST-IND.                                          04910025
043100* VERIFY THAT THE HISTORY/FUTURE FLAG IS VALID.  MUST BE ONE OF   04920025
043200* THE FOLLOWING: 'H' = HISTORY, 'F' = FUTURE, 'L' = LPS PROMO.    04930025
043300******************************************************************04940025
043400                                                                  04950025
043500     EVALUATE TRUE                                                04960025
043600         WHEN PS-RUN-HISTORY                                      04970025
043700         WHEN PS-RUN-FUTURE                                       04980025
043800         WHEN PS-RUN-LPS                                          04990025
043900             CONTINUE                                             05000025
044000                                                                  05010025
044100         WHEN OTHER                                               05020025
044200             MOVE 'D300-VALIDATE-HIST-IND' TO PV-PARAGRAPH-NAME   05030025
044300                                                                  05040025
044400             MOVE 'HISTORY/FUTURE INDICATOR IS NOT VALID'         05050025
044500                           TO PV-DB2-OPERATION-ATTEMPTED          05060025
044600             PERFORM Z900-SQL-ABEND                               05070025
044700     END-EVALUATE.                                                05080025
044800                                                                  05090025
044900******************************************************************05100025
045000 E100-PROCESS-UPC-PRICES.                                         05110025
045100******************************************************************05120025
045200                                                                  05130025
045300     READ PRICE-DETERMINATION-FILE INTO XS044-PD-OUTPUT-RECORD    05140025
045400         AT END                                                   05150025
045500             SET PS-END-OF-PRICING TO TRUE.                       05160025
045600                                                                  05170025
045700     IF PS-END-OF-PRICING                                         05180025
045800         DISPLAY ' '                                              05190025
045900         DISPLAY '** EMPTY PRICE DETERMINATION FILE.'             05200025
046000         DISPLAY ' '                                              05210025
046100     ELSE                                                         05220025
046200         MOVE XS044-INTR-UPC-ID       TO PV-PD-INTR-UPC-ID        05230025
046300         MOVE XS044-PD-PRICE          TO PV-PD-PRICE              05240025
046310                                         PV-PD-PRICE-CALC         05250026
046400         MOVE XS044-PD-PROMO-ID       TO PV-PD-PROMO-ID           05260025
046500         MOVE XS044-PD-INTFC-ID       TO PV-PD-INTFC-ID           05270025
046600         MOVE XS044-PD-MDSE-LNE-ID    TO PV-PD-MDSE-LNE-ID        05280025
046610         IF XS044-TIER-PRICG-TYP-CDE = 'TQP'                      05290049
046630            IF XS044-BUY-QTY(1) = PC-QTY-ONE                      05300049
                     PERFORM E300-APPLY-TIERED-PRICE                    05310049
046680            END-IF                                                05320049
046690         END-IF                                                   05330049
046700         ADD +1 TO PA-PRICE-RECS-READ                             05340025
046800     END-IF.                                                      05350025
046900                                                                  05360025
047000     PERFORM E200-PROCESS-PRICING-RECS                            05370025
047100         UNTIL PS-END-OF-PRICING.                                 05380025
047200                                                                  05390025
047300******************************************************************05400025
047400 E200-PROCESS-PRICING-RECS.                                       05410025
047500******************************************************************05420025
047600                                                                  05430025
047700     PERFORM F100-PROCESS-MIN-PRICE.                              05440048
047800                                                                  05450025
047900*    SEE IF WE SHOULD COMMIT (EVERY X NUMBER OF UPDATES)          05460025
048000     IF PA-UNCOMMITTED-DML >= PC-NBR-ROWS-TO-COMMIT-AFTER         05470025
048100         PERFORM H600-COMMIT                                      05480025
048200         MOVE ZERO TO PA-UNCOMMITTED-DML                          05490025
048300     END-IF                                                       05500025
048400                                                                  05510025
048500     READ PRICE-DETERMINATION-FILE INTO XS044-PD-OUTPUT-RECORD    05520025
048600         AT END                                                   05530025
048700             SET PS-END-OF-PRICING TO TRUE.                       05540025
048800                                                                  05550025
048900     IF NOT PS-END-OF-PRICING                                     05560025
049000         MOVE XS044-INTR-UPC-ID       TO PV-PD-INTR-UPC-ID        05570025
049100         MOVE XS044-PD-PRICE          TO PV-PD-PRICE              05580025
046310                                         PV-PD-PRICE-CALC         05590044
049200         MOVE XS044-PD-PROMO-ID       TO PV-PD-PROMO-ID           05600025
049300         MOVE XS044-PD-INTFC-ID       TO PV-PD-INTFC-ID           05610025
049400         MOVE XS044-PD-MDSE-LNE-ID    TO PV-PD-MDSE-LNE-ID        05620025
046610         IF XS044-TIER-PRICG-TYP-CDE = 'TQP'                      05630049
046630            IF XS044-BUY-QTY(1) = PC-QTY-ONE                      05640049
                     PERFORM E300-APPLY-TIERED-PRICE                    05650049
046680            END-IF                                                05660049
046690         END-IF                                                   05670049
049500         ADD +1 TO PA-PRICE-RECS-READ                             05680025
049600                                                                  05690025
049700         COMPUTE PV-MODULUS-NBR                                   05700025
049800             = FUNCTION MOD(PA-PRICE-RECS-READ, 10000)            05710025
049900         IF PV-MODULUS-NBR = 0                                    05720025
050000             DISPLAY 'ELIGIBLE UPC/STORES PROCESSED: '            05730025
050100                 PA-PRICE-RECS-READ                               05740025
050200         END-IF                                                   05750025
050300     END-IF.                                                      05760025
050400                                                                  05770025
050500******************************************************************05780043
050600*     E300-APPLY-TIERED-PRICE.                                   *05790043
050700******************************************************************05800043
050800 E300-APPLY-TIERED-PRICE.                                         05810043
050900                                                                  05820043
             COMPUTE PV-GET-PCT  = XS044-GET-PCT(1) / 100.              05830044
                                                                        05840044
             COMPUTE PV-DISC-AMT = PV-GET-PCT *                         05850044
                                   PV-PD-PRICE-CALC.                    05860043
             MOVE PV-DISC-AMT       TO PV-DISC-AMT-CHK                  05870043
                                       PV-DISC-AMT-PRT.                 05880043
             MOVE PV-DISC-AMT-CHK-X TO PV-DISC-AMT-FIELDS.              05890043
                                                                        05900043
             IF PV-DISC-AMT-LAST > 0                                    05910043
                COMPUTE PV-FINAL-DISC-AMT = PV-DISC-AMT-PRT             05920043
                                            + 0.01                      05930043
             ELSE                                                       05940043
                MOVE PV-DISC-AMT-PRT TO PV-FINAL-DISC-AMT               05950043
             END-IF.                                                    05960043
                                                                        05970043
             COMPUTE PV-PD-PRICE = PV-PD-PRICE-CALC -                   05980043
                                   PV-FINAL-DISC-AMT.                   05990043
                                                                        06000044
      **     MOVE PV-PD-INTR-UPC-ID TO PV-PD-INTR-UPC-ID-DISPLAY.       06010045
      **     DISPLAY 'PV-PD-INTR-UPC-ID-DISPLAY = '                     06020045
      **              PV-PD-INTR-UPC-ID-DISPLAY.                        06030045
      **     DISPLAY 'PV-PD-PRICE = ' PV-PD-PRICE.                      06040045
                                                                        06050043
050500******************************************************************06060025
050600*     F100-PROCESS-MIN-PRICE.                                    *06070025
050700******************************************************************06080025
050800 F100-PROCESS-MIN-PRICE.                                          06090025
050900                                                                  06100025
051000     PERFORM F150-INSERT-UPC.                                     06110025
051100                                                                  06120025
051200*    BASED ON THE WHETHER WE ARE PROCESSING THE LPS MAIN, AND     06130025
051300*    WHETHER OR NOT THE PROMOTION IS A MAIN OR NOT DETERMINES     06140025
051400*    HOW WE UPDATE THE MIN PRICE TABLE (XST_LPS_MIN_PRIC_W).      06150034
051500     EVALUATE TRUE                                                06160025
051600         WHEN PS-RUN-LPS-PROMO                                    06170025
051700             PERFORM F400-UPDATE-LPS                              06180025
051800         WHEN PS-RUN-MAIN-PROMO                                   06190025
051900             IF PS-RUN-HISTORY                                    06200025
052000                 PERFORM F200-UPDATE-MAIN-HIST                    06210025
052100             ELSE                                                 06220025
052200                 PERFORM F300-UPDATE-MAIN-FUT                     06230025
052300             END-IF                                               06240025
052400         WHEN PS-RUN-NON-MAIN-PROMO                               06250025
052500             IF PS-RUN-HISTORY                                    06260025
052600                 PERFORM F500-UPDATE-NON-MAIN-HIST                06270025
052700             ELSE                                                 06280025
052800                 PERFORM F600-UPDATE-NON-MAIN-FUT                 06290025
052900             END-IF                                               06300025
053000     END-EVALUATE.                                                06310025
053100                                                                  06320025
053200******************************************************************06330025
053300 F150-INSERT-UPC.                                                 06340025
053400*  ATTEMPT TO INSERT THE UPC_ID.  IF IT FAILS,                    06350025
053500*  THAT'S OKAY, AS ANOTHER ITERATION OF THIS JOB MIGHT HAVE       06360025
053600*  ALREADY INSERTED IT INTO THE TABLE.                            06370025
053700******************************************************************06380025
053800                                                                  06390025
053810     PERFORM                                                      06400037
053820         WITH TEST AFTER                                          06410037
053830         VARYING PV-SQL-SUB                                       06420037
053840         FROM 1 BY 1                                              06430037
053850         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 06440037
053860                   OR  SQLCODE NOT = -904 AND -911 AND -913)      06450037
053870                                                                  06460037
053900         EXEC SQL                                                 06470037
054000             INSERT INTO XST_LPS_MIN_PRIC_W                       06480037
054100                (INTR_UPC_ID                                      06490037
054110                ,LPS_PREV_RPTD_IND)                               06500037
054200             VALUES                                               06510037
054300                (:PV-PD-INTR-UPC-ID                               06520037
054310                ,'N')                                             06530037
054400         END-EXEC                                                 06540037
054500                                                                  06550025
054600         EVALUATE TRUE                                            06560037
054610            WHEN SQLCODE = -904                                   06570037
054620            WHEN SQLCODE = -911                                   06580037
054630            WHEN SQLCODE = -913                                   06590037
054640                 CONTINUE                                         06600037
054700            WHEN SQLCODE = 0                                      06610037
054800                 ADD +1 TO PA-ROWS-INSERTED                       06620037
054900                 ADD +1 TO PA-UNCOMMITTED-DML                     06630037
055000                                                                  06640025
055100             WHEN SQLCODE = -803                                  06650037
055200                  ADD +1 TO PA-DUP-INSERTS                        06660037
055300                                                                  06670025
055400             WHEN OTHER                                           06680037
055500                  MOVE 'F150-INSERT-UPC    '                      06690037
055600                               TO PV-PARAGRAPH-NAME               06700025
055700                  MOVE 'INSERT ERROR ON XST_LPS_MIN_PRIC_W'       06710037
055800                               TO PV-DB2-OPERATION-ATTEMPTED      06720025
055900                 PERFORM Z900-SQL-ABEND                           06730037
056000         END-EVALUATE                                             06740037
056010     END-PERFORM.                                                 06750037
056100                                                                  06760025
056110     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         06770037
056111        MOVE 'F150-INSERT-UPC    '                                06780037
056112                     TO PV-PARAGRAPH-NAME                         06790037
056113        MOVE 'MAX RETRIES ON XST_LPS_MIN_PRIC_W'                  06800037
056114                     TO PV-DB2-OPERATION-ATTEMPTED                06810037
056115        PERFORM Z900-SQL-ABEND                                    06820037
056150     END-IF.                                                      06830037
056160                                                                  06840037
056200******************************************************************06850025
056300 F200-UPDATE-MAIN-HIST.                                           06860025
056400******************************************************************06870025
056500                                                                  06880025
056510     PERFORM                                                      06890037
056520         WITH TEST AFTER                                          06900037
056530         VARYING PV-SQL-SUB                                       06910037
056540         FROM 1 BY 1                                              06920037
056550         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 06930037
056560                   OR  SQLCODE NOT = -904 AND -911 AND -913)      06940037
056570                                                                  06950037
056600         EXEC SQL                                                 06960037
056700             UPDATE XST_LPS_MIN_PRIC_W                            06970037
056800                 SET HIST_MP_PROMO_ID = :PV-PD-PROMO-ID           06980037
056900                     , HIST_MP_ITM_ID =                           06990037
057000                         (SELECT PROMO_ITM_ID                     07000037
057100                          FROM XST_MDSE_LNE_SELN                  07010037
057200                          WHERE PROMO_INTFC_ID = :PV-PD-INTFC-ID  07020037
057300                            AND MDSE_LNE_ID = :PV-PD-MDSE-LNE-ID) 07030037
057400                     , HIST_MP_LO_AMT = :PV-PD-PRICE              07040037
057500                     WHERE INTR_UPC_ID = :PV-PD-INTR-UPC-ID       07050037
057600                       AND (HIST_MP_LO_AMT > :PV-PD-PRICE         07060037
057700                        OR HIST_MP_LO_AMT IS NULL)                07070037
057800         END-EXEC                                                 07080037
057900                                                                  07090025
058000         EVALUATE TRUE                                            07100037
058010            WHEN SQLCODE = -904                                   07110037
058020            WHEN SQLCODE = -911                                   07120037
058030            WHEN SQLCODE = -913                                   07130037
058040                 CONTINUE                                         07140037
058100            WHEN SQLCODE = +0                                     07150037
058200                 ADD +1 TO PA-MAIN-HIST-UPDATES                   07160037
058300                 ADD +1 TO PA-UNCOMMITTED-DML                     07170037
058400                                                                  07180025
058500            WHEN SQLCODE = +100                                   07190037
058600                 ADD +1 TO PA-MAIN-HIST-UPDATES-FAILED            07200037
058700                                                                  07210025
058800            WHEN OTHER                                            07220037
058900                 MOVE 'F200-UPDATE-MAIN-HIST   '                  07230037
059000                               TO PV-PARAGRAPH-NAME               07240025
059100                 MOVE 'UPDATE ERROR ON XST_LPS_MIN_PRIC_W'        07250037
059200                               TO PV-DB2-OPERATION-ATTEMPTED      07260025
059300                 PERFORM Z900-SQL-ABEND                           07270037
059400         END-EVALUATE                                             07280037
059410     END-PERFORM.                                                 07290037
059500                                                                  07300025
059510     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         07310037
059520        MOVE 'F200-UPDATE-MAIN-HIST'                              07320037
059530                     TO PV-PARAGRAPH-NAME                         07330037
059540        MOVE 'MAX RETRIES ON XST_LPS_MIN_PRIC_W'                  07340037
059550                     TO PV-DB2-OPERATION-ATTEMPTED                07350037
059560        PERFORM Z900-SQL-ABEND                                    07360037
059570     END-IF.                                                      07370037
059580                                                                  07380037
059600******************************************************************07390025
059700 F300-UPDATE-MAIN-FUT.                                            07400025
059800******************************************************************07410025
059900                                                                  07420025
059910     PERFORM                                                      07430037
059920         WITH TEST AFTER                                          07440037
059930         VARYING PV-SQL-SUB                                       07450037
059940         FROM 1 BY 1                                              07460037
059950         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 07470037
059960                   OR  SQLCODE NOT = -904 AND -911 AND -913)      07480037
059970                                                                  07490037
060000         EXEC SQL                                                 07500037
060100             UPDATE XST_LPS_MIN_PRIC_W                            07510037
060200                 SET FUT_MP_PROMO_ID = :PV-PD-PROMO-ID            07520037
060300                     , FUT_MP_ITM_ID =                            07530037
060400                         (SELECT PROMO_ITM_ID                     07540037
060500                          FROM XST_MDSE_LNE_SELN                  07550037
060600                          WHERE PROMO_INTFC_ID = :PV-PD-INTFC-ID  07560037
060700                            AND MDSE_LNE_ID = :PV-PD-MDSE-LNE-ID) 07570037
060800                     , FUT_MP_LO_AMT = :PV-PD-PRICE               07580037
060900             WHERE INTR_UPC_ID = :PV-PD-INTR-UPC-ID               07590037
061000               AND (FUT_MP_LO_AMT > :PV-PD-PRICE                  07600037
061100                OR FUT_MP_LO_AMT IS NULL)                         07610037
061200         END-EXEC                                                 07620037
061300                                                                  07630025
061400         EVALUATE TRUE                                            07640037
061410            WHEN SQLCODE = -904                                   07650037
061420            WHEN SQLCODE = -911                                   07660037
061430            WHEN SQLCODE = -913                                   07670037
061440                 CONTINUE                                         07680037
061500            WHEN SQLCODE = +0                                     07690037
061600                 ADD +1 TO PA-MAIN-FUT-UPDATES                    07700037
061700                 ADD +1 TO PA-UNCOMMITTED-DML                     07710037
061800                                                                  07720025
061900            WHEN SQLCODE = +100                                   07730037
062000                 ADD +1 TO PA-MAIN-FUT-UPDATES-FAILED             07740037
062100                                                                  07750025
062200            WHEN OTHER                                            07760037
062300                 MOVE 'F300-UPDATE-MAIN-FUT   '                   07770037
062400                               TO PV-PARAGRAPH-NAME               07780025
062500                 MOVE 'UPDATE ERROR ON XST_LPS_MIN_PRIC_W'        07790037
062600                               TO PV-DB2-OPERATION-ATTEMPTED      07800025
062700                 PERFORM Z900-SQL-ABEND                           07810037
062800         END-EVALUATE                                             07820037
062810     END-PERFORM.                                                 07830037
062820                                                                  07840037
062830     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         07850037
062840        MOVE 'F300-UPDATE-MAIN-FUT'                               07860037
062850                     TO PV-PARAGRAPH-NAME                         07870037
062860        MOVE 'MAX RETRIES ON XST_LPS_MIN_PRIC_W'                  07880037
062870                     TO PV-DB2-OPERATION-ATTEMPTED                07890037
062880        PERFORM Z900-SQL-ABEND                                    07900037
062890     END-IF.                                                      07910037
062891                                                                  07920037
062900                                                                  07930025
063000******************************************************************07940025
063100 F400-UPDATE-LPS.                                                 07950025
063200******************************************************************07960025
063300                                                                  07970025
063310     PERFORM                                                      07980037
063320         WITH TEST AFTER                                          07990037
063330         VARYING PV-SQL-SUB                                       08000037
063340         FROM 1 BY 1                                              08010037
063350         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 08020037
063360                   OR  SQLCODE NOT = -904 AND -911 AND -913)      08030037
063370                                                                  08040037
063400         EXEC SQL                                                 08050037
063500             UPDATE XST_LPS_MIN_PRIC_W                            08060037
063600                 SET LPS_ADV_CDE =                                08070037
063700                         (SELECT ADV_CDE                          08080037
063800                          FROM XST_MDSE_LNE_SELN                  08090037
063900                          WHERE PROMO_INTFC_ID = :PV-PD-INTFC-ID  08100037
064000                            AND MDSE_LNE_ID = :PV-PD-MDSE-LNE-ID) 08110037
064100                     , LPS_PROMO_ITM_ID =                         08120037
064200                         (SELECT PROMO_ITM_ID                     08130037
064300                           FROM XST_MDSE_LNE_SELN                 08140037
064400                          WHERE PROMO_INTFC_ID = :PV-PD-INTFC-ID  08150037
064500                            AND MDSE_LNE_ID = :PV-PD-MDSE-LNE-ID) 08160037
064600                     , LPS_PRICG_AMT = :PV-PD-PRICE               08170037
064700                     , LPS_PROMO_ID  = :PV-PD-PROMO-ID            08180037
064800             WHERE INTR_UPC_ID = :PV-PD-INTR-UPC-ID               08190037
064900               AND (LPS_PRICG_AMT > :PV-PD-PRICE                  08200037
065000                OR LPS_ADV_CDE = 'N'                              08210041
065000                OR LPS_PRICG_AMT IS NULL)                         08220041
065100         END-EXEC                                                 08230037
065200                                                                  08240025
065300         EVALUATE TRUE                                            08250037
065310            WHEN SQLCODE = -904                                   08260037
065320            WHEN SQLCODE = -911                                   08270037
065330            WHEN SQLCODE = -913                                   08280037
065340                 CONTINUE                                         08290037
065400            WHEN SQLCODE = +0                                     08300037
065500                 ADD +1 TO PA-LPS-UPDATES                         08310037
065600                 ADD +1 TO PA-UNCOMMITTED-DML                     08320037
065700                                                                  08330025
065800            WHEN SQLCODE = +100                                   08340037
065900                 ADD +1 TO PA-LPS-UPDATES-FAILED                  08350037
066000                                                                  08360025
066100            WHEN OTHER                                            08370037
066200                 MOVE 'F400-UPDATE-LPS'                           08380037
066300                               TO PV-PARAGRAPH-NAME               08390025
066400                 MOVE 'UPDATE ERROR ON XST_LPS_MIN_PRIC_W'        08400037
066500                               TO PV-DB2-OPERATION-ATTEMPTED      08410025
066600                 PERFORM Z900-SQL-ABEND                           08420037
066700         END-EVALUATE                                             08430037
066710     END-PERFORM.                                                 08440037
066720                                                                  08450037
066730     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         08460037
066740        MOVE 'F400-UPDATE-LPS'                                    08470037
066750                     TO PV-PARAGRAPH-NAME                         08480037
066760        MOVE 'MAX RETRIES ON XST_LPS_MIN_PRIC_W'                  08490037
066770                     TO PV-DB2-OPERATION-ATTEMPTED                08500037
066780        PERFORM Z900-SQL-ABEND                                    08510037
066790     END-IF.                                                      08520037
066791                                                                  08530037
066800                                                                  08540025
066900******************************************************************08550025
067000 F500-UPDATE-NON-MAIN-HIST.                                       08560025
067100******************************************************************08570025
067200                                                                  08580025
067210     PERFORM                                                      08590037
067220         WITH TEST AFTER                                          08600037
067230         VARYING PV-SQL-SUB                                       08610037
067240         FROM 1 BY 1                                              08620037
067250         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 08630037
067260                   OR  SQLCODE NOT = -904 AND -911 AND -913)      08640037
067270                                                                  08650037
067300         EXEC SQL                                                 08660037
067400             UPDATE XST_LPS_MIN_PRIC_W                            08670037
067500                 SET HIST_NMP_PROMO_ID = :PV-PD-PROMO-ID          08680037
067600                     , HIST_NMP_ITM_ID =                          08690037
067700                         (SELECT PROMO_ITM_ID                     08700037
067800                           FROM XST_MDSE_LNE_SELN                 08710037
067900                          WHERE PROMO_INTFC_ID = :PV-PD-INTFC-ID  08720037
068000                            AND MDSE_LNE_ID = :PV-PD-MDSE-LNE-ID) 08730037
068100                     , HIST_NMP_LO_AMT = :PV-PD-PRICE             08740037
068200             WHERE INTR_UPC_ID = :PV-PD-INTR-UPC-ID               08750037
068300               AND (HIST_NMP_LO_AMT > :PV-PD-PRICE                08760037
068400                OR HIST_NMP_LO_AMT IS NULL)                       08770037
068500         END-EXEC                                                 08780037
068600                                                                  08790025
068700         EVALUATE TRUE                                            08800037
068710            WHEN SQLCODE = -904                                   08810037
068720            WHEN SQLCODE = -911                                   08820037
068730            WHEN SQLCODE = -913                                   08830037
068740                 CONTINUE                                         08840037
068800            WHEN SQLCODE = +0                                     08850037
068900                 ADD +1 TO PA-NMAIN-HIST-UPDATES                  08860037
069000                 ADD +1 TO PA-UNCOMMITTED-DML                     08870037
069100                                                                  08880025
069200            WHEN SQLCODE = +100                                   08890037
069300                 ADD +1 TO PA-NMAIN-HIST-UPDATES-FAILED           08900037
069400                                                                  08910025
069500            WHEN OTHER                                            08920037
069600                 MOVE 'F500-UPDATE-NON-MAIN-HIST'                 08930037
069700                               TO PV-PARAGRAPH-NAME               08940025
069800                 MOVE 'UPDATE ERROR ON XST_LPS_MIN_PRIC_W'        08950037
069900                               TO PV-DB2-OPERATION-ATTEMPTED      08960025
070000                 PERFORM Z900-SQL-ABEND                           08970037
070100         END-EVALUATE                                             08980037
070110     END-PERFORM.                                                 08990037
070120                                                                  09000037
070130     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         09010037
070140        MOVE 'F500-UPDATE-NON-MAIN-HIST'                          09020037
070150                     TO PV-PARAGRAPH-NAME                         09030037
070160        MOVE 'MAX RETRIES ON XST_LPS_MIN_PRIC_W'                  09040037
070170                     TO PV-DB2-OPERATION-ATTEMPTED                09050037
070180        PERFORM Z900-SQL-ABEND                                    09060037
070190     END-IF.                                                      09070037
070191                                                                  09080037
070200                                                                  09090025
070300******************************************************************09100025
070400 F600-UPDATE-NON-MAIN-FUT.                                        09110025
070500******************************************************************09120025
070600                                                                  09130025
070610     PERFORM                                                      09140037
070620         WITH TEST AFTER                                          09150037
070630         VARYING PV-SQL-SUB                                       09160037
070640         FROM 1 BY 1                                              09170037
070650         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 09180037
070660                   OR  SQLCODE NOT = -904 AND -911 AND -913)      09190037
070670                                                                  09200037
070700         EXEC SQL                                                 09210037
070800             UPDATE XST_LPS_MIN_PRIC_W                            09220037
070900                 SET FUT_NMP_PROMO_ID = :PV-PD-PROMO-ID           09230037
071000                     , FUT_NMP_ITM_ID =                           09240037
071100                         (SELECT PROMO_ITM_ID                     09250037
071200                          FROM XST_MDSE_LNE_SELN                  09260037
071300                          WHERE PROMO_INTFC_ID = :PV-PD-INTFC-ID  09270037
071400                            AND MDSE_LNE_ID = :PV-PD-MDSE-LNE-ID) 09280037
071500                     , FUT_NMP_LO_AMT = :PV-PD-PRICE              09290037
071600              WHERE INTR_UPC_ID = :PV-PD-INTR-UPC-ID              09300037
071700                AND (FUT_NMP_LO_AMT > :PV-PD-PRICE                09310037
071800                 OR FUT_NMP_LO_AMT IS NULL)                       09320025
071900         END-EXEC                                                 09330037
072000                                                                  09340025
072100         EVALUATE TRUE                                            09350037
072110            WHEN SQLCODE = -904                                   09360037
072120            WHEN SQLCODE = -911                                   09370037
072130            WHEN SQLCODE = -913                                   09380037
072140                 CONTINUE                                         09390037
072200            WHEN SQLCODE = +0                                     09400037
072300                 ADD +1 TO PA-NMAIN-FUT-UPDATES                   09410037
072400                 ADD +1 TO PA-UNCOMMITTED-DML                     09420037
072500                                                                  09430025
072600            WHEN SQLCODE = +100                                   09440037
072700                 ADD +1 TO PA-NMAIN-FUT-UPDATES-FAILED            09450037
072800                                                                  09460025
072900            WHEN OTHER                                            09470037
073000                 MOVE 'F600-UPDATE-NON-MAIN-FUT'                  09480037
073100                               TO PV-PARAGRAPH-NAME               09490025
073200                 MOVE 'UPDATE ERROR ON XST_LPS_MIN_PRIC_W'        09500037
073300                               TO PV-DB2-OPERATION-ATTEMPTED      09510025
073400                 PERFORM Z900-SQL-ABEND                           09520037
073500         END-EVALUATE                                             09530037
073510     END-PERFORM.                                                 09540037
073520                                                                  09550037
073530     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         09560037
073540        MOVE 'F600-UPDATE-NON-MAIN-FUT'                           09570037
073550                     TO PV-PARAGRAPH-NAME                         09580037
073560        MOVE 'MAX RETRIES ON XST_LPS_MIN_PRIC_W'                  09590037
073570                     TO PV-DB2-OPERATION-ATTEMPTED                09600037
073580        PERFORM Z900-SQL-ABEND                                    09610037
073590     END-IF.                                                      09620037
073591                                                                  09630037
073600                                                                  09640025
073700******************************************************************09650025
073800 G100-UPDATE-LAST-MAIN-PROMO.                                     09660025
073900*     - UPDATES THE LAST PROMO FIELD IF WE ARE RUNNING            09670025
074000*       A MAIN HISTORY RUN.  THIS FIELD IS USED TO                09680025
074100*       KEEP TRACK OF LAST PROMOTION IN HISTORY THAT HAS BEEN     09690025
074200*       PROCESSED.                                                09700025
074300******************************************************************09710025
074400                                                                  09720025
074410     PERFORM                                                      09730037
074420         WITH TEST AFTER                                          09740037
074430         VARYING PV-SQL-SUB                                       09750037
074440         FROM 1 BY 1                                              09760037
074450         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 09770037
074460                   OR  SQLCODE NOT = -904 AND -911 AND -913)      09780037
074470                                                                  09790037
074500         EXEC SQL                                                 09800037
074600             UPDATE XST_LPS_MIN_PRIC_W                            09810037
074700                 SET LAST_MP_PROMO_ID = :PV-PD-PROMO-ID           09820037
074800                 WHERE HIST_MP_PROMO_ID IS NOT NULL               09830037
074900         END-EXEC                                                 09840037
075000                                                                  09850025
075100     EVALUATE TRUE                                                09860025
075110            WHEN SQLCODE = -904                                   09870037
075120            WHEN SQLCODE = -911                                   09880037
075130            WHEN SQLCODE = -913                                   09890037
075140                 CONTINUE                                         09900037
075200            WHEN SQLCODE = +0                                     09910037
075300            WHEN SQLCODE = +100                                   09920037
075400                CONTINUE                                          09930037
075500                                                                  09940025
075600            WHEN OTHER                                            09950037
075700                 MOVE 'G100-UPDATE-LAST-MAIN-PROMO'               09960037
075800                               TO PV-PARAGRAPH-NAME               09970025
075900                 MOVE 'UPDATE ERROR ON XST_LPS_MIN_PRIC_W'        09980037
076000                               TO PV-DB2-OPERATION-ATTEMPTED      09990025
076100                 PERFORM Z900-SQL-ABEND                           10000037
076200         END-EVALUATE                                             10010037
076210     END-PERFORM.                                                 10020037
076220                                                                  10030037
076230     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         10040037
076240        MOVE 'G100-UPDATE-LAST-MAIN-PROMO'                        10050037
076250                     TO PV-PARAGRAPH-NAME                         10060037
076260        MOVE 'MAX RETRIES ON XST_LPS_MIN_PRIC_W'                  10070037
076270                     TO PV-DB2-OPERATION-ATTEMPTED                10080037
076280        PERFORM Z900-SQL-ABEND                                    10090037
076290     END-IF.                                                      10100037
076291                                                                  10110037
076300                                                                  10120025
076400******************************************************************10130025
076500 G200-UPDATE-LAST-NMAIN-PROMO.                                    10140025
076600*     - UPDATES THE LAST PROMO FIELD IF WE ARE RUNNING            10150025
076700*       A NON-MAIN HISTORY RUN.  THIS FIELD IS USED TO            10160025
076800*       KEEP TRACK OF LAST PROMOTION IN HISTORY THAT HAS BEEN     10170025
076900*       PROCESSED.                                                10180025
077000******************************************************************10190025
077100                                                                  10200025
077110     PERFORM                                                      10210037
077120         WITH TEST AFTER                                          10220037
077130         VARYING PV-SQL-SUB                                       10230037
077140         FROM 1 BY 1                                              10240037
077150         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 10250037
077160                   OR  SQLCODE NOT = -904 AND -911 AND -913)      10260037
077170                                                                  10270037
077200         EXEC SQL                                                 10280037
077300             UPDATE XST_LPS_MIN_PRIC_W                            10290037
077400                 SET LAST_NMP_PROMO_ID = :PV-PD-PROMO-ID          10300037
077500                 WHERE HIST_NMP_PROMO_ID IS NOT NULL              10310037
077600         END-EXEC                                                 10320037
077700                                                                  10330025
077800         EVALUATE TRUE                                            10340037
077810            WHEN SQLCODE = -904                                   10350037
077820            WHEN SQLCODE = -911                                   10360037
077830            WHEN SQLCODE = -913                                   10370037
077840                 CONTINUE                                         10380037
077900            WHEN SQLCODE = +0                                     10390037
078000            WHEN SQLCODE = +100                                   10400037
078100                 CONTINUE                                         10410037
078200                                                                  10420025
078300            WHEN OTHER                                            10430037
078400                 MOVE 'G200-UPDATE-LAST-NMAIN-PROMO'              10440037
078500                               TO PV-PARAGRAPH-NAME               10450025
078600                 MOVE 'UPDATE ERROR ON XST_LPS_MIN_PRIC_W'        10460037
078700                               TO PV-DB2-OPERATION-ATTEMPTED      10470025
078800                 PERFORM Z900-SQL-ABEND                           10480037
078900         END-EVALUATE                                             10490037
078910     END-PERFORM.                                                 10500037
078920                                                                  10510037
078930     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         10520037
078940        MOVE 'G200-UPDATE-LAST-NMAIN-PROMO'                       10530037
078950                     TO PV-PARAGRAPH-NAME                         10540037
078960        MOVE 'MAX RETRIES ON XST_LPS_MIN_PRIC_W'                  10550037
078970                     TO PV-DB2-OPERATION-ATTEMPTED                10560037
078980        PERFORM Z900-SQL-ABEND                                    10570037
078990     END-IF.                                                      10580037
078991                                                                  10590037
079000                                                                  10600025
079237******************************************************************10610025
079240*   H600-COMMIT.                                                 *10620025
079300******************************************************************10630025
079400 H600-COMMIT.                                                     10640025
079500                                                                  10650025
079600     EXEC SQL                                                     10660025
079700          COMMIT                                                  10670025
079800     END-EXEC.                                                    10680025
079900                                                                  10690025
080000     EVALUATE TRUE                                                10700025
080100         WHEN SQLCODE = +0                                        10710025
080200              ADD +1              TO PA-COMMIT-CNT                10720025
080300                                                                  10730025
080400         WHEN OTHER                                               10740025
080500             MOVE 'H600-COMMIT' TO PV-PARAGRAPH-NAME              10750025
080600             MOVE 'UNSUCCESSFUL COMMIT OF XST_LPS_MIN_PRIC_W'     10760025
080700                               TO PV-DB2-OPERATION-ATTEMPTED      10770025
080800             PERFORM Z900-SQL-ABEND                               10780025
080900     END-EVALUATE.                                                10790025
081000                                                                  10800025
081100******************************************************************10810025
081200*     Z900-SQL-ABEND                                             *10820025
081300* ==> PROCESSES:                                                 *10830025
081400*     - PERFORMS ABEND PROCESSING FOR SQL ERRORS.                *10840025
081500* ==> PERFORMED FROM:                                            *10850025
081600******************************************************************10860025
081700 Z900-SQL-ABEND.                                                  10870025
081800                                                                  10880025
081900     DISPLAY 'Z900-SQL-ABEND'.                                    10890025
082000     DISPLAY '**  ABEND     **'.                                  10900025
082100     DISPLAY '**  PROGRAM   **  = ' PC-PROGRAM-NAME.              10910025
082200     DISPLAY '**  PARAGRAPH **  = ' PV-PARAGRAPH-NAME.            10920025
082300     DISPLAY '**  OPERATION **  = ' PV-DB2-OPERATION-ATTEMPTED.   10930025
082400                                                                  10940025
082500******************************************************************10950025
082600* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-   *10960025
082700* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE        *10970025
082800* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE    *10980025
082900* FORMAT.                                                        *10990025
083000******************************************************************11000025
083100     COPY DPPD004.                                                11010025
083200                                                                  11020025
083300     SET ABEND-4013-DB2-ERROR TO TRUE.                            11030025
083400     CALL 'ILBOABN0' USING ABEND-CODE.                            11040025
