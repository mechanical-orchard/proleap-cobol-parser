000100 ID DIVISION.                                                     00010004
000200 PROGRAM-ID.         APKUP025.                                    00020004
000300 AUTHOR.             MARILYN WILKINSON.                           00030004
000400 DATE-WRITTEN.       APRIL 1996.                                  00040004
000500 DATE-COMPILED.                                                   00050004
000600*************************************************************     00060004
000700*    COBOL 2 WITH SQL                                       *     00070004
000800*                                                           *     00080004
000900*    UPDATE RECEIVERS TO MATCHED STATUS                     *     00090004
001000*                    APKUP025                               *     00100004
001100*   PROGRAM OVERVIEW:                                       *     00110004
001200*                                                           *     00120004
001300*     THE RECEIVING TABLES ARE UPDATED BASED ON THE RECEIVE *     00130004
001400*   UPDATE FILE AS FOLLOWS:                                 *     00140004
001500*                                                           *     00150004
001600*    - IF A BULK PO IS CONSIDERED MATCHED, ONLY TRECEIV IS  *     00160004
001700*      UPDATED WITH AN AP PROCESS CODE OF 'M' (MATCHED).    *     00170004
001800*      CLASS DISTRIBUTION PROCESSING WILL UPDATE BOTH       *     00180004
001900*      TRECEIV AND TRECDIS WITH 'J' (JOURNALIZED) ONCE      *     00190004
002000*      PROCESSING IS COMPLETE.                              *     00200004
002100*                                                           *     00210004
002200*    - IF A BY STORE PO IS CONSIDERED MATCHED, ONLY TRECDIS *     00220004
002300*      IS UPDATED WITH AN AP PROCESS CODE OF 'M' (MATCHED). *     00230004
002400*      CLASS DISTRIBUTION PROCESSING WILL UPDATE TRECDIS    *     00240004
002500*      WITH 'J' (JOURNALIZED).  IF ALL TRECDIS ROWS FOR THE *     00250004
002600*      PO/STORE HAVE BEEN MARKED 'J', THEN TRECIEV WILL     *     00260004
002700*      ALSO BE SET TO 'J'.                                  *     00270004
002800*                                                           *     00280004
002900*    THE DECISION WAS MADE TO HANDLE THE RECEIVER UPDATES   *     00290004
003000*    IN THIS FASHION BECAUSE IT IS LESS RESOURCE INTENSIVE  *     00300004
003100*    TO DO ALL THE TRECDIS UPDATING AND CHECKING IN ONE     *     00310004
003200*    PLACE (CLASS DISRIBUTION PROCESSING) RATHER THAN IN    *     00320004
003300*    MANY PLACES (BATCH MATCH, ONLINE RECON, AUTO RECON,    *     00330004
003400*    AND CLASS DISTRIBUTION).                               *     00340004
003500*                                                           *     00350004
003600*   INPUT:                                                  *     00360004
003700*                                                           *     00370004
003800*     1. TPOSTRR - PO STORE DB2 TABLE                       *     00380004
003900*     2. RECEIVING KEYS FILE                                *     00390004
004000*                                                           *     00400004
004100*   I/O:                                                    *     00410004
004200*                                                           *     00420004
004300*        TRECEIV - RECEIVER DB2 TABLE                       *     00430004
004400*        TRECDIS - RECEIVER DISTRIBUTION DB2 TABLE          *     00440004
004500*        TNINREC - NON INVOICED RECEIPT DB2 TABLE           *     00450004
004600*                                                           *     00460004
004700*************************************************************     00470004
004800*   CHANGES:                                                *     00480004
004900*                                                           *     00490004
005000*   04/26/96   INITIAL VERSION                              *     00500004
005100*                                                           *     00510004
005200*   09/19/96   MARY KING                                    *     00520004
005300*              INCLUDED CHECK OF STATUS/AP PROC CDE OF      *     00530004
005400*              SPACE IN THE UPDATE PARAGRAPHS.  THIS ENSURES*     00540004
005500*              THAT ANYTHING THAT WAS PREVIOUSLY JOURNALIZED*     00550004
005600*              WILL NOT BE PROCESSED AGAIN.                 *     00560004
005610*                                                           *     00561005
005620*   DATE: 02/04/08                                          *     00562007
005621*       CHANGES MADE: RECOMPILE FROM PRODUCTION TO INCLUDE  *     00562105
005630*       CHANGES TO COPYBOOK: APRD024.                       *     00563005
005631*       MADE BY: MICHELE RINDFLEISCH      WR/IR #: WR32664  *     00563107
005700*************************************************************     00570004
005800 EJECT                                                            00580004
005900 ENVIRONMENT DIVISION.                                            00590004
006000 CONFIGURATION SECTION.                                           00600004
006100 SOURCE-COMPUTER.        IBM-370.                                 00610004
006200 OBJECT-COMPUTER.        IBM-370.                                 00620004
006300                                                                  00630004
006400 INPUT-OUTPUT SECTION.                                            00640004
006500 FILE-CONTROL.                                                    00650004
006600     SELECT RECV-KEYS-FILE     ASSIGN TO INP01.                   00660004
006700                                                                  00670004
006800 DATA DIVISION.                                                   00680004
006900 FILE SECTION.                                                    00690004
007000 FD  RECV-KEYS-FILE                                               00700004
007100     RECORDING MODE IS F                                          00710004
007200     LABEL RECORDS ARE STANDARD                                   00720004
007300     BLOCK CONTAINS 0 RECORDS                                     00730004
007400     RECORD CONTAINS 100 CHARACTERS                               00740004
007500     DATA RECORD IS RECV-KEYS-DATA.                               00750004
007600 01  RECV-KEYS-DATA             PIC X(100).                       00760004
007700                                                                  00770004
007800 EJECT                                                            00780004
007900 WORKING-STORAGE SECTION.                                         00790004
008000                                                                  00800004
008100 01  FILLER                       PIC X(58)     VALUE             00810004
008200     '************WORKING STORAGE STARTS HERE*******************'.00820004
008300                                                                  00830004
008400 01  PV-PROGRAM-VARIABLES.                                        00840004
008500     05  PV-PROGRAM-NAME          PIC  X(08)    VALUE 'APKUP025'. 00850004
008600     05  TEMP-TMST                PIC  X(10)    VALUE SPACES.     00860004
008700                                                                  00870004
008800     05  PV-CKPT-STAT-CODE        PIC X(01)     VALUE SPACE.      00880004
008900     05  PV-PO-NBR                PIC S9(09) COMP VALUE ZEROS.    00890004
009000     05  PV-STR-NBR               PIC S9(04) COMP VALUE ZEROS.    00900004
009100     05  PV-PO-NBR-9S             PIC  9(09)   VALUE ZEROS.       00910004
009200     05  PV-STR-NBR-9S            PIC  9(04)   VALUE ZEROS.       00920004
009300                                                                  00930004
009400     05  PV-CURRENT-PARAGRAPH     PIC X(50)     VALUE SPACES.     00940004
009500     05  PV-CURRENT-TMST          PIC X(26)     VALUE SPACES.     00950004
009600                                                                  00960004
009700     05  PV-PO-STR-INPUT-COUNT    PIC 9(09)     VALUE ZERO        00970004
009800                                                COMP-3.           00980004
009900     05  PV-RECV-KEY-INPUT-COUNT  PIC 9(09)     VALUE ZERO        00990004
010000                                                COMP-3.           01000004
010100     05  PV-TNINREC-INPUT-COUNT   PIC 9(09)     VALUE ZERO        01010004
010200                                                COMP-3.           01020004
010300     05  PV-TNINREC-UPDATE-COUNT  PIC 9(09)     VALUE ZERO        01030004
010400                                                COMP-3.           01040004
010500     05  PV-TRECDIS-INPUT-COUNT   PIC 9(09)     VALUE ZERO        01050004
010600                                                COMP-3.           01060004
010700     05  PV-TRECDIS-UPDATE-COUNT  PIC 9(09)     VALUE ZERO        01070004
010800                                                COMP-3.           01080004
010900     05  PV-TRECEIV-INPUT-COUNT   PIC 9(09)     VALUE ZERO        01090004
011000                                                COMP-3.           01100004
011100     05  PV-TRECEIV-UPDATE-COUNT  PIC 9(09)     VALUE ZERO        01110004
011200                                                COMP-3.           01120004
011300 01  PC-PROGRAM-CONSTANTS.                                        01130004
011400     05  PC-RETRY-MAX             PIC S9(04)    VALUE +3          01140004
011500                                                COMP SYNC.        01150004
011600     05  PC-RETRY-COUNT           PIC S9(04)    VALUE ZEROS.      01160004
011700     05  PC-IN-PROCESS-CODE       PIC X(01)     VALUE '9'.        01170004
011800     05  PC-RUN-COMPLETE-CODE     PIC X(01)     VALUE '0'.        01180004
011900                                                                  01190004
012000 01  PS-PROGRAM-SWITCHES.                                         01200004
012100     05  PS-END-PO-STR-CSR-SW     PIC  X(01)    VALUE ' '.        01210004
012200         88  MORE-PO-STR                        VALUE 'M'.        01220004
012300         88  END-OF-PO-STR                      VALUE 'E'.        01230004
012400                                                                  01240004
012500     05  PS-END-RECV-KEY-SW       PIC  X(01)    VALUE ' '.        01250004
012600         88  MORE-RECV-KEYS                     VALUE 'M'.        01260004
012700         88  END-OF-RECV-KEYS                   VALUE 'E'.        01270004
012800                                                                  01280004
012900     05  PS-END-TRECEIV-UPDTS-SW  PIC  X(01)    VALUE ' '.        01290004
013000         88  MORE-TRECEIV-UPDTS                 VALUE 'M'.        01300004
013100         88  END-OF-TRECEIV-UPDTS               VALUE 'E'.        01310004
013200                                                                  01320004
013300     05  PS-END-TRECDIS-UPDTS-SW  PIC  X(01)    VALUE 'M'.        01330004
013400         88  MORE-TRECDIS-UPDTS                 VALUE 'M'.        01340004
013500         88  END-OF-TRECDIS-UPDTS               VALUE 'E'.        01350004
013600                                                                  01360004
013700     05  PS-END-TNINREC-UPDTS-SW  PIC  X(01)    VALUE ' '.        01370004
013800         88  MORE-TNINREC-UPDTS                 VALUE 'M'.        01380004
013900         88  END-OF-TNINREC-UPDTS               VALUE 'E'.        01390004
014000                                                                  01400004
014100     05  PS-RUN-TYPE-SW           PIC  X(01)    VALUE ' '.        01410004
014200         88  NORMAL-RUN                         VALUE '0'.        01420004
014300         88  RESTART-RUN                        VALUE '9'.        01430004
014400                                                                  01440004
014500 01  CKPT-RESTART-INFO.                                           01450004
014600     05  CR-PO-NBR                PIC 9(09)     VALUE ZEROS.      01460004
014700     05  CR-STR-NBR               PIC 9(04)     VALUE ZEROS.      01470004
014800                                                                  01480004
014900 01  CKPT-RESTART-TMST.                                           01490004
015000     05  CR-CURR-TMST             PIC X(26)     VALUE SPACES.     01500004
015100     05  CR-NEXT-TMST             PIC X(26)     VALUE SPACES.     01510004
015200                                                                  01520004
015300*----------------------------------------------------------------*01530004
015400*  ABEND DATA AREAS                                              *01540004
015500*----------------------------------------------------------------*01550004
015600 01  ABEND-CODE                  PIC S9(04)  VALUE ZEROS          01560004
015700                                             COMP SYNC.           01570004
015800     88  AC-BAD-RECEIVE-DATA                 VALUE +4001.         01580004
015900     88  AC-BAD-DATA                         VALUE +4008.         01590004
016000     88  AC-DB2-ERROR                        VALUE +4013.         01600004
016100     88  AC-DATE-ERROR                       VALUE +4019.         01610004
016200                                                                  01620004
016300                                                                  01630004
016400 01  ABEND-AREAS.                                                 01640004
016500     05  AA-ABEND-LIT            PIC  X(40)  VALUE                01650004
016600             '*****       ABEND'.                                 01660004
016700     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                01670004
016800             '*****   PROGRAM: APKUP025'.                         01680004
016900     05  AA-PARAGRAPH-LIT.                                        01690004
017000         10  FILLER              PIC  X(17)  VALUE                01700004
017100             '***** PARAGRAPH: '.                                 01710004
017200         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        01720004
017300     05  AA-MESSAGE-LINE-1.                                       01730004
017400         10  FILLER              PIC  X(06)  VALUE '*****'.       01740004
017500         10  AA-MESSAGE-1        PIC  X(127) VALUE SPACES.        01750004
017600     05  AA-MESSAGE-LINE-2.                                       01760004
017700         10  FILLER              PIC  X(06)  VALUE '*****'.       01770004
017800         10  AA-MESSAGE-2        PIC  X(127) VALUE SPACES.        01780004
017900     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                01790004
018000             '*****    DB2 ERROR'.                                01800004
018100     05  AA-DB2-OPERATION-LIT.                                    01810004
018200         10  FILLER              PIC  X(17)  VALUE                01820004
018300             '***** OPERATION: '.                                 01830004
018400         10  AA-DB2-OPERATION    PIC  X(50)  VALUE SPACES.        01840004
018500     05  AA-DB2-TABLE            PIC  X(08)  VALUE SPACES.        01850004
018600     05  AA-BAD-RECEIVE-DATA-MSG-1.                               01860004
018700         10  FILLER              PIC  X(23)  VALUE                01870004
018800             'INVALID RECORD TYPE OF '.                           01880004
018900         10  AA-BAD-RECEIVE-TYPE PIC  9(01)  VALUE ZERO.          01890004
019000         10  FILLER              PIC  X(30)  VALUE                01900004
019100             ' ON INPUT RECEIVE UPDATES FILE'.                    01910004
019200*                                                                 01920004
019300*      RECEIVE KEY FILE LAYOUT                                    01930004
019400*                                                                 01940004
019500     COPY APRD024.                                                01950004
019600     COPY DPWS004.                                                01960004
019700*                                                                 01970004
019800*      TPOSTRR TABLE LAYOUT                                       01980004
019900*                                                                 01990004
020000         EXEC SQL                                                 02000004
020100             INCLUDE TPOSTRR                                      02010004
020200         END-EXEC.                                                02020004
020300*                                                                 02030004
020400*      TRECEIV TABLE LAYOUT                                       02040004
020500*                                                                 02050004
020600         EXEC SQL                                                 02060004
020700             INCLUDE TRECEIV                                      02070004
020800         END-EXEC.                                                02080004
020900*                                                                 02090004
021000*      TRECDIS TABLE LAYOUT                                       02100004
021100*                                                                 02110004
021200         EXEC SQL                                                 02120004
021300             INCLUDE TRECDIS                                      02130004
021400         END-EXEC.                                                02140004
021500*                                                                 02150004
021600*      TNINREC TABLE LAYOUT                                       02160004
021700*                                                                 02170004
021800         EXEC SQL                                                 02180004
021900             INCLUDE TNINREC                                      02190004
022000         END-EXEC.                                                02200004
022100*                                                                 02210004
022200*      TCKRSTCNTL TABLE LAYOUT                                    02220004
022300*                                                                 02230004
022400         EXEC SQL                                                 02240004
022500             INCLUDE TCKRSTCN                                     02250004
022600         END-EXEC.                                                02260004
022700*                                                                 02270004
022800*      TCKRSTINF TABLE LAYOUT                                     02280004
022900*                                                                 02290004
023000         EXEC SQL                                                 02300004
023100             INCLUDE TCKRSTIN                                     02310004
023200         END-EXEC.                                                02320004
023300*----------------------------------------------------------------*02330004
023400* PO_STR_CSR CHECKS FOR ROWS ON THE PO STORE TABLE THAT HAVE A   *02340004
023500* CRE_PRC_CDE OF B                                               *02350004
023600* THIS CURSOR IS USED FOR REGULAR RUN                            *02360004
023700*----------------------------------------------------------------*02370004
023800     EXEC SQL                                                     02380004
023900       DECLARE PO_STR_CSR CURSOR WITH HOLD FOR                    02390004
024000         SELECT                                                   02400004
024100                PO_NBR                                            02410004
024200              , STR_NBR                                           02420004
024300              , PAYT_RLSE_TMST                                    02430004
024400            FROM TPOSTRR                                          02440004
024500            WHERE CRE_PRC_CDE    = 'B'                            02450004
024600            ORDER BY                                              02460004
024700                PO_NBR                                            02470004
024800              , STR_NBR                                           02480004
024900     END-EXEC.                                                    02490004
025000*----------------------------------------------------------------*02500004
025100* PO_STR_CSR CHECKS FOR ROWS ON THE PO STORE TABLE THAT HAVE A   *02510004
025200* CRE_PRC_CDE OF B                                               *02520004
025300* AND THAT ARE PAST THE CHKPT RESTART PO/STR NUMBERS             *02530004
025400* THIS CURSOR IS USED FOR RESTART                                *02540004
025500*----------------------------------------------------------------*02550004
025600     EXEC SQL                                                     02560004
025700       DECLARE PO_STR_CHKPT_CSR CURSOR WITH HOLD FOR              02570004
025800         SELECT                                                   02580004
025900                PO_NBR                                            02590004
026000              , STR_NBR                                           02600004
026100              , PAYT_RLSE_TMST                                    02610004
026200            FROM TPOSTRR                                          02620004
026300            WHERE CRE_PRC_CDE    = 'B'                            02630004
026400              AND ((PO_NBR       = :PV-PO-NBR                     02640004
026500              AND   STR_NBR      > :PV-STR-NBR)                   02650004
026600               OR  (PO_NBR       > :PV-PO-NBR))                   02660004
026700            ORDER BY                                              02670004
026800                PO_NBR                                            02680004
026900              , STR_NBR                                           02690004
027000     END-EXEC.                                                    02700004
027100******************************************************************02710004
027200*  DB2 COMMUNICATION AREA                                         02720004
027300*                                                                 02730004
027400     EXEC SQL                                                     02740004
027500         INCLUDE SQLCA                                            02750004
027600     END-EXEC.                                                    02760004
027700/                                                                 02770004
027800*  DB2 COMMUNICATION AREA2                                        02780004
027900*                                                                 02790004
028000     COPY SQLCA2.                                                 02800004
028100     EJECT                                                        02810004
028200 PROCEDURE DIVISION.                                              02820004
028300 MAINLINE-ROUTINE.                                                02830004
028400                                                                  02840004
028500     OPEN INPUT RECV-KEYS-FILE.                                   02850004
028600                                                                  02860004
028700     PERFORM A100-INITIALIZATION.                                 02870004
028800                                                                  02880004
028900     PERFORM B100-PROCESSING                                      02890004
029000             UNTIL END-OF-PO-STR    OR                            02900004
029100                   END-OF-RECV-KEYS.                              02910004
029200                                                                  02920004
029300     PERFORM Z100-EOJ-PROCESSING.                                 02930004
029400                                                                  02940004
029500     GOBACK.                                                      02950004
029600 A100-INITIALIZATION.                                             02960004
029700                                                                  02970004
029800     EXEC SQL                                                     02980004
029900         SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                 02990004
030000     END-EXEC.                                                    03000004
030100                                                                  03010004
030200     INITIALIZE DCLTPOSTRR                                        03020004
030300                DCLTRECEIV                                        03030004
030400                DCLTRECDIS                                        03040004
030500                DCLTNINREC.                                       03050004
030600                                                                  03060004
030700     PERFORM R400-GET-CHECKPOINT-CNTL.                            03070004
030800     MOVE PV-CKPT-STAT-CODE TO PS-RUN-TYPE-SW.                    03080004
030900                                                                  03090004
031000     IF RESTART-RUN                                               03100004
031100         PERFORM C200-CHECKPOINT-RESTART.                         03110004
031200                                                                  03120004
031300     IF RESTART-RUN                                               03130004
031400        PERFORM Y100-OPEN-PO-STR-CHKPT-CSR                        03140004
031500     ELSE                                                         03150004
031600        PERFORM Y200-OPEN-PO-STR-CSR.                             03160004
031700                                                                  03170004
031800     IF RESTART-RUN                                               03180004
031900        PERFORM R100-FETCH-PO-STR-CHK                             03190004
032000     ELSE                                                         03200004
032100        PERFORM R200-FETCH-PO-STR.                                03210004
032200                                                                  03220004
032300     PERFORM R300-READ-RECV-KEYS.                                 03230004
032400                                                                  03240004
032500 B100-PROCESSING.                                                 03250004
032600                                                                  03260004
032700*  SET UP RECEIVING KEYS FILE AT THE FIRST MATCHING PO/STR REC    03270004
032800                                                                  03280004
032900     PERFORM UNTIL END-OF-RECV-KEYS                       OR      03290004
033000             (PV-PO-NBR-9S    = AP024-SRT-PURCHASE-ORDER AND      03300004
033100              PV-STR-NBR-9S   = AP024-SRT-STORE-NBR)      OR      03310004
033200             ((PV-PO-NBR-9S   = AP024-SRT-PURCHASE-ORDER AND      03320004
033300               PV-STR-NBR-9S  < AP024-SRT-STORE-NBR)      OR      03330004
033400              (PV-PO-NBR-9S   < AP024-SRT-PURCHASE-ORDER))        03340004
033500        PERFORM R300-READ-RECV-KEYS                               03350004
033600     END-PERFORM.                                                 03360004
033700                                                                  03370004
033800     IF END-OF-RECV-KEYS                                          03380004
033900        CONTINUE                                                  03390004
034000     ELSE                                                         03400004
034100        IF PV-PO-NBR-9S    = AP024-SRT-PURCHASE-ORDER AND         03410004
034200           PV-STR-NBR-9S   = AP024-SRT-STORE-NBR                  03420004
034300           PERFORM B200-PROCESS-RECV-KEYS                         03430004
034400              UNTIL END-OF-RECV-KEYS                      OR      03440004
034500               (PV-PO-NBR-9S   NOT = AP024-SRT-PURCHASE-ORDER)    03450004
034600                OR                                                03460004
034700               (PV-PO-NBR-9S       = AP024-SRT-PURCHASE-ORDER     03470004
034800                AND                                               03480004
034900                PV-STR-NBR-9S  NOT = AP024-SRT-STORE-NBR)         03490004
035000           IF NOT END-OF-RECV-KEYS                                03500004
035100              PERFORM C100-CHECKPOINT-COMMIT                      03510004
035200           END-IF                                                 03520004
035300        ELSE                                                      03530004
035400           CONTINUE                                               03540004
035500        END-IF                                                    03550004
035600     END-IF.                                                      03560004
035700                                                                  03570004
035800* FETCH THE NEXT PO STORE TABLE RECORD                            03580004
035900                                                                  03590004
036000     IF RESTART-RUN                                               03600004
036100        PERFORM R100-FETCH-PO-STR-CHK                             03610004
036200     ELSE                                                         03620004
036300        PERFORM R200-FETCH-PO-STR.                                03630004
036400                                                                  03640004
036500*----------------------------------------------------------------*03650004
036600*    PROCESS THE KEYS ON THE RECEIVING FILE TO UPDATE            *03660004
036700*    TRECDIS, TRECEIV, OR TNINREC                                *03670004
036800*----------------------------------------------------------------*03680004
036900 B200-PROCESS-RECV-KEYS.                                          03690004
037000                                                                  03700004
037100     EVALUATE TRUE                                                03710004
037200        WHEN AP024-TRECDIS-UPDATE                                 03720004
037300             ADD 1   TO PV-TRECDIS-INPUT-COUNT                    03730004
037400             PERFORM U100-UPDATE-TRECDIS                          03740004
037500        WHEN AP024-TRECEIV-UPDATE                                 03750004
037600             ADD 1   TO PV-TRECEIV-INPUT-COUNT                    03760004
037700             PERFORM U200-UPDATE-TRECEIV                          03770004
037800        WHEN AP024-TNINREC-UPDATE                                 03780004
037900             ADD 1   TO PV-TNINREC-INPUT-COUNT                    03790004
038000             PERFORM U300-UPDATE-TNINREC                          03800004
038100     END-EVALUATE.                                                03810004
038200                                                                  03820004
038300     PERFORM R300-READ-RECV-KEYS.                                 03830004
038400                                                                  03840004
038500                                                                  03850004
038600*----------------------------------------------------------------*03860004
038700*    DO THE CHECKPOINT RESTART AND THE COMMIT.                   *03870004
038800*----------------------------------------------------------------*03880004
038900 C100-CHECKPOINT-COMMIT.                                          03890004
039000                                                                  03900004
039100     MOVE 'C100-CHECKPOINT-COMMIT' TO PV-CURRENT-PARAGRAPH.       03910004
039200                                                                  03920004
039300     EXEC SQL                                                     03930004
039400       SET :CR-CURR-TMST = CURRENT TIMESTAMP                      03940004
039500     END-EXEC.                                                    03950004
039600                                                                  03960004
039700     EVALUATE TRUE                                                03970004
039800         WHEN SQLCODE = ZERO                                      03980004
039900              CONTINUE                                            03990004
040000                                                                  04000004
040100        WHEN SQLWARN0 NOT = SPACES                                04010004
040200        WHEN SQLCODE  NOT = ZERO                                  04020004
040300            MOVE PV-CURRENT-PARAGRAPH                             04030004
040400                                TO AA-PARAGRAPH-NAME              04040004
040500            MOVE 'UNSUCCESSFUL SET TMST'                          04050004
040600                                TO AA-DB2-OPERATION               04060004
040700            MOVE SPACES         TO AA-DB2-TABLE                   04070004
040800            PERFORM Z999-DB2-ABEND                                04080004
040900     END-EVALUATE.                                                04090004
041000                                                                  04100004
041100     IF CR-CURR-TMST > CR-NEXT-TMST                               04110004
041200        MOVE PC-IN-PROCESS-CODE      TO PV-CKPT-STAT-CODE         04120004
041300        PERFORM U500-UPDATE-TCKRSTCNTL                            04130004
041400        PERFORM U600-UPDATE-TCKRSTINF                             04140004
041500        PERFORM U900-COMMIT                                       04150004
041600                                                                  04160004
041700        EXEC SQL                                                  04170004
041800         SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)     04180004
041900          INTO :CR-NEXT-TMST                                      04190004
042000          FROM TCKRSTCNTL                                         04200004
042100          WHERE PLAN_NAME = :PV-PROGRAM-NAME                      04210004
042200        END-EXEC                                                  04220004
042300                                                                  04230004
042400          EVALUATE TRUE                                           04240004
042500              WHEN SQLCODE = ZERO                                 04250004
042600                   CONTINUE                                       04260004
042700                                                                  04270004
042800          WHEN SQLWARN0 NOT = SPACES                              04280004
042900          WHEN SQLCODE  NOT = ZERO                                04290004
043000              MOVE PV-CURRENT-PARAGRAPH                           04300004
043100                                  TO AA-PARAGRAPH-NAME            04310004
043200              MOVE 'UNSUCCESSFUL NEXT TMST'                       04320004
043300                                  TO AA-DB2-OPERATION             04330004
043400              MOVE SPACES         TO AA-DB2-TABLE                 04340004
043500              PERFORM Z999-DB2-ABEND                              04350004
043600       END-EVALUATE                                               04360004
043700     END-IF.                                                      04370004
043800                                                                  04380004
043900*----------------------------------------------------------------*04390004
044000*    GET THE RESTART INFO                                        *04400004
044100*----------------------------------------------------------------*04410004
044200 C200-CHECKPOINT-RESTART.                                         04420004
044300                                                                  04430004
044400     MOVE 'C200-CHECKPOINT-RESTART' TO PV-CURRENT-PARAGRAPH.      04440004
044500                                                                  04450004
044600     PERFORM R500-GET-CHECKPOINT-INFO.                            04460004
044700     MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO CKPT-RESTART-INFO.     04470004
044800*  MOVE THE CHECKPOINT RESTART INFORMATION TO COMP FIELDS FOR     04480004
044900*  DB2 CURSOR WHERE CLAUSE                                        04490004
045000                                                                  04500004
045100     MOVE CR-PO-NBR          TO PV-PO-NBR.                        04510004
045200     MOVE CR-STR-NBR         TO PV-STR-NBR.                       04520004
045300                                                                  04530004
045400     DISPLAY '** APKUP025 CHECKPOINT RESTART **'                  04540004
045500     DISPLAY '** PO NUMBER ON RESTART = '  CR-PO-NBR.             04550004
045600     DISPLAY '** STR NUMBER ON RESTART= '  CR-STR-NBR.            04560004
045700     DISPLAY '***********************************************'.   04570004
045800                                                                  04580004
045900*----------------------------------------------------------------*04590004
046000*    RETRIEVES THE PO STORE INFO FROM THE TPOSTRR TABLE.         *04600004
046100*    THIS IS FOR THE RESTART LOGIC                               *04610004
046200*----------------------------------------------------------------*04620004
046300 R100-FETCH-PO-STR-CHK.                                           04630004
046400                                                                  04640004
046500     MOVE 'R100-FETCH-PO-STR' TO PV-CURRENT-PARAGRAPH.            04650004
046600                                                                  04660004
046700     PERFORM WITH TEST AFTER                                      04670004
046800             VARYING PC-RETRY-COUNT FROM 1 BY 1                   04680004
046900             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             04690004
047000                     SQLCODE = ZERO OR                            04700004
047100                     SQLCODE = +100                               04710004
047200                                                                  04720004
047300             EXEC SQL                                             04730004
047400                 FETCH PO_STR_CHKPT_CSR                           04740004
047500                 INTO :POSTRR-PO-NBR                              04750004
047600                    , :POSTRR-STR-NBR                             04760004
047700                    , :POSTRR-PAYT-RLSE-TMST                      04770004
047800             END-EXEC                                             04780004
047900                                                                  04790004
048000             EVALUATE TRUE                                        04800004
048100                 WHEN SQLCODE = ZERO                              04810004
048200                 WHEN SQLCODE = +100                              04820004
048300                 WHEN SQLCODE = -904                              04830004
048400                 WHEN SQLCODE = -913                              04840004
048500                      CONTINUE                                    04850004
048600                                                                  04860004
048700                 WHEN SQLWARN0 NOT = SPACES                       04870004
048800                 WHEN SQLCODE  NOT = ZERO                         04880004
048900                     MOVE PV-CURRENT-PARAGRAPH                    04890004
049000                                         TO AA-PARAGRAPH-NAME     04900004
049100                     MOVE 'UNSUCCESSFUL FETCH WITH PO_STR_CHK'    04910004
049200                                         TO AA-DB2-OPERATION      04920004
049300                     MOVE 'TPOSTRR'      TO AA-DB2-TABLE          04930004
049400                     PERFORM Z999-DB2-ABEND                       04940004
049500             END-EVALUATE                                         04950004
049600     END-PERFORM.                                                 04960004
049700                                                                  04970004
049800     IF PC-RETRY-COUNT > PC-RETRY-MAX                             04980004
049900         MOVE PV-CURRENT-PARAGRAPH                                04990004
050000                             TO AA-PARAGRAPH-NAME                 05000004
050100         MOVE 'MAX RETRIES EXCEEDED ON FETCH FOR PO_STR_CHK'      05010004
050200                             TO AA-DB2-OPERATION                  05020004
050300         MOVE 'TPOSTRR'      TO AA-DB2-TABLE                      05030004
050400         PERFORM Z999-DB2-ABEND                                   05040004
050500     END-IF.                                                      05050004
050600                                                                  05060004
050700     EVALUATE TRUE                                                05070004
050800         WHEN SQLCODE = ZEROS                                     05080004
050900              MOVE POSTRR-PO-NBR  TO PV-PO-NBR-9S                 05090004
051000              MOVE POSTRR-STR-NBR TO PV-STR-NBR-9S                05100004
051100              ADD 1               TO PV-PO-STR-INPUT-COUNT        05110004
051200         WHEN SQLCODE = +100                                      05120004
051300              SET END-OF-PO-STR TO TRUE                           05130004
051400         WHEN OTHER                                               05140004
051500             MOVE PV-CURRENT-PARAGRAPH                            05150004
051600                                 TO AA-PARAGRAPH-NAME             05160004
051700             MOVE 'UNSUCCESSFUL FETCH WITH PO_STR_CHK'            05170004
051800                                 TO AA-DB2-OPERATION              05180004
051900             MOVE 'TPOSTRR'      TO AA-DB2-TABLE                  05190004
052000             PERFORM Z999-DB2-ABEND                               05200004
052100     END-EVALUATE.                                                05210004
052200                                                                  05220004
052300*----------------------------------------------------------------*05230004
052400*    RETRIEVES THE PO STORE INFO FROM THE TPOSTRR TABLE.         *05240004
052500*    THIS IS FOR THE REGULAR LOGIC                               *05250004
052600*----------------------------------------------------------------*05260004
052700 R200-FETCH-PO-STR.                                               05270004
052800                                                                  05280004
052900     MOVE 'R200-FETCH-PO-STR' TO PV-CURRENT-PARAGRAPH.            05290004
053000                                                                  05300004
053100     PERFORM WITH TEST AFTER                                      05310004
053200             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05320004
053300             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05330004
053400                     SQLCODE = ZERO OR                            05340004
053500                     SQLCODE = +100                               05350004
053600                                                                  05360004
053700             EXEC SQL                                             05370004
053800                 FETCH PO_STR_CSR                                 05380004
053900                 INTO :POSTRR-PO-NBR                              05390004
054000                    , :POSTRR-STR-NBR                             05400004
054100                    , :POSTRR-PAYT-RLSE-TMST                      05410004
054200             END-EXEC                                             05420004
054300                                                                  05430004
054400             EVALUATE TRUE                                        05440004
054500                 WHEN SQLCODE = ZERO                              05450004
054600                 WHEN SQLCODE = +100                              05460004
054700                 WHEN SQLCODE = -904                              05470004
054800                 WHEN SQLCODE = -913                              05480004
054900                      CONTINUE                                    05490004
055000                                                                  05500004
055100                 WHEN SQLWARN0 NOT = SPACES                       05510004
055200                 WHEN SQLCODE  NOT = ZERO                         05520004
055300                     MOVE PV-CURRENT-PARAGRAPH                    05530004
055400                                         TO AA-PARAGRAPH-NAME     05540004
055500                     MOVE 'UNSUCCESSFUL FETCH WITH PO_STR_CSR'    05550004
055600                                         TO AA-DB2-OPERATION      05560004
055700                     MOVE 'TPOSTRR'      TO AA-DB2-TABLE          05570004
055800                     PERFORM Z999-DB2-ABEND                       05580004
055900             END-EVALUATE                                         05590004
056000     END-PERFORM.                                                 05600004
056100                                                                  05610004
056200     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05620004
056300         MOVE PV-CURRENT-PARAGRAPH                                05630004
056400                             TO AA-PARAGRAPH-NAME                 05640004
056500         MOVE 'MAX RETRIES EXCEEDED ON FETCH FOR PO_STR_CSR'      05650004
056600                             TO AA-DB2-OPERATION                  05660004
056700         MOVE 'TPOSTRR'      TO AA-DB2-TABLE                      05670004
056800         PERFORM Z999-DB2-ABEND                                   05680004
056900     END-IF.                                                      05690004
057000                                                                  05700004
057100     EVALUATE TRUE                                                05710004
057200         WHEN SQLCODE = ZEROS                                     05720004
057300              MOVE POSTRR-PO-NBR   TO PV-PO-NBR-9S                05730004
057400              MOVE POSTRR-STR-NBR  TO PV-STR-NBR-9S               05740004
057500              ADD 1               TO PV-PO-STR-INPUT-COUNT        05750004
057600         WHEN SQLCODE = +100                                      05760004
057700              SET END-OF-PO-STR TO TRUE                           05770004
057800         WHEN OTHER                                               05780004
057900             MOVE PV-CURRENT-PARAGRAPH                            05790004
058000                                 TO AA-PARAGRAPH-NAME             05800004
058100             MOVE 'UNSUCCESSFUL FETCH WITH PO_STR_CSR'            05810004
058200                                 TO AA-DB2-OPERATION              05820004
058300             MOVE 'TPOSTRR'      TO AA-DB2-TABLE                  05830004
058400             PERFORM Z999-DB2-ABEND                               05840004
058500     END-EVALUATE.                                                05850004
058600                                                                  05860004
058700 R300-READ-RECV-KEYS.                                             05870004
058800                                                                  05880004
058900     READ RECV-KEYS-FILE                                          05890004
059000          INTO AP024-RECORD                                       05900004
059100          AT END SET END-OF-RECV-KEYS   TO TRUE.                  05910004
059200                                                                  05920004
059300     IF NOT END-OF-RECV-KEYS                                      05930004
059400         ADD 1 TO PV-RECV-KEY-INPUT-COUNT                         05940004
059500     END-IF.                                                      05950004
059600                                                                  05960004
059700*----------------------------------------------------------------*05970004
059800*    SELECT CHECKPOINT RESTART CONTROL INFO.                     *05980004
059900*----------------------------------------------------------------*05990004
060000 R400-GET-CHECKPOINT-CNTL.                                        06000004
060100                                                                  06010004
060200     MOVE 'R400-GET-CHECKPOINT-CNTL' TO PV-CURRENT-PARAGRAPH.     06020004
060300                                                                  06030004
060400     PERFORM WITH TEST AFTER                                      06040004
060500             VARYING PC-RETRY-COUNT FROM 1 BY 1                   06050004
060600             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             06060004
060700                     SQLCODE = ZERO                               06070004
060800                                                                  06080004
060900             EXEC SQL                                             06090004
061000              SELECT CKPT_STAT_CODE                               06100004
061100               INTO :PV-CKPT-STAT-CODE                            06110004
061200               FROM TCKRSTCNTL                                    06120004
061300               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 06130004
061400             END-EXEC                                             06140004
061500                                                                  06150004
061600             EVALUATE TRUE                                        06160004
061700                 WHEN SQLCODE = ZERO                              06170004
061800                 WHEN SQLCODE = -904                              06180004
061900                 WHEN SQLCODE = -913                              06190004
062000                      CONTINUE                                    06200004
062100                                                                  06210004
062200                 WHEN SQLWARN0 NOT = SPACES                       06220004
062300                 WHEN SQLCODE  NOT = ZERO                         06230004
062400                     MOVE PV-CURRENT-PARAGRAPH                    06240004
062500                                         TO AA-PARAGRAPH-NAME     06250004
062600                     DISPLAY '******** PLAN_NAME:'                06260004
062700                              PV-PROGRAM-NAME                     06270004
062800                     MOVE SPACES TO AA-MESSAGE-1                  06280004
062900                                    AA-MESSAGE-2                  06290004
063000                     MOVE 'UNSUCCESSFUL SELECT'                   06300004
063100                                         TO AA-DB2-OPERATION      06310004
063200                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          06320004
063300                     PERFORM Z999-DB2-ABEND                       06330004
063400             END-EVALUATE                                         06340004
063500     END-PERFORM.                                                 06350004
063600                                                                  06360004
063700     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06370004
063800         MOVE PV-CURRENT-PARAGRAPH                                06380004
063900                             TO AA-PARAGRAPH-NAME                 06390004
064000         DISPLAY '******** PLAN_NAME:'                            06400004
064100                  PV-PROGRAM-NAME                                 06410004
064200         MOVE SPACES TO AA-MESSAGE-1                              06420004
064300                        AA-MESSAGE-2                              06430004
064400         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    06440004
064500                             TO AA-DB2-OPERATION                  06450004
064600         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      06460004
064700         PERFORM Z999-DB2-ABEND                                   06470004
064800     END-IF.                                                      06480004
064900                                                                  06490004
065000*----------------------------------------------------------------*06500004
065100*    SELECT CHECKPOINT RESTART WORKING STORAGE DESCRIPTION INFO  *06510004
065200*----------------------------------------------------------------*06520004
065300 R500-GET-CHECKPOINT-INFO.                                        06530004
065400                                                                  06540004
065500     MOVE 'R400-GET-CHECKPOINT-INFO' TO PV-CURRENT-PARAGRAPH.     06550004
065600                                                                  06560004
065700     PERFORM WITH TEST AFTER                                      06570004
065800             VARYING PC-RETRY-COUNT FROM 1 BY 1                   06580004
065900             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             06590004
066000                     SQLCODE = ZERO                               06600004
066100                                                                  06610004
066200             EXEC SQL                                             06620004
066300              SELECT WORK_STRG_DESC                               06630004
066400               INTO :TCKRSTINF-WORK-STRG-DESC                     06640004
066500               FROM TCKRSTINF                                     06650004
066600               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 06660004
066700             END-EXEC                                             06670004
066800                                                                  06680004
066900             EVALUATE TRUE                                        06690004
067000                 WHEN SQLCODE = ZERO                              06700004
067100                 WHEN SQLCODE = -904                              06710004
067200                 WHEN SQLCODE = -913                              06720004
067300                      CONTINUE                                    06730004
067400                                                                  06740004
067500                 WHEN SQLWARN0 NOT = SPACES                       06750004
067600                 WHEN SQLCODE  NOT = ZERO                         06760004
067700                     MOVE PV-CURRENT-PARAGRAPH                    06770004
067800                                         TO AA-PARAGRAPH-NAME     06780004
067900                     DISPLAY '******** PLAN_NAME:'                06790004
068000                              PV-PROGRAM-NAME                     06800004
068100                     MOVE SPACES TO AA-MESSAGE-1                  06810004
068200                                    AA-MESSAGE-2                  06820004
068300                     MOVE 'UNSUCCESSFUL SELECT'                   06830004
068400                                         TO AA-DB2-OPERATION      06840004
068500                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          06850004
068600                     PERFORM Z999-DB2-ABEND                       06860004
068700             END-EVALUATE                                         06870004
068800     END-PERFORM.                                                 06880004
068900                                                                  06890004
069000     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06900004
069100         MOVE PV-CURRENT-PARAGRAPH                                06910004
069200                             TO AA-PARAGRAPH-NAME                 06920004
069300         DISPLAY '******** PLAN_NAME:'                            06930004
069400                  PV-PROGRAM-NAME                                 06940004
069500         MOVE SPACES TO AA-MESSAGE-1                              06950004
069600                        AA-MESSAGE-2                              06960004
069700         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    06970004
069800                             TO AA-DB2-OPERATION                  06980004
069900         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      06990004
070000         PERFORM Z999-DB2-ABEND                                   07000004
070100     END-IF.                                                      07010004
070200                                                                  07020004
070300                                                                  07030004
070400*----------------------------------------------------------------*07040004
070500*    CONTROLS UPDATING OF THE TRECDIS TABLE.                     *07050004
070600*----------------------------------------------------------------*07060004
070700 U100-UPDATE-TRECDIS.                                             07070004
070800                                                                  07080004
070900     MOVE 'U100-UPDATE-TRECDIS' TO PV-CURRENT-PARAGRAPH.          07090004
071000                                                                  07100004
071100     PERFORM WITH TEST AFTER                                      07110004
071200             VARYING PC-RETRY-COUNT FROM 1 BY 1                   07120004
071300             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             07130004
071400                     SQLCODE = ZERO                               07140004
071500                                                                  07150004
071600             EXEC SQL                                             07160004
071700                 UPDATE TRECDIS                                   07170004
071800                 SET AP_PRC_CDE = 'M',                            07180004
071900                     AP_PRC_DTE = :AP024-AP-PRC-DTE               07190004
072000                 WHERE ORD_NBR        = :AP024-RD-PURCHASE-ORDER  07200004
072100                   AND ORD_LNE_NBR    = :AP024-RD-PO-LNE-NBR      07210004
072200                   AND REC_SEQ_NBR    = :AP024-RD-REC-SEQ-NBR     07220004
072300                   AND OPER_UNT_ID    = :AP024-RD-OPER-UNIT-ID    07230004
072400                   AND FCLTY_ID       = :AP024-RD-FACILITY-ID     07240004
072500                   AND STR_NBR        = :AP024-RD-STORE-NBR       07250004
072600                   AND STR_FCLTY_ID   = :AP024-RD-STORE-FCLTY-ID  07260004
072700                   AND CRE_TMST       = :AP024-RD-CRE-TMST        07270004
072800                   AND AP_PRC_CDE     = ' '                       07280004
072900             END-EXEC                                             07290004
073000                                                                  07300004
073100             EVALUATE TRUE                                        07310004
073200                 WHEN SQLCODE = ZERO                              07320004
073300                 WHEN SQLCODE = -904                              07330004
073400                 WHEN SQLCODE = -913                              07340004
073500                      CONTINUE                                    07350004
073600                                                                  07360004
073700                 WHEN SQLWARN0 NOT = SPACES                       07370004
073800                 WHEN SQLCODE  NOT = ZERO                         07380004
073900                     MOVE PV-CURRENT-PARAGRAPH                    07390004
074000                                         TO AA-PARAGRAPH-NAME     07400004
074100                     DISPLAY '******** PO:'                       07410004
074200                              AP024-SRT-PURCHASE-ORDER            07420004
074300                     DISPLAY '******** PO LINE NBR:'              07430004
074400                              AP024-RD-PO-LNE-NBR                 07440004
074500                     DISPLAY '******** RECVR SEQ:'                07450004
074600                              AP024-RD-REC-SEQ-NBR                07460004
074700                     MOVE SPACES TO AA-MESSAGE-1                  07470004
074800                                    AA-MESSAGE-2                  07480004
074900                     MOVE 'UNSUCCESSFUL UPDATE'                   07490004
075000                                         TO AA-DB2-OPERATION      07500004
075100                     MOVE 'TRECDIS'      TO AA-DB2-TABLE          07510004
075200                     PERFORM Z999-DB2-ABEND                       07520004
075300             END-EVALUATE                                         07530004
075400     END-PERFORM.                                                 07540004
075500                                                                  07550004
075600     IF PC-RETRY-COUNT > PC-RETRY-MAX                             07560004
075700         MOVE PV-CURRENT-PARAGRAPH                                07570004
075800                             TO AA-PARAGRAPH-NAME                 07580004
075900         DISPLAY '******** PO:'                                   07590004
076000                  AP024-SRT-PURCHASE-ORDER                        07600004
076100         DISPLAY '******** PO LINE NBR:'                          07610004
076200                  AP024-RD-PO-LNE-NBR                             07620004
076300         DISPLAY '******** RECVR SEQ:'                            07630004
076400                  AP024-RD-REC-SEQ-NBR                            07640004
076500         MOVE SPACES TO AA-MESSAGE-1                              07650004
076600                        AA-MESSAGE-2                              07660004
076700         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    07670004
076800                             TO AA-DB2-OPERATION                  07680004
076900         MOVE 'TRECDIS'      TO AA-DB2-TABLE                      07690004
077000         PERFORM Z999-DB2-ABEND                                   07700004
077100     END-IF.                                                      07710004
077200                                                                  07720004
077300     EVALUATE TRUE                                                07730004
077400         WHEN SQLCODE = ZEROS                                     07740004
077500             ADD 1 TO PV-TRECDIS-UPDATE-COUNT                     07750004
077600         WHEN OTHER                                               07760004
077700             MOVE PV-CURRENT-PARAGRAPH                            07770004
077800                                 TO AA-PARAGRAPH-NAME             07780004
077900             DISPLAY '******** PO:'                               07790004
078000                      AP024-SRT-PURCHASE-ORDER                    07800004
078100             DISPLAY '******** PO LINE NBR:'                      07810004
078200                      AP024-RD-PO-LNE-NBR                         07820004
078300             DISPLAY '******** RECVR SEQ:'                        07830004
078400                      AP024-RD-REC-SEQ-NBR                        07840004
078500             MOVE SPACES TO AA-MESSAGE-1                          07850004
078600                            AA-MESSAGE-2                          07860004
078700             MOVE 'UNSUCCESSFUL UPDATE'                           07870004
078800                                 TO AA-DB2-OPERATION              07880004
078900             MOVE 'TRECDIS'      TO AA-DB2-TABLE                  07890004
079000             PERFORM Z999-DB2-ABEND                               07900004
079100     END-EVALUATE.                                                07910004
079200                                                                  07920004
079300*----------------------------------------------------------------*07930004
079400*    CONTROLS UPDATING OF THE TRECEIV TABLE.                     *07940004
079500*----------------------------------------------------------------*07950004
079600 U200-UPDATE-TRECEIV.                                             07960004
079700                                                                  07970004
079800     MOVE 'U200-UPDATE-TRECEIV' TO PV-CURRENT-PARAGRAPH.          07980004
079900                                                                  07990004
080000     MOVE AP024-RC-CRE-TMST(1:10) TO TEMP-TMST.                   08000004
080100                                                                  08010004
080200     PERFORM WITH TEST AFTER                                      08020004
080300             VARYING PC-RETRY-COUNT FROM 1 BY 1                   08030004
080400             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             08040004
080500                     SQLCODE = ZERO                               08050004
080600                                                                  08060004
080700             EXEC SQL                                             08070004
080800                 UPDATE TRECEIV                                   08080004
080900                 SET AP_PRC_CDE = 'M',                            08090004
081000                     AP_PRC_DTE = :AP024-AP-PRC-DTE               08100004
081100                 WHERE ORD_NBR        = :AP024-RC-PURCHASE-ORDER  08110004
081200                   AND REC_SEQ_NBR    = :AP024-RC-RECVR-SEQ-NBR   08120004
081300*                  AND CRE_TMST       = :AP024-RC-CRE-TMST        08130004
081400*                  AND DATE(CRE_TMST) = :TEMP-TMST                08140004
081500                   AND VER_STATUS_CDE = 'A'                       08150004
081600                   AND AP_PRC_CDE     = ' '                       08160004
081700             END-EXEC                                             08170004
081800                                                                  08180004
081900             EVALUATE TRUE                                        08190004
082000                 WHEN SQLCODE = ZERO                              08200004
082100                 WHEN SQLCODE = -904                              08210004
082200                 WHEN SQLCODE = -913                              08220004
082300                      CONTINUE                                    08230004
082400                                                                  08240004
082500                 WHEN SQLWARN0 NOT = SPACES                       08250004
082600                 WHEN SQLCODE  NOT = ZERO                         08260004
082700                     MOVE PV-CURRENT-PARAGRAPH                    08270004
082800                                         TO AA-PARAGRAPH-NAME     08280004
082900                     DISPLAY '******** PO:'                       08290004
083000                              AP024-RC-PURCHASE-ORDER             08300004
083100                     DISPLAY '******** RECVR SEQ:'                08310004
083200                              AP024-RC-RECVR-SEQ-NBR              08320004
083300                     MOVE SPACES TO AA-MESSAGE-1                  08330004
083400                                    AA-MESSAGE-2                  08340004
083500                     MOVE 'UNSUCCESSFUL UPDATE'                   08350004
083600                                         TO AA-DB2-OPERATION      08360004
083700                     MOVE 'TRECEIV'      TO AA-DB2-TABLE          08370004
083800                     PERFORM Z999-DB2-ABEND                       08380004
083900             END-EVALUATE                                         08390004
084000     END-PERFORM.                                                 08400004
084100                                                                  08410004
084200     IF PC-RETRY-COUNT > PC-RETRY-MAX                             08420004
084300         MOVE PV-CURRENT-PARAGRAPH                                08430004
084400                             TO AA-PARAGRAPH-NAME                 08440004
084500         DISPLAY '******** PO:'                                   08450004
084600                  AP024-RC-PURCHASE-ORDER                         08460004
084700         DISPLAY '******** RECVR SEQ:'                            08470004
084800                  AP024-RC-RECVR-SEQ-NBR                          08480004
084900         MOVE SPACES TO AA-MESSAGE-1                              08490004
085000                        AA-MESSAGE-2                              08500004
085100         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    08510004
085200                             TO AA-DB2-OPERATION                  08520004
085300         MOVE 'TRECEIV'      TO AA-DB2-TABLE                      08530004
085400         PERFORM Z999-DB2-ABEND                                   08540004
085500     END-IF.                                                      08550004
085600                                                                  08560004
085700     EVALUATE TRUE                                                08570004
085800         WHEN SQLCODE = ZEROS                                     08580004
085900             ADD 1 TO PV-TRECEIV-UPDATE-COUNT                     08590004
086000         WHEN OTHER                                               08600004
086100             MOVE PV-CURRENT-PARAGRAPH                            08610004
086200                                 TO AA-PARAGRAPH-NAME             08620004
086300             DISPLAY '******** PO:'                               08630004
086400                      AP024-RC-PURCHASE-ORDER                     08640004
086500             DISPLAY '******** RECVR SEQ:'                        08650004
086600                      AP024-RC-RECVR-SEQ-NBR                      08660004
086700             MOVE SPACES TO AA-MESSAGE-1                          08670004
086800                            AA-MESSAGE-2                          08680004
086900             MOVE 'UNSUCCESSFUL UPDATE'                           08690004
087000                                 TO AA-DB2-OPERATION              08700004
087100             MOVE 'TRECEIV'      TO AA-DB2-TABLE                  08710004
087200             PERFORM Z999-DB2-ABEND                               08720004
087300     END-EVALUATE.                                                08730004
087400                                                                  08740004
087500*----------------------------------------------------------------*08750004
087600*    UPDATES THE NON-INVOICED RECEIPT TABLE.  THE STATUS CODE    *08760004
087700*----------------------------------------------------------------*08770004
087800 U300-UPDATE-TNINREC.                                             08780004
087900                                                                  08790004
088000     MOVE 'U300-UPDATE-TNINREC' TO PV-CURRENT-PARAGRAPH.          08800004
088100                                                                  08810004
088200     PERFORM WITH TEST AFTER                                      08820004
088300             VARYING PC-RETRY-COUNT FROM 1 BY 1                   08830004
088400             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             08840004
088500                     SQLCODE = ZERO                               08850004
088600                                                                  08860004
088700             EXEC SQL                                             08870004
088800                 UPDATE TNINREC                                   08880004
088900                 SET STATUS_CDE     = 'M',                        08890004
089000                     PAYT_RLSE_TMST = :POSTRR-PAYT-RLSE-TMST      08900004
089100                 WHERE PO_NBR         = :AP024-NR-PURCHASE-ORDER  08910004
089200                   AND PO_LNE_NBR     = :AP024-NR-PO-LNE-NBR      08920004
089300                   AND NON_INVC_SEQ_NBR                           08930004
089400                                      = :AP024-NR-NINVC-SEQ-NBR   08940004
089500                   AND STATUS_CDE     = ' '                       08950004
089600             END-EXEC                                             08960004
089700                                                                  08970004
089800             EVALUATE TRUE                                        08980004
089900                 WHEN SQLCODE = ZERO                              08990004
090000                 WHEN SQLCODE = -904                              09000004
090100                 WHEN SQLCODE = -913                              09010004
090200                      CONTINUE                                    09020004
090300                                                                  09030004
090400                 WHEN SQLWARN0 NOT = SPACES                       09040004
090500                 WHEN SQLCODE  NOT = ZERO                         09050004
090600                     MOVE PV-CURRENT-PARAGRAPH                    09060004
090700                                         TO AA-PARAGRAPH-NAME     09070004
090800                     DISPLAY '******** PO:'                       09080004
090900                              AP024-NR-PURCHASE-ORDER             09090004
091000                     DISPLAY '******** PO LINE NBR:'              09100004
091100                              AP024-NR-PO-LNE-NBR                 09110004
091200                     DISPLAY '******** NON INV SEQ:'              09120004
091300                              AP024-NR-NINVC-SEQ-NBR              09130004
091400                     MOVE SPACES TO AA-MESSAGE-1                  09140004
091500                                    AA-MESSAGE-2                  09150004
091600                     MOVE 'UNSUCCESSFUL UPDATE'                   09160004
091700                                         TO AA-DB2-OPERATION      09170004
091800                     MOVE 'TNINREC'      TO AA-DB2-TABLE          09180004
091900                     PERFORM Z999-DB2-ABEND                       09190004
092000             END-EVALUATE                                         09200004
092100     END-PERFORM.                                                 09210004
092200                                                                  09220004
092300     IF PC-RETRY-COUNT > PC-RETRY-MAX                             09230004
092400         MOVE PV-CURRENT-PARAGRAPH                                09240004
092500                             TO AA-PARAGRAPH-NAME                 09250004
092600         DISPLAY '******** PO:'                                   09260004
092700                  AP024-NR-PURCHASE-ORDER                         09270004
092800         DISPLAY '******** PO LINE NBR:'                          09280004
092900                  AP024-NR-PO-LNE-NBR                             09290004
093000         DISPLAY '******** NON INV SEQ:'                          09300004
093100                  AP024-NR-NINVC-SEQ-NBR                          09310004
093200         MOVE SPACES TO AA-MESSAGE-1                              09320004
093300                        AA-MESSAGE-2                              09330004
093400         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    09340004
093500                             TO AA-DB2-OPERATION                  09350004
093600         MOVE 'TNINREC'      TO AA-DB2-TABLE                      09360004
093700         PERFORM Z999-DB2-ABEND                                   09370004
093800     END-IF.                                                      09380004
093900                                                                  09390004
094000     EVALUATE TRUE                                                09400004
094100         WHEN SQLCODE = ZEROS                                     09410004
094200             ADD 1 TO PV-TNINREC-UPDATE-COUNT                     09420004
094300         WHEN OTHER                                               09430004
094400             MOVE PV-CURRENT-PARAGRAPH                            09440004
094500                                 TO AA-PARAGRAPH-NAME             09450004
094600             DISPLAY '******** PO:'                               09460004
094700                      AP024-NR-PURCHASE-ORDER                     09470004
094800             DISPLAY '******** PO LINE NBR:'                      09480004
094900                      AP024-NR-PO-LNE-NBR                         09490004
095000             DISPLAY '******** NON INV SEQ:'                      09500004
095100                      AP024-NR-NINVC-SEQ-NBR                      09510004
095200             MOVE SPACES TO AA-MESSAGE-1                          09520004
095300                            AA-MESSAGE-2                          09530004
095400             MOVE 'UNSUCCESSFUL UPDATE'                           09540004
095500                                 TO AA-DB2-OPERATION              09550004
095600             MOVE 'TNINREC'      TO AA-DB2-TABLE                  09560004
095700             PERFORM Z999-DB2-ABEND                               09570004
095800     END-EVALUATE.                                                09580004
095900*----------------------------------------------------------------*09590004
096000*    UPDATES THE CHECKPOINT RESTART CONTROL TABLE.  THE STATUS   *09600004
096100*    CODE IS SET TO '9' (RUN IN PROGRESS) OR '0' (RUN COMPLETE). *09610004
096200*----------------------------------------------------------------*09620004
096300 U500-UPDATE-TCKRSTCNTL.                                          09630004
096400                                                                  09640004
096500     MOVE 'U500-UPDATE-TCKRSTCNTL' TO PV-CURRENT-PARAGRAPH.       09650004
096600                                                                  09660004
096700     PERFORM WITH TEST AFTER                                      09670004
096800             VARYING PC-RETRY-COUNT FROM 1 BY 1                   09680004
096900             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             09690004
097000                     SQLCODE = ZERO                               09700004
097100                                                                  09710004
097200             EXEC SQL                                             09720004
097300                 UPDATE TCKRSTCNTL                                09730004
097400                 SET CKPT_STAT_CODE = :PV-CKPT-STAT-CODE          09740004
097500                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          09750004
097600             END-EXEC                                             09760004
097700                                                                  09770004
097800             EVALUATE TRUE                                        09780004
097900                 WHEN SQLCODE = ZERO                              09790004
098000                 WHEN SQLCODE = -904                              09800004
098100                 WHEN SQLCODE = -913                              09810004
098200                      CONTINUE                                    09820004
098300                                                                  09830004
098400                 WHEN SQLWARN0 NOT = SPACES                       09840004
098500                 WHEN SQLCODE  NOT = ZERO                         09850004
098600                     MOVE PV-CURRENT-PARAGRAPH                    09860004
098700                                         TO AA-PARAGRAPH-NAME     09870004
098800                     DISPLAY '******** PLAN_NAME:'                09880004
098900                              PV-PROGRAM-NAME                     09890004
099000                     MOVE SPACES TO AA-MESSAGE-1                  09900004
099100                                    AA-MESSAGE-2                  09910004
099200                     MOVE 'UNSUCCESSFUL UPDATE'                   09920004
099300                                         TO AA-DB2-OPERATION      09930004
099400                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          09940004
099500                     PERFORM Z999-DB2-ABEND                       09950004
099600             END-EVALUATE                                         09960004
099700     END-PERFORM.                                                 09970004
099800                                                                  09980004
099900     IF PC-RETRY-COUNT > PC-RETRY-MAX                             09990004
100000         MOVE PV-CURRENT-PARAGRAPH                                10000004
100100                             TO AA-PARAGRAPH-NAME                 10010004
100200         DISPLAY '******** PLAN_NAME:'                            10020004
100300                  PV-PROGRAM-NAME                                 10030004
100400         MOVE SPACES TO AA-MESSAGE-1                              10040004
100500                        AA-MESSAGE-2                              10050004
100600         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    10060004
100700                             TO AA-DB2-OPERATION                  10070004
100800         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      10080004
100900         PERFORM Z999-DB2-ABEND                                   10090004
101000     END-IF.                                                      10100004
101100                                                                  10110004
101200*----------------------------------------------------------------*10120004
101300*    UPDATES THE CHECKPOINT RESTART INFO TABLE.  THE WORKING     *10130004
101400*    STORAGE DESCRIPTION FIELD IS UPDATED WITH THE LAST COMMITED *10140004
101500*    PO STORE NUMBER COMBINATION.                                *10150004
101600*----------------------------------------------------------------*10160004
101700 U600-UPDATE-TCKRSTINF.                                           10170004
101800                                                                  10180004
101900     MOVE 'U600-UPDATE-TCKRSTINF' TO PV-CURRENT-PARAGRAPH.        10190004
102000                                                                  10200004
102100     MOVE PV-PO-NBR-9S        TO CR-PO-NBR.                       10210004
102200     MOVE PV-STR-NBR-9S       TO CR-STR-NBR.                      10220004
102300     MOVE CKPT-RESTART-INFO   TO TCKRSTINF-WORK-STRG-DESC-TEXT.   10230004
102400     MOVE 4022                TO TCKRSTINF-WORK-STRG-DESC-LEN.    10240004
102500                                                                  10250004
102600     PERFORM WITH TEST AFTER                                      10260004
102700             VARYING PC-RETRY-COUNT FROM 1 BY 1                   10270004
102800             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             10280004
102900                     SQLCODE = ZERO                               10290004
103000                                                                  10300004
103100             EXEC SQL                                             10310004
103200                 UPDATE TCKRSTINF                                 10320004
103300                 SET WORK_STRG_DESC   = :TCKRSTINF-WORK-STRG-DESC 10330004
103400                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          10340004
103500             END-EXEC                                             10350004
103600                                                                  10360004
103700             EVALUATE TRUE                                        10370004
103800                 WHEN SQLCODE = ZERO                              10380004
103900                 WHEN SQLCODE = -904                              10390004
104000                 WHEN SQLCODE = -913                              10400004
104100                      CONTINUE                                    10410004
104200                                                                  10420004
104300                 WHEN SQLWARN0 NOT = SPACES                       10430004
104400                 WHEN SQLCODE  NOT = ZERO                         10440004
104500                     MOVE PV-CURRENT-PARAGRAPH                    10450004
104600                                         TO AA-PARAGRAPH-NAME     10460004
104700                     DISPLAY '******** PLAN_NAME:'                10470004
104800                              PV-PROGRAM-NAME                     10480004
104900                     MOVE SPACES TO AA-MESSAGE-1                  10490004
105000                                    AA-MESSAGE-2                  10500004
105100                     MOVE 'UNSUCCESSFUL UPDATE'                   10510004
105200                                         TO AA-DB2-OPERATION      10520004
105300                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          10530004
105400                     PERFORM Z999-DB2-ABEND                       10540004
105500             END-EVALUATE                                         10550004
105600     END-PERFORM.                                                 10560004
105700                                                                  10570004
105800     IF PC-RETRY-COUNT > PC-RETRY-MAX                             10580004
105900         MOVE PV-CURRENT-PARAGRAPH                                10590004
106000                             TO AA-PARAGRAPH-NAME                 10600004
106100         DISPLAY '******** PLAN_NAME:'                            10610004
106200                  PV-PROGRAM-NAME                                 10620004
106300         MOVE SPACES TO AA-MESSAGE-1                              10630004
106400                        AA-MESSAGE-2                              10640004
106500         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    10650004
106600                             TO AA-DB2-OPERATION                  10660004
106700         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      10670004
106800         PERFORM Z999-DB2-ABEND                                   10680004
106900     END-IF.                                                      10690004
107000                                                                  10700004
107100*----------------------------------------------------------------*10710004
107200*    ISSUES AN SQL COMMIT WORK AFTER A LUW HAS BEEN COMPLETED.   *10720004
107300*----------------------------------------------------------------*10730004
107400 U900-COMMIT.                                                     10740004
107500                                                                  10750004
107600     MOVE 'U900-COMMIT'    TO PV-CURRENT-PARAGRAPH.               10760004
107700                                                                  10770004
107800     EXEC SQL                                                     10780004
107900         COMMIT                                                   10790004
108000     END-EXEC.                                                    10800004
108100                                                                  10810004
108200     EVALUATE TRUE                                                10820004
108300         WHEN SQLCODE = ZEROS                                     10830004
108400             CONTINUE                                             10840004
108500         WHEN OTHER                                               10850004
108600             MOVE PV-CURRENT-PARAGRAPH                            10860004
108700                                 TO AA-PARAGRAPH-NAME             10870004
108800             MOVE SPACES TO AA-MESSAGE-1                          10880004
108900                            AA-MESSAGE-2                          10890004
109000             MOVE 'UNSUCCESSFUL COMMIT'                           10900004
109100                                 TO AA-DB2-OPERATION              10910004
109200             MOVE SPACES         TO AA-DB2-TABLE                  10920004
109300             PERFORM Z999-DB2-ABEND                               10930004
109400     END-EVALUATE.                                                10940004
109500*----------------------------------------------------------------*10950004
109600*    OPENS THE PO STORE RESTART CURSOR.                          *10960004
109700*----------------------------------------------------------------*10970004
109800 Y100-OPEN-PO-STR-CHKPT-CSR.                                      10980004
109900                                                                  10990004
110000     MOVE 'Y100-OPEN-PO-STR-CHK' TO PV-CURRENT-PARAGRAPH.         11000004
110100                                                                  11010004
110200     PERFORM WITH TEST AFTER                                      11020004
110300             VARYING PC-RETRY-COUNT FROM 1 BY 1                   11030004
110400             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             11040004
110500                     SQLCODE = ZERO                               11050004
110600                                                                  11060004
110700             EXEC SQL                                             11070004
110800                 OPEN PO_STR_CHKPT_CSR                            11080004
110900             END-EXEC                                             11090004
111000                                                                  11100004
111100             EVALUATE TRUE                                        11110004
111200                 WHEN SQLCODE = ZERO                              11120004
111300                 WHEN SQLCODE = -904                              11130004
111400                 WHEN SQLCODE = -913                              11140004
111500                      CONTINUE                                    11150004
111600                                                                  11160004
111700                 WHEN SQLWARN0 NOT = SPACES                       11170004
111800                 WHEN SQLCODE  NOT = ZERO                         11180004
111900                     MOVE PV-CURRENT-PARAGRAPH                    11190004
112000                                         TO AA-PARAGRAPH-NAME     11200004
112100                     MOVE 'UNSUCCESSFUL OPEN ON PO_STR_CHK'       11210004
112200                                         TO AA-DB2-OPERATION      11220004
112300                     MOVE 'TPOSTRR'      TO AA-DB2-TABLE          11230004
112400                     PERFORM Z999-DB2-ABEND                       11240004
112500             END-EVALUATE                                         11250004
112600     END-PERFORM.                                                 11260004
112700                                                                  11270004
112800     IF PC-RETRY-COUNT > PC-RETRY-MAX                             11280004
112900         MOVE PV-CURRENT-PARAGRAPH                                11290004
113000                             TO AA-PARAGRAPH-NAME                 11300004
113100         MOVE 'MAX RETRIES EXCEEDED ON OPEN FOR PO_STR_CHK'       11310004
113200                             TO AA-DB2-OPERATION                  11320004
113300         MOVE 'TPOSTRR'      TO AA-DB2-TABLE                      11330004
113400         PERFORM Z999-DB2-ABEND                                   11340004
113500     END-IF.                                                      11350004
113600                                                                  11360004
113700     EVALUATE TRUE                                                11370004
113800         WHEN SQLCODE = ZEROS                                     11380004
113900              CONTINUE                                            11390004
114000         WHEN OTHER                                               11400004
114100             MOVE PV-CURRENT-PARAGRAPH                            11410004
114200                                 TO AA-PARAGRAPH-NAME             11420004
114300             MOVE 'UNSUCCESSFUL OPEN ON PO_STR_CHK'               11430004
114400                                 TO AA-DB2-OPERATION              11440004
114500             MOVE 'TPOSTRR'      TO AA-DB2-TABLE                  11450004
114600             PERFORM Z999-DB2-ABEND                               11460004
114700     END-EVALUATE.                                                11470004
114800                                                                  11480004
114900*----------------------------------------------------------------*11490004
115000*    OPENS THE PO STORE CURSOR.                                  *11500004
115100*----------------------------------------------------------------*11510004
115200 Y200-OPEN-PO-STR-CSR.                                            11520004
115300                                                                  11530004
115400     MOVE 'Y200-OPEN-PO-STR-CSR' TO PV-CURRENT-PARAGRAPH.         11540004
115500                                                                  11550004
115600     PERFORM WITH TEST AFTER                                      11560004
115700             VARYING PC-RETRY-COUNT FROM 1 BY 1                   11570004
115800             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             11580004
115900                     SQLCODE = ZERO                               11590004
116000                                                                  11600004
116100             EXEC SQL                                             11610004
116200                 OPEN PO_STR_CSR                                  11620004
116300             END-EXEC                                             11630004
116400                                                                  11640004
116500             EVALUATE TRUE                                        11650004
116600                 WHEN SQLCODE = ZERO                              11660004
116700                 WHEN SQLCODE = -904                              11670004
116800                 WHEN SQLCODE = -913                              11680004
116900                      CONTINUE                                    11690004
117000                                                                  11700004
117100                 WHEN SQLWARN0 NOT = SPACES                       11710004
117200                 WHEN SQLCODE  NOT = ZERO                         11720004
117300                     MOVE PV-CURRENT-PARAGRAPH                    11730004
117400                                         TO AA-PARAGRAPH-NAME     11740004
117500                     MOVE 'UNSUCCESSFUL OPEN ON PO_STR_CSR'       11750004
117600                                         TO AA-DB2-OPERATION      11760004
117700                     MOVE 'TPOSTRR'      TO AA-DB2-TABLE          11770004
117800                     PERFORM Z999-DB2-ABEND                       11780004
117900             END-EVALUATE                                         11790004
118000     END-PERFORM.                                                 11800004
118100                                                                  11810004
118200     IF PC-RETRY-COUNT > PC-RETRY-MAX                             11820004
118300         MOVE PV-CURRENT-PARAGRAPH                                11830004
118400                             TO AA-PARAGRAPH-NAME                 11840004
118500         MOVE 'MAX RETRIES EXCEEDED ON OPEN FOR PO_STR_CSR'       11850004
118600                             TO AA-DB2-OPERATION                  11860004
118700         MOVE 'TPOSTRR'      TO AA-DB2-TABLE                      11870004
118800         PERFORM Z999-DB2-ABEND                                   11880004
118900     END-IF.                                                      11890004
119000                                                                  11900004
119100     EVALUATE TRUE                                                11910004
119200         WHEN SQLCODE = ZEROS                                     11920004
119300              CONTINUE                                            11930004
119400         WHEN OTHER                                               11940004
119500             MOVE PV-CURRENT-PARAGRAPH                            11950004
119600                                 TO AA-PARAGRAPH-NAME             11960004
119700             MOVE 'UNSUCCESSFUL OPEN ON PO_STR_CSR'               11970004
119800                                 TO AA-DB2-OPERATION              11980004
119900             MOVE 'TPOSTRR'      TO AA-DB2-TABLE                  11990004
120000             PERFORM Z999-DB2-ABEND                               12000004
120100     END-EVALUATE.                                                12010004
120200                                                                  12020004
120300*----------------------------------------------------------------*12030004
120400*    CLOSES THE PO STORE RESTART CURSOR.                          12040004
120500*----------------------------------------------------------------*12050004
120600 Y300-CLOSE-PO-STR-CHKPT-CSR.                                     12060004
120700                                                                  12070004
120800     MOVE 'Y300-CLOSE-PO-STR-CHK' TO PV-CURRENT-PARAGRAPH.        12080004
120900                                                                  12090004
121000     PERFORM WITH TEST AFTER                                      12100004
121100             VARYING PC-RETRY-COUNT FROM 1 BY 1                   12110004
121200             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             12120004
121300                     SQLCODE = ZERO                               12130004
121400                                                                  12140004
121500             EXEC SQL                                             12150004
121600                 CLOSE PO_STR_CHKPT_CSR                           12160004
121700             END-EXEC                                             12170004
121800                                                                  12180004
121900             EVALUATE TRUE                                        12190004
122000                 WHEN SQLCODE = ZERO                              12200004
122100                 WHEN SQLCODE = -904                              12210004
122200                 WHEN SQLCODE = -913                              12220004
122300                      CONTINUE                                    12230004
122400                                                                  12240004
122500                 WHEN SQLWARN0 NOT = SPACES                       12250004
122600                 WHEN SQLCODE  NOT = ZERO                         12260004
122700                     MOVE PV-CURRENT-PARAGRAPH                    12270004
122800                                         TO AA-PARAGRAPH-NAME     12280004
122900                     MOVE 'UNSUCCESSFUL CLOSE ON PO_STR_CHK'      12290004
123000                                         TO AA-DB2-OPERATION      12300004
123100                     MOVE 'TPOSTRR'      TO AA-DB2-TABLE          12310004
123200                     PERFORM Z999-DB2-ABEND                       12320004
123300             END-EVALUATE                                         12330004
123400     END-PERFORM.                                                 12340004
123500                                                                  12350004
123600     IF PC-RETRY-COUNT > PC-RETRY-MAX                             12360004
123700         MOVE PV-CURRENT-PARAGRAPH                                12370004
123800                             TO AA-PARAGRAPH-NAME                 12380004
123900         MOVE 'MAX RETRIES EXCEEDED ON CLOSE FOR PO_STR_CHK'      12390004
124000                             TO AA-DB2-OPERATION                  12400004
124100         MOVE 'TPOSTRR'      TO AA-DB2-TABLE                      12410004
124200         PERFORM Z999-DB2-ABEND                                   12420004
124300     END-IF.                                                      12430004
124400                                                                  12440004
124500     EVALUATE TRUE                                                12450004
124600         WHEN SQLCODE = ZEROS                                     12460004
124700              CONTINUE                                            12470004
124800         WHEN OTHER                                               12480004
124900             MOVE PV-CURRENT-PARAGRAPH                            12490004
125000                                 TO AA-PARAGRAPH-NAME             12500004
125100             MOVE 'UNSUCCESSFUL CLOSE ON PO_STR_CHK'              12510004
125200                                 TO AA-DB2-OPERATION              12520004
125300             MOVE 'TPOSTRR'      TO AA-DB2-TABLE                  12530004
125400             PERFORM Z999-DB2-ABEND                               12540004
125500     END-EVALUATE.                                                12550004
125600                                                                  12560004
125700*----------------------------------------------------------------*12570004
125800*    CLOSES THE PO STORE CURSOR.                                  12580004
125900*----------------------------------------------------------------*12590004
126000 Y400-CLOSE-PO-STR-CSR.                                           12600004
126100                                                                  12610004
126200     MOVE 'Y400-CLOSE-PO-STR-CSR' TO PV-CURRENT-PARAGRAPH.        12620004
126300                                                                  12630004
126400     PERFORM WITH TEST AFTER                                      12640004
126500             VARYING PC-RETRY-COUNT FROM 1 BY 1                   12650004
126600             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             12660004
126700                     SQLCODE = ZERO                               12670004
126800                                                                  12680004
126900             EXEC SQL                                             12690004
127000                 CLOSE PO_STR_CSR                                 12700004
127100             END-EXEC                                             12710004
127200                                                                  12720004
127300             EVALUATE TRUE                                        12730004
127400                 WHEN SQLCODE = ZERO                              12740004
127500                 WHEN SQLCODE = -904                              12750004
127600                 WHEN SQLCODE = -913                              12760004
127700                      CONTINUE                                    12770004
127800                                                                  12780004
127900                 WHEN SQLWARN0 NOT = SPACES                       12790004
128000                 WHEN SQLCODE  NOT = ZERO                         12800004
128100                     MOVE PV-CURRENT-PARAGRAPH                    12810004
128200                                         TO AA-PARAGRAPH-NAME     12820004
128300                     MOVE 'UNSUCCESSFUL CLOSE ON PO_STR_CSR'      12830004
128400                                         TO AA-DB2-OPERATION      12840004
128500                     MOVE 'TPOSTRR'      TO AA-DB2-TABLE          12850004
128600                     PERFORM Z999-DB2-ABEND                       12860004
128700             END-EVALUATE                                         12870004
128800     END-PERFORM.                                                 12880004
128900                                                                  12890004
129000     IF PC-RETRY-COUNT > PC-RETRY-MAX                             12900004
129100         MOVE PV-CURRENT-PARAGRAPH                                12910004
129200                             TO AA-PARAGRAPH-NAME                 12920004
129300         MOVE 'MAX RETRIES EXCEEDED ON CLOSE FOR PO_STR_CSR'      12930004
129400                             TO AA-DB2-OPERATION                  12940004
129500         MOVE 'TPOSTRR'      TO AA-DB2-TABLE                      12950004
129600         PERFORM Z999-DB2-ABEND                                   12960004
129700     END-IF.                                                      12970004
129800                                                                  12980004
129900     EVALUATE TRUE                                                12990004
130000         WHEN SQLCODE = ZEROS                                     13000004
130100              CONTINUE                                            13010004
130200         WHEN OTHER                                               13020004
130300             MOVE PV-CURRENT-PARAGRAPH                            13030004
130400                                 TO AA-PARAGRAPH-NAME             13040004
130500             MOVE 'UNSUCCESSFUL CLOSE ON PO_STR_CSR'              13050004
130600                                 TO AA-DB2-OPERATION              13060004
130700             MOVE 'TPOSTRR'      TO AA-DB2-TABLE                  13070004
130800             PERFORM Z999-DB2-ABEND                               13080004
130900     END-EVALUATE.                                                13090004
131000 Z100-EOJ-PROCESSING.                                             13100004
131100                                                                  13110004
131200     DISPLAY '** APKUP025 SUMMARY **'.                            13120004
131300     DISPLAY '** PO STORE INPUT COUNT= '                          13130004
131400                                         PV-PO-STR-INPUT-COUNT.   13140004
131500     DISPLAY '** RECV KEY INPUT COUNT= '                          13150004
131600                                         PV-RECV-KEY-INPUT-COUNT. 13160004
131700     DISPLAY '** TRECDIS INPUT COUNT = ' PV-TRECDIS-INPUT-COUNT.  13170004
131800     DISPLAY '** TRECDIS UPDATE COUNT= ' PV-TRECDIS-UPDATE-COUNT. 13180004
131900     DISPLAY '** TRECEIV INPUT COUNT = ' PV-TRECEIV-INPUT-COUNT.  13190004
132000     DISPLAY '** TRECEIV UPDATE COUNT= ' PV-TRECEIV-UPDATE-COUNT. 13200004
132100     DISPLAY '** TNINREC INPUT COUNT = ' PV-TNINREC-INPUT-COUNT.  13210004
132200     DISPLAY '** TNINREC UPDATE COUNT= ' PV-TNINREC-UPDATE-COUNT. 13220004
132300                                                                  13230004
132400     MOVE PC-RUN-COMPLETE-CODE TO PV-CKPT-STAT-CODE.              13240004
132500     PERFORM U500-UPDATE-TCKRSTCNTL.                              13250004
132600     PERFORM U900-COMMIT.                                         13260004
132700                                                                  13270004
132800     CLOSE  RECV-KEYS-FILE.                                       13280004
132900     IF RESTART-RUN                                               13290004
133000        PERFORM Y300-CLOSE-PO-STR-CHKPT-CSR                       13300004
133100     ELSE                                                         13310004
133200        PERFORM Y400-CLOSE-PO-STR-CSR.                            13320004
133300                                                                  13330004
133400 Z999-DB2-ABEND.                                                  13340004
133500                                                                  13350004
133600     DISPLAY AA-ABEND-LIT.                                        13360004
133700     DISPLAY AA-DB2-ERROR-LIT.                                    13370004
133800     DISPLAY AA-PROGRAM-LIT.                                      13380004
133900     DISPLAY AA-PARAGRAPH-LIT.                                    13390004
134000     DISPLAY AA-DB2-OPERATION-LIT.                                13400004
134100     DISPLAY AA-DB2-TABLE.                                        13410004
134200     SET AC-DB2-ERROR TO TRUE.                                    13420004
134300                                                                  13430004
134400     COPY DPPD004.                                                13440004
134500                                                                  13450004
134600     CALL 'ILBOABN0' USING ABEND-CODE.                            13460004
