000100 IDENTIFICATION DIVISION.                                         00010014
000200 PROGRAM-ID.         AHKUP039.                                    00020014
000300 AUTHOR.             NANCY EILBES.                                00030014
000400 DATE-WRITTEN.       APRIL 2000.                                  00040014
000500 DATE-COMPILED.                                                   00050014
000600*************************************************************     00060014
000700*    COBOL 2 WITH SQL                                       *     00070014
000800*                                                           *     00080014
000900*   AHKUP039 - ARCHIVE HISTORY DATA DELETION - TALLPLN      *     00090014
001000*                                                           *     00100014
001100*   PROGRAM OVERVIEW:                                       *     00110014
001200*                                                           *     00120014
001300*  THIS PROGRAM DELETES "OLD" ROWS FROM DB2 TABLE TALLPLN.  *     00130014
001400*  ROWS DELETED ARE THOSE PREVIOUSLY - IDENTIFIED/EXTRACTED *     00140014
001500*  WITHIN THE ARCHIVE/HISTORY SYSTEM.                       *     00150014
001600*                                                           *     00160014
001700*  THE EXTRACT FILE USED AS INPUT WILL BE SORTED BY THE     *     00170014
001800*  UNIQUE INDEX COLUMNS TO SPEED THE DELETION PROCESS.      *     00180014
001900*  THESE COLUMNS ARE PO_NBR, PO_LNE_NBR, PLAN_NBR.          *     00190014
002000*                                                           *     00200014
002100*   INPUT:                                                  *     00210014
002200*                                                           *     00220014
002300*     1. TALLPLN DELETION FILE  COPYBOOK DCLTALLPLN         *     00230014
002400*                                                           *     00240014
002500*   DB2 TABLES:                                             *     00250014
002600*                                                           *     00260014
002700*        TALLPLN - PO ALLOCATION PLAN TABLE                 *     00270014
002800*        TCKRSTIN - CHECKPOINT/RESTART INFO TABLE           *     00280014
002900*        TCKRSTCN - CHECKPOINT/RESTART CONTROL TABLE        *     00290014
003000*                                                           *     00300014
003100* ***********************************************************     00310014
003200* DATE: 01/12/2005 CHANGE MADE BY: SUE BARTELT.             *     00320014
003300* CHANGE MADE: MODIFIED SIZE IF INPUT FILE TO 106 FROM 102  *     00330014
003400* TO INCLUDE DC-SPLT-CNCLD-QTY                              *     00340014
003500*************************************************************     00350014
P5207 * DATE: 11/18/2013 CHANGE MADE BY: COGNIZANT(SHEBENA)       *     00350122
P5207 * CHANGE MADE: MODIFIED THE PROGRAM TO REMOVE THE           *     00350222
P5207 *              PO_IN_RMS_IND CHECK BEFORE DELETE.           *     00350322
P5207 * CHANGE TAG - P5207, CR NO - CHG0081355                    *     00350423
003500*************************************************************     00351017
003600 EJECT                                                            00360014
003700 ENVIRONMENT DIVISION.                                            00370014
003800 CONFIGURATION SECTION.                                           00380014
003900 SOURCE-COMPUTER.        IBM-370.                                 00390014
004000 OBJECT-COMPUTER.        IBM-370.                                 00400014
004100                                                                  00410014
004200 INPUT-OUTPUT SECTION.                                            00420014
004300 FILE-CONTROL.                                                    00430014
004400     SELECT TALLPLN-EXTRACT-FILE ASSIGN TO INP01.                 00440014
004500                                                                  00450014
004600 DATA DIVISION.                                                   00460014
004700 FILE SECTION.                                                    00470014
004800 FD  TALLPLN-EXTRACT-FILE                                         00480014
004900     RECORDING MODE IS F                                          00490014
005000     LABEL RECORDS ARE STANDARD                                   00500014
005100     BLOCK CONTAINS 0 RECORDS                                     00510014
005200     RECORD CONTAINS 106 CHARACTERS                               00520014
005300     DATA RECORD IS TALLPLN-EXTRACT-DATA.                         00530014
005400 01  TALLPLN-EXTRACT-DATA       PIC X(106).                       00540014
005500                                                                  00550014
005600                                                                  00560014
005700 EJECT                                                            00570014
005800 WORKING-STORAGE SECTION.                                         00580014
005900                                                                  00590014
006000 01  FILLER                       PIC X(58)     VALUE             00600014
006100     '************WORKING STORAGE STARTS HERE*******************'.00610014
006200                                                                  00620014
006300 01  PV-PROGRAM-VARIABLES.                                        00630014
006400     05  PV-PROGRAM-NAME          PIC  X(08)    VALUE 'AHKUP039'. 00640014
006500     05  PV-CKPT-STAT-CODE        PIC X(01)     VALUE SPACE.      00650014
006600     05  PV-CURRENT-PARAGRAPH     PIC X(50)     VALUE SPACES.     00660014
006700     05  PV-CURRENT-TMST          PIC X(26)     VALUE SPACES.     00670014
006800                                                                  00680014
006900     05  PV-TALLPLN-INPUT-COUNT   PIC 9(09)     VALUE ZERO        00690014
007000                                                COMP-3.           00700014
007100     05  PV-TALLPLN-DELETE-COUNT  PIC 9(09)     VALUE ZERO        00710014
007200                                                COMP-3.           00720014
007300     05  PV-SQL-DELETE-COUNT      PIC 9(09)     VALUE ZERO        00730014
007400                                                COMP-3.           00740014
007500     05  PV-SQLERRD3              PIC S9(09)    VALUE ZERO        00750014
007600                                                COMP-3.           00760014
007700     05  PV-DISP-PO-NBR           PIC X(09)    VALUE SPACES.      00770014
007800     05  PV-DISP-LNE-NBR          PIC X(09)    VALUE SPACES.      00780014
007900     05  PV-DISP-PLAN-NBR         PIC X(09)    VALUE SPACES.      00790014
008100     05  PV-SAVE-PO-NBR           PIC S9(09) COMP                 00810014
008200                                               VALUE ZEROES.      00820014
008300 01  PC-PROGRAM-CONSTANTS.                                        00830014
008400     05  PC-RETRY-MAX             PIC S9(04)    VALUE +3          00840014
008500                                                COMP SYNC.        00850014
008600     05  PC-RETRY-COUNT           PIC S9(04)    VALUE ZEROS.      00860014
008700     05  PC-IN-PROCESS-CODE       PIC X(01)     VALUE '9'.        00870014
008800     05  PC-RUN-COMPLETE-CODE     PIC X(01)     VALUE '0'.        00880014
008900                                                                  00890014
009000 01  PS-PROGRAM-SWITCHES.                                         00900014
009100     05  PS-COMMITS-TAKEN-SW      PIC  X(01)    VALUE 'N'.        00910014
009200         88  COMMITS-TAKEN                      VALUE 'T'.        00920014
009300         88  NO-COMMITS-TAKEN                   VALUE 'N'.        00930014
009400     05  PS-END-EXTRACT-SW        PIC  X(01)    VALUE 'M'.        00940014
009500         88  MORE-EXTRACT                       VALUE 'M'.        00950014
009600         88  END-OF-EXTRACT                     VALUE 'E'.        00960014
009700     05  PS-RUN-TYPE-SW           PIC  X(01)    VALUE ' '.        00970014
009800         88  NORMAL-RUN                         VALUE '0'.        00980014
009900         88  RESTART-RUN                        VALUE '9'.        00990014
010300                                                                  01030014
010400 01  WS-COUNTER.                                                  01040014
010500     05  WS-HOLD-TMST             PIC X(26)     VALUE SPACES.     01050014
010600     05  WS-TMST                  PIC X(26)     VALUE SPACES.     01060014
010700                                                                  01070014
010800 01  CKPT-RESTART-INFO.                                           01080014
010900     05  CR-EXTRACT-RECS-WORKED   PIC  9(9)     VALUE ZERO.       01090014
011000                                                                  01100014
011100*----------------------------------------------------------------*01110014
011200*  ABEND DATA AREAS                                              *01120014
011300*----------------------------------------------------------------*01130014
011400 01  ABEND-CODE                  PIC S9(04)  VALUE ZEROS          01140014
011500                                             COMP SYNC.           01150014
011600     88  AC-BAD-RECEIVE-DATA                 VALUE +4001.         01160014
011700     88  AC-BAD-DATA                         VALUE +4008.         01170014
011800     88  AC-DB2-ERROR                        VALUE +4013.         01180014
011900     88  AC-DATE-ERROR                       VALUE +4019.         01190014
012000                                                                  01200014
012100                                                                  01210014
012200 01  ABEND-AREAS.                                                 01220014
012300     05  AA-ABEND-LIT            PIC  X(40)  VALUE                01230014
012400             '*****       ABEND'.                                 01240014
012500     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                01250014
012600             '*****   PROGRAM: AHKUP039'.                         01260014
012700     05  AA-PARAGRAPH-LIT.                                        01270014
012800         10  FILLER              PIC  X(17)  VALUE                01280014
012900             '***** PARAGRAPH: '.                                 01290014
013000         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        01300014
013100     05  AA-MESSAGE-LINE-1.                                       01310014
013200         10  FILLER              PIC  X(06)  VALUE '*****'.       01320014
013300         10  AA-MESSAGE-1        PIC  X(127) VALUE SPACES.        01330014
013400     05  AA-MESSAGE-LINE-2.                                       01340014
013500         10  FILLER              PIC  X(06)  VALUE '*****'.       01350014
013600         10  AA-MESSAGE-2        PIC  X(127) VALUE SPACES.        01360014
013700     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                01370014
013800             '*****    DB2 ERROR'.                                01380014
013900     05  AA-DB2-OPERATION-LIT.                                    01390014
014000         10  FILLER              PIC  X(17)  VALUE                01400014
014100             '***** OPERATION: '.                                 01410014
014200         10  AA-DB2-OPERATION    PIC  X(50)  VALUE SPACES.        01420014
014300     05  AA-DB2-TABLE            PIC  X(08)  VALUE SPACES.        01430014
014400     EJECT                                                        01440014
014500                                                                  01450014
014600     COPY DPWS004.                                                01460014
014700     EJECT                                                        01470014
014800*----------------------------------------------------------------*01480014
014900*      TALLPLN TABLE LAYOUT                                       01490014
015000*----------------------------------------------------------------*01500014
015100         EXEC SQL                                                 01510014
015200             INCLUDE TALLPLN                                      01520014
015300         END-EXEC.                                                01530014
015400                                                                  01540014
015500*----------------------------------------------------------------*01550014
015600*      TPURCHS TABLE LAYOUT                                       01560014
015700*----------------------------------------------------------------*01570014
015800         EXEC SQL                                                 01580014
015900             INCLUDE TPURCHS                                      01590014
016000         END-EXEC.                                                01600014
016100                                                                  01610014
016200*----------------------------------------------------------------*01620014
016300*      TCKRSTCNTL TABLE LAYOUT                                    01630014
016400*----------------------------------------------------------------*01640014
016500         EXEC SQL                                                 01650014
016600             INCLUDE TCKRSTCN                                     01660014
016700         END-EXEC.                                                01670014
016800                                                                  01680014
016900*----------------------------------------------------------------*01690014
017000*      TCKRSTINF TABLE LAYOUT                                     01700014
017100*----------------------------------------------------------------*01710014
017200         EXEC SQL                                                 01720014
017300             INCLUDE TCKRSTIN                                     01730014
017400         END-EXEC.                                                01740014
017500 EJECT                                                            01750014
017600*----------------------------------------------------------------*01760014
017700*  DB2 COMMUNICATION AREA                                         01770014
017800*----------------------------------------------------------------*01780014
017900*                                                                 01790014
018000     EXEC SQL                                                     01800014
018100         INCLUDE SQLCA                                            01810014
018200     END-EXEC.                                                    01820014
018300                                                                  01830014
018400*----------------------------------------------------------------*01840014
018500*  DB2 COMMUNICATION AREA2                                        01850014
018600*----------------------------------------------------------------*01860014
018700*                                                                 01870014
018800     COPY SQLCA2.                                                 01880014
018900     EJECT                                                        01890014
019000 PROCEDURE DIVISION.                                              01900014
019100 A100-MAINLINE-ROUTINE.                                           01910014
019200                                                                  01920014
019300     PERFORM B100-INITIALIZATION.                                 01930014
019400                                                                  01940014
019500     PERFORM B200-TALLPLN-EXTRACT-PROCESS                         01950014
019600       UNTIL END-OF-EXTRACT.                                      01960014
019700                                                                  01970014
019800     PERFORM B300-EOJ-PROCESSING.                                 01980014
019900                                                                  01990014
020000     GOBACK.                                                      02000014
020100 EJECT                                                            02010014
020200 B100-INITIALIZATION.                                             02020014
020300                                                                  02030014
020400     EXEC SQL                                                     02040014
020500         SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                 02050014
020600     END-EXEC.                                                    02060014
020700                                                                  02070014
020800     PERFORM X300-GET-CHECKPOINT-CNTL.                            02080014
020900     MOVE PV-CKPT-STAT-CODE TO PS-RUN-TYPE-SW.                    02090014
021000                                                                  02100014
021100     OPEN INPUT TALLPLN-EXTRACT-FILE.                             02110014
021200                                                                  02120014
021300     IF RESTART-RUN                                               02130014
021400         PERFORM X200-CHECKPOINT-RESTART                          02140014
021500     ELSE                                                         02150014
021600         PERFORM R100-READ-EXTRACT-FILE                           02160014
021700     END-IF.                                                      02170014
021800                                                                  02180014
021900     PERFORM X500-SET-CHECKPOINT-TIME.                            02190014
022000                                                                  02200014
022100                                                                  02210014
022200     EJECT                                                        02220014
022300 B200-TALLPLN-EXTRACT-PROCESS.                                    02230014
022400                                                                  02240014
022500     MOVE ALLPLN-PO-NBR             TO PV-DISP-PO-NBR.            02250014
022600     MOVE ALLPLN-PO-LNE-NBR         TO PV-DISP-LNE-NBR.           02260014
022700     MOVE ALLPLN-PLAN-NBR           TO PV-DISP-PLAN-NBR.          02270014
022800     IF ALLPLN-PO-NBR NOT = PV-SAVE-PO-NBR                        02280014
022900         MOVE ALLPLN-PO-NBR TO PV-SAVE-PO-NBR                     02290014
023100     END-IF.                                                      02310014
023200                                                                  02320014
023400     PERFORM D100-DELETE-TALLPLN                                  02340021
023600                                                                  02360014
023700     PERFORM X100-CHECKPOINT-CHECK.                               02370014
023800                                                                  02380014
023900     PERFORM R100-READ-EXTRACT-FILE.                              02390014
024000     EJECT                                                        02400014
024100                                                                  02410014
024200                                                                  02420014
024300 B300-EOJ-PROCESSING.                                             02430014
024400                                                                  02440014
024500     DISPLAY '** AHKUP039 SUMMARY **'.                            02450014
024600     DISPLAY '** TALLPLN INPUT COUNT = ' PV-TALLPLN-INPUT-COUNT.  02460014
024700     DISPLAY '** TALLPLN DELETE COUNT = ' PV-TALLPLN-DELETE-COUNT.02470014
024800     DISPLAY '** SQL DELETE COUNT = ' PV-SQL-DELETE-COUNT.        02480014
024900                                                                  02490014
025000     CLOSE  TALLPLN-EXTRACT-FILE.                                 02500014
025100                                                                  02510014
025200     MOVE PC-RUN-COMPLETE-CODE TO PV-CKPT-STAT-CODE.              02520014
025300     PERFORM X600-UPDATE-TCKRSTCNTL.                              02530014
025400                                                                  02540014
025500     EJECT                                                        02550014
032700                                                                  03270014
032800*----------------------------------------------------------------*03280014
032900*    DELETES FROM THE TALLPLN TABLE.  CASCADE DELETE WILL ALSO   *03290014
033000*    CAUSE ROWS TO BE DELETED FROM TMIITEM, TVNDINV AND TEXINVC  *03300014
033100*    TABLES.                                                     *03310014
033200*----------------------------------------------------------------*03320014
033300 D100-DELETE-TALLPLN.                                             03330014
033400                                                                  03340014
033500     MOVE 'D100-DELETE-TALLPLN' TO PV-CURRENT-PARAGRAPH.          03350014
033600                                                                  03360014
033700     PERFORM WITH TEST AFTER                                      03370014
033800        VARYING PC-RETRY-COUNT FROM 1 BY 1                        03380014
033900          UNTIL PC-RETRY-COUNT > PC-RETRY-MAX                     03390014
034000             OR SQLCODE = ZERO                                    03400014
034100                                                                  03410014
034200         EXEC SQL                                                 03420014
034300              DELETE                                              03430014
034400                FROM TALLPLN                                      03440014
034500               WHERE PO_NBR     = :ALLPLN-PO-NBR                  03450014
034600                 AND PO_LNE_NBR = :ALLPLN-PO-LNE-NBR              03460014
034700                 AND PLAN_NBR   = :ALLPLN-PLAN-NBR                03470014
034800         END-EXEC                                                 03480014
034900                                                                  03490014
035000         EVALUATE TRUE                                            03500014
035100             WHEN SQLCODE = ZERO                                  03510014
035200                 ADD 1 TO PV-TALLPLN-DELETE-COUNT                 03520014
035300                 MOVE SQLERRD(3) TO PV-SQLERRD3                   03530014
035400                 ADD PV-SQLERRD3 TO PV-SQL-DELETE-COUNT           03540014
035500                                                                  03550014
035600             WHEN SQLCODE = -904                                  03560014
035700             WHEN SQLCODE = -913                                  03570014
035800             WHEN SQLCODE = +100                                  03580014
035900                  CONTINUE                                        03590014
036000                                                                  03600014
036100             WHEN SQLWARN0 NOT = SPACES                           03610014
036200             WHEN SQLCODE  NOT = ZERO                             03620014
036300                 MOVE PV-CURRENT-PARAGRAPH                        03630014
036400                                     TO AA-PARAGRAPH-NAME         03640014
036500                 DISPLAY '******** PO NUMBER:'                    03650014
036600                          PV-DISP-PO-NBR                          03660014
036700                 DISPLAY '******** PO LNE NBR:'                   03670014
036800                          PV-DISP-LNE-NBR                         03680014
036900                 DISPLAY '******** PLAN NBR:'                     03690014
037000                          PV-DISP-PLAN-NBR                        03700014
037100                 MOVE SPACES TO AA-MESSAGE-1                      03710014
037200                                AA-MESSAGE-2                      03720014
037300                 MOVE 'UNSUCCESSFUL DELETE'                       03730014
037400                                     TO AA-DB2-OPERATION          03740014
037500                 MOVE 'TALLPLN'      TO AA-DB2-TABLE              03750014
037600                 PERFORM Z999-DB2-ABEND                           03760014
037700         END-EVALUATE                                             03770014
037800     END-PERFORM.                                                 03780014
037900                                                                  03790014
038000     IF PC-RETRY-COUNT > PC-RETRY-MAX                             03800014
038100         MOVE PV-CURRENT-PARAGRAPH                                03810014
038200                             TO AA-PARAGRAPH-NAME                 03820014
038300         DISPLAY '******** PO NUMBER:'                            03830014
038400                          PV-DISP-PO-NBR                          03840014
038500         DISPLAY '******** PO LNE NBR :'                          03850014
038600                          PV-DISP-LNE-NBR                         03860014
038700         DISPLAY '******** PLAN NBR :'                            03870014
038800                          PV-DISP-PLAN-NBR                        03880014
038900         MOVE SPACES TO AA-MESSAGE-1                              03890014
039000                        AA-MESSAGE-2                              03900014
039100         MOVE 'MAX RETRIES EXCEEDED ON DELETE'                    03910014
039200                             TO AA-DB2-OPERATION                  03920014
039300         MOVE 'TALLPLN'      TO AA-DB2-TABLE                      03930014
039400         PERFORM Z999-DB2-ABEND                                   03940014
039500     END-IF.                                                      03950014
039600                                                                  03960014
039700     EJECT                                                        03970014
039800 R100-READ-EXTRACT-FILE.                                          03980014
039900                                                                  03990014
040000     READ TALLPLN-EXTRACT-FILE                                    04000014
040100          INTO DCLTALLPLN                                         04010014
040200          AT END SET END-OF-EXTRACT TO TRUE.                      04020014
040300                                                                  04030014
040400     IF MORE-EXTRACT                                              04040014
040500         ADD 1 TO PV-TALLPLN-INPUT-COUNT                          04050014
040600     END-IF.                                                      04060014
040700                                                                  04070014
040800                                                                  04080014
040900     EJECT                                                        04090014
041000*----------------------------------------------------------------*04100014
041100*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *04110014
041200*----------------------------------------------------------------*04120014
041300 X100-CHECKPOINT-CHECK.                                           04130014
041400                                                                  04140014
041500     MOVE 'X100-CHECKPOINT-CHECK' TO PV-CURRENT-PARAGRAPH.        04150014
041600                                                                  04160014
041700     EXEC SQL                                                     04170014
041800       SET :WS-TMST = CURRENT TIMESTAMP                           04180014
041900     END-EXEC.                                                    04190014
042000                                                                  04200014
042100     IF SQLCODE = +0                                              04210014
042200         CONTINUE                                                 04220014
042300     ELSE                                                         04230014
042400         MOVE PV-CURRENT-PARAGRAPH                                04240014
042500                             TO AA-PARAGRAPH-NAME                 04250014
042600         MOVE SPACES TO AA-MESSAGE-1                              04260014
042700                        AA-MESSAGE-2                              04270014
042800         MOVE 'BAD SET COMMAND'                                   04280014
042900                             TO AA-DB2-OPERATION                  04290014
043000         MOVE SPACES             TO AA-DB2-TABLE                  04300014
043100         PERFORM Z999-DB2-ABEND                                   04310014
043200     END-IF.                                                      04320014
043300                                                                  04330014
043400     IF WS-TMST > WS-HOLD-TMST                                    04340014
043500         IF NO-COMMITS-TAKEN                                      04350014
043600             MOVE PC-IN-PROCESS-CODE TO PV-CKPT-STAT-CODE         04360014
043700             PERFORM X600-UPDATE-TCKRSTCNTL                       04370014
043800             SET COMMITS-TAKEN TO TRUE                            04380014
043900         END-IF                                                   04390014
044000         PERFORM X700-UPDATE-TCKRSTINF                            04400014
044100         PERFORM Y100-COMMIT                                      04410014
044200         PERFORM X500-SET-CHECKPOINT-TIME                         04420014
044300     END-IF.                                                      04430014
044400                                                                  04440014
044500 EJECT                                                            04450014
044600*----------------------------------------------------------------*04460014
044700*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *04470014
044800*----------------------------------------------------------------*04480014
044900 X200-CHECKPOINT-RESTART.                                         04490014
045000                                                                  04500014
045100     MOVE 'X200-CHECKPOINT-RESTART' TO PV-CURRENT-PARAGRAPH.      04510014
045200                                                                  04520014
045300     PERFORM X400-GET-CHECKPOINT-INFO.                            04530014
045400     MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO CKPT-RESTART-INFO.     04540014
045500                                                                  04550014
045600     DISPLAY '** AHKUP039 CHECKPOINT RESTART **'                  04560014
045700     DISPLAY '** EXTRACT RECS BYPASSED ON RESTART = '             04570014
045800              CR-EXTRACT-RECS-WORKED.                             04580014
045900     DISPLAY '***********************************************'    04590014
046000                                                                  04600014
046100     PERFORM R100-READ-EXTRACT-FILE                               04610014
046200         CR-EXTRACT-RECS-WORKED TIMES.                            04620014
046300     PERFORM R100-READ-EXTRACT-FILE.                              04630014
046400 EJECT                                                            04640014
046500*----------------------------------------------------------------*04650014
046600*    SELECT CHECKPOINT RESTART CONTROL INFO.                     *04660014
046700*----------------------------------------------------------------*04670014
046800 X300-GET-CHECKPOINT-CNTL.                                        04680014
046900                                                                  04690014
047000     MOVE 'X300-GET-CHECKPOINT-CNTL' TO PV-CURRENT-PARAGRAPH.     04700014
047100                                                                  04710014
047200     PERFORM WITH TEST AFTER                                      04720014
047300             VARYING PC-RETRY-COUNT FROM 1 BY 1                   04730014
047400             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             04740014
047500                     SQLCODE = ZERO                               04750014
047600                                                                  04760014
047700             EXEC SQL                                             04770014
047800              SELECT CKPT_STAT_CODE                               04780014
047900               INTO :PV-CKPT-STAT-CODE                            04790014
048000               FROM TCKRSTCNTL                                    04800014
048100               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 04810014
048200             END-EXEC                                             04820014
048300                                                                  04830014
048400             EVALUATE TRUE                                        04840014
048500                 WHEN SQLCODE = ZERO                              04850014
048600                 WHEN SQLCODE = -904                              04860014
048700                 WHEN SQLCODE = -913                              04870014
048800                      CONTINUE                                    04880014
048900                                                                  04890014
049000                 WHEN SQLWARN0 NOT = SPACES                       04900014
049100                 WHEN SQLCODE  NOT = ZERO                         04910014
049200                     MOVE PV-CURRENT-PARAGRAPH                    04920014
049300                                         TO AA-PARAGRAPH-NAME     04930014
049400                     DISPLAY '******** PLAN_NAME:'                04940014
049500                              PV-PROGRAM-NAME                     04950014
049600                     MOVE SPACES TO AA-MESSAGE-1                  04960014
049700                                    AA-MESSAGE-2                  04970014
049800                     MOVE 'UNSUCCESSFUL SELECT'                   04980014
049900                                         TO AA-DB2-OPERATION      04990014
050000                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          05000014
050100                     PERFORM Z999-DB2-ABEND                       05010014
050200             END-EVALUATE                                         05020014
050300     END-PERFORM.                                                 05030014
050400                                                                  05040014
050500     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05050014
050600         MOVE PV-CURRENT-PARAGRAPH                                05060014
050700                             TO AA-PARAGRAPH-NAME                 05070014
050800         DISPLAY '******** PLAN_NAME:'                            05080014
050900                  PV-PROGRAM-NAME                                 05090014
051000         MOVE SPACES TO AA-MESSAGE-1                              05100014
051100                        AA-MESSAGE-2                              05110014
051200         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    05120014
051300                             TO AA-DB2-OPERATION                  05130014
051400         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      05140014
051500         PERFORM Z999-DB2-ABEND                                   05150014
051600     END-IF.                                                      05160014
051700                                                                  05170014
051800 EJECT                                                            05180014
051900*----------------------------------------------------------------*05190014
052000*    SELECT CHECKPOINT RESTART WORKING STORAGE DESCRIPTION INFO  *05200014
052100*----------------------------------------------------------------*05210014
052200 X400-GET-CHECKPOINT-INFO.                                        05220014
052300                                                                  05230014
052400     MOVE 'X400-GET-CHECKPOINT-INFO' TO PV-CURRENT-PARAGRAPH.     05240014
052500                                                                  05250014
052600     PERFORM WITH TEST AFTER                                      05260014
052700             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05270014
052800             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05280014
052900                     SQLCODE = ZERO                               05290014
053000                                                                  05300014
053100             EXEC SQL                                             05310014
053200              SELECT WORK_STRG_DESC                               05320014
053300               INTO :TCKRSTINF-WORK-STRG-DESC                     05330014
053400               FROM TCKRSTINF                                     05340014
053500               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 05350014
053600             END-EXEC                                             05360014
053700                                                                  05370014
053800             EVALUATE TRUE                                        05380014
053900                 WHEN SQLCODE = ZERO                              05390014
054000                 WHEN SQLCODE = -904                              05400014
054100                 WHEN SQLCODE = -913                              05410014
054200                      CONTINUE                                    05420014
054300                                                                  05430014
054400                 WHEN SQLWARN0 NOT = SPACES                       05440014
054500                 WHEN SQLCODE  NOT = ZERO                         05450014
054600                     MOVE PV-CURRENT-PARAGRAPH                    05460014
054700                                         TO AA-PARAGRAPH-NAME     05470014
054800                     DISPLAY '******** PLAN_NAME:'                05480014
054900                              PV-PROGRAM-NAME                     05490014
055000                     MOVE SPACES TO AA-MESSAGE-1                  05500014
055100                                    AA-MESSAGE-2                  05510014
055200                     MOVE 'UNSUCCESSFUL SELECT'                   05520014
055300                                         TO AA-DB2-OPERATION      05530014
055400                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          05540014
055500                     PERFORM Z999-DB2-ABEND                       05550014
055600             END-EVALUATE                                         05560014
055700     END-PERFORM.                                                 05570014
055800                                                                  05580014
055900     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05590014
056000         MOVE PV-CURRENT-PARAGRAPH                                05600014
056100                             TO AA-PARAGRAPH-NAME                 05610014
056200         DISPLAY '******** PLAN_NAME:'                            05620014
056300                  PV-PROGRAM-NAME                                 05630014
056400         MOVE SPACES TO AA-MESSAGE-1                              05640014
056500                        AA-MESSAGE-2                              05650014
056600         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    05660014
056700                             TO AA-DB2-OPERATION                  05670014
056800         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      05680014
056900         PERFORM Z999-DB2-ABEND                                   05690014
057000     END-IF.                                                      05700014
057100                                                                  05710014
057200 EJECT                                                            05720014
057300*----------------------------------------------------------------*05730014
057400*    SET THE TIME FOR THE NEXT CHECKPOINT.                       *05740014
057500*----------------------------------------------------------------*05750014
057600 X500-SET-CHECKPOINT-TIME.                                        05760014
057700                                                                  05770014
057800     MOVE 'X500-SET-CHECKPOINT-TIME' TO PV-CURRENT-PARAGRAPH.     05780014
057900                                                                  05790014
058000     PERFORM WITH TEST AFTER                                      05800014
058100             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05810014
058200             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05820014
058300                     SQLCODE = ZERO                               05830014
058400                                                                  05840014
058500             EXEC SQL                                             05850014
058600              SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)05860014
058700               INTO :WS-HOLD-TMST                                 05870014
058800               FROM TCKRSTCNTL                                    05880014
058900               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 05890014
059000             END-EXEC                                             05900014
059100                                                                  05910014
059200             EVALUATE TRUE                                        05920014
059300                 WHEN SQLCODE = ZERO                              05930014
059400                 WHEN SQLCODE = -904                              05940014
059500                 WHEN SQLCODE = -913                              05950014
059600                      CONTINUE                                    05960014
059700                                                                  05970014
059800                 WHEN SQLWARN0 NOT = SPACES                       05980014
059900                 WHEN SQLCODE  NOT = ZERO                         05990014
060000                     MOVE PV-CURRENT-PARAGRAPH                    06000014
060100                                         TO AA-PARAGRAPH-NAME     06010014
060200                     DISPLAY '******** PLAN_NAME:'                06020014
060300                              PV-PROGRAM-NAME                     06030014
060400                     MOVE SPACES TO AA-MESSAGE-1                  06040014
060500                                    AA-MESSAGE-2                  06050014
060600                     MOVE 'UNSUCCESSFUL SELECT'                   06060014
060700                                         TO AA-DB2-OPERATION      06070014
060800                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          06080014
060900                     PERFORM Z999-DB2-ABEND                       06090014
061000             END-EVALUATE                                         06100014
061100     END-PERFORM.                                                 06110014
061200                                                                  06120014
061300     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06130014
061400         MOVE PV-CURRENT-PARAGRAPH                                06140014
061500                             TO AA-PARAGRAPH-NAME                 06150014
061600         DISPLAY '******** PLAN_NAME:'                            06160014
061700                  PV-PROGRAM-NAME                                 06170014
061800         MOVE SPACES TO AA-MESSAGE-1                              06180014
061900                        AA-MESSAGE-2                              06190014
062000         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    06200014
062100                             TO AA-DB2-OPERATION                  06210014
062200         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      06220014
062300         PERFORM Z999-DB2-ABEND                                   06230014
062400     END-IF.                                                      06240014
062500                                                                  06250014
062600 EJECT                                                            06260014
062700*----------------------------------------------------------------*06270014
062800*    UPDATES THE CHECKPOINT RESTART CONTROL TABLE.  THE STATUS   *06280014
062900*    CODE IS SET TO '9' (RUN IN PROGRESS) OR '0' (RUN COMPLETE). *06290014
063000*----------------------------------------------------------------*06300014
063100 X600-UPDATE-TCKRSTCNTL.                                          06310014
063200                                                                  06320014
063300     MOVE 'X600-UPDATE-TCKRSTCNTL' TO PV-CURRENT-PARAGRAPH.       06330014
063400                                                                  06340014
063500     PERFORM WITH TEST AFTER                                      06350014
063600             VARYING PC-RETRY-COUNT FROM 1 BY 1                   06360014
063700             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             06370014
063800                     SQLCODE = ZERO                               06380014
063900                                                                  06390014
064000             EXEC SQL                                             06400014
064100                 UPDATE TCKRSTCNTL                                06410014
064200                 SET CKPT_STAT_CODE = :PV-CKPT-STAT-CODE          06420014
064300                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          06430014
064400             END-EXEC                                             06440014
064500                                                                  06450014
064600             EVALUATE TRUE                                        06460014
064700                 WHEN SQLCODE = ZERO                              06470014
064800                 WHEN SQLCODE = -904                              06480014
064900                 WHEN SQLCODE = -913                              06490014
065000                      CONTINUE                                    06500014
065100                                                                  06510014
065200                 WHEN SQLWARN0 NOT = SPACES                       06520014
065300                 WHEN SQLCODE  NOT = ZERO                         06530014
065400                     MOVE PV-CURRENT-PARAGRAPH                    06540014
065500                                         TO AA-PARAGRAPH-NAME     06550014
065600                     DISPLAY '******** PLAN_NAME:'                06560014
065700                              PV-PROGRAM-NAME                     06570014
065800                     MOVE SPACES TO AA-MESSAGE-1                  06580014
065900                                    AA-MESSAGE-2                  06590014
066000                     MOVE 'UNSUCCESSFUL UPDATE'                   06600014
066100                                         TO AA-DB2-OPERATION      06610014
066200                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          06620014
066300                     PERFORM Z999-DB2-ABEND                       06630014
066400             END-EVALUATE                                         06640014
066500     END-PERFORM.                                                 06650014
066600                                                                  06660014
066700     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06670014
066800         MOVE PV-CURRENT-PARAGRAPH                                06680014
066900                             TO AA-PARAGRAPH-NAME                 06690014
067000         DISPLAY '******** PLAN_NAME:'                            06700014
067100                  PV-PROGRAM-NAME                                 06710014
067200         MOVE SPACES TO AA-MESSAGE-1                              06720014
067300                        AA-MESSAGE-2                              06730014
067400         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    06740014
067500                             TO AA-DB2-OPERATION                  06750014
067600         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      06760014
067700         PERFORM Z999-DB2-ABEND                                   06770014
067800     END-IF.                                                      06780014
067900                                                                  06790014
068000     EJECT                                                        06800014
068100*----------------------------------------------------------------*06810014
068200*    UPDATES THE CHECKPOINT RESTART INFO TABLE.  THE WORKING     *06820014
068300*    STORAGE DESCRIPTION FIELD IS UPDATED WITH THE CURRENT INPUT *06830014
068400*    FILE RECORD COUNTS AND THE FILE PROCESSOR INDICATOR.        *06840014
068500*----------------------------------------------------------------*06850014
068600 X700-UPDATE-TCKRSTINF.                                           06860014
068700                                                                  06870014
068800     MOVE 'X700-UPDATE-TCKRSTINF' TO PV-CURRENT-PARAGRAPH.        06880014
068900                                                                  06890014
069000     MOVE PV-TALLPLN-INPUT-COUNT TO CR-EXTRACT-RECS-WORKED.       06900014
069100     MOVE CKPT-RESTART-INFO   TO TCKRSTINF-WORK-STRG-DESC-TEXT.   06910014
069200     MOVE 4022                TO TCKRSTINF-WORK-STRG-DESC-LEN.    06920014
069300                                                                  06930014
069400     PERFORM WITH TEST AFTER                                      06940014
069500             VARYING PC-RETRY-COUNT FROM 1 BY 1                   06950014
069600             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             06960014
069700                     SQLCODE = ZERO                               06970014
069800                                                                  06980014
069900             EXEC SQL                                             06990014
070000                 UPDATE TCKRSTINF                                 07000014
070100                 SET WORK_STRG_DESC   = :TCKRSTINF-WORK-STRG-DESC 07010014
070200                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          07020014
070300             END-EXEC                                             07030014
070400                                                                  07040014
070500             EVALUATE TRUE                                        07050014
070600                 WHEN SQLCODE = ZERO                              07060014
070700                 WHEN SQLCODE = -904                              07070014
070800                 WHEN SQLCODE = -913                              07080014
070900                      CONTINUE                                    07090014
071000                                                                  07100014
071100                 WHEN SQLWARN0 NOT = SPACES                       07110014
071200                 WHEN SQLCODE  NOT = ZERO                         07120014
071300                     MOVE PV-CURRENT-PARAGRAPH                    07130014
071400                                         TO AA-PARAGRAPH-NAME     07140014
071500                     DISPLAY '******** PLAN_NAME:'                07150014
071600                              PV-PROGRAM-NAME                     07160014
071700                     MOVE SPACES TO AA-MESSAGE-1                  07170014
071800                                    AA-MESSAGE-2                  07180014
071900                     MOVE 'UNSUCCESSFUL UPDATE'                   07190014
072000                                         TO AA-DB2-OPERATION      07200014
072100                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          07210014
072200                     PERFORM Z999-DB2-ABEND                       07220014
072300             END-EVALUATE                                         07230014
072400     END-PERFORM.                                                 07240014
072500                                                                  07250014
072600     IF PC-RETRY-COUNT > PC-RETRY-MAX                             07260014
072700         MOVE PV-CURRENT-PARAGRAPH                                07270014
072800                             TO AA-PARAGRAPH-NAME                 07280014
072900         DISPLAY '******** PLAN_NAME:'                            07290014
073000                  PV-PROGRAM-NAME                                 07300014
073100         MOVE SPACES TO AA-MESSAGE-1                              07310014
073200                        AA-MESSAGE-2                              07320014
073300         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    07330014
073400                             TO AA-DB2-OPERATION                  07340014
073500         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      07350014
073600         PERFORM Z999-DB2-ABEND                                   07360014
073700     END-IF.                                                      07370014
073800                                                                  07380014
073900 EJECT                                                            07390014
074000                                                                  07400014
074100*----------------------------------------------------------------*07410014
074200*    ISSUES AN SQL COMMIT WORK AFTER A LUW HAS BEEN COMPLETED.   *07420014
074300*----------------------------------------------------------------*07430014
074400 Y100-COMMIT.                                                     07440014
074500                                                                  07450014
074600     MOVE 'Y100-COMMIT'    TO PV-CURRENT-PARAGRAPH.               07460014
074700                                                                  07470014
074800     EXEC SQL                                                     07480014
074900         COMMIT                                                   07490014
075000     END-EXEC.                                                    07500014
075100                                                                  07510014
075200     EVALUATE TRUE                                                07520014
075300         WHEN SQLCODE = ZEROS                                     07530014
075400             CONTINUE                                             07540014
075500         WHEN OTHER                                               07550014
075600             MOVE PV-CURRENT-PARAGRAPH                            07560014
075700                                 TO AA-PARAGRAPH-NAME             07570014
075800             MOVE SPACES TO AA-MESSAGE-1                          07580014
075900                            AA-MESSAGE-2                          07590014
076000             MOVE 'UNSUCCESSFUL COMMIT'                           07600014
076100                                 TO AA-DB2-OPERATION              07610014
076200             MOVE SPACES         TO AA-DB2-TABLE                  07620014
076300             PERFORM Z999-DB2-ABEND                               07630014
076400     END-EVALUATE.                                                07640014
076500 EJECT                                                            07650014
076600 Z999-DB2-ABEND.                                                  07660014
076700                                                                  07670014
076800     DISPLAY AA-ABEND-LIT.                                        07680014
076900     DISPLAY AA-DB2-ERROR-LIT.                                    07690014
077000     DISPLAY AA-PROGRAM-LIT.                                      07700014
077100     DISPLAY AA-PARAGRAPH-LIT.                                    07710014
077200     DISPLAY AA-DB2-OPERATION-LIT.                                07720014
077300     DISPLAY AA-DB2-TABLE.                                        07730014
077400     SET AC-DB2-ERROR TO TRUE.                                    07740014
077500                                                                  07750014
077600     COPY DPPD004.                                                07760014
077700                                                                  07770014
077800     CALL 'ILBOABN0' USING ABEND-CODE.                            07780014
