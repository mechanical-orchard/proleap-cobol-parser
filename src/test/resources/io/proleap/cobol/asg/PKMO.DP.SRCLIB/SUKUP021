000100 IDENTIFICATION DIVISION.                                         00010001
000200                                                                  00020001
000300 PROGRAM-ID.             SUKUP021.                                00030001
000400 AUTHOR.                 STEPHANIE HERON.                         00040001
000500 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00050001
000600 DATE-WRITTEN            APRIL 2006.                              00060001
000700 DATE-COMPILED.                                                   00070001
000800                                                                  00080001
000900 ENVIRONMENT DIVISION.                                            00090001
001000 CONFIGURATION SECTION.                                           00100001
001100                                                                  00110001
001200 SOURCE-COMPUTER.        IBM-3090.                                00120001
001300 OBJECT-COMPUTER.        IBM-3090.                                00130001
001400                                                                  00140001
001500 INPUT-OUTPUT SECTION.                                            00150001
001600                                                                  00160001
001700 FILE-CONTROL.                                                    00170001
001800                                                                  00180001
001900     SELECT IN-TRAILER-EXTRACT-FILE                               00190001
002000         ASSIGN TO INP01.                                         00200001
002100                                                                  00210001
002200                                                                  00220001
002300 DATA DIVISION.                                                   00230001
002400 FILE SECTION.                                                    00240001
002500                                                                  00250001
002600 FD  IN-TRAILER-EXTRACT-FILE                                      00260001
002700     RECORDING MODE IS F                                          00270001
002800     LABEL RECORDS ARE STANDARD                                   00280001
002900     BLOCK CONTAINS 0 RECORDS.                                    00290001
003000                                                                  00300001
003100 01  IN-TRAILER-RECORD    PIC  X(100).                            00310001
003200                                                                  00320001
003300 WORKING-STORAGE SECTION.                                         00330001
003400                                                                  00340001
003500                                                                  00350001
003600 01  FILLER.                                                      00360001
003700     05  FILLER                      PIC  X(36)    VALUE          00370001
003800         ' ***** WORKING STORAGE PGM=SUKUP021 '.                  00380001
003900     05  PGM-COMPILED                PIC  X(20)    VALUE SPACE.   00390001
004000     05  FILLER                      PIC  X(10)    VALUE          00400001
004100         ' LOCATION='.                                            00410001
004200     05  PGM-LOCATION                PIC  X(04)    VALUE SPACE.   00420001
004300     05  FILLER                      PIC  X(06)    VALUE          00430001
004400         ' *****'.                                                00440001
004500                                                                  00450001
004600 01  PV-DISP-KEY-MSG.                                             00460001
004700     05  FILLER                      PIC X(23) VALUE              00470007
004800         'TRIP ID LAST PROCESSED ' .                              00480006
004900     05  PV-TRIP-ID-DISPLAY          PIC 9(11) VALUE ZEROES.      00490006
005600                                                                  00560001
006100 01  PS-SWITCHES.                                                 00610001
006200     05  PS-EOF-SW                    PIC X(01) VALUE 'N'.        00620001
006300         88  PS-EOF-EXTRACT-YES                 VALUE 'Y'.        00630001
006400         88  PS-EOF-EXTRACT-NO                  VALUE 'N'.        00640001
006500     05  PS-HEADER-SW                 PIC X(01) VALUE 'A'.        00650001
006600         88  PS-UPDATE-OLD-HEADER               VALUE 'U'.        00660001
006700         88  PS-ADD-NEW-HEADER                  VALUE 'A'.        00670001
006800                                                                  00680001
006900 01  PC-CONSTANTS.                                                00690001
007000     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          00700001
007100                                                   'SUKUP021'.    00710001
007200     05  PC-OPEN-FUNC                PIC X(05)     VALUE 'OPEN '. 00720001
007300     05  PC-TRANS-FUNC               PIC X(05)     VALUE 'TRANS'. 00730001
007400     05  PC-CLOSE-FUNC               PIC X(05)     VALUE 'CLOSE'. 00740001
007500     05  PC-RSTRT-FUNC               PIC X(05)     VALUE 'RSTRT'. 00750001
007600     05  PV-CKPT-JOB-NAME            PIC X(08)   VALUE 'PCK075'.  00760001
007700     05  PC-CKPT-PLAN-NAME           PIC X(08)   VALUE 'SUKUP021'.00770001
007800     05  PC-ILBOABN0                 PIC  X(08)    VALUE          00780001
007900                                                   'ILBOABN0'.    00790001
008000     05  PC-MAX-RETRIES              PIC S9(04)    VALUE  +3      00800001
008100                                                   COMP.          00810001
008200     05  PC-DEFAULT-DATE             PIC  X(10)    VALUE          00820001
008300                                     '0001-01-01'.                00830001
008400     05  PC-DEFAULT-TIME             PIC  X(08)    VALUE          00840001
008500                                     '00.00.00'.                  00850001
008600                                                                  00860001
008700                                                                  00870001
008800 01  PV-MISC-STUFF.                                               00880001
008900     05  PV-ABEND-PARAGRAPH           PIC  X(30) VALUE SPACES.    00890001
009000     05  PV-DB2-OPERATION-ATTEMPTED   PIC  X(60) VALUE SPACE.     00900001
009100     05  PV-SQL-CODE                  PIC  9(04) VALUE ZERO.      00910001
009200     05  PV-ABEND-CODE                PIC S9(04) VALUE ZERO       00920001
009300                                                   COMP SYNC.     00930001
009400     05  PV-RETRY-COUNTER             PIC S9(04) VALUE ZERO       00940001
009500                                                 COMP SYNC.       00950001
009600     05  PV-READ-COUNTER              PIC S9(09) COMP-3           00960001
009700                                              VALUE ZERO.         00970001
009800     05  PV-DISP-CONTROL              PIC S9(09) COMP-3           00980001
009900                                              VALUE ZERO.         00990001
010000     05 PV-QTY-INSERT-COUNTER         PIC S9(09) COMP-3           01000001
010100                                              VALUE ZERO.         01010001
010200     05 PV-QTY-UPDATE-COUNTER         PIC S9(09) COMP-3           01020001
010300                                              VALUE ZERO.         01030001
010400     05 PV-TRAN-INSERT-COUNTER        PIC S9(09) COMP-3           01040001
010500                                              VALUE ZERO.         01050001
010600     05 PV-TRAN-DUP-IN-COUNTER        PIC S9(09) COMP-3           01060001
010700                                              VALUE ZERO.         01070001
010800     05 PV-ADD-QTY                    PIC 9(04).                  01080001
010900                                                                  01090001
011000     05  PV-DISP-NBR                  PIC ZZZ,ZZZ,ZZ9.            01100001
011100                                                                  01110001
011200     05  PV-PREP-TIMESTAMP.                                       01120001
011300         10  PV-PREP-DATE            PIC  X(10).                  01130001
011400         10  FILLER                  PIC  X(01).                  01140001
011500         10  PV-PREP-TIME            PIC  X(08).                  01150001
011600         10  FILLER                  PIC  X(07).                  01160001
011700                                                                  01170001
011800     05  PV-INTR-UPC-ID               PIC S9(9) COMP VALUE ZEROS. 01180001
011900     05  PV-STR-NBR                   PIC S9(4) COMP VALUE ZEROS. 01190001
012000     05  PV-TRN-CLSN-CDE              PIC X(02)      VALUE SPACES.01200001
012100     05  PV-HOLD-TIMESTAMP            PIC X(26)      VALUE SPACES.01210001
012200                                                                  01220001
012300     05 PV-EVNT-TMST.                                             01230001
012400        10 PV-EVNT-TMST-YY           PIC  X(04).                  01240001
012500        10 FILLER                    PIC  X(01).                  01250001
012600        10 PV-EVNT-TMST-MM           PIC  X(02).                  01260001
012700        10 FILLER                    PIC  X(01).                  01270001
012800        10 PV-EVNT-TMST-DD           PIC  X(02).                  01280001
012900        10 FILLER                    PIC  X(01).                  01290001
013000        10 PV-EVNT-TMST-HRS          PIC  X(02).                  01300001
013100        10 FILLER                    PIC  X(01).                  01310001
013200        10 PV-EVNT-TMST-MIN          PIC  X(02).                  01320001
013300        10 FILLER                    PIC  X(01).                  01330001
013400        10 PV-EVNT-TMST-SEC          PIC  X(02).                  01340001
013500        10 PV-DOT                    PIC  X(01).                  01350001
013600        10 PV-EVNT-TMST-NSEC         PIC  9(06).                  01360001
013700     05  PV-TIME                      PIC X(08) VALUE SPACES.     01370001
013800                                                                  01380001
013900                                                                  01390001
014000 01  ABEND-CODE                       PIC S9(04)     VALUE +0     01400001
014100                                                     COMP SYNC.   01410001
014200     88  ABEND-4001-WRITE-ERROR                      VALUE +4001. 01420001
014300     88  ABEND-4002-READ-ERROR                       VALUE +4002. 01430001
014400     88  ABEND-4003-CTRL-CARD-ERROR                  VALUE +4003. 01440001
014500     88  ABEND-4004-TABLE-ERROR                      VALUE +4004. 01450001
014600     88  ABEND-4005-OPEN-ERROR                       VALUE +4005. 01460001
014700     88  ABEND-4006-CLOSE-ERROR                      VALUE +4006. 01470001
014800     88  ABEND-4007-SEQUENCE-ERROR                   VALUE +4007. 01480001
014900     88  ABEND-4008-DATS-ERROR                       VALUE +4008. 01490001
015000     88  ABEND-4009-KEY-DATS-ERROR                   VALUE +4009. 01500001
015100     88  ABEND-4013-DB2-ERROR                        VALUE +4013. 01510001
015200                                                                  01520001
015300* TRANSACTION PRESENTATION MODULE PARAMETERS                      01530001
015700                                                                  01570001
015800*    IN-TRAILER EXTRACT RECORD LAYOUT                             01580001
015900     COPY SURD069.                                                01590001
016000                                                                  01600001
016100/                                                                 01610001
016900*                                                                 01690001
017000*  TSUOBTS - OUTBOUND TRAILER STATUS                              01700001
017100*                                                                 01710001
017200     EXEC SQL                                                     01720001
017300         INCLUDE TSUOBTS                                          01730001
017400     END-EXEC.                                                    01740001
017500                                                                  01750001
017600*                                                                 01760001
018300*  COMMUNICATIONS AREA FOR DB2                                    01830001
018400*                                                                 01840001
018500     EXEC SQL                                                     01850001
018600         INCLUDE SQLCA                                            01860001
018700     END-EXEC.                                                    01870001
018800                                                                  01880001
018900*                                                                 01890001
019000* DB2 COMMUNICATION AREA 2                                        01900001
019100*                                                                 01910001
019200     COPY SQLCA2.                                                 01920001
019300/                                                                 01930001
019400     COPY DPWS004.                                                01940001
019500/                                                                 01950001
019600 PROCEDURE DIVISION.                                              01960001
019700                                                                  01970001
019800 0000-MAINLINE-PROCESSING.                                        01980001
019900                                                                  01990001
020000     PERFORM 1000-INITIALIZATION.                                 02000001
020100                                                                  02010001
020200     PERFORM 2000-PROCESS                                         02020001
020300       UNTIL PS-EOF-EXTRACT-YES                                   02030001
020400                                                                  02040001
020500     PERFORM 9000-QUIT.                                           02050001
020600                                                                  02060001
020700     GOBACK.                                                      02070001
020800                                                                  02080001
020900******************************************************************02090001
021000** READ THE DB2 CONTROL TABLE AND READ THE FIRST ASN EXTRACT REC *02100001
021100******************************************************************02110001
021200 1000-INITIALIZATION.                                             02120001
021300     MOVE '1000-INITIALIZATION         '  TO PV-ABEND-PARAGRAPH.  02130001
021400                                                                  02140001
           OPEN INPUT IN-TRAILER-EXTRACT-FILE.                          02150004
021800     PERFORM 8000-READ-EXTRACT.                                   02180001
021900                                                                  02190001
022200     IF PS-EOF-EXTRACT-YES                                        02220001
022300         DISPLAY SPACES                                           02230001
022400         DISPLAY ALL '*'                                          02240001
022500         DISPLAY '  INPUT FILE IS EMPTY '                         02250001
022600         DISPLAY ALL '*'                                          02260001
022700         DISPLAY SPACES                                           02270001
022800     END-IF.                                                      02280001
022900                                                                  02290001
023000                                                                  02300001
023100 2000-PROCESS.                                                    02310001
023200                                                                  02320001
023300     MOVE '2000-PROCESS                '  TO PV-ABEND-PARAGRAPH.  02330001
023400                                                                  02340001
027200     PERFORM 2100-UPDATE-TSUOBTS.                                 02720001
027300     PERFORM 8000-READ-EXTRACT.                                   02730001
027400                                                                  02740001
061200 2100-UPDATE-TSUOBTS.                                             06120001
061300     MOVE '2100-UPDATE-TSUOBTS         ' TO PV-ABEND-PARAGRAPH.   06130002
061400     MOVE SU069-OTBND-TRIP-ID         TO SUOBTS-OTBND-TRIP-ID.    06140002
061500     MOVE SU069-TRIP-STAT-CDE         TO SUOBTS-TRIP-STAT-CDE.    06150002
061600     MOVE SU069-OTBND-STAT-TMST       TO SUOBTS-OTBND-STAT-TMST.  06160002
061900                                                                  06190001
062800         EXEC SQL                                                 06280001
062900             UPDATE TSUOBTS                                       06290001
063000             SET RPT_GEND_IND   = 'Y'                             06300001
063200             WHERE                                                06320001
063300                 OTBND_TRIP_ID  = :SUOBTS-OTBND-TRIP-ID           06330002
063400            AND OTBND_STAT_TMST = :SUOBTS-OTBND-STAT-TMST         06340002
063500            AND TRIP_STAT_CDE   = :SUOBTS-TRIP-STAT-CDE           06350002
063600         END-EXEC                                                 06360001
063700                                                                  06370001
063800         EVALUATE TRUE                                            06380001
063900             WHEN SQLCODE = ZERO                                  06390001
064000                 ADD +1  TO PV-QTY-UPDATE-COUNTER                 06400001
064100             WHEN SQLCODE = +100                                  06410001
064200                 DISPLAY 'ROW NOT FOUND FOR UPDATE'               06420001
064310                 DISPLAY 'TRIP ID  ' SUOBTS-OTBND-TRIP-ID         06431002
064320                 DISPLAY 'STAT CDE ' SUOBTS-TRIP-STAT-CDE         06432002
064330                 DISPLAY 'TMST CDE ' SUOBTS-OTBND-STAT-TMST       06433002
064400                 PERFORM 9100-SQL-ABEND                           06440001
064500             WHEN SQLCODE = -904                                  06450001
064600             WHEN SQLCODE = -911                                  06460001
064700             WHEN SQLCODE = -913                                  06470001
064800                  CONTINUE                                        06480001
064900                                                                  06490001
065000                                                                  06500001
065100             WHEN (SQLCODE > ZERO OR SQLWARN0 = 'W')              06510001
065200                 DISPLAY '**************************************' 06520001
065300                 DISPLAY 'WARNING ISSUED '                        06530001
065400                 DISPLAY 'UPDATE PCT_TRN_CLSN_BAL               ' 06540001
065600                 DISPLAY '**************************************' 06560001
065610                 DISPLAY 'TRIP ID  ' SUOBTS-OTBND-TRIP-ID         06561002
065620                 DISPLAY 'STAT CDE ' SUOBTS-TRIP-STAT-CDE         06562002
065630                 DISPLAY 'TMST CDE ' SUOBTS-OTBND-STAT-TMST       06563002
065700                 PERFORM 9800-SQL-WARNING                         06570001
065800                                                                  06580001
065900             WHEN SQLCODE < ZERO                                  06590001
066000                 DISPLAY '**************************************' 06600001
066100                 DISPLAY 'ERROR ISSUED ON                       ' 06610001
066200                 DISPLAY 'UPDATE PCT_TRN_CLSN_BAL               ' 06620001
066400                 DISPLAY '**************************************' 06640001
066410                 DISPLAY 'TRIP ID  ' SUOBTS-OTBND-TRIP-ID         06641002
066420                 DISPLAY 'STAT CDE ' SUOBTS-TRIP-STAT-CDE         06642002
066430                 DISPLAY 'TMST CDE ' SUOBTS-OTBND-STAT-TMST       06643002
066500                 PERFORM 9900-SQL-ERROR                           06650001
066600                                                                  06660001
066700         END-EVALUATE.                                            06670001
066900                                                                  06690001
067900/                                                                 06790001
068000 8000-READ-EXTRACT.                                               06800001
068100                                                                  06810001
068200     MOVE '8000-READ-EXTRACT   '  TO PV-ABEND-PARAGRAPH.          06820001
068300                                                                  06830001
068400     READ IN-TRAILER-EXTRACT-FILE INTO SU069-EXTRACT-RECORD       06840001
068500         AT END                                                   06850001
068600             SET PS-EOF-EXTRACT-YES TO TRUE                       06860005
069400     END-READ.                                                    06940001
069500                                                                  06950001
071600     IF PS-EOF-EXTRACT-YES                                        07160005
071700         CONTINUE                                                 07170005
071800     ELSE                                                         07180001
071900         ADD 1                        TO PV-READ-COUNTER          07190001
072000                                         PV-DISP-CONTROL          07200001
072100         IF PV-DISP-CONTROL > 50                                  07210001
072200             EXEC SQL                                             07220001
072300                 COMMIT                                           07230001
072600             END-EXEC                                             07260001
072700             MOVE PV-READ-COUNTER     TO PV-DISP-NBR              07270001
                   MOVE SU069-OTBND-TRIP-ID TO PV-TRIP-ID-DISPLAY       07271006
072800             DISPLAY PV-TIME                                      07280001
072900             ' PROCESSING REC # ' PV-DISP-NBR                     07290001
073000             ' / ' PV-DISP-KEY-MSG                                07300006
073100             MOVE ZERO                TO PV-DISP-CONTROL          07310001
073200         END-IF                                                   07320001
073300     END-IF.                                                      07330001
073400                                                                  07340001
073500/                                                                 07350001
073600 9000-QUIT.                                                       07360001
074000     MOVE PV-READ-COUNTER             TO PV-DISP-NBR              07400001
074100     DISPLAY 'RECORDS READ               = ' PV-DISP-NBR          07410001
074200                                                                  07420001
074600     MOVE PV-QTY-UPDATE-COUNTER       TO PV-DISP-NBR              07460001
074700     DISPLAY 'TSUOBTS UPDATE             = '  PV-DISP-NBR         07470001
           CLOSE IN-TRAILER-EXTRACT-FILE.                               07480004
075400/                                                                 07540001
075500 9100-SQL-ABEND.                                                  07550001
075600******************************************************************07560001
075700*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    07570001
075800*  ERROR OR WARNING CODE OCCURS.                                  07580001
075900******************************************************************07590001
076000     DISPLAY '9100-SQL-ABEND'.                                    07600001
076100     DISPLAY '** ABEND     **'.                                   07610001
076200     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        07620001
076300     DISPLAY '** PARAGRAPH ** = ' PV-ABEND-PARAGRAPH.             07630001
076400     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.     07640001
076500     DISPLAY '** TRIP ID      = ' SUOBTS-OTBND-TRIP-ID            07650005
076600     DISPLAY '** STAT CDE     ** = ' SUOBTS-TRIP-STAT-CDE         07660005
076700     DISPLAY '** TMST CDE     ** = ' SUOBTS-OTBND-STAT-TMST       07670005
076800     DISPLAY '**              ** = '                              07680001
076900     MOVE SQLCODE TO PV-SQL-CODE.                                 07690001
077000     DISPLAY '** SQL CODE  ** = ' PV-SQL-CODE.                    07700001
077100     MOVE +4013 TO PV-ABEND-CODE.                                 07710001
077200     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         07720001
077300                                                                  07730001
077400******************************************************************07740001
077500*  THIS MODULE PERFORMS THE SQL WARNING.                         *07750001
077600******************************************************************07760001
077700                                                                  07770001
077800 9800-SQL-WARNING.                                                07780001
077900                                                                  07790001
078000     MOVE SQLCODE               TO SQLCODE2.                      07800001
078100     MOVE SQLERRD(3)            TO SQLERRD3.                      07810001
078200     DISPLAY '** ABEND **       ** = SQLWARNING'.                 07820001
078300     DISPLAY '** PROGRAM        ** = SUKUP021'.                   07830001
078400     DISPLAY '** PARAGRAPH      ** = ' PV-ABEND-PARAGRAPH.        07840001
078500     DISPLAY '** SQLCODE        ** = ' SQLCODE2.                  07850001
078600     DISPLAY '** ROWS PROCESSED ** = ' SQLERRD3.                  07860001
078700                                                                  07870001
078800     COPY DPPD004.                                                07880001
078900     SET ABEND-4013-DB2-ERROR   TO TRUE                           07890001
079000     CALL 'ILBOABN0' USING ABEND-CODE.                            07900001
079100                                                                  07910001
079200 EJECT                                                            07920001
079300******************************************************************07930001
079400* THIS MODULE PERFORMS THE SQL ERROR.                            *07940001
079500******************************************************************07950001
079600                                                                  07960001
079700 9900-SQL-ERROR.                                                  07970001
079800                                                                  07980001
079900     MOVE SQLCODE               TO SQLCODE2.                      07990001
080000     MOVE SQLERRD(3)            TO SQLERRD3.                      08000001
080100     DISPLAY '** ABEND **       ** = SQLERROR'.                   08010001
080200     DISPLAY '** PROGRAM        ** = SUKUP021'.                   08020001
080300     DISPLAY '** PARAGRAPH      ** = ' PV-ABEND-PARAGRAPH.        08030001
080400                                                                  08040001
080500     COPY DPPD004.                                                08050001
080600     SET ABEND-4013-DB2-ERROR   TO TRUE                           08060001
080700     CALL 'ILBOABN0' USING ABEND-CODE.                            08070001
080800/                                                                 08080001
