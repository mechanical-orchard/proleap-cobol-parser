000100***************************************************************** 00010001
000200 IDENTIFICATION DIVISION.                                         00020001
000300******************************************************************00030001
000400                                                                  00040001
000500 PROGRAM-ID.                AUKCS517.                             00050007
000600 AUTHOR.                    BARB SCHULTZ.                         00060001
000700 INSTALLATION.              KOHLS DEPARTMENT STORES.              00070001
000800 DATE-WRITTEN.              01-02-2008.                           00080001
000900 DATE-COMPILED.                                                   00090001
001000                                                                  00100001
001100******************************************************************00110001
001200*               CICS PROGRAM - AUKCS517 - A517                   *00120007
001300*                                                                *00130001
001400*   BLACKHAWK GIFT CARD AUTH                                     *00140001
001500*                                                                *00150001
001600*   THIS TRANSACTION WILL RETRIEVE BLACKHAWK GIFT CARD INFO      *00160038
001700*   FROM THE POS QUEUE.  THESE TRANSACTIONS WILL BE INSERTED INTO*00170001
001800*   AN AUTH DATABASE AND A PROGRAM WILL BE STARTED THAT CALLS    *00180001
001900*   AJB AND SENDS THE AUTH DATA TO BLACKHAWK.                    *00190001
002000*                                                                *00200001
001100******************************************************************00210001
002700                                                                  00220001
002800******************************************************************00230001
002900 ENVIRONMENT DIVISION.                                            00240001
003000******************************************************************00250001
003100                                                                  00260001
003200******************************************************************00270001
003300 DATA DIVISION.                                                   00280001
003400******************************************************************00290001
003500                                                                  00300001
003600 WORKING-STORAGE SECTION.                                         00310001
003700                                                                  00320001
003800*                                                                 00330001
003900*  WORKING-STORAGE VARIABLES REQUIRED FOR THE USE OF THE          00340001
004000*  AUTHORIZATION LOG MESSAGES ROUTINE (EPPD000).                  00350014
004200*                                                                 00360001
004300                                                                  00370001
004200*  THIRD PARTY AUTH QUEUE LAYOUT                                  00380012
004400     COPY SAWS051.                                                00390074
004300                                                                  00400012
004400     COPY EPWS000.                                                00410012
004500                                                                  00420001
004600*                                                                 00430001
004700*    MQ Series API control blocks                                 00440001
004800*                                                                 00450001
004900 01  MQM-OBJECT-DESCRIPTOR.                                       00460001
005000     COPY CMQODV.                                                 00470001
005100                                                                  00480001
005200 01  MQM-MESSAGE-DESCRIPTOR.                                      00490001
005300     COPY CMQMDV.                                                 00500001
005400                                                                  00510001
005500 01  MQM-GET-MESSAGE-OPTIONS.                                     00520001
005600     COPY CMQGMOV.                                                00530001
005700                                                                  00540001
005800 01  MQM-PUT-MESSAGE-OPTIONS.                                     00550001
005900     COPY CMQPMOV.                                                00560001
006000                                                                  00570001
006100*                                                                 00580001
006200*    MQV contains constants (for filling in the control blocks)   00590001
006300*    and return codes (for testing the result of a call)          00600001
006400*                                                                 00610001
006500 01  MQM-CONSTANTS.                                               00620001
006600     COPY CMQV.                                                   00630001
006400                                                                  00640034
006400*---------------------------------------------------------*       00650034
006400* NETCOOL ERROR MESSAGES DISPLAYED IN CSSL                        00660034
006400*---------------------------------------------------------*       00670034
006400 01  PE-PROGRAM-ERROR-MESSAGES.                                   00680034
006400   05  PE-NETCOOL-ALERT-TO-BE-WRITTEN.                            00690034
006400     10  FILLER                              PIC  X(016)          00700034
006400           VALUE '!NETCOOL ALERT- '.                              00710034
006400     10  PE-IS003-SUMMARY                    PIC  X(255)          00720034
006400                                              VALUE SPACES.       00730034
006400                                                                  00740034
006700*---------------------------------------------------------*       00750027
006700* NETCOOL MESSAGE COPYBOOK                                        00760027
006700*---------------------------------------------------------*       00770027
006700     COPY ISWS003.                                                00780027
006700*                                                                 00790027
006800 01  PS-PROGRAM-SWITCHES.                                         00800001
006900     05  PS-PROGRAM-CONTINUE-SW  PIC X(1)     VALUE ' '.          00810001
007000         88  PS-PC-PROGRAM-CONTINUE           VALUE 'C'.          00820001
007100         88  PS-PC-PROGRAM-END                VALUE 'E'.          00830001
007200     05  PS-ERROR-TYPE           PIC X(1).                        00840029
007200         88  PS-DB2-ERROR                     VALUE 'D'.          00850029
007200         88  PS-AUTH-MESSAGE-ERROR            VALUE 'M'.          00860029
007200         88  PS-SYSTEM-ERROR                  VALUE 'S'.          00870029
007200                                                                  00880029
007300 01  PC-PROGRAM-CONSTANTS.                                        00890001
007400     05  PC-CURRENT-PROGRAM-NAME PIC X(8)     VALUE 'AUKCS517'.   00900007
007700     05  PC-AUTH-INQ-MESSAGE-LENGTH                               00930001
007800                                 PIC S9(04)   VALUE +400          00941082
007900                                 COMP SYNC.                       00950001
008200     05  PC-STORES-IV-RESP-FORMAT-COMP                            00980001
008300                                 PIC S9(4)    VALUE +145          00990001
008400                                 COMP SYNC.                       01000001
009400     05  PC-AUTH-TRAN-ID                                          01100009
009500                                 PIC X(04)   VALUE 'A518'.        01110009
009600     05  PC-AUTH-PROGRAM                                          01120009
009700                                 PIC X(08)   VALUE 'AUKCS518'.    01130009
010200*                   MQ SERIES CONSTANTS                           01140001
010300     05  PC-MQCONN               PIC X(8)    VALUE 'CSQCCONN'.    01150001
010400     05  PC-MQOPEN               PIC X(8)    VALUE 'CSQCOPEN'.    01160001
010500     05  PC-MQGET                PIC X(8)    VALUE 'CSQCGET'.     01170001
010600     05  PC-MQPUT                PIC X(8)    VALUE 'CSQCPUT'.     01180080
010600     05  PC-MQPUT1               PIC X(8)    VALUE 'CSQCPUT1'.    01181080
010700     05  PC-MQCLOSE              PIC X(8)    VALUE 'CSQCCLOS'.    01190001
010800     05  PC-MQDISC               PIC X(8)    VALUE 'CSQCDISC'.    01200001
010900     05  PC-QMGR-NAME            PIC X(4)    VALUE SPACES.        01210001
011000         88  PC-PROD-QMGR-NAME               VALUE 'QKSP'.        01220001
011100         88  PC-TEST-QMGR-NAME               VALUE 'QKST'.        01230001
011200         88  PC-QA-QMGR-NAME                 VALUE 'QKSQ'.        01240001
011300     05  PC-THIRD-PY-AUTH-QNAME PIC X(45)    VALUE                01250009
011400              'EP.THIRDPARTYCARD.AUTH.Q                     '.    01260009
011600*                 WAIT TIME OF 40 MINUTES                         01270001
011700     05  PC-MQGET-WAIT-TIME      PIC S9(9)   VALUE 2400000        01280001
011800                                             BINARY.              01290001
011900     05  PC-ONE                  PIC S9(1)   VALUE +1.            01300001
012000                                                                  01310001
012700 01  PV-PROGRAM-VARIABLES.                                        01380001
012800     05  PV-MESSAGE-AREA.                                         01390061
001600         10  PV-HD-SLS-DTE           PIC  X(10)      VALUE SPACES.01400061
001700         10  PV-HD-STR-NBR           PIC  9(04)      VALUE ZEROES.01410061
001800         10  PV-HD-RGST-ID           PIC  9(04)      VALUE ZEROES.01420061
001900         10  PV-HD-TRN-NBR           PIC  9(04)      VALUE ZEROES.01430061
002000         10  PV-HD-STRT-TM           PIC  X(08)      VALUE SPACES.01440061
002200         10  PV-HD-LNE-ITM-SEQ-NBR   PIC  9(04)      VALUE ZEROES.01450072
002300         10  PV-HD-CARD-NBR          PIC  X(30)      VALUE SPACES.01460061
002400         10  PV-HD-CUST-CHRGD-AMT    PIC  9(07)V99   VALUE ZEROES.01470072
002600         10  PV-HD-SAF-CDE           PIC  X(01)      VALUE SPACES.01480061
012800     05  PV-AUTH-INQ-MESSAGE-AREA.                                01500061
012900         10  PV-AI-MQ-MESSAGE-DESCRIPTOR                          01510061
013000                                 PIC X(324)   VALUE SPACES.       01520061
013100         10  PV-AI-AUTH-REQUEST-MESSAGE                           01530061
013200                                 PIC X(74)    VALUE SPACES.       01540082
013300                                                                  01550001
013400     05  PV-CICS-RESPONSE         PIC S9(9)   VALUE ZERO          01560001
013500                                  COMP SYNC.                      01570001
013600     05  PV-CICS-RESPONSE-DISP    PIC ZZZZZ9999-.                 01580001
015000     05  PV-CICS-MSG-AREA         PIC X(100) VALUE SPACES.        01591088
013700                                                                  01592088
018400*                     MQ SERIES VARIABLES.                        01950001
018500     05  PV-GET-MESSAGE-BUFFER      PIC X(82)        VALUE SPACES.01960066
018600     05  PV-GET-MSG-BUFFER-LENGTH   PIC S9(9) BINARY VALUE 82.    01970066
018700     05  PV-GET-DATA-LENGTH         PIC S9(9) BINARY VALUE 0.     01980001
019000     05  PV-CONNECT-HANDLE          PIC S9(9) BINARY VALUE 0.     02010001
019100     05  PV-GETQ-HANDLE             PIC S9(9) BINARY VALUE 0.     02020001
019200     05  PV-OPEN-OPTIONS            PIC S9(9) BINARY VALUE 0.     02030001
019300     05  PV-COMPLETION-CODE         PIC S9(9) BINARY VALUE 0.     02040001
019400     05  PV-REASON                  PIC S9(9) BINARY VALUE 0.     02050001
019500     05  PV-CONNECT-REASON          PIC S9(9) BINARY VALUE 0.     02060001
019600     05  PV-DISPLAY-REASON          PIC S9(9)        VALUE 0.     02070001
019700     05  PV-DISPLAY-COMP-CODE       PIC S9(9)        VALUE 0.     02080001
           05  PV-SEPARATE-CRD.                                         02090017
               10  PV-UPC-NBR       PIC X(11)       VALUE SPACES.       02100041
               10  PV-CRD-NBR       PIC X(19)       VALUE SPACES.       02110019
019700     05  PV-SLS-DTE           PIC  X(10)      VALUE SPACES.       02120016
019700     05  PV-STR-NBR           PIC  9(04)      VALUE ZEROES.       02130027
019700     05  PV-RGST-ID           PIC  9(04)      VALUE ZEROES.       02140027
019700     05  PV-TRN-NBR           PIC  9(04)      VALUE ZEROES.       02150027
019700     05  PV-STRT-TM           PIC  X(08)      VALUE SPACES.       02160016
019700     05  PV-LNE-ITM-SEQ-NBR   PIC  9(04)      VALUE ZEROES.       02170027
019700     05  PV-CUST-CHRGD-AMT    PIC  9(07)      VALUE ZEROES.       02180035
                                                                        02190092
       01  PV-SYSTEM-ID.                                                02350032
           05  PV-CICS-REGION         PIC  X(06)  VALUE SPACE.          02360032
           05  FILLER                 PIC  X(02)  VALUE SPACE.          02370032
                                                                        02380032
                                                                        02390032
        01  DE-DB2-ERROR-MESSAGE.                                       02400010
            05  FILLER                  PIC X(11)    VALUE              02410010
                'SQLCODE = ('.                                          02420010
            05  DE-SQLCODE              PIC Z(8)9-   VALUE ZERO.        02430010
            05  FILLER                  PIC X(21)    VALUE              02440010
                ')  ROWS PROCESSED = ('.                                02450010
            05  DE-ROWS-PROCESSED       PIC Z(8)9-   VALUE ZERO.        02460010
            05  FILLER                  PIC X(25)    VALUE ')'.         02470010
                                                                        02480010
       01  DW-DB2-WARNING-MESSAGE.                                      02490030
           05  FILLER                  PIC X(11)    VALUE               02500030
                 'SQLCODE = ('.                                         02510030
           05  DW-SQLCODE              PIC Z(8)9-   VALUE ZERO.         02520030
           05  FILLER                  PIC X(21)    VALUE               02530030
                 ')  ROWS PROCESSED = ('.                               02540030
           05  DW-ROWS-PROCESSED       PIC Z(8)9-   VALUE ZERO.         02550010
           05  FILLER                  PIC X(14)    VALUE               02560010
                ')  SQLWARN = ('.                                       02570030
           05  DW-SQLWARN              PIC X(8)     VALUE ZERO.         02580010
           05  FILLER                  PIC X(3)     VALUE ')'.          02590010
                                                                        02600010
       01  DS-DB2-SQLERRMC-MESSAGE.                                     02610010
           05  FILLER                  PIC X(11)    VALUE               02620010
               'SQLERRMC = '.                                           02630010
           05  DS-SQLERRMC             PIC X(66)    VALUE SPACES.       02640010
                                                                        02650010
       01  AA-ATTEMPTED-ACTION-MESSAGE.                                 02660010
           05  FILLER                  PIC X(14)    VALUE               02670010
               'ATTEMPTING TO '.                                        02680010
           05  AA-ATTEMPTED-ACTION.                                     02690010
               10 AA-ATTEMPTED-ACT     PIC X(80)    VALUE SPACES.       02700010
               10 AA-ATTEMPTED-CRD     PIC X(10)    VALUE SPACES.       02710010
           05  AA-ATTEMPTED-ACTION-R REDEFINES AA-ATTEMPTED-ACTION.     02720010
               10 AA-ATTEMPTED-ACTI    PIC X(80).                       02730010
               10 AA-ATTEMPTED-YR      PIC X(04).                       02740010
               10 AA-ATTEMPTED-SHIP    PIC X(06).                       02750010
                                                                        02760014
      *                                                                 02820010
      *  THIRD PARTY GIFT CARD TABLES                                   02830012
      *                                                                 02840010
                                                                        02850012
           EXEC SQL                                                     02860012
               INCLUDE GCT00002                                         02870012
           END-EXEC.                                                    02880012
                                                                        02890010
           EXEC SQL                                                     02900037
               INCLUDE GCT00004                                         02910037
           END-EXEC.                                                    02920037
                                                                        02930037
      *  STANDARD LAYOUT FOR THE SQL COMMUNICATION AREA.                02940010
                                                                        02950010
           EXEC SQL                                                     02960010
               INCLUDE SQLCA                                            02970010
           END-EXEC.                                                    02980010
                                                                        02990010
020500 01  PE-PROGRAM-ERROR-MESSAGES.                                   03000010
020600*                    MQ CALL ERROR MESSAGES                       03010010
020700     05  PE-MQ-ERROR-NUMBER           PIC X(02) VALUE '01'.       03020010
020800     05  PE-MQ-ERROR-MESSAGE.                                     03030010
020900         10  FILLER                   PIC X(19) VALUE             03040010
021000                                'MQ ERROR FOR CALL: '.            03050010
021100         10  PE-MQ-CALL-TYPE          PIC X(7)  VALUE SPACES.     03060010
021200             88  PE-MQ-CONNECT                  VALUE 'MQCONN '.  03070010
021300             88  PE-MQ-OPEN                     VALUE 'MQOPEN '.  03080010
021400             88  PE-MQ-GET                      VALUE 'MQGET  '.  03090010
021500             88  PE-MQ-PUT1                     VALUE 'MQPUT1 '.  03100010
021600             88  PE-MQ-CLOSE                    VALUE 'MQCLOSE'.  03110010
021700             88  PE-MQ-DISCONNECT               VALUE 'MQDISCN'.  03120010
021800         10  FILLER                   PIC X(02) VALUE SPACES.     03130001
021900         10  FILLER                   PIC X(11) VALUE             03140001
022000                                        'COMP CODE: '.            03150001
022100         10  PE-MQ-COMPLETION-CODE    PIC 9(04) VALUE ZEROS.      03160001
022200         10  FILLER                   PIC X(02) VALUE SPACES.     03170001
022300         10  FILLER                   PIC X(13) VALUE             03180001
022400                                      'REASON CODE: '.            03190001
022500         10  PE-MQ-REASON-CODE        PIC 9(04) VALUE ZEROS.      03200001
022600                                                                  03210001
022700*                REGISTER PROGRAMMING ERROR MESSAGE               03220001
022800     05  PE-REG-PROG-ERROR-NUMBER     PIC X(02) VALUE '02'.       03230001
022900     05  PE-REGISTER-PROGRAM-ERROR.                               03240001
023000         10  FILLER                   PIC X(29) VALUE             03250001
023100                      'REGISTER PROGRAMMING ERROR - '.            03260001
023200         10  FILLER                   PIC X(02) VALUE SPACES.     03270001
023300         10  FILLER                   PIC X(07) VALUE             03280001
023400                                            'STORE: '.            03290001
023500         10  PE-RP-STORE-NUMBER       PIC 9(04) VALUE ZEROS.      03300001
023600         10  FILLER                   PIC X(02) VALUE SPACES.     03310001
023700         10  FILLER                   PIC X(06) VALUE             03320001
023800                                             'TERM: '.            03330001
023900         10  PE-RP-TERMINAL-NUMBER    PIC 9(04) VALUE ZEROS.      03340001
024000                                                                  03350001
024100*                   PROGRAM START ERROR MESSAGE                   03360001
024200     05  PE-PROG-START-ERROR-NUMBER   PIC X(02) VALUE '03'.       03370001
024300     05  PE-PROGRAM-START-ERROR.                                  03380001
024400         10  FILLER                   PIC X(03) VALUE ' - '.      03390001
024500         10  FILLER                   PIC X(09) VALUE             03400001
024600                                                   'PROGRAM ('.   03410001
024700         10  PE-PS-START-PGM-NAME     PIC X(08) VALUE SPACES.     03420001
024800         10  FILLER                   PIC X(14) VALUE             03430001
024900                                              ') START FAILED'.   03440001
025000         10  FILLER                   PIC X(14) VALUE             03450001
025100                                              ' / CICS RESP: '.   03460001
025200         10  PE-PS-CICS-RESP-CODE     PIC ZZZ9-.                  03470001
025300     05  PE-CICS-ERROR-NUMBER         PIC X(02) VALUE '05'.       03480001
025400     05  PE-CICS-ERROR-MSG.                                       03490001
025500         10  FILLER                   PIC X(28) VALUE             03500001
025600         'CICS ERROR - RESPONSE CODE: '.                          03510001
025700         10  PE-CE-CICS-RESP-CODE     PIC ZZZ9-.                  03520001
025800     05  PE-MSG-RECEIVE               PIC X(02) VALUE '06'.       03530001
025800                                                                  03540048
024000******************************************************************03550048
024000 LINKAGE SECTION.                                                 03560048
024000******************************************************************03570048
024000                                                                  03590048
044100******************************************************************03600001
044200 PROCEDURE DIVISION.                                              03610001
044300******************************************************************03620001
044400                                                                  03630001
044500 0000-MAINLINE.                                                   03640001
044600                                                                  03650001
044700     PERFORM 1000-INITIALIZE.                                     03660001
044800                                                                  03670001
044900     PERFORM 2000-PROCESS-AUTH-REQUESTS                           03680001
045000         UNTIL PS-PC-PROGRAM-END.                                 03690001
045100                                                                  03700001
045200     PERFORM 9500-CLOSE-THIRDPTY-AUTH-Q.                          03710079
045300     PERFORM 9600-DISCONNECT-FROM-Q-MNGR.                         03720001
045400                                                                  03730001
045500     PERFORM 9999-RETURN-TO-NATIVE-CICS.                          03740001
045600                                                                  03750001
045700******************************************************************03760001
045800*  INITIALIZE FOR ALL BLACKHAWK POS TRANSACTIONS.                *03770006
045900*  FORMAT THE CURRENT DATE AND TIME, ESTABLISH ADDRESSING TO THE *03780001
046300******************************************************************03790001
046400                                                                  03800001
046500 1000-INITIALIZE.                                                 03810001
046600     PERFORM EP000-0000-INITIALIZE.                               03820001
046700     IF EP000-PV-KOHLS-PROD-SYSTEM                                03830001
046800         SET PC-PROD-QMGR-NAME  TO  TRUE                          03840001
046900     ELSE                                                         03850001
047000        IF EP000-PV-KOHLS-QA-SYSTEM                               03860001
047100            SET PC-QA-QMGR-NAME  TO  TRUE                         03870001
047200        ELSE                                                      03880001
047300            SET PC-TEST-QMGR-NAME  TO  TRUE                       03890001
047400        END-IF                                                    03900001
047500     END-IF.                                                      03910001
047600                                                                  03920001
047700     SET PS-PC-PROGRAM-CONTINUE  TO  TRUE.                        03930001
048300                                                                  03940003
047800**** get the first gift card off the queue                        03950003
047900     PERFORM 9200-CONNECT-TO-Q-MNGR.                              03960001
048000     PERFORM 9300-OPEN-THIRDPTY-AUTH-Q.                           03970079
048100                                                                  03980001
048200     PERFORM 9400-MQGET-AUTH-REQUEST.                             03990001
048300                                                                  04000001
048400******************************************************************04010001
048500*  PROCESS AN AUTHORIZATION REQUEST.  DETERMINE IF THERE ARE     *04020001
048600*  REGISTER PROGRAMMING ERRORS. FIND THE MERCHANT NUMBER FOR THE *04030001
048700*  STORE AND CARD TYPE REQUESTING AUTHORIZATION. FORMAT A        *04040001
048800*  THIRDPTY REQUEST MESSAGE, FIND THE NEXT AVAILABLE             *04050079
048900*  COMMUNICATION LINE, AND SEND THE MESSAGE.                     *04060001
049000*  LOG ALL COMMUNICATION PROBLEMS/RESTORATION IN THE STORE TABLE *04070001
049100*  AND ON THE ALERT MESSAGE CONSOLE.                             *04080001
049200******************************************************************04090001
049300 2000-PROCESS-AUTH-REQUESTS.                                      04100001
049400                                                                  04110008
049400     MOVE MQM-MESSAGE-DESCRIPTOR                                  04120061
049400         TO PV-AI-MQ-MESSAGE-DESCRIPTOR.                          04130061
049400                                                                  04131062
      *** DISPLAY A MESSAGE TO THE EPCL LOG ***                         04150001
083600     MOVE PE-MSG-RECEIVE TO EP000-SL-PI-MESSAGE-NUMBER.           04160001
083700     SET EP000-SL-INFORMATION TO TRUE.                            04170001
083800     MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER.                   04180001
      * Display Message *                                               04190009
           STRING '3RD PRTY GC RCV: '                                   04200085
                   PV-STR-NBR '/'                                       04220017
                   PV-RGST-ID '/'                                       04230017
                   PV-TRN-NBR '/'                                       04240017
                   PV-STRT-TM '/'                                       04250017
                   PV-UPC-NBR '/'                                       04261073
                   'CARD:' PV-CRD-NBR                                   04270085
                   ' AMT:' PV-CUST-CHRGD-AMT                            04290085
                   DELIMITED BY SIZE                                    04300033
           INTO EP000-MD-SYSTEM-LOG-MESSAGE                             04310009
084100          (EP000-MESSAGE-LINE-COUNTER)                            04320009
           END-STRING.                                                  04330009
                                                                        04340009
084600     PERFORM EP000-1000-POST-MESSAGE.                             04350001
                                                                        04360009
070600     PERFORM 5000-INSERT-GFT-TRAN-TABLE.                          04370045
012800                                                                  04373084
070600     PERFORM 5100-INSERT-GFT-VND-AUTH-TBL.                        04390045
070600     PERFORM 5200-COMMIT-CHANGES.                                 04420092
                                                                        04450050
059900     PERFORM 6000-START-AUTH-PGM.                                 04460070
                                                                        04480001
      *** GET NEXT MESSAGE FROM THE QUEUE ***                           04490001
053000     PERFORM 9400-MQGET-AUTH-REQUEST.                             04500001
067800                                                                  04510020
070600*----------------------------------------------------------------*04520010
070600* INSERT GIFT CARD TRANSACTION TABLE                             *04530011
070600*----------------------------------------------------------------*04540010
070600 5000-INSERT-GFT-TRAN-TABLE.                                      04550036
070600                                                                  04560010
070600     EXEC SQL INSERT                                              04570010
070600              INTO GCT_GFT_CRD_TRN                                04580011
070600                  (CRD_ACCT_NBR                                   04590011
070600                  ,CRE_TMST                                       04600022
070600                  ,SLS_DTE                                        04610011
070600                  ,STR_NBR                                        04620011
070600                  ,RGST_ID                                        04630011
070600                  ,TRN_NBR                                        04640011
070600                  ,STRT_TM                                        04650011
070600                  ,LNE_ITM_SEQ_NBR                                04660011
070600                  ,UPC_NUMBER                                     04670011
070600                  ,CUST_CHRGD_AMT)                                04680011
070600           VALUES                                                 04690010
070600              (:GCT00002-CRD-ACCT-NBR                             04700017
070600              , CURRENT TIMESTAMP                                 04710032
070600              ,:GCT00002-SLS-DTE                                  04720017
070600              ,:GCT00002-STR-NBR                                  04730017
070600              ,:GCT00002-RGST-ID                                  04740017
070600              ,:GCT00002-TRN-NBR                                  04750017
070600              ,:GCT00002-STRT-TM                                  04760017
070600              ,:GCT00002-LNE-ITM-SEQ-NBR                          04770017
070600              ,:GCT00002-UPC-NUMBER                               04780017
070600              ,:GCT00002-CUST-CHRGD-AMT)                          04790017
070600      END-EXEC.                                                   04800010
070600                                                                  04810010
070600      EVALUATE TRUE                                               04820010
070600          WHEN SQLCODE = 0                                        04821092
070600          WHEN SQLCODE = -803                                     04830059
070600               CONTINUE                                           04840059
070600          WHEN OTHER                                              04850092
070600               MOVE SA051-CARD-NBR  TO  AA-ATTEMPTED-CRD          04860019
070600               MOVE ' INSERT AUTH ROW (GCT00002)'                 04870017
070600                                 TO AA-ATTEMPTED-ACT              04880010
070600               PERFORM 9100-DB2-ERROR                             04890010
070600               PERFORM 9999-RETURN-TO-NATIVE-CICS                 04900010
070600      END-EVALUATE.                                               05000010
070600*----------------------------------------------------------------*05010036
070600* INSERT GIFT CARD TRANSACTION TABLE                             *05020036
070600*----------------------------------------------------------------*05030036
070600 5100-INSERT-GFT-VND-AUTH-TBL.                                    05040036
070600                                                                  05050036
070600     EXEC SQL INSERT                                              05060036
070600              INTO GCT_VND_AUTH                                   05070036
070600                  (CRD_ACCT_NBR                                   05080036
070600                  ,CRE_TMST                                       05090036
070600                  ,LAST_UPD_TMST)                                 05100060
070600           VALUES                                                 05130036
070600              (:GCT00004-CRD-ACCT-NBR                             05140036
070600              , CURRENT TIMESTAMP                                 05150036
070600              , CURRENT TIMESTAMP)                                05160060
070600      END-EXEC.                                                   05190036
070600                                                                  05200036
070600      EVALUATE TRUE                                               05210036
070600          WHEN SQLCODE = 0                                        05220092
070600          WHEN SQLCODE = -803                                     05221092
070600               CONTINUE                                           05230059
070600          WHEN OTHER                                              05240092
070600               MOVE SA051-CARD-NBR  TO  AA-ATTEMPTED-CRD          05250092
070600               MOVE ' INSERT AUTH ROW (GCT00004)'                 05260092
070600                                 TO AA-ATTEMPTED-ACT              05270092
070600               PERFORM 9100-DB2-ERROR                             05280092
070600               PERFORM 9999-RETURN-TO-NATIVE-CICS                 05290092
070600      END-EVALUATE.                                               05390036
070600*-----------------------------------------------------------------05400053
070600*  COMMIT FOR GFT_VND_AUTH_TBL AND GCT_GFT_CRD_TRN               *05410053
070600*-----------------------------------------------------------------05420053
070600 5200-COMMIT-CHANGES.                                             05430053
070600                                                                  05440061
070600     EXEC CICS                                                    05450053
070600         SYNCPOINT                                                05460053
070600     END-EXEC.                                                    05470053
070600                                                                  05480053
070600     EVALUATE TRUE                                                05490053
070600         WHEN SQLCODE = ZERO                                      05500053
070600             CONTINUE                                             05510053
070600         WHEN SQLCODE > ZERO                                      05520053
070600         WHEN SQLCODE < ZERO                                      05530053
070600             MOVE '5200-COMMIT-CHANGES' TO AA-ATTEMPTED-ACTION    05540053
070600             PERFORM 9100-DB2-ERROR                               05550053
070600     END-EVALUATE.                                                05560053
070600                                                                  05570053
059400******************************************************************05580053
059500*  THIS PARAGRAPH SENDS A FORMATTED THIRDPTY ISO MESSAGE TO      *05590079
059600*  THE RESPONSE PROGRAM. IT STARTS AUKCS518 TO GO TO AJB AND GET *05600053
059600*  THE THIRD PARTY GIFT CARD ACTIVATED.   A RESPONSE SHOULD BE   *05610053
059600*  COMING BACK TO THIS PROGRAM.                                  *05620053
059800******************************************************************05630053
059900 6000-START-AUTH-PGM.                                             05640070
060000                                                                  05650061
060100     EXEC CICS                                                    05660061
060200         START                                                    05670061
060300             TRANSID (PC-AUTH-TRAN-ID)                            05680061
060400             FROM    (PV-AUTH-INQ-MESSAGE-AREA)                   05690061
060500             LENGTH  (PC-AUTH-INQ-MESSAGE-LENGTH)                 05700061
060600             RESP    (PV-CICS-RESPONSE)                           05710061
060700     END-EXEC.                                                    05720061
060800                                                                  05730061
060900     IF PV-CICS-RESPONSE NOT = DFHRESP(NORMAL)                    05740061
061000         INITIALIZE EP000-SL-SYSTEM-LOG-MESSAGE                   05750061
061100         MOVE PC-AUTH-PROGRAM  TO PE-PS-START-PGM-NAME            05760061
061300         MOVE PE-PROG-START-ERROR-NUMBER                          05770061
061400                               TO EP000-SL-PI-MESSAGE-NUMBER      05780061
061500         MOVE PV-CICS-RESPONSE TO PE-PS-CICS-RESP-CODE            05790061
061600         MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER                05800061
061700         MOVE PE-PROGRAM-START-ERROR                              05810061
061800                               TO EP000-MD-SYSTEM-LOG-MESSAGE     05820061
061900                                  (EP000-MESSAGE-LINE-COUNTER)    05830061
062000         SET EP000-SL-ERROR TO TRUE                               05840061
062500         PERFORM EP000-1000-POST-MESSAGE                          05850061
062800         PERFORM 6100-BUILD-SEND-FORMATTED-RESP                   05860061
062900     END-IF.                                                      05870061
067200******************************************************************06180058
067300*  BUILD AND SEND A RESPONSE                                     *06190092
067600******************************************************************06220058
067700 6100-BUILD-SEND-FORMATTED-RESP.                                  06230064
067800                                                                  06240064
090300*---------- CONSTRUCT NETCOOL MESSAGE -------------------------*  06411088
090300     STRING                                                       06412088
090300     ' AUKCS517:'                 DELIMITED BY SIZE               06413088
090300     ' START OF AUKCS518 FAILED'  DELIMITED BY SIZE               06414088
090300     ' CALL PAYMENT AND TAX MAINFRAME TEAM' DELIMITED BY SIZE     06415091
090300     INTO IS003-SUMMARY.                                          06416088
090300     PERFORM 9800-POST-NETCOOL-ALERT.                             06417088
090300*---------- CONSTRUCT NETCOOL MESSAGE -------------------------*  06418088
070600                                                                  06419088
070600*----------------------------------------------------------------*06420058
070600*  FORMAT AND POST INFORMATION RELATIVE TO A DB2 ERROR.  ROLL    *06430058
070600*  BACK ALL RESOURCES.                                           *06440058
070600*----------------------------------------------------------------*06450058
070600 9100-DB2-ERROR.                                                  06460058
070600                                                                  06470058
070600     SET PS-DB2-ERROR                                             06480058
070600         EP000-SL-ERROR TO TRUE.                                  06490058
070600                                                                  06500058
070600     MOVE SQLCODE TO DE-SQLCODE.                                  06510058
070600     MOVE SQLERRD(3) TO DE-ROWS-PROCESSED.                        06520058
070600     ADD  PC-ONE TO EP000-MESSAGE-LINE-COUNTER                    06530058
070600     MOVE DE-DB2-ERROR-MESSAGE                                    06540058
070600         TO  EP000-MD-SYSTEM-LOG-MESSAGE                          06550058
070600                 (EP000-MESSAGE-LINE-COUNTER).                    06560058
070600     MOVE SQLERRMC TO DS-SQLERRMC.                                06570058
070600     ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER                     06580058
070600     MOVE DS-DB2-SQLERRMC-MESSAGE                                 06590058
070600         TO  EP000-MD-SYSTEM-LOG-MESSAGE                          06600058
070600                 (EP000-MESSAGE-LINE-COUNTER).                    06610058
070600                                                                  06620058
070600     ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER                     06630058
070600     MOVE AA-ATTEMPTED-ACTION-MESSAGE                             06640058
070600         TO  EP000-MD-SYSTEM-LOG-MESSAGE                          06650058
070600                 (EP000-MESSAGE-LINE-COUNTER).                    06660058
070600                                                                  06670058
070600     PERFORM EP000-1000-POST-MESSAGE.                             06680058
070600                                                                  06690058
070600     EXEC CICS                                                    06700058
070600         SYNCPOINT                                                06710058
070600             ROLLBACK                                             06720058
070600     END-EXEC.                                                    06730058
070600*----------------------------------------------------------------*06740058
070600*  FORMAT AND POST INFORMATION RELATIVE TO A DB2 WARNING.  ROLL  *06750058
070600*  BACK ALL RESOURCES.                                           *06760058
070600*----------------------------------------------------------------*06770058
070600                                                                  06780058
070600 9100-DB2-WARNING.                                                06790058
070600     SET PS-DB2-ERROR                                             06800058
070600         EP000-SL-ERROR TO TRUE.                                  06810058
070600                                                                  06820058
070600     MOVE SQLCODE TO DW-SQLCODE.                                  06830058
070600     MOVE SQLERRD(3) TO DW-ROWS-PROCESSED.                        06840058
070600     MOVE SQLWARN TO DW-SQLWARN.                                  06850058
070600     ADD  PC-ONE TO EP000-MESSAGE-LINE-COUNTER                    06860058
070600     MOVE DW-DB2-WARNING-MESSAGE                                  06870058
070600         TO  EP000-MD-SYSTEM-LOG-MESSAGE                          06880058
070600                 (EP000-MESSAGE-LINE-COUNTER)                     06890058
070600     MOVE SQLERRMC TO DS-SQLERRMC.                                06900058
070600     ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER                     06910058
070600     MOVE DS-DB2-SQLERRMC-MESSAGE                                 06920058
070600         TO  EP000-MD-SYSTEM-LOG-MESSAGE                          06930058
070600                 (EP000-MESSAGE-LINE-COUNTER)                     06940058
070600                                                                  06950058
070600     ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER                     06960058
070600     MOVE AA-ATTEMPTED-ACTION-MESSAGE                             06970058
070600         TO  EP000-MD-SYSTEM-LOG-MESSAGE                          06980058
070600                 (EP000-MESSAGE-LINE-COUNTER)                     06990058
070600                                                                  07000058
070600     PERFORM EP000-1000-POST-MESSAGE.                             07010058
070600                                                                  07020058
070600     EXEC CICS                                                    07030058
070600         SYNCPOINT                                                07040058
070600             ROLLBACK                                             07050058
070600     END-EXEC.                                                    07060058
070600                                                                  07070058
070700* -------------------------------------------------------------- *07080053
070800*    Connect to the queue manager                                 07090010
070900* -------------------------------------------------------------- *07100010
071000 9200-CONNECT-TO-Q-MNGR.                                          07110010
071100                                                                  07120010
071200     CALL PC-MQCONN USING PC-QMGR-NAME                            07130010
071300                          PV-CONNECT-HANDLE                       07140017
071400                          PV-COMPLETION-CODE                      07150017
071500                          PV-REASON.                              07160017
071600*                                                                 07170010
071700*    If connection fails display error message and exit.          07180010
071800*                                                                 07190010
071900     MOVE PV-REASON TO PV-CONNECT-REASON.                         07200010
072000     IF (PV-COMPLETION-CODE NOT = MQCC-OK) THEN                   07210010
090300*---------- CONSTRUCT NETCOOL MESSAGE -------------------------*  07211088
090300         STRING                                                   07212088
090300         ' AUKCS517:'                 DELIMITED BY SIZE           07213088
090300         ' MQ CONNECT FAILED'         DELIMITED BY SIZE           07214088
090300         ' CALL PAYMENT AND TAX MAINFRAME TEAM'                   07215091
090300                                      DELIMITED BY SIZE           07215291
090300         INTO IS003-SUMMARY                                       07216088
090300         PERFORM 9800-POST-NETCOOL-ALERT                          07217088
090300*---------- CONSTRUCT NETCOOL MESSAGE -------------------------*  07218088
072100         SET PE-MQ-CONNECT TO TRUE                                07220010
072200         MOVE PV-COMPLETION-CODE TO PV-DISPLAY-COMP-CODE          07230010
072300         MOVE PV-DISPLAY-COMP-CODE TO PE-MQ-COMPLETION-CODE       07240010
072400         MOVE PV-REASON TO PV-DISPLAY-REASON                      07250010
072500         MOVE PV-DISPLAY-REASON TO PE-MQ-REASON-CODE              07260010
072600*                                                                 07270001
072700         MOVE PE-MQ-ERROR-NUMBER TO EP000-SL-PI-MESSAGE-NUMBER    07280001
072800         SET EP000-SL-ERROR  TO  TRUE                             07290001
072900         MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER                07300001
073000         MOVE PE-MQ-ERROR-MESSAGE TO                              07310001
073100                    EP000-MD-SYSTEM-LOG-MESSAGE                   07320001
073200                    (EP000-MESSAGE-LINE-COUNTER)                  07330001
073300*                                                                 07340001
073400         PERFORM EP000-1000-POST-MESSAGE                          07350001
073500         PERFORM 9999-RETURN-TO-NATIVE-CICS                       07360001
073600     END-IF.                                                      07370001
073700                                                                  07380001
  3800* -------------------------------------------------------------- *07390019
073900*    Open the queue for input                                     07400001
074000* -------------------------------------------------------------- *07410001
074100 9300-OPEN-THIRDPTY-AUTH-Q.                                       07420079
074200                                                                  07430001
074300     COMPUTE PV-OPEN-OPTIONS = MQOO-INPUT-SHARED +                07440001
074400                               MQOO-FAIL-IF-QUIESCING.            07450001
074500     MOVE PC-THIRD-PY-AUTH-QNAME TO MQOD-OBJECTNAME.              07460009
074600     MOVE PC-QMGR-NAME        TO  MQOD-OBJECTQMGRNAME.            07470001
074700*                                                                 07480001
074800     CALL PC-MQOPEN USING PV-CONNECT-HANDLE                       07490001
074900                          MQM-OBJECT-DESCRIPTOR                   07500017
075000                          PV-OPEN-OPTIONS                         07510017
075100                          PV-GETQ-HANDLE                          07520017
075200                          PV-COMPLETION-CODE                      07530017
075300                          PV-REASON.                              07540017
075400*                                                                 07550001
075500*    If open fails log error message and exit.                    07560001
075600*                                                                 07570001
075700     IF (PV-COMPLETION-CODE NOT = MQCC-OK) THEN                   07580001
090300*---------- CONSTRUCT NETCOOL MESSAGE -------------------------*  07581088
090300         STRING                                                   07582088
090300         ' AUKCS517:'                 DELIMITED BY SIZE           07583088
090300         ' MQ OPEN FAILED'            DELIMITED BY SIZE           07584088
090300         ' CALL PAYMENT AND TAX MAINFRAME TEAM'                   07584191
090300                                      DELIMITED BY SIZE           07585091
090300         INTO IS003-SUMMARY                                       07586088
090300         PERFORM 9800-POST-NETCOOL-ALERT                          07587088
090300*---------- CONSTRUCT NETCOOL MESSAGE -------------------------*  07588088
075800         SET PE-MQ-OPEN TO TRUE                                   07590001
075900         MOVE PV-COMPLETION-CODE TO PV-DISPLAY-COMP-CODE          07600001
076000         MOVE PV-DISPLAY-COMP-CODE TO PE-MQ-COMPLETION-CODE       07610001
076100         MOVE PV-REASON TO PV-DISPLAY-REASON                      07620001
076200         MOVE PV-DISPLAY-REASON TO PE-MQ-REASON-CODE              07630001
076300*                                                                 07640001
076400         MOVE PE-MQ-ERROR-NUMBER TO EP000-SL-PI-MESSAGE-NUMBER    07650001
076500         SET EP000-SL-ERROR  TO  TRUE                             07660001
076600         MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER                07670001
076700         MOVE PE-MQ-ERROR-MESSAGE TO                              07680001
076800                    EP000-MD-SYSTEM-LOG-MESSAGE                   07690001
076900                    (EP000-MESSAGE-LINE-COUNTER)                  07700001
077000*                                                                 07710001
077100         PERFORM EP000-1000-POST-MESSAGE                          07720001
077200         PERFORM 9600-DISCONNECT-FROM-Q-MNGR                      07730001
077300         PERFORM 9999-RETURN-TO-NATIVE-CICS                       07740001
077400     END-IF.                                                      07750001
077500                                                                  07760001
077600* -------------------------------------------------------------- *07770001
077700*  MQ GET THE AUTHORIZATION MESSAGE FROM EP.CHECK.AUTH.Q          07780001
077800* -------------------------------------------------------------- *07790001
077900 9400-MQGET-AUTH-REQUEST.                                         07800001
078000*                                                                 07810001
078100*    Setup MQGMO-OPTIONS                                          07820001
078200*                                                                 07830001
078300     COMPUTE MQGMO-OPTIONS = MQGMO-WAIT +                         07840001
078400                             MQGMO-NO-SYNCPOINT +                 07850001
078500                             MQGMO-FAIL-IF-QUIESCING.             07860001
078600                                                                  07870001
078700     MOVE PC-MQGET-WAIT-TIME  TO  MQGMO-WAITINTERVAL.             07880001
078800*                                                                 07890001
078900*    The message ID and Correl ID                                 07900001
079000*    are blanked before each MQGET.                               07910001
079100*                                                                 07920001
079200     MOVE SPACES    TO PV-GET-MESSAGE-BUFFER.                     07930001
079300     MOVE MQMI-NONE TO MQMD-MSGID.                                07940001
079400     MOVE MQCI-NONE TO MQMD-CORRELID.                             07950001
079500*                                                                 07960001
079600     CALL  PC-MQGET  USING PV-CONNECT-HANDLE                      07970001
079700                           PV-GETQ-HANDLE                         07980001
079800                           MQMD                                   07990001
079900                           MQGMO                                  08000001
080000                           PV-GET-MSG-BUFFER-LENGTH               08010001
080100                           PV-GET-MESSAGE-BUFFER                  08020001
080200                           PV-GET-DATA-LENGTH                     08030001
080300                           PV-COMPLETION-CODE                     08040001
080400                           PV-REASON.                             08050001
080500                                                                  08060001
080600*                                                                 08070001
080700*        If get failed, display the error message                 08080001
080800*        and terminate the program.                               08090001
080900*                                                                 08100001
081000     IF (PV-COMPLETION-CODE = MQCC-FAILED)                        08110001
081100         IF (PV-REASON NOT = MQRC-NO-MSG-AVAILABLE)               08120001
090300*---------- CONSTRUCT NETCOOL MESSAGE -------------------------*  08121088
090300             STRING                                               08122088
090300             ' AUKCS517:'                 DELIMITED BY SIZE       08123088
090300             ' MQ GET FAILED'             DELIMITED BY SIZE       08124088
090300             ' CALL PAYMENT AND TAX MAINFRAME TEAM'               08125191
090300                                          DELIMITED BY SIZE       08125291
090300             INTO IS003-SUMMARY                                   08126088
090300             PERFORM 9800-POST-NETCOOL-ALERT                      08127088
090300*---------- CONSTRUCT NETCOOL MESSAGE -------------------------*  08128088
081200             SET PE-MQ-GET TO TRUE                                08130001
081300             MOVE PV-COMPLETION-CODE TO PV-DISPLAY-COMP-CODE      08140001
081400             MOVE PV-DISPLAY-COMP-CODE TO PE-MQ-COMPLETION-CODE   08150001
081500             MOVE PV-REASON TO PV-DISPLAY-REASON                  08160001
081600             MOVE PV-DISPLAY-REASON TO PE-MQ-REASON-CODE          08170001
081700*                                                                 08180001
081800             MOVE PE-MQ-ERROR-NUMBER TO                           08190001
081900                                     EP000-SL-PI-MESSAGE-NUMBER   08200001
082000             SET EP000-SL-ERROR  TO  TRUE                         08210001
082100             MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER            08220001
082200             MOVE PE-MQ-ERROR-MESSAGE TO                          08230001
082300                        EP000-MD-SYSTEM-LOG-MESSAGE               08240001
082400                        (EP000-MESSAGE-LINE-COUNTER)              08250001
082500*                                                                 08260001
082600             PERFORM EP000-1000-POST-MESSAGE                      08270001
082700         END-IF                                                   08280001
082800         PERFORM 9500-CLOSE-THIRDPTY-AUTH-Q                       08290079
082900         PERFORM 9600-DISCONNECT-FROM-Q-MNGR                      08300001
083000         PERFORM 9999-RETURN-TO-NATIVE-CICS                       08310001
083100     END-IF.                                                      08320001
083200                                                                  08330062
083300     MOVE PV-GET-MESSAGE-BUFFER  TO  SA051-BLKHAWK-FIELDS         08340066
083300                                     PV-AI-AUTH-REQUEST-MESSAGE.  08341066
083200                                                                  08350062
           MOVE SA051-CARD-NBR         TO PV-SEPARATE-CRD               08360039
                                          PV-HD-CARD-NBR.               08380063
           MOVE PV-CRD-NBR             TO GCT00002-CRD-ACCT-NBR         08390050
                                          GCT00004-CRD-ACCT-NBR.        08400050
           MOVE SA051-SLS-DTE          TO GCT00002-SLS-DTE              08410050
                                          PV-HD-SLS-DTE                 08430063
                                          PV-SLS-DTE.                   08440050
           MOVE SA051-STR-NBR          TO GCT00002-STR-NBR              08450050
                                          PV-HD-STR-NBR                 08470063
                                          PV-STR-NBR.                   08480050
           MOVE SA051-RGST-ID          TO GCT00002-RGST-ID              08490050
                                          PV-HD-RGST-ID                 08510063
                                          PV-RGST-ID.                   08520050
           MOVE SA051-TRN-NBR          TO GCT00002-TRN-NBR              08530050
                                          PV-HD-TRN-NBR                 08550063
                                          PV-TRN-NBR.                   08560050
           MOVE SA051-STRT-TM          TO GCT00002-STRT-TM              08570050
                                          PV-HD-STRT-TM                 08590063
                                          PV-STRT-TM.                   08600050
           MOVE SA051-LNE-ITM-SEQ-NBR  TO GCT00002-LNE-ITM-SEQ-NBR      08610050
                                          PV-HD-LNE-ITM-SEQ-NBR         08630063
                                          PV-LNE-ITM-SEQ-NBR.           08640050
           MOVE PV-UPC-NBR             TO GCT00002-UPC-NUMBER.          08650052
           MOVE SA051-CUST-CHRGD-AMT   TO GCT00002-CUST-CHRGD-AMT       08660050
                                          PV-CUST-CHRGD-AMT             08680077
                                          PV-HD-CUST-CHRGD-AMT.         08681077
002600     MOVE SA051-SAF-CDE          TO PV-HD-SAF-CDE.                08690084
083400     MOVE PV-MESSAGE-AREA        TO PV-AI-AUTH-REQUEST-MESSAGE.   08710061
083500                                                                  08720001
084800* -------------------------------------------------------------- *08730001
084900*    CLOSE THE THIRDPTY AUTH QUEUE                                08740079
085000* -------------------------------------------------------------- *08750001
085100 9500-CLOSE-THIRDPTY-AUTH-Q.                                      08760079
085200                                                                  08770001
085300     CALL PC-MQCLOSE USING PV-CONNECT-HANDLE                      08780001
085400                           PV-GETQ-HANDLE                         08790016
085500                           MQCO-NONE                              08800016
085600                           PV-COMPLETION-CODE                     08810016
085700                           PV-REASON.                             08820016
085800     IF (PV-COMPLETION-CODE NOT = MQCC-OK) THEN                   08830001
090300*---------- CONSTRUCT NETCOOL MESSAGE -------------------------*  08831088
090300         STRING                                                   08832088
090300         ' AUKCS517:'            DELIMITED BY SIZE                08833088
090300         ' MQ CLOSE FAILED'      DELIMITED BY SIZE                08834088
090300         ' CALL PAYMENT AND TAX MAINFRAME TEAM'                   08835191
090300                                 DELIMITED BY SIZE                08835291
090300         INTO IS003-SUMMARY                                       08836088
090300         PERFORM 9800-POST-NETCOOL-ALERT                          08837088
090300*---------- CONSTRUCT NETCOOL MESSAGE -------------------------*  08838088
085900         SET PE-MQ-CLOSE TO TRUE                                  08840001
086000         MOVE PV-COMPLETION-CODE TO PV-DISPLAY-COMP-CODE          08850001
086100         MOVE PV-DISPLAY-COMP-CODE TO PE-MQ-COMPLETION-CODE       08860001
086200         MOVE PV-REASON TO PV-DISPLAY-REASON                      08870001
086300         MOVE PV-DISPLAY-REASON TO PE-MQ-REASON-CODE              08880001
086400*                                                                 08890001
086500         MOVE PE-MQ-ERROR-NUMBER TO  EP000-SL-PI-MESSAGE-NUMBER   08900001
086600         SET EP000-SL-ERROR  TO  TRUE                             08910001
086700         MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER                08920001
086800         MOVE PE-MQ-ERROR-MESSAGE TO                              08930001
086900                    EP000-MD-SYSTEM-LOG-MESSAGE                   08940001
087000                    (EP000-MESSAGE-LINE-COUNTER)                  08950001
087100*                                                                 08960001
087200         PERFORM EP000-1000-POST-MESSAGE                          08970001
087300         PERFORM 9600-DISCONNECT-FROM-Q-MNGR                      08980001
087400         PERFORM 9999-RETURN-TO-NATIVE-CICS                       08990001
087500     END-IF.                                                      09000001
087600                                                                  09010001
087700*----------------------------------------------------------------*09020001
087800*  DISCONNECT FROM THE MQ MANAGER                                *09030001
087900*----------------------------------------------------------------*09040001
088000 9600-DISCONNECT-FROM-Q-MNGR.                                     09050001
088100                                                                  09060001
088200*    Disconnect from the queue manager                            09070001
088300                                                                  09080001
088400     IF PV-CONNECT-REASON IS NOT EQUAL TO MQRC-ALREADY-CONNECTED  09090001
088500         CALL PC-MQDISC USING PV-CONNECT-HANDLE                   09100001
088600                              PV-COMPLETION-CODE                  09110001
088700                              PV-REASON                           09120001
088800         IF (PV-COMPLETION-CODE NOT = MQCC-OK) THEN               09130001
088900             SET PE-MQ-DISCONNECT TO TRUE                         09140001
089000             MOVE PV-COMPLETION-CODE TO PV-DISPLAY-COMP-CODE      09150001
089100             MOVE PV-DISPLAY-COMP-CODE TO PE-MQ-COMPLETION-CODE   09160001
089200             MOVE PV-REASON      TO PV-DISPLAY-REASON             09170001
089300             MOVE PV-DISPLAY-REASON TO PE-MQ-REASON-CODE          09180001
089400*                                                                 09190001
089500             MOVE PE-MQ-ERROR-NUMBER TO                           09200001
089600                                     EP000-SL-PI-MESSAGE-NUMBER   09210001
089700             SET EP000-SL-ERROR  TO  TRUE                         09220001
089800             MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER            09230001
089900             MOVE PE-MQ-ERROR-MESSAGE TO                          09240001
090000                        EP000-MD-SYSTEM-LOG-MESSAGE               09250001
090100                        (EP000-MESSAGE-LINE-COUNTER)              09260001
090200             PERFORM EP000-1000-POST-MESSAGE                      09270001
090300             PERFORM 9999-RETURN-TO-NATIVE-CICS                   09280001
090300*---------- CONSTRUCT NETCOOL MESSAGE -------------------------*  09281088
090300             STRING                                               09282088
090300             ' AUKCS517:'            DELIMITED BY SIZE            09282188
090300             ' MQ DISC FAILED'       DELIMITED BY SIZE            09282291
090300             ' CALL PAYMENT AND TAX MAINFRAME TEAM'               09282491
090300                                     DELIMITED BY SIZE            09282591
090300             INTO IS003-SUMMARY                                   09283088
090300             PERFORM 9800-POST-NETCOOL-ALERT                      09284088
090300*---------- CONSTRUCT NETCOOL MESSAGE -------------------------*  09285088
090400         END-IF                                                   09290001
090500     END-IF.                                                      09300001
090600                                                                  09310001
097000***************************************************************** 09940025
097000* SEND NETCOOL MAJOR MESSAGE HERE                                 09950025
097000***************************************************************** 09980025
097000                                                                  09990025
097000 9800-POST-NETCOOL-ALERT.                                         10000090
097000     SET IS003-CICS                                               10080088
097000         IS003-VERSION-1                                          10081088
097000         IS003-PROBLEM-ALERT                                      10082088
097000         IS003-CRITICAL        TO TRUE.                           10083088
097000                                                                  10086088
097000     MOVE 'GC'                 TO IS003-SYSTEM-ID.                10110088
097000                                                                  10120088
097000     IF PV-CICS-REGION = 'CICSPS'                                 10130088
097000       MOVE 'AUTO LAB'         TO IS003-AUTOMATION-LABEL          10140088
097000     ELSE                                                         10150088
097000       MOVE 'CICS TST'         TO IS003-AUTOMATION-LABEL          10160088
097000     END-IF.                                                      10170088
097000                                                                  10180088
097000     CALL IS003-ALERT-PROGRAM                                     10190088
097000         USING DFHEIBLK                                           10200088
097000               IS003-CICS-COMMAREA                                10210088
097000               IS003-NETCOOL-ALERT.                               10220088
097000                                                                  10230088
097000     IF NOT IS003-OK                                              10240088
097000        STRING '!ERROR WRITING NETCOOL ALERT. '                   10250088
097000               'NETCOOL RETURN CODE='                             10260088
097000          IS003-RETURN-CODE DELIMITED BY SIZE                     10270088
097000          INTO PV-CICS-MSG-AREA                                   10280088
097000        END-STRING                                                10290088
097000        PERFORM 9990-WRITE-CICS                                   10300088
097000** FOR TESTING PURPOSES ONLY                                      10340025
097000*    ELSE                                                         10350087
097000*       STRING '!NETCOOL RETURN CODE IS GOOD. '                   10360087
097000*              'NETCOOL RETURN CODE='                             10370087
097000*         IS003-RETURN-CODE DELIMITED BY SIZE                     10380087
097000*         INTO IS003-SUMMARY                                      10390087
097000*       END-STRING                                                10400087
097000*       STRING '!IS003-MESSAGE='                                  10410087
097000*         IS003-MESSAGE DELIMITED BY SIZE                         10420087
097000*         INTO IS003-SUMMARY                                      10430087
097000*       END-STRING                                                10440087
097000     END-IF.                                                      10450088
097000*                                                                 10460087
097000*** WRITE ALL NETCOOL MESSAGES TO THE CICS LOG                    10470025
097000*** IF NOT IN PRODUCTION, ONLY WRITE NETCOOL MESSAGES             10480025
097000*** TO THE CICS LOG, NOT TO NETCOOL                               10490025
097000     MOVE IS003-SUMMARY       TO PE-IS003-SUMMARY.                10500088
097000     MOVE PE-NETCOOL-ALERT-TO-BE-WRITTEN TO IS003-SUMMARY.        10510088
097000                                                                  10520088
097000* PERFORM A COMMIT TO GET NETCOOL ALERT WRITTEN.                  10530025
097000                                                                  10540088
097000     EXEC CICS                                                    10550088
097000         SYNCPOINT                                                10560088
097000     END-EXEC.                                                    10570088
097000                                                                  10571088
097000*-----------------------------------------------------------------10580088
097000*  WRITE TO CSSL                                                  10581088
097000*-----------------------------------------------------------------10581188
097000 9990-WRITE-CICS.                                                 10581288
097000                                                                  10581388
097000     EXEC CICS                                                    10581488
097000         WRITEQ TD                                                10582088
097000         QUEUE('CSSL')                                            10583088
097000         FROM(PV-CICS-MSG-AREA)                                   10584088
097000         RESP(PV-CICS-RESPONSE)                                   10585088
097000     END-EXEC.                                                    10586088
097000                                                                  10587088
097000     MOVE SPACES TO PV-CICS-MSG-AREA.                             10587188
097000                                                                  10587288
097100*----------------------------------------------------------------*10590025
097200*    TERMINATE THE TASK.                                          10600001
097300*----------------------------------------------------------------*10610001
097400 9999-RETURN-TO-NATIVE-CICS.                                      10620001
097500                                                                  10630001
097600     EXEC CICS                                                    10640001
097700         RETURN                                                   10650001
097800     END-EXEC.                                                    10660001
097900                                                                  10670001
098000*                                                                 10680001
098100*----------------------------------------------------------------*10690001
098200*  LOG ALERT/ERROR ROUTINE.                                       10700001
098300*                                                                 10710001
098400     COPY EPPD000.                                                10720001
098500                                                                  10730001
