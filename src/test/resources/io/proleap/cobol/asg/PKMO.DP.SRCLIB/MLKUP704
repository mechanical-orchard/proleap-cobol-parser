000100 IDENTIFICATION DIVISION.                                         00010000
000200                                                                  00020000
000300 PROGRAM-ID.    MLKUP704                                          00030000
000400 AUTHOR.        BOB & DAVE (CROC MEN).                            00040000
000500 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00050000
000600 DATE-WRITTEN.  6-07-99.                                          00060001
000700 DATE-COMPILED.                                                   00070000
000800                                                                  00080000
000900******************************************************************00090000
001000* MLKUP704 - M/L RECALC MONTH-TO-DATE DEPT, ENT-ID LEVEL (TVADPT) 00100000
001100******************************************************************00110000
001200*  THIS PROGRAM WILL RECALCULATE THE FOLLOWING FIELDS ON TVADPT  *00120001
001300*    SHNK_RTL_AMT     - RETAIL SHRINK                            *00130000
001400*    END_INV_RTL_AMT  - RETAIL ENDING INVENTORY                  *00140000
001500*    CUM_MKUP_PCT     - CUM-TO-DATE MARKUP PERCENT               *00150000
001600*    END_INV_COST_AMT - COST ENDING INVENTORY                    *00160000
001700*    SLS_COST_AMT     - COST AS A BASIS OF SALES                 *00170000
001800*    GRO_MRGN_AMT     - GROSS MARGIN DOLLAR AMOUNT               *00180000
001900******************************************************************00190000
002000* THIS PROGRAM WILL OPEN A CURSOR FOR PROCESSING ALL OF THE      *00200000
002000*   DATES BETWEEN THE OPEN FISCAL MONTH END DATE AND MAX DATE    *00201000
002000*   WHICH IS THE DRIVER OF THE PROGRAM.                          *00202000
002100* FOR EACH DATE, ALL THE DEPT, ENT-ID'S ARE PROCESSED AND THE    *00203001
002200*   DATA IS RECALCULATED FOR EACH ENT-ID WITHIN EACH DEPT.       *00204002
002500* FSCL_MN_END_DTE IS BETWEEN THE OPN_FSCL_MN_DTE AND THE MXPSTG_ *00205001
002600* FSCL_MN_DTE, OR IF IT IS IN THE PRIOR FISCAL MONTH AND HAS END-*00206000
002700* INVENTORY COST OR RETAIL <> 0.                                 *00207000
002800*   AN ADDITIONAL CUSOR IS BUILT TO DETERMINE THE NUMBER OF      *00208000
002900* ENT-IDS WITHIN A DEPT.  THIS IS USED WHEN PRORATING THE        *00209001
003000* SHRINK RETAIL AMOUNT.  IF THE TOTAL AMOUNT OF SHRINK FOR A     *00210000
003100* DEPT NUMBER IS NOT EQUAL TO THE SHRINK IN THE DPT TABLE, THE   *00220001
003200* DIFFERENCE IS ADDED/SUBTRACTED TO THE LAST ENT-ID OF A DEPT.   *00230001
003300*     IF THERE IS ACTIVITY FOR THE CURRENT OPEN MONTH, THEN THE  *00240000
003400* ROW IS ALWAYS TO BE RECALCED. IF THERE IS NO CURRENT ACTIVITY, *00250000
003500* (IE. ALL DOLLAR VALUES FOR OPEN-FSCL-MN-DTE = 0), BUT THERE IS *00260000
003600* ENDING-INVENTORY DOLLARS PRESENT FROM THE PREVIOUS MONTH-END - *00270000
003700* THEN A NEW ROW IS INSERTED THAT CARRIES FORWARD ONLY INVENTORY *00280000
003800* BALANCES FROM THE PRIOR MONTH. IF THERE IS NO CURRENT DOLLARS  *00290000
003900* FOR THE CURRENT OPEN MONTH, AS WELL AS, NO PREVIOUS END-INV    *00300000
004000* DOLLARS FROM THE PRIOR MONTH, A NEW ROW WILL NOT BE INSERTED.  *00310000
004100*                                                                 00320000
004200* THIS PGM WILL USE CHECKPOINT RESTART LOGIC TO DETERMINE IF AND *00330000
004300* WHEN A CHECKPOINT IS TO BE TAKEN. A CHECKPOINT/COMMIT WILL     *00340000
004300* BE TAKEN WHEN EVER THERE IS A DEPT NUMBER CHANGE OR AT THE END *00350000
004400* OF THE ENT-ID CURSOR.                                           00360000
004500* CONDITIONS ....                                                *00370000
004600* NORMAL START - INITAL CURSOR WILL SELECT ALL DATES WITHIN THE  *00380000
004700*   DATE RANGE SPECIFIED.  A COMMIT IS ONLY TAKE AFTER A ENTIRE  *00390000
004800*   DEPT HAS BEEN RECALCED FOR A SPECIFIC DATE.                  *00400000
004900* RESTART - SELECT CHECKPOINT RESTART KEY FROM TCKRSTINF, USE    *00410000
005000*   DATE AND DEPT NBR TO DETERMINE WHICH ROWS SHOULD BE RECALCED *00420000
005100*   WHICH IS ALL ROWS >= TO LAST COMMITED DATE AND DEPT NUMBER.  *00430000
005200******************************************************************00440000
005300*                        CHANGE LOG                              *00450000
005400*  CHANGE ID    CHANGE DATE            REASON FOR CHANGE         *00460000
C30235* 08/05/12 - COGNIZANT        -  INC # CRQ000000030235            00461013
C30235*    - RECOMPILING THE PROGRAM.                                   00462013
005500******************************************************************00470000
005600                                                                  00480000
005700 ENVIRONMENT DIVISION.                                            00490000
005800                                                                  00500000
005900 CONFIGURATION SECTION.                                           00510000
006000 SOURCE-COMPUTER.        IBM-3090.                                00520000
006100 OBJECT-COMPUTER.        IBM-3090.                                00530000
006200 INPUT-OUTPUT SECTION.                                            00540000
006300 FILE-CONTROL.                                                    00550000
006400**                                                                00560000
006500*                                                                 00570000
006600 DATA DIVISION.                                                   00580000
006700 FILE SECTION.                                                    00590000
006800**                                                                00600000
006900*                                                                 00610000
007000 WORKING-STORAGE SECTION.                                         00620000
007100                                                                  00630000
007200 01  ABEND-CODE                  PIC S9(04)  VALUE ZERO COMP SYNC.00640000
007300                                                                  00650000
007400 01  PA-PROGRAM-ACCUMULATORS.                                     00660000
007500     05  PA-COMMIT-COUNT                 PIC  9(09) VALUE ZEROES. 00670000
007600     05  PA-DEPT-COUNT                   PIC  9(09) VALUE ZEROES. 00680001
007700     05  PA-DATE-COUNT                   PIC  9(09) VALUE ZEROES. 00690000
007800     05  PA-INSERT-COUNT                 PIC  9(09) VALUE ZEROES. 00700000
007900     05  PA-UPDATE-COUNT                 PIC  9(09) VALUE ZEROES. 00710000
008000                                                                  00720000
008100 01  PS-PROGRAM-SWITCHES.                                         00730000
008200     05  PS-FIRST-COMMIT-SW              PIC X     VALUE 'N'.     00740000
008300         88  PS-FIRST-COMMIT                       VALUE 'Y'.     00750000
008400     05  PS-ENT-ID-CURSOR-SW             PIC X     VALUE 'N'.     00760001
008500         88  PS-END-OF-ENT-ID-CURSOR               VALUE 'Y'.     00770000
008600         88  PS-NOT-END-OF-ENT-ID-CURSOR           VALUE 'N'.     00780000
008700     05  PS-CURR-MONTH-SW                PIC X     VALUE 'N'.     00790000
008800         88  PS-CURR-MONTH-ROW-FOUND               VALUE 'Y'.     00800000
008900         88  PS-CURR-MONTH-ROW-NOT-FOUND           VALUE 'N'.     00810000
009000     05  PS-PREV-MONTH-ROW-SW            PIC X     VALUE 'N'.     00820000
009100         88  PS-PREV-MONTH-ROW-FOUND               VALUE 'Y'.     00830000
009200         88  PS-PREV-MONTH-ROW-NOT-FOUND           VALUE 'N'.     00840000
009300     05  PS-PREV-SEASON-INV-SW           PIC X     VALUE 'N'.     00850000
009400         88  PS-NO-PREV-SEASONAL-INV               VALUE 'Y'.     00860000
009500     05  PS-CURR-SEASON-CURSOR-SW        PIC X     VALUE 'N'.     00870000
009600         88  PS-END-OF-CURR-SEASON-CSR             VALUE 'Y'.     00880000
009700     05  PS-CURRENT-PURCH-COST-SW        PIC X     VALUE 'N'.     00890000
009800         88  PS-NO-CURRENT-PURCH-COSTS             VALUE 'Y'.     00900000
009900     05  PS-RESULT-TABLE-SW              PIC X     VALUE 'N'.     00910000
010000         88  PS-EMPTY-RESULT-TABLE                 VALUE 'Y'.     00920000
010100     05  PS-END-OF-FISCAL-DATE-CSR-SW    PIC X     VALUE 'N'.     00930000
010200         88  PS-END-OF-FISCAL-DATE-CSR             VALUE 'Y'.     00940000
010300                                                                  00950000
010400 01  PC-PROGRAM-CONSTANTS.                                        00960000
010500     05  PC-JOB-NAME             PIC  X(06)    VALUE 'MLK420'.    00970003
010600     05  PC-PROGRAM-NAME         PIC  X(08)    VALUE 'MLKUP704'.  00980000
010700                                                                  00990000
010800 01  PE-PROGRAM-ERROR-MESSAGES.                                   01000000
010900     05  PE-MSG-01                       PIC X(30) VALUE          01010000
011000          'INSPECT WHERE CLAUSE VARIABLE'.                        01020000
011100     05  PE-MSG-02                       PIC X(30) VALUE          01030000
011200          'DB2 SELECT ATTEMPTED         '.                        01040000
011300     05  PE-MSG-03                       PIC X(30) VALUE          01050000
011400          'ATTEMPTING TO OPEN DB2 CURSOR'.                        01060000
011500     05  PE-MSG-04                       PIC X(30) VALUE          01070000
011600          'ATTEMPT TO FETCH CURSOR ROW  '.                        01080000
011700     05  PE-MSG-05                       PIC X(30) VALUE          01090000
011800          'ATTEMPT TO CLOSE DB2 CURSOR  '.                        01100000
011900     05  PE-MSG-06                       PIC X(30) VALUE          01110000
012000          'ERROR ON UPDATE OF TVADPT    '.                        01120001
012100     05  PE-MSG-07                       PIC X(30) VALUE          01130000
012200          'ERROR IN SELECT - TCKRSTCNTL '.                        01140000
012300     05  PE-MSG-08                       PIC X(30) VALUE          01150000
012400          'UPDATE WORK_STRG - TCKRSTINF '.                        01160000
012500     05  PE-MSG-09                       PIC X(30) VALUE          01170000
012600          'PGM ABEND DURING A COMMIT    '.                        01180000
012700     05  PE-MSG-10                       PIC X(30) VALUE          01190000
012800          'UPDATE OF TCKRSTCNTL FAILED  '.                        01200000
012900     05  PE-MSG-11                       PIC X(30) VALUE          01210000
013000          'ERROR IN SELECT - TCKRSTINF  '.                        01220000
013100     05  PE-MSG-13                       PIC X(30) VALUE          01230000
013200          'SHRINK NOT FND FOR DEPT/DATE '.                        01240000
013300     05  PE-MSG-14                       PIC X(30) VALUE          01250000
013400          'ERROR ON ''INSERT'' TO TVADPT'.                        01260001
013500     05  PE-MSG-16                       PIC X(30) VALUE          01270000
013600          'ERROR SELECTING COUNT OF ROWS.'.                       01280000
013700*                                                                 01290000
013800 01  PROGRAM-VARIABLES.                                           01300000
013900     05  PV-TVADPT-UPDATE-VARIABLES.                              01310001
014000* THESE VARIABLES WILL UPDATE CURRENT TVADPT ROW *****************01320001
014100         10  PV-SHNK-RTL-AMT             PIC  S9(11)V9(2) COMP-3. 01330000
014200         10  PV-END-INV-RTL-AMT          PIC  S9(11)V9(2) COMP-3. 01340000
014300         10  PV-CUM-MKUP-PCT             PIC  S9(4)V9(7)  COMP-3. 01350000
014400         10  PV-END-INV-COST-AMT         PIC  S9(11)V9(2) COMP-3. 01360000
014500         10  PV-SLS-COST-AMT             PIC  S9(11)V9(2) COMP-3. 01370000
014600         10  PV-GRO-MRGN-AMT             PIC  S9(11)V9(2) COMP-3. 01380000
014700******************************************************************01390000
014800     05  PV-SEASON-TO-DATE-CSR-VAR.                               01400000
014900         10  PV-VADPT-RCPT-RTL-AMT       PIC  S9(11)V9(2) COMP-3. 01410001
015000         10  PV-VADPT-RCPT-NET-COST-AMT  PIC  S9(11)V9(2) COMP-3. 01420001
015100         10  PV-VADPT-PADJ-RTL-AMT       PIC  S9(11)V9(2) COMP-3. 01430001
015200         10  PV-VADPT-PADJ-NET-COST-AMT  PIC  S9(11)V9(2) COMP-3. 01440001
015300         10  PV-VADPT-MKUP-RTL-AMT       PIC  S9(11)V9(2) COMP-3. 01450001
015400         10  PV-VADPT-XFER-NET-AMT       PIC  S9(11)V9(2) COMP-3. 01460001
015500     05  PV-CURR-MONTH-COST-VAR.                                  01470000
015600         10  PV-CURR-MONTH-RCPT-NET-COST PIC  S9(11)V9(2) COMP-3. 01480000
015700         10  PV-CURR-MONTH-PADJ-NET-COST PIC  S9(11)V9(2) COMP-3. 01490000
015800     05  PV-PREV-MONTH-VAR.                                       01500000
015900         10  PV-PREV-MONTH-END-INV-RTL   PIC  S9(11)V9(2) COMP-3. 01510000
016000         10  PV-PREV-MONTH-END-INV-COST  PIC  S9(11)V9(2) COMP-3. 01520000
016100     05  PV-PREV-SEASON-VAR.                                      01530000
016200         10  PV-PREV-SEASON-END-INV-RTL  PIC  S9(11)V9(2) COMP-3. 01540000
016300         10  PV-PREV-SEASON-END-INV-COST PIC  S9(11)V9(2) COMP-3. 01550000
016400     05  PV-CUM-TO-DATE-VARIABLES.                                01560000
016500         10  PV-CUM-TO-DATE-PURCH-RETAIL PIC  S9(11)V9(2) COMP-3. 01570000
016600         10  PV-CUM-TO-DATE-PURCH-COST   PIC  S9(11)V9(2) COMP-3. 01580000
016700         10  PV-CUM-SEASON-MKUP          PIC  S9(11)V9(2) COMP-3. 01590000
016800*                                                                 01600000
016900 01  PV-VARIABLE-FIELDS.                                          01610000
016901     05  PV-SALES-NULL-IND               PIC S9(04) VALUE ZEROS   01620000
016910                                                    COMP.         01630000
017000     05  PV-COMMIT-DEPT                  PIC  X(03) VALUE SPACES. 01640000
017100     05  PV-HOLD-DEPT-NBR                PIC  X(03) VALUE SPACES. 01650000
017300     05  PV-PARAGRAPH-NAME               PIC  X(30) VALUE SPACES. 01670000
017400     05  PV-ABEND-MESSAGE                PIC  X(75) VALUE SPACES. 01680000
017500     05  PV-OPERATION-ATTEMPTED          PIC  X(30) VALUE SPACES. 01690000
017600     05  PV-XFER-NET                     PIC  S9(11)V99 COMP-3    01690100
017610                                                       VALUE +0.  01690200
017700     05  PV-DPT-SHNK-DIFF                PIC  S9(11)V99 COMP-3    01690301
017800                                                       VALUE +0.  01690400
017900     05  PV-ENT-ID-SALES-AMT      PIC S9(11)V99 COMP-3 VALUE +0.  01690500
018000     05  PV-ENT-ID-MKDN-AMT       PIC S9(11)V99 COMP-3 VALUE +0.  01690600
018100     05  PV-VADPT-SHNK-RTL-AMT    PIC S9(11)V99 COMP-3 VALUE +0.  01690701
018200     05  PV-DPT-SALES-AMT         PIC S9(11)V99 COMP-3 VALUE +0.  01690801
018300     05  PV-MNDPT-SHNK-RTL-AMT    PIC S9(11)V99 COMP-3 VALUE +0.  01690901
018400     05  PV-ENT-ID-PCT-SALES      PIC S9(04)V9(07)                01691000
018500                                                COMP-3 VALUE +0.  01692000
018600     05  PV-ENT-ID-COUNT          PIC  S9(04)   COMP-3 VALUE +0.  01693000
018700     05  PV-ENT-ID-PROCESS-COUNT  PIC  S9(04)   COMP-3 VALUE +0.  01694000
018800                                                                  01695000
019500*****************************************************             01720001
019600*  MONTHLY DEPT, ENT-ID TABLE - CONTAINS SHRINK AMT *             01730001
019700*****************************************************             01740001
019800     EXEC SQL                                                     01750000
019900         INCLUDE TMNDPT                                           01760001
020000     END-EXEC.                                                    01770000
020100****************************************************              01780000
020200*  COMMUNICATION AREAS FOR DB2                     *              01790000
020300****************************************************              01800000
020400     EXEC SQL                                                     01810000
020500         INCLUDE SQLCA                                            01820000
020600     END-EXEC.                                                    01830000
020700****************************************************              01840000
020800*  M/L MONTH-TO-DATE DEPARTMENT TABLE              *              01850000
020900****************************************************              01860000
021000     EXEC SQL                                                     01870000
021100         INCLUDE TVADPT                                           01880001
021200     END-EXEC.                                                    01890000
                                                                        01891007
021300****************************************************              01900000
021400* M/L DATE TABLE                                   *              01910007
021500****************************************************              01920000
021600     EXEC SQL                                                     01930000
021700         INCLUDE TDTATTR                                          01940000
021800     END-EXEC.                                                    01950000
021900                                                                  01960000
021300****************************************************              01961007
021400* M/L CONTROL  TABLE                               *              01962007
021500****************************************************              01963007
022000     EXEC SQL                                                     01970007
022100         INCLUDE TMLCNTL                                          01980007
022200     END-EXEC.                                                    01990007
026200                                                                  02390000
026300****************************************************              02400000
026400*CHECKPOINT RESTART CONTROL AND INFORMATION TABLES *              02410000
026500****************************************************              02420000
026600     EXEC SQL                                                     02430000
026700         INCLUDE TCKRSTCN                                         02440000
026800     END-EXEC.                                                    02450000
026900*                                                                 02460000
027000     EXEC SQL                                                     02470000
027100         INCLUDE TCKRSTIN                                         02480000
027200     END-EXEC.                                                    02490000
027300     EXEC SQL                                                     02500000
027400         DECLARE ENT_ID_CSR CURSOR FOR                            02510000
027500          SELECT  DISTINCT DEPT_NBR, ENT_ID                       02520001
027600           FROM TVADPT                                            02530001
027700            WHERE DEPT_NBR       >= :VADPT-DEPT-NBR               02540001
027800            AND ((FSCL_MN_END_DTE = :MLCNTL-OPN-FSCL-MN-DTE)      02550000
028100            OR  (FSCL_MN_END_DTE  = :DTATTR-PFM-END-DTE           02560000
028200            AND (END_INV_RTL_AMT  <> 0 OR                         02570000
028300                 END_INV_COST_AMT <> 0)))                         02580000
028400           ORDER BY DEPT_NBR, ENT_ID                              02590001
028500           FOR FETCH ONLY                                         02600000
028600     END-EXEC.                                                    02610000
028700                                                                  02620000
028800*                                                                 02630000
028900* MAX (6) ROWS FOR EACH DEPT (MONTHS PER SEASON) - CUM SEASON $   02640000
029000     EXEC SQL                                                     02650000
029100         DECLARE SEASON_TO_DATE_CSR CURSOR FOR                    02660000
029200          SELECT  XFER_IN_RTL_AMT                                 02670000
029300                 ,XFER_OUT_RTL_AMT                                02680000
029400                 ,RCPT_RTL_AMT                                    02690000
029500                 ,RCPT_NET_COST_AMT                               02700000
029600                 ,PADJ_RTL_AMT                                    02710000
029700                 ,PADJ_NET_COST_AMT                               02720000
029800                 ,MKUP_RTL_AMT                                    02730000
029900            FROM  TVADPT                                          02740001
030000           WHERE  DEPT_NBR   = :VADPT-DEPT-NBR                    02750001
030200             AND  ENT_ID     = :VADPT-ENT-ID                      02770001
030300             AND (FSCL_MN_END_DTE >= :DTATTR-SEA-BEG-DTE          02780000
030400             AND  FSCL_MN_END_DTE <= :DTATTR-FSCL-MN-END-DTE)     02790000
030500           FOR FETCH ONLY                                         02800000
030600     END-EXEC.                                                    02810000
030700                                                                  02820000
030800*                                                                 02830000
030900* MONTHS TO BE PROCESSED - ALL DATES BETWEEN OPEN AND MAX DATES   02840000
031000     EXEC SQL                                                     02850000
031100         DECLARE FISCAL_DATE_CSR CURSOR FOR                       02860000
031200          SELECT  DISTINCT                                        02870000
031300                  FSCL_MN_END_DTE                                 02880000
031400                 ,CAL_MN_NBR                                      02890000
031500                 ,PFM_END_DTE                                     02900000
031600                 ,SEA_BEG_DTE                                     02910000
031700                 ,PREV_SEA_END_DTE                                02920000
031800                 ,FSCL_MN_NBR                                     02930000
031900                 ,FSCL_YR_NBR                                     02940000
032000            FROM  TDTATTR                                         02950000
032100           WHERE FSCL_MN_END_DTE BETWEEN                          02960000
032200                                      :MLCNTL-OPN-FSCL-MN-DTE     02970000
032300                                  AND :MLCNTL-MXPSTG-FSCL-MN-DTE  02980000
032400           ORDER BY FSCL_MN_END_DTE                               02990000
032500           FOR FETCH ONLY                                         03000000
032600     END-EXEC.                                                    03010000
032700*                                                                 03020000
032800******************************************************************03030000
032900* CHECKPOINT RESTART VARIABLES                                   *03040000
033000******************************************************************03050000
033100 01  CR-CHECKPOINT-RESTART-AREA.                                  03060000
033200     05  CR-AREA-LEN                  PIC S9(04) VALUE +67  COMP. 03070000
033300     05  CR-CHECKPOINT-RESTART-VAR.                               03080000
033400         10  CR-PREV-DTL-KEY.                                     03090000
033500             15  CR-FISCAL-MN-END-DTE PIC  X(10).                 03100000
033600             15  FILLER               PIC  X(01).                 03110000
033700             15  CR-FISCAL-MN-NBR     PIC  X(02).                 03120000
033800             15  FILLER               PIC  X(01).                 03130000
033900             15  CR-DEPT-NBR          PIC  X(03).                 03140000
034000         10  FILLER                   PIC  X(01) VALUE SPACES.    03150000
034100         10  CR-TVADPT-FETCH-COUNT    PIC  9(09) VALUE ZEROES.    03160001
034200         10  FILLER                   PIC  X(01) VALUE SPACES.    03170000
034300         10  CR-TVADPT-UPDATE-COUNT   PIC  9(09) VALUE ZEROES.    03180001
034400         10  FILLER                   PIC  X(01) VALUE SPACES.    03190000
034500         10  CR-TVADPT-INSERT-COUNT   PIC  9(09) VALUE ZEROES.    03200001
034600         10  FILLER                   PIC  X(01) VALUE SPACES.    03210000
034700         10  CR-TVADPT-COMMIT-COUNT   PIC  9(09) VALUE ZEROES.    03220001
034800     EJECT                                                        03230000
034900*                                                                 03240000
035000****************************************************              03250000
035100*  ERROR MESSAGE AREA FOR DB2                      *              03260000
035200****************************************************              03270000
035300     COPY DPWS004.                                                03280000
035400*                                                                 03290000
035500*-------------------*                                             03300000
035600 PROCEDURE DIVISION.                                              03310000
035700*-------------------*                                             03320000
035800                                                                  03330000
035900 0000-MAIN-MODULE.                                                03340000
036000                                                                  03350000
036100     PERFORM 1000-INITIALIZATION.                                 03360000
036200                                                                  03370000
036300     PERFORM 2000-PROCESS-INPUT                                   03380000
036400         UNTIL PS-END-OF-FISCAL-DATE-CSR.                         03390000
036500                                                                  03400000
036600     PERFORM 8000-EOJ-ROUTINE.                                    03410000
036700                                                                  03420000
036800     STOP RUN.                                                    03430000
036900*                                                                 03440000
037000*                                                                 03450000
037100******************************************************************03460000
037200* 1000-INITIALIZATION.                                            03470000
037300* LOAD TABLE WITH MONTHS TO BE RECALCULATED - OPN_MN THRU MXPSTG  03480000
037400* DETERMINE IF THIS IS A 'RESTART' (TCKRSTINF-CKPT-STAT-CODE = 9) 03490000
037500******************************************************************03500000
037600 1000-INITIALIZATION.                                             03510000
037700                                                                  03520000
037800     PERFORM 7000-SELECT-CNTL-TBL-ROW.                            03530000
037900     PERFORM 7650-INIT-CHECKPOINT-SELECT.                         03540000
038000                                                                  03550000
038100     IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                           03560000
038200         PERFORM 7700-SELECT-RESTART-INFO                         03570000
038300         MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO                    03580000
038400                                       CR-CHECKPOINT-RESTART-VAR  03590000
038500         DISPLAY 'RESTART-LAST DATE COMMIT: ' CR-FISCAL-MN-END-DTE03600000
038510         DISPLAY 'RESTART-LAST DEPT COMMIT: ' CR-DEPT-NBR         03610000
038600         MOVE CR-FISCAL-MN-END-DTE       TO MLCNTL-OPN-FSCL-MN-DTE03620000
038700         PERFORM 7050-OPEN-DATE-CURSOR                            03630000
038800         PERFORM 7075-FETCH-DATE-CURSOR                           03640000
038900         MOVE CR-DEPT-NBR                TO VADPT-DEPT-NBR        03650001
039000     ELSE                                                         03660000
039100         SET PS-FIRST-COMMIT TO TRUE                              03670000
039200         INITIALIZE CR-CHECKPOINT-RESTART-VAR                     03680000
039300         DISPLAY 'COMMITS WILL BE TAKEN AFTER A CHG IN DEPT.'     03690000
039400         PERFORM 7050-OPEN-DATE-CURSOR                            03700000
039500         PERFORM 7075-FETCH-DATE-CURSOR                           03710000
039600         MOVE MLCNTL-OPN-FSCL-MN-DTE TO  DTATTR-FSCL-MN-END-DTE   03720000
039700     END-IF.                                                      03730000
039800                                                                  03740000
039900     INITIALIZE PA-PROGRAM-ACCUMULATORS.                          03750000
040000                                                                  03760000
040100     IF  PS-END-OF-ENT-ID-CURSOR                                  03770000
040200         IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                       03780000
040300             DISPLAY 'NO RECORDS TO PROCESSED AFTER RESTART'      03790000
040400             SET PS-EMPTY-RESULT-TABLE TO TRUE                    03800000
040500         ELSE                                                     03810000
040600             IF TCKRSTCNTL-CKPT-STAT-CODE = '0'                   03820000
040700                 DISPLAY 'NO ROWS SELECTED FOR RECALCULATION'     03830000
040800                 SET PS-EMPTY-RESULT-TABLE TO TRUE                03840000
040900             END-IF                                               03850000
041000         END-IF                                                   03860000
041400     END-IF.                                                      03900000
041500*                                                                 03910000
041600*                                                                 03920000
041700******************************************************************03930000
041800* MAIN PROCESSING PARAGRAPH-PERFORMED UNTIL END OF CSR PROCESSING 03940000
041900* WHEN PV-SUB1 > PV-MAX-SUB - THEN ALL DATES FOR THIS DEPT        03950001
042000*                 HAVE BEEN PROCESSED, CHECK IF COMMIT REQUIRED.  03960000
042100******************************************************************03970000
042200 2000-PROCESS-INPUT.                                              03980000
042300                                                                  03990000
042400     ADD 1      TO PA-DATE-COUNT.                                 04000000
042410                                                                  04010000
042500     SET PS-NOT-END-OF-ENT-ID-CURSOR TO TRUE.                     04020000
042600     PERFORM 7149-OPEN-ENT-ID-CURSOR.                             04030000
042700     PERFORM 7150-FETCH-ENT-ID-CURSOR.                            04040000
042710                                                                  04050000
042800     MOVE VADPT-DEPT-NBR   TO PV-COMMIT-DEPT.                     04060001
042900                                                                  04070000
043000     PERFORM 2025-PROCESS-ENT-IDS                                 04080000
043100          UNTIL PS-END-OF-ENT-ID-CURSOR.                          04090000
043200                                                                  04100000
043300     PERFORM 7075-FETCH-DATE-CURSOR.                              04110000
043400     MOVE DTATTR-FSCL-MN-END-DTE TO MLCNTL-OPN-FSCL-MN-DTE.       04120000
043500                                                                  04130000
043600******************************************************************04140000
043700* DEPT LEVEL PROCESSING PARAGRAPH                                 04150000
043800* PROCESS ALL DATES FOR THIS DEPARTMENT                           04160000
043900******************************************************************04170000
044000 2025-PROCESS-ENT-IDS.                                            04180000
044100                                                                  04190000
044200     ADD 1 TO PV-ENT-ID-PROCESS-COUNT                             04200000
044300              PA-DEPT-COUNT.                                      04210001
044400     INITIALIZE  PROGRAM-VARIABLES.                               04220000
044500     MOVE 'N' TO PS-CURR-MONTH-SW                                 04230000
044600                 PS-PREV-MONTH-ROW-SW.                            04240000
044700                                                                  04250000
044800***  DETERMINE IF CURRENT DOLLARS AND/OR PRIOR INVENTORY DOLLARS  04260000
045020     PERFORM 7350-SELECT-PREV-MONTH-END-INV.                      04270000
045030     PERFORM 7300-SELECT-CURRENT-DOLLARS.                         04280000
045100                                                                  04290000
045200******************************************************************04300000
045300*****                CARRY FORWARD LOGIC                     *****04310000
045400******************************************************************04320000
045500*    CURRENT $ FOUND FOR THIS MONTH  - RECALC ROW                *04330000
045600* NO CURRENT $ FOUND/NO PREV $ FOUND - BYPASS RECALC THIS MONTH  *04340000
045700* NO CURRENT $ FOUND/   PREV $ FOUND - CARRY FORWARD INVENTORY $ *04350000
045800******************************************************************04360000
045900     IF PS-CURR-MONTH-ROW-FOUND                                   04370000
046000         PERFORM 2035-RECALC-PROCESSING                           04380000
052081         PERFORM 7500-UPDATE-PROCESSING                           04390000
052082     ELSE                                                         04400000
052083         IF PS-PREV-MONTH-ROW-FOUND                               04410000
052086            PERFORM 2030-INITIALIZE-DCLGEN-FIELDS                 04420000
052108            PERFORM 2035-RECALC-PROCESSING                        04430000
052109            PERFORM 7510-INSERT-CARRY-FWD-ROW                     04440000
052110         END-IF                                                   04450000
052111     END-IF.                                                      04460000
052112                                                                  04470000
052113     PERFORM 7150-FETCH-ENT-ID-CURSOR.                            04480000
052114                                                                  04490000
052115***  PERFORM COMMIT WHEN DEPT CHANGES OR END OF ENT-ID CSR        04500000
052116     IF VADPT-DEPT-NBR NOT = PV-COMMIT-DEPT OR                    04510001
052117        PS-END-OF-ENT-ID-CURSOR                                   04520000
052118        PERFORM 7800-COMMIT-PROCESSING                            04530000
052119        MOVE VADPT-DEPT-NBR   TO PV-COMMIT-DEPT                   04540001
052120     END-IF.                                                      04550000
052121*                                                                 04560000
052122*                                                                 04570000
052123******************************************************************04580000
052125*  INITIALIZE THE TVADPT DGLGEN FIELDS USED FOR RECALC WHEN      *04590001
052126*  CARRYING FORWARD PREV MONTTH ENDING INVENTORY RETAIL AND COST *04600000
052127******************************************************************04610000
052128 2030-INITIALIZE-DCLGEN-FIELDS.                                   04620000
052129                                                                  04630000
052130     MOVE ZEROS       TO VADPT-SLS-REG-RTL-AMT                    04640001
052131                         VADPT-SLS-PROMO-RTL-AMT                  04650001
052132                         VADPT-SLS-PROCLR-RTL-AMT                 04660001
052133                         VADPT-SLS-CLR-RTL-AMT                    04670001
052134                         VADPT-SLS-OTH-RTL-AMT                    04680001
052135                         VADPT-MKDN-PLU-RTL-AMT                   04690001
052136                         VADPT-MKDN-RGST-RTL-AMT                  04700001
052137                         VADPT-MKDN-UMTCH-RTL-AMT                 04710001
052138                         VADPT-MKDN-BYR-RTL-AMT                   04720001
052139                         VADPT-MKDN-STR-RTL-AMT                   04730001
052140                         VADPT-MKUP-RTL-AMT                       04740001
052141                         VADPT-XFER-IN-RTL-AMT                    04750001
052142                         VADPT-XFER-OUT-RTL-AMT                   04760001
052143                         VADPT-RCPT-RTL-AMT                       04770001
052144                         VADPT-RCPT-NET-COST-AMT                  04780001
052145                         VADPT-RCPT-GRO-COST-AMT                  04790001
052146                         VADPT-PADJ-FRGT-COST-AMT                 04800001
052147                         VADPT-PADJ-DISC-COST-AMT                 04810001
052148                         VADPT-PADJ-RTL-AMT                       04820001
052149                         VADPT-PADJ-NET-COST-AMT                  04830001
052150                         VADPT-INV-ADJ-RTL-AMT.                   04840001
052151*                                                                 04850000
052152*                                                                 04860000
052153******************************************************************04870000
052154*                                                                *04880000
052155*            ********* RECALC PROCESSING **********              *04890000
052156*                                                                *04900000
052157******************************************************************04910000
052158 2035-RECALC-PROCESSING.                                          04920000
052159                                                                  04930000
052160***  GET THE # OF ENT-IDS W/I A DEPT WHEN CHANGE OCCURS           04940001
052161     IF VADPT-DEPT-NBR    = PV-HOLD-DEPT-NBR                      04950001
052163         CONTINUE                                                 04970000
052164     ELSE                                                         04980000
052165         PERFORM 7155-GET-ENT-ID-COUNT                            04990000
052166         PERFORM 7200-OBTAIN-SHRINK-DLRS                          05000000
052167***  RESET ENT ID PROCESS COUNT FOR DEPT AND CLEAR                05010001
052168***  DEPT SHRINK ACCUMULATOR                                      05020001
052169         MOVE 1                        TO PV-ENT-ID-PROCESS-COUNT 05030000
052170         MOVE 0                        TO PV-VADPT-SHNK-RTL-AMT   05040001
052171         MOVE VADPT-DEPT-NBR           TO PV-HOLD-DEPT-NBR        05050001
052173     END-IF.                                                      05070000
052174                                                                  05080000
052175     PERFORM 2125-PRORATE-SHRINK.                                 05090000
052176     PERFORM 2150-CALC-ENDINV-RETAIL.                             05100000
052177                                                                  05110000
052178     PERFORM 7400-PREV-SEASON-END-INV.                            05120000
052179                                                                  05130000
052180     PERFORM 2200-CALC-PREV-SEASN-END-PURCH.                      05140000
052181                                                                  05150000
052182     PERFORM 7425-OPEN-SEASON-CURSOR.                             05160000
052183     PERFORM 7450-FETCH-SEASONAL-CURSOR.                          05170011
052184     PERFORM 2250-CALC-SEASON-TO-DATE-PURCH                       05180000
052185        UNTIL PS-END-OF-CURR-SEASON-CSR.                          05190000
052186                                                                  05200000
052187     PERFORM 7575-CLOSE-SEASON-CURSOR.                            05210000
052188                                                                  05211000
052189     PERFORM 2300-CALC-CUMM-TO-DATE-PURCH.                        05212000
052190     PERFORM 2400-CALC-CUMM-MARKUP-PCT.                           05213000
052191                                                                  05214000
052192     PERFORM 2500-CALC-END-INV-COST.                              05215000
052193***  SALES COST AMOUNT                                            05216000
052194     PERFORM 7475-CURR-SEASON-COST.                               05217000
052195     PERFORM 2600-CALC-SALES-COST-AMT.                            05218000
052196***  GROSS MARGIN AMOUNT                                          05218100
052197     PERFORM 2700-CALC-GROSS-MARGIN-AMT.                          05218200
052300*                                                                 05218300
052400*                                                                 05218400
052500**************************************************                05218500
052600*                                                *                05218600
052700* FOLLOWING PARAGRAPHS PERFORM ALL CALCULATIONS  *                05218700
052800*                                                *                05218800
052900**************************************************                05218900
053000 2125-PRORATE-SHRINK.                                             05219000
053100                                                                  05220000
053200***  COMPUTE TOTAL SALES FOR AN ENT-ID TO BE USED TO PRORATE      05230000
053300***  THE SHRINK AMOUNT TO THE ENT-ID                              05240000
053400     COMPUTE PV-ENT-ID-SALES-AMT = VADPT-SLS-REG-RTL-AMT          05250001
053500                                 + VADPT-SLS-PROMO-RTL-AMT        05260001
053600                                 + VADPT-SLS-PROCLR-RTL-AMT       05270001
053700                                 + VADPT-SLS-CLR-RTL-AMT          05280001
053800                                 + VADPT-SLS-OTH-RTL-AMT.         05290001
                                                                        05300000
053900     PERFORM 7250-SUM-SALES-DLRS.                                 05310000
054000                                                                  05320000
054100***  CALC % OF SALES FOR AN ENT-ID WITHIN A DEPT                  05330001
054200     IF PV-DPT-SALES-AMT = 0                                      05340001
054300         MOVE 0 TO PV-ENT-ID-PCT-SALES                            05350000
054400     ELSE                                                         05360000
054500         COMPUTE PV-ENT-ID-PCT-SALES ROUNDED =                    05370000
054600                 PV-ENT-ID-SALES-AMT / PV-DPT-SALES-AMT           05380001
054700     END-IF.                                                      05390000
054800                                                                  05400000
054900***  CALC SHRINK RETAIL FOR AN ENT-ID W/N A DEPT                  05410005
055000     COMPUTE PV-SHNK-RTL-AMT ROUNDED =                            05420000
055100             PV-ENT-ID-PCT-SALES * PV-MNDPT-SHNK-RTL-AMT.         05430001
055200                                                                  05440000
055300***  ACCUMULATOR FOR DEPT LEVEL SHRINK AMOUNTS USED TO            05450001
055400***  BALANCE BACK TO MNDPT SHRINK AMOUNTS                         05460001
055500     ADD PV-SHNK-RTL-AMT TO PV-VADPT-SHNK-RTL-AMT.                05470001
055600                                                                  05480000
055700***  ON LAST ENT ID OF DEPT, CHECK THAT SHRINK                    05490001
055800***  TOTALS ARE IN SYNC, IF NOT RECALC THE SHRINK FOR THAT LAST   05500000
055900***  ENT ID FOR A DEPT.                                           05510001
056000     IF PV-ENT-ID-COUNT = PV-ENT-ID-PROCESS-COUNT                 05520000
056100         IF PV-VADPT-SHNK-RTL-AMT = PV-MNDPT-SHNK-RTL-AMT         05530001
056200             CONTINUE                                             05540000
056300         ELSE                                                     05550000
056400             COMPUTE PV-DPT-SHNK-DIFF = PV-MNDPT-SHNK-RTL-AMT -   05560001
056500                                        PV-VADPT-SHNK-RTL-AMT     05570001
056600             COMPUTE PV-SHNK-RTL-AMT =                            05580000
056700                     PV-SHNK-RTL-AMT + PV-DPT-SHNK-DIFF           05590001
056800         END-IF                                                   05600000
056900         MOVE ZEROES TO PV-ENT-ID-PROCESS-COUNT                   05610000
057000                        PV-VADPT-SHNK-RTL-AMT                     05620001
057100     END-IF.                                                      05630000
057200*                                                                 05640000
057300*                                                                 05650000
057400******************************************************************05660000
057500* CALCULATE THE ENDING INVENTORY OF CURRENT MONTH BASED ON THE    05670000
057600*       ENDING INVENTORY FROM THE PRIOR MONTH                     05680000
057700******************************************************************05690000
057800 2150-CALC-ENDINV-RETAIL.                                         05700000
057900                                                                  05710000
058000***  THE TOTAL MARKDOWN AMT                                       05720000
058100     COMPUTE PV-ENT-ID-MKDN-AMT = VADPT-MKDN-PLU-RTL-AMT          05730001
058200                                + VADPT-MKDN-RGST-RTL-AMT         05740001
058300                                + VADPT-MKDN-UMTCH-RTL-AMT        05750001
058400                                + VADPT-MKDN-BYR-RTL-AMT          05760001
058500                                + VADPT-MKDN-STR-RTL-AMT.         05770001
058600                                                                  05780000
058700     COMPUTE PV-END-INV-RTL-AMT = (  PV-PREV-MONTH-END-INV-RTL    05790000
058800                                   + VADPT-RCPT-RTL-AMT           05800001
058900                                   + VADPT-PADJ-RTL-AMT           05810001
059000                                   + VADPT-MKUP-RTL-AMT           05820001
059100                                   - PV-ENT-ID-SALES-AMT          05830000
059200                                   + VADPT-XFER-IN-RTL-AMT        05840001
059300                                   - VADPT-XFER-OUT-RTL-AMT       05850001
059400                                   - PV-ENT-ID-MKDN-AMT           05860000
059500                                   - VADPT-INV-ADJ-RTL-AMT        05870001
059600                                   - PV-SHNK-RTL-AMT).            05880000
059700*                                                                 05890000
059800*                                                                 05900000
059900******************************************************************05910000
060000* CALCULATE CUMULATIVE MARKUP PERCENTAGE FOR UPDATE               05920000
060100******************************************************************05930000
060200 2200-CALC-PREV-SEASN-END-PURCH.                                  05940000
060300                                                                  05950000
060400     IF PS-NO-PREV-SEASONAL-INV                                   05960000
060500          MOVE 0 TO PV-PREV-SEASON-END-INV-RTL                    05970000
060600          MOVE 0 TO PV-PREV-SEASON-END-INV-COST                   05980000
060700     ELSE                                                         05990000
060800          MOVE VADPT-END-INV-RTL-AMT TO                           06000001
060900                                   PV-PREV-SEASON-END-INV-RTL     06010000
061000          MOVE VADPT-END-INV-COST-AMT TO                          06020001
061100                                   PV-PREV-SEASON-END-INV-COST    06030000
061200     END-IF.                                                      06040000
061300*                                                                 06050000
061400*                                                                 06060000
061500******************************************************************06070000
061600* ACCUMULATE CURRENT SEASON RETAIL/COST AMTS FROM SEASON BEGINNING06080000
061700******************************************************************06090000
061800 2250-CALC-SEASON-TO-DATE-PURCH.                                  06100000
061900                                                                  06110000
062000     COMPUTE PV-XFER-NET =                                        06120000
062100        (VADPT-XFER-IN-RTL-AMT -                                  06130001
062200         VADPT-XFER-OUT-RTL-AMT).                                 06140001
062300                                                                  06150000
062400     ADD PV-XFER-NET             TO  PV-VADPT-XFER-NET-AMT.       06160001
062500     ADD VADPT-RCPT-RTL-AMT      TO  PV-VADPT-RCPT-RTL-AMT.       06170001
062600     ADD VADPT-RCPT-NET-COST-AMT TO  PV-VADPT-RCPT-NET-COST-AMT.  06180001
062700     ADD VADPT-PADJ-RTL-AMT      TO  PV-VADPT-PADJ-RTL-AMT.       06190001
062800     ADD VADPT-PADJ-NET-COST-AMT TO  PV-VADPT-PADJ-NET-COST-AMT.  06200001
062900     ADD VADPT-MKUP-RTL-AMT      TO  PV-VADPT-MKUP-RTL-AMT.       06210001
063000                                                                  06220000
063100     PERFORM 7450-FETCH-SEASONAL-CURSOR.                          06230011
063200*                                                                 06240000
063300*                                                                 06250000
063400******************************************************************06260000
063500* DETERMINE CUMULATIVE RETAIL AND COST                            06270000
063600* ADD PRIOR SEASON END INV AMTS TO CURRENT SEASON-TO-DATE AMTS    06280000
063700******************************************************************06290000
063800 2300-CALC-CUMM-TO-DATE-PURCH.                                    06300000
063900                                                                  06310000
064000     COMPUTE PV-CUM-TO-DATE-PURCH-COST   =                        06320000
064100                                   (  PV-PREV-SEASON-END-INV-COST 06330000
064200                                    + PV-VADPT-RCPT-NET-COST-AMT  06340001
064300                                    + PV-VADPT-PADJ-NET-COST-AMT).06350001
064400                                                                  06360000
064500     COMPUTE PV-CUM-TO-DATE-PURCH-RETAIL =                        06370000
064600                                    (  PV-PREV-SEASON-END-INV-RTL 06380000
064700                                     + PV-VADPT-XFER-NET-AMT      06390001
064800                                     + PV-VADPT-RCPT-RTL-AMT      06400001
064900                                     + PV-VADPT-PADJ-RTL-AMT      06410001
065000                                     + PV-VADPT-MKUP-RTL-AMT).    06420001
065100*                                                                 06430000
065200*                                                                 06440000
065300******************************************************************06450000
065400* FINAL CALCULATIONS OF VALUES TO UPDATE TVADPT - CUM_MKUP_PCT    06460001
065500******************************************************************06470000
065600 2400-CALC-CUMM-MARKUP-PCT.                                       06480000
065700                                                                  06490000
065800     COMPUTE PV-CUM-SEASON-MKUP = (  PV-CUM-TO-DATE-PURCH-RETAIL  06500000
065900                                   - PV-CUM-TO-DATE-PURCH-COST  ).06510000
066000                                                                  06520000
066100     IF PV-CUM-TO-DATE-PURCH-RETAIL = 0                           06530000
066200          MOVE 100 TO PV-CUM-MKUP-PCT                             06540000
066300     ELSE                                                         06550000
066400          COMPUTE PV-CUM-MKUP-PCT ROUNDED =                       06560000
066500         (PV-CUM-SEASON-MKUP * 100) / PV-CUM-TO-DATE-PURCH-RETAIL 06570000
066600     END-IF.                                                      06580000
066700*                                                                 06590000
066800*                                                                 06600000
066900******************************************************************06610000
067000* FINAL CALCULATIONS OF VALUES TO UPDATE TVADPT - END_INV_COST_AMT06620001
067100******************************************************************06630000
067200 2500-CALC-END-INV-COST.                                          06640000
067300                                                                  06650000
067400     COMPUTE PV-END-INV-COST-AMT ROUNDED =                        06660000
067500                  ( (100 - PV-CUM-MKUP-PCT)  *                    06670000
067600                         ( PV-END-INV-RTL-AMT) ) / 100.           06680000
067700*                                                                 06690000
067800*                                                                 06700000
067900******************************************************************06710000
068000* FINAL CALCULATIONS OF VALUES TO UPDATE TVADPT - SALES_COST_AMT *06720001
068100******************************************************************06730000
068200 2600-CALC-SALES-COST-AMT.                                        06740000
068300                                                                  06750000
068400     IF PS-NO-CURRENT-PURCH-COSTS                                 06760000
068500         MOVE ZEROES            TO PV-CURR-MONTH-RCPT-NET-COST    06770000
068600                                   PV-CURR-MONTH-PADJ-NET-COST    06780000
068700     END-IF.                                                      06790000
068800                                                                  06800000
068900     COMPUTE PV-SLS-COST-AMT =                                    06810000
069000           (  PV-PREV-MONTH-END-INV-COST                          06820000
069100            + PV-CURR-MONTH-RCPT-NET-COST                         06830000
069200            + PV-CURR-MONTH-PADJ-NET-COST                         06840000
069300            - PV-END-INV-COST-AMT         ).                      06850000
069400*                                                                 06860000
069500*                                                                 06870000
069600******************************************************************06880000
069700* FINAL CALCULATIONS OF VALUES TO UPDATE TVADPT - GRO_MRGN_AMT   *06890001
069800******************************************************************06900000
069900 2700-CALC-GROSS-MARGIN-AMT.                                      06910000
070000                                                                  06920000
070100     IF PV-ENT-ID-SALES-AMT = 0                                   06930000
070200         MOVE 0 TO PV-GRO-MRGN-AMT                                06940000
070300     ELSE                                                         06950000
070400         COMPUTE PV-GRO-MRGN-AMT =                                06960000
070500         (PV-ENT-ID-SALES-AMT - PV-SLS-COST-AMT)                  06970000
070600     END-IF.                                                      06980000
070700*                                                                 06990000
070800*                                                                 07000000
070900******************************************************************07010000
071000* READ THE DB2 CONTROL TABLE CONTAINING OPEN FISCAL DATE INFO     07020000
071100******************************************************************07030000
071200 7000-SELECT-CNTL-TBL-ROW.                                        07040000
071300                                                                  07050000
071400      EXEC SQL                                                    07060000
071500          SELECT OPN_FSCL_MN_DTE                                  07070000
071600                ,OPN_FSCL_MN_NBR                                  07080000
071700                ,MXPSTG_FSCL_MN_DTE                               07090000
071800                ,MXPSTG_FSCL_MN_NBR                               07100000
071900           INTO  :MLCNTL-OPN-FSCL-MN-DTE                          07110000
072000                ,:MLCNTL-OPN-FSCL-MN-NBR                          07120000
072100                ,:MLCNTL-MXPSTG-FSCL-MN-DTE                       07130000
072200                ,:MLCNTL-MXPSTG-FSCL-MN-NBR                       07140000
072300           FROM  TMLCNTL                                          07150008
072400      END-EXEC.                                                   07160000
072500                                                                  07170000
072600     EVALUATE SQLCODE                                             07180000
072700         WHEN 0                                                   07190000
072800             MOVE MLCNTL-OPN-FSCL-MN-DTE TO CR-FISCAL-MN-END-DTE  07200000
072900             MOVE MLCNTL-OPN-FSCL-MN-NBR TO CR-FISCAL-MN-NBR      07210000
073000             DISPLAY 'CONTROL DATES (TMLCNTL)'                    07220000
073100             DISPLAY '  FISCAL OPEN END DATE : ',                 07230006
073200                                           MLCNTL-OPN-FSCL-MN-DTE 07240000
073300             DISPLAY '        OPEN MONTH NBR : ',                 07250006
073400                                           MLCNTL-OPN-FSCL-MN-NBR 07260000
073500             DISPLAY 'MAXPSTG  MONTH END DTE : ',                 07270006
073600                                        MLCNTL-MXPSTG-FSCL-MN-DTE 07280000
073700             DISPLAY '      MAX MONTH NUMBER : ',                 07290006
073800                                        MLCNTL-MXPSTG-FSCL-MN-NBR 07300000
073900         WHEN OTHER                                               07310000
074000            MOVE '7000-SELECT-CNTL-TBL-ROW' TO PV-PARAGRAPH-NAME  07320000
074100            MOVE PE-MSG-01 TO PV-OPERATION-ATTEMPTED              07330000
074200            PERFORM 9999-SQL-ABEND                                07340000
074300     END-EVALUATE.                                                07350000
074400*                                                                 07360000
074500*                                                                 07370000
074600***************************************************************** 07380000
074700* OPEN CURSOR FOR UPDATE AT INITIALIZATION & AFTER EACH COMMIT    07390000
074800***************************************************************** 07400000
074900 7050-OPEN-DATE-CURSOR.                                           07410000
075000                                                                  07420000
075100     EXEC SQL                                                     07430000
075200         OPEN FISCAL_DATE_CSR                                     07440000
075300     END-EXEC                                                     07450000
075400                                                                  07460000
075500     EVALUATE SQLCODE                                             07470000
075600         WHEN 0                                                   07480000
075700              CONTINUE                                            07490000
075800         WHEN OTHER                                               07500000
075900            MOVE '7050-OPEN-DATE-CSR' TO PV-PARAGRAPH-NAME        07510000
076000            MOVE PE-MSG-03 TO PV-OPERATION-ATTEMPTED              07520000
076100            PERFORM 9999-SQL-ABEND                                07530000
076200     END-EVALUATE.                                                07540000
076300*                                                                 07550000
076400*                                                                 07560000
076500***************************************************************** 07570000
076600* INCREMENT SUBSCRIPT AND CONTINUE LOADING INTERNAL TABLE         07580000
076700***************************************************************** 07590000
076800 7075-FETCH-DATE-CURSOR.                                          07600000
076900                                                                  07610000
077000     EXEC SQL                                                     07620000
077100            FETCH FISCAL_DATE_CSR                                 07630000
077200             INTO :DTATTR-FSCL-MN-END-DTE                         07640000
077300                 ,:DTATTR-CAL-MN-NBR                              07650000
077400                 ,:DTATTR-PFM-END-DTE                             07660000
077500                 ,:DTATTR-SEA-BEG-DTE                             07670000
077600                 ,:DTATTR-PREV-SEA-END-DTE                        07680000
077700                 ,:DTATTR-FSCL-MN-NBR                             07690000
077800                 ,:DTATTR-FSCL-YR-NBR                             07700000
077900     END-EXEC                                                     07710000
078000                                                                  07720000
078100     EVALUATE SQLCODE                                             07730000
078200         WHEN +0                                                  07740000
                   CONTINUE                                             07741009
      ***       USED FOR TESTING/DEBUG                                  07742009
078300***          DISPLAY '---------------------------------'          07750009
078400***          DISPLAY 'PROCESS DATE: ', DTATTR-FSCL-MN-END-DTE     07760009
078500         WHEN +100                                                07770000
078600             SET PS-END-OF-FISCAL-DATE-CSR TO TRUE                07780000
078700         WHEN OTHER                                               07790000
078800             MOVE '7075-PROCESS-DATE-CSR' TO PV-PARAGRAPH-NAME    07800000
078900             MOVE PE-MSG-04 TO PV-OPERATION-ATTEMPTED             07810000
079000             PERFORM 9999-SQL-ABEND                               07820000
079100     END-EVALUATE.                                                07830000
079200                                                                  07840000
079300*                                                                 07850000
079400*                                                                 07860000
079500***************************************************************** 07870000
079600*                                                                 07880000
079700***************************************************************** 07890000
079800 7149-OPEN-ENT-ID-CURSOR.                                         07900000
079900                                                                  07910000
080000     EXEC SQL                                                     07920000
080100         OPEN ENT_ID_CSR                                          07930000
080200     END-EXEC                                                     07940000
080300                                                                  07950000
080400     EVALUATE SQLCODE                                             07960000
080500         WHEN 0                                                   07970000
080600              CONTINUE                                            07980000
080700         WHEN OTHER                                               07990000
080800            DISPLAY 'HOLD-DATE ', DTATTR-PFM-END-DTE              08000000
080900            DISPLAY 'MAX DATE  ', MLCNTL-MXPSTG-FSCL-MN-DTE       08010000
081000            MOVE '7149-OPEN-ENT-ID-CSR' TO PV-PARAGRAPH-NAME      08020001
081100            MOVE PE-MSG-03 TO PV-OPERATION-ATTEMPTED              08030000
081200            PERFORM 9999-SQL-ABEND                                08040000
081300     END-EVALUATE.                                                08050000
081400*                                                                 08060000
081500*                                                                 08070000
081600***************************************************************** 08080000
081700* FETCH A DEPT TO PROCESS                                         08090001
081800***************************************************************** 08100000
081900 7150-FETCH-ENT-ID-CURSOR.                                        08110000
082000                                                                  08120000
082100     EXEC SQL                                                     08130000
082200            FETCH ENT_ID_CSR                                      08140000
082300             INTO :VADPT-DEPT-NBR                                 08150001
082500                 ,:VADPT-ENT-ID                                   08170001
082600     END-EXEC                                                     08180000
082700                                                                  08190000
082800     EVALUATE SQLCODE                                             08200000
082900         WHEN +0                                                  08210000
083000             CONTINUE                                             08220000
083100         WHEN +100                                                08230000
083200             SET PS-END-OF-ENT-ID-CURSOR TO TRUE                  08240000
083300         WHEN OTHER                                               08250000
083400             MOVE '7150-FETCH-ENT-ID'    TO PV-PARAGRAPH-NAME     08260001
083500             MOVE PE-MSG-04              TO PV-OPERATION-ATTEMPTED08270000
083600             PERFORM 9999-SQL-ABEND                               08280000
083700       END-EVALUATE.                                              08290000
083800*                                                                 08300000
083900*                                                                 08310000
084000***************************************************************** 08320000
084100*-- RETRIEVE COUNT OF ALL ROWS WITHIN THE PREVIOUS FISCAL         08330000
084200*-- MONTH END DATE (CARRY FORWARD ROWS) AND THE MAX POSTING DATE  08340000
084300*-- THIS COUNT IS USED TO ACCOMODATE FOR ANY IMBALANCE IN THE     08350000
084400*-- CALCULATED SHRINK VS. THE TMNDPT SHRINK.  ANY OUT OF BALANCE  08360001
084500*-- AMOUNT IS LOADED INTO THE LAST ENT ID OF A DEPT               08370001
084600***************************************************************** 08380000
084700 7155-GET-ENT-ID-COUNT.                                           08390000
084800                                                                  08400000
084900     MOVE ZEROES TO PV-ENT-ID-COUNT.                              08410000
085000                                                                  08420000
085100     EXEC SQL                                                     08430000
085200          SELECT  COUNT (DISTINCT ENT_ID)                         08440000
085300             INTO :PV-ENT-ID-COUNT                                08450000
085400           FROM  TVADPT                                           08460001
085500          WHERE DEPT_NBR          = :VADPT-DEPT-NBR               08470001
085700            AND ((FSCL_MN_END_DTE = :MLCNTL-OPN-FSCL-MN-DTE)      08490000
086000            OR  (FSCL_MN_END_DTE  = :DTATTR-PFM-END-DTE           08500000
086100            AND (END_INV_RTL_AMT  <> 0 OR                         08510000
086200                 END_INV_COST_AMT <> 0)))                         08520000
086300     END-EXEC.                                                    08530000
086400                                                                  08540000
086500     EVALUATE SQLCODE                                             08550000
086600         WHEN +0                                                  08560000
086700             CONTINUE                                             08570000
086800         WHEN OTHER                                               08580000
086900             MOVE '7155-GET-ENT-ID-COUNT' TO PV-PARAGRAPH-NAME    08590000
087000             MOVE PE-MSG-16              TO PV-OPERATION-ATTEMPTED08600000
087100             PERFORM 9999-SQL-ABEND                               08610000
087200     END-EVALUATE.                                                08620000
087300*                                                                 08630000
087400*                                                                 08640000
087500***************************************************************** 08650000
087600* RETRIEVES CURRENT MONTH SHRINK DOLLARS FROM TMNSCLS             08660000
087700***************************************************************** 08670000
087800 7200-OBTAIN-SHRINK-DLRS.                                         08680000
087900                                                                  08690000
088000     EXEC SQL                                                     08700000
088100          SELECT  SUM (SHNK_RTL_AMT)                              08710000
088200          INTO   :PV-MNDPT-SHNK-RTL-AMT                           08720001
088300            FROM TMNDPT                                           08730001
088400           WHERE FSCL_MN_END_DTE = :DTATTR-FSCL-MN-END-DTE        08740000
088500            AND  DEPT_NBR        = :VADPT-DEPT-NBR                08750001
088700     END-EXEC.                                                    08770000
088800                                                                  08780000
088900     EVALUATE SQLCODE                                             08790000
089000         WHEN +0                                                  08800000
089100            CONTINUE                                              08810000
089200         WHEN -305                                                08820000
089300            MOVE ZERO TO PV-MNDPT-SHNK-RTL-AMT                    08830001
089400         WHEN OTHER                                               08840000
089500           DISPLAY SPACE                                          08850000
089700           DISPLAY 'OPEN MONTH DATE : '  DTATTR-FSCL-MN-END-DTE   08851006
089600           DISPLAY '    DEPT NBR    : '  VADPT-DEPT-NBR           08860006
089900           DISPLAY '    ENT-ID      : '  VADPT-ENT-ID             08890001
090000           MOVE '7200-SELECT-SHRINK-AMT' TO PV-PARAGRAPH-NAME     08900000
090100           MOVE PE-MSG-13                TO PV-OPERATION-ATTEMPTED08910000
090200           PERFORM 9999-SQL-ABEND                                 08920000
090300       END-EVALUATE.                                              08930000
090400*                                                                 08940000
090500*                                                                 08950000
090600***************************************************************** 08960000
090700*-- SUM RETAIL SALES FROM TVADPT FOR AN DEPT                      08970001
090800***************************************************************** 08980000
090900 7250-SUM-SALES-DLRS.                                             08990000
091000                                                                  09000000
091100     EXEC SQL                                                     09010000
091200          SELECT  SUM (SLS_REG_RTL_AMT +                          09020000
091300                       SLS_PROMO_RTL_AMT +                        09030000
091400                       SLS_PROCLR_RTL_AMT +                       09040000
091500                       SLS_CLR_RTL_AMT +                          09050000
091600                       SLS_OTH_RTL_AMT)                           09060000
091700            INTO  :PV-DPT-SALES-AMT:PV-SALES-NULL-IND             09070001
091800            FROM TVADPT                                           09080001
091900           WHERE FSCL_MN_NBR     = :DTATTR-FSCL-MN-NBR            09090000
092000             AND FSCL_MN_END_DTE = :DTATTR-FSCL-MN-END-DTE        09100000
092100             AND DEPT_NBR        = :VADPT-DEPT-NBR                09110001
092300     END-EXEC                                                     09130000
092400                                                                  09140000
092500     EVALUATE SQLCODE                                             09150000
092600         WHEN +0                                                  09160000
092610             IF PV-SALES-NULL-IND < 0                             09170000
092700                MOVE ZEROS              TO PV-DPT-SALES-AMT       09180001
092710             END-IF                                               09190000
092800         WHEN OTHER                                               09200000
092900             MOVE '7250-SUM END ID SSL' TO PV-PARAGRAPH-NAME      09210000
093000             MOVE 'NEED MESSAGE'        TO PV-OPERATION-ATTEMPTED 09220000
093100             PERFORM 9999-SQL-ABEND                               09230000
093200     END-EVALUATE.                                                09240000
093300*                                                                 09250000
093400*                                                                 09260000
093500***************************************************************** 09270000
093600* SELECT A ROW FROM DB2 TO BE RECALCED THEN INSERTED OR UPDATED   09280007
093700***************************************************************** 09290000
093800 7300-SELECT-CURRENT-DOLLARS.                                     09300000
093900                                                                  09310000
094000     EXEC SQL                                                     09320000
094100         SELECT SLS_REG_RTL_AMT                                   09330000
094200               ,SLS_PROMO_RTL_AMT                                 09340000
094300               ,SLS_PROCLR_RTL_AMT                                09350000
094400               ,SLS_CLR_RTL_AMT                                   09360000
094500               ,SLS_OTH_RTL_AMT                                   09370000
094600               ,MKDN_PLU_RTL_AMT                                  09380000
094700               ,MKDN_RGST_RTL_AMT                                 09390000
094800               ,MKDN_UMTCH_RTL_AMT                                09400000
094900               ,MKDN_BYR_RTL_AMT                                  09410000
095000               ,MKDN_STR_RTL_AMT                                  09420000
095100               ,MKUP_RTL_AMT                                      09430000
095200               ,XFER_IN_RTL_AMT                                   09440000
095300               ,XFER_OUT_RTL_AMT                                  09450000
095400               ,RCPT_RTL_AMT                                      09460000
095500               ,RCPT_NET_COST_AMT                                 09470000
095600               ,RCPT_GRO_COST_AMT                                 09480000
095700               ,PADJ_FRGT_COST_AMT                                09490000
095800               ,PADJ_DISC_COST_AMT                                09500000
095900               ,PADJ_RTL_AMT                                      09510000
096000               ,PADJ_NET_COST_AMT                                 09520000
096100               ,INV_ADJ_RTL_AMT                                   09530000
096200           INTO :VADPT-SLS-REG-RTL-AMT                            09540001
096300               ,:VADPT-SLS-PROMO-RTL-AMT                          09550001
096400               ,:VADPT-SLS-PROCLR-RTL-AMT                         09560001
096500               ,:VADPT-SLS-CLR-RTL-AMT                            09570001
096600               ,:VADPT-SLS-OTH-RTL-AMT                            09580001
096700               ,:VADPT-MKDN-PLU-RTL-AMT                           09590001
096800               ,:VADPT-MKDN-RGST-RTL-AMT                          09600001
096900               ,:VADPT-MKDN-UMTCH-RTL-AMT                         09610001
097000               ,:VADPT-MKDN-BYR-RTL-AMT                           09620001
097100               ,:VADPT-MKDN-STR-RTL-AMT                           09630001
097200               ,:VADPT-MKUP-RTL-AMT                               09640001
097300               ,:VADPT-XFER-IN-RTL-AMT                            09650001
097400               ,:VADPT-XFER-OUT-RTL-AMT                           09660001
097500               ,:VADPT-RCPT-RTL-AMT                               09670001
097600               ,:VADPT-RCPT-NET-COST-AMT                          09680001
097700               ,:VADPT-RCPT-GRO-COST-AMT                          09690001
097800               ,:VADPT-PADJ-FRGT-COST-AMT                         09700001
097900               ,:VADPT-PADJ-DISC-COST-AMT                         09710001
098000               ,:VADPT-PADJ-RTL-AMT                               09720001
098100               ,:VADPT-PADJ-NET-COST-AMT                          09730001
098200               ,:VADPT-INV-ADJ-RTL-AMT                            09740001
098300            FROM TVADPT                                           09750001
098400           WHERE FSCL_MN_NBR     = :DTATTR-FSCL-MN-NBR            09760000
098500             AND FSCL_MN_END_DTE = :DTATTR-FSCL-MN-END-DTE        09770000
098600             AND DEPT_NBR        = :VADPT-DEPT-NBR                09780001
098800             AND ENT_ID          = :VADPT-ENT-ID                  09800001
098900     END-EXEC                                                     09810000
099000                                                                  09820000
099100     EVALUATE SQLCODE                                             09830000
099200         WHEN +0                                                  09840000
099300           SET PS-CURR-MONTH-ROW-FOUND   TO TRUE                  09850000
099400         WHEN +100                                                09860000
099500           SET PS-CURR-MONTH-ROW-NOT-FOUND   TO TRUE              09870000
099600         WHEN OTHER                                               09880000
099700             MOVE '7300-SELECT-CURRENT'  TO PV-PARAGRAPH-NAME     09890000
099800             MOVE PE-MSG-04              TO PV-OPERATION-ATTEMPTED09900000
099900             PERFORM 9999-SQL-ABEND                               09910000
100000       END-EVALUATE.                                              09920000
100100*                                                                 09930000
100200*                                                                 09940000
100300******************************************************************09950000
100400* RETRIEVE LAST MONTH'S ENDING INVENTORY RETAIL/COST              09960000
100500*     THIS IS ALSO THE BEGINNING INVENTORY FOR THIS MONTH         09970000
100600******************************************************************09980000
100700 7350-SELECT-PREV-MONTH-END-INV.                                  09990000
100800                                                                  10000000
100900     EXEC SQL                                                     10010000
101000          SELECT  END_INV_RTL_AMT                                 10020000
101100                , END_INV_COST_AMT                                10030000
101200            INTO  :PV-PREV-MONTH-END-INV-RTL                      10040000
101300                 ,:PV-PREV-MONTH-END-INV-COST                     10050000
101400            FROM  TVADPT                                          10060001
101500           WHERE  DEPT_NBR        = :VADPT-DEPT-NBR               10070001
101700             AND  ENT_ID          = :VADPT-ENT-ID                 10090001
101800             AND  FSCL_MN_END_DTE = :DTATTR-PFM-END-DTE           10100000
101900     END-EXEC.                                                    10110000
102000                                                                  10120000
102100     EVALUATE SQLCODE                                             10130000
102200         WHEN 0                                                   10140000
102300             SET PS-PREV-MONTH-ROW-FOUND TO TRUE                  10150000
102400         WHEN +100                                                10160000
102500             SET PS-PREV-MONTH-ROW-NOT-FOUND TO TRUE              10170000
102600             MOVE ZEROES TO PV-PREV-MONTH-END-INV-RTL             10180000
102700                            PV-PREV-MONTH-END-INV-COST            10190000
102800         WHEN OTHER                                               10200000
102900             MOVE PE-MSG-02            TO PV-OPERATION-ATTEMPTED  10210000
103000             MOVE  '7350-SELECT-PREV-MONTH-END-INV'               10220000
103100                                       TO PV-PARAGRAPH-NAME       10230000
103200             PERFORM 9999-SQL-ABEND                               10240000
103300     END-EVALUATE.                                                10250000
103400*                                                                 10260000
103500*                                                                 10270000
103600******************************************************************10280000
103700* 7400-PREV-SEASON-END-INV SELECTS THE ENDING INVENTORY COST &   *10290000
103800*      RETAIL FROM THE LAST DAY OF THE PREVIOUS FISCAL SEASON    *10300000
103900******************************************************************10310000
104000 7400-PREV-SEASON-END-INV.                                        10320000
104100                                                                  10330000
104200     MOVE 'N'    TO PS-PREV-SEASON-INV-SW.                        10340000
104300                                                                  10350000
104400     EXEC SQL                                                     10360000
104500          SELECT  END_INV_RTL_AMT                                 10370000
104600                 ,END_INV_COST_AMT                                10380000
104700            INTO  :VADPT-END-INV-RTL-AMT                          10390001
104800                 ,:VADPT-END-INV-COST-AMT                         10400001
104900            FROM  TVADPT                                          10410001
105000           WHERE  DEPT_NBR        = :VADPT-DEPT-NBR               10420001
105200             AND  ENT_ID          = :VADPT-ENT-ID                 10440001
105300             AND  FSCL_MN_END_DTE = :DTATTR-PREV-SEA-END-DTE      10450000
105400     END-EXEC.                                                    10460000
105500                                                                  10470000
105600     EVALUATE SQLCODE                                             10480000
105700         WHEN 0                                                   10490000
105800             CONTINUE                                             10500000
105900         WHEN +100                                                10510000
106000             SET PS-NO-PREV-SEASONAL-INV       TO TRUE            10520000
106100         WHEN OTHER                                               10530000
106200             MOVE PE-MSG-02            TO PV-OPERATION-ATTEMPTED  10540000
106300             MOVE  '7400-PREV-SEASON-END-INV'                     10550000
106400                                       TO PV-PARAGRAPH-NAME       10560000
106500             PERFORM 9999-SQL-ABEND                               10570000
106600     END-EVALUATE.                                                10580000
106700*                                                                 10590000
106800*                                                                 10600000
106900***************************************************************** 10610000
107000* OPEN CURSOR FOR MONTH-END VALUES FOR THIS SEASON                10620000
107100***************************************************************** 10630000
107200 7425-OPEN-SEASON-CURSOR.                                         10640000
107300                                                                  10650000
107400     EXEC SQL                                                     10660000
107500         OPEN SEASON_TO_DATE_CSR                                  10670000
107600     END-EXEC                                                     10680000
107700                                                                  10690000
107800     IF SQLCODE = +0                                              10700000
107900         CONTINUE                                                 10710000
108000     ELSE                                                         10720000
108100         MOVE PE-MSG-03                 TO PV-OPERATION-ATTEMPTED 10730000
108200         MOVE '7425-OPEN-SEASON-CURSOR' TO PV-PARAGRAPH-NAME      10740000
108300         PERFORM 9999-SQL-ABEND                                   10750000
108400     END-IF.                                                      10760000
108500*                                                                 10770000
108600*                                                                 10780000
108700******************************************************************10790000
108800* 7450-FETCH-SEASON-CURSOR WILL RETRIEVE ALL ROWS WITH AN   ENDING10800011
108900* INVENTORY AMOUNT FOR EACH MONTH END DATE FOR THE CURRENT SEASON.10810000
109000******************************************************************10820000
109100 7450-FETCH-SEASONAL-CURSOR.                                      10830011
109200                                                                  10840000
109300     MOVE 'N'    TO PS-CURR-SEASON-CURSOR-SW.                     10850000
109400                                                                  10860000
109500     EXEC SQL                                                     10870000
109600           FETCH SEASON_TO_DATE_CSR                               10880000
109700            INTO  :VADPT-XFER-IN-RTL-AMT                          10890001
109800                 ,:VADPT-XFER-OUT-RTL-AMT                         10900001
109900                 ,:VADPT-RCPT-RTL-AMT                             10910001
110000                 ,:VADPT-RCPT-NET-COST-AMT                        10920001
110100                 ,:VADPT-PADJ-RTL-AMT                             10930001
110200                 ,:VADPT-PADJ-NET-COST-AMT                        10940001
110300                 ,:VADPT-MKUP-RTL-AMT                             10950001
110400     END-EXEC.                                                    10960000
110500                                                                  10970000
110600     EVALUATE SQLCODE                                             10980000
110700          WHEN 0                                                  10990000
110800              CONTINUE                                            11000000
110900          WHEN +100                                               11010000
111000              SET PS-END-OF-CURR-SEASON-CSR    TO TRUE            11020000
111100          WHEN OTHER                                              11030000
111200              MOVE PE-MSG-04             TO PV-OPERATION-ATTEMPTED11040000
111300              MOVE '7450-FETCH-SEASONAL-CURSOR'                   11050011
111400                                         TO PV-PARAGRAPH-NAME     11060000
111500              PERFORM 9999-SQL-ABEND                              11070000
111600     END-EVALUATE.                                                11080000
111700*                                                                 11090000
111800*                                                                 11100000
111900******************************************************************11110000
112000* 7475-CURR-SEASON-COST SELECTS THE CURRENT MONTH RECEIPT NET    *11120000
112100*      COST AND PURCH ADJ NET COST AMTS FOR THE OPEN FISCAL      *11130000
112200*      PERIOD FOR A PARTICULAR ENT ID.                           *11140000
112300******************************************************************11150000
112400 7475-CURR-SEASON-COST.                                           11160000
112500                                                                  11170000
112600     MOVE 'N'    TO PS-CURRENT-PURCH-COST-SW.                     11180000
112700                                                                  11190000
112800     EXEC SQL                                                     11200000
112900          SELECT  RCPT_NET_COST_AMT                               11210000
113000                 ,PADJ_NET_COST_AMT                               11220000
113100            INTO  :PV-CURR-MONTH-RCPT-NET-COST                    11230000
113200                 ,:PV-CURR-MONTH-PADJ-NET-COST                    11240000
113300            FROM  TVADPT                                          11250001
113400           WHERE  DEPT_NBR        = :VADPT-DEPT-NBR               11260001
113600             AND  ENT_ID          = :VADPT-ENT-ID                 11280001
113700             AND  FSCL_MN_END_DTE = :DTATTR-FSCL-MN-END-DTE       11290000
113800     END-EXEC.                                                    11300000
113900                                                                  11310000
114000     EVALUATE SQLCODE                                             11320000
114100         WHEN 0                                                   11330000
114200             CONTINUE                                             11340000
114300         WHEN +100                                                11350000
114400             SET PS-NO-CURRENT-PURCH-COSTS     TO TRUE            11360000
114500         WHEN OTHER                                               11370000
114600             MOVE PE-MSG-02            TO PV-OPERATION-ATTEMPTED  11380000
114700             MOVE  '7475-CURRENT-SEASON-COST'                     11390000
114800                                       TO PV-PARAGRAPH-NAME       11400000
114900             PERFORM 9999-SQL-ABEND                               11410000
115000     END-EVALUATE.                                                11420000
115100*                                                                 11430000
115200*                                                                 11440000
115300******************************************************************11450000
115400* UPDATE COLUMNS WITH VALUES JUST CALCULATED FOR THIS DEPARTMENT  11460000
115500******************************************************************11470000
115600 7500-UPDATE-PROCESSING.                                          11480000
115700                                                                  11490000
115800     EXEC SQL                                                     11500000
115900         UPDATE TVADPT                                            11510001
116000            SET  SHNK_RTL_AMT     = :PV-SHNK-RTL-AMT              11520000
116100                ,END_INV_RTL_AMT  = :PV-END-INV-RTL-AMT           11530000
116200                ,CUM_MKUP_PCT     = :PV-CUM-MKUP-PCT              11540000
116300                ,END_INV_COST_AMT = :PV-END-INV-COST-AMT          11550000
116400                ,SLS_COST_AMT     = :PV-SLS-COST-AMT              11560000
116500                ,GRO_MRGN_AMT     = :PV-GRO-MRGN-AMT              11570000
116600          WHERE FSCL_MN_NBR       = :DTATTR-FSCL-MN-NBR           11580000
116700            AND FSCL_MN_END_DTE   = :DTATTR-FSCL-MN-END-DTE       11590000
116800            AND DEPT_NBR          = :VADPT-DEPT-NBR               11600001
117000            AND ENT_ID            = :VADPT-ENT-ID                 11620001
117100     END-EXEC                                                     11630000
117200                                                                  11640000
117300     EVALUATE SQLCODE                                             11650000
117400         WHEN 0                                                   11660000
117500              ADD 1                TO PA-UPDATE-COUNT             11670000
117600         WHEN OTHER                                               11680000
117700              DISPLAY '*************************************'     11690000
117800              DISPLAY 'ROW IN PROCESS  : ', VADPT-DEPT-NBR        11700001
118000                                            VADPT-ENT-ID          11720001
118100              DISPLAY 'MONTH-END-DATE  : ',                       11730000
118200                                        DTATTR-FSCL-MN-END-DTE    11740000
118300              DISPLAY 'FISCAL MONTH NBR: ',                       11750000
118400                                           DTATTR-FSCL-MN-NBR     11760000
118500              MOVE PE-MSG-06        TO PV-OPERATION-ATTEMPTED     11770000
118600              MOVE '7500-UPDATE-PROCESSING'                       11780000
118700                                    TO PV-PARAGRAPH-NAME          11790000
118800              PERFORM 9999-SQL-ABEND                              11800000
118900     END-EVALUATE.                                                11810000
119000*                                                                 11820000
119100*                                                                 11830000
119200******************************************************************11840000
119300* 7510-INSERT-CARRY-FWD-ROW                                       11850000
119400* PERFORMED IF NO ROW IS FOUND ON DB2 (FOR THIS PROCESSING MONTH) 11860000
119500* BUT INVENTORY DOLLARS (COST AND/OR RETAIL) FOUND FOR LAST MONTH 11870000
119600******************************************************************11880000
119700 7510-INSERT-CARRY-FWD-ROW.                                       11890000
                                                                        11891007
119800***  USED TO DIAPLAY INSERTED ROWS DURING TESTING                 11900006
119900***  DISPLAY 'INSERTED ROW : ', VADPT-DEPT-NBR, '-',              11910006
120100***    VADPT-ENT-ID                                               11930006
120200                                                                  11940000
120300     EXEC SQL                                                     11950000
120400         INSERT INTO TVADPT                                       11960001
120500              (  FSCL_MN_NBR                                      11970000
120600               , FSCL_MN_END_DTE                                  11980000
120700               , DEPT_NBR                                         11990000
120900               , ENT_ID                                           12010000
121000               , SLS_REG_RTL_AMT                                  12020000
121010               , SLS_PROMO_RTL_AMT                                12030000
121020               , SLS_PROCLR_RTL_AMT                               12040000
121030               , SLS_CLR_RTL_AMT                                  12050000
121040               , SLS_OTH_RTL_AMT                                  12060000
121050               , MKDN_PLU_RTL_AMT                                 12070000
121060               , MKDN_RGST_RTL_AMT                                12080000
121070               , MKDN_UMTCH_RTL_AMT                               12090000
121080               , MKDN_BYR_RTL_AMT                                 12100000
121090               , MKDN_STR_RTL_AMT                                 12101000
121091               , MKUP_RTL_AMT                                     12102000
121092               , XFER_IN_RTL_AMT                                  12103000
121093               , XFER_OUT_RTL_AMT                                 12104000
121094               , RCPT_RTL_AMT                                     12105000
121095               , RCPT_NET_COST_AMT                                12106000
121096               , RCPT_GRO_COST_AMT                                12107000
121097               , PADJ_FRGT_COST_AMT                               12108000
121098               , PADJ_DISC_COST_AMT                               12109000
121099               , PADJ_RTL_AMT                                     12109100
121100               , PADJ_NET_COST_AMT                                12109200
121101               , DR_ALW_RTL_AMT                                   12109300
121102               , RTV_RTL_AMT                                      12109400
121103               , INV_ADJ_RTL_AMT                                  12109500
121104               , SHNK_RTL_AMT                                     12109600
121105               , MKUP_INIT_AMT                                    12109700
121106               , MKUP_NET_AMT                                     12109800
121107               , END_INV_RTL_AMT                                  12109900
121108               , CUM_MKUP_PCT                                     12110000
121109               , END_INV_COST_AMT                                 12110100
121110               , SLS_COST_AMT                                     12110200
121111               , GRO_MRGN_AMT      )                              12110300
121112         VALUES (:DTATTR-FSCL-MN-NBR                              12110400
121113                ,:DTATTR-FSCL-MN-END-DTE                          12110500
121114                ,:VADPT-DEPT-NBR                                  12110601
121116                ,:VADPT-ENT-ID                                    12110801
121117                ,0                                                12110900
121118                ,0                                                12111000
121119                ,0                                                12111100
121120                ,0                                                12111200
121121                ,0                                                12111300
121122                ,0                                                12111400
121123                ,0                                                12111500
121124                ,0                                                12111600
121125                ,0                                                12111700
121126                ,0                                                12111800
121127                ,0                                                12111900
121128                ,0                                                12112000
121129                ,0                                                12112100
121130                ,0                                                12112200
121131                ,0                                                12112300
121132                ,0                                                12112400
121133                ,0                                                12112500
121134                ,0                                                12112600
121135                ,0                                                12112700
121136                ,0                                                12112800
121137                ,0                                                12112900
121138                ,0                                                12113000
121139                ,0                                                12113100
121140                ,:PV-SHNK-RTL-AMT                                 12113200
121141                ,0                                                12113300
121142                ,0                                                12113400
121143                ,:PV-END-INV-RTL-AMT                              12113500
121144                ,:PV-CUM-MKUP-PCT                                 12113600
121145                ,:PV-END-INV-COST-AMT                             12113700
121146                ,:PV-SLS-COST-AMT                                 12113800
121147                ,:PV-GRO-MRGN-AMT)                                12113900
121148                                                                  12114000
121149     END-EXEC.                                                    12114100
121150                                                                  12114200
121151     IF SQLCODE = 0                                               12114300
121152         ADD 1                      TO PA-INSERT-COUNT            12114400
121153     ELSE                                                         12114500
121154         MOVE '7510-INSERT-CARRY-FWD-ROW' TO PV-PARAGRAPH-NAME    12114600
121155         MOVE PE-MSG-14             TO PV-OPERATION-ATTEMPTED     12114700
121156         PERFORM 9999-SQL-ABEND                                   12114800
121157     END-IF.                                                      12114900
121158*                                                                 12115000
121159*                                                                 12115100
121160******************************************************************12115200
121200*                                                                 12115300
121300******************************************************************12115400
121400 7575-CLOSE-SEASON-CURSOR.                                        12115500
121500                                                                  12115600
121600     EXEC SQL                                                     12115700
121700         CLOSE SEASON_TO_DATE_CSR                                 12115800
121800     END-EXEC.                                                    12115900
121900                                                                  12116000
122000     EVALUATE SQLCODE                                             12117000
122100         WHEN 0                                                   12118000
122200             CONTINUE                                             12119000
122300         WHEN OTHER                                               12120000
122400             MOVE PE-MSG-05            TO PV-OPERATION-ATTEMPTED  12130000
122500             MOVE '7575-CLOSE-SEASON-CURSOR' TO PV-PARAGRAPH-NAME 12140000
122600             PERFORM 9999-SQL-ABEND                               12150000
122700     END-EVALUATE.                                                12160000
122800*                                                                 12170000
122900*                                                                 12180000
123000******************************************************************12190000
123100* 7650-INIT-CHECKPOINT-SELECT                                    *12200000
123200* CHECK STATUS CODE TO SEE IF THIS IS A RESTART CONDITION        *12210000
123300******************************************************************12220000
123400 7650-INIT-CHECKPOINT-SELECT.                                     12230000
123500                                                                  12240000
123600     EXEC SQL                                                     12250000
123700       SELECT  CKPT_STAT_CODE                                     12260000
123800              ,CKPT_FRQNCY_QTY                                    12270000
123900         INTO  :TCKRSTCNTL-CKPT-STAT-CODE                         12280000
124000              ,:TCKRSTCNTL-CKPT-FRQNCY-QTY                        12290000
124100         FROM  TCKRSTCNTL                                         12300000
124200        WHERE  JOB_NAME  = :PC-JOB-NAME                           12310000
124300          AND  PLAN_NAME = :PC-PROGRAM-NAME                       12320000
124400     END-EXEC.                                                    12330000
124500                                                                  12340000
124600     IF SQLCODE = 0                                               12350000
124700         CONTINUE                                                 12360000
124800     ELSE                                                         12370000
124900         MOVE '7650-INIT-CHECKPOINT-SELECT' TO PV-PARAGRAPH-NAME  12380000
125000         MOVE PE-MSG-07             TO PV-OPERATION-ATTEMPTED     12390000
125100         PERFORM 9999-SQL-ABEND                                   12400000
125200     END-IF.                                                      12410000
125300*                                                                 12420000
125400*                                                                 12430000
125500******************************************************************12440000
125600* 7700-SELECT-RESTART-INFO                                       *12450000
125700* OBTAIN INFORMATION REGARDING WHERE TO RESTART TABLE PROCESSING *12460000
125800******************************************************************12470000
125900 7700-SELECT-RESTART-INFO.                                        12480000
126000                                                                  12490000
126100     EXEC SQL                                                     12500000
126200       SELECT  WORK_STRG_DESC                                     12510000
126300         INTO  :TCKRSTINF-WORK-STRG-DESC                          12520000
126400         FROM  TCKRSTINF                                          12530000
126500        WHERE  JOB_NAME  = :PC-JOB-NAME                           12540000
126600          AND  PLAN_NAME = :PC-PROGRAM-NAME                       12550000
126700     END-EXEC.                                                    12560000
126800                                                                  12570000
126900     IF SQLCODE = 0                                               12580000
127000         CONTINUE                                                 12590000
127100     ELSE                                                         12600000
127200         MOVE '*7700-SELECT-RESTART-INFO*' TO PV-PARAGRAPH-NAME   12610000
127300         MOVE PE-MSG-11             TO PV-OPERATION-ATTEMPTED     12620000
127400         PERFORM 9999-SQL-ABEND                                   12630000
127500     END-IF.                                                      12640000
127600*                                                                 12650000
127700*                                                                 12660000
127800******************************************************************12670000
127900* 7800-COMMIT-PROCESSING.                                        *12680000
127910*      THE ENT-ID CURSOR IS ALWAYS CLOSED BY THE COMMIT WHEN     *12690000
127920*      A DEPT CHANGES OR WHEN THE END-OF-CURSOR IS REACHED       *12700000
127921*      SO CODE TO CLOSE FOR THE ENT-ID CURSOR WAS NOT NEEDED     *12710000
127930******************************************************************12720000
128100 7800-COMMIT-PROCESSING.                                          12730000
128200                                                                  12740000
128300     MOVE '*7800-COMMIT-PROCESSING*' TO PV-PARAGRAPH-NAME.        12750000
128400                                                                  12760000
128500***  CHECK DEPT                                                   12770001
128600***      PREPARE COMMIT RECORD FOR UPDATE                         12780000
128700     ADD 1                           TO PA-COMMIT-COUNT.          12790000
128800     MOVE DTATTR-FSCL-MN-END-DTE     TO CR-FISCAL-MN-END-DTE.     12800000
128900     MOVE DTATTR-FSCL-MN-NBR         TO CR-FISCAL-MN-NBR.         12810000
129000     MOVE VADPT-DEPT-NBR             TO CR-DEPT-NBR.              12820001
129100     MOVE PA-DEPT-COUNT              TO CR-TVADPT-FETCH-COUNT.    12830001
129200     MOVE PA-UPDATE-COUNT            TO CR-TVADPT-UPDATE-COUNT.   12840001
129300     MOVE PA-INSERT-COUNT            TO CR-TVADPT-INSERT-COUNT.   12850001
129400     MOVE PA-COMMIT-COUNT            TO CR-TVADPT-COMMIT-COUNT.   12860001
129410                                                                  12870000
129500***      MOVE COMMIT INFO TO WORKING STORAGE ROW                  12880000
129600     MOVE CR-CHECKPOINT-RESTART-AREA TO TCKRSTINF-WORK-STRG-DESC. 12890000
      ***  USED TO DISPLAY COMMIT POINTS DURING TESTING                 12891006
129800***  DISPLAY 'COMMIT TAKEN FOR DEPT: ' PV-COMMIT-DEPT.            12900006
129810                                                                  12910000
129900     IF PS-FIRST-COMMIT                                           12920000
130000         MOVE '9' TO TCKRSTCNTL-CKPT-STAT-CODE                    12930000
130100         PERFORM 7900-UPDATE-CHECKPOINT-STATUS                    12940000
130200         MOVE 'N' TO PS-FIRST-COMMIT-SW                           12950000
130300     END-IF.                                                      12960000
130310                                                                  12970000
130400     PERFORM 7850-COMMIT-CHANGES.                                 12980000
130410                                                                  12990000
130420***  REESTABLISH DATE CURSOR FOR THE DATE IT LEFT OFF ON          13000000
130500     PERFORM 7050-OPEN-DATE-CURSOR.                               13010000
130600     PERFORM 7075-FETCH-DATE-CURSOR.                              13020000
130610                                                                  13030000
130700***  REESTABLISH ENT-ID CURSOR FOR THE DEPT IT LEFT OFF ON        13031000
130800***  WHENEVER THERE IS A DEPT CHANGE COMMIT TAKING PLACE          13032000
130900***  OR SET HOST-VAR TO SPACES WHEN END OF ENT-ID CURSOR          13033000
131000     IF PS-END-OF-ENT-ID-CURSOR                                   13034000
131100        MOVE SPACES           TO VADPT-DEPT-NBR                   13035001
131200     ELSE                                                         13036000
131300        PERFORM 7149-OPEN-ENT-ID-CURSOR                           13037000
131400        PERFORM 7150-FETCH-ENT-ID-CURSOR                          13038000
131600     END-IF.                                                      13039000
131800*                                                                 13040000
131900*                                                                 13050000
132000******************************************************************13060000
132100* 7850-COMMIT-CHANGES.                                            13070000
132200* UPDATE CHECKPOINT INFORMATION TABLE. TAKE A COMMIT.             13080000
132300******************************************************************13090000
132400 7850-COMMIT-CHANGES.                                             13100000
132500                                                                  13110000
132600     EXEC SQL                                                     13120000
132700       UPDATE TCKRSTINF                                           13130000
132800          SET WORK_STRG_DESC = :TCKRSTINF-WORK-STRG-DESC          13140000
132900        WHERE JOB_NAME       = :PC-JOB-NAME                       13150000
133000          AND PLAN_NAME      = :PC-PROGRAM-NAME                   13160000
133100     END-EXEC.                                                    13170000
133200                                                                  13180000
133300     IF SQLCODE = 0                                               13190000
133400         CONTINUE                                                 13200000
133500     ELSE                                                         13210000
133600         MOVE PE-MSG-08                  TO PV-OPERATION-ATTEMPTED13220000
133700         MOVE  '* 7850-COMMIT-CHANGES *' TO PV-PARAGRAPH-NAME     13230000
133800         PERFORM 9999-SQL-ABEND                                   13240000
133900     END-IF.                                                      13250000
134000                                                                  13260000
134100     EXEC SQL                                                     13270000
134200         COMMIT                                                   13280000
134300     END-EXEC.                                                    13290000
134400                                                                  13300000
134500     IF SQLCODE = 0                                               13310000
134600         CONTINUE                                                 13320000
134700     ELSE                                                         13330000
134800         MOVE PE-MSG-09                  TO PV-OPERATION-ATTEMPTED13340000
134900         MOVE  '* 7850-COMMIT-CHANGES *' TO PV-PARAGRAPH-NAME     13350000
135000         PERFORM 9999-SQL-ABEND                                   13360000
135100     END-IF.                                                      13370000
135200*                                                                 13380000
135300*                                                                 13390000
135400******************************************************************13400000
135500* UPDATE CHECKPOINT STATUS                                        13410000
135600******************************************************************13420000
135700 7900-UPDATE-CHECKPOINT-STATUS.                                   13430000
135800                                                                  13440000
135900     EXEC SQL                                                     13450000
136000       UPDATE  TCKRSTCNTL                                         13460000
136100          SET  CKPT_STAT_CODE = :TCKRSTCNTL-CKPT-STAT-CODE        13470000
136200        WHERE  JOB_NAME  = :PC-JOB-NAME                           13480000
136300          AND  PLAN_NAME = :PC-PROGRAM-NAME                       13490000
136400     END-EXEC.                                                    13500000
136500                                                                  13510000
136600     IF SQLCODE = 0                                               13520000
136700         CONTINUE                                                 13530000
136800     ELSE                                                         13540000
136900         MOVE '7900-UPDATE-CHECKPOINT-STATUS' TO PV-PARAGRAPH-NAME13550000
137000         MOVE PE-MSG-10                  TO PV-OPERATION-ATTEMPTED13560000
137100         PERFORM 9999-SQL-ABEND                                   13570000
137200     END-IF.                                                      13580000
137300*                                                                 13590000
137400*                                                                 13600000
147100******************************************************************13610000
147200*  RESET STATUS CODE, DISPLAY FINAL COUNTS , CLOSE INPUT FILE    *13620000
147300******************************************************************13630000
147400 8000-EOJ-ROUTINE.                                                13640000
147500                                                                  13650000
147600***  COMMIT ANY FINAL CHANGES THAT MAY HAVE BEEN MADE             13660000
147700     IF PS-EMPTY-RESULT-TABLE                                     13670000
147800         CONTINUE                                                 13680000
147900     ELSE                                                         13690000
148000         PERFORM 7800-COMMIT-PROCESSING                           13700000
148100     END-IF.                                                      13710000
148200                                                                  13720000
148300     MOVE '0' TO TCKRSTCNTL-CKPT-STAT-CODE.                       13730000
148400     PERFORM 7900-UPDATE-CHECKPOINT-STATUS.                       13740000
148500                                                                  13750000
148600     DISPLAY '                                             '.     13760000
148700     DISPLAY '******* END OF JOB STATISTICS ********'.            13770000
148800     DISPLAY ' '.                                                 13780006
148900     DISPLAY 'DATES PROCESSED        : ', PA-DATE-COUNT.          13790006
149000     DISPLAY 'DEPT ROWS PROCESSED    : ', PA-DEPT-COUNT.          13800006
149100     DISPLAY '  TVADPT ROWS UPDATED  : ', PA-UPDATE-COUNT.        13810006
149200     DISPLAY '  TVADPT ROWS INSERTED : ', PA-INSERT-COUNT.        13820006
149300     DISPLAY ' '.                                                 13830006
149400     DISPLAY '  COMMITS TAKEN        : ', PA-COMMIT-COUNT.        13840006
149500     DISPLAY ' '.                                                 13850006
149600     DISPLAY '*********************** EOJ ********************'.  13860000
149700*                                                                 13870000
149800*                                                                 13880000
149900******************************************************************13890000
150000*  STANDARD DB2 ERROR ABEND ROUTINE                               13900000
150100*  THIS ROUTINE FORCES AN ABEND DUE TO A DB2 PROBLEM.             13910000
150200******************************************************************13920000
150300 9999-SQL-ABEND.                                                  13930000
150400                                                                  13940000
150500     MOVE +4013                 TO ABEND-CODE.                    13950000
150600     DISPLAY '**  ABEND     **'.                                  13960000
150700     DISPLAY '**  PROGRAM   **  = ' PC-PROGRAM-NAME.              13970006
150800     DISPLAY '**  PARAGRAPH **  = ' PV-PARAGRAPH-NAME.            13980000
150900     DISPLAY '**  OPERATION **  = ' PV-OPERATION-ATTEMPTED.       13990000
151000                                                                  14000000
151100***  THE FOLLOWING COPYBOOK UTILIZES THE DB2 ABEND MODULE         14010000
151200***  DSNTIAR TO CONVERT SQLCA INTO UNDERSTANDABLE VERBAGE.        14020000
151300                                                                  14030000
151400     COPY DPPD004.                                                14040000
151500     CALL 'ILBOABN0'  USING ABEND-CODE.                           14050000
151600*                                                                 14060000
151700*                                                                 14070000
