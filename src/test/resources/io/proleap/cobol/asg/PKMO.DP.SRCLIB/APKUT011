000100 IDENTIFICATION DIVISION.                                         00010001
000200 PROGRAM-ID.         APKUT011.                                    00020001
000300 AUTHOR.             NANCY EILBES.                                00030001
000400 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00040001
000500 DATE-WRITTEN.       APRIL 2020.                                  00050001
000600******************************************************************00060001
000700*    ADD PO TYPE CODE TO DAILY TRANSACTION RECORDS.              *00070001
000710*      COBOL WITH SQL                                            *00071001
000720*                                                                *00072001
000730*    THE PURPOSE OF THIS PROGRAM IS TO READ THE DAILY TRANSACTION*00073001
000740*    FILE AND LOOKUP THE PO TYPE CODE FOR ALL RECORDS CONTAINING *00074001
000750*    A PO NUMBER.  RECORDS WILL BE REWRITTEN.                    *00075001
000751*                                                                *00075101
000760*    THIS PROCESS IS NEEDED SO THAT THE ORACLE INTEGRATION CAN   *00076001
000770*    INCLUDE A PAY GROUP OF 'CD' FOR POS WITH TYPE 'CD'.         *00077001
000780*                                                                *00078001
000790*    INPUT:                                                      *00079001
000800*    DAILY AP TRANSACTION FILE                 COPYBOOK APRD040  *00080001
001000*    PURCHASE ORDER DATABASE                   DB2 TABLE TPURCHS *00100001
001100*                                                                *00110001
001200*    OUTPUT:                                                     *00120001
001201*    UPDATED TRANSACTION FILE                  COPYBOOK APRD040  *00120101
001220*                                                                *00122001
001230*----------------------------------------------------------------*00123003
001232* CHANGE LOG:                                                    *00123203
001233* DATE  04/03/2020                                               *00123303
001234*     CHANGE MADE:  INITIAL VERSION.                             *00123403
001235*     MADE BY: NANCY EILBES            WR/IR #: CHG0242385       *00123503
001236******************************************************************00123603
001240 ENVIRONMENT DIVISION.                                            00124001
001250 CONFIGURATION SECTION.                                           00125001
001260 SOURCE-COMPUTER.    IBM-3090.                                    00126001
001270 OBJECT-COMPUTER.    IBM-3090.                                    00127001
001280                                                                  00128001
001290 INPUT-OUTPUT SECTION.                                            00129001
001300 FILE-CONTROL.                                                    00130001
001400                                                                  00140001
001500     SELECT AP-TRANS-FILE            ASSIGN TO INP01.             00150001
001700     SELECT UPDATED-AP-TRANS-FILE    ASSIGN TO OUT01.             00170001
001800                                                                  00180001
001900 DATA DIVISION.                                                   00190001
002000                                                                  00200001
002100 FILE SECTION.                                                    00210001
002200*                                                                 00220001
002300 FD  AP-TRANS-FILE                                                00230001
002400     RECORDING MODE IS F                                          00240001
002500     RECORD CONTAINS 500 CHARACTERS                               00250001
002600     BLOCK CONTAINS 0 RECORDS                                     00260001
002700     LABEL RECORDS ARE STANDARD                                   00270001
002800     DATA RECORD IS AP-TRANS-RECORD.                              00280001
002900*                                                                 00290001
003000 01  AP-TRANS-RECORD              PIC X(500).                     00300001
003100*                                                                 00310001
004100 FD  UPDATED-AP-TRANS-FILE                                        00410001
004200     RECORDING MODE IS F                                          00420001
004300     RECORD CONTAINS 500 CHARACTERS                               00430001
004400     BLOCK CONTAINS 0 RECORDS                                     00440001
004500     LABEL RECORDS ARE STANDARD                                   00450001
004600     DATA RECORD IS UPDATED-RECORD.                               00460001
004700*                                                                 00470001
004800 01  UPDATED-AP-TRANS-RECORD      PIC X(500).                     00480001
004900 EJECT                                                            00490001
005000 WORKING-STORAGE SECTION.                                         00500001
005100                                                                  00510001
005400 01  PROGRAM-VARIABLES.                                           00540001
006100     05  PV-DAILY-COUNT          PIC 9(09)   VALUE ZEROS.         00610001
006200     05  PV-UPDATED-DAILY-COUNT  PIC 9(09)   VALUE ZEROS.         00620001
006300     05  PV-PO-NBR               PIC X(09).                       00630002
006400                                                                  00640001
006500 01  PROGRAM-CONSTANTS.                                           00650001
006600     05  PC-PROGRAM-NAME         PIC X(08)   VALUE 'APKUT011'.    00660001
006700                                                                  00670001
006800 01  END-OF-FILE-NO-DAILY        PIC X(01)   VALUE 'N'.           00680001
006900     88  END-OF-AP-TRANS-FILE                VALUE 'Y'.           00690001
007000                                                                  00700001
007100 01  END-OF-FILE-NO-DOCUMENTS    PIC X(01)   VALUE 'N'.           00710001
007200     88  END-OF-DOCUMENTS-FILE               VALUE 'Y'.           00720001
007300                                                                  00730001
007400 EJECT                                                            00740001
007500*---------------------------------------------------------------* 00750001
007600*    AP DAILY TRANSACTION FILE RECORD LAYOUT                      00760001
007700*---------------------------------------------------------------* 00770001
008000     COPY APRD040.                                                00800001
008100 EJECT                                                            00810001
008200*---------------------------------------------------------------* 00820001
008300*    TPURCHS DCLGEN                                               00830001
008400*---------------------------------------------------------------* 00840001
008500     EXEC SQL                                                     00850001
008600         INCLUDE TPURCHS                                          00860001
008700     END-EXEC.                                                    00870001
008800                                                                  00880001
008900*---------------------------------------------------------------* 00890001
009000*    SQL COMMUNICATIONS AREA DCLGEN                               00900001
009010*---------------------------------------------------------------* 00901001
009020     EXEC SQL                                                     00902001
009030         INCLUDE SQLCA                                            00903001
009040     END-EXEC.                                                    00904001
009050                                                                  00905001
009060                                                                  00906001
009070*----------------------------------------------------------------*00907001
009080*  ABEND DATA AREAS                                              *00908001
009090*----------------------------------------------------------------*00909001
009100 01  ABEND-CODE                  PIC S9(04)  VALUE ZEROS          00910001
009101                                             COMP SYNC.           00910101
009102     88  AC-DB2-ERROR                        VALUE +4013.         00910201
009103                                                                  00910301
009104 01  ABEND-AREAS.                                                 00910401
009105     05  AA-ABEND-LIT            PIC  X(40)  VALUE                00910501
009106             '*****       ABEND'.                                 00910601
009107     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                00910701
009108             '*****   PROGRAM: APKUT011'.                         00910801
009109     05  AA-PARAGRAPH-LIT.                                        00910901
009110         10  FILLER              PIC  X(17)  VALUE                00911001
009111             '***** PARAGRAPH: '.                                 00911101
009112         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        00911201
009113     05  AA-MESSAGE-LINE.                                         00911301
009114         10  FILLER              PIC  X(06)  VALUE '*****'.       00911401
009115         10  AA-MESSAGE          PIC  X(127) VALUE SPACES.        00911501
009116     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                00911601
009117             '*****    DB2 ERROR'.                                00911701
009118     05  AA-DB2-OPERATION-LIT.                                    00911801
009119         10  FILLER              PIC  X(17)  VALUE                00911901
009120             '***** OPERATION: '.                                 00912001
009121         10  AA-DB2-OPERATION.                                    00912101
009122             15  AA-DB2-OP-1     PIC  X(50)  VALUE SPACES.        00912201
009123             15  AA-DB2-OP-2     PIC  X(25)  VALUE SPACES.        00912301
009124     05  AA-DB2-TABLE-1          PIC  X(08)  VALUE SPACES.        00912401
009125     05  AA-DB2-TABLE-2          PIC  X(08)  VALUE SPACES.        00912501
009126     05  AA-DB2-TABLE-3          PIC  X(08)  VALUE SPACES.        00912601
009127     05  AA-DB2-TABLE-4          PIC  X(08)  VALUE SPACES.        00912701
009128     05  AA-DB2-TABLE-5          PIC  X(08)  VALUE SPACES.        00912801
009129                                                                  00912901
009130     COPY  DPWS004.                                               00913001
009131                                                                  00913101
009132 PROCEDURE DIVISION.                                              00913201
009133                                                                  00913301
009134 0000-MAINLINE-PROCESSING.                                        00913401
009135                                                                  00913501
009136     PERFORM B100-HOUSEKEEPING.                                   00913601
009137                                                                  00913701
009138     PERFORM B200-PROCESS-COMPARE                                 00913801
009139       UNTIL END-OF-AP-TRANS-FILE.                                00913901
009150                                                                  00915001
009160     PERFORM B300-END-OF-PROGRAM.                                 00916001
009170                                                                  00917001
009180     GOBACK.                                                      00918001
009190 EJECT                                                            00919001
009200 B100-HOUSEKEEPING.                                               00920001
009300                                                                  00930001
009400     OPEN INPUT  AP-TRANS-FILE                                    00940001
009600          OUTPUT UPDATED-AP-TRANS-FILE.                           00960001
009700                                                                  00970001
009800     INITIALIZE DCLTPURCHS.                                       00980001
009810                                                                  00981001
009900     PERFORM R100-READ-AP-TRANS-FILE.                             00990001
010000*    MOVE AP040-PO-NBR TO PURCHS-PO-NBR.                          01000001
010010*    PERFORM S100-SELECT-PO-TYPE-CODE.                            01001001
010100 EJECT                                                            01010001
010200 B200-PROCESS-COMPARE.                                            01020001
010300                                                                  01030001
010400     IF  AP040-PO-NBR = SPACES                                    01040001
010401     OR  AP040-PO-NBR = ZEROES                                    01040101
010402         PERFORM W100-WRITE-UPDATED-TRANS-FILE                    01040202
010403         PERFORM R100-READ-AP-TRANS-FILE                          01040301
010404     ELSE                                                         01040401
010410         IF  AP040-PO-NBR = PV-PO-NBR                             01041002
010420             MOVE SPACES            TO AP040-BAR-CDE              01042001
010430             MOVE PURCHS-PO-TYP-CDE TO AP040-PO-TYP-CDE           01043001
010450             PERFORM W100-WRITE-UPDATED-TRANS-FILE                01045002
010460             PERFORM R100-READ-AP-TRANS-FILE                      01046001
011970         ELSE                                                     01197001
011971             MOVE AP040-PO-NBR TO PURCHS-PO-NBR                   01197101
011972                                  PV-PO-NBR                       01197202
011973             PERFORM S100-SELECT-PO-TYPE-CODE                     01197302
011974             MOVE SPACES            TO AP040-BAR-CDE              01197402
011975             MOVE PURCHS-PO-TYP-CDE TO AP040-PO-TYP-CDE           01197502
011976             PERFORM W100-WRITE-UPDATED-TRANS-FILE                01197602
011977             PERFORM R100-READ-AP-TRANS-FILE                      01197702
012700         END-IF                                                   01270001
012701     END-IF.                                                      01270101
012702                                                                  01270201
012900 EJECT                                                            01290001
013000 B300-END-OF-PROGRAM.                                             01300001
013100                                                                  01310001
014600     DISPLAY '**  APKUT011 COUNTS  **'.                           01460001
014800     DISPLAY 'DAILY FILE RECS READ   = ' PV-DAILY-COUNT.          01480001
014900     DISPLAY 'UNMATCHED DAILY WRITTEN = ' PV-UPDATED-DAILY-COUNT. 01490001
015000                                                                  01500001
015100     CLOSE AP-TRANS-FILE                                          01510001
015300           UPDATED-AP-TRANS-FILE.                                 01530001
015400                                                                  01540001
015500 EJECT                                                            01550001
015600 R100-READ-AP-TRANS-FILE.                                         01560001
015700                                                                  01570001
015800     IF NOT END-OF-AP-TRANS-FILE                                  01580001
015900         READ AP-TRANS-FILE INTO AP040-TRANSACTION-FILE           01590001
016000           AT END                                                 01600001
016100              SET END-OF-AP-TRANS-FILE TO TRUE                    01610001
016300     END-IF.                                                      01630001
016400                                                                  01640001
016640     IF NOT END-OF-AP-TRANS-FILE                                  01664001
016650        ADD +1 TO PV-DAILY-COUNT                                  01665001
016660     END-IF.                                                      01666001
018300 EJECT                                                            01830001
018400*----------------------------------------------------------------*01840001
018500*    RETRIEVES THE PO TYPE CODE.                                 *01850001
018600*----------------------------------------------------------------*01860001
018700 S100-SELECT-PO-TYPE-CODE.                                        01870001
018900                                                                  01890001
019000     EXEC SQL                                                     01900001
019100       SELECT PO_TYP_CDE                                          01910001
019500         INTO :PURCHS-PO-TYP-CDE                                  01950001
019900         FROM TPURCHS                                             01990001
019910        WHERE PO_NBR = :PURCHS-PO-NBR                             01991001
019920          AND VER_STATUS_CDE = 'A'                                01992001
020000     END-EXEC.                                                    02000001
020100                                                                  02010001
020200     EVALUATE TRUE                                                02020001
020300         WHEN SQLCODE = ZERO                                      02030001
020400              CONTINUE                                            02040001
020500         WHEN SQLWARN0 NOT = SPACES                               02050001
020600         WHEN SQLCODE  NOT = ZERO                                 02060001
020700             MOVE 'S100-SELECT-PO-TYPE-CODE' TO AA-PARAGRAPH-NAME 02070001
020800             MOVE 'UNSUCCESSFUL SELECT ON TPURCHS' TO AA-DB2-OP-1 02080001
020900             MOVE 'TPURCHS'   TO AA-DB2-TABLE-1                   02090001
021000             PERFORM Z998-DB2-ABEND                               02100001
021100     END-EVALUATE.                                                02110001
021200 EJECT                                                            02120001
021210                                                                  02121001
021220 W100-WRITE-UPDATED-TRANS-FILE.                                   02122002
021230                                                                  02123001
021240     WRITE UPDATED-AP-TRANS-RECORD FROM AP040-TRANSACTION-FILE.   02124001
021250     ADD +1 TO PV-UPDATED-DAILY-COUNT.                            02125001
021260                                                                  02126001
021270 EJECT                                                            02127001
021300*----------------------------------------------------------------*02130001
021400*    ABEND ROUTINE FOR DB2 ERRORS                                *02140001
021500*----------------------------------------------------------------*02150001
021600 Z998-DB2-ABEND.                                                  02160001
021700                                                                  02170001
021800     DISPLAY AA-ABEND-LIT.                                        02180001
021900     DISPLAY AA-DB2-ERROR-LIT.                                    02190001
022000     DISPLAY AA-PROGRAM-LIT.                                      02200001
022100     DISPLAY AA-PARAGRAPH-LIT.                                    02210001
022200     DISPLAY AA-DB2-OPERATION-LIT.                                02220001
022300     DISPLAY AA-DB2-TABLE-1.                                      02230001
022400     SET AC-DB2-ERROR TO TRUE.                                    02240001
022500                                                                  02250001
022600     COPY  DPPD004.                                               02260001
022700                                                                  02270001
022800     CALL 'ILBOABN0' USING ABEND-CODE.                            02280001
