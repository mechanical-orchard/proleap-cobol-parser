000500 IDENTIFICATION DIVISION.                                         00050002
000600 PROGRAM-ID.    AHKUT049.                                         00060002
000700 AUTHOR.        PATRICK BURKE.                                    00070002
000800 INSTALLATION.  KOHLS.                                            00080002
000900 DATE-WRITTEN   MAY, 2000.                                        00090002
001000 DATE-COMPILED.                                                   00100002
001100                                                                  00110002
001200* ************************************************************** *00120002
001300* * AHKUT049.  "ARCHIVE HISTORY" PROJECT.  EXTRACT PROGRAM.    * *00130002
001400* *                                                            * *00140002
001500* * PURPOSE:                                                   * *00150002
001600* * THIS PROGRAM CREATES AN EXTRACT FILE FROM: TPKITEM         * *00160003
001700* * THIS EXTRACT FILE CONSISTS OF ROWS ELIGIBLE TO BE:         * *00170002
001800* * 1) LOADED TO THE "ARCHIVE/HISTORY" VERSIONS OF THE TABLES. * *00180002
001900* * 2) DELETED FROM THE OPERATIONAL VERSIONS OF THE TABLES.    * *00190002
002000* *                                                            * *00200002
002100* * PROCESSING OVERVIEW:                                       * *00210002
002200* * THIS PROGRAM READS A "DRIVER" FILE. FOR EACH RECORD READ,  * *00220002
002300* * 1) INCREMENT COUNT OF RECORDS READ.                        * *00230002
002400* * 2) ATTEMPT TO FIND RELATED ROW(S) ON THE TABLE.            * *00240002
002500* *    2.A) IF NO MATCH(ES):                                   * *00250002
002600* *         2.A.1) PROCESSING CONTINUES                        * *00260002
002700* *         2.A.2) DO NOT PERFORM ERROR/REPORTING ROUTINES;    * *00270002
002800* *                THIS SYSTEM DOES NOT CLEANSE DATA NOR REPORT* *00280002
002900* *                ON UNCLEAN DATA.  IT SIMPLY MIGRATES        * *00290002
003000* *                CONDITIONS OCCURRING IN OPERATIONAL         * *00300002
003100* *                TABLES OVER TO THE ARCHIVE/HISTORY TABLES.  * *00310002
003200* *    2.B) IF MATCH(ES):                                      * *00320002
003300* *         2.B.1) INCREMENT COUNT OF ROW(S) FOUND.            * *00330002
003400* *         2.B.2) WRITE THESE ROW(S) TO THE EXTRACT FILE.     * *00340002
003500* *         2.B.3) INCREMENT COUNT OF RECORDS WRITTEN.         * *00350002
003600* *         2.B.4) DO NOT REMOVE THE ROW(S) FROM THE TABLE     * *00360002
003700* *                AT THIS TIME.  THEY WILL BE REMOVED IN OTHER* *00370002
003800* *                PROCESSING, AFTER HAVING BEEN LOADED TO THE * *00380002
003900* *                ARCHIVE/HISTORY TABLE.                      * *00390002
004000* * 3) EVERY NTH RECORD (IE: INITIAL SETTING 1000), REPORT     * *00400002
004100* *    RECORD COUNT AND CURRENT DATE/TIME.  THIS WILL ASSIST   * *00410002
004200* *    WITH RUN-TIME ESTIMATE OF TIME REMAINING TO COMPLETE.   * *00420002
004300* ************************************************************** *00430002
004400 ENVIRONMENT DIVISION.                                            00440002
004500 CONFIGURATION SECTION.                                           00450002
004600 SOURCE-COMPUTER.        IBM-3090.                                00460002
004700 OBJECT-COMPUTER.        IBM-3090.                                00470002
004800                                                                  00480002
004900 INPUT-OUTPUT SECTION.                                            00490002
005000 FILE-CONTROL.                                                    00500002
005100                                                                  00510002
005200     SELECT IN-DRIVER-FILE                ASSIGN TO IN01.         00520002
005300     SELECT OUT-EXTRACT-FILE              ASSIGN TO OUT01.        00530002
005400                                                                  00540002
005500******************************************************************00550002
005600 DATA DIVISION.                                                   00560002
005700 FILE SECTION.                                                    00570002
005800                                                                  00580002
005900 FD  IN-DRIVER-FILE                                               00590002
006000     RECORDING MODE IS F                                          00600002
006100     LABEL RECORDS ARE STANDARD                                   00610002
006200     BLOCK CONTAINS 0 RECORDS.                                    00620002
006300 01  IN-DRIVER-RECORD                PIC  X(004).                 00630002
006400                                                                  00640002
006500**** TPKITEM:                                                     00650004
006600 FD  OUT-EXTRACT-FILE                                             00660002
006700     RECORDING MODE IS F                                          00670002
006800     LABEL RECORDS ARE STANDARD                                   00680002
006900     BLOCK CONTAINS 0 RECORDS.                                    00690002
007000 01  OUT-EXTRACT-RECORD              PIC  X(053).                 00700005
007100                                                                  00710002
007200                                                                  00720002
007300                                                                  00730002
007400 WORKING-STORAGE SECTION.                                         00740002
007500                                                                  00750002
007600 01  PC-PROGRAM-CONSTANTS.                                        00760002
007700     05  PC-CURRENT-PROGRAM-NAME     PIC X(08) VALUE 'AHKUT049'.  00770002
007800     05  PC-PGM-PROGRESS-DESC.                                    00780002
007900         10  PC-BEGINNING            PIC X(09) VALUE 'BEGINNING'. 00790002
008000         10  PC-CONTINUING           PIC X(10) VALUE              00800002
008100                                               'CONTINUING'.      00810002
008200         10  PC-ENDING               PIC X(06) VALUE 'ENDING'.    00820002
008300         10  PC-ABENDING             PIC X(08) VALUE 'ABENDING'.  00830002
008400     05  PC-ABEND-INFO.                                           00840002
008500         10  PC-ABEND                PIC X(11) VALUE              00850002
008600                                               '** ABEND **'.     00860002
008700         10  PC-ABEND-MSG-PARA       PIC X(15) VALUE              00870002
008800                                               '- PARA       : '. 00880002
008900         10  PC-ABEND-MSG-DISPLAY-PARA                            00890002
009000                                     PIC X(15) VALUE              00900002
009100                                               '  CALLED PARA: '. 00910002
009200         10  PC-ABEND-MSG-NUMBER     PIC X(15) VALUE              00920002
009300                                               '  FOR ABEND# : '. 00930002
009400         10  PC-ABEND-MSG-DESC       PIC X(15) VALUE              00940002
009500                                               '- ERROR IS   : '. 00950002
009600         10  PC-ABEND-MSG-INDENT-15  PIC X(15) VALUE SPACES.      00960002
009700         10  PC-ABEND-MSG-ACTION     PIC X(15) VALUE              00970002
009800                                               '- ACTION     : '. 00980002
009900     05  PC-HOW-OFTEN-TO-DISPLAY     PIC 9(9)  VALUE 5000.        00990002
010000                                                                  01000002
010100 01  PS-PROGRAM-SWITCHES.                                         01010002
010200     05  PS-IN-DRIVER-EOF-SW         PIC X(01) VALUE 'N'.         01020002
010300         88  PS-IN-DRIVER-EOF                  VALUE 'Y'.         01030002
010400         88  PS-IN-DRIVER-NOT-EOF              VALUE 'N'.         01040002
010500     05  PS-CURSOR-HAS-DATA-SW       PIC X(01) VALUE 'N'.         01050002
010600         88  PS-CURSOR-HAS-DATA                VALUE 'Y'.         01060002
010700         88  PS-CURSOR-HAS-NO-DATA             VALUE 'N'.         01070002
010800     05  PS-TABLE-LOOP-DONE-SW       PIC X(01) VALUE 'N'.         01080002
010900         88  PS-TABLE-LOOP-DONE                VALUE 'Y'.         01090002
011000         88  PS-TABLE-LOOP-NOT-DONE            VALUE 'N'.         01100002
011100                                                                  01110002
011200 01  PV-PROGRAM-VARIABLES.                                        01120002
011300     05  PV-PO-NBR-COMP              PIC S9(9) VALUE 0 COMP.      01130002
011400     05  PV-PO-NBR-NUM               PIC  9(9) VALUE 0.           01140002
011500     05  PV-IN-DRIVER-RECS-READ-CNT  PIC  9(9) VALUE 0.           01150002
011600     05  PV-RECS-WITH-MATCHES-CNT    PIC  9(9) VALUE 0.           01160002
011700     05  PV-TABLE-ROW-SELECT-CNT     PIC  9(9) VALUE 0.           01170002
011800     05  PV-EXTRACT-WRITTEN-CNT      PIC  9(9) VALUE 0.           01180002
011900                                                                  01190002
012000     05  PV-PARAGRAPH-NAME           PIC X(30) VALUE SPACES.      01200002
012100     05  PV-DB2-OPERATION-MSG-1      PIC X(79) VALUE SPACES.      01210002
012200     05  PV-DB2-TABLE-NAME           PIC X(18) VALUE SPACES.      01220002
012300     05  PV-DISPLAY-NTH-MULTIPLE     PIC 9(9)  VALUE 0.           01230002
012400     05  PV-DISPLAY-NTH-REMAINDER    PIC 9(9)  VALUE 0.           01240002
012500     05  PV-SQLCODE                  PIC +999  VALUE ZERO.        01250002
012600                                                                  01260002
012700     05  PV-TMST                     PIC X(26) VALUE SPACES.      01270002
012800     05  PV-TIMESTAMP-DETAIL                                      01280002
012900         REDEFINES                                                01290002
013000         PV-TMST.                                                 01300002
013100         10  PV-TIMESTAMP-19.                                     01310002
013200             15  PV-TMS-DATE.                                     01320002
013300                 20  PV-TMS-YEAR.                                 01330002
013400                     25  PV-TMS-CC   PIC X(02).                   01340002
013500                     25  PV-TMS-YY   PIC X(02).                   01350002
013600                 20  FILLER          PIC X(01).                   01360002
013700                 20  PV-TMS-MONTH    PIC X(02).                   01370002
013800                 20  FILLER          PIC X(01).                   01380002
013900                 20  PV-TMS-DAY      PIC X(02).                   01390002
014000             15  FILLER              PIC X(01).                   01400002
014100             15  PV-TMS-HOUR         PIC X(02).                   01410002
014200             15  FILLER              PIC X(01).                   01420002
014300             15  PV-TMS-MINUTE       PIC X(02).                   01430002
014400             15  FILLER              PIC X(01).                   01440002
014500             15  PV-TMS-SECOND       PIC X(02).                   01450002
014600         10  FILLER                  PIC X(01).                   01460002
014700         10  PV-TMS-MSECOND          PIC X(06).                   01470002
014800                                                                  01480002
014900 01  DM-DISPLAY-MESSAGE.                                          01490002
015000     05  DM-01-10.                                                01500002
015100         10  DM-PROGRAM              PIC X(08) VALUE SPACE.       01510002
015200         10  FILLER                  PIC X(02) VALUE ': '.        01520002
015300     05  DM-11-80.                                                01530002
015400         10  FILLER                  PIC X(37) VALUE              01540002
015500                        'SELECT ROWS MATCHING PO DRIVER FILE, '.  01550002
015600         10  FILLER                  PIC X(30) VALUE              01560002
015700                        'CREATING TPKSLIP EXTRACT FILE.'.         01570002
015800         10  FILLER                  PIC X(01) VALUE SPACE.       01580002
015900         10  FILLER                  PIC X(01) VALUE ALL '*'.     01590002
016000     05  DM-81-120.                                               01600002
016100         10  FILLER                  PIC X(40) VALUE ALL '*'.     01610002
016200                                                                  01620002
016300 01  DP-DISPLAY-PROGRESS-MSG.                                     01630002
016400     05  DP-PROGRAM                  PIC X(08) VALUE SPACE.       01640002
016500     05  FILLER                      PIC X(02) VALUE SPACE.       01650002
016600     05  DP-STATUS-DESCRIPTION       PIC X(10) VALUE SPACE.       01660002
016700     05  FILLER                      PIC X(04) VALUE ' AT '.      01670002
016800     05  DP-TIMESTAMP-19             PIC X(19) VALUE SPACE.       01680002
016900     05  FILLER                      PIC X(03) VALUE '.  '.       01690002
017000     05  FILLER                      PIC X(03) VALUE              01700002
017100                                         'IN:'.                   01710002
017200     05  DP-IN-CNT                   PIC ZZZ,ZZZ,ZZ9              01720002
017300                                               VALUE ZERO.        01730002
017400     05  FILLER                      PIC X(02) VALUE ', '.        01740002
017500*    05  FILLER                      PIC X(16) VALUE              01750002
017600*                                        'DRIVER W/ROW(S):'.      01760002
017700*    05  DP-MATCHES-FOUND-CNT        PIC ZZZ,ZZZ,ZZ9              01770002
017800*                                              VALUE ZERO.        01780002
017900*    05  FILLER                      PIC X(02) VALUE ', '.        01790002
018000     05  FILLER                      PIC X(14) VALUE              01800002
018100                                         'ROWS SELECTED:'.        01810002
018200     05  DP-ROWS-SELECTED-CNT        PIC ZZZ,ZZZ,ZZ9              01820002
018300                                               VALUE ZERO.        01830002
018400     05  FILLER                      PIC X(02) VALUE ', '.        01840002
018500     05  FILLER                      PIC X(04) VALUE              01850002
018600                                         'OUT:'.                  01860002
018700     05  DP-OUT-CNT                  PIC ZZZ,ZZZ,ZZ9              01870002
018800                                               VALUE ZERO.        01880002
018900     05  FILLER                      PIC X(01) VALUE '.'.         01890002
019000                                                                  01900002
019100 01  ABEND-CODE                      PIC S9(04)                   01910002
019200                                               VALUE ZEROES       01920002
019300                                               COMP SYNC.         01930002
019400                                                                  01940002
019500*---------------------------------------------------------------* 01950002
019600*  DB2 FORMATTED MESSAGE AREA                                     01960002
019700*---------------------------------------------------------------* 01970002
019800     COPY DPWS004.                                                01980002
019900                                                                  01990002
020000                                                                  02000002
020100*---------------------------------------------------------------* 02010002
020200*  AHRD002  - RECORD LAYOUT FOR PO DRIVER FILE, INPUT.          * 02020002
020300*---------------------------------------------------------------* 02030002
020400     COPY AHRD002.                                                02040002
020500                                                                  02050002
020600                                                                  02060002
020700*---------------------------------------------------------------* 02070002
020800*    DB2 AREA FOR TPKITEM                                       * 02080002
020900*---------------------------------------------------------------* 02090002
021000     EXEC SQL                                                     02100002
021100          INCLUDE TPKITEM                                         02110002
021200     END-EXEC.                                                    02120002
021300                                                                  02130002
021400*---------------------------------------------------------------* 02140002
021500*    DB2 AREA FOR COMMUNICATIONS                                * 02150002
021600*---------------------------------------------------------------* 02160002
021700     EXEC SQL                                                     02170002
021800          INCLUDE SQLCA                                           02180002
021900     END-EXEC.                                                    02190002
022000                                                                  02200002
022100*---------------------------------------------------------------* 02210002
022200*    DEFINE CURSOR FOR TPKITEM :                                * 02220002
022300*    PULL ALL AVAILABLE COLUMNS, SO EXTRACT FILE WILL CONTAIN   * 02230002
022400*    ALL DATA TO POPULATE "ARCHIVE HISTORY" COPY OF THIS TABLE. * 02240002
022500*---------------------------------------------------------------* 02250002
022600     EXEC SQL                                                     02260002
022700          DECLARE TABLE-CURSOR CURSOR FOR                         02270002
022800           SELECT PO_NBR                                          02280002
022900                 ,SEQ_NBR                                         02290002
022910                 ,PKSL_LNE_NBR                                    02291002
023000                 ,CRE_TMST                                        02300002
023100                 ,VER_STAT_CDE                                    02310002
023110                 ,PKSL_ITM_QTY                                    02311002
023200                 ,CRE_UID                                         02320002
023300                 ,PURITM_VER_NBR                                  02330002
025000           FROM   TPKITEM                                         02500002
025100          WHERE  (PO_NBR = :PV-PO-NBR-COMP)                       02510002
025200*      ORDER BY                                                   02520002
025300            FOR  FETCH ONLY                                       02530002
025400           WITH  UR                                               02540002
025500     END-EXEC.                                                    02550002
025600                                                                  02560002
025700                                                                  02570002
025800 PROCEDURE DIVISION.                                              02580002
025900********************                                              02590002
026000                                                                  02600002
026100 0000-PROGRAM-MAINLINE.                                           02610002
026200                                                                  02620002
026300     PERFORM 1000-INITIALIZE.                                     02630002
026400                                                                  02640002
026500     SET PS-IN-DRIVER-NOT-EOF TO TRUE.                            02650002
026600     PERFORM 2000-PROCESS-DRIVER-FILE                             02660002
026700         UNTIL PS-IN-DRIVER-EOF.                                  02670002
026800                                                                  02680002
026900     PERFORM 6000-EOJ-ROUTINE.                                    02690002
027000     STOP RUN.                                                    02700002
027100                                                                  02710002
027200                                                                  02720002
027300* ************************************************************** *02730002
027400* * INITIALIZATIONS                                            * *02740002
027500* ************************************************************** *02750002
027600 1000-INITIALIZE.                                                 02760002
027700                                                                  02770002
027800     MOVE PC-CURRENT-PROGRAM-NAME TO DM-PROGRAM.                  02780002
027900     DISPLAY DM-DISPLAY-MESSAGE.                                  02790002
028000                                                                  02800002
028100     MOVE PC-BEGINNING              TO DP-STATUS-DESCRIPTION.     02810002
028200     PERFORM 6200-DISPLAY-PGM-PROGRESS.                           02820002
028300                                                                  02830002
028400     PERFORM 9000-OPEN-IN-DRIVER-FILE.                            02840002
028500     PERFORM 9700-OPEN-OUT-EXTRACT-FILE.                          02850002
028600                                                                  02860002
028700                                                                  02870002
028800* ************************************************************** *02880002
028900* * 1) GET NEXT RECORD FROM DRIVER FILE, AND                   * *02890002
029000* *    1A- POPULATE KEY (WHERE CLAUSE) FOR TABLE CURSOR        * *02900002
029100* *    1B- OPEN TABLE CURSOR                                   * *02910002
029200* *    1C- LOOP THRU TABLE CURSOR TO EXTRACT ALL               * *02920002
029300* *        ROWS FOR THIS INPUT DRIVER RECORD                   * *02930002
029400* *    2) FOR EACH ROW,                                        * *02940002
029500* *       2A- INCREMENT COUNTS                                 * *02950002
029600* *       2B- WRITE EXTRACT RECORD                             * *02960002
029700* *    1D- CLOSE TABLE CURSOR                                  * *02970002
029800* ************************************************************** *02980002
029900 2000-PROCESS-DRIVER-FILE.                                        02990002
030000                                                                  03000002
030100     PERFORM 9050-READ-IN-DRIVER-FILE.                            03010002
030200     IF PS-IN-DRIVER-EOF                                          03020002
030300         CONTINUE                                                 03030002
030400     ELSE                                                         03040002
030500         MOVE AH002-PO-NBR TO         PV-PO-NBR-COMP              03050002
030600                                      PV-PO-NBR-NUM               03060002
030700         PERFORM 2100-CHECK-PGM-PROGRESS                          03070002
030800         SET PS-TABLE-LOOP-NOT-DONE   TO TRUE                     03080002
030900         SET PS-CURSOR-HAS-NO-DATA    TO TRUE                     03090002
031000         PERFORM 9100-OPEN-TABLE-CURSOR                           03100002
031100         PERFORM 3000-EXTRACT-ROWS-FROM-TABLE                     03110002
031200             UNTIL PS-TABLE-LOOP-DONE                             03120002
031300         PERFORM 9190-CLOSE-TABLE-CURSOR                          03130002
031400     END-IF.                                                      03140002
031500                                                                  03150002
031600                                                                  03160002
031700* ************************************************************** *03170002
031800* *    EVERY NTH RECORD (IE: INITIAL SETTING 1000), REPORT     * *03180002
031900* *    RECORD COUNT AND CURRENT DATE/TIME.  THIS WILL ASSIST   * *03190002
032000* *    WITH RUN-TIME ESTIMATE OF TIME REMAINING TO COMPLETE.   * *03200002
032100* ************************************************************** *03210002
032200 2100-CHECK-PGM-PROGRESS.                                         03220002
032300     DIVIDE    PV-IN-DRIVER-RECS-READ-CNT                         03230002
032400         BY        PC-HOW-OFTEN-TO-DISPLAY                        03240002
032500         GIVING    PV-DISPLAY-NTH-MULTIPLE                        03250002
032600         REMAINDER PV-DISPLAY-NTH-REMAINDER.                      03260002
032700                                                                  03270002
032800     IF PV-DISPLAY-NTH-REMAINDER = ZERO                           03280002
032900         MOVE PC-CONTINUING         TO DP-STATUS-DESCRIPTION      03290002
033000         PERFORM 6200-DISPLAY-PGM-PROGRESS                        03300002
033100     END-IF.                                                      03310002
033200                                                                  03320002
033300                                                                  03330002
033400* ************************************************************** *03340002
033500* * EXTRACT ROWS FROM TABLE, FOR THE CURRENT DRIVER RECORD     * *03350002
033600* ************************************************************** *03360002
033700 3000-EXTRACT-ROWS-FROM-TABLE.                                    03370002
033800     INITIALIZE DCLTPKITEM.                                       03380002
033900     PERFORM 9150-FETCH-TABLE-CURSOR.                             03390002
034000     IF PS-TABLE-LOOP-DONE                                        03400002
034100         CONTINUE                                                 03410002
034200     ELSE                                                         03420002
034300         PERFORM 9750-WRITE-EXTRACT-RECORD                        03430002
034400     END-IF.                                                      03440002
034500                                                                  03450002
034600                                                                  03460002
034700* ************************************************************** *03470002
034800* * DISPLAY END OF RUN MESSAGE, CLOSE THE OUTPUT FILES         * *03480002
034900* ************************************************************** *03490002
035000 6000-EOJ-ROUTINE.                                                03500002
035100                                                                  03510002
035200     PERFORM 9090-CLOSE-IN-DRIVER-FILE.                           03520002
035300     PERFORM 9790-CLOSE-OUT-EXTRACT-FILE.                         03530002
035400                                                                  03540002
035500     MOVE PC-ENDING                 TO DP-STATUS-DESCRIPTION.     03550002
035600     PERFORM 6200-DISPLAY-PGM-PROGRESS.                           03560002
035700                                                                  03570002
035800                                                                  03580002
035900* ************************************************************** *03590002
036000* * DISPLAY PROGRAM PROGRESS.                                  * *03600002
036100* ************************************************************** *03610002
036200 6200-DISPLAY-PGM-PROGRESS.                                       03620002
036300                                                                  03630002
036400     EXEC SQL                                                     03640002
036500          SET :PV-TMST = CURRENT TIMESTAMP                        03650002
036600     END-EXEC.                                                    03660002
036700                                                                  03670002
036800     MOVE PC-CURRENT-PROGRAM-NAME   TO DP-PROGRAM.                03680002
036900     MOVE PV-TIMESTAMP-19           TO DP-TIMESTAMP-19.           03690002
037000     MOVE PV-IN-DRIVER-RECS-READ-CNT                              03700002
037100                                    TO DP-IN-CNT.                 03710002
037200*    MOVE PV-RECS-WITH-MATCHES-CNT  TO DP-MATCHES-FOUND-CNT.      03720002
037300     MOVE PV-TABLE-ROW-SELECT-CNT   TO DP-ROWS-SELECTED-CNT.      03730002
037400     MOVE PV-EXTRACT-WRITTEN-CNT    TO DP-OUT-CNT.                03740002
037500                                                                  03750002
037600     DISPLAY DP-DISPLAY-PROGRESS-MSG.                             03760002
037700                                                                  03770002
037800                                                                  03780002
037900* ************************************************************** *03790002
038000* * FILE AND DB2 TABLE ACCESS PARAGRAPHS.                      * *03800002
038100* * 90XX- INPUT:  DRIVER FILE                                  * *03810002
038200* * 91XX- INPUT:  TABLE CURSOR                                 * *03820002
038300* * 97XX- OUTPUT: TABLE EXTRACT                                * *03830002
038400* ************************************************************** *03840002
038500                                                                  03850002
038600* ************************************************************** *03860002
038700* * OPEN  INPUT DRIVER FILE                                    * *03870002
038800* ************************************************************** *03880002
038900 9000-OPEN-IN-DRIVER-FILE.                                        03890002
039000     OPEN  INPUT  IN-DRIVER-FILE.                                 03900002
039100                                                                  03910002
039200                                                                  03920002
039300* ************************************************************** *03930002
039400* * READ  INPUT DRIVER FILE OF ELIGIBLE DATA TO EXTRACT        * *03940002
039500* ************************************************************** *03950002
039600 9050-READ-IN-DRIVER-FILE.                                        03960002
039700     READ IN-DRIVER-FILE                                          03970002
039800          INTO AH002-DRIVER-RECORD-LAYOUT                         03980002
039900          AT END                                                  03990002
040000              SET PS-IN-DRIVER-EOF TO TRUE.                       04000002
040100                                                                  04010002
040200     IF PS-IN-DRIVER-EOF                                          04020002
040300         CONTINUE                                                 04030002
040400     ELSE                                                         04040002
040500         ADD +1 TO PV-IN-DRIVER-RECS-READ-CNT                     04050002
040600     END-IF.                                                      04060002
040700                                                                  04070002
040800                                                                  04080002
040900* ************************************************************** *04090002
041000* * CLOSE INPUT DRIVER FILE                                    * *04100002
041100* ************************************************************** *04110002
041200 9090-CLOSE-IN-DRIVER-FILE.                                       04120002
041300     CLOSE IN-DRIVER-FILE.                                        04130002
041400                                                                  04140002
041500                                                                  04150002
041600* ************************************************************** *04160002
041700* * OPEN  TABLE CURSOR                                         * *04170002
041800* ************************************************************** *04180002
041900 9100-OPEN-TABLE-CURSOR.                                          04190002
042000     EXEC SQL                                                     04200002
042100          OPEN TABLE-CURSOR                                       04210002
042200     END-EXEC.                                                    04220002
042300                                                                  04230002
042400     EVALUATE TRUE                                                04240002
042500         WHEN SQLCODE = ZERO                                      04250002
042600              ADD +1 TO PV-RECS-WITH-MATCHES-CNT                  04260002
042700              SET PS-CURSOR-HAS-DATA TO TRUE                      04270002
042800         WHEN SQLCODE = +100                                      04280002
042900              SET PS-TABLE-LOOP-DONE TO TRUE                      04290002
043000         WHEN SQLWARN0 NOT EQUAL SPACE                            04300002
043100         WHEN SQLCODE  NOT EQUAL ZERO                             04310002
043200              MOVE '9100-OPEN-TABLE-CURSOR'                       04320002
043300                                 TO PV-PARAGRAPH-NAME             04330002
043400              MOVE 'OPEN TABLE CURSOR'                            04340002
043500                                 TO PV-DB2-OPERATION-MSG-1        04350002
043600              MOVE 'TPKITEM'     TO PV-DB2-TABLE-NAME             04360002
043700              PERFORM 9999-DB2-ABEND                              04370002
043800     END-EVALUATE.                                                04380002
043900                                                                  04390002
044000                                                                  04400002
044100* ************************************************************** *04410002
044200* * FETCH TABLE CURSOR                                         * *04420002
044300* ************************************************************** *04430002
044400 9150-FETCH-TABLE-CURSOR.                                         04440002
044500     EXEC SQL                                                     04450002
044600         FETCH TABLE-CURSOR                                       04460002
044700          INTO  :PKITEM-PO-NBR                                    04470002
044800               ,:PKITEM-SEQ-NBR                                   04480002
044900               ,:PKITEM-PKSL-LNE-NBR                              04490002
045000               ,:PKITEM-CRE-TMST                                  04500002
045100               ,:PKITEM-VER-STAT-CDE                              04510002
045200               ,:PKITEM-PKSL-ITM-QTY                              04520002
045300               ,:PKITEM-CRE-UID                                   04530002
045400               ,:PKITEM-PURITM-VER-NBR                            04540002
046700                                                                  04670002
046800     END-EXEC.                                                    04680002
046900                                                                  04690002
047000     EVALUATE TRUE                                                04700002
047100         WHEN SQLCODE = ZERO                                      04710002
047200              ADD +1                 TO PV-TABLE-ROW-SELECT-CNT   04720002
047300              SET PS-CURSOR-HAS-DATA TO TRUE                      04730002
047400         WHEN SQLCODE = +100                                      04740002
047500              SET PS-TABLE-LOOP-DONE TO TRUE                      04750002
047600         WHEN SQLWARN0 NOT EQUAL SPACE                            04760002
047700         WHEN SQLCODE NOT EQUAL ZERO                              04770002
047800              MOVE '9150-FETCH-TABLE-CURSOR'                      04780002
047900                                 TO PV-PARAGRAPH-NAME             04790002
048000              MOVE 'FETCH TABLE CURSOR'                           04800002
048100                                 TO PV-DB2-OPERATION-MSG-1        04810002
048200              MOVE 'TPKITEM'     TO PV-DB2-TABLE-NAME             04820002
048300              PERFORM 9999-DB2-ABEND                              04830002
048400     END-EVALUATE.                                                04840002
048500                                                                  04850002
048600                                                                  04860002
048700* ************************************************************** *04870002
048800* * CLOSE TABLE CURSOR                                         * *04880002
048900* ************************************************************** *04890002
049000 9190-CLOSE-TABLE-CURSOR.                                         04900002
049100     EXEC SQL                                                     04910002
049200          CLOSE TABLE-CURSOR                                      04920002
049300     END-EXEC.                                                    04930002
049400                                                                  04940002
049500     EVALUATE TRUE                                                04950002
049600         WHEN SQLCODE = ZERO                                      04960002
049700              CONTINUE                                            04970002
049800         WHEN SQLWARN0 NOT EQUAL SPACE                            04980002
049900         WHEN SQLCODE NOT EQUAL ZERO                              04990002
050000              MOVE '9190-CLOSE-TABLE-CURSOR'                      05000002
050100                                 TO PV-PARAGRAPH-NAME             05010002
050200              MOVE 'CLOSE TABLE CURSOR'                           05020002
050300                                 TO PV-DB2-OPERATION-MSG-1        05030002
050400              MOVE 'TPKITEM'     TO PV-DB2-TABLE-NAME             05040002
050500              PERFORM 9999-DB2-ABEND                              05050002
050600     END-EVALUATE.                                                05060002
050700                                                                  05070002
050800                                                                  05080002
050900* ************************************************************** *05090002
051000* * OPEN OUTPUT EXTRACT FILE                                   * *05100002
051100* ************************************************************** *05110002
051200 9700-OPEN-OUT-EXTRACT-FILE.                                      05120002
051300     OPEN OUTPUT OUT-EXTRACT-FILE.                                05130002
051400                                                                  05140002
051500                                                                  05150002
051600* ************************************************************** *05160002
051700* * WRITE A RECORD TO THE TABLE EXTRACT FILE                   * *05170002
051800* ************************************************************** *05180002
051900 9750-WRITE-EXTRACT-RECORD.                                       05190002
052000     WRITE  OUT-EXTRACT-RECORD  FROM  DCLTPKITEM.                 05200002
052100     ADD +1 TO PV-EXTRACT-WRITTEN-CNT.                            05210002
052200                                                                  05220002
052300                                                                  05230002
052400* ************************************************************** *05240002
052500* * CLOSE OUTPUT EXTRACT FILE                                  * *05250002
052600* ************************************************************** *05260002
052700 9790-CLOSE-OUT-EXTRACT-FILE.                                     05270002
052800     CLOSE OUT-EXTRACT-FILE.                                      05280002
052900                                                                  05290002
053000                                                                  05300002
053100* ************************************************************** *05310002
053200* * DISPLAY INFORMATION NEEDED FOR DEBUGGING/MAINTENANCE/SUPPORT *05320002
053300* * AND CALL THE ABEND PROCESSOR IN THE EVENT THAT AN          * *05330002
053400* * SQL ERROR OR WARNING CODE OCCURS.                          * *05340002
053500* ************************************************************** *05350002
053600 9999-DB2-ABEND.                                                  05360002
053700                                                                  05370002
053800     DISPLAY PC-CURRENT-PROGRAM-NAME                              05380002
053900             ' 9999-DB2-ABEND'.                                   05390002
054000     DISPLAY PC-CURRENT-PROGRAM-NAME                              05400002
054100             ' ** ABEND           **'.                            05410002
054200     DISPLAY PC-CURRENT-PROGRAM-NAME                              05420002
054300             ' ** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.       05430002
054400     DISPLAY PC-CURRENT-PROGRAM-NAME                              05440002
054500             ' ** TABLES AFFECTED ** = ' PV-DB2-TABLE-NAME.       05450002
054600     DISPLAY PC-CURRENT-PROGRAM-NAME                              05460002
054700             ' ** OPERATION       ** = ' PV-DB2-OPERATION-MSG-1.  05470002
054800                                                                  05480002
054900     DISPLAY PC-CURRENT-PROGRAM-NAME                              05490002
055000             ' ** SQLCODE         ** = ' SQLCODE.                 05500002
055100     MOVE SQLCODE TO PV-SQLCODE.                                  05510002
055200     DISPLAY PC-CURRENT-PROGRAM-NAME                              05520002
055300             ' ** PV-SQLCODE      ** = ' PV-SQLCODE '.'.          05530002
055400                                                                  05540002
055500     DISPLAY PC-CURRENT-PROGRAM-NAME                              05550002
055600             ' ** SQLWARN0        ** = ' SQLWARN0 '.'.            05560002
055700                                                                  05570002
055800                                                                  05580002
055900*----------------------------------------------------------------*05590002
056000* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-   *05600002
056100* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE        *05610002
056200* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE    *05620002
056300* FORMAT.                                                        *05630002
056400*----------------------------------------------------------------*05640002
056500     COPY DPPD004.                                                05650002
056600                                                                  05660002
056700     MOVE PC-ABENDING               TO DP-STATUS-DESCRIPTION.     05670002
056800     PERFORM 6200-DISPLAY-PGM-PROGRESS.                           05680002
056900     PERFORM 9090-CLOSE-IN-DRIVER-FILE.                           05690002
057000     PERFORM 9790-CLOSE-OUT-EXTRACT-FILE.                         05700002
057100                                                                  05710002
057200*----------------------------------------------------------------*05720002
057300* CALL ABEND                                                     *05730002
057400*----------------------------------------------------------------*05740002
057500     MOVE +4013                  TO ABEND-CODE.                   05750002
057600     CALL 'ILBOABN0' USING ABEND-CODE.                            05760002
057700*                                                                 05770002
