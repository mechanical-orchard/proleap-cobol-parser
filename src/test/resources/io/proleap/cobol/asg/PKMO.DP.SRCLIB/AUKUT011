000100* ------------------------------------------------------------- * 00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300* ------------------------------------------------------------- * 00030000
000400 PROGRAM-ID.      AUKUT011.                                       00040001
000500 AUTHOR.          BARB SCHULTZ.                                   00050000
000600 INSTALLATION.    KOHLS DEPARTMENT STORES.                        00060000
000700 DATE-WRITTEN.    07-24-2008.                                     00070001
000800                                                                  00080000
000900***************************************************************** 00090000
001000*  THIS PROGRAM WILL PUT A MESSAGE ON TO THE                    * 00100000
001100*  EP.THIRDPARTYCARD.AUTH.Q BASED UPON WHAT IS IN THE CONTROL   * 00110001
001100*  FILE.  THIS WILL BE USED TO GET CARDS BACK IN THE QUEUE TO   * 00111001
001300*  BE REPROCESSED IF BLACKHAWK CANNOT PROCESS THEM.             * 00113001
004900***************************************************************** 00114000
005000* ------------------------------------------------------------- * 00115000
005100 ENVIRONMENT DIVISION.                                            00116000
005200* ------------------------------------------------------------- * 00117000
005300                                                                  00118000
005400 CONFIGURATION SECTION.                                           00119000
005500                                                                  00120000
005600 SOURCE-COMPUTER.       IBM-3090.                                 00130000
005700 OBJECT-COMPUTER.       IBM-3090.                                 00140000
005800                                                                  00150000
005900 INPUT-OUTPUT SECTION.                                            00160000
006000                                                                  00170000
006100 FILE-CONTROL.                                                    00180000
006200                                                                  00190000
006300     SELECT CONTROL-CARD            ASSIGN TO INP01.              00200000
006400                                                                  00210000
006500* ------------------------------------------------------------- * 00220000
006600 DATA DIVISION.                                                   00230000
006700* ------------------------------------------------------------- * 00240000
006800 FILE SECTION.                                                    00250000
006900                                                                  00260000
007000 FD  CONTROL-CARD                                                 00270000
007100     RECORDING MODE F                                             00280000
007200     BLOCK CONTAINS 0 RECORDS                                     00290000
007300     LABEL RECORDS ARE OMITTED.                                   00300000
007400 01  CONTROL-CARD-LINE              PIC  X(80).                   00310000
007500                                                                  00320000
007600* ------------------------------------------------------------- * 00330000
007700 WORKING-STORAGE SECTION.                                         00340000
007800* ------------------------------------------------------------- * 00350000
007900                                                                  00360000
008000 01  CC-CONTROL-CARD.                                             00370000
008100     05  CC-QMGR-NAME              PIC X(48) value spaces.        00380005
008200     05  FILLER                    PIC X(01) value spaces.        00380105
008100     05  CC-CARD-NBR               PIC X(19) value spaces.        00381005
008200     05  FILLER                    PIC X(12) value spaces.        00390005
008300                                                                  00400000
008400* ------------------------------------------------------------- * 00410000
008500*   PROGRAM VARIABLES                                             00420000
008600* ------------------------------------------------------------- * 00430000
008700                                                                  00440000
008800 01  PV-PROGRAM-VARIABLES.                                        00450000
008900     05  PV-PARAGRAPH             PIC X(30)     VALUE SPACES.     00460000
009000     05  PV-QM-NAME               PIC X(48).                      00470000
009100     05  PV-MSGBUFFER             PIC X(100000) VALUE SPACES.     00480000
009200     05  PV-MSGLENGTH             PIC S9(9) BINARY VALUE +100000. 00490000
009200     05  PV-DATA-LENGTH           PIC S9(9) BINARY.               00500000
009400     05  PV-NUMPUTS               PIC S9(9) BINARY VALUE 0.       00510000
009500     05  PV-ERROR-MESSAGE         PIC X(48) VALUE SPACES.         00520000
009600     05  PV-HCONN                 PIC S9(9) BINARY VALUE 0.       00530000
009700     05  PV-GQ-HANDLE             PIC S9(9) BINARY VALUE 0.       00540000
009700     05  PV-PQ-HANDLE-BH          PIC S9(9) BINARY VALUE 0.       00550000
009800     05  PV-OPEN-OPTIONS          PIC S9(9) BINARY.               00560000
009900     05  PV-COMPLETION-CODE       PIC S9(9) BINARY.               00570000
009900     05  PV-SAVE-COMPLETION-CODE  PIC S9(9) BINARY.               00580000
010000     05  PV-REASON                PIC S9(9) BINARY.               00590000
010100     05  PV-CON-REASON            PIC S9(9) BINARY.               00600000
010100     05  PV-MQ-REASON-TEXT        PIC X(30)   VALUE SPACES.       00610000
010200     05  PV-QMGR-NAME           PIC X(48)    VALUE                00620000
010300              'EP.THIRDPARTYCARD.AUTH.Q                        '. 00630000
010400     05  PV-PARAGRAPH-NAME        PIC  X(30)  VALUE SPACE.        00640000
010500     05  PV-OPERATION-MSG-1       PIC  X(40)  VALUE SPACE.        00650000
010600     05  PV-DB2-OPERATION         PIC  X(40)  VALUE SPACES.       00660000
010700     05  PV-SAVE-CRD              PIC  X(19)  VALUE SPACES.       00670000
010800     05  PV-SAVE-AUTH-RSPN        PIC  X(03)  VALUE SPACES.       00680000
010800     05  PV-SAVE-REASON           PIC  S9(9)  BINARY.             00690000
010900     05  PV-PUT-MESSAGE-BUFFER    PIC  X(82)  VALUE SPACES.       00700000
011000     05  PV-PUT-MSG-BUFFER-LENGTH PIC  S9(9) BINARY VALUE 82.     00710000
011100     05  PV-CARD-ACCT-NBR         PIC  X(19)  VALUE SPACES.       00720003
011100     05  PV-CARD-NBR.                                             00721001
011200         10  PV-UPC-NUMBER        PIC  9(11).                     00730000
011300         10  PV-CRD-ACCT-NBR      PIC  9(19).                     00740000
011100     05  PV-CARD-NBR-R REDEFINES PV-CARD-NBR PIC X(30).           00750000
011300                                                                  00760000
011400******************************************************************00770000
011400* RECORD FOR PUT TO BLACK HAWK                                    00780000
011400******************************************************************00790000
011400 01  PV-BLKHAWK-FEED               PIC  X(1200000).               00800000
011400                                                                  00810000
011400 01  PV-BLKHAWK-INFO          REDEFINES PV-BLKHAWK-FEED.          00820000
011400     05  PV-BLKHAWK-DATA           PIC X(82).                     00830000
011400     05  FILLER                    PIC X(1199918).                00840000
011400                                                                  00850000
011400 01  PV-BLKHAWK-RECORD REDEFINES PV-BLKHAWK-FEED.                 00860000
011400     05  PV-BLKHAWK-TBL OCCURS 1200000 TIMES.                     00870000
011400         10  PV-BLKHAWK-REC PIC X(01).                            00880000
011400                                                                  00890000
011400 01  SUBSCRIPTS.                                                  00900000
011600     05  BLKHAWK-SUB               PIC S9(09)  COMP.              00910000
011600                                                                  00920000
011600                                                                  00930000
011500*    API control blocks                                           00940000
011600                                                                  00950000
011700 01  MQM-OBJECT-DESCRIPTOR.                                       00960000
011800     COPY CMQODV.                                                 00970000
011900 01  MQM-MESSAGE-DESCRIPTOR.                                      00980000
012000     COPY CMQMDV.                                                 00990000
012100 01  MQM-PUT-MESSAGE-OPTIONS.                                     01000000
012200     COPY CMQPMOV.                                                01010000
012300                                                                  01020000
012400*    MQV contains constants (for filling in the control blocks)   01030000
012500*    and return codes (for testing the result of a call)          01040000
012600                                                                  01050000
012700 01  MQM-CONSTANTS.                                               01060000
012800     COPY CMQV.                                                   01070000
012900                                                                  01080000
013000*----------------------------------------------------------------*01090000
013100*    PROGRAM CONSTANTS                                            01100000
013200*----------------------------------------------------------------*01110000
013300 01  PC-PROGRAM-CONSTANTS.                                        01120000
013400     05  PC-PGM-NAME               PIC X(09) VALUE 'AUKUT011 '.   01130001
013500     05  PC-FIFTY-STARS            PIC X(50) VALUE ALL '*'.       01140000
013600     05  PC-MSG-EXPIRY             PIC S9(9) VALUE 72000.         01150000
013700     05  PC-MSG-TEXT               PIC X(100)                     01160000
013800                                   VALUE 'END RUN OF PROGRAM'.    01170000
013900     05  PC-CORRELID-ASCII         PIC X(24)                      01180000
014000                            VALUE 'ê&.•€                '.     01190000
014100*                   MQ SERIES CONSTANTS                           01200000
014200     05  PC-MQCONN               PIC X(8)    VALUE 'CSQBCONN'.    01210000
014300     05  PC-MQOPEN               PIC X(8)    VALUE 'CSQBOPEN'.    01220000
014400     05  PC-MQGET                PIC X(8)    VALUE 'CSQBGET'.     01230000
014500     05  PC-MQPUT                PIC X(8)    VALUE 'CSQBPUT'.     01240000
014500     05  PC-MQPUT1               PIC X(8)    VALUE 'CSQBPUT1'.    01250000
014600     05  PC-MQCLOSE              PIC X(8)    VALUE 'CSQBCLOS'.    01260000
014600     05  PC-MQCMIT               PIC X(8)    VALUE 'CSQBCOMM'.    01270000
014600     05  PC-MQBACK               PIC X(8)    VALUE 'CSQBBACK'.    01280000
014700     05  PC-MQDISC               PIC X(8)    VALUE 'CSQBDISC'.    01290000
014700     05  PC-MQCHECK              PIC X(8)    VALUE 'MQR2C'.       01300000
014800     05  PC-QMGR-NAME            PIC X(4)    VALUE SPACES.        01310000
014900         88  PC-PROD-QMGR-NAME               VALUE 'QKSP'.        01320000
015000         88  PC-TEST-QMGR-NAME               VALUE 'QKST'.        01330000
015100         88  PC-QA-QMGR-NAME                 VALUE 'QKSQ'.        01340000
015200     05  PC-THIRD-PY-AUTH-QNAME PIC X(48)    VALUE                01350000
015300           'EP.THIRDPARTYCARD.AUTH.Q                        '.    01360000
015400*----------------------------------------------------------------*01370000
015500*    PROGRAM SWITCHES                                            *01380000
015600*----------------------------------------------------------------*01390000
015700 01  PS-PROGRAM-SWITCHES.                                         01400000
015800     05  PS-END-OF-FILE-SW         PIC X(01) VALUE 'N'.           01410007
015900         88  PS-END-OF-FILE                  VALUE 'Y'.           01420007
016000     05  PS-END-PROGRAM-SW         PIC X(01) VALUE 'N'.           01430000
016100         88  PS-END-PROGRAM                  VALUE 'Y'.           01440000
016200                                                                  01450000
016300 01  AC-ABEND-CODE           PIC S9(4) COMP SYNC VALUE ZERO.      01460000
016400     88  AC-WRITE-ERROR                         VALUE +4001.      01470000
016500     88  AC-READ-ERROR                          VALUE +4002.      01480000
016600     88  AC-CONTROL-CARD-ERROR                  VALUE +4003.      01490000
016700     88  AC-TABLE-ERROR                         VALUE +4004.      01500000
016800     88  AC-OPEN-ERROR                          VALUE +4005.      01510000
016900     88  AC-CLOSE-ERROR                         VALUE +4006.      01520000
017000     88  AC-SEQUENCE-ERROR                      VALUE +4007.      01530000
017100     88  AC-DATA-ERROR                          VALUE +4008.      01540000
017200     88  AC-KEY-DATA-ERROR                      VALUE +4009.      01550000
017300     88  AC-DB2-ERROR                           VALUE +4013.      01560000
017400     88  AC-CALENDAR-ROUTINE-ERROR              VALUE +4019.      01570000
017500     88  AC-MQ-ERROR                            VALUE +4020.      01580000
017600                                                                  01590000
017700******************************************************************01600000
017800*  THIRD PARTY AUTH QUEUE LAYOUT                                  01610000
017900******************************************************************01620000
018000     COPY SAWS051.                                                01630000
018100                                                                  01640000
018200******************************************************************01650000
018300* DATE ROUTINE COPY MEMBERS                                       01660000
018400******************************************************************01670000
018500     COPY DPWS500.                                                01680000
018600                                                                  01690000
018700******************************************************************01700000
018800*  WS FIELDS FOR SQLCA MESSAGE ROUTINE                            01710000
018900******************************************************************01720000
019000     COPY DPWS004.                                                01730000
019100                                                                  01740000
019200******************************************************************01750000
019300*  DB2 TABLE GCT_GFT_CRD_TRN                                      01760000
019400******************************************************************01770000
019500     EXEC SQL                                                     01780000
019600         INCLUDE GCT00002                                         01790000
019700     END-EXEC.                                                    01800000
019800                                                                  01810000
019900******************************************************************01820000
020000*  DB2 TABLE GCT_VND_AUTH                                         01830000
020100******************************************************************01840000
020200     EXEC SQL                                                     01850000
020300         INCLUDE GCT00004                                         01860000
020400     END-EXEC.                                                    01870000
020500                                                                  01880000
020600******************************************************************01890000
020700*  DB2 COMMUNICATION AREA.                                        01900000
020800******************************************************************01910000
020900     EXEC SQL                                                     01920000
021000           INCLUDE SQLCA                                          01930000
021100     END-EXEC.                                                    01940000
021200                                                                  01950000
022900                                                                  02260000
023000* ------------------------------------------------------------- * 02270000
023100 PROCEDURE DIVISION.                                              02280000
023200* ------------------------------------------------------------- * 02290000
023300 1000-MAIN SECTION.                                               02300000
023400                                                                  02310000
023500     PERFORM 1000-INITIALIZE.                                     02320000
023600                                                                  02330000
023700     PERFORM 2000-PROCESS-DATA                                    02340000
023800       UNTIL PS-END-OF-FILE OR PS-END-PROGRAM.                    02350007
023900                                                                  02360000
024200     PERFORM 3000-CLOSE-QUEUE.                                    02390000
024300                                                                  02400000
024400     PERFORM 3500-DISCONNECT-QMGR.                                02410000
024500                                                                  02420000
024500     CLOSE CONTROL-CARD.                                          02421001
024500                                                                  02422001
024600     PERFORM 9500-END-PROGRAM.                                    02430000
024700                                                                  02440000
024800* ------------------------------------------------------------- * 02450000
024900*    INITIALIZATION                                               02460000
025000* ------------------------------------------------------------- * 02470000
025100 1000-INITIALIZE.                                                 02480000
025200                                                                  02490000
027300     OPEN INPUT CONTROL-CARD.                                     02491001
025200                                                                  02492001
025300     PERFORM 4100-READ-CONTROL-CARD.                              02500001
025400                                                                  02510000
026400     PERFORM 1200-CONNECT-QUEUE-MANAGER.                          02550000
026700                                                                  02560000
026600     PERFORM 1500-OPEN-QUEUE.                                     02570000
026700                                                                  02580000
031000                                                                  03010000
031100* ------------------------------------------------------------- * 03020000
031200*    Connect to the queue manager                                 03030000
031300* ------------------------------------------------------------- * 03040000
031400                                                                  03050000
031500 1200-CONNECT-QUEUE-MANAGER.                                      03060000
031600                                                                  03070000
031700     MOVE CC-QMGR-NAME TO PV-QM-NAME.                             03080000
031800                                                                  03090000
031900     CALL PC-MQCONN USING PV-QM-NAME                              03100000
032000                          PV-HCONN                                03110000
032100                          PV-COMPLETION-CODE                      03120000
032200                          PV-REASON.                              03130000
032300                                                                  03140000
032400*    If connection failed then display error message              03150000
032500*    and exit                                                     03160000
032600                                                                  03170000
032700     MOVE PV-REASON TO PV-CON-REASON.                             03180000
032800     IF (PV-COMPLETION-CODE NOT = MQCC-OK) THEN                   03190000
032900        MOVE 'MQCONN ERROR'               TO PV-ERROR-MESSAGE     03200000
033000        MOVE '1000-CONNECT-QUEUE-MANAGER' TO PV-PARAGRAPH         03210000
033100        PERFORM 9000-DISPLAY-ERROR-MESSAGE                        03220000
033200        SET PS-END-PROGRAM TO TRUE                                03230000
033300     END-IF.                                                      03240000
033400     DISPLAY 'MQCONN SUCCESSFUL TO ', PV-QM-NAME.                 03250000
033500                                                                  03260000
033600* ------------------------------------------------------------- * 03270000
033700*    Open the queue for output                                    03280000
033800* ------------------------------------------------------------- * 03290000
033900                                                                  03300000
034000 1500-OPEN-QUEUE.                                                 03310000
034100                                                                  03320000
034200     COMPUTE PV-OPEN-OPTIONS = MQOO-OUTPUT +                      03330000
034300                               MQOO-FAIL-IF-QUIESCING.            03340000
034600                                                                  03350000
034700     MOVE PV-QMGR-NAME     TO MQOD-OBJECTNAME.                    03360000
034800     MOVE PV-QM-NAME       TO MQOD-OBJECTQMGRNAME.                03370000
034900                                                                  03380000
035000     CALL PC-MQOPEN USING PV-HCONN                                03390000
035100                          MQM-OBJECT-DESCRIPTOR                   03400000
035200                          PV-OPEN-OPTIONS                         03410000
035300                          PV-GQ-HANDLE                            03420000
035400                          PV-COMPLETION-CODE                      03430000
035500                          PV-REASON.                              03440000
035600                                                                  03450000
035700*    If open failed then display error message                    03460000
035800*    and exit.                                                    03470000
035900                                                                  03480000
036000     IF (PV-COMPLETION-CODE NOT = MQCC-OK) THEN                   03490000
036100        MOVE 'MQOPEN ERROR'    TO PV-ERROR-MESSAGE                03500000
036200        MOVE '1000-OPEN-QUEUE' TO PV-PARAGRAPH                    03510000
036300        PERFORM 9000-DISPLAY-ERROR-MESSAGE                        03520000
036400        PERFORM 3500-DISCONNECT-QMGR                              03530000
036500        SET PS-END-PROGRAM TO TRUE                                03540000
036600     END-IF.                                                      03550000
036700     DISPLAY 'MQOPEN SUCCESSFUL'.                                 03560000
036800                                                                  03570000
036900* ------------------------------------------------------------- * 03580000
037000* PROCESS THE DATA                                                03590000
037100* ------------------------------------------------------------- * 03600000
037200 2000-PROCESS-DATA.                                               03610000
036800                                                                  03611001
037300     MOVE CC-CARD-NBR TO GCT00002-CRD-ACCT-NBR.                   03620004
038000     PERFORM 2200-SELECT-GCT00002.                                03660001
038200     PERFORM 2300-MOVE-FIELDS-TO-QUEUE.                           03680001
038300     PERFORM 2500-MQPUT-MSG.                                      03690001
038900                                                                  03720000
039000     PERFORM 4100-READ-CONTROL-CARD.                              03760002
039100                                                                  03770000
039200* ------------------------------------------------------------- * 03780000
039300* SELECT GCT00002 ROWS FROM TABLE                                 03790000
039400* ------------------------------------------------------------- * 03800000
039500 2200-SELECT-GCT00002.                                            03810000
039600                                                                  03820000
039700     EXEC SQL                                                     03830000
039800         SELECT CRD_ACCT_NBR                                      03840000
039900              , CRE_TMST                                          03850000
040000              , SLS_DTE                                           03860000
040100              , STR_NBR                                           03870000
040200              , RGST_ID                                           03880000
040300              , TRN_NBR                                           03890000
040400              , STRT_TM                                           03900000
040500              , LNE_ITM_SEQ_NBR                                   03910000
040600              , UPC_NUMBER                                        03920000
040700              , CUST_CHRGD_AMT                                    03930000
040800           INTO :GCT00002-CRD-ACCT-NBR                            03940000
040900              , :GCT00002-CRE-TMST                                03950000
041000              , :GCT00002-SLS-DTE                                 03960000
041100              , :GCT00002-STR-NBR                                 03970000
041200              , :GCT00002-RGST-ID                                 03980000
041300              , :GCT00002-TRN-NBR                                 03990000
041400              , :GCT00002-STRT-TM                                 04000000
041500              , :GCT00002-LNE-ITM-SEQ-NBR                         04010000
041600              , :GCT00002-UPC-NUMBER                              04020000
041700              , :GCT00002-CUST-CHRGD-AMT                          04030000
041800         FROM GCT_GFT_CRD_TRN                                     04040000
041900         WHERE CRD_ACCT_NBR = :GCT00002-CRD-ACCT-NBR              04050004
042000         WITH UR                                                  04060000
 42100     END-EXEC.                                                    04070004
042200                                                                  04080000
042300     EVALUATE SQLCODE                                             04090000
042400         WHEN 0                                                   04100000
042500             CONTINUE                                             04110000
042600         WHEN OTHER                                               04120000
042700             MOVE '2200-SELECT-GCT00002'   TO PV-PARAGRAPH-NAME   04130000
042800             MOVE 'ERROR SELECTING GCT00002  '                    04140000
042900                                           TO PV-DB2-OPERATION    04150000
043000             PERFORM 9100-SQL-ABEND                               04160000
043100     END-EVALUATE.                                                04170000
043200                                                                  04180000
043300* ------------------------------------------------------------- * 04190000
043400* MOVE THE FIELDS TO THE QUEUE                                    04200000
043500* ------------------------------------------------------------- * 04210000
043600 2300-MOVE-FIELDS-TO-QUEUE.                                       04220000
043700                                                                  04230000
043800      MOVE ZEROES                   TO SA051-PARTN-NBR.           04240000
041000      MOVE GCT00002-SLS-DTE         TO SA051-SLS-DTE.             04250000
043900      MOVE GCT00002-CRD-ACCT-NBR    TO PV-CRD-ACCT-NBR.           04260000
044000      MOVE GCT00002-UPC-NUMBER      TO PV-UPC-NUMBER.             04270000
044100      MOVE GCT00002-CRD-ACCT-NBR    TO SA051-CARD-NBR.            04280000
044200      MOVE GCT00002-STR-NBR         TO SA051-STR-NBR.             04290000
044300      MOVE GCT00002-RGST-ID         TO SA051-RGST-ID.             04300000
044400      MOVE GCT00002-TRN-NBR         TO SA051-TRN-NBR.             04310000
044500      MOVE GCT00002-STRT-TM         TO SA051-STRT-TM.             04320000
044600      MOVE ZEROES                   TO SA051-SLS-CORR-SEQ-NBR.    04330000
044700      MOVE GCT00002-LNE-ITM-SEQ-NBR TO SA051-LNE-ITM-SEQ-NBR.     04340000
044800      MOVE PV-CARD-NBR-R            TO SA051-CARD-NBR.            04350000
044900      MOVE GCT00002-CUST-CHRGD-AMT  TO SA051-CUST-CHRGD-AMT.      04360000
045000      MOVE 'S'                      TO SA051-SAF-CDE.             04370000
045100                                                                  04380000
045200      MOVE SA051-CARD-INFO    TO PV-PUT-MESSAGE-BUFFER.           04390000
045300                                                                  04400000
045400* ------------------------------------------------------------- * 04410000
045500* PUT MESSAGE ON LOCAL QUEUE TO END THE DATA COLLECT PROCESS      04420000
045600* ------------------------------------------------------------- * 04430000
045700 2500-MQPUT-MSG.                                                  04440000
045800     DISPLAY 'BLKHAWK-FEED'.                                      04450000
045800     DISPLAY '  PARTN-NBR       = ' SA051-PARTN-NBR.              04460000
045800     DISPLAY '  SLS-DTE         = ' SA051-SLS-DTE.                04470000
045800     DISPLAY '  STR-NBR         = ' SA051-STR-NBR.                04480000
045800     DISPLAY '  RGST-ID         = ' SA051-RGST-ID.                04490000
045800     DISPLAY '  TRN-NBR         = ' SA051-TRN-NBR.                04500000
045800     DISPLAY '  STRT-TM         = ' SA051-STRT-TM.                04510000
045800     DISPLAY '  SLS-CORR-SEQ-NBR= ' SA051-SLS-CORR-SEQ-NBR.       04520004
045800     DISPLAY '  LNE-ITM-SEQ-NBR = ' SA051-LNE-ITM-SEQ-NBR.        04530000
045800     DISPLAY '  CARD-NBR        = ' SA051-CARD-NBR.               04540000
045800     DISPLAY '  CUST-CHRGD-AMT  = ' SA051-CUST-CHRGD-AMT.         04550000
045800     DISPLAY '  SA051-CARD-LENGTH = ' SA051-CARD-LENGTH.          04560000
045800*                                                                 04570000
045800     MOVE SA051-BLKHAWK-FIELDS TO PV-BLKHAWK-DATA.                04580000
045800     MOVE SA051-CARD-LENGTH    TO PV-DATA-LENGTH.                 04581000
045800                                                                  04582000
045800     COMPUTE MQPMO-OPTIONS = MQPMO-SYNCPOINT.                     04583000
045800                                                                  04584000
045800     MOVE PV-QM-NAME          TO MQOD-OBJECTQMGRNAME.             04585000
045800     MOVE PV-QMGR-NAME        TO MQOD-OBJECTNAME.                 04586000
045800     MOVE PV-BLKHAWK-FEED     TO PV-MSGBUFFER.                    04587000
045800     MOVE MQPER-PERSISTENT    TO MQMD-PERSISTENCE.                04588000
045800                                                                  04589000
045800     IF (CC-QMGR-NAME NOT = 'QKSP')                               04590000
045800         DISPLAY ' '                                              04590100
045800         DISPLAY '2600-PUT BLKHAWK QUEUE = '                      04590200
045800         DISPLAY SA051-BLKHAWK-FIELDS                             04590300
045800     END-IF.                                                      04590400
045800                                                                  04590500
045800     CALL PC-MQPUT USING PV-HCONN                                 04590600
035300                         PV-GQ-HANDLE                             04590700
045800                         MQM-MESSAGE-DESCRIPTOR                   04590800
045800                         MQM-PUT-MESSAGE-OPTIONS                  04590900
045800                         PV-DATA-LENGTH                           04591000
045800                         PV-MSGBUFFER                             04591100
045800                         PV-COMPLETION-CODE                       04591200
045800                         PV-REASON.                               04591300
045800                                                                  04591400
045800     IF (PV-COMPLETION-CODE NOT = MQCC-OK)                        04591500
045800        DISPLAY '                            '                    04591600
045800        DISPLAY '2500-PUT-TO-MQ-BLKHAWK-FEED'                     04591700
045800        DISPLAY 'ERROR ON INITIAL PUT TO BLACK HAWK'              04591800
045800        DISPLAY 'PV-REASON         = ' PV-REASON                  04591900
045800        DISPLAY 'PV-COMPLETION-CODE= ' PV-COMPLETION-CODE         04592000
045800        DISPLAY 'PV-PQ-HANDLE-BH   = ' PV-PQ-HANDLE-BH            04592100
045800        DISPLAY 'PV-HCONN          = ' PV-HCONN                   04592200
045800        DISPLAY 'PV-QM-NAME        = ' PV-QM-NAME                 04592300
045800        DISPLAY 'CC-BLKHAWK-QNAME  = ' CC-QMGR-NAME               04592400
045800        DISPLAY '** WILL PERFORM RETRY LOGIC **'                  04592500
045800        PERFORM 2600-RETRY-PUT-TO-BLKHAWK                         04592600
045800     ELSE                                                         04592700
045800        PERFORM 9800-COMMIT-MQ                                    04592800
057800        ADD 1 TO PV-NUMPUTS                                       04592900
045800     END-IF.                                                      04593000
045800                                                                  04593100
045800     INITIALIZE PV-BLKHAWK-FEED.                                  04593200
045800     INITIALIZE SA051-BLKHAWK-FIELDS.                             04593300
045800                                                                  04593400
045400* ------------------------------------------------------------- * 04593500
045500* PUT MESSAGE ON QUEUE                                            04593600
045600* ------------------------------------------------------------- * 04593700
045700 2600-RETRY-PUT-TO-BLKHAWK.                                       04593800
046000                                                                  04593900
046000*** ATTEMPT TO CLOSE THE QUEUE, IF IT FAILS, GO AHEAD AND REOPEN  04594000
046000*** AT THAT POINT TO ESTABLISH A NEW HANDLE.                      04594100
046000                                                                  04594200
049300     PERFORM 3000-CLOSE-QUEUE.                                    04594300
046000     PERFORM 2700-REOPEN-BLKHAWK.                                 04594400
046000     PERFORM 2800-RETRY-PUT-TO-BLKHAWK.                           04594500
046000                                                                  04594600
046000******************************************************************04594700
046000* REOPEN BLACK HAWK                                               04594800
046000******************************************************************04594900
046000 2700-REOPEN-BLKHAWK.                                             04595000
046000                                                                  04595100
046000     INITIALIZE PV-PQ-HANDLE-BH.                                  04595200
046000                                                                  04595300
046000     COMPUTE PV-OPEN-OPTIONS = MQOO-OUTPUT +                      04595400
046000                               MQOO-FAIL-IF-QUIESCING.            04595500
046000                                                                  04595600
034700     MOVE PV-QMGR-NAME     TO MQOD-OBJECTNAME.                    04595700
034800     MOVE PV-QM-NAME       TO MQOD-OBJECTQMGRNAME.                04595800
046000                                                                  04595900
046000     CALL PC-MQOPEN USING PV-HCONN                                04596000
046000                          MQM-OBJECT-DESCRIPTOR                   04596100
046000                          PV-OPEN-OPTIONS                         04596200
046000                          PV-GQ-HANDLE                            04596300
046000                          PV-COMPLETION-CODE                      04596400
046000                          PV-REASON.                              04596500
046000*                                                                 04596600
046000*    IF OPEN FAILED THEN DISPLAY ERROR MESSAGE                    04596700
046000*    AND EXIT.                                                    04596800
046000*                                                                 04596900
046000     IF (PV-COMPLETION-CODE   NOT = MQCC-OK)                      04597000
046000        MOVE 'MQOPEN ERROR'   TO PV-ERROR-MESSAGE                 04598000
046000        MOVE '27200-REOPEN BLACK HAWK '                           04598100
046000                              TO PV-PARAGRAPH                     04598200
046000                                                                  04598300
046000        DISPLAY '                                        '        04598400
046000        DISPLAY 'ABENDING IN REPOPEN OF BLACK HAWK QUEUE'         04598500
046000        DISPLAY 'PV-REASON         = ' PV-REASON                  04598600
046000        DISPLAY 'PV-COMPLETION-CODE= ' PV-COMPLETION-CODE         04598700
046000        DISPLAY 'PV-HCONN          = ' PV-HCONN                   04598800
046000        DISPLAY 'PV-PQ-HANDLE-BH      = ' PV-PQ-HANDLE-BH         04598900
046000                                                                  04599000
046000        MOVE PV-REASON TO PV-SAVE-REASON                          04599100
046000                                                                  04599200
046000        PERFORM 9400-DISCONNECT-QMGR                              04599300
046000        PERFORM 9200-DISPLAY-MQ-ERROR                             04599400
046000     END-IF.                                                      04599500
046000                                                                  04599600
046000     DISPLAY 'REOPEN OF BLACK HAWK QUEUE SUCCESSFUL'.             04599700
046000                                                                  04599800
046000******************************************************************04599900
046000* RETRY PUT TO BLACK HAWK                                         04600000
046000******************************************************************04600100
046000 2800-RETRY-PUT-TO-BLKHAWK.                                       04600200
046000                                                                  04600300
045800     MOVE PV-QM-NAME             TO MQOD-OBJECTQMGRNAME.          04600400
045800     MOVE PV-QMGR-NAME           TO MQOD-OBJECTNAME.              04600500
046000     MOVE PV-BLKHAWK-FEED        TO PV-MSGBUFFER.                 04600600
046000     MOVE MQPER-PERSISTENT       TO MQMD-PERSISTENCE.             04600700
046000     MOVE MQFMT-STRING           TO MQMD-FORMAT.                  04600800
046000                                                                  04600900
046000     MOVE 0                      TO PV-DATA-LENGTH.               04601000
046000     MOVE SA051-CARD-LENGTH      TO PV-DATA-LENGTH.               04601100
046000                                                                  04601200
046000     CALL PC-MQPUT USING PV-HCONN                                 04601300
035300                         PV-GQ-HANDLE                             04601400
046000                         MQM-MESSAGE-DESCRIPTOR                   04601500
046000                         MQM-PUT-MESSAGE-OPTIONS                  04601600
046000                         PV-DATA-LENGTH                           04601700
046000                         PV-MSGBUFFER                             04601800
046000                         PV-COMPLETION-CODE                       04601900
046000                         PV-REASON.                               04602000
046000                                                                  04602100
046000*    DISPLAY ERROR MESSAGE IF PUT FAILED                          04602200
046000*       AND BREAK OUT OF LOOP                                     04602300
046000                                                                  04602400
046000     IF (PV-COMPLETION-CODE NOT = MQCC-OK)                        04602500
046000        DISPLAY '                             '                   04602600
046000        DISPLAY 'ERROR ON REPUT TO BLACK HAWK'                    04602700
046000        DISPLAY 'PV-REASON         = ' PV-REASON                  04602800
046000        DISPLAY 'PV-COMPLETION-CODE= ' PV-COMPLETION-CODE         04602900
046000        DISPLAY 'PV-PQ-HANDLE-BH   = ' PV-PQ-HANDLE-BH            04603000
046000        DISPLAY 'PV-HCONN          = ' PV-HCONN                   04603100
046000        DISPLAY 'PV-QM-NAME        = ' PV-QM-NAME                 04603200
046000        DISPLAY 'CC-QMGR-NAME      = ' CC-QMGR-NAME               04603300
046000                                                                  04603400
046000        MOVE PV-COMPLETION-CODE  TO PV-SAVE-COMPLETION-CODE       04603500
046000        MOVE PV-REASON           TO PV-SAVE-REASON                04603600
046000        MOVE '2800-RETRY-PUT-TO-BLKHAWK'                          04603700
046000                                 TO PV-PARAGRAPH                  04603800
046000        MOVE 'MQPUT ERROR'       TO PV-ERROR-MESSAGE              04603900
046000                                                                  04604000
046000        PERFORM 9700-BACK-OUT-MQ                                  04604100
046000        PERFORM 9200-DISPLAY-MQ-ERROR                             04604200
046000     ELSE                                                         04604300
046000        PERFORM 9800-COMMIT-MQ                                    04604400
057800        ADD 1 TO PV-NUMPUTS                                       04604500
046000     END-IF.                                                      04604600
048900                                                                  04604700
049000* ------------------------------------------------------------- * 04604800
049100* CLOSE THE QUEUE                                                 04604900
049200* ------------------------------------------------------------- * 04605000
049300 3000-CLOSE-QUEUE.                                                04606000
049400     CALL PC-MQCLOSE USING PV-HCONN                               04607000
049500                           PV-GQ-HANDLE                           04608000
049600                           MQCO-NONE                              04609000
049700                           PV-COMPLETION-CODE                     04610000
049800                           PV-REASON.                             04620000
050600                                                                  04630000
049900     IF (PV-COMPLETION-CODE NOT = MQCC-OK)                        04640000
050000        MOVE 'MQCLOSE ERROR'     TO PV-ERROR-MESSAGE              04650000
050100        MOVE '3000-CLOSE-QUEUE ' TO PV-PARAGRAPH                  04660000
050200        PERFORM 9000-DISPLAY-ERROR-MESSAGE                        04670000
050300     ELSE                                                         04680000
050400        DISPLAY 'MQCLOSE SUCCESSFUL'                              04690000
050500     END-IF.                                                      04700000
050600                                                                  04710000
050700* ------------------------------------------------------------- * 04720000
050800* DISCONNECT FROM THE MQ QUEUE MANAGER                            04730000
050900* ------------------------------------------------------------- * 04740000
051000 3500-DISCONNECT-QMGR.                                            04750000
051100                                                                  04760000
051200     IF PV-CON-REASON IS NOT EQUAL TO MQRC-ALREADY-CONNECTED      04770000
051300        CALL PC-MQDISC USING PV-HCONN                             04780000
051400                             PV-COMPLETION-CODE                   04790000
051500                             PV-REASON                            04800000
051600        IF (PV-COMPLETION-CODE NOT = MQCC-OK)                     04810000
051700           MOVE 'MQDISC ERROR'         TO PV-ERROR-MESSAGE        04820000
051800           MOVE '3500-DISCONNECT-QMGR' TO PV-PARAGRAPH            04830000
051900           PERFORM 9000-DISPLAY-ERROR-MESSAGE                     04840000
052000        ELSE                                                      04850000
052100           DISPLAY 'MQDISC SUCCESSFUL'                            04860000
052200        END-IF                                                    04870000
052300     END-IF.                                                      04880000
052400                                                                  04890000
055100                                                                  05200001
026800* ------------------------------------------------------------- * 05201001
026900*    READ CONTROL CARD                                            05202001
027000* ------------------------------------------------------------- * 05203001
027100 4100-READ-CONTROL-CARD.                                          05204001
 27200                                                                  05205007
027400     READ CONTROL-CARD INTO CC-CONTROL-CARD                       05206007
033200        AT END SET PS-END-OF-FILE TO TRUE.                        05206107
027500                                                                  05207001
027600     IF CC-QMGR-NAME = SPACES                                     05208001
027700         DISPLAY PC-PGM-NAME                                      05209001
027800             'CONTROL CARD MISSING - FOR QMGR NAME'               05209101
027900         SET AC-CONTROL-CARD-ERROR TO TRUE                        05209201
028000         CALL 'ILBOABN0' USING AC-ABEND-CODE                      05209308
028100     ELSE                                                         05209401
028200         DISPLAY PC-PGM-NAME                                      05209501
028300                 '- CONTROL CARD: '                               05209601
028400                 CC-CONTROL-CARD                                  05209701
028500     END-IF.                                                      05209801
027500                                                                  05209901
028600     IF CC-CARD-NBR IS NOT NUMERIC                                05210001
027700         DISPLAY CC-CARD-NBR                                      05210101
027800             ' CONTROL CARD NUMBER NOT NUMERIC'                   05210201
027900         SET AC-CONTROL-CARD-ERROR TO TRUE                        05210301
028000         CALL 'ILBOABN0' USING AC-ABEND-CODE                      05210408
028500     END-IF.                                                      05210901
056900                                                                  05400001
058200* ------------------------------------------------------------- * 05410000
058300* DISPLAY THE VALUES OF A FAILED MQ API COMMAND                   05420000
058400* ------------------------------------------------------------- * 05430000
058500 9000-DISPLAY-ERROR-MESSAGE.                                      05440000
058600                                                                  05450000
058700     DISPLAY '** ABEND ***************************************'.  05460000
058800     DISPLAY '** PROGRAM:   ', PC-PGM-NAME.                       05470000
058900     DISPLAY '** PARAGRAPH: ', PV-PARAGRAPH.                      05480000
059000     DISPLAY '** MESSAGE:   ', PV-ERROR-MESSAGE.                  05490000
059100     DISPLAY '** COMP CODE: ', PV-COMPLETION-CODE.                05500000
059200     DISPLAY '** RSN CODE:  ', PV-REASON.                         05510000
059201     DISPLAY '************************************************'.  05520000
059202     SET AC-MQ-ERROR TO TRUE.                                     05530000
059203     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         05540000
059204                                                                  05550000
059205***************************************************************** 05560000
059206* PERFORMS ABEND PROCESSING FOR SQL ERRORS.                       05570000
059207***************************************************************** 05580000
059208 9100-SQL-ABEND.                                                  05590000
059209                                                                  05600000
059210     DISPLAY '9100-SQL-ABEND'.                                    05610000
059220     DISPLAY '**  ABEND     **'.                                  05620000
059230     DISPLAY '**  PROGRAM   ** = ' PC-PGM-NAME.                   05630000
059240     DISPLAY '**  PARAGRAPH ** = ' PV-PARAGRAPH-NAME.             05640000
059250     DISPLAY '**  SQLCODE   ** = ' SQLCODE.                       05650000
059260                                                                  05660000
059270******************************************************************05670000
059280* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-   *05680000
059290* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE        *05690000
059300* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE    *05700000
059400* FORMAT.                                                        *05710000
059500******************************************************************05720000
059600                                                                  05730000
059700     COPY DPPD004.                                                05740000
059800                                                                  05750000
059900     MOVE +4013 TO AC-ABEND-CODE.                                 05760000
060000     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         05770000
059600                                                                  05780000
059600******************************************************************05790000
059600* DISPLAY MQ ERROR                                                05800000
059600******************************************************************05810000
059600 9200-DISPLAY-MQ-ERROR.                                           05820000
059600                                                                  05830000
059600     CALL PC-MQCHECK USING PV-SAVE-REASON                         05840000
059600                           PV-MQ-REASON-TEXT.                     05850000
059600                                                                  05860000
059600     DISPLAY '                                                '.  05870000
059600     DISPLAY '**** ABEND *************************************'.  05880000
059600     DISPLAY '** MQSERIES ERROR **'.                              05890000
059600     DISPLAY '** PROGRAM:    ', PC-PGM-NAME.                      05900000
059600     DISPLAY '** PARAGRAPH:  ', PV-PARAGRAPH.                     05910000
059600     DISPLAY '** MESSAGE:    ', PV-ERROR-MESSAGE.                 05920000
059600     DISPLAY '** COMP CODE:  ', PV-SAVE-COMPLETION-CODE.          05930000
059600     DISPLAY '** RSN CODE:   ', PV-SAVE-REASON.                   05940000
059600     DISPLAY '** RSN TEXT:   ', PV-MQ-REASON-TEXT.                05950000
059600     DISPLAY '************************************************'.  05960000
059600                                                                  05970000
059600     SET AC-MQ-ERROR TO TRUE.                                     05980000
059600                                                                  05990000
059600     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         06000000
059600                                                                  06001000
059600***************************************************************** 06002000
059600* DISCONNECT FROM THE QUEUE MANAGER                               06003000
059600***************************************************************** 06003100
059600 9400-DISCONNECT-QMGR.                                            06003200
059600                                                                  06003300
059600     IF PV-CON-REASON IS NOT EQUAL TO MQRC-ALREADY-CONNECTED      06003400
059600        CALL PC-MQDISC USING PV-HCONN                             06003500
059600                            PV-COMPLETION-CODE                    06003600
059600                            PV-REASON                             06003700
059600                                                                  06003800
059600        IF (PV-COMPLETION-CODE NOT = MQCC-OK)                     06003900
059600           MOVE 'MQDISC ERROR'         TO PV-ERROR-MESSAGE        06004000
059600           MOVE '9400-DISCONNECT-QMGR' TO PV-PARAGRAPH            06004100
059600           PERFORM 9200-DISPLAY-MQ-ERROR                          06004200
059600        ELSE                                                      06004300
059600           DISPLAY 'MQDISC SUCCESSFUL'                            06004400
059600        END-IF                                                    06004500
059600     END-IF.                                                      06004600
059600                                                                  06004700
057000* ------------------------------------------------------------- * 06004800
057100* END THE PROGRAM                                                 06004900
057200* ------------------------------------------------------------- * 06005000
057300 9500-END-PROGRAM.                                                06005100
057400                                                                  06005200
057500*    Display the number of messages successfully put              06005300
057600*    to the queue                                                 06005400
057700                                                                  06005500
057800     DISPLAY PV-NUMPUTS, ' MESSAGES PUT TO QUEUE'.                06005600
057900                                                                  06005700
058000     STOP RUN.                                                    06005800
058100                                                                  06005900
060100******************************************************************06006000
060100* BACK OUT MQ                                                     06007000
060100******************************************************************06008000
060100 9700-BACK-OUT-MQ.                                                06009000
060100                                                                  06010000
060100     CALL PC-MQBACK USING PV-HCONN                                06020000
060100                          PV-COMPLETION-CODE                      06030000
060100                          PV-REASON.                              06040000
060100                                                                  06050000
060100     IF (PV-COMPLETION-CODE NOT = MQCC-OK)                        06060000
060100        MOVE '9700-BACK-OUT-MQ'  TO PV-PARAGRAPH                  06070000
060100        MOVE 'MQBACK ERROR'    TO PV-ERROR-MESSAGE                06080000
060100        PERFORM 9200-DISPLAY-MQ-ERROR                             06090000
060100     END-IF.                                                      06100000
060100                                                                  06110000
060100******************************************************************06120000
060100* COMMIT MQ                                                       06130000
060100******************************************************************06140000
060100 9800-COMMIT-MQ.                                                  06150000
060100                                                                  06151000
060100     CALL PC-MQCMIT USING PV-HCONN                                06152000
060100                          PV-COMPLETION-CODE                      06153000
060100                          PV-REASON.                              06154000
060100                                                                  06155000
060100     IF (PV-COMPLETION-CODE NOT = MQCC-OK)                        06156000
060100        MOVE '9800-COMMIT-MQ'  TO PV-PARAGRAPH                    06157000
060100        MOVE 'MQCMIT ERROR'    TO PV-ERROR-MESSAGE                06158000
060100        PERFORM 9700-BACK-OUT-MQ                                  06159000
060100        PERFORM 9200-DISPLAY-MQ-ERROR                             06159100
060100     END-IF.                                                      06159200
060100                                                                  06159300
