000100 IDENTIFICATION DIVISION.                                         00010024
000200                                                                  00020024
000300 PROGRAM-ID.      SAKUP002.                                       00030024
000400 AUTHOR.          STEVEN NOWAK.                                   00040024
000500 INSTALLATION.    KOHLS DEPARTMENT STORES.                        00050024
000600 DATE-WRITTEN.    05/01/09.                                       00060024
000700 DATE-COMPILED.                                                   00070024
000800                                                                  00080024
000900******************************************************************00090024
001000*  MODULE TYPE:   COBOL2 DB2 BATCH.                               00100024
001100*                                                                 00110024
001200*  DESCRIPTION: PROGRAM UPDATES THE TSASUM TABLE WITH THE DATA    00120024
001300*               PULLED IN PROGRAM SAKUT060                        00130024
001400*                                                                 00140024
001500*========================== CHANGE LOG ===========================00150024
001600*  AUTH        BY           DATE    DESCRIPTION                   00160025
001700*=================================================================00170024
001800* WR36527     TKMA409     04-15-09  CREATE PROGRAM                00180025
001900*                                                                 00190024
260107* CHG0260107  JIM HUNTER  08-19-21  ADD COPYBOOK DPWS991 TO MAKE  00191025
260107*                                   THE CALL TO DPKUT901 DYNAMIC. 00192025
002000******************************************************************00200024
002100                                                                  00210024
002200 ENVIRONMENT DIVISION.                                            00220024
002300 CONFIGURATION SECTION.                                           00230024
002400                                                                  00240024
002500 SOURCE-COMPUTER.    IBM-3090.                                    00250024
002600 OBJECT-COMPUTER.    IBM-3090.                                    00260024
002700                                                                  00270024
002800 INPUT-OUTPUT SECTION.                                            00280024
002900 FILE-CONTROL.                                                    00290024
003000                                                                  00300024
003100 DATA DIVISION.                                                   00310024
003200 FILE SECTION.                                                    00320024
003300                                                                  00330024
003400                                                                  00340024
003500***************************************************************** 00350024
003600*                       WORKING STORAGE                           00360024
003700***************************************************************** 00370024
003800 WORKING-STORAGE SECTION.                                         00380024
003900                                                                  00390024
004000 01  W-START                          PIC  X(40)                  00400024
004100     VALUE 'SAKUP002 - WORKING STORAGE BEGINS HERE'.              00410024
004200                                                                  00420024
004300                                                                  00430024
004400***************************************************************** 00440024
004500*                         SWITCHES                                00450024
004600***************************************************************** 00460024
004700 01  PROGRAM-SWITCHES.                                            00470024
004800     05  PS-RESTART-REQUIRED-SW       PIC  X(01) VALUE 'N'.       00480024
004900         88  PS-RESTART-REQUIRED                 VALUE 'Y'.       00490024
005000         88  PS-RESTART-NOT-REQUIRED             VALUE 'N'.       00500024
005100                                                                  00510024
005200******************************************************************00520024
005300*                       ACCUMULATORS                              00530024
005400******************************************************************00540024
005500 01  PROGRAM-ACCUM.                                               00550024
005600     05  PA-READ                      PIC  9(11) VALUE ZEROS.     00560024
005600     05  PA-CKPT                      PIC  9(11) VALUE ZEROS.     00570024
005700                                                                  00580024
005800******************************************************************00590024
005900*                           CONSTANTS                             00600024
006000******************************************************************00610024
006100 01  PROGRAM-CONSTANTS.                                           00620024
006200     05  PC-MAX-RETRIES               PIC S9(04) VALUE +3         00630024
006300                                                 COMP SYNC.       00640024
006400     05  PC-MAX-DEADLOCKS             PIC S9(04) VALUE +3         00650024
006500                                                 COMP SYNC.       00660024
006600                                                                  00670024
006700     05  PC-CKPT-JOB-NAME             PIC  X(08) VALUE 'SAK051  '.00680024
006800     05  PC-CKPT-PLAN-NAME            PIC  X(08) VALUE 'SAKUP002'.00690024
006900     05  PC-PROGRAM-NAME              PIC  X(08) VALUE 'SAKUP002'.00700024
007000                                                                  00710024
007100     05  PC-TRAN-PRES-FUNC-CODES.                                 00720024
007200         10  PC-TRAN-PRES-FUNC-OPEN   PIC  X(05) VALUE 'OPEN '.   00730024
007300         10  PC-TRAN-PRES-FUNC-TRANS  PIC  X(05) VALUE 'TRANS'.   00740024
007400         10  PC-TRAN-PRES-FUNC-RSTRT  PIC  X(05) VALUE 'RSTRT'.   00750024
007500         10  PC-TRAN-PRES-FUNC-CLOSE  PIC  X(05) VALUE 'CLOSE'.   00760024
007600                                                                  00770024
007700     05  PC-MINUS-ONE                 PIC S9(01) VALUE -1.        00780024
007800     05  PC-SYSTEM                    PIC  X(08) VALUE 'SYSTEM  '.00790024
007900                                                                  00800024
008000******************************************************************00810024
008100*                          VARIABLES                              00820024
008200******************************************************************00830024
008300 01  PROGRAM-VARIABLES.                                           00840024
008400     05  PV-SQL-SUB                   PIC  9(03) VALUE ZERO.      00850024
008500     05  PV-DEADLOCK-COUNTER          PIC  9(03) VALUE ZERO.      00860024
008600     05  PV-PARAGRAPH-NAME            PIC  X(30) VALUE SPACE.     00870024
008700     05  PV-DB2-OPER-ATTEMPTED        PIC  X(30) VALUE SPACE.     00880024
008800     05  PV-OPERATION-MSG             PIC  X(35) VALUE SPACE.     00890024
008900     05  PV-RET-CODE                  PIC  9(04) VALUE ZEROS.     00900024
009000                                                                  00910024
009100******************************************************************00920024
009200*               SYSTEM TIME AND DATE VARIABLES                    00930024
009300******************************************************************00940024
009400 01  SYS-DATE-TIME.                                               00950024
009500     05  SYS-DATE                     PIC  X(08) VALUE SPACES.    00960024
009600     05  SYS-TIME                     PIC  X(08) VALUE SPACES.    00970024
009700                                                                  00980024
009800 01  ST-BEG-TIME.                                                 00990024
009900     05  ST-BEG-HR                    PIC  9(02) VALUE ZEROS.     01000024
010000     05  FILLER                       PIC  X(01) VALUE ':'.       01010024
010100     05  ST-BEG-MN                    PIC  9(02) VALUE ZEROS.     01020024
010200                                                                  01030024
010300 01  ST-END-TIME.                                                 01040024
010400     05  ST-END-HR                    PIC  9(02) VALUE ZEROS.     01050024
010500     05  FILLER                       PIC  X(01) VALUE ':'.       01060024
010600     05  ST-END-MN                    PIC  9(02) VALUE ZEROS.     01070024
010700                                                                  01080024
010800 01  SD-EDIT-DATE.                                                01090024
010900     05  SD-MONTH                     PIC  9(02) VALUE ZEROS.     01100024
011000     05  FILLER                       PIC  X(01) VALUE '-'.       01110024
011100     05  SD-DAY                       PIC  9(02) VALUE ZEROS.     01120024
011200     05  FILLER                       PIC  X(01) VALUE '-'.       01130024
011300     05  SD-CENT                      PIC  9(02) VALUE ZEROS.     01140024
011400     05  SD-YEAR                      PIC  9(02) VALUE ZEROS.     01150024
011500                                                                  01160024
011600******************************************************************01170024
011700*                        ERROR HANDLING                           01180024
011800******************************************************************01190024
011900 01  ABEND-CODE                       PIC S9(04) VALUE ZEROS      01200024
012000                                                 COMP SYNC.       01210024
012100     88  ABEND-4002-READ-ERROR                   VALUE +4002.     01220024
012200     88  ABEND-4013-DB2-ERROR                    VALUE +4013.     01230024
012300     88  ABEND-4019-CAL-SUB-ERROR                VALUE +4019.     01240024
012400                                                                  01250024
012500                                                                  01260024
012600******************************************************************01270024
012700*  TSASUM - TOTALS BY STORE REGISTER                              01280024
012800******************************************************************01290024
012900     COPY SARD008.                                                01300024
013000                                                                  01310024
013100******************************************************************01320024
013200*  DB2 FORMATTED ERROR MESSAGE                                    01330024
013300******************************************************************01340024
013400     COPY DPWS004.                                                01350024
013500                                                                  01360024
013600******************************************************************01370024
013700*  SQL COMMUNICATIONS WORK AREA                                   01380024
013800******************************************************************01390024
013900     COPY SQLCA2.                                                 01400024
014000                                                                  01410024
014100******************************************************************01420024
014200*  COMMUNICATIONS AREA FOR DB2                                    01430024
014300******************************************************************01440024
014400     EXEC SQL                                                     01450024
014500         INCLUDE SQLCA                                            01460024
014600     END-EXEC.                                                    01470024
014700                                                                  01480024
014800******************************************************************01490024
014900*  DB2 TABLE TSASUM - STORE TOTALS TABLE                          01500024
015000******************************************************************01510024
015100     EXEC SQL                                                     01520024
015200          INCLUDE TSASUM                                          01530024
015300     END-EXEC.                                                    01540024
015400                                                                  01550024
015500******************************************************************01560024
015600*  TRANSACTION PREPARATION MODULE COMMUNICATIONS AREA             01570024
015700******************************************************************01580024
260107     COPY DPWS991.                                                01590025
015800                                                                  01591025
015800     COPY DPLS001.                                                01592025
015900     05  WORK-STORAGE-PASSED.                                     01600024
016000******************************************************************01610024
016100*PA - PROGRAM ACCUMULATORS                                        01620024
016200******************************************************************01630024
016300         10  PROGRAM-ACCUMULATORS.                                01640024
016400             15  PA-ROWS-INSERTED PIC S9(11)           VALUE ZERO 01650024
016500                                                       COMP-3.    01660024
016600             15  PA-ROWS-UPDATED  PIC S9(11)           VALUE ZERO 01670024
016700                                                       COMP-3.    01680024
016600             15  PA-DUPL-ROWS     PIC S9(11)           VALUE ZERO 01690024
016700                                                       COMP-3.    01700024
016800                                                                  01710024
016900 01  FILLER                          PIC X(4096)  VALUE SPACE.    01720024
017000                                                                  01730024
017100                                                                  01740024
017200                                                                  01750024
017300 PROCEDURE DIVISION.                                              01760024
017400******************************************************************01770024
017500* MAINLINE-PROCESSING                                             01780024
017600******************************************************************01790024
017700                                                                  01800024
017800     PERFORM A100-INITIALIZE.                                     01810024
017900                                                                  01820024
018000     PERFORM B100-PROCESS-UPDATE-RECORDS                          01830024
018100       UNTIL DP001-PREP-TRANS-EOF.                                01840024
018200                                                                  01850024
018300     PERFORM Z990-EOJ-ROUTINE.                                    01860024
018400                                                                  01870024
018500     GOBACK.                                                      01880024
018600                                                                  01890024
018700                                                                  01900024
018800******************************************************************01910024
018900* PREFORMS TASK INITIATION                                        01920024
019000******************************************************************01930024
019100 A100-INITIALIZE.                                                 01940024
019200                                                                  01950024
019300     MOVE FUNCTION CURRENT-DATE TO SYS-DATE-TIME.                 01960024
019400                                                                  01970024
019500     MOVE SYS-TIME (1:2) TO ST-BEG-HR.                            01980024
019600     MOVE SYS-TIME (3:2) TO ST-BEG-MN.                            01990024
019700                                                                  02000024
019800     MOVE SYS-DATE (1:2) TO SD-CENT.                              02010024
019900     MOVE SYS-DATE (3:2) TO SD-YEAR.                              02020024
020000     MOVE SYS-DATE (5:2) TO SD-MONTH.                             02030024
020100     MOVE SYS-DATE (7:2) TO SD-DAY.                               02040024
020200                                                                  02050024
020300     MOVE PC-TRAN-PRES-FUNC-OPEN TO DP001-FUNC-CODE.              02060024
020400                                                                  02070024
020500     PERFORM X100-BUILD-COMM-AREA-TRAN-PRES.                      02080024
020600                                                                  02090024
020700                                                                  02100024
020800******************************************************************02110024
020900* PROCESS UPDATE RECORDS                                          02120024
021000******************************************************************02130024
021100 B100-PROCESS-UPDATE-RECORDS.                                     02140024
021200                                                                  02150024
021300     SET PS-RESTART-NOT-REQUIRED TO TRUE.                         02160024
021400                                                                  02170024
021500     PERFORM C100-UPDATE-FIELDS.                                  02180024
021600                                                                  02190024
021700*----------------------------------------------------------------*02200024
021800*  IF A RESTART IS REQUIRED, ISSUE A RESTART CALL RATHER THAN A  *02210024
021900*  TRANS CALL.  THIS WILL ALLOW PROCESSING TO RESUME WITH THE    *02220024
022000*  FIRST TRANSACTION AFTER THE LAST COMMIT.                      *02230024
022100*----------------------------------------------------------------*02240024
022200     IF  PS-RESTART-REQUIRED                                      02250024
022300         MOVE PC-TRAN-PRES-FUNC-RSTRT TO DP001-FUNC-CODE          02260024
022400     ELSE                                                         02270024
022500         MOVE PC-TRAN-PRES-FUNC-TRANS TO DP001-FUNC-CODE          02280024
022600     END-IF.                                                      02290024
022700                                                                  02300024
022800     PERFORM X100-BUILD-COMM-AREA-TRAN-PRES.                      02310024
022900                                                                  02320024
023000     ADD 1 TO PA-READ.                                            02330024
023100                                                                  02340024
023100                                                                  02350024
023300******************************************************************02360024
023400* UPDATES THE TSASUM FIELDS                                       02370024
023500******************************************************************02380024
023600 C100-UPDATE-FIELDS.                                              02390024
023700                                                                  02400024
023800     MOVE SA008-PARTN-NBR      TO SASUM-PARTN-NBR.                02410024
023900     MOVE SA008-STR-NBR        TO SASUM-STR-NBR.                  02420024
024000     MOVE SA008-RGST-ID        TO SASUM-RGST-ID.                  02430024
024100     MOVE SA008-SUM-TYP-CDE    TO SASUM-SUM-TYP-CDE.              02440024
024200     MOVE SA008-SUM-CTG-CDE    TO SASUM-SUM-CTG-CDE.              02450024
024300     MOVE SA008-CTG-AMT        TO SASUM-CTG-AMT.                  02460024
024400     MOVE SA008-CTG-NBR-OF-ITM TO SASUM-CTG-NBR-OF-ITM.           02470024
024500     MOVE SA008-CTG-SRC-CDE    TO SASUM-CTG-SRC-CDE.              02480024
024600                                                                  02490024
029300     EVALUATE TRUE                                                02491024
029400        WHEN SA008-TYPE = 'INSRT'                                 02492024
024800             PERFORM C200-TSASUM-INSERT                           02510024
025000                                                                  02530024
029400        WHEN SA008-TYPE = 'UPDT1'                                 02531024
029400        WHEN SA008-TYPE = 'UPDT2'                                 02531124
024800             PERFORM C300-TSASUM-UPDATE1                          02532024
025000                                                                  02533024
029400        WHEN SA008-TYPE = 'UPDT3'                                 02534024
024800             PERFORM C400-TSASUM-UPDATE3                          02535024
025000                                                                  02536024
034000     END-EVALUATE.                                                02601024
025800                                                                  02610024
025900                                                                  02620024
026000******************************************************************02630024
026100* INSERT INTO THE TSASUM TABLE                                    02640024
026200******************************************************************02650024
026300 C200-TSASUM-INSERT.                                              02660024
026400                                                                  02670024
026500     PERFORM WITH TEST AFTER                                      02680024
026600         VARYING PV-SQL-SUB                                       02690024
026700         FROM 1 BY 1                                              02700024
026800         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       02710024
026900                OR SQLCODE = -911                                 02720024
026900                OR SQLCODE = -803                                 02730024
027000                OR SQLCODE = 0)                                   02740024
027100                                                                  02750024
027200         EXEC SQL                                                 02760024
027300             INSERT  INTO TSASUM                                  02770024
027400                  (  PARTN_NBR                                    02780024
027500                  ,  STR_NBR                                      02790024
027600                  ,  RGST_ID                                      02800024
027700                  ,  SUM_TYP_CDE                                  02810024
027800                  ,  SUM_CTG_CDE                                  02820024
027900                  ,  CTG_AMT                                      02830024
028000                  ,  CTG_NBR_OF_ITM                               02840024
028100                  ,  CTG_SRC_CDE)                                 02850024
028200              VALUES                                              02860024
028300                  (  :SASUM-PARTN-NBR                             02870024
028400                  ,  :SASUM-STR-NBR                               02880024
028500                  ,  :SASUM-RGST-ID                               02890024
028600                  ,  :SASUM-SUM-TYP-CDE                           02900024
028700                  ,  :SASUM-SUM-CTG-CDE                           02910024
028800                  ,  :SASUM-CTG-AMT                               02920024
028900                  ,  :SASUM-CTG-NBR-OF-ITM                        02930024
029000                  ,  :SASUM-CTG-SRC-CDE)                          02940024
029100         END-EXEC                                                 02950024
029200                                                                  02960024
029300         EVALUATE TRUE                                            02970024
029400             WHEN SQLCODE = 0                                     02980024
029500                 ADD +1 TO PA-ROWS-INSERTED                       02990024
029600                                                                  03000024
029700             WHEN SQLCODE = -803                                  03010024
029500                 ADD +1 TO PA-DUPL-ROWS                           03020024
029600                                                                  03030024
029700             WHEN SQLCODE = -911                                  03040024
029800                 ADD +1 TO PV-DEADLOCK-COUNTER                    03050024
029900                                                                  03060024
030000                 DISPLAY '                   '                    03070024
030100                 DISPLAY 'DEADLOCK INCOUNTERED -911'              03080024
030200                 DISPLAY 'DEADLOCK-COUNTER = ' PV-DEADLOCK-COUNTER03090024
030300                                                                  03100024
030400                 IF PV-DEADLOCK-COUNTER > PC-MAX-DEADLOCKS        03110024
030500                     MOVE 'C200-TSASUM-INSERT'                    03120024
030600                                      TO PV-PARAGRAPH-NAME        03130024
030700                     MOVE 'MAXIMUM DEADLOCKS EXCEEDED    '        03140024
030800                                      TO PV-DB2-OPER-ATTEMPTED    03150024
030900                     PERFORM Z200-SQL-ABEND                       03160024
031000                                                                  03170024
031100                 ELSE                                             03180024
031200                     SET PS-RESTART-REQUIRED TO TRUE              03190024
031300                 END-IF                                           03200024
031400                                                                  03210024
031500             WHEN OTHER                                           03220024
031600                 DISPLAY '                   '                    03230024
031700                 DISPLAY 'SQLCODE = ' SQLCODE                     03240024
031800                 DISPLAY 'DP001-FUNC-CODE = ' DP001-FUNC-CODE     03250024
031900                 DISPLAY 'DP001-RET-CODE  = ' DP001-RET-CODE      03260024
032000                 DISPLAY '                   '                    03270024
032100                 DISPLAY 'PA-ROWS-INSERTED= ' PA-ROWS-INSERTED    03280024
032200                 DISPLAY 'PA-ROWS-UPDATED = ' PA-ROWS-UPDATED     03290024
032300                 DISPLAY '                   '                    03300024
032400                 DISPLAY 'INSERT ABENDED ON: '                    03310024
032500                 DISPLAY 'PART-NBR = ' SASUM-PARTN-NBR            03320024
032600                 DISPLAY 'STR-NBR  = ' SASUM-STR-NBR              03330024
032700                 DISPLAY 'RGST-ID  = ' SASUM-RGST-ID              03340024
032800                 DISPLAY 'TYP-CDE  = ' SASUM-SUM-TYP-CDE          03350024
032900                 DISPLAY 'CTG-CDE  = ' SASUM-SUM-CTG-CDE          03360024
033000                 DISPLAY 'CTG-AMT  = ' SASUM-CTG-AMT              03370024
033100                 DISPLAY 'CTG-NBR  = ' SASUM-CTG-NBR-OF-ITM       03380024
033200                 DISPLAY 'CTG-SRC  = ' SASUM-CTG-SRC-CDE          03390024
033300                                                                  03400024
033400                 MOVE 'C200-TSASUM-INSERT'                        03410024
033500                                        TO PV-PARAGRAPH-NAME      03420024
033600                 MOVE 'TSASUM INSERT'                             03430024
033700                                        TO PV-DB2-OPER-ATTEMPTED  03440024
033800                                                                  03450024
033900                 PERFORM Z200-SQL-ABEND                           03460024
034000         END-EVALUATE                                             03470024
034100     END-PERFORM.                                                 03480024
034200                                                                  03490024
034300                                                                  03500024
034400     IF PV-SQL-SUB > PC-MAX-RETRIES                               03510024
034500         MOVE 'C200-TSASUM-INSERT'      TO PV-PARAGRAPH-NAME      03520024
034600         MOVE 'VERIFY RETRIES EXCEEDED' TO PV-DB2-OPER-ATTEMPTED  03530024
034700         PERFORM Z200-SQL-ABEND                                   03540024
034800     END-IF.                                                      03550024
034900                                                                  03560024
035000                                                                  03570024
035100******************************************************************03580024
035200* UPDATE THE TSASUM TABLE                                         03590024
035300******************************************************************03600024
035400 C300-TSASUM-UPDATE1.                                             03610024
035500                                                                  03620024
035600     PERFORM WITH TEST AFTER                                      03630024
035700         VARYING PV-SQL-SUB                                       03640024
035800         FROM 1 BY 1                                              03650024
035900         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       03660024
036000                OR SQLCODE = -911                                 03670024
036100                OR SQLCODE = 0)                                   03680024
036200                                                                  03690024
036300         EXEC SQL                                                 03700024
036400             UPDATE  TSASUM                                       03710024
036500                SET  CTG_AMT          = :SASUM-CTG-AMT            03720024
036600                    ,CTG_NBR_OF_ITM   = :SASUM-CTG-NBR-OF-ITM     03730024
036700              WHERE  PARTN_NBR        = :SASUM-PARTN-NBR          03740024
036800               AND   STR_NBR          = :SASUM-STR-NBR            03750024
036900               AND   RGST_ID          = :SASUM-RGST-ID            03760024
037000               AND   SUM_TYP_CDE      = :SASUM-SUM-TYP-CDE        03770024
037100               AND   SUM_CTG_CDE      = :SASUM-SUM-CTG-CDE        03780024
037200               AND   CTG_SRC_CDE      = :SASUM-CTG-SRC-CDE        03790024
037300         END-EXEC                                                 03800024
037400                                                                  03810024
037500         EVALUATE TRUE                                            03820024
037600             WHEN SQLCODE = 0                                     03830024
037700                 ADD +1 TO PA-ROWS-UPDATED                        03840024
037800                                                                  03850024
037900             WHEN SQLCODE = +100                                  03860024
038000                 PERFORM C200-TSASUM-INSERT                       03870024
038100                                                                  03880024
038200             WHEN SQLCODE = -911                                  03890024
038300                 ADD +1 TO PV-DEADLOCK-COUNTER                    03900024
038400                                                                  03910024
038500                 DISPLAY '                   '                    03920024
038600                 DISPLAY 'DEADLOCK INCOUNTERED -911'              03930024
038700                 DISPLAY 'DEADLOCK-COUNTER = ' PV-DEADLOCK-COUNTER03940024
038800                                                                  03950024
038900                 IF PV-DEADLOCK-COUNTER > PC-MAX-DEADLOCKS        03960024
039000                     MOVE 'C300-TSASUM-UPDATE1'                   03970024
039100                                      TO PV-PARAGRAPH-NAME        03980024
039200                     MOVE 'MAXIMUM DEADLOCKS EXCEEDED    '        03990024
039300                                      TO PV-DB2-OPER-ATTEMPTED    04000024
039400                     PERFORM Z200-SQL-ABEND                       04010024
039500                                                                  04020024
039600                 ELSE                                             04030024
039700                     SET PS-RESTART-REQUIRED TO TRUE              04040024
039800                 END-IF                                           04050024
039900                                                                  04060024
040000             WHEN OTHER                                           04070024
040100                 DISPLAY '                   '                    04080024
040200                 DISPLAY 'SQLCODE = ' SQLCODE                     04090024
040300                 DISPLAY 'DP001-FUNC-CODE = ' DP001-FUNC-CODE     04100024
040400                 DISPLAY 'DP001-RET-CODE  = ' DP001-RET-CODE      04110024
040500                 DISPLAY '                   '                    04120024
040600                 DISPLAY 'PA-ROWS-INSERTED= ' PA-ROWS-INSERTED    04130024
040700                 DISPLAY 'PA-ROWS-UPDATED = ' PA-ROWS-UPDATED     04140024
040800                 DISPLAY '                   '                    04150024
040900                 DISPLAY 'UPDATE ABENDED ON: '                    04160024
041000                 DISPLAY 'PART-NBR = ' SASUM-PARTN-NBR            04170024
041100                 DISPLAY 'STR-NBR  = ' SASUM-STR-NBR              04180024
041200                 DISPLAY 'RGST-ID  = ' SASUM-RGST-ID              04190024
041300                 DISPLAY 'TYP-CDE  = ' SASUM-SUM-TYP-CDE          04200024
041400                 DISPLAY 'CTG-CDE  = ' SASUM-SUM-CTG-CDE          04210024
041500                 DISPLAY 'CTG-AMT  = ' SASUM-CTG-AMT              04220024
041600                 DISPLAY 'CTG-NBR  = ' SASUM-CTG-NBR-OF-ITM       04230024
041700                 DISPLAY 'CTG-SRC  = ' SASUM-CTG-SRC-CDE          04240024
041800                                                                  04250024
041900                 MOVE 'C300-TSASUM-UPDATE1'                       04260024
042000                                        TO PV-PARAGRAPH-NAME      04270024
042100                 MOVE 'TSASUM INSERT'                             04280024
042200                                        TO PV-DB2-OPER-ATTEMPTED  04290024
042300                                                                  04300024
042400                 PERFORM Z200-SQL-ABEND                           04310024
042500         END-EVALUATE                                             04320024
042600     END-PERFORM.                                                 04330024
042700                                                                  04340024
042800                                                                  04350024
042900     IF PV-SQL-SUB > PC-MAX-RETRIES                               04360024
043000         MOVE 'C300-TSASUM-UPDATE1'     TO PV-PARAGRAPH-NAME      04370024
043100         MOVE 'VERIFY RETRIES EXCEEDED' TO PV-DB2-OPER-ATTEMPTED  04380024
043200         PERFORM Z200-SQL-ABEND                                   04390024
043300     END-IF.                                                      04400024
043400                                                                  04410024
043500                                                                  04420024
043600******************************************************************04430024
043700* UPDATE THE TSASUM TABLE                                         04440024
043800******************************************************************04450024
043900 C400-TSASUM-UPDATE3.                                             04460024
044000                                                                  04470024
044100     PERFORM WITH TEST AFTER                                      04480024
044200         VARYING PV-SQL-SUB                                       04490024
044300         FROM 1 BY 1                                              04500024
044400         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       04510024
044500                OR SQLCODE = -911                                 04520024
044600                OR SQLCODE = 0)                                   04530024
044700                                                                  04540024
044800         EXEC SQL                                                 04550024
044900             UPDATE  TSASUM                                       04560024
045000                SET  CTG_AMT          = :SASUM-CTG-AMT            04570024
045100                    ,CTG_NBR_OF_ITM   = :SASUM-CTG-NBR-OF-ITM     04580024
045200                    ,CTG_SRC_CDE      = :SASUM-CTG-SRC-CDE        04590024
045300              WHERE  PARTN_NBR        = :SASUM-PARTN-NBR          04600024
045400               AND   STR_NBR          = :SASUM-STR-NBR            04610024
045500               AND   RGST_ID          = :SASUM-RGST-ID            04620024
045600               AND   SUM_TYP_CDE      = :SASUM-SUM-TYP-CDE        04630024
045700               AND   SUM_CTG_CDE      = :SASUM-SUM-CTG-CDE        04640024
045800         END-EXEC                                                 04650024
045900                                                                  04660024
046000         EVALUATE TRUE                                            04670024
046100             WHEN SQLCODE = 0                                     04680024
046200                 ADD +1 TO PA-ROWS-UPDATED                        04690024
046300                                                                  04700024
046400             WHEN SQLCODE = +100                                  04710024
046500                 PERFORM C200-TSASUM-INSERT                       04720024
046600                                                                  04730024
046700             WHEN SQLCODE = -911                                  04740024
046800                 ADD +1 TO PV-DEADLOCK-COUNTER                    04750024
046900                                                                  04760024
047000                 DISPLAY '                   '                    04770024
047100                 DISPLAY 'DEADLOCK INCOUNTERED -911'              04780024
047200                 DISPLAY 'DEADLOCK-COUNTER = ' PV-DEADLOCK-COUNTER04790024
047300                                                                  04800024
047400                 IF PV-DEADLOCK-COUNTER > PC-MAX-DEADLOCKS        04810024
047500                     MOVE 'C400-TSASUM-UPDATE3'                   04820024
047600                                      TO PV-PARAGRAPH-NAME        04830024
047700                     MOVE 'MAXIMUM DEADLOCKS EXCEEDED    '        04840024
047800                                      TO PV-DB2-OPER-ATTEMPTED    04850024
047900                     PERFORM Z200-SQL-ABEND                       04860024
048000                                                                  04870024
048100                 ELSE                                             04880024
048200                     SET PS-RESTART-REQUIRED TO TRUE              04890024
048300                 END-IF                                           04900024
048400                                                                  04910024
048500             WHEN OTHER                                           04920024
048600                 DISPLAY '                   '                    04930024
048700                 DISPLAY 'SQLCODE = ' SQLCODE                     04940024
048800                 DISPLAY 'DP001-FUNC-CODE = ' DP001-FUNC-CODE     04950024
048900                 DISPLAY 'DP001-RET-CODE  = ' DP001-RET-CODE      04960024
049000                 DISPLAY '                   '                    04970024
049100                 DISPLAY 'PA-ROWS-INSERTED= ' PA-ROWS-INSERTED    04980024
049200                 DISPLAY 'PA-ROWS-UPDATED = ' PA-ROWS-UPDATED     04990024
049300                 DISPLAY '                   '                    05000024
049400                 DISPLAY 'UPDATE ABENDED ON: '                    05010024
049500                 DISPLAY 'PART-NBR = ' SASUM-PARTN-NBR            05020024
049600                 DISPLAY 'STR-NBR  = ' SASUM-STR-NBR              05030024
049700                 DISPLAY 'RGST-ID  = ' SASUM-RGST-ID              05040024
049800                 DISPLAY 'TYP-CDE  = ' SASUM-SUM-TYP-CDE          05050024
049900                 DISPLAY 'CTG-CDE  = ' SASUM-SUM-CTG-CDE          05060024
050000                 DISPLAY 'CTG-AMT  = ' SASUM-CTG-AMT              05070024
050100                 DISPLAY 'CTG-NBR  = ' SASUM-CTG-NBR-OF-ITM       05080024
050200                 DISPLAY 'CTG-SRC  = ' SASUM-CTG-SRC-CDE          05090024
050300                                                                  05100024
050400                 MOVE 'C400-TSASUM-UPDATE3'                       05110024
050500                                        TO PV-PARAGRAPH-NAME      05120024
050600                 MOVE 'TSASUM INSERT'                             05130024
050700                                        TO PV-DB2-OPER-ATTEMPTED  05140024
050800                                                                  05150024
050900                 PERFORM Z200-SQL-ABEND                           05160024
051000         END-EVALUATE                                             05170024
051100     END-PERFORM.                                                 05180024
051200                                                                  05190024
051300                                                                  05200024
051400     IF PV-SQL-SUB > PC-MAX-RETRIES                               05210024
051500         MOVE 'C400-TSASUM-UPDATE3'     TO PV-PARAGRAPH-NAME      05220024
051600         MOVE 'VERIFY RETRIES EXCEEDED' TO PV-DB2-OPER-ATTEMPTED  05230024
051700         PERFORM Z200-SQL-ABEND                                   05240024
051800     END-IF.                                                      05250024
051900                                                                  05260024
052000                                                                  05270024
052100******************************************************************05280024
052200* BUILD THE COMMUNICATION AREA FOR A CALL TO THE TRANSACTION      05290024
052300* PRESENTATION MODULE                                             05300024
052400******************************************************************05310024
052500 X100-BUILD-COMM-AREA-TRAN-PRES.                                  05320024
052600                                                                  05330024
052700     MOVE LENGTH OF                                               05340024
052800          WORK-STORAGE-PASSED TO DP001-WORK-STRG-LENGTH.          05350024
052900     MOVE PC-CKPT-JOB-NAME    TO DP001-JOB-NAME.                  05360024
053000     MOVE PC-CKPT-PLAN-NAME   TO DP001-PLAN-NAME.                 05370024
053100                                                                  05380024
053200     PERFORM X200-CALL-TRANS-PRES-MODULE.                         05390024
053300                                                                  05400024
053400     MOVE DP001-TRANS-RECORD  TO SA008-TSASUM-REC.                05410024
053500                                                                  05420024
053600     IF  DP001-CKPT-TAKEN                                         05430024
053700         ADD 1 TO PA-CKPT                                         05440024
054200                                                                  05450024
054300         INITIALIZE PV-DEADLOCK-COUNTER                           05460024
054400     END-IF.                                                      05470024
054500                                                                  05480024
054600                                                                  05490024
054700******************************************************************05500024
054800* VERIFY THE RETURN CODE ON THE CALLED MODULE                     05510024
054900******************************************************************05520024
055000 X200-CALL-TRANS-PRES-MODULE.                                     05530024
055100                                                                  05540024
055200     PERFORM Z900-CALL-TRANS-PRES-MODULE.                         05550024
055300                                                                  05560024
055400     IF  DP001-GOOD-RET-CODE                                      05570024
055500     OR  DP001-CKPT-TAKEN                                         05580024
055600     OR  DP001-RESTART                                            05590024
055700         CONTINUE                                                 05600024
055800                                                                  05610024
055900     ELSE                                                         05620024
056000         MOVE 'X200-CALL-TRANS-PRES-MODULE' TO PV-PARAGRAPH-NAME  05630024
056100         MOVE '** BAD CALL TO TRANS PREP MODULE **'               05640024
056200                                            TO PV-OPERATION-MSG   05650024
056300         MOVE DP001-RET-CODE                TO PV-RET-CODE        05660024
056400                                                                  05670024
056500         SET ABEND-4019-CAL-SUB-ERROR TO TRUE                     05680024
056600                                                                  05690024
056700         PERFORM Z100-ABEND                                       05700024
056800     END-IF.                                                      05710024
056900                                                                  05720024
057000                                                                  05730024
057100******************************************************************05740024
057200* NON-DB2 ABEND                                                   05750024
057300******************************************************************05760024
057400 Z100-ABEND.                                                      05770024
057500                                                                  05780024
057600     PERFORM Z999-CONTROLS.                                       05790024
057700                                                                  05800024
057800     DISPLAY '                     '.                             05810024
057900     DISPLAY '** ABEND           **'.                             05820024
058000     DISPLAY '** PROGRAM         ** = ' PC-PROGRAM-NAME.          05830024
058100     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        05840024
058200     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG.         05850024
058300     DISPLAY '** RETURN CODE     ** = ' PV-RET-CODE.              05860024
058400                                                                  05870024
058500     CALL 'ILBOABN0' USING ABEND-CODE.                            05880024
058600                                                                  05890024
058700                                                                  05900024
058800******************************************************************05910024
058900* ABEND THE PROGRAM IN THE EVENT THAT A SQL ERROR OR WARNING      05920024
059000* CODE OCCURS.                                                    05930024
059100******************************************************************05940024
059200 Z200-SQL-ABEND.                                                  05950024
059300                                                                  05960024
059400     PERFORM Z999-CONTROLS.                                       05970024
059500                                                                  05980024
059600     DISPLAY '** ABEND     **'.                                   05990024
059700     DISPLAY '** PROGRAM   ** = ' PC-PROGRAM-NAME.                06000024
059800     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              06010024
059900     DISPLAY '** OPERATION ** = ' PV-DB2-OPER-ATTEMPTED.          06020024
060000                                                                  06030024
060100******************************************************************06040024
060200* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    06050024
060300* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         06060024
060400* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     06070024
060500* FORMAT.                                                         06080024
060600******************************************************************06090024
060700     COPY DPPD004.                                                06100024
060800                                                                  06110024
060900     SET ABEND-4013-DB2-ERROR TO TRUE.                            06120024
061000                                                                  06130024
061100     CALL 'ILBOABN0' USING ABEND-CODE.                            06140024
061200                                                                  06150024
061300                                                                  06160024
061400******************************************************************06170024
061500* PREFORMS TASK TERMINATION PROCESSING                            06180024
061600******************************************************************06190024
061700 Z990-EOJ-ROUTINE.                                                06200024
061800                                                                  06210024
061900     MOVE PC-TRAN-PRES-FUNC-CLOSE TO DP001-FUNC-CODE.             06220024
062000                                                                  06230024
062100     PERFORM X100-BUILD-COMM-AREA-TRAN-PRES.                      06240024
062200                                                                  06250024
062300     PERFORM Z999-CONTROLS.                                       06260024
062400                                                                  06270024
062500                                                                  06280024
062600******************************************************************06290024
062700* DISPLAY CONTROLS FROM THE PROGRAM                               06300024
062800******************************************************************06310024
062900 Z999-CONTROLS.                                                   06320024
063000                                                                  06330024
063100     MOVE FUNCTION CURRENT-DATE TO SYS-DATE-TIME.                 06340024
063200                                                                  06350024
063300     MOVE SYS-TIME (1:2) TO ST-END-HR.                            06360024
063400     MOVE SYS-TIME (3:2) TO ST-END-MN.                            06370024
063500                                                                  06380024
063600     DISPLAY '                    '.                              06390024
063700     DISPLAY '**********************'.                            06400024
063800     DISPLAY '   SAKUP002 CONTROLS  '.                            06410024
063900     DISPLAY '**********************'.                            06420024
064000     DISPLAY 'RUN DATE  = ' SD-EDIT-DATE.                         06430024
064100     DISPLAY 'BEG TIME  = ' ST-BEG-TIME.                          06440024
064200     DISPLAY 'END TIME  = ' ST-END-TIME.                          06450024
064300     DISPLAY '======================'.                            06460024
064400     DISPLAY 'RECORDS READ   = ' PA-READ.                         06470024
064400     DISPLAY 'CHECKPOINTS    = ' PA-CKPT.                         06480024
064500     DISPLAY '                '.                                  06490024
064600     DISPLAY 'ROWS INSERTED  = ' PA-ROWS-INSERTED.                06500024
064700     DISPLAY 'ROWS UPDATED   = ' PA-ROWS-UPDATED.                 06510024
064800     DISPLAY '                '.                                  06520024
064700     DISPLAY 'DUPLICATE ROWS = ' PA-DUPL-ROWS.                    06530024
064800     DISPLAY '                '.                                  06540024
064900                                                                  06550024
065000                                                                  06560024
065100******************************************************************06570024
065200* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    06580024
065300* MENTS THAT ARE REQUIRED TO INVOKE THE TRANSACTION PRESENTATION  06590024
065400* MODULE (DPKUT901) OF THE DB2 CHECKPOINT RESTART SYSTEM.         06600024
065500******************************************************************06610024
065600     COPY DPPD001.                                                06620024
065700                                                                  06630024
065800                                                                  06640024
