       IDENTIFICATION DIVISION.                                         00010000
       PROGRAM-ID.    XSKUP029.                                         00020047
       AUTHOR.        KOHLS DEPARTMENT STORES.                          00030000
       INSTALLATION.  KOHLS DEPARTMENT STORES.                          00040000
       DATE-WRITTEN.  10/07/2002.                                       00050047
       DATE-COMPILED.                                                   00060000
      ******************************************************************00070000
      **       MERCHANDISE HIERARCHY MESSAGE FOR TABLE XST_DEPT         00080047
      ******************************************************************00090024
      **THIS IS A CALLED MODULE FOR DEPT MERCH HIER TABLES.  THIS       00100047
      **     PROGRAM WILL PERFORM UPDATES/INSERTS/DELETES FOR THIS      00110036
      **     TABLE.  IT DOES THE FOLLOWING WITH THESE RETURN CODES:     00120036
      **     0000 - END PROGRAM                                         00130024
      **    -0530 - END PROGRAM                                         00140024
      **    -0803 - COMPARE TIMESTAMPS AND UPDATE IF MESSAGE IS NEWER   00150024
      **    -0911 - RETRY INSERT UP TO 5 TIMES AND THEN END PROGRAM     00160024
      ******************************************************************00170000
      **10/07/2002 CHANGED BY:JULIE SMITH          PROGRAM WRITE        00180047
010103**01/01/2003 CHANGED BY:JULIE SMITH  ADDITIONAL TIMESTAMP         00190051
      ******************************************************************00200058
092404**09/24/2004 CHANGED BY:GAYLE HAUPT  WR27107   FIELDS ADDED:      00210058
092404**     DMA-NBR, STR-ZN-CDE, BYR-NBR, CONT-CLR-EXCLN-IND           00220055
      ******************************************************************00230000
111504**11/15/2004 CHANGED BY:JULIE TEWES  WR27840   INCLUDE            00240059
111504**     XST_DEPT_ATTR TABLE                                        00250059
      ******************************************************************00260059
       ENVIRONMENT DIVISION.                                            00270000
       CONFIGURATION SECTION.                                           00280000
       SOURCE-COMPUTER.  IBM-3090.                                      00290000
       OBJECT-COMPUTER.  IBM-3090.                                      00300000
       DATA DIVISION.                                                   00310000
                                                                        00320017
       WORKING-STORAGE SECTION.                                         00330017
      ******************************************************************00340000
      **PROGRAM SWITCHES                                                00350000
      ******************************************************************00360000
       01  PS-PROGRAM-SWITCHES.                                         00370000
           05  PS-PROCESS-CONTINUE-SW      PIC X(01)  VALUE 'Y'.        00380020
               88  PS-PROCESS-CONTINUE                VALUE 'Y'.        00390018
               88  PS-PROCESS-COMPLETE                VALUE 'N'.        00400018
      ******************************************************************00410000
      **PROGRAM COUNTERS                                                00420018
      ******************************************************************00430000
       01  PC-PROGRAM-COUNTERS.                                         00440018
           05  PC-RETRY-COUNTER            PIC 9(01)  VALUE ZEROS.      00450018
           05  PC-RETRY-COUNTER-2          PIC 9(01)  VALUE ZEROS.      00460019
           05  PC-RETRY-MAX                PIC 9(01)  VALUE 5.          00470024
      ******************************************************************00480018
      **PROGRAM VARIABLES                                               00490018
      ******************************************************************00500018
       01  PV-PROGRAM-VARIABLES.                                        00510018
           05  PV-PARAGRAPH-NAME               PIC X(20)  VALUE SPACES. 00520019
           05  PV-TIME-EVALUATE-INSERT.                                 00530019
               10  PV-TIME-HOUR-IN             PIC  9(02) VALUE ZEROS.  00540019
               10  PV-TIME-MINUTE-IN           PIC  9(02) VALUE ZEROS.  00550019
               10  PV-TIME-SECOND-IN           PIC  9(02) VALUE ZEROS.  00560019
               10  PV-TIME-MICROSEC-IN         PIC  9(06) VALUE ZEROS.  00570019
           05  PV-TIME-EVALUATE-UPDATE.                                 00580019
               10  PV-TIME-HOUR-UP             PIC  9(02) VALUE ZEROS.  00590019
               10  PV-TIME-MINUTE-UP           PIC  9(02) VALUE ZEROS.  00600019
               10  PV-TIME-SECOND-UP           PIC  9(02) VALUE ZEROS.  00610019
               10  PV-TIME-MICROSEC-UP         PIC  9(06) VALUE ZEROS.  00620019
      ******************************************************************00630018
      **TIMESTAMP VARIABLES                                             00640018
      ******************************************************************00650018
       01  SD-TIMESTAMP-COMPARE                PIC  X(26).              00660054
       01  SD-TIMESTAMP.                                                00670054
           05  SD-CURR-DTE                     PIC  X(10).              00680018
           05  FILLER                          PIC  X(01) VALUE '-'.    00690052
           05  SD-HOUR                         PIC  9(02).              00700052
           05  FILLER                          PIC  X(01) VALUE '.'.    00710052
           05  SD-MINUTE                       PIC  9(02).              00720052
           05  FILLER                          PIC  X(01) VALUE '.'.    00730052
           05  SD-SECOND                       PIC  9(02).              00740052
           05  FILLER                          PIC  X(01) VALUE '.'.    00750052
           05  SD-MICROSEC                     PIC  9(06).              00760052
      ******************************************************************00770000
      **COPYBOOKS                                                       00780000
      ******************************************************************00790000
      ***DB2 MESSAGE AREA                                               00800000
           COPY SQLCA2.                                                 00810055
      ***MESSAGE COPYBOOK                                               00820018
           COPY HMRD001.                                                00830055
      ***DATE ROUTINE COPYBOOK                                          00840019
           COPY DPWS500.                                                00850055
      ******************************************************************00860000
      **TABLE INCLUSIONS                                                00870000
      ******************************************************************00880000
      ***DB2 COMMUNICATIONS AREA                                        00890000
           EXEC SQL                                                     00900000
                INCLUDE SQLCA                                           00910000
           END-EXEC.                                                    00920000
      ***XST_DEPT TABLE                                                 00930047
           EXEC SQL                                                     00940000
                INCLUDE XST00015                                        00950047
           END-EXEC.                                                    00960000
111504***XST_DEPT_ATTR TABLE                                            00970059
111504     EXEC SQL                                                     00980059
111504          INCLUDE XST00082                                        00990060
111504     END-EXEC.                                                    01000059
                                                                        01010000
       LINKAGE SECTION.                                                 01020000
      ******************************************************************01030000
      **LINKAGE VARIABLES                                               01040000
      ******************************************************************01050000
       01  LV-HMRD001-RECORD               PIC X(500).                  01060041
       01  LV-RETURN-CODE                  PIC S9(04).                  01070017
010103 01  LV-CURRENT-TIMESTAMP            PIC X(26).                   01080051
                                                                        01090024
       PROCEDURE DIVISION USING LV-HMRD001-RECORD,                      01100036
                                LV-RETURN-CODE,                         01110051
010103                          LV-CURRENT-TIMESTAMP.                   01120051
      ******************************************************************01130000
       0000-MAINLINE.                                                   01140000
                                                                        01150000
            PERFORM 1000-INITIALIZATION.                                01160000
            PERFORM 2000-PROCESS-MESSAGE                                01170037
                    UNTIL PS-PROCESS-COMPLETE.                          01180018
            PERFORM 9999-WRAPUP.                                        01190000
                                                                        01200000
       EJECT.                                                           01210018
      ***************************************************************** 01220000
      **INITIALIZATION AREA - ALL MOVES TO UPDATE/INSERT                01230024
      ***************************************************************** 01240000
       1000-INITIALIZATION.                                             01250000
                                                                        01260000
           MOVE '1000-INITIALIZATION'      TO PV-PARAGRAPH-NAME.        01270018
                                                                        01280018
           SET PS-PROCESS-CONTINUE         TO TRUE.                     01290020
           INITIALIZE PC-RETRY-COUNTER.                                 01300018
           INITIALIZE SD-TIMESTAMP.                                     01310042
                                                                        01320023
           MOVE LV-HMRD001-RECORD          TO HMRD001-RECORD.           01330036
           MOVE HM001-DEPS-DEPT            TO XST00015-DEPT-NBR.        01340047
           MOVE HM001-DEPS-DEPT-NAME       TO XST00015-DEPT-NM.         01350047
092404     MOVE HM001-DEPS-GROUP-NO        TO XST00015-DMA-NBR.         01360055
092404     MOVE HM001-DEPS-BUYER           TO XST00015-BYR-NBR.         01370055
                                                                        01380042
010103     MOVE LV-CURRENT-TIMESTAMP       TO XST00015-LAST-UPD-TMST.   01390051
           INITIALIZE SD-TIMESTAMP.                                     01400042
                                                                        01410054
010103     MOVE HM001-CRE-TMST             TO SD-CURR-DTE.              01420053
010103     MOVE SD-TIMESTAMP              TO XST00015-SOR-LAST-MSG-TMST.01430051
010103     INITIALIZE SD-TIMESTAMP.                                     01440051
                                                                        01450042
       EJECT.                                                           01460042
      ***************************************************************** 01470001
      **MAIN PROGRAM LOGIC - READS ACTION TYPE ON HMRD001 RECORD        01480044
      ***************************************************************** 01490001
       2000-PROCESS-MESSAGE.                                            01500037
                                                                        01510000
           MOVE '2000-PROCESS-MESSAGE' TO PV-PARAGRAPH-NAME.            01520037
                                                                        01530017
           EVALUATE TRUE                                                01540037
              WHEN HM001-ACTN-TYP-INSERT                                01550037
                   PERFORM 2100-INSERT-DATA                             01560037
              WHEN HM001-ACTN-TYP-UPDATE                                01570037
                   PERFORM 2200-UPDATE-DATA                             01580037
              WHEN HM001-ACTN-TYP-DELETE                                01590037
                   PERFORM 2300-DELETE-DATA                             01600039
           END-EVALUATE.                                                01610037
                                                                        01620037
       EJECT.                                                           01630037
      ***************************************************************** 01640037
      **INSERT ACTION TYPE                                              01650044
      ***************************************************************** 01660037
       2100-INSERT-DATA.                                                01670037
                                                                        01680037
           MOVE '2100-INSERT-DATA'     TO PV-PARAGRAPH-NAME.            01690057
                                                                        01700037
           EXEC SQL                                                     01710018
                INSERT INTO XST_DEPT (DEPT_NBR                          01720047
                                    , BUS_GP_NBR                        01730047
                                    , DEPT_NM                           01740047
                                    , MDSE_LNE_CDE                      01750047
                                    , LAST_UPD_TMST                     01760051
010103                              , SOR_LAST_MSG_TMST                 01770055
092404                              , DMA_NBR                           01780055
092404                              , STR_ZN_CDE                        01790055
092404                              , BYR_NBR                           01800055
092404                              , CONT_CLR_EXCLN_IND)               01810056
                VALUES (:XST00015-DEPT-NBR                              01820047
                      , 99                                              01830051
                      , :XST00015-DEPT-NM                               01840047
                      , 'S'                                             01850051
                      , :XST00015-LAST-UPD-TMST                         01860051
010103                , :XST00015-SOR-LAST-MSG-TMST                     01870055
092404                , :XST00015-DMA-NBR                               01880055
092404                , 'AAAAA'                                         01890057
092404                , :XST00015-BYR-NBR                               01900055
092404                , 'N')                                            01910055
           END-EXEC.                                                    01920018
                                                                        01930004
           EVALUATE TRUE                                                01940020
      ***SUCCESSFUL PROCESSING                                          01950051
              WHEN SQLCODE = ZEROS                                      01960020
111504             PERFORM 2150-INSERT-ATTR-DATA                        01970059
      ***REFERENTIAL INTEGRITY ISSUES                                   01980051
              WHEN SQLCODE = -530                                       01990020
              WHEN SQLCODE = -532                                       02000051
                   SET PS-PROCESS-COMPLETE   TO TRUE                    02010018
      ***ROW ALREADY EXISTS                                             02020051
              WHEN SQLCODE = -803                                       02030020
                   PERFORM 2150-SELECT-DATA                             02040038
      ***ROW/TABLE LOCK                                                 02050051
              WHEN SQLCODE = -911                                       02060028
              WHEN SQLCODE = -913                                       02070050
                   IF  PC-RETRY-COUNTER >= PC-RETRY-MAX                 02080031
                       SET PS-PROCESS-COMPLETE TO TRUE                  02090018
                   ELSE                                                 02100018
                       ADD +1                  TO PC-RETRY-COUNTER      02110027
                   END-IF                                               02120018
              WHEN OTHER                                                02130018
                   SET PS-PROCESS-COMPLETE     TO TRUE                  02140018
           END-EVALUATE.                                                02150018
                                                                        02160001
       EJECT.                                                           02170018
111504***************************************************************** 02180059
111504**INSERT RECORD INTO XST_DEPT_ATTR                                02190059
111504***************************************************************** 02200059
111504 2150-INSERT-ATTR-DATA.                                           02210059
                                                                        02220059
111504     MOVE '2150-INSERT-ATTR-DATA' TO PV-PARAGRAPH-NAME.           02230059
                                                                        02240059
111504     EXEC SQL                                                     02250059
111504          INSERT INTO XST_DEPT_ATTR                               02260059
111504                              ( DEPT_NBR                          02270059
111504                              , CLOR_DESC_TYP_CDE)                02280059
111504          VALUES (:XST00015-DEPT-NBR                              02290059
111504                ,  'NRF')                                         02300059
111504     END-EXEC.                                                    02310059
                                                                        02320059
111504     EVALUATE TRUE                                                02330059
111504***SUCCESSFUL PROCESSING                                          02340059
111504        WHEN SQLCODE = ZEROS                                      02350059
111504             SET PS-PROCESS-COMPLETE   TO TRUE                    02360059
111504***REFERENTIAL INTEGRITY ISSUES                                   02370059
111504        WHEN SQLCODE = -530                                       02380059
111504        WHEN SQLCODE = -532                                       02390059
111504             SET PS-PROCESS-COMPLETE   TO TRUE                    02400059
111504***ROW/TABLE LOCK                                                 02410059
111504        WHEN SQLCODE = -911                                       02420059
111504        WHEN SQLCODE = -913                                       02430059
111504             IF  PC-RETRY-COUNTER >= PC-RETRY-MAX                 02440059
111504                 SET PS-PROCESS-COMPLETE TO TRUE                  02450059
111504             ELSE                                                 02460059
111504                 ADD +1                  TO PC-RETRY-COUNTER      02470059
111504             END-IF                                               02480059
111504        WHEN OTHER                                                02490059
111504             SET PS-PROCESS-COMPLETE     TO TRUE                  02500059
111504     END-EVALUATE.                                                02510059
                                                                        02520059
111504 EJECT.                                                           02530059
      ******************************************************************02540059
      *SELECT DATE FROM EXISTING RECORD FOR COMPARISON TO MESSAGE DATE  02550044
      ******************************************************************02560018
       2150-SELECT-DATA.                                                02570038
                                                                        02580018
           MOVE '2150-SELECT-DATA' TO PV-PARAGRAPH-NAME                 02590038
                                                                        02600018
           EXEC SQL                                                     02610018
                SELECT LAST_UPD_TMST                                    02620018
                INTO  :SD-TIMESTAMP-COMPARE                             02630054
                FROM   XST_DEPT                                         02640047
                WHERE DEPT_NBR   = :XST00015-DEPT-NBR                   02650047
           END-EXEC.                                                    02660018
                                                                        02670018
           EVALUATE TRUE                                                02680020
      ***SUCCESSFUL PROCESSING                                          02690051
              WHEN SQLCODE = ZEROS                                      02700020
                   PERFORM 2153-DATE-COMPARE                            02710038
              WHEN OTHER                                                02720018
                   SET PS-PROCESS-COMPLETE     TO TRUE                  02730018
           END-EVALUATE.                                                02740018
                                                                        02750018
       EJECT.                                                           02760018
      ******************************************************************02770018
      **COMPARE DATE OF EXISTING ROW TO MESSAGE AND UPDATE IF MESSAGE   02780024
      **        HAS A NEWER TIMESTAMP.                                  02790024
      ******************************************************************02800018
       2153-DATE-COMPARE.                                               02810038
                                                                        02820018
           MOVE '2153-DATE-COMPARE' TO PV-PARAGRAPH-NAME                02830038
                                                                        02840018
           INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              02850018
                                                                        02860018
           SET DPG53-LK-CMPR-DTE-ISO-FMT TO TRUE.                       02870018
           SET DPG52-LK-DTE-ISO-FMT       TO TRUE.                      02880033
           SET DPG51-ACTUAL-CALENDAR-ONLY TO TRUE.                      02890033
           MOVE HM001-CRE-TMST           TO DPG52-LK-DATE-INPUT.        02900042
           MOVE SD-TIMESTAMP-COMPARE     TO DPG53-LK-CMPR-DATE-INPUT.   02910054
                                                                        02920018
           CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51                02930018
                                                   DPG52                02940018
                                                   DPG53                02950018
                                                   DPG54                02960018
                                                   DPG55                02970018
                                                   DPG56.               02980018
                                                                        02990018
           EVALUATE TRUE                                                03000019
              WHEN DPG55-DAYS-DIFFERENCE = 0                            03010019
                   PERFORM 2200-UPDATE-DATA                             03020042
                           UNTIL PS-PROCESS-COMPLETE                    03030042
              WHEN DPG55-DAYS-DIFFERENCE < ZERO                         03040019
                   SET PS-PROCESS-COMPLETE     TO TRUE                  03050019
              WHEN DPG55-DAYS-DIFFERENCE > ZERO                         03060019
                   PERFORM 2200-UPDATE-DATA                             03070019
                           UNTIL PS-PROCESS-COMPLETE                    03080024
           END-EVALUATE.                                                03090019
                                                                        03100018
       EJECT.                                                           03110018
      ******************************************************************03120019
      **UPDATE ACTION TYPE                                              03130044
      ******************************************************************03140019
       2200-UPDATE-DATA.                                                03150019
                                                                        03160019
           MOVE '2200-UPDATE-DATA' TO PV-PARAGRAPH-NAME                 03170019
                                                                        03180019
           EXEC SQL                                                     03190019
              UPDATE XST_DEPT                                           03200047
                  SET   DEPT_NM       = :XST00015-DEPT-NM               03210049
                      , LAST_UPD_TMST = :XST00015-LAST-UPD-TMST         03220047
010103                , SOR_LAST_MSG_TMST = :XST00015-SOR-LAST-MSG-TMST 03230051
092404                , DMA_NBR       = :XST00015-DMA-NBR               03240055
092404                , BYR_NBR       = :XST00015-BYR-NBR               03250055
                  WHERE DEPT_NBR      = :XST00015-DEPT-NBR              03260047
           END-EXEC.                                                    03270019
                                                                        03280019
           EVALUATE TRUE                                                03290020
      ***SUCCESSFUL PROCESSING                                          03300051
              WHEN SQLCODE = ZEROS                                      03310020
                   SET PS-PROCESS-COMPLETE     TO TRUE                  03320019
      ***ROW/TABLE LOCK                                                 03330051
              WHEN SQLCODE = -911                                       03340020
              WHEN SQLCODE = -913                                       03350050
                   IF  PC-RETRY-COUNTER-2 >= PC-RETRY-MAX               03360035
                       SET PS-PROCESS-COMPLETE TO TRUE                  03370019
                   ELSE                                                 03380019
                       ADD +1                  TO PC-RETRY-COUNTER-2    03390024
                   END-IF                                               03400019
              WHEN OTHER                                                03410019
                   SET PS-PROCESS-COMPLETE     TO TRUE                  03420038
           END-EVALUATE.                                                03430019
                                                                        03440019
       EJECT.                                                           03450019
      ******************************************************************03460039
      **DELETE TYPE ACTION                                              03470044
      ******************************************************************03480039
       2300-DELETE-DATA.                                                03490039
                                                                        03500039
           MOVE '2300-DELETE-DATA' TO PV-PARAGRAPH-NAME                 03510039
                                                                        03520039
           EXEC SQL                                                     03530041
                DELETE FROM XST_DEPT                                    03540047
                WHERE DEPT_NBR   = :XST00015-DEPT-NBR                   03550047
           END-EXEC.                                                    03560041
                                                                        03570041
           EVALUATE TRUE                                                03580041
      ***SUCCESSFUL PROCESSING                                          03590051
              WHEN SQLCODE = ZEROS                                      03600041
                   SET PS-PROCESS-COMPLETE     TO TRUE                  03610041
      ***ROW DOES NOT EXIST                                             03620051
              WHEN SQLCODE = +100                                       03630045
                   SET PS-PROCESS-COMPLETE     TO TRUE                  03640045
      ***ROW/TABLE LOCK                                                 03650051
              WHEN SQLCODE = -911                                       03660041
              WHEN SQLCODE = -913                                       03670050
                   IF  PC-RETRY-COUNTER-2 >= PC-RETRY-MAX               03680041
                       SET PS-PROCESS-COMPLETE TO TRUE                  03690041
                   ELSE                                                 03700041
                       ADD +1                  TO PC-RETRY-COUNTER-2    03710041
                   END-IF                                               03720041
              WHEN OTHER                                                03730041
                   SET PS-PROCESS-COMPLETE     TO TRUE                  03740041
           END-EVALUATE.                                                03750041
                                                                        03760041
       EJECT.                                                           03770039
      ******************************************************************03780000
      **PASS SQLCODE TO CALLING AND EXIT PROGRAM                        03790024
      ******************************************************************03800000
       9999-WRAPUP.                                                     03810000
                                                                        03820000
           MOVE '9999-WRAPUP' TO PV-PARAGRAPH-NAME                      03830018
                                                                        03840000
           MOVE SQLCODE       TO LV-RETURN-CODE.                        03850018
           DISPLAY 'XSKUP029 - DEPT NBR: ' XST00015-DEPT-NBR            03860047
                            ' WITH RETURN-CODE ' LV-RETURN-CODE.        03870046
           EXIT PROGRAM.                                                03880000
                                                                        03890000
       EJECT.                                                           03900018
