000100******************************************************************00010022
000200 IDENTIFICATION DIVISION.                                         00020022
000300******************************************************************00030022
000400                                                                  00040022
000500 PROGRAM-ID.    MRKUT159.                                         00050022
000600 AUTHOR.        KUSHAL BOTHRA.                                    00060022
000700 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00070022
000800 DATE-WRITTEN   07/03.                                            00080022
000900 DATE-COMPILED.                                                   00090022
001000                                                                  00100022
001100******************************************************************00110022
001200*   READ INFOREM HEADER AND DETAIL FILES AS INPUT AND CREATE AN   00120022
001300*     OUTPUT FILE THAT WILL BE USED TO SEND DATA TO THE STAGING   00130022
001400*   - API                                                         00140022
001400*     THIS PROGRAM WILL BE A CLONE OF PROGRAM MRKUT135            00150022
001400*     PROGRAM WILL SPECIFY DISTRIBUTION TYPE OF -E- IN            00160022
001400*     THE MODIFIED SQL TO JOIN TO THE DB2 OVERRIDE TABLE          00170022
001500******************************************************************00180022
002100******************************************************************00190022
002200 ENVIRONMENT DIVISION.                                            00200022
002300******************************************************************00210022
002400                                                                  00220022
002500 INPUT-OUTPUT SECTION.                                            00230022
002600                                                                  00240022
002700 FILE-CONTROL.                                                    00250022
002800                                                                  00260022
002900     SELECT HEADER-FILE                                           00270022
003000            ASSIGN TO ICROH                                       00280022
003100            ORGANIZATION IS INDEXED                               00290022
003200            ACCESS MODE  IS DYNAMIC                               00300022
003300            RECORD KEY   IS H-ORDER-HEADER-KEY                    00310022
003400            FILE STATUS  IS SC-HEADER-STATUS.                     00320022
003500                                                                  00330022
003600     SELECT DETAIL-FILE                                           00340022
003700            ASSIGN TO ICROD                                       00350022
003800            ORGANIZATION IS INDEXED                               00360022
003900            ACCESS MODE  IS DYNAMIC                               00370022
004000            RECORD KEY   IS D-LINE-ITEM-KEY                       00380022
004100            FILE STATUS  IS SC-DETAIL-STATUS.                     00390022
004200                                                                  00400022
004300     SELECT OUTPUT-FILE                                           00410022
004400            ASSIGN TO OUT01.                                      00420022
004500                                                                  00430022
004600******************************************************************00440022
004700 DATA DIVISION.                                                   00450022
004800******************************************************************00460022
004900                                                                  00470022
005000 FILE SECTION.                                                    00480022
005100                                                                  00490022
005200 FD  HEADER-FILE                                                  00500022
005300     DATA RECORD IS HEADER-RECORD.                                00510022
005400                                                                  00520022
005500 01  HEADER-RECORD.                                               00530022
005600     COPY ICI085C.                                                00540022
005700     COPY ICI055C.                                                00550022
005800     COPY ICI056C.                                                00560022
005900     COPY ICI100C.                                                00570022
006000     COPY ICI090C.                                                00580022
006100                                                                  00590022
006200                                                                  00600022
006300 FD  DETAIL-FILE                                                  00610022
006400     DATA RECORD IS DETAIL-RECORD.                                00620022
006500                                                                  00630022
006600 01  DETAIL-RECORD.                                               00640022
006700     COPY ICI050C.                                                00650022
006800     COPY ICI030C.                                                00660022
006900     COPY ICI031C.                                                00670022
007000     COPY ICI095C.                                                00680022
007100                                                                  00690022
007200                                                                  00700022
007300 FD  OUTPUT-FILE                                                  00710022
007400     LABEL RECORDS ARE OMITTED                                    00720022
007500     RECORDING MODE F                                             00730022
007600     RECORD CONTAINS 106 CHARACTERS                               00740022
007700     BLOCK CONTAINS 0 RECORDS                                     00750022
007800     DATA RECORD IS SUGGESTED-PO-RECORD.                          00760022
007900                                                                  00770022
008000 01  SUGGESTED-PO-RECORD         PIC X(106).                      00780022
008100                                                                  00790022
008200******************************************************************00800022
008300 WORKING-STORAGE SECTION.                                         00810022
008400******************************************************************00820022
008500                                                                  00830022
008600 01  ABEND-CODE                  PIC S9(4) COMP SYNC VALUE ZERO.  00840022
008700     88  ABEND-4001-WRITE-ERROR                      VALUE +4001. 00850022
008800     88  ABEND-4002-READ-ERROR                       VALUE +4002. 00860022
008900     88  ABEND-4003-CTRL-CARD-ERROR                  VALUE +4003. 00870022
009000     88  ABEND-4004-TABLE-ERROR                      VALUE +4004. 00880022
009100     88  ABEND-4005-OPEN-ERROR                       VALUE +4005. 00890022
009200     88  ABEND-4006-CLOSE-ERROR                      VALUE +4006. 00900022
009300     88  ABEND-4007-SEQUENCE-ERROR                   VALUE +4007. 00910022
009400     88  ABEND-4008-DATA-ERROR                       VALUE +4008. 00920022
009500     88  ABEND-4009-KEY-DATA-ERROR                   VALUE +4009. 00930022
009600     88  ABEND-4013-DB2-ERROR                        VALUE +4013. 00940022
009700                                                                  00950022
009800 01  PC-PROGRAM-CONSTANTS.                                        00960022
009900     05  PC-ONE                  PIC  9(1) VALUE 1.               00970022
010000     05  PC-DISTRIBUTION-TYPE    PIC  X(1) VALUE 'S'.             00980022
010100     05  PC-GROUP-TYPE           PIC  X(4) VALUE '5000'.          00990022
010200     05  PC-SKU-TYPE             PIC  X(1) VALUE 'S'.             01000022
010300     05  PC-ACTION-INSERT        PIC  X(1) VALUE '1'.             01010022
010400     05  PC-SYSTEM-ID            PIC  X(2) VALUE 'MR'.            01020022
010500     05  PC-PGM-NAME             PIC  X(8) VALUE 'MRKUT159'.      01030022
010600     05  PC-WORKSHEET            PIC  X(1) VALUE 'W'.             01040022
010700     05  PC-PACKAGING            PIC  X(1) VALUE 'B'.             01050022
010800     05  PC-PO-TYPE              PIC  X(2) VALUE 'IN'.            01060022
010900     05  PC-PO-TYPE-EC           PIC  X(2) VALUE 'EC'.            01070022
011000     05  PC-STORE-CAT            PIC  X(2) VALUE 'XS'.            01080022
011100     05  PC-STORE-CAT-EC         PIC  X(2) VALUE 'ES'.            01090022
011200     05  PC-ROW-NOT-FOUND        PIC S9(4) COMP SYNC VALUE +100.  01100022
011300     05  PC-MAX-RETRIES          PIC S9(3) VALUE 3   COMP-3.      01110022
011400     05  PC-SPACES               PIC X(3)  VALUE SPACES.          01120022
011500     05  PC-DETAIL               PIC X     VALUE 'D'.             01130022
011600     05  PC-FIRST-LINE           PIC 9(5)  VALUE 1.               01140022
011700     05  PC-MULTI-RT             PIC 9(3)  VALUE 99.              01150022
011800                                                                  01160022
011900 01  PS-PROGRAM-SWITCHES.                                         01170022
012000     05  PS-END-OF-HEADER-SWITCH PIC X     VALUE 'N'.             01180022
012100         88  PS-NOT-END-OF-HEADER          VALUE 'N'.             01190022
012200         88  PS-END-OF-HEADER              VALUE 'Y'.             01200022
012300     05  PS-VALID-HEADER-SWITCH  PIC X     VALUE 'N'.             01210022
012400         88  PS-HEADER-INVALID             VALUE 'N'.             01220022
012500         88  PS-HEADER-VALID               VALUE 'Y'.             01230022
012600     05  PS-END-OF-DETAIL-SWITCH PIC X     VALUE 'N'.             01240022
012700         88  PS-NOT-END-OF-DETAIL          VALUE 'N'.             01250022
012800         88  PS-END-OF-DETAIL              VALUE 'Y'.             01260022
012900     05  PS-FIRST-DETAIL-SWITCH  PIC X     VALUE 'Y'.             01270022
013000         88  PS-NOT-FIRST-DETAIL           VALUE 'N'.             01280022
013100         88  PS-FIRST-DETAIL               VALUE 'Y'.             01290022
013200     05  PS-FIRST-ITEM-SWITCH    PIC X     VALUE 'Y'.             01300022
013300         88  PS-NOT-FIRST-ITEM             VALUE 'N'.             01310022
013400         88  PS-FIRST-ITEM                 VALUE 'Y'.             01320022
013500     05  PS-PO-MULTIPLE-LT       PIC X     VALUE 'N'.             01330022
013600         88  PS-NOT-MULTI-LT               VALUE 'N'.             01340022
013700         88  PS-MULTI-LT                   VALUE 'Y'.             01350022
013800     05  PS-PO-MULTIPLE-RT       PIC X     VALUE 'N'.             01360022
013900         88  PS-NOT-MULTI-RT               VALUE 'N'.             01370022
014000         88  PS-MULTI-RT                   VALUE 'Y'.             01380022
014100     05  PS-ECOMMERCE-PO         PIC X     VALUE 'Y'.             01390022
014200         88  PS-NOT-ECOMMERCE              VALUE 'N'.             01400022
014300         88  PS-ECOMMERCE                  VALUE 'Y'.             01410022
014400                                                                  01420022
014500 01  PV-PROGRAM-VARIABLES.                                        01430022
014600     05  PV-LINE-ITEM-KEY.                                        01440022
014700         10  PV-RECORD-TYPE      PIC X     VALUE SPACES.          01450022
014800         10  PV-REF-NO           PIC X(15) VALUE SPACES.          01460022
014900         10  PV-LINE-NO          PIC 9(5)  VALUE ZERO.            01470022
015000     05  PV-INAME.                                                01480022
015100         10  PV-SKU              PIC  X(8)  VALUE SPACES.         01490022
015200         10  FILLER              PIC  X(7)  VALUE SPACES.         01500022
015300***THIS NEEDS TO CHANGE FOR SNE                                   01510022
015400         10  PV-STORE            PIC  X(5)  VALUE SPACES.         01520022
015500     05  PV-UPC-COMP-3           PIC S9(11) COMP-3.               01530022
015600     05  PV-STORE-N              PIC  9(5).                       01540022
015700     05  PV-STORE-NC                  PIC  S9(4) COMP.            01550022
015800     05  PV-CURR-REF-NO          PIC  X(15) VALUE SPACES.         01560022
015900     05  PV-CURR-SKU             PIC  X(8)  VALUE SPACES.         01570022
016000     05  PV-CURR-SKU-NUMERIC REDEFINES PV-CURR-SKU.               01580022
016100         10  PV-CURR-SKU-N       PIC  9(8).                       01590022
016200     05  PV-CURR-SKU-P           PIC  S9(8)V COMP-3.              01600022
016300     05  PV-CURR-DEPT            PIC  X(3).                       01610022
016400     05  PV-ITEM-OQ              PIC  9(9)  VALUE ZERO.           01620022
016500     05  PV-ITEM-RAWOQ           PIC  9(9)  VALUE ZERO.           01630022
016600     05  PV-PO-OQ                PIC  9(9)  VALUE ZERO.           01640022
016700     05  PV-PO-RAWOQ             PIC  9(9)  VALUE ZERO.           01650022
016800     05  PV-PO-LEAD-TIME         PIC  9(3).                       01660022
016900     05  PV-PO-REVIEW-TIME       PIC  9(3).                       01670022
017000     05  PV-INHOUSE-VENDOR-X     PIC  X(3).                       01680022
017100     05  PV-INHOUSE-VENDOR       PIC S9(3).                       01690022
017200     05  PV-INHOUSE-VENDOR-N     PIC S9(3)V COMP-3.               01700022
017300     05  PV-SEQUENCE-NBR         PIC  9(9)  VALUE ZERO.           01710022
017400     05  PV-SQL-SUB              PIC S9(4)  COMP SYNC VALUE ZERO. 01720022
017500     05  PV-PARAGRAPH-NAME       PIC  X(30) VALUE SPACES.         01730022
017600     05  PV-DB2-OPER-ATTEMPTED   PIC  X(30) VALUE SPACES.         01740022
017700     05  PV-ORDER-RUN-DATE.                                       01750022
017800         10  PV-ORDER-RUN-MONTH  PIC 99.                          01760022
017900         10  PV-ORDER-RUN-SLASH1 PIC X.                           01770022
018000         10  PV-ORDER-RUN-DAY    PIC 99.                          01780022
018100         10  PV-ORDER-RUN-SLASH2 PIC X.                           01790022
018200         10  PV-ORDER-RUN-YEAR   PIC 9(4).                        01800022
018300     05  PV-PK-BY-STR            PIC X       VALUE 'N'.           01810022
018400         88  PV-PK-BY-STR-Y      VALUE 'Y'.                       01820022
018500         88  PV-PK-BY-STR-N      VALUE 'N'.                       01830022
018600     05  PV-HNG                  PIC X       VALUE 'N'.           01840022
018700         88  PV-HNG-Y            VALUE 'H'.                       01850022
018800         88  PV-HNG-N            VALUE 'F'.                       01860022
018900     05  PV-PRE-TICKNG           PIC X       VALUE 'N'.           01870022
019000         88  PV-PRE-TICKNG-Y     VALUE 'Y'.                       01880022
019100         88  PV-PRE-TICKNG-N     VALUE 'N'.                       01890022
019200     05  PV-LDTM-DAYS-QTY        PIC 9(5)    VALUE ZERO.          01900022
019300     05  PV-TVNDAGR-COUNT        PIC S9(09) COMP-3.               01910022
019400                                                                  01920022
019500 01  WS-I-ITEM-HOLD.                                              01930022
019600     05  WS-I-SYSTEM-KEY            PIC X(12).                    01940022
019700     05  WS-I-UPC-ID                PIC 9(10).                    01950022
019800     05  WS-I-INAME.                                              01960022
019900         10  WS-I-SKU               PIC X(08).                    01970022
020000         10  FILLER                 PIC X(07).                    01980022
020100     05  WS-I-SKU-TYPE              PIC X(01).                    01990022
020200     05  WS-I-ICOST                 PIC S9(4)V9(5) COMP-3.        02000022
020300     05  WS-I-UNIT-RETAIL-AMT       PIC 9(05)V99.                 02010022
020400     05  WS-I-GROUP-RETAIL-AMT      PIC 9(05)V99.                 02020022
020500     05  WS-I-GROUP-RETAIL-QTY      PIC 9(03).                    02030022
020600                                                                  02040022
020700 01  CD-SCHEDULE-DATE                 PIC X(10).                  02050022
020800 01  CD-DATE REDEFINES CD-SCHEDULE-DATE.                          02060022
020900     05  CD-YEAR                      PIC 9(4).                   02070022
021000     05  FILLER                       PIC X.                      02080022
021100     05  CD-MONTH                     PIC 99.                     02090022
021200     05  FILLER                       PIC X.                      02100022
021300     05  CD-DAY                       PIC 99.                     02110022
021400                                                                  02120022
021500 01  SC-STATUS-CODES.                                             02130022
021600     05  SC-HEADER-STATUS        PIC XX    VALUE SPACES.          02140022
021700         88  SC-HEADER-STATUS-OK           VALUE '00'.            02150022
021800         88  SC-HEADER-STATUS-DUPLICATE    VALUE '22'.            02160022
021900         88  SC-HEADER-STATUS-NOT-FOUND    VALUE '23'.            02170022
022000     05  SC-DETAIL-STATUS        PIC XX    VALUE SPACES.          02180022
022100         88  SC-DETAIL-STATUS-OK           VALUE '00'.            02190022
022200         88  SC-DETAIL-STATUS-DUPLICATE    VALUE '22'.            02200022
022300         88  SC-DETAIL-STATUS-NOT-FOUND    VALUE '23'.            02210022
022400                                                                  02220022
022500******************************************************************02230022
022600*   OUTPUT FILE RECORD                                            02240022
022700******************************************************************02250022
022800     COPY MRRD135.                                                02260022
022900*                                                                 02270022
023000*---------------------------------------------------------------* 02280022
023100*   ERROR MESSAGE AREA FOR DB2                                    02290022
023200*---------------------------------------------------------------* 02300022
023300     COPY DPWS004.                                                02310022
023400*                                                                 02320022
023500 EJECT                                                            02330022
023600************************                                          02340022
023700* DB2 TABLES                                                      02350022
023800************************                                          02360022
023900                                                                  02370022
024000     EXEC SQL                                                     02380022
024100         INCLUDE TVNDDPT                                          02390022
024200     END-EXEC.                                                    02400022
024300                                                                  02410022
024400     EXEC SQL                                                     02420022
024500         INCLUDE TMRITEM                                          02430022
024600     END-EXEC.                                                    02440022
024700                                                                  02450022
024800     EXEC SQL                                                     02460022
024900         INCLUDE TUPC                                             02470022
025000     END-EXEC.                                                    02480022
025100                                                                  02490022
025200     EXEC SQL                                                     02500022
025300         INCLUDE TSKXREF                                          02510022
025400     END-EXEC.                                                    02520022
025500                                                                  02530022
025600     EXEC SQL                                                     02540022
025700         INCLUDE XMT00001                                         02550022
025800     END-EXEC.                                                    02560022
025900                                                                  02570022
026000     EXEC SQL                                                     02580022
026100         INCLUDE TVNDAGR                                          02590022
026200     END-EXEC.                                                    02600022
026300                                                                  02610022
026400************************                                          02620022
026500* DB2 COMMUNICATION AREA                                          02630022
026600************************                                          02640022
026700                                                                  02650022
026800     EXEC SQL                                                     02660022
026900         INCLUDE SQLCA                                            02670022
027000     END-EXEC.                                                    02680022
027100                                                                  02690022
027200     COPY SQLCA2.                                                 02700022
027300                                                                  02710022
027400************************                                          02720022
027500* DB2 CUSRORS                                                     02730022
027600************************                                          02740022
027700                                                                  02750022
027800******************************************************************02760022
027900 PROCEDURE DIVISION.                                              02770022
028000******************************************************************02780022
028100 A100-PROGRAM-MAINLINE.                                           02790022
028200                                                                  02800022
028300     SET PS-NOT-END-OF-HEADER TO TRUE.                            02810022
028400                                                                  02820022
028500     PERFORM B100-PRE-PROCESSING.                                 02830022
028600                                                                  02840022
028700     PERFORM B200-PROCESS-INFILE                                  02850022
028800             UNTIL PS-END-OF-HEADER.                              02860022
028900                                                                  02870022
029000     PERFORM B300-POST-PROCESSING.                                02880022
029100                                                                  02890022
029200     STOP RUN.                                                    02900022
029300                                                                  02910022
029400                                                                  02920022
029500 B100-PRE-PROCESSING.                                             02930022
029600******************************************************************02940022
029700*   OPEN FILES                                                    02950022
029800*   ACCEPT PARAMETER INPUT                                        02960022
029900*   READ CONTROL FILE                                             02970022
030000*   READ FIRST HEADER RECORD                                      02980022
030100******************************************************************02990022
030200                                                                  03000022
030300     OPEN INPUT  HEADER-FILE                                      03010022
030400                 DETAIL-FILE                                      03020022
030500          OUTPUT OUTPUT-FILE.                                     03030022
030600                                                                  03040022
030700     IF  NOT SC-HEADER-STATUS-OK                                  03050022
030800          DISPLAY '**  ABEND  **'                                 03060022
030900          DISPLAY 'MRKUT159'                                      03070022
031000          DISPLAY 'I/O HEADER FILE OPEN ERROR'                    03080022
031100          DISPLAY 'FILE STATUS CODE = ' SC-HEADER-STATUS          03090022
031200          SET ABEND-4005-OPEN-ERROR TO TRUE                       03100022
031300          CALL 'ILBOABN0' USING ABEND-CODE                        03110022
031400     END-IF.                                                      03120022
031500                                                                  03130022
031600     IF  NOT SC-DETAIL-STATUS-OK                                  03140022
031700         DISPLAY '**  ABEND  **'                                  03150022
031800         DISPLAY 'MRKUT159'                                       03160022
031900         DISPLAY 'I/O DETAIL FILE OPEN ERROR'                     03170022
032000         DISPLAY 'FILE STATUS CODE = ' SC-DETAIL-STATUS           03180022
032100         SET ABEND-4005-OPEN-ERROR TO TRUE                        03190022
032200         CALL 'ILBOABN0' USING ABEND-CODE                         03200022
032300     END-IF.                                                      03210022
032400                                                                  03220022
032500     ACCEPT CD-SCHEDULE-DATE.                                     03230022
032600                                                                  03240022
032700     MOVE CD-MONTH TO PV-ORDER-RUN-MONTH.                         03250022
032800     MOVE '/'      TO PV-ORDER-RUN-SLASH1.                        03260022
032900     MOVE CD-DAY   TO PV-ORDER-RUN-DAY.                           03270022
033000     MOVE '/'      TO PV-ORDER-RUN-SLASH2.                        03280022
033100     MOVE CD-YEAR  TO PV-ORDER-RUN-YEAR.                          03290022
033200                                                                  03300022
033300     SET PS-HEADER-INVALID TO TRUE.                               03310022
033400                                                                  03320022
033500     PERFORM C100-READ-HEADER-FILE                                03330022
033600             UNTIL PS-HEADER-VALID OR                             03340022
033700                   PS-END-OF-HEADER.                              03350022
033800                                                                  03360022
033900 B200-PROCESS-INFILE.                                             03370022
034000******************************************************************03380022
034100*   PERFORM UNTIL NO MORE HEADER RECORDS :                        03390022
034200*     READ AND PROCESS ALL DETAIL RECORDS WITH THE SAME           03400022
034300*          REFERENCE NUMBER AS THE HEADER RECORD                  03410022
034400*     READ THE NEXT HEADER RECORD                                 03420022
034500******************************************************************03430022
034600                                                                  03440022
034700     SET PS-NOT-END-OF-DETAIL TO TRUE.                            03450022
034800                                                                  03460022
034900     PERFORM C200-BUILD-DETAIL-KEY THRU C200-EXIT.                03470022
035000                                                                  03480022
035100     PERFORM C300-PROCESS-DETAIL-FILE THRU C300-EXIT              03490022
035200             UNTIL PS-END-OF-DETAIL.                              03500022
035300                                                                  03510022
035400     SET PS-HEADER-INVALID TO TRUE.                               03520022
035500                                                                  03530022
035600     PERFORM C100-READ-HEADER-FILE                                03540022
035700             UNTIL PS-HEADER-VALID OR                             03550022
035800                   PS-END-OF-HEADER.                              03560022
035900                                                                  03570022
036000 B300-POST-PROCESSING.                                            03580022
036100******************************************************************03590022
036200*   CLOSE FILES                                                   03600022
036300******************************************************************03610022
036400                                                                  03620022
036500     MOVE WS-I-SKU   TO PV-CURR-SKU.                              03630022
036600     PERFORM D200-PROCESS-ITEM-RECORD.                            03640022
036700     PERFORM D300-PROCESS-HDR-RECORD.                             03650022
036800                                                                  03660022
036900     CLOSE HEADER-FILE                                            03670022
037000           DETAIL-FILE                                            03680022
037100           OUTPUT-FILE.                                           03690022
037200                                                                  03700022
037300     IF  NOT SC-HEADER-STATUS-OK                                  03710022
037400         DISPLAY '**  ABEND  **'                                  03720022
037500         DISPLAY 'MRKUT159'                                       03730022
037600         DISPLAY 'I/O HEADER FILE CLOSE ERROR'                    03740022
037700         DISPLAY 'FILE STATUS CODE = ' SC-HEADER-STATUS           03750022
037800         SET ABEND-4006-CLOSE-ERROR TO TRUE                       03760022
037900         CALL 'ILBOABN0' USING ABEND-CODE                         03770022
038000     END-IF                                                       03780022
038100                                                                  03790022
038200     IF  NOT SC-DETAIL-STATUS-OK                                  03800022
038300         DISPLAY '**  ABEND  **'                                  03810022
038400         DISPLAY 'MRKUT159'                                       03820022
038500         DISPLAY 'I/O DETAIL FILE CLOSE ERROR'                    03830022
038600         DISPLAY 'FILE STATUS CODE = ' SC-DETAIL-STATUS           03840022
038700         SET ABEND-4006-CLOSE-ERROR TO TRUE                       03850022
038800         CALL 'ILBOABN0' USING ABEND-CODE                         03860022
038900     END-IF.                                                      03870022
039000                                                                  03880022
039100 C100-READ-HEADER-FILE.                                           03890022
039200******************************************************************03900022
039300*   READ NEXT HEADER RECORD                                       03910022
039400******************************************************************03920022
039500                                                                  03930022
039600     READ HEADER-FILE NEXT                                        03940022
039700          AT END  SET PS-END-OF-HEADER TO TRUE.                   03950022
039800                                                                  03960022
039900     IF H-ORDER-HEADER-KEY = SPACES                               03970022
040000         SET PS-END-OF-HEADER TO TRUE                             03980022
040100     END-IF                                                       03990022
040200                                                                  04000022
040300     IF PS-NOT-END-OF-HEADER                                      04010022
040400        IF H-ORDER-HEADER-KEY = LOW-VALUES OR                     04020022
040500           H-REF-NO (15:1) = 'C' OR                               04030022
040600           TOTCOST = ZERO                                         04040022
040700            CONTINUE                                              04050022
040800        ELSE                                                      04060022
040900            SET PS-HEADER-VALID TO TRUE                           04070022
041000        END-IF                                                    04080022
041100     END-IF.                                                      04090022
041200                                                                  04100022
041300 C200-BUILD-DETAIL-KEY.                                           04110022
041400****************************************************************  04120022
041500*   FORMAT DETAIL KEY USING HEADER REFERENCE NUMBER               04130022
041600*   START READING DETAIL FILE AT FIRST RECORD WITH CURRENT        04140022
041700*     REFERENCE NUMBER                                            04150022
041800****************************************************************  04160022
041900                                                                  04170022
042000     MOVE PC-DETAIL        TO PV-RECORD-TYPE.                     04180022
042100     MOVE H-REF-NO         TO PV-REF-NO                           04190022
042200                              PV-CURR-REF-NO.                     04200022
042300     MOVE PC-FIRST-LINE    TO PV-LINE-NO.                         04210022
042400     MOVE PV-LINE-ITEM-KEY TO D-LINE-ITEM-KEY.                    04220022
042500                                                                  04230022
042600     START DETAIL-FILE                                            04240022
042700           KEY >= D-LINE-ITEM-KEY.                                04250022
042800                                                                  04260022
042900     READ DETAIL-FILE.                                            04270022
043000                                                                  04280022
043100     IF SC-DETAIL-STATUS-OK                                       04290022
043200         NEXT SENTENCE                                            04300022
043300     ELSE                                                         04310022
043400         SET PS-END-OF-DETAIL TO TRUE                             04320022
043500     END-IF.                                                      04330022
043600                                                                  04340022
043700 C200-EXIT.                                                       04350022
043800     EXIT.                                                        04360022
043900                                                                  04370022
044000 C300-PROCESS-DETAIL-FILE.                                        04380022
044100****************************************************************  04390022
044200*   IF SKU CHANGES : WRITE THE PREV ITEM RECORD                   04400022
044300*                    AND WRITE A STORE RECORD                     04410022
044400*   IF REFERENCE NUMBER CHANGES :                                 04420022
044500*                    WRITE THE PREV ITEM RECORD                   04430022
044600****************************************************************  04440022
044700                                                                  04450022
044800     IF NOT PS-END-OF-DETAIL                                      04460022
044900         IF D-REF-NO NOT = PV-CURR-REF-NO                         04470022
045000             MOVE WS-I-SKU        TO PV-CURR-SKU                  04480022
045100             PERFORM D200-PROCESS-ITEM-RECORD                     04490022
045200             PERFORM D300-PROCESS-HDR-RECORD                      04500022
045300             SET PS-END-OF-DETAIL TO TRUE                         04510022
045400         ELSE                                                     04520022
045500             MOVE INAME TO PV-INAME                               04530022
045600             IF PV-SKU     NOT = PV-CURR-SKU                      04540022
045700                 IF PS-FIRST-ITEM                                 04550022
045800                     MOVE PV-SKU           TO PV-CURR-SKU         04560022
045900                     PERFORM D100-PROCESS-STORE-RECORD            04570022
046000                     PERFORM F700-MOVE-ITEM-HOLD-INFO             04580022
046100                     SET PS-NOT-FIRST-ITEM TO TRUE                04590022
046200                 ELSE                                             04600022
046300                     MOVE WS-I-SKU         TO PV-CURR-SKU         04610022
046400                     PERFORM D200-PROCESS-ITEM-RECORD             04620022
046500                     MOVE PV-SKU           TO PV-CURR-SKU         04630022
046600                     PERFORM D100-PROCESS-STORE-RECORD            04640022
046700                     PERFORM F700-MOVE-ITEM-HOLD-INFO             04650022
046800                 END-IF                                           04660022
046900             ELSE                                                 04670022
047000                 PERFORM D100-PROCESS-STORE-RECORD                04680022
047100                 PERFORM F700-MOVE-ITEM-HOLD-INFO                 04690022
047200             END-IF                                               04700022
047300         END-IF                                                   04710022
047400     END-IF.                                                      04720022
047500                                                                  04730022
047600     IF NOT PS-END-OF-DETAIL                                      04740022
047700         PERFORM C400-READ-DETAIL-FILE                            04750022
047800     END-IF.                                                      04760022
047900                                                                  04770022
048000 C300-EXIT.                                                       04780022
048100     EXIT.                                                        04790022
048200                                                                  04800022
048300 C400-READ-DETAIL-FILE.                                           04810022
048400******************************************************************04820022
048500*   READ THE NEXT DETAIL RECORD                                   04830022
048600******************************************************************04840022
048700                                                                  04850022
048800     READ DETAIL-FILE NEXT                                        04860022
048900          AT END  SET PS-END-OF-DETAIL TO TRUE.                   04870022
049000                                                                  04880022
049100 C400-EXIT.                                                       04890022
049200     EXIT.                                                        04900022
049300                                                                  04910022
049400 D100-PROCESS-STORE-RECORD.                                       04920022
049500******************************************************************04930022
049600*   FORMAT A SUGGESTED PO STORE RECORD                            04940022
049700******************************************************************04950022
049800                                                                  04960022
049900     MOVE PV-STORE                  TO PV-STORE-N.                04970022
050000     MOVE PV-STORE-N                TO PV-STORE-NC.               04980022
050100                                                                  04990022
050200     IF PS-ECOMMERCE                                              05000022
050300         PERFORM F100-GET-STORE-INFO                              05010022
050400         IF XMT00001-E-BUS-IND = 'N'                              05020022
050500             SET PS-NOT-ECOMMERCE TO TRUE                         05030022
050600         END-IF                                                   05040022
050700     END-IF                                                       05050022
050800                                                                  05060022
050900     ADD OQ                         TO PV-ITEM-OQ                 05070022
051000     ADD OQ                         TO PV-PO-OQ                   05080022
051100     ADD RAWOQ                      TO PV-ITEM-RAWOQ.             05090022
051200                                                                  05100022
051300     PERFORM E100-FORMAT-WRITE-STORE-RECORD.                      05110022
051400                                                                  05120022
051500 D200-PROCESS-ITEM-RECORD.                                        05130022
051600******************************************************************05140022
051700*   FORMAT A SUGGESTED PO STORE RECORD                            05150022
051800******************************************************************05160022
051900                                                                  05170022
052000     IF PV-CURR-SKU NOT = SPACES                                  05180022
052100         MOVE PV-CURR-SKU-N TO PV-CURR-SKU-P                      05190022
052200     END-IF                                                       05200022
052300                                                                  05210022
052400     PERFORM F200-GET-ITEM-INFO.                                  05220022
052500                                                                  05230022
052600     IF PS-FIRST-DETAIL                                           05240022
052700         MOVE MRITEM-LT-QTY         TO PV-PO-LEAD-TIME            05250022
052800         MOVE MRITEM-RT-NBR         TO PV-PO-REVIEW-TIME          05260022
052900         SET PS-NOT-FIRST-DETAIL    TO TRUE                       05270022
053000     ELSE                                                         05280022
053100         IF PS-NOT-MULTI-LT                                       05290022
053200             IF MRITEM-LT-QTY NOT = PV-PO-LEAD-TIME               05300022
053300                 SET PS-MULTI-LT        TO TRUE                   05310022
053400             END-IF                                               05320022
053500         END-IF                                                   05330022
053600                                                                  05340022
053700         IF PS-NOT-MULTI-RT                                       05350022
053800             IF MRITEM-RT-NBR NOT =  PV-PO-REVIEW-TIME            05360022
053900                 SET PS-MULTI-RT        TO TRUE                   05370022
054000             END-IF                                               05380022
054100         END-IF                                                   05390022
054200     END-IF.                                                      05400022
054300                                                                  05410022
054400     PERFORM E200-FORMAT-WRITE-ITEM-RECORD                        05420022
054500                                                                  05430022
054600     MOVE ZEROES                    TO PV-ITEM-OQ                 05440022
054700                                       PV-ITEM-RAWOQ.             05450022
054800                                                                  05460022
054900     MOVE PV-SKU                    TO PV-CURR-SKU.               05470022
055000                                                                  05480022
055100 D300-PROCESS-HDR-RECORD.                                         05490022
055200******************************************************************05500022
055300*   FORMAT A SUGGESTED PO HEADER RECORD                           05510022
055400******************************************************************05520022
055500                                                                  05530022
055600     MOVE H-USERID(1:3)         TO PV-CURR-DEPT.                  05540022
055700     MOVE H-VENDOR-NO(1)        TO PV-INHOUSE-VENDOR-X.           05550022
055800     MOVE PV-INHOUSE-VENDOR-X(1:3)  TO PV-INHOUSE-VENDOR.         05560022
055900     MOVE PV-INHOUSE-VENDOR         TO PV-INHOUSE-VENDOR-N.       05570022
056000                                                                  05580022
056100     PERFORM F300-GET-VENDOR.                                     05590022
056200                                                                  05600022
056300     PERFORM F400-GET-PK-BY-STR-INFO.                             05610022
056400     PERFORM F500-GET-HNG-INFO.                                   05620022
056500     PERFORM F600-GET-LDTM-PRETK-INFO.                            05630022
056600                                                                  05640022
056700     PERFORM E300-FORMAT-WRITE-HDR-RECORD.                        05650022
056800                                                                  05660022
056900     MOVE ZEROES                TO PV-PO-OQ.                      05670022
057000     MOVE SPACES                TO PV-CURR-SKU.                   05680022
057100                                                                  05690022
057200     SET PS-FIRST-DETAIL        TO TRUE.                          05700022
057300     SET PS-FIRST-ITEM          TO TRUE.                          05710022
057400     SET PS-NOT-MULTI-LT        TO TRUE.                          05720022
057500     SET PS-NOT-MULTI-RT        TO TRUE.                          05730022
057600     SET PS-ECOMMERCE           TO TRUE.                          05740022
057700                                                                  05750022
057800 E100-FORMAT-WRITE-STORE-RECORD.                                  05760022
057900******************************************************************05770022
058000*   FORMAT A SUGGESTED PO STORE RECORD                            05780022
058100******************************************************************05790022
058200                                                                  05800022
058300     MOVE SPACES                TO MR135-STAGING-RECORD.          05810022
058400                                                                  05820022
058500     ADD  PC-ONE                TO PV-SEQUENCE-NBR.               05830022
058600     MOVE PV-SEQUENCE-NBR       TO MR135-SEQUENCE-NUMBER.         05840022
058700     SET  MR135-STORE-RECORD    TO TRUE.                          05850022
058800     MOVE PV-CURR-REF-NO(1:12)  TO MR135-S-SYSTEM-KEY.            05860022
058900     MOVE PV-CURR-SKU           TO MR135-S-SKU.                   05870022
059000     MOVE PC-DISTRIBUTION-TYPE  TO MR135-S-DISTRIBUTION-TYPE.     05880022
059100     MOVE PC-GROUP-TYPE         TO MR135-S-STORE-GROUP-TYPE.      05890022
059200     MOVE PV-STORE              TO MR135-S-DISTRIBUTION-ID.       05900022
059300     MOVE OQ                    TO MR135-S-SUGGESTED-OQ           05910022
059400                                   MR135-S-ACTUAL-OQ.             05920022
059500     MOVE RAWOQ                 TO MR135-S-OPTIMAL-OQ.            05930022
059600                                                                  05940022
059700     WRITE SUGGESTED-PO-RECORD  FROM MR135-STAGING-RECORD.        05950022
059800                                                                  05960022
059900 E200-FORMAT-WRITE-ITEM-RECORD.                                   05970022
060000******************************************************************05980022
060100*   FORMAT A SUGGESTED PO ITEM RECORD                             05990022
060200******************************************************************06000022
060300                                                                  06010022
060400     MOVE SPACES                TO MR135-STAGING-RECORD.          06020022
060500                                                                  06030022
060600     ADD  PC-ONE                TO PV-SEQUENCE-NBR.               06040022
060700     MOVE PV-SEQUENCE-NBR       TO MR135-SEQUENCE-NUMBER.         06050022
060800     SET  MR135-ITEM-RECORD     TO TRUE.                          06060022
060900     MOVE PV-CURR-REF-NO(1:12)  TO MR135-I-SYSTEM-KEY.            06070022
061000     MOVE SKXREF-INTR-UPC-ID    TO PV-UPC-COMP-3.                 06080022
061100     MOVE PV-UPC-COMP-3         TO MR135-I-UPC-ID.                06090022
061200     MOVE PV-CURR-SKU           TO MR135-I-SKU.                   06100022
061300     MOVE PC-SKU-TYPE           TO MR135-I-SKU-TYPE.              06110022
061400     MOVE WS-I-ICOST            TO MR135-I-UNIT-COST-AMOUNT.      06120022
061500     MOVE UPC-INNR-PK-QTY       TO MR135-I-INNER-PACK.            06130022
061600     MOVE UPC-OUTR-PK-QTY       TO MR135-I-OUTER-PACK.            06140022
061700     MOVE WS-I-UNIT-RETAIL-AMT  TO MR135-I-UNIT-RETAIL-AMOUNT.    06150022
061800     MOVE WS-I-GROUP-RETAIL-AMT TO MR135-I-GROUP-RETAIL-AMOUNT.   06160022
061900     MOVE WS-I-GROUP-RETAIL-QTY TO MR135-I-GROUP-RETAIL-QTY.      06170022
062000     MOVE PV-ITEM-OQ            TO MR135-I-SUGGESTED-OQ           06180022
062100                                   MR135-I-ACTUAL-OQ.             06190022
062200     MOVE PV-ITEM-RAWOQ         TO MR135-I-OPTIMAL-OQ.            06200022
062300                                                                  06210022
062400     WRITE SUGGESTED-PO-RECORD  FROM MR135-STAGING-RECORD.        06220022
062500                                                                  06230022
062600 E300-FORMAT-WRITE-HDR-RECORD.                                    06240022
062700*************************************************************     06250022
062800*   FORMAT AND WRITE A SUGGESTED PO HEADER RECORD                 06260022
062900*************************************************************     06270022
063000                                                                  06280022
063100     MOVE SPACES                TO MR135-STAGING-RECORD.          06290022
063200                                                                  06300022
063300     ADD  PC-ONE                TO PV-SEQUENCE-NBR.               06310022
063400     MOVE PV-SEQUENCE-NBR      TO MR135-SEQUENCE-NUMBER.          06320022
063500     SET  MR135-HEADER-RECORD   TO TRUE.                          06330022
063600     MOVE PV-CURR-REF-NO(1:12)  TO MR135-H-SYSTEM-KEY.            06340022
063700     MOVE PC-ACTION-INSERT      TO MR135-H-ACTION.                06350022
063800     MOVE PC-SYSTEM-ID          TO MR135-H-SYSTEM-ID.             06360022
063900     MOVE PC-PGM-NAME           TO MR135-H-USERID.                06370022
064000     MOVE PC-WORKSHEET          TO MR135-H-SUGGESTED-PO-STATUS.   06380022
064100     MOVE PC-PACKAGING          TO MR135-H-PACKAGING-CODE.        06390022
064200     IF PS-ECOMMERCE                                              06400022
064300         MOVE PC-PO-TYPE-EC     TO MR135-H-PO-TYPE-CODE           06410022
064400         MOVE PC-STORE-CAT-EC   TO MR135-H-STORE-CATEGORY         06420022
064500     ELSE                                                         06430022
064600         MOVE PC-PO-TYPE        TO MR135-H-PO-TYPE-CODE           06440022
064700         MOVE PC-STORE-CAT      TO MR135-H-STORE-CATEGORY         06450022
064800     END-IF                                                       06460022
064900     MOVE PV-CURR-DEPT          TO MR135-H-DEPARTMENT.            06470022
065000     MOVE VNDDPT-ENT-ID         TO MR135-H-VENDOR-ID              06480022
065100                                                                  06490022
065200     IF PS-NOT-MULTI-LT                                           06500022
065300         MOVE PV-PO-LEAD-TIME   TO MR135-H-LEAD-TIME              06510022
065400     END-IF.                                                      06520022
065500                                                                  06530022
065600     MOVE PV-ORDER-RUN-DATE     TO MR135-H-ORDER-RUN-DATE.        06540022
065700                                                                  06550022
065800     IF PS-MULTI-RT                                               06560022
065900         MOVE PC-MULTI-RT       TO MR135-H-REVIEW-TIME-NBR        06570022
066000     ELSE                                                         06580022
066100         MOVE PV-PO-REVIEW-TIME TO MR135-H-REVIEW-TIME-NBR        06590022
066200     END-IF.                                                      06600022
066300                                                                  06610022
066400     MOVE H-SYSTEM-ID           TO MR135-H-SYSTEM-CODE            06620022
066500     MOVE PV-PO-OQ              TO MR135-H-SUGGESTED-OQ           06630022
066600                                   MR135-H-ACTUAL-OQ.             06640022
066700                                                                  06650022
066800     MOVE PV-PK-BY-STR          TO MR135-H-PK-BY-STR.             06660022
066900     MOVE PV-HNG                TO MR135-H-HANGER.                06670022
067000     MOVE PV-PRE-TICKNG         TO MR135-H-PTKT-IND.              06680022
067100     MOVE PV-LDTM-DAYS-QTY      TO MR135-H-LDTM-DAYS-QTY.         06690022
067200                                                                  06700022
067300     WRITE SUGGESTED-PO-RECORD  FROM MR135-STAGING-RECORD.        06710022
067400                                                                  06720022
067500 F100-GET-STORE-INFO.                                             06730022
067600******************************************************************06740022
067700*   GET STORE INFO.                                               06750022
067800******************************************************************06760022
067900     MOVE 'F100-STORE-INFO'        TO PV-PARAGRAPH-NAME.          06770022
068000     MOVE 'SELECT STORE INFO'      TO PV-DB2-OPER-ATTEMPTED.      06780022
068100*                                                                 06790022
068200     PERFORM                                                      06800022
068300         WITH TEST AFTER                                          06810022
068400         VARYING PV-SQL-SUB                                       06820022
068500         FROM 1 BY 1                                              06830022
068600         UNTIL PV-SQL-SUB > PC-MAX-RETRIES                        06840022
068700            OR SQLCODE = ZERO                                     06850022
068800            OR SQLCODE = +100                                     06860022
068900                                                                  06870022
069000     EXEC SQL                                                     06880022
069100       SELECT E_BUS_IND                                           06890022
069200        INTO :XMT00001-E-BUS-IND                                  06900022
069300          FROM XMT_LOC A                                          06910022
069400          WHERE A.LOC_NBR      = :PV-STORE-NC                     06920022
069500     END-EXEC                                                     06930022
069600         EVALUATE TRUE                                            06940022
069700             WHEN SQLCODE = ZERO                                  06950022
069800                 CONTINUE                                         06960022
069900             WHEN SQLCODE = -904                                  06970022
070000             WHEN SQLCODE = -913                                  06980022
070100             WHEN SQLCODE = +100                                  06990022
070200                 CONTINUE                                         07000022
070300             WHEN SQLWARN0 NOT = SPACES                           07010022
070400             WHEN SQLCODE  NOT = ZERO                             07020022
070500                  PERFORM Z999-SQL-ABEND                          07030022
070600         END-EVALUATE                                             07040022
070700     END-PERFORM.                                                 07050022
070800*                                                                 07060022
070900     IF PV-SQL-SUB > PC-MAX-RETRIES                               07070022
071000        MOVE 'MAX RETRIES EXCEEDED FOR SELECT'                    07080022
071100                                   TO PV-DB2-OPER-ATTEMPTED       07090022
071200        PERFORM Z999-SQL-ABEND                                    07100022
071300     END-IF.                                                      07110022
071400*                                                                 07120022
071500                                                                  07130022
071600 F200-GET-ITEM-INFO.                                              07140022
071700******************************************************************07150022
071800*   GET ITEM INFO.                                                07160022
071900******************************************************************07170022
072000     MOVE 'F200-ITEM-INFO'        TO PV-PARAGRAPH-NAME.           07180022
072100     MOVE 'SELECT ITEM INFO'      TO PV-DB2-OPER-ATTEMPTED.       07190022
072200*                                                                 07200022
3372A        INITIALIZE DCLTMRITEM                                      07210022
                        DCLTUPC                                         07220022
                        DCLTSKXREF                                      07230022
072300     PERFORM                                                      07240022
072400         WITH TEST AFTER                                          07250022
072500         VARYING PV-SQL-SUB                                       07260022
072600         FROM 1 BY 1                                              07270022
072700         UNTIL PV-SQL-SUB > PC-MAX-RETRIES                        07280022
072800            OR SQLCODE = ZERO                                     07290022
072900            OR SQLCODE = +100                                     07300022
073000                                                                  07310022
073100     EXEC SQL                                                     07320022
3372A        WITH DATA_1 AS (                                           07330022
3372A        SELECT A.SKU SKU,                                          07340022
3372A               LT_QTY,                                             07350022
073300              RT_NBR,                                             07360022
073400              INNR_PK_QTY,                                        07370022
073500              OUTR_PK_QTY,                                        07380022
3372A               A.INTR_UPC_ID INTR_UPC_ID                           07390022
074200          FROM TSKXREF A,                                         07400022
074300               TUPC    B,                                         07410022
074400               TMRITEM C                                          07420022
074500          WHERE A.SKU          = :PV-CURR-SKU-P                   07430022
074600            AND A.ITM_NBR      = C.ITEM_NBR                       07440022
074700            AND A.INTR_UPC_ID  = B.INTR_UPC_ID                    07450022
074800            AND B.UPC_TYP_CDE      = 'I'                          07460022
3372A             AND B.EFF_END_DTE     IS NULL )                       07470022
3372A          SELECT                                                   07480022
3372A                DATA_1.LT_QTY,                                     07490022
3372A                DATA_1.RT_NBR,                                     07500022
3372A                COALESCE(M.INNR_PK_QTY,DATA_1.INNR_PK_QTY),        07510022
3372A                COALESCE(M.OUTR_PK_QTY,DATA_1.OUTR_PK_QTY),        07520022
3372A                DATA_1.INTR_UPC_ID                                 07530022
3372A         INTO :MRITEM-LT-QTY,                                      07540022
3372A              :MRITEM-RT-NBR,                                      07550022
3372A              :UPC-INNR-PK-QTY,                                    07560022
3372A              :UPC-OUTR-PK-QTY,                                    07570022
3372A              :SKXREF-INTR-UPC-ID                                  07580022
3372A         FROM      DATA_1 LEFT OUTER JOIN MRTW_SKU_PKGNG_OVRRID M  07590022
3372A           ON      (DATA_1.SKU=M.SKU_NBR)                          07600022
3372A                   AND M.DISTRB_TYP_CDE = 'E'                      07610022
075000     END-EXEC                                                     07620022
075100         EVALUATE TRUE                                            07630022
075200             WHEN SQLCODE = ZERO                                  07640022
075300                 CONTINUE                                         07650022
075400             WHEN SQLCODE = -904                                  07660022
075500             WHEN SQLCODE = -913                                  07670022
075600             WHEN SQLCODE = +100                                  07680022
075700                 CONTINUE                                         07690022
075800             WHEN SQLWARN0 NOT = SPACES                           07700022
075900             WHEN SQLCODE  NOT = ZERO                             07710022
076000                  PERFORM Z999-SQL-ABEND                          07720022
076100         END-EVALUATE                                             07730022
076200     END-PERFORM.                                                 07740022
076300*                                                                 07750022
076400     IF PV-SQL-SUB > PC-MAX-RETRIES                               07760022
076500        MOVE 'MAX RETRIES EXCEEDED FOR SELECT'                    07770022
076600                                   TO PV-DB2-OPER-ATTEMPTED       07780022
076700        PERFORM Z999-SQL-ABEND                                    07790022
076800     END-IF.                                                      07800022
076900*                                                                 07810022
077000 F300-GET-VENDOR.                                                 07820022
077100******************************************************************07830022
077200*   GET ENT-ID USING INHOUSE NUMBER                               07840022
077300******************************************************************07850022
077400                                                                  07860022
077500     MOVE 'F300-GET-VENDOR'       TO PV-PARAGRAPH-NAME.           07870022
077600     MOVE 'SELECT FOR VENDOR'     TO PV-DB2-OPER-ATTEMPTED.       07880022
077700*                                                                 07890022
077800     PERFORM                                                      07900022
077900         WITH TEST AFTER                                          07910022
078000         VARYING PV-SQL-SUB                                       07920022
078100         FROM 1 BY 1                                              07930022
078200         UNTIL PV-SQL-SUB > PC-MAX-RETRIES                        07940022
078300            OR SQLCODE = ZERO                                     07950022
078400            OR SQLCODE = +100                                     07960022
078500                                                                  07970022
078600     EXEC SQL                                                     07980022
078700       SELECT ENT_ID                                              07990022
078800         INTO :VNDDPT-ENT-ID                                      08000022
078900         FROM TVNDDPT                                             08010022
079000        WHERE INHOUSE_NBR = :PV-INHOUSE-VENDOR-N                  08020022
079100          AND DEPT_NBR    = :PV-CURR-DEPT                         08030022
079200     END-EXEC                                                     08040022
079300         EVALUATE TRUE                                            08050022
079400             WHEN SQLCODE = ZERO                                  08060022
079500                 CONTINUE                                         08070022
079600             WHEN SQLCODE = -904                                  08080022
079700             WHEN SQLCODE = -913                                  08090022
079800             WHEN SQLCODE = +100                                  08100022
079900                 CONTINUE                                         08110022
080000             WHEN SQLWARN0 NOT = SPACES                           08120022
080100             WHEN SQLCODE  NOT = ZERO                             08130022
080200                  PERFORM Z999-SQL-ABEND                          08140022
080300         END-EVALUATE                                             08150022
080400     END-PERFORM.                                                 08160022
080500*                                                                 08170022
080600     IF PV-SQL-SUB > PC-MAX-RETRIES                               08180022
080700        MOVE 'MAX RETRIES EXCEEDED FOR SELECT'                    08190022
080800                                   TO PV-DB2-OPER-ATTEMPTED       08200022
080900        PERFORM Z999-SQL-ABEND                                    08210022
081000     END-IF.                                                      08220022
081100*                                                                 08230022
081200 F400-GET-PK-BY-STR-INFO.                                         08240022
081300******************************************************************08250022
081400*   GET PK-BY-STR-INFO                                            08260022
081500******************************************************************08270022
081600                                                                  08280022
081700     MOVE 'F400-GET-PK-BY-STR'    TO PV-PARAGRAPH-NAME.           08290022
081800     MOVE 'SELECT FOR PK-BY-STR'  TO PV-DB2-OPER-ATTEMPTED.       08300022
081900*                                                                 08310022
082000     PERFORM                                                      08320022
082100         WITH TEST AFTER                                          08330022
082200         VARYING PV-SQL-SUB                                       08340022
082300         FROM 1 BY 1                                              08350022
082400         UNTIL PV-SQL-SUB > PC-MAX-RETRIES                        08360022
082500            OR SQLCODE = ZERO                                     08370022
082600            OR SQLCODE = +100                                     08380022
082700                                                                  08390022
082800     INITIALIZE DCLTVNDAGR                                        08400022
082900     MOVE ZERO                         TO PV-TVNDAGR-COUNT        08410022
083000                                                                  08420022
083100     EXEC SQL                                                     08430022
083200       SELECT COUNT(*)                                            08440022
083300         INTO :PV-TVNDAGR-COUNT                                   08450022
083400         FROM TVNDAGR                                             08460022
083500        WHERE ENT_ID        = :VNDDPT-ENT-ID                      08470022
083600          AND DEPT_NBR      = :PV-CURR-DEPT                       08480022
083700          AND AGRMT_TYP_ID  = '4'                                 08490022
083800          AND TYP_CDE       = 4                                   08500022
083900          AND CURRENT DATE >= EFFECTIVE_DATE                      08510022
084000          AND CURRENT DATE  < EXPIRATION_DATE                     08520022
084100     END-EXEC                                                     08530022
084200         EVALUATE TRUE                                            08540022
084300             WHEN SQLCODE = ZERO                                  08550022
084400                 IF PV-TVNDAGR-COUNT > ZERO                       08560022
084500                    SET PV-PK-BY-STR-Y  TO TRUE                   08570022
084600                 ELSE                                             08580022
084700                    SET PV-PK-BY-STR-N  TO TRUE                   08590022
084800                 END-IF                                           08600022
084900             WHEN SQLCODE = -904                                  08610022
085000             WHEN SQLCODE = -913                                  08620022
085100             WHEN SQLCODE = +100                                  08630022
085200                 CONTINUE                                         08640022
085300             WHEN SQLWARN0 NOT = SPACES                           08650022
085400             WHEN SQLCODE  NOT = ZERO                             08660022
085500                  PERFORM Z999-SQL-ABEND                          08670022
085600         END-EVALUATE                                             08680022
085700     END-PERFORM.                                                 08690022
085800*                                                                 08700022
085900     IF PV-SQL-SUB > PC-MAX-RETRIES                               08710022
086000        MOVE 'MAX RETRIES EXCEEDED FOR SELECT'                    08720022
086100                                   TO PV-DB2-OPER-ATTEMPTED       08730022
086200        PERFORM Z999-SQL-ABEND                                    08740022
086300     END-IF.                                                      08750022
086400*                                                                 08760022
086500 F500-GET-HNG-INFO.                                               08770022
086600******************************************************************08780022
086700*   GET GET-HNG-INFO                                              08790022
086800******************************************************************08800022
086900                                                                  08810022
087000     MOVE 'F500-GET-HNG'          TO PV-PARAGRAPH-NAME.           08820022
087100     MOVE 'SELECT FOR HNG'        TO PV-DB2-OPER-ATTEMPTED.       08830022
087200*                                                                 08840022
087300     PERFORM                                                      08850022
087400         WITH TEST AFTER                                          08860022
087500         VARYING PV-SQL-SUB                                       08870022
087600         FROM 1 BY 1                                              08880022
087700         UNTIL PV-SQL-SUB > PC-MAX-RETRIES                        08890022
087800            OR SQLCODE = ZERO                                     08900022
087900            OR SQLCODE = +100                                     08910022
088000                                                                  08920022
088100     INITIALIZE DCLTVNDAGR                                        08930022
088200     MOVE ZERO                         TO PV-TVNDAGR-COUNT        08940022
088300                                                                  08950022
088400     EXEC SQL                                                     08960022
088500       SELECT COUNT(*)                                            08970022
088600         INTO :PV-TVNDAGR-COUNT                                   08980022
088700         FROM TVNDAGR                                             08990022
088800        WHERE ENT_ID        = :VNDDPT-ENT-ID                      09000022
088900          AND DEPT_NBR      = :PV-CURR-DEPT                       09010022
089000          AND AGRMT_TYP_ID  = '4'                                 09020022
089100          AND TYP_CDE       = 2                                   09030022
089200          AND CURRENT DATE >= EFFECTIVE_DATE                      09040022
089300          AND CURRENT DATE  < EXPIRATION_DATE                     09050022
089400     END-EXEC                                                     09060022
089500         EVALUATE TRUE                                            09070022
089600             WHEN SQLCODE = ZERO                                  09080022
089700                 IF PV-TVNDAGR-COUNT > ZERO                       09090022
089800                    SET PV-HNG-Y  TO TRUE                         09100022
089900                 ELSE                                             09110022
090000                    SET PV-HNG-N  TO TRUE                         09120022
090100                 END-IF                                           09130022
090200             WHEN SQLCODE = -904                                  09140022
090300             WHEN SQLCODE = -913                                  09150022
090400             WHEN SQLCODE = +100                                  09160022
090500                 CONTINUE                                         09170022
090600             WHEN SQLWARN0 NOT = SPACES                           09180022
090700             WHEN SQLCODE  NOT = ZERO                             09190022
090800                  PERFORM Z999-SQL-ABEND                          09200022
090900         END-EVALUATE                                             09210022
091000     END-PERFORM.                                                 09220022
091100*                                                                 09230022
091200     IF PV-SQL-SUB > PC-MAX-RETRIES                               09240022
091300        MOVE 'MAX RETRIES EXCEEDED FOR SELECT'                    09250022
091400                                   TO PV-DB2-OPER-ATTEMPTED       09260022
091500        PERFORM Z999-SQL-ABEND                                    09270022
091600     END-IF.                                                      09280022
091700*                                                                 09290022
091800 F600-GET-LDTM-PRETK-INFO.                                        09300022
091900******************************************************************09310022
092000*   GET GET-LDTM-PRETK-INFO                                       09320022
092100******************************************************************09330022
092200                                                                  09340022
092300     MOVE 'F600-GET-LDTM-PRETK'   TO PV-PARAGRAPH-NAME.           09350022
092400     MOVE 'SELECT FOR LDTM-PRETK' TO PV-DB2-OPER-ATTEMPTED.       09360022
092500*                                                                 09370022
092600     INITIALIZE PV-LDTM-DAYS-QTY                                  09380022
092700                PV-PRE-TICKNG.                                    09390022
092800     PERFORM                                                      09400022
092900         WITH TEST AFTER                                          09410022
093000         VARYING PV-SQL-SUB                                       09420022
093100         FROM 1 BY 1                                              09430022
093200         UNTIL PV-SQL-SUB > PC-MAX-RETRIES                        09440022
093300            OR SQLCODE = ZERO                                     09450022
093400            OR SQLCODE = +100                                     09460022
093500                                                                  09470022
093600     INITIALIZE DCLTVNDAGR                                        09480022
093700     MOVE ZERO                         TO VNDAGR-LEADTIME-DAYS-QTY09490022
093800                                                                  09500022
093900     EXEC SQL                                                     09510022
094000       SELECT LEADTIME_DAYS_QTY                                   09520022
094100         INTO :VNDAGR-LEADTIME-DAYS-QTY                           09530022
094200         FROM TVNDAGR                                             09540022
094300        WHERE ENT_ID        = :VNDDPT-ENT-ID                      09550022
094400          AND DEPT_NBR      = :PV-CURR-DEPT                       09560022
094500          AND AGRMT_TYP_ID  = '4'                                 09570022
094600          AND TYP_CDE       = 1                                   09580022
094700          AND CURRENT DATE >= EFFECTIVE_DATE                      09590022
094800          AND CURRENT DATE  < EXPIRATION_DATE                     09600022
094900     END-EXEC                                                     09610022
095000         EVALUATE TRUE                                            09620022
095100             WHEN SQLCODE = ZERO                                  09630022
095200                 SET PV-PRE-TICKNG-Y TO TRUE                      09640022
095300                 IF VNDAGR-LEADTIME-DAYS-QTY > ZERO               09650022
095400                    MOVE VNDAGR-LEADTIME-DAYS-QTY TO              09660022
095500                                                 PV-LDTM-DAYS-QTY 09670022
095600                 ELSE                                             09680022
095700                    MOVE ZERO TO PV-LDTM-DAYS-QTY                 09690022
095800                 END-IF                                           09700022
095900             WHEN SQLCODE = -904                                  09710022
096000             WHEN SQLCODE = -913                                  09720022
096100                 CONTINUE                                         09730022
096200             WHEN SQLCODE = +100                                  09740022
096300                 SET PV-PRE-TICKNG-N TO TRUE                      09750022
096400             WHEN SQLWARN0 NOT = SPACES                           09760022
096500             WHEN SQLCODE  NOT = ZERO                             09770022
096600                  PERFORM Z999-SQL-ABEND                          09780022
096700         END-EVALUATE                                             09790022
096800     END-PERFORM.                                                 09800022
096900*                                                                 09810022
097000     IF PV-SQL-SUB > PC-MAX-RETRIES                               09820022
097100        MOVE 'MAX RETRIES EXCEEDED FOR SELECT'                    09830022
097200                                   TO PV-DB2-OPER-ATTEMPTED       09840022
097300        PERFORM Z999-SQL-ABEND                                    09850022
097400     END-IF.                                                      09860022
097500                                                                  09870022
097600 F700-MOVE-ITEM-HOLD-INFO.                                        09880022
097700                                                                  09890022
097800     MOVE INAME            TO WS-I-INAME.                         09900022
097900     MOVE ICOST            TO WS-I-ICOST.                         09910022
098000     MOVE CUR-UNIT-RTL-AMT TO WS-I-UNIT-RETAIL-AMT.               09920022
098100     MOVE GR-RTL-AMT       TO WS-I-GROUP-RETAIL-AMT.              09930022
098200     MOVE GR-QTY           TO WS-I-GROUP-RETAIL-QTY.              09940022
098300                                                                  09950022
098400 Z999-SQL-ABEND.                                                  09960022
098500*                                                                 09970022
098600     SET ABEND-4013-DB2-ERROR  TO TRUE.                           09980022
098700     DISPLAY '**  ABEND     **'.                                  09990022
098800     DISPLAY '**  PROGRAM   **  = MRKUT159'.                      10000022
098900     DISPLAY '**  PARAGRAPH **  = ' PV-PARAGRAPH-NAME.            10010022
099000     DISPLAY '**  OPERATION **  = ' PV-DB2-OPER-ATTEMPTED.        10020022
099100                                                                  10030022
099200*    THE FOLLOWING COPYBOOK UTILIZES THE DB2 ABEND MODULE         10040022
099300*    DSNTIAR TO CONVERT SQLCA INTO UNDERSTANDABLE VERBAGE.        10050022
099400                                                                  10060022
099500     COPY DPPD004.                                                10070022
099600                                                                  10080022
099700     CALL 'ILBOABN0'  USING ABEND-CODE.                           10090022
099800*                                                                 10100022
100000***********************END OF PROGRAM**************************** 10110022
