000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.   DLKUT032.                                          00020000
000300 AUTHOR.       RON KRIER.                                         00030000
000400 INSTALLATION. KOHLS DEPARTMENT STORES.                           00040000
000500 DATE-WRITTEN. NOVEMBER 2009.                                     00050000
000600 DATE-COMPILED.                                                   00060000
000700******************************************************************00070000
000800*             SHIPPING ASSIGNMENT RESET                           00080000
000900*                                                                 00090000
001000* THIS PROGRAM WILL USE THE EXTRACT FILE CREATED IN DLKUT023 AS   00100000
001100* INPUT TO POSSIBLY UPDATE A MATCHING PCT_BUS_EVNT_EXPRT ROW THAT 00110000
001200* HAS A 'X' IN STAT_CDE TO 'C' THUS ALLOWING FOR MANUAL CARTON    00120000
001300* SCANS                                                           00130000
001400******************************************************************00140000
001500 ENVIRONMENT DIVISION.                                            00150000
001600******************************************************************00160000
001700 CONFIGURATION SECTION.                                           00170000
001800 SOURCE-COMPUTER.        IBM-3090.                                00180000
001900 OBJECT-COMPUTER.        IBM-3090.                                00190000
002000******************************************************************00200000
002100 INPUT-OUTPUT SECTION.                                            00210000
002200 FILE-CONTROL.                                                    00220000
002300                                                                  00230000
002310     SELECT SELECT-TMST-EXTRACT-FILE ASSIGN TO INP01.             00231000
002320     SELECT EXPORT-KEY-FILE          ASSIGN TO OUT01.             00232000
002500                                                                  00250000
002600 DATA DIVISION.                                                   00260000
002700 FILE SECTION.                                                    00270000
002710 FD  SELECT-TMST-EXTRACT-FILE                                     00271000
002720     RECORDING MODE IS F                                          00272000
002730     LABEL RECORDS ARE STANDARD                                   00273000
002740     BLOCK CONTAINS 0 RECORDS.                                    00274000
002750                                                                  00275000
002760 01  SELECT-TMST-EXTRACT-RECORD       PIC X(52).                  00276000
002770                                                                  00277000
002780                                                                  00278000
002790 FD  EXPORT-KEY-FILE                                              00279000
002800     RECORDING MODE IS F                                          00280000
002900     LABEL RECORDS ARE STANDARD                                   00290000
003000     BLOCK CONTAINS 0 RECORDS.                                    00300000
003100                                                                  00310000
003200 01  EXPORT-KEY-RECORD                PIC X(080).                 00320000
003300                                                                  00330000
003500 WORKING-STORAGE SECTION.                                         00350000
003600                                                                  00360000
003700                                                                  00370000
003800 01  PS-PROGRAM-SWITCHES.                                         00380000
003900     05  PS-END-OF-EXTRACT-SW        PIC X(01)       VALUE 'N'.   00390000
004000         88  PS-END-OF-EXTRACT-YES                   VALUE 'Y'.   00400000
004100         88  PS-END-OF-EXTRACT-NO                    VALUE 'N'.   00410000
004200     05  PS-END-OF-EXT-CSR-SW        PIC  X(01)      VALUE 'N'.   00420000
004300         88  PS-END-OF-EXT-CSR-YES                   VALUE 'Y'.   00430000
004400         88  PS-END-OF-EXT-CSR-NO                    VALUE 'N'.   00440000
004500     05  PS-RUN-TYPE-SW                PIC  X(01)    VALUE ' '.   00450000
004600         88  PS-NORMAL-RUN                           VALUE '0'.   00460000
004700         88  PS-RESTART-RUN                          VALUE '9'.   00470000
004800                                                                  00480000
004900 01  PC-PROGRAM-CONSTANTS.                                        00490000
005000     05  PC-CURRENT-PROGRAM-NAME     PIC X(08) VALUE 'DLKUT032'.  00500000
005100     05  PC-PGM-NAME                 PIC X(08) VALUE 'DLKUT032'.  00510000
005200     05  PC-JOB-NAME                 PIC X(08) VALUE SPACES.      00520000
005300                                                                  00530000
005400 01  PA-TOTALS.                                                   00540000
005500     05  PA-INPUT-COUNT              PIC  9(9) VALUE 0.           00550000
005510     05  PA-OUTPUT-COUNT             PIC  9(9) VALUE 0.           00551000
005800                                                                  00580000
005900 01  ABEND-CODE                      PIC S9(4) VALUE +0           00590000
006000                                               COMP SYNC.         00600000
006100                                                                  00610000
006200 01  PV-PROGRAM-VARIABLES.                                        00620000
006210     05  PV-PROCESS-TIMESTAMP        PIC X(26) VALUE SPACE.       00621000
006300     05  PV-CURRENT-TMST             PIC X(26) VALUE SPACE.       00630000
006310     05  PV-INPUT-TMST               PIC X(26) VALUE SPACE.       00631000
006400     05  PV-DC-NBR                   PIC S9(4) COMP.              00640000
006500     05  PV-EXTRACT                  PIC X(30) VALUE SPACES.      00650000
006600     05  PV-RESTART-COUNT            PIC 9(09) VALUE 0.           00660000
006700     05  PC-MAX-RETRIES              PIC S9(03) VALUE 3 COMP-3.   00670000
006800     05  PC-RUN-IN-PROGRESS-CODE     PIC X(01)  VALUE '9'.        00680000
006900     05  PC-RUN-COMPLETE-CODE        PIC X(01)  VALUE '0'.        00690000
007000     05  PV-CKPT-STAT-CODE           PIC X(01)  VALUE SPACES.     00700000
007100     05  PV-DLSHOT-FUNC-QTY          PIC S9(9)  VALUE 0 COMP.     00710000
011118                                                                  01111800
011120 01  CC-CONTROL-CARD.                                             01112000
011130     05  CC-DC-NBR                    PIC X(04)  VALUE ZEROS.     01113000
011140     05  PV-CC-DC-NBR  REDEFINES CC-DC-NBR                        01114000
011150                                      PIC 9(4).                   01115000
011160     05  FILLER                       PIC X(5).                   01116000
011170     05  CC-JOB-NAME                  PIC X(6).                   01117000
011171     05  FILLER                       PIC X(65).                  01117100
011200                                                                  01120000
011700 01  PV-ABEND-VARIABLES.                                          01170000
011710     05  PV-ABEND-CODE               PIC S9(4) VALUE +0 COMP      01171000
011720                                                        SYNC.     01172000
011800     05  PV-RETRY-COUNTER            PIC S9(4) VALUE +0 COMP.     01180000
011900     05  PV-SQLCODE                  PIC S9(9).                   01190000
011910     05  SUB1                        PIC 9(7) VALUE 0.            01191000
012000     05  PV-DISPLAY-SQLCODE          PIC -------999.              01200000
012100     05  PV-ABEND-PROGRAM            PIC X(08) VALUE 'DLKUT032'.  01210000
012200     05  PV-ABEND-PARAGRAPH          PIC X(25) VALUE SPACES.      01220000
012300     05  PV-ABEND-OPERATION          PIC X(20) VALUE SPACES.      01230000
012400     05  PV-ABEND-STRUCTURE-1        PIC X(08) VALUE SPACES.      01240000
012500     05  PV-DB2-OPERATION-MESSAGE-1  PIC X(79) VALUE SPACES.      01250000
012700                                                                  01270000
012810******************************************************************01281000
012820*    SELECT TIMESTAMP EXTRACT FILE LAYOUT                         01282000
012830******************************************************************01283000
012900     COPY DLRD012.                                                01290000
013000                                                                  01300000
013610******************************************************************01361000
013620*    EXTRACT FILE LAYOUT                                          01362000
013630******************************************************************01363000
013640     COPY DLRD015.                                                01364000
013650                                                                  01365000
013700******************************************************************01370000
013800*  COMMUNICATIONS AREA FOR DB2                                    01380000
013900******************************************************************01390000
014000     EXEC SQL                                                     01400000
014100         INCLUDE SQLCA                                            01410000
014200     END-EXEC.                                                    01420000
014210                                                                  01421000
014220******************************************************************01422000
014221*  PARM TABLE                                                     01422100
014222******************************************************************01422200
014223     EXEC SQL                                                     01422300
014224         INCLUDE TKRPRPM                                          01422400
014225     END-EXEC.                                                    01422500
014226                                                                  01422600
014227******************************************************************01422700
014230*  DB2 FORMATTED MESSAGE AREA                                     01423000
014240******************************************************************01424000
014250     COPY DPWS004.                                                01425000
014300                                                                  01430000
014400******************************************************************01440000
014600*  PCT_BUS_EVNT_EXPRT - BUSINESS EVENT EXPORT TABLE               01460000
014700******************************************************************01470000
014800     EXEC SQL                                                     01480000
014900         INCLUDE PCT00011                                         01490000
015000     END-EXEC.                                                    01500000
015010                                                                  01501000
015020******************************************************************01502000
015040*  PCT_BUS_EVNT_DTL -  BUSINESS EVENT EXPORT DETAIL               01504000
015050******************************************************************01505000
015060     EXEC SQL                                                     01506000
015070         INCLUDE PCT00012                                         01507000
015080     END-EXEC.                                                    01508000
015090                                                                  01509000
015097******************************************************************01509700
015100* COBOL CURSOR DECLARATION                                        01510000
015110******************************************************************01511000
015120     EXEC SQL                                                     01512000
015130       DECLARE EXTRACT CURSOR FOR                                 01513000
015150         SELECT EXPRT.EVNT_EXPRT_ID, EXPRT.CRE_TMST               01515000
015151              , SUBSTR(DTL.DTL_TXT,1,29)                          01515100
015152         FROM PCT_BUS_EVNT_EXPRT EXPRT                            01515200
015153            , PCT_BUS_EVNT_DTL DTL                                01515300
015154         WHERE EXPRT.EVNT_OBJ_TXT = 'SHIPPING'                    01515400
015155           AND EXPRT.EVNT_KY_2_NBR = :PV-DC-NBR                   01515500
015156           AND NOT EXPRT.EVNT_OBJ_ACTN_TXT = 'DOOR SUMMARY'       01515600
015157           AND EXPRT.EXPRT_STAT_CDE = 'X'                         01515700
015158           AND DTL.EVNT_EXPRT_ID = EXPRT.EVNT_EXPRT_ID            01515800
015184           AND EXPRT.CRE_TMST > :PV-PROCESS-TIMESTAMP             01518400
015185         ORDER BY 3, 1                                            01518500
015193     END-EXEC.                                                    01519300
015200                                                                  01520000
032000 PROCEDURE DIVISION.                                              03200000
032100                                                                  03210000
032200 0000-PROGRAM-MAINLINE.                                           03220000
032400                                                                  03240000
032500     PERFORM 1000-INITIALIZE.                                     03250000
032600                                                                  03260000
032700     PERFORM 2000-PROCESS-EXTRACT                                 03270000
032800        UNTIL PS-END-OF-EXTRACT-YES.                              03280000
032900                                                                  03290000
033002     PERFORM 8500-EOJ-ROUTINE.                                    03300200
033003                                                                  03300300
033300     STOP RUN.                                                    03330000
033400                                                                  03340000
033500******************************************************************03350000
033700*                I N I T I A L I Z A T I O N                     *03370000
033900******************************************************************03390000
034000 1000-INITIALIZE.                                                 03400000
034010                                                                  03401000
034110     ACCEPT CC-CONTROL-CARD.                                      03411000
034200                                                                  03420000
034300     MOVE PV-CC-DC-NBR TO PV-DC-NBR.                              03430000
034301     MOVE CC-JOB-NAME  TO PC-JOB-NAME                             03430100
034310                                                                  03431000
034320     DISPLAY 'INPUT DC CONTROL CARD => ' PV-CC-DC-NBR             03432000
034330                                    '  ' CC-JOB-NAME.             03433000
034339                                                                  03433900
034340     OPEN INPUT SELECT-TMST-EXTRACT-FILE.                         03434000
034341     OPEN OUTPUT EXPORT-KEY-FILE.                                 03434100
034342                                                                  03434200
034343     INITIALIZE DL015-EAI-KEY-RECORD-LAYOUT.                      03434300
035012                                                                  03501200
035035     IF PS-END-OF-EXTRACT-YES                                     03503500
035036        CONTINUE                                                  03503600
035037     ELSE                                                         03503700
035038        PERFORM 7000-READ-INPUT                                   03503800
035039     END-IF.                                                      03503900
035040                                                                  03504000
035041     PERFORM 9808-SELECT-DLSHOT-PARM.                             03504100
035050                                                                  03505000
035100******************************************************************03510000
050900*                                                                 05090000
051000******************************************************************05100000
051100 2000-PROCESS-EXTRACT.                                            05110000
051500                                                                  05150000
051509     SET PS-END-OF-EXT-CSR-NO TO TRUE.                            05150900
051510     PERFORM 3000-OPEN-EXTRACT.                                   05151000
051511     PERFORM 3100-FETCH-EXTRACT                                   05151100
051512        UNTIL PS-END-OF-EXT-CSR-YES.                              05151200
051513     PERFORM 3200-CLOSE-EXTRACT.                                  05151300
051516     PERFORM 7000-READ-INPUT.                                     05151600
051520                                                                  05152000
074798******************************************************************07479800
074799* OPEN EXTRACT CURSOR                                             07479900
074800******************************************************************07480000
074801 3000-OPEN-EXTRACT.                                               07480100
074802                                                                  07480200
074803     PERFORM                                                      07480302
074804         WITH TEST AFTER                                          07480400
074805         VARYING PV-RETRY-COUNTER                                 07480500
074806         FROM 1 BY 1                                              07480600
074807         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               07480700
074808            OR  (SQLCODE = +100)                                  07480800
074809            OR  (SQLCODE = +0))                                   07480900
074810                                                                  07481000
074811     EXEC SQL                                                     07481100
074812         OPEN EXTRACT                                             07481200
074813     END-EXEC                                                     07481300
074814                                                                  07481400
074815     EVALUATE TRUE                                                07481500
074816       WHEN SQLCODE = 0                                           07481600
074817       WHEN SQLCODE = -904                                        07481702
074818       WHEN SQLCODE = -913                                        07481802
074819       WHEN SQLCODE = -911                                        07481902
074820           CONTINUE                                               07482000
074821       WHEN OTHER                                                 07482100
074822           MOVE '3100-OPEN-EXTRACT-CRS'                           07482200
074823                                 TO PV-ABEND-PARAGRAPH            07482300
074824           MOVE 'OPEN EXTRACT'   TO PV-ABEND-OPERATION            07482400
074825           MOVE 'JOIN'           TO PV-ABEND-STRUCTURE-1          07482500
074826           MOVE 'OPEN CURSOR'    TO PV-DB2-OPERATION-MESSAGE-1    07482600
074827           PERFORM 9900-DB2-ABEND                                 07482700
074828     END-EVALUATE                                                 07482800
074829     END-PERFORM.                                                 07482900
074830                                                                  07483000
074831     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES AND                    07483100
074832         SQLCODE NOT = ZERO                                       07483200
074833         DISPLAY '**************************************'         07483300
074834         DISPLAY 'MAX RETRIES EXCEEDED ATTEMPTING TO    '         07483400
074835         DISPLAY 'OPEN EXTRACT CURSOR    '                        07483500
074836         DISPLAY '**************************************'         07483600
074837         MOVE '3100-OPEN-EXTRACT-CRS'                             07483700
074838                               TO PV-ABEND-PARAGRAPH              07483800
074839         MOVE 'OPEN EXTRACT'   TO PV-ABEND-OPERATION              07483900
074840         MOVE 'JOIN'           TO PV-ABEND-STRUCTURE-1            07484000
074841         MOVE 'OPEN CURSOR'    TO PV-DB2-OPERATION-MESSAGE-1      07484100
074842         PERFORM 9900-DB2-ABEND                                   07484200
074843     END-IF.                                                      07484300
074844                                                                  07484400
074845******************************************************************07484500
074846* FETCH EXTRACT CURSOR                                            07484600
074847******************************************************************07484700
074848 3100-FETCH-EXTRACT.                                              07484800
074850                                                                  07485000
074851     PERFORM                                                      07485100
074852         WITH TEST AFTER                                          07485200
074853         VARYING PV-RETRY-COUNTER                                 07485300
074854         FROM 1 BY 1                                              07485400
074855         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               07485500
074856            OR  (SQLCODE = +100)                                  07485600
074857            OR  (SQLCODE = +0))                                   07485700
074858                                                                  07485800
074860     EXEC SQL                                                     07486000
074870         FETCH EXTRACT                                            07487000
074880          INTO  :DL015-EVNT-EXPRT-ID                              07488000
074881             ,  :DL015-EXTRACT-TIMESTAMP                          07488100
074882             ,  :DL015-EXTRACT-DTL-TXT                            07488200
074900     END-EXEC                                                     07490000
075000                                                                  07500000
075100     EVALUATE TRUE                                                07510000
075200         WHEN SQLCODE = ZERO                                      07520000
075210             SET DL015-PC-APP-ID TO TRUE                          07521000
075220             PERFORM 7200-WRITE-KEY-REC                           07522000
075400         WHEN SQLCODE = +100                                      07540000
075500             SET PS-END-OF-EXT-CSR-YES TO TRUE                    07550000
075510         WHEN SQLCODE = -904                                      07551002
075520         WHEN SQLCODE = -913                                      07552002
075530         WHEN SQLCODE = -911                                      07553002
075540              CONTINUE                                            07554002
075600         WHEN OTHER                                               07560000
075700             MOVE '3100-FETCH-EXTRACT'                            07570000
075800                                 TO PV-ABEND-PARAGRAPH            07580000
075900             MOVE 'FETCH EXTRACT' TO PV-ABEND-OPERATION           07590000
076000             MOVE 'JOIN'       TO PV-ABEND-STRUCTURE-1            07600000
076100             MOVE 'FETCH CURSOR' TO PV-DB2-OPERATION-MESSAGE-1    07610000
076200             PERFORM 9900-DB2-ABEND                               07620000
076300     END-EVALUATE                                                 07630000
076301     END-PERFORM.                                                 07630100
076302                                                                  07630200
076303     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES AND                    07630300
076304         SQLCODE NOT = ZERO                                       07630400
076305         DISPLAY '**************************************'         07630500
076306         DISPLAY 'MAX RETRIES EXCEEDED ATTEMPTING TO    '         07630600
076307         DISPLAY 'FETCH EXTRACT CURSOR   '                        07630700
076308         DISPLAY '**************************************'         07630800
076309         MOVE '3100-FETCH-EXTRACT'                                07630900
076310                              TO PV-ABEND-PARAGRAPH               07631000
076311         MOVE 'FETCH EXTRACT' TO PV-ABEND-OPERATION               07631100
076312         MOVE 'JOIN'       TO PV-ABEND-STRUCTURE-1                07631200
076313         MOVE 'FETCH CURSOR' TO PV-DB2-OPERATION-MESSAGE-1        07631300
076314         PERFORM 9900-DB2-ABEND                                   07631400
076315     END-IF.                                                      07631500
076320                                                                  07632000
076350******************************************************************07635000
076351* CLOSE EXTRACT CURSOR                                            07635100
076352******************************************************************07635200
076353 3200-CLOSE-EXTRACT.                                              07635300
076354                                                                  07635400
076355     PERFORM                                                      07635500
076356         WITH TEST AFTER                                          07635600
076357         VARYING PV-RETRY-COUNTER                                 07635700
076358         FROM 1 BY 1                                              07635800
076359         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               07635900
076360            OR  (SQLCODE = +100)                                  07636000
076361            OR  (SQLCODE = +0))                                   07636100
076362                                                                  07636200
076363     EXEC SQL                                                     07636300
076364         CLOSE EXTRACT                                            07636400
076365     END-EXEC                                                     07636500
076366                                                                  07636600
076367     EVALUATE TRUE                                                07636700
076368       WHEN SQLCODE = 0                                           07636800
076369       WHEN SQLCODE = -904                                        07636902
076370       WHEN SQLCODE = -913                                        07637002
076371       WHEN SQLCODE = -911                                        07637102
076372           CONTINUE                                               07637200
076373       WHEN OTHER                                                 07637300
076374           MOVE '3200-CLOSE-EXTRACT-CRS'                          07637400
076375                                 TO PV-ABEND-PARAGRAPH            07637500
076376           MOVE 'CLOSE EXTRACT'   TO PV-ABEND-OPERATION           07637600
076377           MOVE 'JOIN'           TO PV-ABEND-STRUCTURE-1          07637700
076378           MOVE 'CLOSE CURSOR'   TO PV-DB2-OPERATION-MESSAGE-1    07637800
076379           PERFORM 9900-DB2-ABEND                                 07637900
076380     END-EVALUATE                                                 07638000
076381     END-PERFORM.                                                 07638100
076382                                                                  07638200
076383     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES AND                    07638300
076384         SQLCODE NOT = ZERO                                       07638400
076385         DISPLAY '**************************************'         07638500
076386         DISPLAY 'MAX RETRIES EXCEEDED ATTEMPTING TO    '         07638600
076387         DISPLAY 'CLOSE EXTRACT CURSOR   '                        07638700
076388         DISPLAY '**************************************'         07638800
076389         MOVE '3200-CLOSE-EXTRACT-CRS'                            07638900
076390                               TO PV-ABEND-PARAGRAPH              07639000
076391         MOVE 'CLOSE EXTRACT'   TO PV-ABEND-OPERATION             07639100
076392         MOVE 'JOIN'           TO PV-ABEND-STRUCTURE-1            07639200
076393         MOVE 'CLOSE CURSOR'   TO PV-DB2-OPERATION-MESSAGE-1      07639300
076394         PERFORM 9900-DB2-ABEND                                   07639400
076395     END-IF.                                                      07639500
076396                                                                  07639600
076397******************************************************************07639700
076398*  READ THE INPUT FILE                                            07639800
076399******************************************************************07639900
076400 7000-READ-INPUT.                                                 07640000
076401                                                                  07640100
076402     READ SELECT-TMST-EXTRACT-FILE                                07640200
076403       INTO DL012-CONTROL-RECORD                                  07640300
076404           AT END                                                 07640400
076405               SET PS-END-OF-EXTRACT-YES TO TRUE.                 07640500
076406                                                                  07640600
076407     IF PS-END-OF-EXTRACT-NO                                      07640700
076408        ADD 1 TO PA-INPUT-COUNT                                   07640800
076409        DISPLAY 'INPUT TIMESTAMP >- ' DL012-CONTROL-TMST          07640900
076410        MOVE DL012-CONTROL-TMST TO PV-INPUT-TMST                  07641000
076411     END-IF.                                                      07641100
076412                                                                  07641200
076413******************************************************************07641300
076414*  WRITE THE OUTPUT KEY RECORD                                    07641400
076415******************************************************************07641500
076416 7200-WRITE-KEY-REC.                                              07641600
076417                                                                  07641700
076418     ADD 1 TO PA-OUTPUT-COUNT.                                    07641800
076419     WRITE EXPORT-KEY-RECORD FROM                                 07641900
076420           DL015-EAI-KEY-RECORD-LAYOUT.                           07642000
076421                                                                  07642100
076422******************************************************************07642200
076423* EOJ DISPLAYS                                                    07642300
076424******************************************************************07642400
076425 8500-EOJ-ROUTINE.                                                07642500
076426                                                                  07642600
076427     CLOSE SELECT-TMST-EXTRACT-FILE                               07642700
076428           EXPORT-KEY-FILE.                                       07642800
076429                                                                  07642900
076430     DISPLAY '*******************************************'        07643000
076431     DISPLAY '      * DLKUT032 SUMMARY STATISTICS *      '        07643100
076432     DISPLAY ' '                                                  07643200
076433     DISPLAY '        ---------------------------        '        07643300
076434     DISPLAY '             KEY DATA EXTRACT              '        07643400
076435     DISPLAY '        ---------------------------        '        07643500
076436     DISPLAY ' '                                                  07643600
076437     DISPLAY ' INPUT  COUNT: ' PA-INPUT-COUNT.                    07643700
076438     DISPLAY ' OUTPUT COUNT: ' PA-OUTPUT-COUNT.                   07643800
076439     DISPLAY ' '                                                  07643900
076440     DISPLAY '************  END OF DLKUT032  ***************'.    07644000
076450                                                                  07645000
076655******************************************************************07665500
076656*  GET PARM TO DETERMINE CURSOR CRE-TMST WINDOW IN MINUTES        07665600
076657******************************************************************07665700
076658 9808-SELECT-DLSHOT-PARM.                                         07665800
076659                                                                  07665900
076660     PERFORM                                                      07666000
076670         WITH TEST AFTER                                          07667000
076680         VARYING PV-RETRY-COUNTER                                 07668000
076690         FROM 1 BY 1                                              07669000
076700         UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES OR               07670000
076800                     SQLCODE = ZERO                               07680000
076900                                                                  07690000
077000         EXEC SQL                                                 07700000
077010             SELECT  FUNC_QTY                                     07701000
077020                   ,(TIMESTAMP(:PV-INPUT-TMST) - FUNC_QTY MINUTES)07702000
077030              INTO   :PV-DLSHOT-FUNC-QTY                          07703000
077040                   , :PV-PROCESS-TIMESTAMP                        07704000
077300              FROM   TKRPRPM                                      07730000
077400             WHERE   LOC_ID            = 90                       07740000
077500               AND   INTFC_SYS_CDE     = 'DLX'                    07750000
077600               AND   FUNC_PRC_STAT_CDE = 'AC'                     07760000
077700               AND   SYS_PRC_FUNC_CDE  = 'DLSHOT'                 07770000
077800               AND  (CURRENT DATE                                 07780000
077900                     BETWEEN DATE (FUNC_BEG_TMST) AND             07790000
078000                             DATE (FUNC_END_TMST))                07800000
078100         END-EXEC                                                 07810000
078200                                                                  07820000
078300         EVALUATE TRUE                                            07830000
078400             WHEN SQLCODE = ZERO                                  07840000
078500                DISPLAY 'TIME WINDOW (MIN)    -> '                07850000
078501                        PV-DLSHOT-FUNC-QTY                        07850100
078510                DISPLAY 'CALCULATED TIMESTAMP -> '                07851000
078520                        PV-PROCESS-TIMESTAMP                      07852000
078600             WHEN SQLCODE = -904                                  07860000
078700             WHEN SQLCODE = -911                                  07870000
078800             WHEN SQLCODE = -913                                  07880000
078900                  CONTINUE                                        07890000
079000             WHEN SQLWARN0 NOT = SPACES                           07900000
079100             WHEN SQLCODE NOT = ZERO                              07910000
079200                MOVE '9808-SELECT-DLSHOT-PARM'                    07920000
079300                                     TO PV-ABEND-PARAGRAPH        07930000
079400                MOVE 'SELECT'        TO PV-ABEND-OPERATION        07940000
079500                MOVE 'SELECT'        TO PV-ABEND-STRUCTURE-1      07950000
079600                MOVE 'SELECT DLSHOT' TO PV-DB2-OPERATION-MESSAGE-107960000
079700                PERFORM 9900-DB2-ABEND                            07970000
079800         END-EVALUATE                                             07980000
079900     END-PERFORM.                                                 07990000
079901                                                                  07990100
079902     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES AND                    07990200
079903         (SQLCODE NOT = ZERO AND SQLCODE NOT = +100)              07990300
079904         DISPLAY '****************************************'       07990400
079905         DISPLAY '** MAX RETRIES EXCEEDED ATTEMPTING TO **'       07990500
079906         DISPLAY '** GET DLSHOT PARM FROM TKRPRPM       **'       07990600
079907         DISPLAY '** PARAGRAPH = 9808-SELECT-DLSHOT-PARM *'       07990700
079908         DISPLAY '****************************************'       07990800
079909         MOVE '9808-SELECT-DLSHOT-PARM'                           07990900
079910                              TO PV-ABEND-PARAGRAPH               07991000
079911         MOVE 'SELECT'        TO PV-ABEND-OPERATION               07991100
079912         MOVE 'SELECT'        TO PV-ABEND-STRUCTURE-1             07991200
079913         MOVE 'SELECT DLSHOT' TO PV-DB2-OPERATION-MESSAGE-1       07991300
079914         PERFORM 9900-DB2-ABEND                                   07991400
079920     END-IF.                                                      07992000
093800******************************************************************09380000
093900* 9900-DB2-ABEND - PERFORMS THE ABEND FOR THE PROGRAM IN THE      09390000
094000* EVENT THAT AN SQL ERROR OR WARNING CODE OCCURS.                 09400000
094100******************************************************************09410000
094200 9900-DB2-ABEND.                                                  09420000
094300                                                                  09430000
094400     MOVE SQLCODE    TO PV-SQLCODE.                               09440000
094500     MOVE PV-SQLCODE TO PV-DISPLAY-SQLCODE.                       09450000
094600     DISPLAY '*** DB2 ERROR ***'.                                 09460000
094700     DISPLAY '*** SQLCODE   = ' PV-DISPLAY-SQLCODE.               09470000
094800     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                 09480000
094900     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               09490000
095000     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               09500000
095100     DISPLAY '*** MESSAGE   = ' PV-DB2-OPERATION-MESSAGE-1.       09510000
095200     DISPLAY '*** TABLE 1   = ' PV-ABEND-STRUCTURE-1.             09520000
095300                                                                  09530000
095400******************************************************************09540000
095500* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    09550000
095600* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         09560000
095700* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     09570000
095800* FORMAT.                                                         09580000
095900******************************************************************09590000
096000     COPY DPPD004.                                                09600000
096010                                                                  09601000
096800     MOVE +4013         TO PV-ABEND-CODE.                         09680000
096900     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         09690000
097000******************************************************************09700000
