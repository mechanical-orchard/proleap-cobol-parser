      ******************************************************************00010000
       IDENTIFICATION DIVISION.                                         00020000
      ******************************************************************00030000
      *                                                                 00040000
       PROGRAM-ID.   PXKRP100.                                          00050001
       AUTHOR.       RICH KELLEN.                                       00060000
       INSTALLATION. KOHLS DEPARTMENT STORES.                           00070000
       DATE-WRITTEN. JUNE 2010.                                         00080000
       DATE-COMPILED.                                                   00090000
      *                                                                 00100000
      ***************************************************************** 00110000
      * WR33394 - EVENT OH QTY ADJUSTMENT REPORT.                     * 00120009
      * THIS PROGRAM LOOKS UP STORE INVENTORY AND HIERARCHY TO CREATE * 00130009
      * A REPORT OF EVENT ADJUSTMENTS BY STORE FOR NEW AND ADDITIONAL * 00140009
      * MARKS. IT ALSO CREATES COMMA DELIMITED FILES WITH THE SAME    * 00150009
      * INFORMATION.                                                  * 00160009
      ***************************************************************** 00170000
      ******************** HISTORY OF CHANGES **************************00180000
      * CHG ID/                                                        *00190000
      * WR/PROJ  DATE        DESCRIPTION OF CHANGES                    *00200000
      * -------  ----------  ----------------------------------------  *00210000
      * WR36056  07/01/2010  INITIAL IMPLEMENTATION                    *00220000
      ******************************************************************00230000
      * WR39649  03/28/2011  ADD DB2 CHECK TO XST_LOC FOR PXRD122-STR- *00231031
      *                      NBR FOR E_BUS_IND = 'N' NOT ECOMM STORE   *00232031
      * KAREN GIVENS         CONTINUE PROCESS RECORD, IF = 'Y' ECOMM   *00233031
      *                      STORE SKIP RECORD.                        *00234018
      ******************************************************************00240000
       ENVIRONMENT DIVISION.                                            00250000
      ******************************************************************00260000
      *                                                                 00270000
       CONFIGURATION SECTION.                                           00280000
       SOURCE-COMPUTER.   IBM-3090.                                     00290000
       OBJECT-COMPUTER.   IBM-3090.                                     00300000
      *                                                                 00310000
       INPUT-OUTPUT SECTION.                                            00320000
       FILE-CONTROL.                                                    00330000
           SELECT INPUT-FILE                                            00340000
               ASSIGN                       TO INP01.                   00350000
                                                                        00360000
            SELECT NEW-MARK-CSV-FILE                                    00370000
              ASSIGN                        TO OUT01.                   00380000
                                                                        00390000
            SELECT ADDL-MARK-CSV-FILE                                   00391000
              ASSIGN                        TO OUT02.                   00392000
                                                                        00393000
            SELECT NEW-MARK-REPORT-FILE                                 00394004
              ASSIGN                        TO OUT03.                   00395000
                                                                        00396000
            SELECT ADDL-MARK-REPORT-FILE                                00397004
              ASSIGN                        TO OUT04.                   00398004
                                                                        00399004
      ******************************************************************00400000
       DATA DIVISION.                                                   00410000
      ******************************************************************00420000
      *                                                                 00430000
       FILE SECTION.                                                    00440000
       FD  INPUT-FILE                                                   00450000
           RECORDING MODE F                                             00460000
           BLOCK CONTAINS 0 RECORDS                                     00470000
           RECORD CONTAINS 062 CHARACTERS                               00480000
           LABEL RECORDS ARE STANDARD                                   00490000
           DATA RECORD IS INPUT-RECORD.                                 00500000
       01  INPUT-RECORD                           PIC X(062).           00510015
      *                                                                 00520000
       FD NEW-MARK-CSV-FILE                                             00530000
           RECORDING MODE IS F                                          00540000
           BLOCK CONTAINS 0 RECORDS                                     00550000
           RECORD CONTAINS 070 CHARACTERS                               00551005
           LABEL RECORDS ARE STANDARD                                   00552000
           DATA RECORD IS NEW-MARK-CSV-RECORD.                          00560005
      *                                                                 00570000
       01 NEW-MARK-CSV-RECORD                    PIC X(070).            00580002
      *                                                                 00590000
       FD ADDL-MARK-CSV-FILE                                            00591000
           RECORDING MODE IS F                                          00592000
           BLOCK CONTAINS 0 RECORDS                                     00593000
           RECORD CONTAINS 070 CHARACTERS                               00594002
           LABEL RECORDS ARE STANDARD                                   00595000
           DATA RECORD IS ADDL-MARK-CSV-RECORD.                         00596005
      *                                                                 00597000
       01 ADDL-MARK-CSV-RECORD                   PIC X(70).             00598002
      *                                                                 00599000
       FD NEW-MARK-REPORT-FILE                                          00599104
           RECORDING MODE IS F                                          00599200
           BLOCK CONTAINS 0 RECORDS                                     00599300
           RECORD CONTAINS 133 CHARACTERS                               00599400
           LABEL RECORDS ARE STANDARD                                   00599500
           DATA RECORD IS NEW-MARK-REPORT-REC.                          00599605
      *                                                                 00599700
       01 NEW-MARK-REPORT-REC                    PIC X(133).            00599904
      *                                                                 00600200
       FD ADDL-MARK-REPORT-FILE                                         00600304
           RECORDING MODE IS F                                          00600404
           BLOCK CONTAINS 0 RECORDS                                     00600504
           RECORD CONTAINS 133 CHARACTERS                               00600604
           LABEL RECORDS ARE STANDARD                                   00600704
           DATA RECORD IS ADDL-MARK-REPORT-REC.                         00600805
      *                                                                 00600904
       01 ADDL-MARK-REPORT-REC                   PIC X(133).            00601004
      *                                                                 00601204
       WORKING-STORAGE SECTION.                                         00602004
                                                                        00610000
       01 ABEND-CODE                      PIC S9(04)    VALUE ZERO      00620000
                                                        COMP SYNC.      00630000
           88  ABEND-4013-DB2-ERROR                        VALUE +4013. 00640000
      *                                                                 00650000
                                                                        00700000
       01 PC-PROGRAM-CONSTANTS.                                         00930000
          05  PC-PXKRP100                 PIC X(10)      VALUE          00940001
              'PXKRP100  '.                                             00950001
           05  PC-CURRENT-PROGRAM-NAME    PIC X(08)                     00960000
               VALUE 'PXKRP100'.                                        00970001
          05  PC-PROGRAM-NAME             PIC X(08)  VALUE              00980000
              'PXKRP100'.                                               00990001
          05  PC-CSV-HEADING-REC-1        PIC X(51)  VALUE              00991012
            'EVNT,STR,DIST,REG,TERR,BEG,SCND,END,PCT OH,INV,    '.      00992012
          05  PC-CSV-HEADING-REC-2        PIC X(51)  VALUE              00993012
            'DATE,NBR,NBR,NBR,NBR,OH QTY,QTY,OH QTY,FOUND,DATE, '.      00994012
       01 PV-PROGRAM-VARIABLES.                                         01000000
          05  PV-SQLCODE                  PIC +9(04).                   01010000
          05  PV-OPERATION-MSG            PIC X(60)  VALUE SPACES.      01020000
          05  PV-PRCHG-ID                 PIC X(10)  VALUE SPACES.      01021000
          05  PV-UNT-RTL-AMT              PIC X(09)  VALUE SPACES.      01022000
          05  PV-GP-RTL-QTY               PIC X(10)  VALUE SPACES.      01022100
          05  PV-GP-RTL-AMT               PIC X(10)  VALUE SPACES.      01023000
          05  PV-WRITE-CNT                PIC 9(7)   VALUE ZERO         01030000
                                                     COMP-3.            01040000
          05  PV-READ-CNT                 PIC 9(7)      VALUE ZERO      01050000
                                                        COMP-3.         01060000
          05  PV-LOC-NOT-FOUND-CNT        PIC 9(7)      VALUE ZERO      01070000
                                                        COMP-3.         01080000
          05  PV-RETRY-CNT                PIC S9(04)    VALUE +0        01090000
                                                        COMP SYNC.      01100000
          05  PV-ABEND-CODE        PIC S9(04)     VALUE +0              01150000
                                                  COMP SYNC.            01160000
          05  PV-PARA-NAME         PIC X(35).                           01170000
          05  PV-NEW-MARK-NOT-WRITTEN-SW  PIC X VALUE 'N'.              01180011
            88 PV-NEW-MARK-WRITTEN              VALUE 'Y'.              01180111
            88 PV-NEW-MARK-NOT-WRITTEN          VALUE 'N'.              01180211
          05  PV-ADDL-MARK-NOT-WRITTEN-SW  PIC X VALUE 'N'.             01180311
            88 PV-ADDL-MARK-WRITTEN              VALUE 'Y'.             01180411
            88 PV-ADDL-MARK-NOT-WRITTEN          VALUE 'N'.             01180511
          05  PC-REPORT-LINE-COUNTER          PIC 9(03) VALUE 99.       01180911
          05  PC-AM-PAGE-COUNTER              PIC 9(03) VALUE ZEROS.    01181011
          05  PC-NM-PAGE-COUNTER              PIC 9(03) VALUE ZEROS.    01181111
      ******************************************************************01181201
      **TIMESTAMP VARIABLES                                             01182001
      ******************************************************************01183001
       01 DF-DATE-TIME-FIELDS.                                          01184001
          05 DF-ACCEPT-DATE.                                            01185001
             10  DF-ACCEPT-YR                  PIC 9(02) VALUE ZEROS.   01186001
             10  DF-ACCEPT-MO                  PIC 9(02) VALUE ZEROS.   01187001
             10  DF-ACCEPT-DY                  PIC 9(02) VALUE ZEROS.   01188001
          05 DF-ACCEPT-TIME.                                            01189001
             10  DF-ACCEPT-HR                  PIC 9(02) VALUE ZEROS.   01189101
             10  DF-ACCEPT-MN                  PIC 9(02) VALUE ZEROS.   01189201
             10  DF-ACCEPT-SS                  PIC 9(04) VALUE ZEROS.   01189301
          05 DF-FORMAT-DATE.                                            01189401
             10  DF-FORMAT-DATE-MM             PIC 9(02) VALUE ZEROS.   01189501
             10  FILLER                        PIC X(01) VALUE '/'.     01189601
             10  DF-FORMAT-DATE-DD             PIC 9(02) VALUE ZEROS.   01189701
             10  FILLER                        PIC X(01) VALUE '/'.     01189801
             10  DF-FORMAT-DATE-YY             PIC 9(02) VALUE ZEROS.   01189901
                                                                        01190000
      *                                                                 01220000
       01 PS-PROGRAM-SWITCHES.                                          01230000
          05  END-OF-INPUT-FILE-SW PIC X(1) VALUE 'N'.                  01240000
              88  PS-END-OF-INPUT-FILE VALUE 'Y'.                       01250000
W39649    05  PS-STORE-NBR-CHECK-SW            PIC X(01)  VALUE 'N'.    01260022
W39649        88  PS-STORE-NBR-FOUND-YES                  VALUE 'Y'.    01270022
W39649        88  PS-STORE-NBR-FOUND-NO                   VALUE 'N'.    01280022
      *                                                                 01290000
      ******************************************************************01291001
      **REPORT HEADINGS                                                 01292001
      ******************************************************************01293001
       01  RH-TITLE-1.                                                  01294001
           05  FILLER                          PIC X(45)  VALUE SPACES. 01295007
           05  FILLER                          PIC X(38)                01296013
                        VALUE '  NEW MARK ONHAND ADJ REPORT     '.      01297016
           05  FILLER                          PIC X(05)  VALUE SPACES. 01298013
      *    05  RH-EVENT-DATE                   PIC X(10)  VALUE SPACES. 01298113
           05  FILLER                          PIC X(45)  VALUE SPACES. 01298213
       01  RH-TITLE-1A.                                                 01298313
           05  FILLER                          PIC X(45)  VALUE SPACES. 01298413
           05  FILLER                          PIC X(38)                01298513
                        VALUE ' ADDL MARK ONHAND ADJ REPORT     '.      01298616
           05  FILLER                          PIC X(05)  VALUE SPACES. 01298713
      *    05  RH-EVENT-DATE-1A                PIC X(10)  VALUE SPACES. 01298813
           05  FILLER                          PIC X(45)  VALUE SPACES. 01298913
       01  RH-HEADINGS-1.                                               01302004
           05  FILLER                          PIC X(02)  VALUE SPACES. 01302106
           05  FILLER                          PIC X(05)                01302201
               VALUE 'STORE'.                                           01302304
           05  FILLER                          PIC X(03)  VALUE SPACES. 01302406
           05  FILLER                          PIC X(06)                01302504
               VALUE 'EXPCTD'.                                          01302604
           05  FILLER                          PIC X(04)  VALUE SPACES. 01302706
           05  FILLER                          PIC X(04)                01302904
               VALUE 'SCND'.                                            01303004
           05  FILLER                          PIC X(08)  VALUE SPACES. 01303106
           05  FILLER                          PIC X(03)                01303204
               VALUE 'PCT'.                                             01303304
           05  FILLER                          PIC X(06)  VALUE SPACES. 01303406
           05  FILLER                          PIC X(05)                01303501
               VALUE 'UNITS'.                                           01303604
           05  FILLER                          PIC X(07)  VALUE SPACES. 01303706
           05  FILLER                          PIC X(04)                01303804
               VALUE 'DIST'.                                            01303904
           05  FILLER                          PIC X(06)  VALUE SPACES. 01304206
           05  FILLER                          PIC X(04)                01304306
               VALUE 'REGN'.                                            01304404
           05  FILLER                          PIC X(05)  VALUE SPACES. 01304506
           05  FILLER                          PIC X(04)                01304604
               VALUE 'TERR'.                                            01304704
           05  FILLER                          PIC X(04)  VALUE SPACES. 01304808
           05  FILLER                          PIC X(09)                01304908
               VALUE ' LAST INV'.                                       01305008
           05  FILLER                          PIC X(20)  VALUE SPACES. 01305108
       01  RH-HEADINGS-2.                                               01305208
           05  FILLER                          PIC X(02)  VALUE SPACES. 01305308
           05  FILLER                          PIC X(05)                01305408
               VALUE 'NBR  '.                                           01305508
           05  FILLER                          PIC X(03)  VALUE SPACES. 01305608
           05  FILLER                          PIC X(06)                01305708
               VALUE 'OH QTY'.                                          01305808
           05  FILLER                          PIC X(04)  VALUE SPACES. 01305908
           05  FILLER                          PIC X(04)                01306008
               VALUE 'QTY '.                                            01306108
           05  FILLER                          PIC X(08)  VALUE SPACES. 01306208
           05  FILLER                          PIC X(04)                01306308
               VALUE 'CAPT'.                                            01306408
           05  FILLER                          PIC X(05)  VALUE SPACES. 01306508
           05  FILLER                          PIC X(06)                01306608
               VALUE 'ADJSTD'.                                          01306708
           05  FILLER                          PIC X(07)  VALUE SPACES. 01306808
           05  FILLER                          PIC X(04)                01306908
               VALUE 'NBR '.                                            01307008
           05  FILLER                          PIC X(06)  VALUE SPACES. 01307108
           05  FILLER                          PIC X(04)                01307208
               VALUE 'NBR '.                                            01307308
           05  FILLER                          PIC X(05)  VALUE SPACES. 01307408
           05  FILLER                          PIC X(04)                01307508
               VALUE 'NBR '.                                            01307608
           05  FILLER                          PIC X(04)  VALUE SPACES. 01307708
           05  FILLER                          PIC X(04)                01307808
               VALUE 'DATE'.                                            01307908
           05  FILLER                          PIC X(20)  VALUE SPACES. 01308004
       01  RH-BLANK-LINE.                                               01309008
           05  FILLER                          PIC X(133)  VALUE SPACES.01310008
       01  RD-DETAIL-LINE.                                              01313708
           05  RD-STR-NBR                      PIC ZZZZZ  VALUE ZEROS.  01313808
           05  FILLER                          PIC X(05)  VALUE SPACES. 01313908
           05  RD-EPECTED-OH-QTY               PIC ZZZZ9  VALUE ZEROS.  01314008
           05  FILLER                          PIC X(05)  VALUE SPACES. 01314108
           05  RD-SCANNED-QTY-NBR              PIC ZZZZ9  VALUE ZEROS.  01314208
           05  FILLER                          PIC X(05)  VALUE SPACES. 01314308
           05  RD-PCT-SCANNED                  PIC ZZZ.99 VALUE ZEROS.  01314408
           05  FILLER                          PIC X(05)  VALUE SPACES. 01314508
           05  RD-UNITS-ADJSTD                 PIC +ZZZZ9 VALUE ZEROS.  01314608
           05  FILLER                          PIC X(05)  VALUE SPACES. 01314708
           05  RD-DIST-NBR                     PIC ZZZZ9  VALUE ZEROS.  01314808
           05  FILLER                          PIC X(05)  VALUE SPACES. 01314908
           05  RD-REGION-NBR                   PIC ZZZZ9  VALUE ZEROS.  01315008
           05  FILLER                          PIC X(05)  VALUE SPACES. 01315108
           05  RD-TERR-NBR                     PIC ZZZ9   VALUE ZEROS.  01315208
           05  FILLER                          PIC X(05)  VALUE SPACES. 01315308
           05  RD-INV-DATE                     PIC X(10)  VALUE SPACE.  01315408
           05  FILLER                          PIC X(15)  VALUE SPACES. 01315508
      ******************************************************************01315608
      **TIMESTAMP VARIABLES                                             01316008
      ******************************************************************01320000
      ******************************************************************01480000
      * DB2 ERROR MESSAGES FORMAT AREA.                                 01490000
      ******************************************************************01500000
           COPY DPWS004.                                                01510000
                                                                        01520000
      *                                                                 01570000
      ******************************************************************01571001
      * 132 BYTE REPORT LAYOUT.                                         01572001
      ******************************************************************01573001
           COPY DPWS132O.                                               01574002
                                                                        01575001
      *                                                                 01576001
      ******************************************************************01640000
      * COPY MEMBER FOR THE INPUT FILE                                  01650000
      ******************************************************************01660000
      *                                                                 01670000
           COPY PXRD122.                                                01680000
                                                                        01690000
      ******************************************************************01691000
      * COPY MEMBER FOR THE CSV OUTPUT FILE                             01692000
      ******************************************************************01693000
      *                                                                 01694000
           COPY PXRD123.                                                01695000
                                                                        01696000
      *---------------------------------------------                    01700000
      *  DB2 COMMUNICATION AREA.                                        01710000
      *---------------------------------------------                    01720000
           EXEC SQL                                                     01730000
                INCLUDE SQLCA                                           01740000
           END-EXEC.                                                    01750000
                                                                        01760000
           COPY SQLCA2.                                                 01770000
      ******************************************************************01780000
      *  DB2 TABLE TINVPAR                                              01790000
      ******************************************************************01800000
           EXEC SQL                                                     01810000
               INCLUDE TINVPAR                                          01820000
           END-EXEC.                                                    01830000
      ******************************************************************01840002
      *  DB2 TABLE XST_LOC_DIST                                         01850002
      ******************************************************************01860002
           EXEC SQL                                                     01870002
               INCLUDE XST00002                                         01880002
           END-EXEC.                                                    01890002
      ******************************************************************01900002
      *  DB2 TABLE XST_DIST_REGN                                        01910002
      ******************************************************************01920002
           EXEC SQL                                                     01930002
               INCLUDE XST00004                                         01940002
           END-EXEC.                                                    01950002
      ******************************************************************01960002
      *  DB2 TABLE XST_REGN_TERR                                        01970002
      ******************************************************************01980002
           EXEC SQL                                                     01990002
               INCLUDE XST00006                                         02000002
           END-EXEC.                                                    02010002
W39649******************************************************************02020022
W39649*  DB2 TABLE XST_LOC                                              02030022
W39649******************************************************************02040022
W39649     EXEC SQL                                                     02050022
W39649         INCLUDE XST00001                                         02060022
W39649     END-EXEC.                                                    02070022
      ******************************************************************02440000
       PROCEDURE DIVISION.                                              02450000
      ******************************************************************02460000
      *                                                                 02470000
          EJECT                                                         02480000
       0000-MAINLINE-PROCESSING.                                        02490000
      ******************************************************************02500000
      * MAIN PROCESSING ROUTINE                                       * 02510000
      ******************************************************************02520000
                                                                        02530000
            PERFORM 1000-INIT.                                          02540000
            PERFORM 2000-PROCESS-LKUP-INV-DATE                          02540123
              UNTIL PS-END-OF-INPUT-FILE.                               02560000
                                                                        02570000
            PERFORM 9000-END-OF-JOB.                                    02580000
                                                                        02590000
            GOBACK.                                                     02600000
                                                                        02610000
      ******************************************************************02620000
      * OPEN FILES AND READ FIRST INPUT RECORD.                        *02630000
      ******************************************************************02640000
      *                                                                 02650000
       1000-INIT.                                                       02660000
            MOVE '*1000-INIT.              *' TO PV-PARA-NAME.          02670000
            OPEN INPUT  INPUT-FILE                                      02680000
                 OUTPUT NEW-MARK-CSV-FILE                               02690000
                        ADDL-MARK-CSV-FILE                              02691000
                        NEW-MARK-REPORT-FILE                            02700004
                        ADDL-MARK-REPORT-FILE.                          02710004
           PERFORM 7000-READ-INPUT-FILE.                                02790000
      **RETRIEVE DATE FROM SYSTEM                                       02790101
           ACCEPT DF-ACCEPT-TIME FROM TIME.                             02790201
           ACCEPT DF-ACCEPT-DATE FROM DATE.                             02790301
                                                                        02790401
           MOVE DF-ACCEPT-YR          TO DF-FORMAT-DATE-YY.             02790501
           MOVE DF-ACCEPT-MO          TO DF-FORMAT-DATE-MM.             02790601
           MOVE DF-ACCEPT-DY          TO DF-FORMAT-DATE-DD.             02790701
                                                                        02790801
      ***PREPS KOHLS STANDARD HEADING                                   02791001
           MOVE PC-CURRENT-PROGRAM-NAME                                 02792001
                                     TO DP132O-PROGRAM-NAME.            02793001
           MOVE DF-FORMAT-DATE       TO DP132O-RUN-DATE.                02794013
           MOVE DF-ACCEPT-HR         TO DP132O-RUN-HOUR.                02795001
           MOVE DF-ACCEPT-MN         TO DP132O-RUN-MINUTE.              02796001
                                                                        02800000
                                                                        02810000
      ******************************************************************02824000
      * PROCESS INPUT FILE.                                             02830000
      ******************************************************************02840000
       2000-PROCESS-LKUP-INV-DATE.                                      02850019
           MOVE PXRD122-STR-NBR           TO PXRD123-STR-NBR            02851000
                                             XST00002-LOC-NBR           02851127
                                             RD-STR-NBR                 02851204
                                             INVPAR-LOC-NBR.            02852000
W39649     PERFORM 8100-LOOKUP-STORE-HIERARCHY                          02852124
W39649                                                                  02852224
W39649     IF PS-STORE-NBR-FOUND-YES                                    02852324
W39649                                                                  02852424
              MOVE PXRD122-EVNT-DTE          TO PXRD123-EVNT-DTE        02853024
              MOVE PXRD122-BEG-OH-QTY        TO PXRD123-BEG-OH-QTY      02855024
                                                RD-EPECTED-OH-QTY       02855124
              MOVE PXRD122-SCND-QTY          TO PXRD123-SCND-QTY        02855224
                                                RD-SCANNED-QTY-NBR      02855324
              MOVE PXRD122-END-OH-QTY        TO PXRD123-END-OH-QTY      02855424
              COMPUTE RD-UNITS-ADJSTD = PXRD122-SCND-QTY  -             02855524
                    PXRD122-BEG-OH-QTY                                  02855624
              MOVE PXRD122-PCT-OH-FND        TO PXRD123-PCT-OH-FND      02855724
                                                RD-PCT-SCANNED          02855824
              MOVE XST00006-TERR-NBR         TO PXRD123-TERR-NBR        02857524
                                                RD-TERR-NBR             02857624
              MOVE XST00004-REGN-NBR         TO PXRD123-REGN-NBR        02857724
                                                RD-REGION-NBR           02857824
              MOVE XST00002-DIST-NBR         TO PXRD123-DIST-NBR        02857924
                                                RD-DIST-NBR             02858024
              PERFORM 8000-LOOKUP-LAST-INV-DATE                         02858124
              MOVE INVPAR-ACTL-FIN-BK-DTE    TO PXRD123-INV-DTE         02858224
                                                RD-INV-DATE             02858324
              IF PXRD122-MARK-TYP-CDE = 'N'                             02858424
                 PERFORM 7100-WRITE-NEW-MARK-CSV-FILE                   02859024
                 IF PC-REPORT-LINE-COUNTER > 60                         02859124
                    MOVE 1             TO DP132O-REPORT-NUMBER          02859224
                    PERFORM 2100-WRITE-NEW-MARK-HDNGS                   02859324
                    WRITE NEW-MARK-REPORT-REC FROM RD-DETAIL-LINE       02859424
                   ADD +01             TO PC-REPORT-LINE-COUNTER        02859524
                 ELSE                                                   02859624
                    WRITE NEW-MARK-REPORT-REC FROM RD-DETAIL-LINE       02859724
                    ADD +01             TO PC-REPORT-LINE-COUNTER       02859824
W39649           END-IF                                                 02859924
              ELSE                                                      02860024
                 PERFORM 7200-WRITE-ADDL-MARK-CSV-FILE                  02860124
                 IF PC-REPORT-LINE-COUNTER > 60                         02860224
                    MOVE 2             TO DP132O-REPORT-NUMBER          02860324
                    PERFORM 2200-WRITE-ADDL-MARK-HDNGS                  02860424
                    WRITE ADDL-MARK-REPORT-REC FROM RD-DETAIL-LINE      02860524
                    ADD +01             TO PC-REPORT-LINE-COUNTER       02860624
                 ELSE                                                   02860724
                    WRITE ADDL-MARK-REPORT-REC FROM RD-DETAIL-LINE      02860824
                    ADD +01             TO PC-REPORT-LINE-COUNTER       02860924
W39649           END-IF                                                 02861024
W39649        END-IF                                                    02861124
W39649     END-IF.                                                      02861224
W39649                                                                  02861324
           PERFORM 7000-READ-INPUT-FILE.                                02862024
                                                                        02870000
      ***************************************************************** 02880001
      **WRITE NEW MARK REPORT HEADERS                                   02890004
      ***************************************************************** 02900001
       2100-WRITE-NEW-MARK-HDNGS.                                       02910004
                                                                        02920001
           MOVE '2100-WRITE-NEW-MARK-HDNGS'  TO PV-PARA-NAME.           02930004
                                                                        02940001
           INITIALIZE PC-REPORT-LINE-COUNTER.                           02950001
                                                                        02960001
           MOVE 0              TO PC-REPORT-LINE-COUNTER.               02961005
           ADD +1                      TO PC-NM-PAGE-COUNTER.           02970004
           MOVE PC-NM-PAGE-COUNTER        TO DP132O-PAGE-NUMBER.        02971004
           WRITE NEW-MARK-REPORT-REC FROM                               02979005
                 DP132O-STANDRD-HEADER-132-COLS                         02979104
                               AFTER ADVANCING PAGE.                    02979204
                                                                        02979304
           WRITE NEW-MARK-REPORT-REC FROM                               02979405
                 RH-TITLE-1 AFTER ADVANCING 1 LINE.                     02979604
                                                                        02979704
           WRITE NEW-MARK-REPORT-REC FROM RH-HEADINGS-1                 02979805
                               AFTER ADVANCING 2 LINES.                 02980004
           WRITE NEW-MARK-REPORT-REC FROM RH-HEADINGS-2                 02980105
                               AFTER ADVANCING 1 LINES.                 02980204
           WRITE NEW-MARK-REPORT-REC FROM RH-BLANK-LINE                 02980308
                               AFTER ADVANCING 1 LINES.                 02980408
                                                                        02980801
           ADD +05             TO PC-REPORT-LINE-COUNTER.               02980908
                                                                        02981001
      ***************************************************************** 02981104
      **WRITE ADDL MARK REPORT HEADERS                                  02981204
      ***************************************************************** 02981304
       2200-WRITE-ADDL-MARK-HDNGS.                                      02981404
                                                                        02981504
           MOVE '2200-WRITE-ADDL-MARK-HDNGS'  TO PV-PARA-NAME.          02981604
                                                                        02981704
           INITIALIZE PC-REPORT-LINE-COUNTER.                           02981804
                                                                        02981904
           MOVE 0              TO PC-REPORT-LINE-COUNTER.               02982005
           ADD +1                      TO PC-AM-PAGE-COUNTER.           02982104
           MOVE PC-AM-PAGE-COUNTER        TO DP132O-PAGE-NUMBER.        02982204
           WRITE ADDL-MARK-REPORT-REC FROM                              02982305
                 DP132O-STANDRD-HEADER-132-COLS                         02982404
                               AFTER ADVANCING PAGE.                    02982504
                                                                        02982604
           WRITE ADDL-MARK-REPORT-REC FROM                              02982705
                 RH-TITLE-1A AFTER ADVANCING 1 LINE.                    02982804
                                                                        02982904
           WRITE ADDL-MARK-REPORT-REC FROM RH-HEADINGS-1                02983005
                               AFTER ADVANCING 2 LINES.                 02983104
           WRITE ADDL-MARK-REPORT-REC FROM RH-HEADINGS-2                02983205
                               AFTER ADVANCING 1 LINES.                 02983304
           WRITE ADDL-MARK-REPORT-REC FROM RH-BLANK-LINE                02983408
                               AFTER ADVANCING 1 LINES.                 02983508
                                                                        02983604
           ADD +05             TO PC-REPORT-LINE-COUNTER.               02983708
                                                                        02983804
                                                                        02984004
      ******************************************************************02990000
      *  READ INPUT FILE                                               *03000000
      ******************************************************************03010000
       7000-READ-INPUT-FILE.                                            03020000
           ADD 1 TO PV-READ-CNT.                                        03030000
           READ INPUT-FILE INTO PXRD122-EVNT-EFF-EXTR-FILE              03040000
             AT END                                                     03050000
               SET PS-END-OF-INPUT-FILE TO TRUE.                        03060000
                                                                        03070000
      ******************************************************************03080000
      *  WRITE OUTPUT FILE                                             *03090000
      ******************************************************************03100000
       7100-WRITE-NEW-MARK-CSV-FILE.                                    03110000
           IF PV-NEW-MARK-NOT-WRITTEN                                   03120011
             WRITE NEW-MARK-CSV-RECORD FROM                             03130011
               PC-CSV-HEADING-REC-1                                     03140011
             WRITE NEW-MARK-CSV-RECORD FROM                             03140111
               PC-CSV-HEADING-REC-2.                                    03140211
           WRITE NEW-MARK-CSV-RECORD FROM                               03141011
             PXRD123-PRCHG-CSV-FILE.                                    03142011
           SET PV-NEW-MARK-WRITTEN TO TRUE.                             03143011
                                                                        03150000
      ******************************************************************03151000
      *  WRITE OUTPUT FILE                                             *03152000
      ******************************************************************03153000
       7200-WRITE-ADDL-MARK-CSV-FILE.                                   03154000
           IF PV-ADDL-MARK-NOT-WRITTEN                                  03155011
             WRITE ADDL-MARK-CSV-RECORD FROM                            03155111
               PC-CSV-HEADING-REC-1                                     03155211
             WRITE ADDL-MARK-CSV-RECORD FROM                            03155311
               PC-CSV-HEADING-REC-2.                                    03155411
           WRITE ADDL-MARK-CSV-RECORD FROM                              03156000
             PXRD123-PRCHG-CSV-FILE.                                    03157000
           SET PV-ADDL-MARK-WRITTEN TO TRUE.                            03157111
                                                                        03158000
      *------------------------------------------------------           03161004
      * 8000-LOOKUP-LAST-INV-DATE.                                      03170000
      *     LOOKS UP THE LAST INVENTORY DATE BY STORE                   03180000
      *------------------------------------------------------           03200000
                                                                        03210000
       8000-LOOKUP-LAST-INV-DATE.                                       03220000
                                                                        03230000
           EXEC SQL                                                     03240000
              SELECT ACTL_FIN_BK_DTE                                    03350000
              INTO  :INVPAR-ACTL-FIN-BK-DTE                             03360000
              FROM TINVPAR                                              03460000
              WHERE LOC_NBR = :INVPAR-LOC-NBR                           03470000
                AND INV_ID =                                            03480000
                 (SELECT MAX(INV_ID)                                    03490000
                  FROM TINVPAR A                                        03500000
                  WHERE LOC_NBR = :INVPAR-LOC-NBR                       03510000
                    AND ACTL_FIN_BK_DTE <= CURRENT DATE                 03520000
                    AND LOC_INV_STAT_CDE = 'IN')                        03521000
                                                                        03530000
               WITH UR                                                  03710000
           END-EXEC.                                                    03720000
                                                                        03730000
           EVALUATE TRUE                                                03740000
              WHEN SQLCODE = +0                                         03750000
                CONTINUE                                                03751000
              WHEN SQLCODE = +100                                       03850000
                DISPLAY 'LOC NOT FOUND ON TINVPAR TABLE - '             03851000
                  INVPAR-LOC-NBR                                        03852000
                MOVE 'NO INV DT' TO INVPAR-ACTL-FIN-BK-DTE              03853000
                ADD 1 TO PV-LOC-NOT-FOUND-CNT                           03860000
              WHEN OTHER                                                03870000
                DISPLAY 'SELECT FAILED IN PARA 8000'                    03880000
                DISPLAY 'LOC-NBR:     ' INVPAR-LOC-NBR                  03900000
                PERFORM 9980-SQL-ERROR                                  03930000
           END-EVALUATE.                                                03940000
                                                                        03950000
      *------------------------------------------------------           03951002
      * 8100-LOOKUP-STORE-HIERARCHY.                                    03952002
      *     LOOKS UP THE LOCATION HIERARCHY                             03953002
      *------------------------------------------------------           03954002
                                                                        03955002
       8100-LOOKUP-STORE-HIERARCHY.                                     03956003
                                                                        03957002
W39649     SET PS-STORE-NBR-FOUND-NO  TO TRUE.                          03957124
                                                                        03957224
           EXEC SQL                                                     03958002
               SELECT C.TERR_NBR,                                       03959128
                      B.REGN_NBR,                                       03959225
                      A.DIST_NBR                                        03959325
               INTO :XST00006-TERR-NBR,                                 03959728
                    :XST00004-REGN-NBR,                                 03959828
                    :XST00002-DIST-NBR                                  03959928
               FROM XST_LOC_DIST  A,                                    03960328
                    XST_DIST_REGN B,                                    03960428
                    XST_REGN_TERR C,                                    03960529
W39639              XST_LOC       D                                     03960630
W39649         WHERE A.LOC_NBR = :XST00002-LOC-NBR                      03960729
W39649           AND A.LOC_NBR = D.LOC_NBR                              03960829
                 AND B.DIST_NBR = A.DIST_NBR                            03960929
                 AND C.REGN_NBR = B.REGN_NBR                            03961029
                 AND A.BEG_DTE <= CURRENT DATE                          03961129
                 AND (A.END_DTE IS NULL                                 03961229
                  OR A.END_DTE > CURRENT DATE)                          03961329
                 AND B.BEG_DTE <= CURRENT DATE                          03961429
                 AND (B.END_DTE IS NULL                                 03961529
                  OR B.END_DTE > CURRENT DATE)                          03961629
                 AND C.BEG_DTE <= CURRENT DATE                          03961729
                 AND (C.END_DTE IS NULL                                 03961829
                  OR C.END_DTE > CURRENT DATE)                          03961929
W39649           AND D.LOC_TYP_CDE  = 'DS'                              03962029
W39649           AND D.E_BUS_IND    = 'N'                               03962129
                                                                        03962328
               WITH UR                                                  03962428
           END-EXEC.                                                    03962528
                                                                        03962628
           EVALUATE TRUE                                                03962728
              WHEN SQLCODE = +0                                         03962828
W39649          SET PS-STORE-NBR-FOUND-YES TO TRUE                      03962928
                                                                        03963028
              WHEN SQLCODE = +100                                       03963128
W39649          SET PS-STORE-NBR-FOUND-NO  TO TRUE                      03963228
                DISPLAY 'LOC-NBR    ' XST00002-LOC-NBR                  03963328
                MOVE 0 TO             XST00006-TERR-NBR                 03963428
                                      XST00004-REGN-NBR                 03963528
                                      XST00002-DIST-NBR                 03963628
              WHEN OTHER                                                03963728
                DISPLAY 'SELECT FAILED IN PARA 8100'                    03963828
                DISPLAY 'LOC-NBR    ' XST00002-LOC-NBR                  03963928
                PERFORM 9980-SQL-ERROR                                  03964028
           END-EVALUATE.                                                03965028
                                                                        03965602
      ******************************************************************03966002
      *  WRITE COUNTER FILES, CLOSE FILES, DISPLAY COUNTERS            *03970000
      ******************************************************************03980000
       9000-END-OF-JOB.                                                 03990000
           DISPLAY 'NBR OF LOCS NOT FOUND -   '                         04020000
                   PV-LOC-NOT-FOUND-CNT.                                04030000
           CLOSE INPUT-FILE                                             04060000
                 NEW-MARK-CSV-FILE                                      04070000
                 ADDL-MARK-CSV-FILE                                     04071000
                 NEW-MARK-REPORT-FILE                                   04071104
                 ADDL-MARK-REPORT-FILE.                                 04071204
                                                                        04080000
      *----------------------------------------------------------       04090000
       9980-SQL-ERROR.                                                  04100000
      *----------------------------------------------------------       04110000
                                                                        04120000
           MOVE SQLCODE    TO SQLCODE2.                                 04130000
           MOVE SQLERRD(3) TO SQLERRD3.                                 04140000
           DISPLAY '** PROGRAM        ** = PXKRP100'.                   04160001
           DISPLAY '** SQLCODE        ** = ' SQLCODE2.                  04170000
           DISPLAY '** ROWS PROCESSED ** = ' SQLERRD3.                  04180000
           DISPLAY '** SQLERRM        ** = ' SQLERRM.                   04190000
           DISPLAY '** SQLERRMC       ** = ' SQLERRMC.                  04200000
                                                                        04210000
           SET ABEND-4013-DB2-ERROR TO TRUE.                            04220000
           CALL 'ILBOABN0' USING ABEND-CODE.                            04230000
                                                                        04240000
      *                                                                 04250000
