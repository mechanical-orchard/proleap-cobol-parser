000100 IDENTIFICATION DIVISION.                                         00010009
000200 TITLE 'WMS - PURGE ITEM DC ASSOCIATION'                          00020010
000300**************************************************************    00030010
000400*   THIS PROGRAM WILL PURGE THE IMT_ITM_DC_ASSN TABLE.            00040014
000500**************************************************************    00050010
278816*  CHANGED 12/05/2022    BY BARB SCHULTZ    WR: CHG0278816        00051043
278816*                                                                 00051142
278816*  ADDED COMMIT LOGIC AND THE TCKRSTCNTL TABLE TO THE PROGRAM.    00051345
278816*  NOTE: THIS WILL ONLY CONTROL THE COMMIT FREQUENCY.  IT         00051445
278816*        IS NOT USED TO RESTART THE PROGRAM.  ON AN ABEND         00051645
278816*        THE JOB IS RESTARTED FROM THE TOP.                       00051745
278816*                                                                 00051945
278816**************************************************************    00052042
000600 PROGRAM-ID.    WSKUP029.                                         00060010
000700 AUTHOR.        JEAN KURKOWSKI.                                   00070010
000800 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00080010
000900 DATE-WRITTEN.  JUNE 2007.                                        00090010
001000 DATE-COMPILED.                                                   00100010
001100 ENVIRONMENT DIVISION.                                            00110010
001200 CONFIGURATION SECTION.                                           00120010
001300 SOURCE-COMPUTER. IBM-3090.                                       00130010
001400 OBJECT-COMPUTER. IBM-3090.                                       00140010
001500 INPUT-OUTPUT SECTION.                                            00150010
001600                                                                  00160010
001700 FILE-CONTROL.                                                    00170010
001800 DATA DIVISION.                                                   00180010
001900 FILE SECTION.                                                    00190010
002000                                                                  00200010
002100 WORKING-STORAGE SECTION.                                         00210010
002200 01  PS-PROGRAM-SWITCHES.                                         00220010
002300     05  PS-EOF-ITEM-DC-CSR          PIC X(01)  VALUE 'N'.        00230010
002400         88  PS-EOF-ITEM-DC-CSR-YES             VALUE 'Y'.        00240010
002500         88  PS-EOF-ITEM-DC-CSR-NO              VALUE 'N'.        00250010
002600                                                                  00260010
003210 01  PV-PROGRAM-VARIABLES.                                        00321001
003300     05  PV-ABEND-CODE               PIC S9(04) VALUE +0          00330001
003400                                                COMP SYNC.        00340001
003410     05  PV-DISPLAY-CNT              PIC Z(08)9.                  00341001
003420     05  PV-DISPLAY-UPC-ID           PIC Z(10).                   00342016
278816     05  PV-PROGRAM-NAME             PIC X(08)  VALUE 'WSKUP029'. 00343042
278816     05  PV-COMMIT-TIMESTAMP         PIC X(26)  VALUE SPACES.     00350042
278816     05  PV-CURRENT-TIMESTAMP        PIC X(26)  VALUE SPACES.     00351042
278816     05  PV-COMMIT-TAKEN             PIC 9(9)   VALUE ZERO.       00352042
278816     05  PV-DISPLAY-COMMIT           PIC Z(08)9.                  00353042
003500                                                                  00354019
003600 01  PA-PROGRAM-ACCUMULATORS.                                     00360001
003700     05  PA-TOTALS.                                               00370001
003800         10 PA-UPC-CNT               PIC S9(09) VALUE +0 COMP-3.  00380002
003810         10 PA-ACT-UPC-CNT           PIC S9(09) VALUE +0 COMP-3.  00381001
003820         10 PA-INACT-UPC-CNT         PIC S9(09) VALUE +0 COMP-3.  00382001
003900                                                                  00390001
004000 01  DK-KEYS.                                                     00400001
004100     05  DK-INTR-UPC-ID              PIC S9(09) VALUE +3 COMP.    00410001
005000                                                                  00500001
005100******************************************************************00510001
005200*  COMMUNICATIONS AREA FOR DB2                                    00520001
005300******************************************************************00530001
005400     EXEC SQL                                                     00540001
005500          INCLUDE SQLCA                                           00550001
005600     END-EXEC.                                                    00560001
005700                                                                  00570001
005800******************************************************************00580001
005900*  DB2 TABLE - ITEM DC ASSOCIATION - IMT_ITM_DC_ASSN              00590001
006100******************************************************************00610001
006200     EXEC SQL                                                     00620001
006300          INCLUDE IMT00024                                        00630001
006400     END-EXEC.                                                    00640001
006500                                                                  00650001
006510* JAK 07/2007 - REPLACE TUPC WITH TWEBITM                         00651016
006600******************************************************************00660001
006700*  DB2 TABLE - TWEBITM                                            00670014
006900******************************************************************00690001
007000     EXEC SQL                                                     00700001
007100          INCLUDE TWEBITM                                         00710014
007200     END-EXEC.                                                    00720001
007300                                                                  00730001
278816******************************************************************00731142
278816*    STANDARD DB/2 DCLGEN FOR THE CHECKPOINT RESTART TABLE       *00732042
278816******************************************************************00732142
278816     EXEC SQL                                                     00734042
278816         INCLUDE TCKRSTCN                                         00735042
278816     END-EXEC.                                                    00736042
278816                                                                  00737042
007400**DECLARE THE ITEM-DC-ASSN-CSR                                    00740001
007500     EXEC SQL                                                     00750001
007600          DECLARE ITEM-DC-ASSN-CSR CURSOR WITH HOLD FOR           00760047
007700           SELECT  DISTINCT                                       00770001
007800                   INTR_UPC_ID                                    00780001
008110           FROM    IMT_ITM_DC_ASSN                                00811001
008190     END-EXEC.                                                    00819001
008191                                                                  00819101
008200******************************************************************00821035
008300*  DB2 FORMATTED MESSAGE AREA                                     00830001
008400******************************************************************00840001
008500     COPY DPWS004.                                                00850001
008600                                                                  00860001
008700******************************************************************00870001
008800 LINKAGE SECTION.                                                 00880001
008900******************************************************************00890001
009000                                                                  00900001
009100******************************************************************00910001
009200 PROCEDURE DIVISION.                                              00920001
009300******************************************************************00930001
009400******************************************************************00940001
009500*  0000-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE PROGRAM.  *00950001
009600******************************************************************00960001
009700 0000-PROGRAM-MAINLINE.                                           00970001
009800     DISPLAY '************ START OF WSKUP029 ***************'     00980001
009900                                                                  00990001
010000     PERFORM 1000-INITIALIZE.                                     01000001
278816     PERFORM 7000-GET-COMMIT-TIMESTAMP.                           01010042
010200     PERFORM 2000-GET-UPC-ID UNTIL                                01020038
278816             PS-EOF-ITEM-DC-CSR-YES.                              01040042
010500     PERFORM 8000-DISPLAY-STATS.                                  01050001
010600                                                                  01060001
010700     DISPLAY '************  END OF WSKUP029  ***************'.    01070001
010800     STOP RUN.                                                    01080001
010900                                                                  01090001
011000******************************************************************01100001
011100* INIT DCLGENS & VARIABLES                                        01110001
011200******************************************************************01120001
011300 1000-INITIALIZE.                                                 01130001
011400                                                                  01140001
011500     INITIALIZE DCLTWEBITM                                        01150014
011700                DCLIMT00024.                                      01170001
011800                                                                  01180001
011900     INITIALIZE PV-PROGRAM-VARIABLES                              01190001
012000                PA-PROGRAM-ACCUMULATORS                           01200001
012010                PS-PROGRAM-SWITCHES.                              01201001
012100                                                                  01210001
012200******************************************************************01220001
012300** PROCESS ROWS ON IMT_ITM_DC_ASSN TABLE                          01230001
012400******************************************************************01240001
012410 2000-GET-UPC-ID.                                                 01241001
012600                                                                  01260001
012700     PERFORM 2010-OPEN-ITEM-DC-CSR.                               01270004
012810     PERFORM 2020-FETCH-ITEM-DC-CSR UNTIL                         01281007
012900             PS-EOF-ITEM-DC-CSR-YES.                              01290034
013000     PERFORM 2030-CLOSE-ITEM-DC-CSR.                              01300004
016600                                                                  01660001
016601                                                                  01660101
016602******************************************************************01660201
016603** OPEN THE CURSOR                                                01660301
016604******************************************************************01660401
016610 2010-OPEN-ITEM-DC-CSR.                                           01661004
016640                                                                  01664001
016660     SET PS-EOF-ITEM-DC-CSR-NO        TO TRUE.                    01666004
016670                                                                  01667001
016680     EXEC SQL                                                     01668001
016690          OPEN ITEM-DC-ASSN-CSR                                   01669004
016692     END-EXEC.                                                    01669201
016693                                                                  01669301
018800     EVALUATE TRUE                                                01880001
018900         WHEN SQLCODE = ZERO                                      01890001
019000             CONTINUE                                             01900001
019500         WHEN SQLWARN0 NOT EQUAL SPACE                            01950001
019600         WHEN SQLCODE NOT EQUAL ZERO                              01960001
019700             DISPLAY '******************************************' 01970001
019800             DISPLAY '** ABEND                                **' 01980001
019900             DISPLAY '** PROGRAM = WSKUP029                   **' 01990001
020000             DISPLAY '** PARAGRAPH = 2010-OPEN-ITEM-DC-CSR    **' 02000004
020100             DISPLAY '** OPEN CURSOR AGAINST IMT_ITM_DC_ASSN  **' 02010001
020200             DISPLAY '******************************************' 02020001
020300             PERFORM 9100-SQL-ABEND                               02030001
020400     END-EVALUATE.                                                02040001
020600                                                                  02060001
020610                                                                  02061001
020620******************************************************************02062001
020630** FETCH THE CURSOR - THIS WILL BRING BACK 1 ROW FOR EACH         02063001
020631**                    INTR UPC ID                                 02063101
020640******************************************************************02064001
020700 2020-FETCH-ITEM-DC-CSR.                                          02070004
020800                                                                  02080001
021200     EXEC SQL                                                     02120001
021300          FETCH ITEM-DC-ASSN-CSR                                  02130004
021310          INTO  :IMT00024-INTR-UPC-ID                             02131001
021400     END-EXEC.                                                    02140001
021500                                                                  02150001
021600     EVALUATE TRUE                                                02160001
021610         WHEN SQLCODE = ZERO                                      02161001
021620             ADD 1                     TO PA-UPC-CNT              02162002
021621             MOVE IMT00024-INTR-UPC-ID TO DK-INTR-UPC-ID          02162101
021622             PERFORM 2040-CHECK-UPC                               02162201
021623         WHEN SQLCODE = +100                                      02162301
021624             SET PS-EOF-ITEM-DC-CSR-YES TO TRUE                   02162404
021630         WHEN SQLWARN0 NOT EQUAL SPACE                            02163001
021640         WHEN SQLCODE NOT EQUAL ZERO                              02164001
021650             DISPLAY '******************************************' 02165001
021660             DISPLAY '** ABEND                                **' 02166001
021670             DISPLAY '** PROGRAM = WSKUP029                   **' 02167001
021680             DISPLAY '** PARAGRAPH = 2020-FETCH-ITEM-DC-CSR   **' 02168004
021690             DISPLAY '** FETCH ROW FROM IMT_ITM_DC_ASSN       **' 02169001
021691             DISPLAY '******************************************' 02169101
021692             PERFORM 9100-SQL-ABEND                               02169201
021693     END-EVALUATE.                                                02169301
021694                                                                  02169401
021695                                                                  02169501
021696******************************************************************02169601
021697** CLOSE THE CURSOR                                               02169701
021699******************************************************************02169901
021700 2030-CLOSE-ITEM-DC-CSR.                                          02170004
021701                                                                  02170101
021702     EXEC SQL                                                     02170201
021703          CLOSE ITEM-DC-ASSN-CSR                                  02170304
021705     END-EXEC.                                                    02170501
021706                                                                  02170601
021707     EVALUATE TRUE                                                02170701
021708         WHEN SQLCODE = ZERO                                      02170801
021709             CONTINUE                                             02170901
021710         WHEN SQLWARN0 NOT EQUAL SPACE                            02171001
021711         WHEN SQLCODE NOT EQUAL ZERO                              02171101
021712             DISPLAY '******************************************' 02171201
021713             DISPLAY '** ABEND                                **' 02171301
021714             DISPLAY '** PROGRAM = WSKUP029                   **' 02171401
021715             DISPLAY '** PARAGRAPH = 2030-CLOSE-ITEM-DC-CSR   **' 02171504
021716             DISPLAY '** CLOSE CURSOR AGAINST IMT_ITM_DC_ASSN **' 02171601
021717             DISPLAY '******************************************' 02171701
021718             PERFORM 9100-SQL-ABEND                               02171801
021719     END-EVALUATE.                                                02171901
021720                                                                  02172001
021721                                                                  02172101
021722******************************************************************02172201
021723** CHECK TO SEE IF THE INTR-UPC-ID EXISTS ON THE TWEBITM TABLE    02172314
021724** IF IT DOES NOT, THEN THE ROWS WILL BE DELETED FROM THE         02172414
021725** IMT_ITM_DC_ASSN TABLE                                          02172501
021726******************************************************************02172601
021727 2040-CHECK-UPC.                                                  02172701
021728                                                                  02172801
021729     EXEC SQL                                                     02172901
021730          SELECT INTR_UPC_ID                                      02173001
021731          INTO  :WEBITM-INTR-UPC-ID                               02173115
021732          FROM   TWEBITM                                          02173214
021733          WHERE  INTR_UPC_ID = :DK-INTR-UPC-ID                    02173305
021734           WITH  UR                                               02173417
021735     END-EXEC.                                                    02173517
021736                                                                  02173617
021737     EVALUATE TRUE                                                02173717
021738         WHEN SQLCODE = ZERO                                      02173817
021739         WHEN SQLCODE = -811                                      02173917
021740             ADD 1                TO  PA-ACT-UPC-CNT              02174017
021741         WHEN SQLCODE = +100                                      02174117
021742             ADD 1                TO  PA-INACT-UPC-CNT            02174217
021743             MOVE DK-INTR-UPC-ID  TO  PV-DISPLAY-UPC-ID           02174317
021744             DISPLAY 'INTR_UPC_ID DELETED - '                     02174417
021745                      PV-DISPLAY-UPC-ID                           02174517
021746             PERFORM 2050-DELETE-UPC                              02174717
021747         WHEN SQLWARN0 NOT EQUAL SPACE                            02174919
021748         WHEN SQLCODE NOT EQUAL ZERO                              02175019
021749             DISPLAY '******************************************' 02175119
021750             DISPLAY '** ABEND                                **' 02175219
021751             DISPLAY '** PROGRAM = WSKUP029                   **' 02175319
021752             DISPLAY '** PARAGRAPH = 2040-CHECK-UPC           **' 02175419
021753             DISPLAY '** SELECT ROW FROM TWEBITM              **' 02175519
021754             DISPLAY '******************************************' 02175619
021755             PERFORM 9100-SQL-ABEND                               02175719
021756     END-EVALUATE.                                                02175819
021757                                                                  02175919
021758                                                                  02176019
021759******************************************************************02176119
021760** DELETE THE ROWS FROM THE IMT_ITM_DC_ASSN TABLE                 02176219
021761** THERE MAY BE MORE THAN 1 ROW FOR EACH INTR-UPC-ID              02176319
021762******************************************************************02176419
021763 2050-DELETE-UPC.                                                 02176519
021764                                                                  02176619
021765     EXEC SQL                                                     02176741
021766          DELETE                                                  02176841
021767          FROM   IMT_ITM_DC_ASSN                                  02176941
021768          WHERE  INTR_UPC_ID = :DK-INTR-UPC-ID                    02177041
021769     END-EXEC.                                                    02177141
021770                                                                  02177219
021771     EVALUATE TRUE                                                02177341
021772         WHEN SQLCODE = ZERO                                      02177441
021773             CONTINUE                                             02177541
021774         WHEN SQLWARN0 NOT EQUAL SPACE                            02177641
021775         WHEN SQLCODE NOT EQUAL ZERO                              02177741
021776             DISPLAY '******************************************' 02177841
021777             DISPLAY '** ABEND                                **' 02177941
021778             DISPLAY '** PROGRAM = WSKUP029                   **' 02178041
021779             DISPLAY '** PARAGRAPH = 2050-DELETE-UPC          **' 02178141
021780             DISPLAY '** DELETE ROW FROM IMT_ITM_DC_ASSN      **' 02178241
021781             DISPLAY '******************************************' 02178341
021782             PERFORM 9100-SQL-ABEND                               02178441
021783     END-EVALUATE.                                                02178541
278816                                                                  02179442
278816     PERFORM 7010-CHECK-FOR-COMMIT.                               02179542
278816                                                                  02179742
278816     IF SQLCODE = ZERO                                            02180042
278816        IF PV-CURRENT-TIMESTAMP > PV-COMMIT-TIMESTAMP             02180142
278816           PERFORM 7020-COMMIT                                    02180442
278816           PERFORM 7000-GET-COMMIT-TIMESTAMP                      02180742
278816        END-IF                                                    02180942
278816     END-IF.                                                      02181042
278816                                                                  02181142
278816******************************************************************02181242
278816*  GET THE TIMESTAMP THAT WILL BE USED TO DETERMINE COMMIT       *02181342
278816*  PROCESSING                                                    *02181442
278816******************************************************************02181542
278816 7000-GET-COMMIT-TIMESTAMP.                                       02181642
278816                                                                  02181742
278816     EXEC SQL                                                     02181842
278816        SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)      02181944
278816         INTO :PV-COMMIT-TIMESTAMP                                02182044
278816        FROM TCKRSTCNTL                                           02182144
278816         WHERE PLAN_NAME           = 'WSKUP029'                   02182342
278816     END-EXEC.                                                    02182444
278816                                                                  02182542
278816     EVALUATE TRUE                                                02182644
278816        WHEN SQLCODE = ZERO                                       02182744
278816             CONTINUE                                             02182844
278816        WHEN SQLWARN0 NOT EQUAL SPACE                             02183044
278816        WHEN SQLCODE NOT = +0                                     02190044
278816            DISPLAY '******************************************'  02191044
278816            DISPLAY '** ABEND                                **'  02192044
278816            DISPLAY '** PROGRAM = WSKUP029                   **'  02193044
278816            DISPLAY '** PARAGRAPH = 7000-GET-COMMIT-TIMESTAMP**'  02194044
278816            DISPLAY '** GET COMMIT TIMESTAMP                 **'  02195044
278816            DISPLAY '******************************************'  02196044
278816            PERFORM 9100-SQL-ABEND                                02241044
278816     END-EVALUATE.                                                02250044
278816                                                                  02260342
278816***************************************************************** 02261042
278816* CHECK TO SEE IF A COMMIT NEEDS TO BE TAKEN                      02262042
278816***************************************************************** 02263042
278816 7010-CHECK-FOR-COMMIT.                                           02264042
278816                                                                  02265042
278816     EXEC SQL                                                     02266042
278816         SET :PV-CURRENT-TIMESTAMP = CURRENT TIMESTAMP            02267042
278816     END-EXEC.                                                    02268042
278816                                                                  02269042
278816     EVALUATE TRUE                                                02269142
278816         WHEN SQLCODE = ZERO                                      02270042
278816             CONTINUE                                             02280042
278816         WHEN SQLWARN0 NOT EQUAL SPACE                            02290042
278816         WHEN SQLCODE NOT = +0                                    02300042
278816             DISPLAY '******************************************' 02301042
278816             DISPLAY '** ABEND                                **' 02302042
278816             DISPLAY '** PROGRAM = WSKUP029                   **' 02303042
278816             DISPLAY '** PARAGRAPH = 7010-CHECK-FOR-COMMIT    **' 02304042
278816             DISPLAY '** CHECK FOR COMMIT FOR UPC DELETE      **' 02305042
278816             DISPLAY '******************************************' 02306042
278816             PERFORM 9100-SQL-ABEND                               02350042
278816     END-EVALUATE.                                                02360042
278816                                                                  02370042
278816***************************************************************** 02371042
278816* COMMIT DB2 CHANGES                                            * 02372042
278816***************************************************************** 02373042
278816 7020-COMMIT.                                                     02374042
278816                                                                  02375042
278816     EXEC SQL                                                     02376042
278816         COMMIT                                                   02377042
278816     END-EXEC.                                                    02378042
278816                                                                  02379042
278816     EVALUATE TRUE                                                02379142
278816         WHEN SQLCODE = ZERO                                      02380042
278816             ADD +1 TO PV-COMMIT-TAKEN                            02390042
278816         WHEN SQLWARN0 NOT EQUAL SPACE                            02400042
278816         WHEN SQLCODE NOT = +0                                    02410042
278816             DISPLAY '******************************************' 02411042
278816             DISPLAY '** ABEND                                **' 02412042
278816             DISPLAY '** PROGRAM = WSKUP029                   **' 02413042
278816             DISPLAY '** PARAGRAPH = 7020-COMMIT-TIMESTAMP    **' 02414042
278816             DISPLAY '** COMMIT UPC DELETE                    **' 02415042
278816             DISPLAY '******************************************' 02416042
278816             PERFORM 9100-SQL-ABEND                               02451042
278816     END-EVALUATE.                                                02452042
278816                                                                  02453042
024600***************************************************************** 02460001
024700* DISPLAY THE COUNTS TO THE LOG                                   02470001
024800******************************************************************02480001
024900 8000-DISPLAY-STATS.                                              02490001
025000                                                                  02500001
025100     DISPLAY '**************************************'.            02510001
025200     DISPLAY '*** WSKUP029 SUMMARY STATISTICS ******'.            02520001
025300     DISPLAY '**************************************'.            02530001
025310     MOVE PA-UPC-CNT         TO PV-DISPLAY-CNT.                   02531001
025400     DISPLAY 'TOTAL INTR UPC ID CNT:' PV-DISPLAY-CNT.             02540001
025410     MOVE PA-ACT-UPC-CNT     TO PV-DISPLAY-CNT.                   02541001
025500     DISPLAY 'ACTIVE INTR UPC ID   :' PV-DISPLAY-CNT.             02550001
025510     MOVE PA-INACT-UPC-CNT   TO PV-DISPLAY-CNT.                   02551001
025600     DISPLAY 'INACTIVE INTR UPC ID :' PV-DISPLAY-CNT.             02560001
278816     MOVE PV-COMMIT-TAKEN    TO PV-DISPLAY-CNT.                   02561042
278816     DISPLAY 'COMMITS TAKEN        :' PV-DISPLAY-CNT.             02570042
025800     DISPLAY '**************************************'.            02580001
025900                                                                  02590001
026000******************************************************************02600001
026100* PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    *02610001
026200* ERROR OR WARNING CODE OCCURS.                                  *02620001
026300******************************************************************02630001
026400 9100-SQL-ABEND.                                                  02640001
026500******************************************************************02650001
026600* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-   *02660001
026700* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE        *02670001
026800* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE    *02680001
026900* FORMAT.                                                        *02690001
027000******************************************************************02700001
027100                                                                  02710001
027200     COPY DPPD004.                                                02720001
027300                                                                  02730001
027400     MOVE +4013 TO PV-ABEND-CODE.                                 02740001
027500     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         02750001
027600                                                                  02760001
027700******************************************************************02770001
027800**            E N D   O F   P R O G R A M                       **02780001
027900******************************************************************02790001
