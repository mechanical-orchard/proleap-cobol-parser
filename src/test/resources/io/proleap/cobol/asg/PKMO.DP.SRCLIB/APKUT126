000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.      APKUT126.                                       00020000
000300 AUTHOR.          NANCY EILBES.                                   00030000
000400 INSTALLATION.    KOHLS DEPARTMENT STORES.                        00040000
000500 DATE-WRITTEN.    04/06/2004.                                     00050000
000600*----------------------------------------------------------------*00060000
000700*   CREATE VENDOR DEDUCTION TRANSACTIONS FOR VENDOR ALLOWANCE    *00070000
000710*   AGREEMENTS.                                                  *00071000
000720*   COBOL390 WITH DB2 SQL                                        *00072000
000730*----------------------------------------------------------------*00073000
000740*   THIS PROGRAM WILL READ AN EXTRACT FILE OF VENDOR AGREEMENT   *00074000
000750*   PURCHASE ACTIVITY AND GENERATE ADJUSTMENTS TO DEDUCT THE     *00075000
000760*   ALLOWANCE AMOUNT FROM THE VENDOR.                            *00076000
000770*----------------------------------------------------------------*00077000
000780*                                                                *00078000
000790* DB2 TABLES:                                                    *00079000
000800*  1. ACCOUNTS PAYABLE CONTROL TABLE  (TAPCNTL TABLE)            *00080000
000900*  2. AP TRANCODE MASTER TABLE        (TTRNCDE TABLE)            *00090000
001000*  3. DATE ATTRIBUTE TABLE            (TDTATTR TABLE)            *00100000
001100*                                                                *00110000
001200* INPUT FILE:                                                    *00120000
001300*  1. VENDOR AGREEMENT ACTIVITY FILE  (COPYBOOK APRD081)         *00130000
001400*                                                                *00140000
001500* OUTPUT FILE:                                                   *00150000
001600*  1. ADJUSTMENT DETAILS              (COPYBOOK APRD045)         *00160000
001700*                                                                *00170000
001800*----------------------------------------------------------------*00180000
001900* CHANGE LOG:                                                    *00190000
002000*   DATE  04/23/2004                                             *00200000
002100*       CHANGE MADE: INITIAL VERSION.                            *00210000
002200*       MADE BY: NANCY EILBES            WR/IR #: WR26677        *00220000
002300*                                                                *00230000
002310*  DATE  08/01/2005                                              *00231000
002320*      CHANGE MADE: MODIFIED LOGIC TO PROCESS VENDOR DEDUCTIONS  *00232000
002330*      FOR SEMI-ANNUAL AND ANNUAL POSTING FREQUENCIES AT THE END *00233000
002331*      OF THE APPROPRIATE QUARTER, AND TO GIVE THEM A PAYMENT DUE*00233100
002332*      DATE FOR THE END OF THE ACTUAL POSTING PERIOD.            *00233200
002333*      MADE BY: NANCY EILBES            WR/IR #: WR27240         *00233300
002334*                                                                *00233401
002335*  DATE  05/17/2017                                              *00233501
002336*      CHANGE MADE: ADDED LOGIC TO PUT DESCRIPTION 'BRIDAL       *00233601
002337*      DEDUCTION FOR CURRENT QUARTER' IN THE REASON 1 FIELD WHEN *00233701
002338*      CREATING TRANCODE 96 FOR THE BRIDAL REGISTRY PROGRAM.     *00233801
002340*      MADE BY: NANCY EILBES            WR/IR #: CHG0168877      *00234001
002334*                                                                *00234102
002335*  DATE  02/21/2023                                              *00234202
002336*      CHANGE MADE: CHANGE CALL TO DPKUP151 FROM STATIC TO       *00234302
002337*                   DYNAMIC                                      *00234402
002340*      MADE BY: JEAN KURK               WR/IR #: CHG0282641      *00234602
002341*----------------------------------------------------------------*00234701
002342                                                                  00234801
002343 ENVIRONMENT DIVISION.                                            00234901
002344                                                                  00235001
002345 CONFIGURATION SECTION.                                           00235101
002346 SOURCE-COMPUTER. IBM-3090.                                       00235201
002347 OBJECT-COMPUTER. IBM-3090.                                       00235301
002350                                                                  00235400
002360 INPUT-OUTPUT SECTION.                                            00236000
002370 FILE-CONTROL.                                                    00237000
002380     SELECT VNDAGR-ACTVTY-FILE ASSIGN TO INP01.                   00238000
002390     SELECT ADJUST-JRNL-FILE ASSIGN TO OUT01.                     00239000
002400                                                                  00240000
002500 DATA DIVISION.                                                   00250000
002600                                                                  00260000
002700 FILE SECTION.                                                    00270000
002800                                                                  00280000
002900 FD  VNDAGR-ACTVTY-FILE                                           00290000
003000     RECORDING MODE IS F                                          00300000
003100     LABEL RECORDS ARE STANDARD                                   00310000
003200     BLOCK CONTAINS 0 RECORDS                                     00320000
003300     DATA RECORD IS INPUT-EXP-INV-RECORD.                         00330000
003400                                                                  00340000
003500 01  VNDAGR-ACTVTY-RECORD       PIC X(250).                       00350000
003600                                                                  00360000
003700 FD  ADJUST-JRNL-FILE                                             00370000
003800     RECORDING MODE F                                             00380000
003900     LABEL RECORDS ARE STANDARD                                   00390000
004000     DATA RECORD IS ADJUST-JRNL-RECORD.                           00400000
004100 01  ADJUST-JRNL-RECORD         PIC X(500).                       00410000
004200                                                                  00420000
004300                                                                  00430000
004400 WORKING-STORAGE SECTION.                                         00440000
004500                                                                  00450000
004600 01  CONTROL-CARD.                                                00460000
004700     05  CC-BEGIN-DTE            PIC X(10).                       00470000
004800     05  FILLER                  PIC X.                           00480000
004900     05  CC-END-DTE              PIC X(10).                       00490000
005000     05  FILLER                  PIC X(59).                       00500000
005100                                                                  00510000
005200 01  PV-PROGRAM-VARIABLES.                                        00520000
005300     05  PV-CURR-TMST               PIC X(26) VALUE SPACES.       00530000
005400     05  PV-ENTR-DTE                PIC X(10) VALUE SPACES.       00540000
005500     05  PV-PYMT-DUE-DTE            PIC X(10) VALUE SPACES.       00550000
005600     05  PV-FSCL-HALF-DUE-DTE       PIC X(10) VALUE SPACES.       00560000
005700     05  PV-CAL-HALF-DUE-DTE        PIC X(10) VALUE SPACES.       00570000
005800     05  PV-FSCL-YEAR-DUE-DTE       PIC X(10) VALUE SPACES.       00580000
005900     05  PV-CAL-YEAR-DUE-DTE        PIC X(10) VALUE SPACES.       00590000
006000     05  SAVE-VENDOR-NBR            PIC X(09) VALUE SPACES.       00600000
006100     05  SAVE-AP-TRN-CDE            PIC X(02) VALUE SPACES.       00610000
006110     05  MATCH-AP-TRN-CDE           PIC X(02) VALUE SPACES.       00611000
006120     05  WS-VND-DEDUCT-TRN-CDE      PIC X(02) VALUE SPACES.       00612000
006130     05  PV-CAL-QTR-NBR             PIC X.                        00613000
006140     05  PV-POST-CAL-QTR-NBR        PIC X.                        00614000
006150     05  PV-CAL-YR-NBR              PIC X(4).                     00615000
006160                                                                  00616000
006170 01  WS-COUNTERS-AND-CONSTANTS.                                   00617000
006180     05  INPUT-COUNT                  PIC 9(09) VALUE 0.          00618000
006190     05  OUT-ADJUSTMENT-COUNT         PIC 9(09) VALUE 0.          00619000
006200     05  PC-PROGRAM-NAME              PIC X(08) VALUE 'APKUT126'. 00620000
006210     05  PC-BRIDAL-COMMENT            PIC X(36) VALUE             00621000
006220                          'BRIDAL DEDUCTION FOR CURRENT QUARTER'. 00622000
006160                                                                  00623002
006400 01  PS-PROGRAM-SWITCHES.                                         00640000
006500     05  PS-ACTVTY-EOF                PIC X(01)      VALUE 'N'.   00650000
006600         88  ACTVTY-EOF                              VALUE 'Y'.   00660000
006700     05  PS-TRANCODE-CSR-SW           PIC X(01)      VALUE ' '.   00670000
006800         88  END-OF-TRANCODES                        VALUE 'Y'.   00680000
006900     05  PS-FISCAL-MONTH-IND          PIC X(01)      VALUE 'N'.   00690000
007000         88  END-OF-FISCAL-MONTH                     VALUE 'Y'.   00700000
007100     05  PS-FISCAL-QTR-IND            PIC X(01)      VALUE 'N'.   00710000
007200         88  END-OF-FISCAL-QTR                       VALUE 'Y'.   00720000
007210     05  PS-FISCAL-HALF-IND           PIC X(01)      VALUE 'N'.   00721000
007220         88  END-OF-FISCAL-HALF                      VALUE 'Y'.   00722000
007230     05  PS-FISCAL-YEAR-IND           PIC X(01)      VALUE 'N'.   00723000
007240         88  END-OF-FISCAL-YEAR                      VALUE 'Y'.   00724000
007250     05  PS-CALENDAR-QTR-IND          PIC X(01)      VALUE 'N'.   00725000
007260         88  END-OF-CALENDAR-QTR                     VALUE 'Y'.   00726000
007270     05  PS-CALENDAR-HALF-IND         PIC X(01)      VALUE 'N'.   00727000
007280         88  END-OF-CALENDAR-HALF                    VALUE 'Y'.   00728000
007290     05  PS-CALENDAR-YEAR-IND         PIC X(01)      VALUE 'N'.   00729000
007291         88  END-OF-CALENDAR-YEAR                    VALUE 'Y'.   00729100
007292                                                                  00729200
007293 01  WS-ABEND-FIELDS.                                             00729300
007294     05  WS-ABEND-LITERAL          PIC  X(40)   VALUE             00729400
007295             '*****       ABEND'.                                 00729500
007296     05  WS-ABEND-PROGRAM-MSG.                                    00729600
007297         10  FILLER                PIC X(17)    VALUE             00729700
007298             '*****   PROGRAM: '.                                 00729800
007299         10  WS-ABEND-PROGRAM      PIC X(8)   VALUE 'APKUT126'.   00729900
007300     05  WS-ABEND-PARAGRAPH-MSG.                                  00730000
007400         10  FILLER                PIC  X(17)   VALUE             00740000
007500             '***** PARAGRAPH: '.                                 00750000
007600         10  WS-ABEND-PARAGRAPH    PIC X(35)  VALUE SPACES.       00760000
007700     05  WS-ABEND-OPERATION-MSG.                                  00770000
007800         10  FILLER                PIC  X(17)   VALUE             00780000
007900             '***** OPERATION: '.                                 00790000
008000         10  WS-ABEND-OPERATION    PIC X(50)  VALUE SPACES.       00800000
008100     05  WS-ABEND-TABLE1-MSG.                                     00810000
008200         10  FILLER                PIC  X(15)   VALUE             00820000
008300             '***** TABLE 1: '.                                   00830000
008400         10  WS-ABEND-STRUCTURE-1  PIC X(8)   VALUE SPACES.       00840000
008500     05  WS-ABEND-TABLE2-MSG.                                     00850000
008600         10  FILLER                PIC  X(15)   VALUE             00860000
008700             '***** TABLE 2: '.                                   00870000
008800         10  WS-ABEND-STRUCTURE-2  PIC X(8)   VALUE SPACES.       00880000
008900     05  WS-ABEND-STATUS           PIC XX     VALUE SPACES.       00890000
009000     05  WS-MESSAGE-LINE-1.                                       00900000
009100         10  FILLER                PIC  X(06)   VALUE '*****'.    00910000
009200         10  WS-MESSAGE-1          PIC  X(80)   VALUE SPACES.     00920000
009300     05  WS-MESSAGE-LINE-2.                                       00930000
009400         10  FILLER                PIC  X(06)   VALUE '*****'.    00940000
009500         10  WS-MESSAGE-2          PIC  X(80)   VALUE SPACES.     00950000
009600                                                                  00960000
009700 01  ABEND-CODE                    PIC S9(4)  COMP SYNC           00970000
009800                                              VALUE ZEROS.        00980000
009900     88 AP-TABLE-FULL              VALUE +4004.                   00990000
010000     88 AP-EMPTY-FILE              VALUE +4005.                   01000000
010100     88 AP-TABLE-NOTFND            VALUE +4006.                   01010000
010200     88 AC-BAD-DATA                VALUE +4008.                   01020000
010300     88 AP-DB2-ERROR               VALUE +4013.                   01030000
010400                                                                  01040000
010500 01  AP-TRANCODES.                                                01050000
010600     05  AP-TRANCODE-TBL OCCURS 25 TIMES INDEXED BY TRN-INDEX.    01060000
010700         10  TBL-AP-TRN-CDE             PIC X(2).                 01070000
010800         10  TBL-PSTG-TYP-CDE           PIC X(2).                 01080000
010900         10  TBL-TRN-TYP-CDE            PIC X(3).                 01090000
011000         10  TBL-AUTO-OFFST-TRN-CDE     PIC X(2).                 01100000
011100         10  TBL-GL-ACCT-NBR            PIC X(6).                 01110000
011200         10  TBL-BTCH-SRC-CDE           PIC X(3).                 01120000
011300         10  TBL-VND-DEDUCT-TRN-CDE     PIC X(2).                 01130000
011400                                                                  01140000
011500*----------------------------------------------------------------*01150000
011600* DB2 SQL ERROR MESSAGE FORMAT AREA                               01160000
011700*----------------------------------------------------------------*01170000
011800                                                                  01180000
011900     COPY DPWS004.                                                01190000
012000                                                                  01200000
012100*----------------------------------------------------------------*01210000
012200* VENDOR AGREEMENT ACTIVITY EXTRACT FILE LAYOUT (INPUT)           01220000
012300*----------------------------------------------------------------*01230000
012400                                                                  01240000
012500     COPY APRD081.                                                01250000
012600                                                                  01260000
012700*----------------------------------------------------------------*01270000
012800* ADJUSTMENT JOURNAL DETAIL TRANSACTION RESULTS FILE LAYOUT       01280000
012900*----------------------------------------------------------------*01290000
013000                                                                  01300000
013100     COPY APRD045.                                                01310000
013200                                                                  01320000
013300*---------------------------------------------------------------- 01330000
013400*  WORKING STORAGE AREA FOR DPKUP151                              01340000
013500*---------------------------------------------------------------- 01350000
013600     COPY APWS151.                                                01360000
013600     COPY DPWS951.                                                01361004
013700                                                                  01370000
013800*----------------------------------------------------------------*01380000
013900* ACCOUNTS PAYABLE CONTROL TABLE                                  01390000
014000*----------------------------------------------------------------*01400000
014100                                                                  01410000
014200     EXEC SQL                                                     01420000
014300         INCLUDE TAPCNTL                                          01430000
014400     END-EXEC.                                                    01440000
014500                                                                  01450000
014600*----------------------------------------------------------------*01460000
014700* AP TRANCODE MASTER TABLE                                        01470000
014800*----------------------------------------------------------------*01480000
014900                                                                  01490000
015000     EXEC SQL                                                     01500000
015100         INCLUDE TTRNCDE                                          01510000
015200     END-EXEC.                                                    01520000
015300                                                                  01530000
015400*----------------------------------------------------------------*01540000
015500* DATE ATTRIBUTE TABLE                                            01550000
015600*----------------------------------------------------------------*01560000
015700                                                                  01570000
015800     EXEC SQL                                                     01580000
015900         INCLUDE TDTATTR                                          01590000
016000     END-EXEC.                                                    01600000
016100                                                                  01610000
016200*----------------------------------------------------------------*01620000
016300* DB2 COMMUNICATION AREA                                          01630000
016400*----------------------------------------------------------------*01640000
016500                                                                  01650000
016600     EXEC SQL                                                     01660000
016700         INCLUDE SQLCA                                            01670000
016800     END-EXEC.                                                    01680000
016900                                                                  01690000
017000*----------------------------------------------------------------*01700000
017100* DB2 COMMUNICATION AREA2                                         01710000
017200*----------------------------------------------------------------*01720000
017300                                                                  01730000
017400     COPY SQLCA2.                                                 01740000
017500                                                                  01750000
017600*----------------------------------------------------------------*01760000
017700* TRANCODE CURSOR RETURNS ALL VENDOR AGREEMENT TRANCODES         *01770000
017800*----------------------------------------------------------------*01780000
017900                                                                  01790000
018000     EXEC SQL                                                     01800000
018100       DECLARE TRANCODE_CSR CURSOR FOR                            01810000
018200         SELECT AP_TRN_CDE                                        01820000
018300              , PSTG_TYP_CDE                                      01830000
018400              , TRN_TYP_CDE                                       01840000
018500              , AUTO_OFFST_TRN_CDE                                01850000
018501              , GL_ACCT_NBR                                       01850100
018502           FROM TTRNCDE                                           01850200
018503          WHERE BTCH_SRC_CDE IN ('VAA','VDA')                     01850300
018504            AND CURRENT DATE BETWEEN EFF_STRT_DTE                 01850400
018505                                 AND EFF_END_DTE                  01850500
018506     END-EXEC.                                                    01850600
018507                                                                  01850700
018508 PROCEDURE DIVISION.                                              01850800
018509                                                                  01850900
018510 A100-PROGRAM-MAINLINE.                                           01851000
018520                                                                  01852000
018530     PERFORM B100-HOUSEKEEPING.                                   01853000
018540                                                                  01854000
018550     PERFORM B200-PROCESS-ACTVTY-REC                              01855000
018560         UNTIL ACTVTY-EOF.                                        01856000
018570                                                                  01857000
018580     PERFORM B300-END-OF-JOB.                                     01858000
018590                                                                  01859000
018600     GOBACK.                                                      01860000
018700                                                                  01870000
018800*----------------------------------------------------------------*01880000
018900*  B100-HOUSEKEEPING  OPEN FILES, INITIALIZE THE NECESSARY        01890000
019000*  FIELDS, PROCESS THE INVOICE FILE FOR THE FIRST RECORD, AND     01900000
019100*  OPENS THE CURSOR FOR THE FIRST RECORD.                         01910000
019200*----------------------------------------------------------------*01920000
019300                                                                  01930000
019400 B100-HOUSEKEEPING.                                               01940000
019500                                                                  01950000
019600     OPEN INPUT  VNDAGR-ACTVTY-FILE                               01960000
019700          OUTPUT ADJUST-JRNL-FILE.                                01970000
019800                                                                  01980000
019900     INITIALIZE AP045-TRANSACTION-FILE.                           01990000
020000                                                                  02000000
020100**   ACCEPT CONTROL-CARD.                                         02010000
020200                                                                  02020000
020300     PERFORM S400-SELECT-DATES.                                   02030000
020400     MOVE APCNTL-NEXT-BTCH-PRC-DTE TO PV-ENTR-DTE.                02040000
020500                                                                  02050000
020600     DISPLAY '*** DATE CONTROLS SELECTED FOR THIS RUN ***'        02060000
020700     DISPLAY 'BATCH PROCESS DATE   = ' APCNTL-BTCH-PRC-DTE.       02070000
020800     DISPLAY 'CALCULATED ENTER DTE = ' PV-ENTR-DTE.               02080000
020900     DISPLAY 'DTATTR-FSCL-MN-NBR   = ' DTATTR-FSCL-MN-NBR.        02090000
021000     DISPLAY 'DTATTR-FSCL-YR-NBR   = ' DTATTR-FSCL-YR-NBR.        02100000
021010     DISPLAY 'DTATTR-FSCL-QTR-NBR  = ' DTATTR-FSCL-QTR-NBR.       02101000
021011     DISPLAY 'DTATTR-CAL-MN-NBR    = ' DTATTR-CAL-MN-NBR.         02101100
021012     DISPLAY 'PV-CAL-QTR-NBR       = ' PV-CAL-QTR-NBR.            02101200
021013     DISPLAY 'PV-POST-CAL-QTR-NBR  = ' PV-POST-CAL-QTR-NBR.       02101300
021014     DISPLAY 'PS-FISCAL-MONTH-IND  = ' PS-FISCAL-MONTH-IND.       02101400
021015     DISPLAY 'PS-FISCAL-QTR-IND    = ' PS-FISCAL-QTR-IND.         02101500
021016     DISPLAY 'PS-FISCAL-HALF-IND   = ' PS-FISCAL-HALF-IND.        02101600
021017     DISPLAY 'PS-FISCAL-YEAR-IND   = ' PS-FISCAL-YEAR-IND.        02101700
021018     DISPLAY 'PS-CALENDAR-QTR-IND  = ' PS-CALENDAR-QTR-IND.       02101800
021019     DISPLAY 'PS-CALENDAR-HALF-IND = ' PS-CALENDAR-HALF-IND.      02101900
021020     DISPLAY 'PS-CALENDAR-YEAR-IND = ' PS-CALENDAR-YEAR-IND.      02102000
021030     DISPLAY 'FISCAL HALF DUE DATE = ' PV-FSCL-HALF-DUE-DTE.      02103000
021031     DISPLAY 'CALNDAR HALF DUE DTE = ' PV-CAL-HALF-DUE-DTE.       02103100
021032     DISPLAY 'FISCAL YEAR DUE DATE = ' PV-FSCL-YEAR-DUE-DTE.      02103200
021033     DISPLAY 'CALNDAR YEAR DUE DTE = ' PV-CAL-YEAR-DUE-DTE.       02103300
021034     DISPLAY '****** END OF DATE CONTROLS DISPLAY *******'.       02103400
021035                                                                  02103500
021036     PERFORM S500-SET-CURRENT-TMST.                               02103600
021037     PERFORM D200-LOAD-TRANCODES.                                 02103700
021038                                                                  02103800
021039     PERFORM R100-READ-VNDAGR-ACTVTY-FILE.                        02103900
021040                                                                  02104000
021050*---------------------------------------------------------------* 02105000
021060*  PROCESSES RECORDS FROM THE EXTRACT FILE.  POSTING FREQUENCY  * 02106000
021070*  AND THE END OF PERIOD CURRENTLY BEING PROCESSED DETERMINES   * 02107000
021080*  WHETHER OR NOT A VENDOR DEDUCTION WILL BE PROCESSED.         * 02108000
021090*  THE CORRECT HALF-YEAR NUMBER IS ASSIGNED BASED ON QTR NBR.   * 02109000
021100*---------------------------------------------------------------* 02110000
021200                                                                  02120000
021300 B200-PROCESS-ACTVTY-REC.                                         02130000
021400                                                                  02140000
021500     EVALUATE TRUE                                                02150000
021600         WHEN AP081-POST-FSCL-MNTH                                02160000
021700         WHEN AP081-POST-FSCL-QTR                                 02170000
021800         WHEN AP081-POST-CAL-QTR                                  02180000
021900              MOVE APCNTL-NEXT-BTCH-PRC-DTE TO PV-PYMT-DUE-DTE    02190000
022000         WHEN AP081-POST-FSCL-SEMI-ANNL                           02200000
022100              MOVE PV-FSCL-HALF-DUE-DTE TO PV-PYMT-DUE-DTE        02210000
022200         WHEN AP081-POST-CAL-SEMI-ANNL                            02220000
022300              MOVE PV-CAL-HALF-DUE-DTE TO PV-PYMT-DUE-DTE         02230000
022400         WHEN AP081-POST-CAL-ANNL                                 02240000
022500              MOVE PV-CAL-YEAR-DUE-DTE TO PV-PYMT-DUE-DTE         02250000
022600         WHEN AP081-POST-FSCL-ANNL                                02260000
022700              MOVE PV-FSCL-YEAR-DUE-DTE TO PV-PYMT-DUE-DTE        02270000
022800     END-EVALUATE.                                                02280000
022900                                                                  02290000
022901     IF  AP081-EST-EARNED-AMT > 0                                 02290100
022902         EVALUATE TRUE                                            02290200
022903             WHEN AP081-POST-FSCL-MNTH                            02290300
022904                  IF  AP081-FSCL-MN-NBR = DTATTR-FSCL-MN-NBR      02290400
022905                  AND AP081-FSCL-YR-NBR = DTATTR-FSCL-YR-NBR      02290500
022906                      PERFORM C100-CREATE-VENDOR-DEDUCTION        02290600
022907                  END-IF                                          02290700
022908             WHEN AP081-POST-FSCL-QTR                             02290800
022909             WHEN AP081-POST-FSCL-SEMI-ANNL                       02290900
022910             WHEN AP081-POST-FSCL-ANNL                            02291000
022920                  IF  END-OF-FISCAL-QTR                           02292000
022930                  AND AP081-FSCL-QTR-NBR = DTATTR-FSCL-QTR-NBR    02293000
022931                  AND AP081-FSCL-YR-NBR = DTATTR-FSCL-YR-NBR      02293100
022932                      PERFORM C100-CREATE-VENDOR-DEDUCTION        02293200
022933                  END-IF                                          02293300
022934             WHEN AP081-POST-CAL-QTR                              02293400
022935             WHEN AP081-POST-CAL-SEMI-ANNL                        02293500
022936             WHEN AP081-POST-CAL-ANNL                             02293600
022937                  IF  END-OF-CALENDAR-QTR                         02293700
022938                  AND AP081-CAL-QTR-NBR = PV-CAL-QTR-NBR          02293800
022939                  AND AP081-CAL-YR-NBR  = PV-CAL-YR-NBR           02293900
022940                      PERFORM C100-CREATE-VENDOR-DEDUCTION        02294000
022950                  END-IF                                          02295000
022960         END-EVALUATE                                             02296000
022970     END-IF.                                                      02297000
022980                                                                  02298000
022990     PERFORM R100-READ-VNDAGR-ACTVTY-FILE.                        02299000
023000                                                                  02300000
023100*---------------------------------------------------------------* 02310000
023200*  CLOSE FILES AND PERFORM FINAL DISPLAYS.                        02320000
023300*---------------------------------------------------------------* 02330000
023400 B300-END-OF-JOB.                                                 02340000
023500                                                                  02350000
023600     CLOSE VNDAGR-ACTVTY-FILE                                     02360000
023700           ADJUST-JRNL-FILE.                                      02370000
023800                                                                  02380000
023900     DISPLAY 'ACTIVITY RECORDS READ = ' INPUT-COUNT.              02390000
024000     DISPLAY 'ADJUSTMENT RECORDS WRITTEN = ' OUT-ADJUSTMENT-COUNT.02400000
024100                                                                  02410000
024200*----------------------------------------------------------------*02420000
024300*  FORMAT THE ADJUSTMENT DETAIL RECORD FROM THE DATA ON THE INPUT*02430000
024400*  RECORD TO CREATE THE VENDOR DEDUCTION.  MANY FIELDS ARE       *02440000
024500*  LOADED FROM TTRNCDE TABLE VALUES, SO THE TRANCODE TABLE IS    *02450000
024600*  SEARCHED FOR THE VENDOR DEDUCT TRANCODE THAT GOES WITH THE    *02460000
024700*  INPUT TRANCODE BEING PROCESSED.                               *02470000
024800*----------------------------------------------------------------*02480000
024900 C100-CREATE-VENDOR-DEDUCTION.                                    02490000
025000                                                                  02500000
025100     INITIALIZE AP045-KEY-FIELDS                                  02510000
025200                AP045-COMMON-FIELDS                               02520000
025300                AP045-DETAIL-FIELDS.                              02530000
025400                                                                  02540000
025500     IF  AP081-VENDOR-NBR = SAVE-VENDOR-NBR                       02550000
025600     AND AP081-AGR-AP-TRN-CDE = SAVE-AP-TRN-CDE                   02560000
025610         CONTINUE                                                 02561000
025620     ELSE                                                         02562000
025630         MOVE AP081-VENDOR-NBR TO SAVE-VENDOR-NBR                 02563000
025640         PERFORM S100-GET-NEXT-DOC-NBR                            02564000
025650     END-IF.                                                      02565000
025660                                                                  02566000
025670     IF  AP081-AGR-AP-TRN-CDE = SAVE-AP-TRN-CDE                   02567000
025680         CONTINUE                                                 02568000
025690     ELSE                                                         02569000
025700         MOVE AP081-AGR-AP-TRN-CDE TO SAVE-AP-TRN-CDE             02570000
025800                                      MATCH-AP-TRN-CDE            02580000
025801         PERFORM D100-FIND-TRANCODE-ENTRY                         02580100
025802         MOVE TBL-VND-DEDUCT-TRN-CDE(TRN-INDEX)                   02580200
025803                                     TO WS-VND-DEDUCT-TRN-CDE     02580300
025804     END-IF.                                                      02580400
025805                                                                  02580500
025806     MOVE WS-VND-DEDUCT-TRN-CDE TO MATCH-AP-TRN-CDE.              02580600
025807     PERFORM D100-FIND-TRANCODE-ENTRY.                            02580700
025808                                                                  02580800
025809     MOVE AP081-VENDOR-NBR              TO AP045-VND-NBR.         02580900
025810     MOVE WS151-NEXT-DOC-NBR            TO AP045-DOC-NBR.         02581000
025820     MOVE APCNTL-BTCH-PRC-DTE           TO AP045-DOC-DTE.         02582000
025830     MOVE WS-VND-DEDUCT-TRN-CDE         TO AP045-AP-TRN-CDE.      02583000
025840     SET AP045-DETAIL-RECORD            TO TRUE.                  02584000
025850                                                                  02585000
025851     IF AP045-AP-TRN-CDE = '96'                                   02585100
025852        MOVE PC-BRIDAL-COMMENT          TO AP045-RSN-1ST-LNE-TXT  02585200
025853     ELSE                                                         02585300
025854        MOVE SPACES                     TO AP045-RSN-1ST-LNE-TXT  02585400
025855     END-IF.                                                      02585500
025856                                                                  02585600
025860     MOVE TBL-TRN-TYP-CDE(TRN-INDEX)    TO AP045-TRN-TYP-CDE.     02586000
025870     MOVE TBL-PSTG-TYP-CDE(TRN-INDEX)   TO AP045-PSTG-TYP-CDE.    02587000
025880                                                                  02588000
025890     IF AP045-MERCHANDISE                                         02589000
025900        MOVE 85                         TO AP045-STR-NBR          02590000
026000        MOVE AP081-DEPT-NBR             TO AP045-DEPT-NBR         02600000
026100     ELSE                                                         02610000
026200        MOVE 90                         TO AP045-STR-NBR          02620000
026300        MOVE TBL-GL-ACCT-NBR(TRN-INDEX) TO AP045-GL-ACCT-NBR      02630000
026400     END-IF.                                                      02640000
026500                                                                  02650000
026600     MOVE PV-CURR-TMST                  TO AP045-ENTR-TMST.       02660000
026700     MOVE PV-ENTR-DTE                   TO AP045-ENTR-DTE.        02670000
026800     MOVE PC-PROGRAM-NAME               TO AP045-ENTR-ID.         02680000
026900     SET  AP045-ORGN-ADJUST             TO TRUE.                  02690000
027000     MOVE APCNTL-BTCH-PRC-DTE           TO AP045-INV-CUTOFF-DTE   02700000
027100                                           AP045-PS-BTCH-DTE.     02710000
027200     MOVE 'ADJ'                         TO AP045-PS-BTCH-SRC-CDE. 02720000
027300     MOVE '00'                          TO AP045-PS-BTCH-SEQ-NBR. 02730000
027400                                                                  02740000
027500     MOVE AP081-ENT-ID                  TO AP045-ENT-ID.          02750000
027600     MOVE AP081-VENDOR-NAME             TO AP045-ENT-NME-DESC.    02760000
027700     MOVE PV-PYMT-DUE-DTE               TO AP045-PYMT-DUE-DTE.    02770000
027800                                                                  02780000
027900     IF  APCNTL-MULT-PSTG-PER-IND = 'Y'                           02790000
027910         MOVE APCNTL-PREV-PSTG-FYR-NBR  TO AP045-PSTG-FYR-NBR     02791000
027920         MOVE APCNTL-PREV-PSTG-FMN-NBR  TO AP045-PSTG-FMN-NBR     02792000
027930         MOVE APCNTL-PREV-PSTG-FWK-NBR  TO AP045-PSTG-FWK-NBR     02793000
027940     ELSE                                                         02794000
027950         MOVE APCNTL-CURR-PSTG-FYR-NBR  TO AP045-PSTG-FYR-NBR     02795000
027960         MOVE APCNTL-CURR-PSTG-FMN-NBR  TO AP045-PSTG-FMN-NBR     02796000
027970         MOVE APCNTL-CURR-PSTG-FWK-NBR  TO AP045-PSTG-FWK-NBR     02797000
027980     END-IF.                                                      02798000
027990                                                                  02799000
028000     MOVE AP081-EST-EARNED-AMT TO AP045-GRO-COST-AMT.             02800000
028100                                                                  02810000
028200**   COMPUTE AP045-GRO-COST-AMT = AP045-GRO-COST-AMT +            02820000
028300**           AP081-VND-DED-AMT.                                   02830000
028400                                                                  02840000
028500     IF AP045-CREDIT                                              02850000
028600        COMPUTE AP045-GRO-COST-AMT = AP045-GRO-COST-AMT * -1      02860000
028700     END-IF.                                                      02870000
028800                                                                  02880000
028810     MOVE AP045-GRO-COST-AMT TO AP045-NET-COST-AMT.               02881000
028820                                                                  02882000
028830     PERFORM W200-WRITE-OUTPUT-JRNL-REC.                          02883000
028840                                                                  02884000
028850                                                                  02885000
028860*----------------------------------------------------------------*02886000
028870*  SEARCHES TRANCODE TABLE FOR THE TRANCODE BEING PROCESSED.     *02887000
028880*----------------------------------------------------------------*02888000
028890 D100-FIND-TRANCODE-ENTRY.                                        02889000
028900                                                                  02890000
029000     IF  MATCH-AP-TRN-CDE = SPACES                                02900000
029100         MOVE 'D100-FIND-TRANCODE-ENTRY' TO WS-ABEND-PARAGRAPH    02910000
029200         SET AP-TABLE-NOTFND TO TRUE                              02920000
029300         DISPLAY 'AP-TRN-CDE = ' AP081-AGR-AP-TRN-CDE             02930000
029301         MOVE 'NO VENDOR DEDUCT TRNCODE AVAILABLE' TO WS-MESSAGE-102930100
029302         PERFORM Z998-ABEND                                       02930200
029303     END-IF.                                                      02930300
029304                                                                  02930400
029305     PERFORM VARYING TRN-INDEX FROM 1 BY 1                        02930500
029306       UNTIL TBL-AP-TRN-CDE(TRN-INDEX) = MATCH-AP-TRN-CDE         02930600
029307          OR TRN-INDEX > 25                                       02930700
029308     END-PERFORM.                                                 02930800
029309                                                                  02930900
029310     IF  TRN-INDEX > 25                                           02931000
029320         MOVE 'D100-FIND-TRANCODE-ENTRY' TO WS-ABEND-PARAGRAPH    02932000
029330         SET AP-TABLE-NOTFND TO TRUE                              02933000
029340         DISPLAY 'AP-TRN-CDE = ' MATCH-AP-TRN-CDE                 02934000
029350         MOVE 'TRANCODE TABLE ENTRY NOT FOUND' TO WS-MESSAGE-1    02935000
029360         PERFORM Z998-ABEND                                       02936000
029370     END-IF.                                                      02937000
029380*----------------------------------------------------------------*02938000
029390*  OPENS THE TRANCODE CURSOR AND FETCHES UNTIL END, LOADING EACH *02939000
029391*  ENTRY INTO THE TRANCODE TABLE IN WORKING STORAGE.             *02939100
029392*----------------------------------------------------------------*02939200
029393 D200-LOAD-TRANCODES.                                             02939300
029394                                                                  02939400
029395     PERFORM X100-OPEN-TRANCODE-CSR.                              02939500
029396                                                                  02939600
029397     SET TRN-INDEX TO 1.                                          02939700
029398     PERFORM S300-FETCH-TRANCODE-CSR.                             02939800
029399                                                                  02939900
029400     PERFORM UNTIL END-OF-TRANCODES OR TRN-INDEX > 15             02940000
029500        MOVE TRNCDE-AP-TRN-CDE   TO TBL-AP-TRN-CDE(TRN-INDEX)     02950000
029600        MOVE TRNCDE-PSTG-TYP-CDE TO TBL-PSTG-TYP-CDE(TRN-INDEX)   02960000
029700        MOVE TRNCDE-TRN-TYP-CDE  TO TBL-TRN-TYP-CDE(TRN-INDEX)    02970000
029800        MOVE TRNCDE-AUTO-OFFST-TRN-CDE                            02980000
029900                              TO TBL-AUTO-OFFST-TRN-CDE(TRN-INDEX)02990000
029910        MOVE TRNCDE-GL-ACCT-NBR  TO TBL-GL-ACCT-NBR(TRN-INDEX)    02991000
029911        IF TRNCDE-AP-TRN-CDE = '88'                               02991100
029912           MOVE '91'         TO TBL-VND-DEDUCT-TRN-CDE(TRN-INDEX) 02991200
029913        END-IF                                                    02991300
029914        IF TRNCDE-AP-TRN-CDE = '89'                               02991400
029915           MOVE '96'         TO TBL-VND-DEDUCT-TRN-CDE(TRN-INDEX) 02991500
029916        END-IF                                                    02991600
029917        SET TRN-INDEX UP BY 1                                     02991700
029918        PERFORM S300-FETCH-TRANCODE-CSR                           02991800
029919     END-PERFORM.                                                 02991900
029920                                                                  02992000
029921     PERFORM X200-CLOSE-TRANCODE-CSR.                             02992100
029922                                                                  02992200
029923     IF  TRN-INDEX > 15                                           02992300
029924     AND NOT END-OF-TRANCODES                                     02992400
029925         MOVE 'D200-LOAD-TRANCODES' TO WS-ABEND-PARAGRAPH         02992500
029926         SET AP-TABLE-FULL TO TRUE                                02992600
029927         MOVE 'MAX NUMBER OF ENTRIES EXCEEDED ON TRANCODE TABLE'  02992700
029928                                    TO WS-MESSAGE-1               02992800
029929         MOVE 'QUERY TTRNCDE FOR BTCH SRC = VDA AND EXPAND LIMIT' 02992900
029930                                    TO WS-MESSAGE-2               02993000
029931         PERFORM Z998-ABEND                                       02993100
029932     END-IF.                                                      02993200
029933                                                                  02993300
029934*----------------------------------------------------------------*02993400
029935*  R100-READ-VNDAGR-ACTVTY-FILE                                  *02993500
029936*  READS THE INPUT FILE INTO THE APRD081 COPYBOOK.               *02993600
029937*----------------------------------------------------------------*02993700
029938                                                                  02993800
029939 R100-READ-VNDAGR-ACTVTY-FILE.                                    02993900
029940                                                                  02994000
029941     READ VNDAGR-ACTVTY-FILE INTO AP081-VNDAGR-EXTRACT            02994100
029942         AT END                                                   02994200
029943            SET ACTVTY-EOF TO TRUE.                               02994300
029944                                                                  02994400
029945     IF NOT ACTVTY-EOF                                            02994500
029946        ADD 1 TO INPUT-COUNT                                      02994600
029947     END-IF.                                                      02994700
029948                                                                  02994800
029949                                                                  02994900
029950*----------------------------------------------------------------*02995000
029960*  S100-GET-NEXT-DOC-NBR                                         *02996000
029970*  SELECT THE NEXT AVAILABLE DOC NUMBER FROM THE TAPCNTL TABLE.  *02997000
029980*----------------------------------------------------------------*02998000
029990                                                                  02999000
030000 S100-GET-NEXT-DOC-NBR.                                           03000000
030100                                                                  03010000
030200     CALL DP951-AJ-NEXT-DOC-NBR-ROUTINE                           03020003
030200                     USING WS151-DOC-NBR-PARAMETERS.              03021002
030300                                                                  03030000
030400     IF WS151-ERRORS-FOUND                                        03040000
030500        SET AC-BAD-DATA TO TRUE                                   03050000
030600        MOVE 'S100-GET-NEXT-DOC-NBR     '                         03060000
030700                                   TO WS-ABEND-PARAGRAPH          03070000
030800        MOVE WS151-ERROR-MESSAGE   TO WS-MESSAGE-1                03080000
030900        MOVE WS151-SQLCODE         TO WS-MESSAGE-2                03090000
031000        PERFORM Z998-ABEND                                        03100000
031100     END-IF.                                                      03110000
031200                                                                  03120000
031300*----------------------------------------------------------------*03130000
031400*  S300-FETCH-TRANCODE-CSR                                       *03140000
031500*----------------------------------------------------------------*03150000
031600 S300-FETCH-TRANCODE-CSR.                                         03160000
031700                                                                  03170000
031800     EXEC SQL                                                     03180000
031900          FETCH TRANCODE_CSR                                      03190000
032000           INTO :TRNCDE-AP-TRN-CDE                                03200000
032100              , :TRNCDE-PSTG-TYP-CDE                              03210000
032200              , :TRNCDE-TRN-TYP-CDE                               03220000
032300              , :TRNCDE-AUTO-OFFST-TRN-CDE                        03230000
032400              , :TRNCDE-GL-ACCT-NBR                               03240000
032500     END-EXEC.                                                    03250000
032600                                                                  03260000
032700     EVALUATE TRUE                                                03270000
032800         WHEN SQLCODE = +0                                        03280000
032900              CONTINUE                                            03290000
033000         WHEN SQLCODE = +100                                      03300000
033100              SET END-OF-TRANCODES TO TRUE                        03310000
033200                                                                  03320000
033300         WHEN SQLWARN0 NOT = SPACES                               03330000
033400         WHEN SQLCODE < +0                                        03340000
033500         WHEN SQLCODE > +0                                        03350000
033600              MOVE 'S300-FETCH-TRANCODE-CSR'                      03360000
033700                                TO WS-ABEND-PARAGRAPH             03370000
033800              MOVE 'UNSUCCESSFUL FETCH ON TRANCODE CSR'           03380000
033900                                TO WS-ABEND-OPERATION             03390000
034000              MOVE 'TTRNCDE '   TO WS-ABEND-STRUCTURE-1           03400000
034100              MOVE SPACES       TO WS-ABEND-STRUCTURE-2           03410000
034200              PERFORM Z999-SQL-ERROR                              03420000
034300     END-EVALUATE.                                                03430000
034400                                                                  03440000
034500*----------------------------------------------------------------*03450000
034600*  SELECT BATCH PROCESS DATE, CURR/PREV POSTING FISCAL YEAR,     *03460000
034700*  CURR/PREV POSTING FISCAL MONTH, AND CURR/PREV POSTING FISCAL  *03470000
034800*  WEEK FROM THE TAPCNTL TABLE, ALONG WITH THE FISCAL MONTH      *03480000
034900*  NUMBER FROM THE TDTATTR TABLE.  THE WHERE CONDITION STATING   *03490000
035000*  A.BTCH_PRC_DTE = B.FSCL_MN_END_DTE GUARANTEES THAT THIS       *03500000
035100*  PROGRAM IS BEING RUN ON THE LAST DAY OF THE FISCAL MONTH.     *03510000
035200*  BATCH PROCESS DATE PLUS 2 DAYS IS USED AS THE ENTER DATE SO   *03520000
035300*  IT WILL BE A MONDAY DATE, WHICH IS WHEN THE TRANSACTIONS      *03530000
035400*  BEING CREATED IN THIS PROGRAM WILL ACTUALLY POST.             *03540000
035500*----------------------------------------------------------------*03550000
035600 S400-SELECT-DATES.                                               03560000
035700                                                                  03570000
035800     EXEC SQL                                                     03580000
035900          SELECT A.BTCH_PRC_DTE                                   03590000
036000               , A.NEXT_BTCH_PRC_DTE                              03600000
036100               , A.CURR_PSTG_FYR_NBR                              03610000
036200               , A.CURR_PSTG_FMN_NBR                              03620000
036300               , A.CURR_PSTG_FWK_NBR                              03630000
036400               , A.PREV_PSTG_FYR_NBR                              03640000
036500               , A.PREV_PSTG_FMN_NBR                              03650000
036600               , A.PREV_PSTG_FWK_NBR                              03660000
036700               , A.MULT_PSTG_PER_IND                              03670000
036800               , B.FSCL_MN_NBR                                    03680000
036900               , B.FSCL_YR_NBR                                    03690000
037000               , B.FSCL_QTR_NBR                                   03700000
037100               , B.CAL_MN_NBR                                     03710000
037200               , B.SEA_DESC                                       03720000
037300               , (CASE B.CAL_MN_NBR                               03730000
037400                  WHEN '01' THEN '1'                              03740000
037410                  WHEN '02' THEN '1'                              03741000
037420                  WHEN '03' THEN '1'                              03742000
037430                  WHEN '04' THEN '2'                              03743000
037440                  WHEN '05' THEN '2'                              03744000
037450                  WHEN '06' THEN '2'                              03745000
037460                  WHEN '07' THEN '3'                              03746000
037470                  WHEN '08' THEN '3'                              03747000
037480                  WHEN '09' THEN '3'                              03748000
037490                  WHEN '10' THEN '4'                              03749000
037491                  WHEN '11' THEN '4'                              03749100
037492                  WHEN '12' THEN '4'                              03749200
037493                  END)                                            03749300
037494               , (CASE B.CAL_MN_NBR                               03749400
037495                  WHEN '01' THEN CHAR(INTEGER(B.FSCL_YR_NBR)+ 1)  03749500
037496                  ELSE B.FSCL_YR_NBR                              03749600
037497                 END)                                             03749700
037498            INTO :APCNTL-BTCH-PRC-DTE                             03749800
037499               , :APCNTL-NEXT-BTCH-PRC-DTE                        03749900
037500               , :APCNTL-CURR-PSTG-FYR-NBR                        03750000
037600               , :APCNTL-CURR-PSTG-FMN-NBR                        03760000
037700               , :APCNTL-CURR-PSTG-FWK-NBR                        03770000
037800               , :APCNTL-PREV-PSTG-FYR-NBR                        03780000
037900               , :APCNTL-PREV-PSTG-FMN-NBR                        03790000
038000               , :APCNTL-PREV-PSTG-FWK-NBR                        03800000
038100               , :APCNTL-MULT-PSTG-PER-IND                        03810000
038200               , :DTATTR-FSCL-MN-NBR                              03820000
038300               , :DTATTR-FSCL-YR-NBR                              03830000
038310               , :DTATTR-FSCL-QTR-NBR                             03831000
038320               , :DTATTR-CAL-MN-NBR                               03832000
038321               , :DTATTR-SEA-DESC                                 03832100
038322               , :PV-CAL-QTR-NBR                                  03832200
038323               , :PV-CAL-YR-NBR                                   03832300
038324            FROM TAPCNTL A                                        03832400
038325               , TDTATTR B                                        03832500
038326           WHERE A.BTCH_PRC_DTE    = B.KY_DTE                     03832600
038327             AND A.BTCH_PRC_DTE    = B.FSCL_MN_END_DTE            03832700
038328     END-EXEC.                                                    03832800
038329                                                                  03832900
038330     EVALUATE TRUE                                                03833000
038340         WHEN SQLCODE = +0                                        03834000
038350              SET END-OF-FISCAL-MONTH             TO TRUE         03835000
038360              EVALUATE TRUE                                       03836000
038370                 WHEN DTATTR-FSCL-MN-NBR = '02'                   03837000
038380                      SET END-OF-CALENDAR-QTR     TO TRUE         03838000
038390                 WHEN DTATTR-FSCL-MN-NBR = '03'                   03839000
038400                      SET END-OF-FISCAL-QTR       TO TRUE         03840000
038500                 WHEN DTATTR-FSCL-MN-NBR = '05'                   03850000
038600                      SET END-OF-CALENDAR-QTR     TO TRUE         03860000
038700                      SET END-OF-CALENDAR-HALF TO TRUE            03870000
038800                 WHEN DTATTR-FSCL-MN-NBR = '06'                   03880000
038810                      SET END-OF-FISCAL-QTR       TO TRUE         03881000
038820                      SET END-OF-FISCAL-HALF      TO TRUE         03882000
038830                 WHEN DTATTR-FSCL-MN-NBR = '08'                   03883000
038840                      SET END-OF-CALENDAR-QTR     TO TRUE         03884000
038841                 WHEN DTATTR-FSCL-MN-NBR = '09'                   03884100
038842                      SET END-OF-FISCAL-QTR       TO TRUE         03884200
038843                 WHEN DTATTR-FSCL-MN-NBR = '11'                   03884300
038844                      SET END-OF-CALENDAR-QTR     TO TRUE         03884400
038845                      SET END-OF-CALENDAR-HALF    TO TRUE         03884500
038846                      SET END-OF-CALENDAR-YEAR    TO TRUE         03884600
038847                 WHEN DTATTR-FSCL-MN-NBR = '12'                   03884700
038848                      SET END-OF-FISCAL-QTR       TO TRUE         03884800
038849                      SET END-OF-FISCAL-HALF      TO TRUE         03884900
038850                      SET END-OF-FISCAL-YEAR      TO TRUE         03885000
038860              END-EVALUATE                                        03886000
038870         WHEN SQLWARN0 NOT = SPACES                               03887000
038880         WHEN SQLCODE < +0                                        03888000
038890         WHEN SQLCODE > +0                                        03889000
038900              MOVE 'S400-SELECT-DATES' TO WS-ABEND-PARAGRAPH      03890000
039000              MOVE 'UNSUCCESSFUL SELECT DATES'                    03900000
039100                                       TO WS-ABEND-OPERATION      03910000
039200              MOVE 'TAPCNTL '          TO WS-ABEND-STRUCTURE-1    03920000
039300              MOVE 'TDTATTR '          TO WS-ABEND-STRUCTURE-2    03930000
039400              PERFORM Z999-SQL-ERROR                              03940000
039500     END-EVALUATE.                                                03950000
039600                                                                  03960000
039700     EXEC SQL                                                     03970000
039800          SELECT MAX(FSCL_MN_END_DTE) + 2 DAYS                    03980000
039900               , MAX(PFM_END_DTE) + 2 DAYS                        03990000
040000            INTO :PV-FSCL-HALF-DUE-DTE                            04000000
040100               , :PV-CAL-HALF-DUE-DTE                             04010000
040110            FROM TDTATTR                                          04011000
040120           WHERE FSCL_YR_NBR = :DTATTR-FSCL-YR-NBR                04012000
040130             AND SEA_DESC = :DTATTR-SEA-DESC                      04013000
040131     END-EXEC.                                                    04013100
040132                                                                  04013200
040133     EVALUATE TRUE                                                04013300
040134         WHEN SQLCODE = +0                                        04013400
040135              CONTINUE                                            04013500
040136         WHEN SQLWARN0 NOT = SPACES                               04013600
040137         WHEN SQLCODE < +0                                        04013700
040138         WHEN SQLCODE > +0                                        04013800
040139              MOVE 'S400-SELECT-DATES' TO WS-ABEND-PARAGRAPH      04013900
040140              MOVE 'UNSUCCESSFUL DUE DATE SELECT'                 04014000
040141                                       TO WS-ABEND-OPERATION      04014100
040142              MOVE 'TDTATTR '          TO WS-ABEND-STRUCTURE-1    04014200
040143              MOVE SPACE               TO WS-ABEND-STRUCTURE-2    04014300
040144              PERFORM Z999-SQL-ERROR                              04014400
040145     END-EVALUATE.                                                04014500
040146                                                                  04014600
040147     EXEC SQL                                                     04014700
040148          SELECT MAX(FSCL_MN_END_DTE) + 2 DAYS                    04014800
040149               , MAX(PFM_END_DTE) + 2 DAYS                        04014900
040150            INTO :PV-FSCL-YEAR-DUE-DTE                            04015000
040151               , :PV-CAL-YEAR-DUE-DTE                             04015100
040152            FROM TDTATTR                                          04015200
040153           WHERE FSCL_YR_NBR = :DTATTR-FSCL-YR-NBR                04015300
040154     END-EXEC.                                                    04015400
040155                                                                  04015500
040156     EVALUATE TRUE                                                04015600
040157         WHEN SQLCODE = +0                                        04015700
040158              CONTINUE                                            04015800
040159         WHEN SQLWARN0 NOT = SPACES                               04015900
040160         WHEN SQLCODE < +0                                        04016000
040161         WHEN SQLCODE > +0                                        04016100
040162              MOVE 'S400-SELECT-DATES' TO WS-ABEND-PARAGRAPH      04016200
040163              MOVE 'YEARLY DUE DATE SELECT'                       04016300
040164                                       TO WS-ABEND-OPERATION      04016400
040165              MOVE 'TDTATTR '          TO WS-ABEND-STRUCTURE-1    04016500
040166              MOVE SPACE               TO WS-ABEND-STRUCTURE-2    04016600
040167              PERFORM Z999-SQL-ERROR                              04016700
040168     END-EVALUATE.                                                04016800
040169*----------------------------------------------------------------*04016900
040170*  S500-SET-CURENT-TMST  GETS THE CURRENT TIMESTAMP FROM DB2.    *04017000
040180*----------------------------------------------------------------*04018000
040190                                                                  04019000
040200 S500-SET-CURRENT-TMST.                                           04020000
040300                                                                  04030000
040400                                                                  04040000
040500     EXEC SQL                                                     04050000
040600          SET :PV-CURR-TMST = CURRENT TIMESTAMP                   04060000
040700     END-EXEC.                                                    04070000
040800                                                                  04080000
040900     EVALUATE TRUE                                                04090000
041000         WHEN SQLCODE = +0                                        04100000
041100              CONTINUE                                            04110000
041200         WHEN SQLWARN0 NOT = SPACES                               04120000
041300         WHEN SQLCODE < +0                                        04130000
041400         WHEN SQLCODE > +0                                        04140000
041500              MOVE 'S500-SET-CURRENT-TMST' TO WS-ABEND-PARAGRAPH  04150000
041600              MOVE 'UNSUCCESSFUL SET TMST' TO WS-ABEND-OPERATION  04160000
041700              MOVE SPACES TO WS-ABEND-STRUCTURE-1                 04170000
041800                             WS-ABEND-STRUCTURE-2                 04180000
041900              PERFORM Z999-SQL-ERROR                              04190000
042000     END-EVALUATE.                                                04200000
042100                                                                  04210000
042200*----------------------------------------------------------------*04220000
042300*  W200-WRITE-OUTPUT-JRNL-REC                                    *04230000
042400*  WRITES TO THE JOURNALIZED OUTPUT FILE.                        *04240000
042500*----------------------------------------------------------------*04250000
042600                                                                  04260000
042700 W200-WRITE-OUTPUT-JRNL-REC.                                      04270000
042800                                                                  04280000
042900     WRITE ADJUST-JRNL-RECORD FROM AP045-TRANSACTION-FILE.        04290000
043000                                                                  04300000
043100     ADD 1 TO OUT-ADJUSTMENT-COUNT.                               04310000
043200                                                                  04320000
043300*----------------------------------------------------------------*04330000
043400*  OPEN TRANCODE CURSOR.                                         *04340000
043500*----------------------------------------------------------------*04350000
043600 X100-OPEN-TRANCODE-CSR.                                          04360000
043700                                                                  04370000
043800     EXEC SQL                                                     04380000
043900         OPEN TRANCODE_CSR                                        04390000
044000     END-EXEC.                                                    04400000
044100                                                                  04410000
044200     EVALUATE TRUE                                                04420000
044300         WHEN SQLCODE = ZERO                                      04430000
044400              CONTINUE                                            04440000
044500         WHEN SQLWARN0 NOT = SPACES                               04450000
044600         WHEN SQLCODE  NOT = ZERO                                 04460000
044700              MOVE 'X100-OPEN-TRANCODE-CSR' TO WS-ABEND-PARAGRAPH 04470000
044800              MOVE 'UNSUCCESSFUL OPEN ON TRANCODE_CSR'            04480000
044900                                       TO WS-ABEND-OPERATION      04490000
045000              MOVE 'TTRNCDE '          TO WS-ABEND-STRUCTURE-1    04500000
045100              MOVE SPACE               TO WS-ABEND-STRUCTURE-2    04510000
045200              PERFORM Z999-SQL-ERROR                              04520000
045300     END-EVALUATE.                                                04530000
045400                                                                  04540000
045500*----------------------------------------------------------------*04550000
045600*  CLOSE TRANCODE CURSOR.                                        *04560000
045700*----------------------------------------------------------------*04570000
045800 X200-CLOSE-TRANCODE-CSR.                                         04580000
045900                                                                  04590000
046000     EXEC SQL                                                     04600000
046100         CLOSE TRANCODE_CSR                                       04610000
046200     END-EXEC.                                                    04620000
046300                                                                  04630000
046400     EVALUATE TRUE                                                04640000
046500         WHEN SQLCODE = ZERO                                      04650000
046600              CONTINUE                                            04660000
046700         WHEN SQLWARN0 NOT = SPACES                               04670000
046800         WHEN SQLCODE  NOT = ZERO                                 04680000
046900              MOVE 'X200-CLOSE-TRANCODE-CSR' TO WS-ABEND-PARAGRAPH04690000
047000              MOVE 'UNSUCCESSFUL CLOSE ON TRANCODE_CSR'           04700000
047100                                       TO WS-ABEND-OPERATION      04710000
047200              MOVE 'TTRNCDE '          TO WS-ABEND-STRUCTURE-1    04720000
047300              MOVE SPACE               TO WS-ABEND-STRUCTURE-2    04730000
047400              PERFORM Z999-SQL-ERROR                              04740000
047500     END-EVALUATE.                                                04750000
047600                                                                  04760000
047700*----------------------------------------------------------------*04770000
047800*  GENERAL ABEND ROUTINE                                         *04780000
047900*----------------------------------------------------------------*04790000
048000 Z998-ABEND.                                                      04800000
048100                                                                  04810000
048200     DISPLAY WS-ABEND-LITERAL.                                    04820000
048300     DISPLAY WS-ABEND-PROGRAM-MSG.                                04830000
048400     DISPLAY WS-ABEND-PARAGRAPH-MSG.                              04840000
048500     DISPLAY WS-MESSAGE-LINE-1.                                   04850000
048600     DISPLAY WS-MESSAGE-LINE-2.                                   04860000
048700                                                                  04870000
048800     CALL 'ILBOABN0' USING ABEND-CODE.                            04880000
048900                                                                  04890000
049000*----------------------------------------------------------------*04900000
049100*  PROCESS DB2 ABENDS.                                           *04910000
049200*----------------------------------------------------------------*04920000
049300 Z999-SQL-ERROR.                                                  04930000
049400                                                                  04940000
049500     DISPLAY '*** DB2 ERROR '.                                    04950000
049600     DISPLAY WS-ABEND-PROGRAM-MSG.                                04960000
049700     DISPLAY WS-ABEND-PARAGRAPH-MSG.                              04970000
049800     DISPLAY WS-ABEND-OPERATION-MSG.                              04980000
049900     DISPLAY WS-ABEND-TABLE1-MSG.                                 04990000
050000     IF WS-ABEND-STRUCTURE-2 > SPACES                             05000000
050100         DISPLAY WS-ABEND-TABLE2-MSG.                             05010000
050200                                                                  05020000
050300     SET AP-DB2-ERROR              TO TRUE.                       05030000
050400                                                                  05040000
050500     COPY DPPD004.                                                05050000
050600     CALL 'ILBOABN0' USING ABEND-CODE.                            05060000
