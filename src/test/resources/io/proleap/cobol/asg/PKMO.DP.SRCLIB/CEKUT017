000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.    CEKUT017.                                         00020000
000300 AUTHOR.        TKMA479.                                          00030000
000400 DATE-WRITTEN.  03/00.                                            00040000
000500****************************************************************  00050000
000600*  IMPORTANT IMPORTANT                                            00060000
000700*                                                                 00070000
000800*  WHEN THE SYSTEM GOES LIVE THIS CURSOR MUST ALSO INCLUDE        00080000
000900* CANCELED STOCK ORDERS                                           00090000
001000*        STOCK-PULL-CSR CURSOR                                    00100000
001100*                                                                 00110000
001200*  IMPORTANT IMPORTANT                                            00120000
001300*                                                                 00130000
001400****************************************************************  00140000
001500* THIS PROGRAM WILL EXTRACT DATA FROM THE CENTRAL STOCK PULL      00150000
001600* TABLES WHICH WILL THEN BE DOWNLOADED INTO THE RETEK RDM         00160000
001700* APPLICATION                                                     00170000
001800****************************************************************  00180000
001810************************************************************      00181000
001811******************************************************************00181100
001812*  CHANGE LOG                                                     00181200
001813*  DATE       CHANGED BY    DESC                                  00181300
001814*  ---------- ------------- --------------------------------------00181400
001815*  03/24/2010 MICHAEL J. WATTS                                    00181500
001816*                           MADE CHANGES FOR EFC2 PROJECT         00181600
001817*                           (WR38216)                             00181700
001818*                           ADDED TABLE AND LOGIC FOR             00181800
001819*                           FOR WST_EFC2_SKU_FFLMT (SKU HUB)      00181900
001820*                           MODIFIED TO ACCESS                    00182000
001821*                           WST_EFC2_DEPT_ALLOC INSTEAD OF        00182100
001822*                           WST_EFC2_SKU_FFLMT (SKU HUB)          00182200
001823*                                                                 00182300
001824*  05/20/2010 BRUCE GRAHAM - KFORCE                               00182400
001825*                           WAREHOUSE TRANSFERS EFC2 PROJECT      00182500
001826*                           (WR38216)                             00182600
001827*                           PROGRAM CHANGES CAN BE FOUND BY       00182700
001828*                           DOING A SEARCH ON X38216 IN COLS      00182800
001829*                           1 THRU 6.                             00182900
001830*                           ALSO INCLUDEDS THE COMMENTING OUT     00183000
001840*                           OF ACCESS TO DEPT HUB PUT INTO        00184000
001850*                           PRODUCTION PREVIOUSLY.                00185000
001860*                                                                 00186000
001861*  09/05/2011 CHRSITINE TWIEHAUS 38972 MLOF                       00186100
001862*                           REMOVE COPYBOOK WST00014              00186200
001863*                                                                 00186300
001864*  05/20/2020 JEAN KURK                                           00186400
001865*                           RENAME WMKUT009 TO CEKUT017           00186500
001866*                                                                 00186600
001867************************************************************      00186700
001868 ENVIRONMENT DIVISION.                                            00186800
001869 INPUT-OUTPUT SECTION.                                            00186900
001870                                                                  00187000
001871 FILE-CONTROL.                                                    00187100
001872     SELECT CE009-DOWNLOAD-FILE  ASSIGN TO UT-S-OUT01.            00187200
001873     SELECT CE021-DOWNLOAD-FILE  ASSIGN TO UT-S-OUT02.            00187300
001880                                                                  00188000
001890 DATA DIVISION.                                                   00189000
001900                                                                  00190000
002000 FILE SECTION.                                                    00200000
002100                                                                  00210000
002200 FD  CE009-DOWNLOAD-FILE                                          00220000
002300     RECORDING MODE IS F                                          00230000
002400     LABEL RECORDS ARE STANDARD                                   00240000
002500     RECORD CONTAINS 1156                                         00250000
002600     BLOCK CONTAINS 0 RECORDS                                     00260000
002700     DATA RECORD IS CE009-DOWNLOAD-RECORD.                        00270000
002800 01  CE009-DOWNLOAD-RECORD          PIC X(1156).                  00280000
002900                                                                  00290000
003000 FD  CE021-DOWNLOAD-FILE                                          00300000
003100     RECORDING MODE IS F                                          00310000
003200     LABEL RECORDS ARE STANDARD                                   00320000
003300     RECORD CONTAINS 219                                          00330000
003400     BLOCK CONTAINS 0 RECORDS                                     00340000
003500     DATA RECORD IS CE021-DOWNLOAD-RECORD.                        00350000
003600 01  CE021-DOWNLOAD-RECORD          PIC X(219).                   00360000
003700                                                                  00370000
003800                                                                  00380000
003900 WORKING-STORAGE SECTION.                                         00390000
004000                                                                  00400000
004100 01  PV-ABEND-CODE                    PIC S9(04)   VALUE +0       00410000
004200                                                   COMP SYNC.     00420000
004300                                                                  00430000
004400 01  PS-PROGRAM-SWITCHES.                                         00440000
004500     05  PS-STOCK-PULL-SW             PIC X(1)   VALUE 'N'.       00450000
004600         88  PS-END-STOCK-PULL                   VALUE 'Y'.       00460000
004700         88  PS-NOT-END-STOCK-PULL               VALUE 'N'.       00470000
004800     05  PS-VALID-DC-SW               PIC X(1)   VALUE 'N'.       00480000
004900         88  PS-VALID-DC                         VALUE 'Y'.       00490000
005000         88  PS-NO-VALID-DC                      VALUE 'N'.       00500000
005100     05  PS-STOCK-ORDER-SW            PIC X(1)   VALUE 'N'.       00510000
005200         88  PS-END-STOCK-ORDER                  VALUE 'Y'.       00520000
005300         88  PS-NOT-END-STOCK-ORDER              VALUE 'N'.       00530000
005400     05  PS-RDM-LOCATION-SW           PIC X(1)   VALUE 'N'.       00540000
005500         88  PS-IS-RDM-LOCATION                  VALUE 'Y'.       00550000
005600         88  PS-ISNOT-RDM-LOCATION               VALUE 'N'.       00560000
005700* ADDED FOR (WR38216)                                             00570000
005800     05  PS-DEPT-ALLOC-SW             PIC X(1)   VALUE 'N'.       00580000
005900         88  PS-DEPT-ALLOC-YES                   VALUE 'Y'.       00590000
006000         88  PS-DEPT-ALLOC-NO                    VALUE 'N'.       00600000
006100                                                                  00610000
006200 01  PV-PROGRAM-VARIABLES.                                        00620000
006300     05  PV-RETRY-COUNT               PIC S9(04)  VALUE +0        00630000
006400                                                  COMP SYNC.      00640000
006410     05  PV-PARAGRAPH-NAME            PIC  X(30)  VALUE SPACES.   00641000
006420     05  PV-ERROR-MESSAGE-1           PIC  X(60)  VALUE SPACES.   00642000
006430     05  PV-ERROR-MESSAGE-2           PIC  X(60)  VALUE SPACES.   00643000
006440     05  PV-ERROR-MESSAGE-3           PIC  X(60)  VALUE SPACES.   00644000
006450     05  PV-SQLCODE                   PIC 9(9)  VALUE ZERO.       00645000
006460     05  PV-COUNT1                    PIC 9(7)  VALUE ZERO.       00646000
006470     05  PV-COUNT2                    PIC 9(7)  VALUE ZERO.       00647000
006480     05  PV-DETAIL-COUNT              PIC S9(7) COMP-3            00648000
006490                                                VALUE ZERO.       00649000
006500     05  PV-CNSTK-REQ-PL-NBR          PIC X(9)  VALUE ZEROES.     00650000
006600     05  PV-CEPLIT-PL-LNE-NBR         PIC X(4)  VALUE ZEROES.     00660000
006700     05  PV-ITM-NBR                   PIC 9(16) VALUE ZERO.       00670000
006800     05  PV-NBR                       PIC 9(3)  VALUE ZERO.       00680000
006900     05  PV-DC1-NMBR                  PIC S9(4) VALUE 0 COMP.     00690000
007000     05  PV-DISP-LOC-ID               PIC  9(4) VALUE 0.          00700000
007010     05  PV-DISP-MINUTES              PIC  Z,ZZ9  VALUE ZERO.     00701003
007100     05  PV-TMST                      PIC X(26)   VALUE SPACES.   00710000
007200     05  PV-PREV-CNSTK-LOC-ID         PIC S9(04) COMP VALUE ZERO. 00720000
007300     05  DK-LOCATION-NUMBER           PIC S9(04) COMP VALUE ZERO. 00730000
007310     05  PV-OFFSET-MINUTES            PIC S9(09) COMP VALUE ZERO. 00731002
007400     05  PV-STAT-CDE                  PIC X(01)   VALUE SPACES.   00740000
007500* ADDED FOR (WR38216)                                             00750000
007600     05  PV-PREV-SKU              PIC S9(08) COMP-3 VALUE ZEROES. 00760000
007700     05  PV-CURR-DATE             PIC X(10)        VALUE SPACES.  00770000
007800     05  PV-USED-LOC-ID           PIC S9(04) COMP   VALUE ZEROES. 00780000
007900     05  PV-DB2-COUNT                 PIC S9(09) COMP-3 VALUE +0. 00790000
008000                                                                  00800000
008100 01  PC-PROGRAM-CONSTANTS.                                        00810000
008200     05  PC-PROGRAM-NAME              PIC X(08)  VALUE 'CEKUT017'.00820000
008300     05  PC-MAX-RETRIES               PIC S9(04) VALUE +3         00830000
008400                                                 COMP SYNC.       00840000
008500* ADDED FOR (WR38216)                                             00850000
008600     05  PC-EFC1-LOC-ID            PIC S9(04) COMP   VALUE 873.   00860000
008700     05  PC-EFC2-LOC-ID            PIC S9(04) COMP   VALUE 809.   00870000
008800     05  PC-C                         PIC X(01) VALUE 'C'.        00880000
008900     05  PC-X                         PIC X(01) VALUE 'X'.        00890000
009000     05  PC-XF                        PIC X(02) VALUE 'XF'.       00900000
009100                                                                  00910000
009200 01  PV-ABEND-FIELDS.                                             00920000
009300     05  PV-ABEND-PROGRAM             PIC X(8)   VALUE 'CEKUT017'.00930000
009310     05  PV-ABEND-PARAGRAPH           PIC X(50)  VALUE SPACES.    00931000
009311     05  PV-ABEND-OPERATION           PIC X(50)  VALUE SPACES.    00931100
009312     05  PV-ABEND-STRUCTURE-1         PIC X(8)   VALUE SPACES.    00931200
009313     05  PV-ABEND-STRUCTURE-2         PIC X(8)   VALUE SPACES.    00931300
009314     05  PV-ABEND-STRUCTURE-3         PIC X(8)   VALUE SPACES.    00931400
009315     05  PV-ABEND-STATUS              PIC XX     VALUE SPACES.    00931500
009316     05  PV-DB2-OPERATION-MESSAGE-1   PIC  X(79) VALUE SPACES.    00931600
009317     05  PV-DB2-OPERATION-MESSAGE-2   PIC  X(79) VALUE SPACES.    00931700
009318     05  PV-DB2-OPERATION-MESSAGE-3   PIC  X(79) VALUE SPACES.    00931800
009319     05  PV-DB2-OPERATION-MESSAGE-4   PIC  X(79) VALUE SPACES.    00931900
009320                                                                  00932000
009330     05  PV-REFORMAT-TMST.                                        00933000
009340         10  PV-REFORMAT-TMST-DTE.                                00934000
009350             15  PV-REFORMAT-TMST-DTE-CY  PIC X(04)  VALUE SPACES.00935000
009360             15  PV-REFORMAT-TMST-DTE-MM  PIC X(02)  VALUE SPACES.00936000
009370             15  PV-REFORMAT-TMST-DTE-DD  PIC X(02)  VALUE SPACES.00937000
009380         10  PV-REFORMAT-TMST-TM.                                 00938000
009390             15  PV-REFORMAT-TMST-TM-HH   PIC X(02)  VALUE SPACES.00939000
009400             15  PV-REFORMAT-TMST-TM-MM   PIC X(02)  VALUE SPACES.00940000
009500/                                                                 00950000
009600     COPY CERD009.                                                00960000
009700     COPY CERD021.                                                00970000
009800/                                                                 00980000
009900******************************************************************00990000
010000* COPYBOOK FOR THE LOGISTICS DOMAIN LOCATION MODULE (XLKUT071).   01000000
010100******************************************************************01010000
010200     COPY XLWS071.                                                01020000
010300                                                                  01030000
010400******************************************************************01040000
010500*  USED FOR DB2 ERROR MESSAGE BUILDING                            01050000
010600******************************************************************01060000
010700     COPY DPWS004.                                                01070000
010800******************************************************************01080000
010900*   DB2 SQL COMMUNICATION AREA                                    01090000
011000******************************************************************01100000
011100     EXEC SQL                                                     01110000
011200          INCLUDE SQLCA                                           01120000
011300     END-EXEC.                                                    01130000
011400/                                                                 01140000
011500     EXEC SQL                                                     01150000
011600          INCLUDE TCEPLIT                                         01160000
011700     END-EXEC.                                                    01170000
011800/                                                                 01180000
011900     EXEC SQL                                                     01190000
012000          INCLUDE TCEPLRQ                                         01200000
012100     END-EXEC.                                                    01210000
012200/                                                                 01220000
012300     EXEC SQL                                                     01230000
012400          INCLUDE TKRPRPM                                         01240000
012500     END-EXEC.                                                    01250000
012600/                                                                 01260000
012700     EXEC SQL                                                     01270000
012800          INCLUDE TCEPLDS                                         01280000
012900     END-EXEC.                                                    01290000
013000/                                                                 01300000
013010     EXEC SQL                                                     01301002
013020          INCLUDE TCEPLST                                         01302002
013030     END-EXEC.                                                    01303002
013040/                                                                 01304002
013100***************************************************************** 01310000
013200*******   (XLT_SKU)                                               01320000
013300***************************************************************** 01330000
013400                                                                  01340000
013500     EXEC SQL                                                     01350000
013600          INCLUDE XLT00003                                        01360000
013700     END-EXEC.                                                    01370000
013800                                                                  01380000
013900***************************************************************** 01390000
014000*******   (XLT_VND_STYL)  (WR38216)                               01400000
014100***************************************************************** 01410000
014200                                                                  01420000
014300     EXEC SQL                                                     01430000
014400          INCLUDE XLT00004                                        01440000
014500     END-EXEC.                                                    01450000
014700******************************************************************01470000
014800* STOCK PULL CURSOR                                               01480000
014900******************************************************************01490000
015000     EXEC SQL                                                     01500000
015100          DECLARE STOCK-PULL-CSR CURSOR WITH HOLD FOR             01510000
015200           SELECT A.CNSTK_LOC_ID                                  01520000
015300                 ,A.SRC_TYP_CDE                                   01530000
015400                 ,B.CNSTK_REQ_PL_NBR                              01540000
015410                 ,B.PL_LNE_NBR                                    01541000
015420                 ,B.ITM_NBR                                       01542000
015430                 ,B.UNT_RTL_AMT                                   01543000
015440                 ,B.STAT_CDE                                      01544000
015450                 ,SKU.SKU_NBR                                     01545000
015460                 ,SKU.STYL_ID                                     01546000
015470            FROM TCEPLRQ A                                        01547002
015471               , TCEPLIT B                                        01547102
015480               , XLT_SKU SKU                                      01548002
015481               , TCEPLST C                                        01548102
015490               WHERE A.CNSTK_REQ_PL_NBR = B.CNSTK_REQ_PL_NBR      01549000
015500                 AND B.STAT_CDE IN ('NW', 'IP')                   01550000
015600                 AND B.DWNLD_RDM_STAT_CDE IN (' ', 'N', 'R')      01560000
015700                 AND SKU.ITM_NBR = B.ITM_NBR                      01570000
015710                 AND C.CNSTK_REQ_PL_NBR = B.CNSTK_REQ_PL_NBR      01571002
015720                 AND C.PL_LNE_NBR > 0                             01572002
015730                 AND C.STAT_CDE = 'NW'                            01573002
015740                 AND C.CRE_TMST =                                 01574002
015750                     (SELECT MAX(CC.CRE_TMST)                     01575002
015760                        FROM TCEPLST CC                           01576002
015770                       WHERE  CC.CNSTK_REQ_PL_NBR =               01577002
015771                               C.CNSTK_REQ_PL_NBR                 01577102
015780                         AND  CC.PL_LNE_NBR > 0                   01578002
015790                         AND  CC.STAT_CDE = 'NW')                 01579002
015795                 AND CURRENT TIMESTAMP >                          01579502
015796                     C.CRE_TMST + :PV-OFFSET-MINUTES MINUTES      01579604
015800       UNION                                                      01580000
015900           SELECT A.CNSTK_LOC_ID                                  01590000
016000                 ,A.SRC_TYP_CDE                                   01600000
016100                 ,B.CNSTK_REQ_PL_NBR                              01610000
016200                 ,B.PL_LNE_NBR                                    01620000
016300                 ,B.ITM_NBR                                       01630000
016400                 ,B.UNT_RTL_AMT                                   01640000
016500                 ,B.STAT_CDE                                      01650000
016600                 ,SKU.SKU_NBR                                     01660000
016700                 ,SKU.STYL_ID                                     01670000
016800           FROM  TCEPLRQ A, TCEPLIT B                             01680000
016900                 , XLT_SKU SKU                                    01690000
017000               WHERE A.CNSTK_REQ_PL_NBR = B.CNSTK_REQ_PL_NBR      01700000
017100                 AND B.STAT_CDE = 'CA'                            01710000
017200                 AND B.DWNLD_RDM_STAT_CDE IN ('X', 'R')           01720000
017300                 AND SKU.ITM_NBR = B.ITM_NBR                      01730000
017400           ORDER BY CNSTK_LOC_ID                                  01740000
017500                 WITH UR                                          01750000
017600     END-EXEC.                                                    01760000
017610******************************************************************01761000
017620* STOCK ORDER CURSOR                                              01762000
017630******************************************************************01763000
017640     EXEC SQL                                                     01764000
017650          DECLARE STOCK-ORDER-CSR CURSOR FOR                      01765000
017660           SELECT  REQ_ORD_QTY                                    01766000
017670                  ,STR_NBR                                        01767000
017680           FROM   TCEPLDS                                         01768000
017690           WHERE    CNSTK_REQ_PL_NBR = :CEPLIT-CNSTK-REQ-PL-NBR   01769000
017700                AND PL_LNE_NBR       = :CEPLIT-PL-LNE-NBR         01770000
017800                 WITH UR                                          01780000
017900     END-EXEC.                                                    01790000
018000/                                                                 01800000
018100 PROCEDURE DIVISION.                                              01810000
018200                                                                  01820000
018300     PERFORM 1000-INIT.                                           01830000
018400                                                                  01840000
018500     PERFORM 2000-PROCESS-DOWNLOAD.                               01850000
018600                                                                  01860000
018700     PERFORM 9000-TERMINATE.                                      01870000
018800                                                                  01880000
018900     GOBACK.                                                      01890000
019000                                                                  01900000
019100 1000-INIT.                                                       01910000
019200**ADDED PV-TMST(1:10) MOVE (WR38216)                              01920000
019300                                                                  01930000
019400     OPEN OUTPUT CE009-DOWNLOAD-FILE                              01940000
019500                 CE021-DOWNLOAD-FILE.                             01950000
019600                                                                  01960000
019700     PERFORM 8500-GET-TIMESTAMP.                                  01970000
019800     MOVE PV-TMST(1:10) TO PV-CURR-DATE.                          01980000
019801                                                                  01980102
019810     PERFORM 8600-GET-OFFSET-MINUTES.                             01981002
019820                                                                  01982002
019830     MOVE PV-OFFSET-MINUTES TO PV-DISP-MINUTES.                   01983002
019831     DISPLAY ' '.                                                 01983102
019840     DISPLAY ' CEPLDY OFFSET MINUTES PARM HAS A VALUE OF: '       01984002
019850             PV-DISP-MINUTES.                                     01985002
019860     DISPLAY ' '.                                                 01986002
019920                                                                  01992002
020000 2000-PROCESS-DOWNLOAD.                                           02000000
020100                                                                  02010000
020200     PERFORM 7000-OPEN-STOCK-PULL-CURSOR.                         02020000
020300     PERFORM 7100-FETCH-STOCK-PULL-CURSOR                         02030000
020400        UNTIL PS-END-STOCK-PULL.                                  02040000
020500     PERFORM 7200-CLOSE-STOCK-PULL-CURSOR.                        02050000
020600                                                                  02060000
020700 7000-OPEN-STOCK-PULL-CURSOR.                                     02070000
020800     PERFORM                                                      02080000
020900         WITH TEST AFTER                                          02090000
021000         VARYING PV-RETRY-COUNT                                   02100000
021100         FROM 1 BY 1                                              02110000
021200         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 02120000
021300            OR  (SQLCODE = +0))                                   02130000
021400                                                                  02140000
021500         EXEC SQL                                                 02150000
021600             OPEN STOCK-PULL-CSR                                  02160000
021700         END-EXEC                                                 02170000
021800                                                                  02180000
021900         EVALUATE TRUE                                            02190000
022000             WHEN SQLCODE = +0                                    02200000
022100             WHEN SQLCODE = -904                                  02210000
022200             WHEN SQLCODE = -911                                  02220000
022300             WHEN SQLCODE = -913                                  02230000
022400                  CONTINUE                                        02240000
022500             WHEN SQLWARN0 NOT = SPACE                            02250000
022600             WHEN SQLCODE  NOT = +0                               02260000
022700                  MOVE '7000-OPEN-STOCK-PULL-CURSOR'              02270000
022800                                 TO PV-ABEND-PARAGRAPH            02280000
022900                  MOVE 'OPEN STOCK-PULL'                          02290000
023000                                 TO PV-ABEND-OPERATION            02300000
023100                  MOVE 'TCEPLIT' TO PV-ABEND-STRUCTURE-1          02310000
023200                  MOVE 'TCEPLRQ' TO PV-ABEND-STRUCTURE-2          02320000
023300                  PERFORM 9900-DB2-ABEND                          02330000
023400         END-EVALUATE                                             02340000
023500     END-PERFORM.                                                 02350000
023600                                                                  02360000
023700     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          02370000
023800         MOVE '7000-OPEN-STOCK-PULL-CURSOR'                       02380000
023900                                 TO PV-ABEND-PARAGRAPH            02390000
024000         MOVE 'MAX RETRIES EXCEEDED'                              02400000
024100                                 TO PV-ABEND-OPERATION            02410000
024200         PERFORM 9900-DB2-ABEND                                   02420000
024300     END-IF.                                                      02430000
024400                                                                  02440000
024500 7100-FETCH-STOCK-PULL-CURSOR.                                    02450000
024600**ADDED LOGIC FOR DEPT HUB CHECK (WR38216)                        02460000
024700                                                                  02470000
024800     INITIALIZE DCLTCEPLIT                                        02480000
024900                DCLTCEPLRQ.                                       02490000
025000     EXEC SQL                                                     02500000
025100          FETCH STOCK-PULL-CSR                                    02510000
025200           INTO   :CEPLRQ-CNSTK-LOC-ID                            02520000
025300                 ,:CEPLRQ-SRC-TYP-CDE                             02530000
025400                 ,:CEPLIT-CNSTK-REQ-PL-NBR                        02540000
025500                 ,:CEPLIT-PL-LNE-NBR                              02550000
025600                 ,:CEPLIT-ITM-NBR                                 02560000
025700                 ,:CEPLIT-UNT-RTL-AMT                             02570000
025800                 ,:CEPLIT-STAT-CDE                                02580000
025900                 ,:XLT00003-SKU-NBR                               02590000
026000                 ,:XLT00003-STYL-ID                               02600000
026100     END-EXEC.                                                    02610000
026200                                                                  02620000
026300     EVALUATE TRUE                                                02630000
026400         WHEN SQLCODE = +0                                        02640000
026500              CONTINUE                                            02650000
026600         WHEN SQLCODE = +100                                      02660000
026700              SET PS-END-STOCK-PULL TO TRUE                       02670000
026800         WHEN SQLWARN0 NOT = SPACE                                02680000
026900         WHEN SQLCODE  NOT = +0                                   02690000
027000              MOVE '7100-FETCH-STOCK-PULL-CURSOR'                 02700000
027100                                   TO PV-ABEND-PARAGRAPH          02710000
027200              MOVE 'FETCH STOCK-PULL CURSOR'                      02720000
027300                                   TO PV-ABEND-OPERATION          02730000
027400              MOVE 'TCEPLIT'       TO PV-ABEND-STRUCTURE-1        02740000
027500              MOVE 'TCEPLRQ'       TO PV-ABEND-STRUCTURE-2        02750000
027600              PERFORM 9900-DB2-ABEND                              02760000
027700     END-EVALUATE.                                                02770000
027800                                                                  02780000
027900     IF PS-END-STOCK-PULL                                         02790000
028000        CONTINUE                                                  02800000
028100     ELSE                                                         02810000
028200         PERFORM 7110-VERIFY-CS-LOCATION                          02820000
028300         IF PS-VALID-DC AND                                       02830000
028400            PS-IS-RDM-LOCATION                                    02840000
028500             INITIALIZE DCLTCEPLDS                                02850000
028600             SET PS-NOT-END-STOCK-ORDER TO TRUE                   02860000
028700*            IF CEPLRQ-SRC-TYP-CDE NOT = PC-XF                    02870000
028800*                IF CEPLRQ-CNSTK-LOC-ID = PC-EFC1-LOC-ID          02880000
028900*                   PERFORM 7450-LOOKUP-DEPT                      02890000
029000*                   PERFORM 7400-CHECK-DEPT-HUB                   02900000
029100*                ELSE                                             02910000
029200*                   MOVE CEPLRQ-CNSTK-LOC-ID TO PV-USED-LOC-ID    02920000
029300*                END-IF                                           02930000
029400*            ELSE                                                 02940000
029500                 MOVE CEPLRQ-CNSTK-LOC-ID TO PV-USED-LOC-ID       02950000
029600*            END-IF                                               02960000
029700                                                                  02970000
029800             PERFORM 8000-OPEN-STOCK-ORDER-CURSOR                 02980000
029900             PERFORM 8100-FETCH-STOCK-ORDER-CURSOR                02990000
030000                     UNTIL PS-END-STOCK-ORDER                     03000000
030100             PERFORM 8200-CLOSE-STOCK-ORDER-CURSOR                03010000
030200                                                                  03020000
030300             IF PV-DETAIL-COUNT > ZERO                            03030000
030400                        OR CEPLIT-STAT-CDE = 'CA'                 03040000
030500                 INITIALIZE CE009-SOHDR-DOWNLOAD-REC              03050000
030600                 PERFORM 7300-WRITE-HEADER-RECORD                 03060000
030700                 MOVE ZERO            TO PV-DETAIL-COUNT          03070000
030710                 IF CEPLIT-STAT-CDE = 'CA'                        03071000
030711                     MOVE SPACE       TO PV-STAT-CDE              03071100
030712                 ELSE                                             03071200
030713                     MOVE 'X'         TO PV-STAT-CDE              03071300
030714                 END-IF                                           03071400
030715                 PERFORM 7700-UPDATE-TCEPLIT                      03071500
030716         END-IF                                                   03071600
030717     END-IF.                                                      03071700
030718                                                                  03071800
030719 7110-VERIFY-CS-LOCATION.                                         03071900
030720     IF CEPLRQ-CNSTK-LOC-ID = PV-PREV-CNSTK-LOC-ID                03072000
030730         CONTINUE                                                 03073000
030740     ELSE                                                         03074000
030750         MOVE CEPLRQ-CNSTK-LOC-ID     TO PV-PREV-CNSTK-LOC-ID     03075000
030760         PERFORM 7130-CALL-XLKUT071                               03076000
030770         IF PS-VALID-DC                                           03077000
030780             PERFORM 7120-SELECT-TKRPRPM                          03078000
030790         END-IF                                                   03079000
030800     END-IF.                                                      03080000
030900                                                                  03090000
031000 7120-SELECT-TKRPRPM.                                             03100000
031100                                                                  03110000
031200     INITIALIZE DCLTKRPRPM.                                       03120000
031300                                                                  03130000
031400     PERFORM                                                      03140000
031500         WITH TEST AFTER                                          03150000
031600         VARYING PV-RETRY-COUNT                                   03160000
031700         FROM 1 BY 1                                              03170000
031800         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 03180000
031900            OR  (SQLCODE = +0 OR SQLCODE = +100))                 03190000
032000                                                                  03200000
032100         EXEC SQL                                                 03210000
032200             SELECT LOC_ID                                        03220000
032300             INTO :KRPRPM-LOC-ID                                  03230000
032400             FROM TKRPRPM                                         03240000
032500         WHERE                                                    03250000
032600             LOC_ID = :DK-LOCATION-NUMBER                         03260000
032700         AND INTFC_SYS_CDE = 'RDM'                                03270000
032800         AND FUNC_PRC_STAT_CDE = 'AC'                             03280000
032900         AND FUNC_TXT = 'Y'                                       03290000
033000         AND SYS_PRC_FUNC_CDE = 'RDMFAC'                          03300000
033100         AND (CURRENT DATE                                        03310000
033200         BETWEEN DATE(FUNC_BEG_TMST) AND DATE(FUNC_END_TMST) )    03320000
033300         END-EXEC                                                 03330000
033400                                                                  03340000
033500         EVALUATE TRUE                                            03350000
033600             WHEN SQLCODE = +0                                    03360000
033700                 SET PS-IS-RDM-LOCATION                           03370000
033800                                      TO TRUE                     03380000
033900             WHEN SQLCODE = +100                                  03390000
034000                 SET PS-ISNOT-RDM-LOCATION                        03400000
034100                                      TO TRUE                     03410000
034200             WHEN SQLCODE = -904                                  03420000
034300             WHEN SQLCODE = -911                                  03430000
034400             WHEN SQLCODE = -913                                  03440000
034500                  CONTINUE                                        03450000
034600             WHEN SQLWARN0 NOT = SPACE                            03460000
034700             WHEN SQLCODE  NOT = +0                               03470000
034800                  MOVE '7120-SELECT-TKRPRPM'                      03480000
034900                                 TO PV-ABEND-PARAGRAPH            03490000
035000                  MOVE 'SELECT TKRPRPM - DC NUM'                  03500000
035100                                 TO PV-ABEND-OPERATION            03510000
035200                  MOVE 'TKRPRPM'   TO PV-ABEND-STRUCTURE-1        03520000
035300                  PERFORM 9900-DB2-ABEND                          03530000
035400         END-EVALUATE                                             03540000
035500     END-PERFORM.                                                 03550000
035600                                                                  03560000
035700     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          03570000
035800            AND NOT (SQLCODE = +0 OR SQLCODE = +100)              03580000
035900         MOVE '7120-SELECT-TKRPRPM'                               03590000
036000                                 TO PV-ABEND-PARAGRAPH            03600000
036100         MOVE 'MAX RETRIES EXCEEDED'                              03610000
036200                                 TO PV-ABEND-OPERATION            03620000
036300         PERFORM 9900-DB2-ABEND                                   03630000
036400     END-IF.                                                      03640000
036500/                                                                 03650000
036600 7130-CALL-XLKUT071.                                              03660000
036700     INITIALIZE XL071-COMMAREA-REC.                               03670000
036800     MOVE CEPLRQ-CNSTK-LOC-ID  TO XL071-LOCATION-NUMBER.          03680000
036900     CALL XL071-LOCATION-MODULE USING XL071-COMMAREA-REC          03690000
037000                                                                  03700000
037100     EVALUATE TRUE                                                03710000
037200         WHEN XL071-NO-ERRORS                                     03720000
037300             IF XL071-ASGMT-EFF-STP-DTE = '9999-09-09' AND        03730000
037400                XL071-ASGMT-PO-STP-DTE = '9999-09-09'             03740000
037500                 MOVE XL071-ASGMT-DC-NBR  TO PV-DC1-NMBR          03750000
037600                 MOVE XL071-ASGMT-DC-NBR  TO DK-LOCATION-NUMBER   03760000
037700                 SET PS-VALID-DC     TO TRUE                      03770000
037800             ELSE                                                 03780000
037900                 SET PS-NO-VALID-DC   TO TRUE                     03790000
038000             END-IF                                               03800000
038100         WHEN XL071-LOC-NOT-FOUND                                 03810000
038200             MOVE '7130-CALL-XLKUT071' TO PV-PARAGRAPH-NAME       03820000
038300             MOVE 'NOT FOUND'          TO PV-ERROR-MESSAGE-1      03830000
038400             MOVE CEPLRQ-CNSTK-LOC-ID  TO PV-DISP-LOC-ID          03840000
038500             MOVE PV-DISP-LOC-ID       TO PV-ERROR-MESSAGE-2      03850000
038600             PERFORM 9200-ABEND                                   03860000
038700         WHEN XL071-BAD-DB2-RETURN                                03870000
038800             MOVE '7130-CALL-XLKUT071' TO PV-PARAGRAPH-NAME       03880000
038900             MOVE 'BAD DB2 RETURN'     TO PV-ERROR-MESSAGE-1      03890000
039000             MOVE CEPLRQ-CNSTK-LOC-ID  TO PV-DISP-LOC-ID          03900000
039100             MOVE PV-DISP-LOC-ID       TO PV-ERROR-MESSAGE-2      03910000
039200             MOVE XL071-SQLCODE        TO PV-ERROR-MESSAGE-3      03920000
039300             PERFORM 9200-ABEND                                   03930000
039400     END-EVALUATE.                                                03940000
039500 7200-CLOSE-STOCK-PULL-CURSOR.                                    03950000
039600                                                                  03960000
039700     PERFORM                                                      03970000
039800         WITH TEST AFTER                                          03980000
039900         VARYING PV-RETRY-COUNT                                   03990000
040000         FROM 1 BY 1                                              04000000
040100         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 04010000
040200            OR  (SQLCODE = +0))                                   04020000
040300                                                                  04030000
040400            EXEC SQL                                              04040000
040500                CLOSE STOCK-PULL-CSR                              04050000
040600            END-EXEC                                              04060000
040700                                                                  04070000
040800            EVALUATE TRUE                                         04080000
040900                WHEN SQLCODE = 0                                  04090000
041000                    CONTINUE                                      04100000
041100                WHEN SQLCODE = -911                               04110000
041200                WHEN SQLCODE = -913                               04120000
041300                WHEN SQLCODE = -904                               04130000
041400                    CONTINUE                                      04140000
041500                WHEN SQLCODE  NOT = +0                            04150000
041600                     MOVE '7200-CLOSE-STOCK-PULL-CURSOR'          04160000
041700                                  TO PV-ABEND-PARAGRAPH           04170000
041800                     MOVE 'CLOSE STOCK-PULL'                      04180000
041900                                  TO PV-ABEND-OPERATION           04190000
042000                     MOVE 'TCEPLIT'   TO PV-ABEND-STRUCTURE-1     04200000
042100                     MOVE 'TCEPLRQ'   TO PV-ABEND-STRUCTURE-2     04210000
042200                     PERFORM 9900-DB2-ABEND                       04220000
042300            END-EVALUATE                                          04230000
042400                                                                  04240000
042500     END-PERFORM.                                                 04250000
042600                                                                  04260000
042700     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          04270000
042800         MOVE '7200-CLOSE-STOCK-PULL-CURSOR'                      04280000
042900                                 TO PV-ABEND-PARAGRAPH            04290000
043000         MOVE 'MAX RETRIES EXCEEDED'                              04300000
043100                                 TO PV-ABEND-OPERATION            04310000
043200         PERFORM 9900-DB2-ABEND                                   04320000
043300     END-IF.                                                      04330000
043400                                                                  04340000
043500 7300-WRITE-HEADER-RECORD.                                        04350000
043600**CHANGED TO USE PV-USED-LOC-ID FOR LOCATION (WR38216)            04360000
043700*                                                                 04370000
043800     IF CEPLIT-STAT-CDE = 'NW' OR 'IP'                            04380000
043900        MOVE 'A'                   TO CE009-ACTION-TYPE           04390000
044000     END-IF.                                                      04400000
044100     IF CEPLIT-STAT-CDE = 'CA'                                    04410000
044200        MOVE 'M'                   TO CE009-ACTION-TYPE           04420000
044300        MOVE 20000102              TO CE009-PICK-NOT-AFT-DATE     04430000
044400     END-IF.                                                      04440000
044500*****MOVE CEPLRQ-CNSTK-LOC-ID      TO CE009-LOCATION.             04450000
044600     MOVE PV-REFORMAT-TMST         TO CE009-TRANS-DATE-TIME.      04460000
044700     MOVE CEPLIT-CNSTK-REQ-PL-NBR   TO PV-CNSTK-REQ-PL-NBR.       04470000
044800     MOVE CEPLIT-PL-LNE-NBR         TO PV-CEPLIT-PL-LNE-NBR.      04480000
044900                                                                  04490000
045000     IF  XL071-E-BUS-IND = 'Y'                                    04500000
045100         IF  XL071-LOC-TYP-CDE = 'DS'                             04510000
045200         OR  XL071-LOC-TYP-CDE = 'CS'                             04520000
045300             MOVE PV-CNSTK-REQ-PL-NBR(5:5)                        04530000
045310                                   TO CE009-DISTRO-NUMBER(2:5)    04531000
045320             MOVE PV-CEPLIT-PL-LNE-NBR(2:3)                       04532000
045321                                   TO CE009-DISTRO-NUMBER(7:3)    04532100
045322             IF  CEPLRQ-SRC-TYP-CDE = PC-XF                       04532200
045323                 MOVE PC-X         TO CE009-DISTRO-NUMBER(1:1)    04532300
045324             ELSE                                                 04532400
045325                 MOVE PC-C         TO CE009-DISTRO-NUMBER(1:1)    04532500
045326             END-IF                                               04532600
045327         ELSE                                                     04532700
045328             MOVE PV-CNSTK-REQ-PL-NBR(5:5)                        04532800
045329                                   TO CE009-DISTRO-NUMBER(1:5)    04532900
045330             MOVE PV-CEPLIT-PL-LNE-NBR                            04533000
045340                                   TO CE009-DISTRO-NUMBER(6:4)    04534000
045350         END-IF                                                   04535000
045360     ELSE                                                         04536000
045370         MOVE PV-CNSTK-REQ-PL-NBR(5:5)                            04537000
045380                                   TO CE009-DISTRO-NUMBER(1:5)    04538000
045390         MOVE PV-CEPLIT-PL-LNE-NBR TO CE009-DISTRO-NUMBER(6:4)    04539000
045400     END-IF.                                                      04540000
045500                                                                  04550000
045600     MOVE 100                      TO CE009-PRIORITY.             04560000
045700     MOVE 'MANUAL'                 TO CE009-ORDER-TYPE.           04570000
045800     MOVE 'N'                      TO CE009-BREAK-BY-DISTRO.      04580000
045900     MOVE 20000101                 TO CE009-PICK-NOT-B4-DATE.     04590000
046000     MOVE 20491231                 TO CE009-PICK-NOT-AFT-DATE.    04600000
046100     MOVE 'KOHL'                   TO CE009-CARRIER-CODE          04610000
046200     MOVE 'ALL   '                 TO CE009-CARRIER-SERV-CODE     04620000
046300     MOVE 'ALL'                    TO CE009-ROUTE                 04630000
046400     ADD 1                         TO PV-COUNT1.                  04640000
046500***  WRITE CE009-DOWNLOAD-RECORD FROM                             04650000
046600***     CE009-SOHDR-DOWNLOAD-REC.                                 04660000
046700                                                                  04670000
046800     MOVE PV-USED-LOC-ID TO CE009-LOCATION.                       04680000
046900     WRITE CE009-DOWNLOAD-RECORD FROM CE009-SOHDR-DOWNLOAD-REC.   04690000
047000                                                                  04700000
047100                                                                  04710000
047200*7400-CHECK-DEPT-HUB.                                             04720000
047300****************************************************************  04730000
047400***  CHECK IF THE DEPT ALLOC IND ASSOCIATED WITH THE SKU          04740000
047500***  IS YES, IF IT IS MOVE EFC2 VALUE                             04750000
047600***  TO HOLD FIELD, ELSE MOVE INPUT LOCATION TO HOLD FIELD        04760000
047700***ADDED FOR (WR38216)                                            04770000
047800****************************************************************  04780000
047900*                                                                 04790000
048000*    PERFORM 7420-SELECT-FROM-HUB.                                04800000
048100*                                                                 04810000
048200*    EVALUATE TRUE                                                04820000
048300*        WHEN PS-DEPT-ALLOC-YES                                   04830000
048400*             MOVE PC-EFC2-LOC-ID TO PV-USED-LOC-ID               04840000
048500*        WHEN PS-DEPT-ALLOC-NO                                    04850000
048600*             MOVE CEPLRQ-CNSTK-LOC-ID TO PV-USED-LOC-ID          04860000
048700*    END-EVALUATE.                                                04870000
048800*                                                                 04880000
048900*7420-SELECT-FROM-HUB.                                            04890000
049000****************************************************************  04900000
049100***  READ THE DEPT HUB TABLE USING DEPT FROM XLT00004             04910000
049200***ADDED FOR (WR38216)                                            04920000
049300****************************************************************  04930000
049400*    EXEC SQL                                                     04940000
049500*        SELECT 1                                                 04950000
049600*            INTO :PV-DB2-COUNT                                   04960000
049700*        FROM WST_EFC2_DEPT_ALLOC                                 04970000
049800*            WHERE DEPT_NBR = :XLT00004-DEPT-NBR                  04980000
049900*              AND EFC2_ALLOC_IND = 'Y'                           04990000
050000*              AND EFC2_ALLOC_DTE  <= :PV-CURR-DATE               05000000
050100*    END-EXEC.                                                    05010000
050110*                                                                 05011000
050120*    EVALUATE TRUE                                                05012000
050130*       WHEN SQLCODE = ZERO                                       05013000
050140*          SET PS-DEPT-ALLOC-YES TO TRUE                          05014000
050150*       WHEN SQLCODE = +100                                       05015000
050160*          SET PS-DEPT-ALLOC-NO  TO TRUE                          05016000
050170*       WHEN OTHER                                                05017000
050180*          MOVE '7420-SELECT-FROM-HUB' TO PV-ABEND-PARAGRAPH      05018000
050181*          MOVE 'SELECT EFC2' TO PV-ABEND-OPERATION               05018100
050182*          PERFORM 9900-DB2-ABEND                                 05018200
050183*    END-EVALUATE.                                                05018300
050184*                                                                 05018400
050185***************************************************************   05018500
050186****ACCESS XLT_VND_STYL TABLE TO LOOK UP THE DEPARTMENT           05018600
050187****NUMBER ASSOCIATED WITH A SKU  (W38216)                        05018700
050188***************************************************************   05018800
050189*                                                                 05018900
050190*7450-LOOKUP-DEPT.                                                05019000
050191*                                                                 05019100
050192*    EXEC SQL                                                     05019200
050193*        SELECT STYL_ID                                           05019300
050194*              ,DEPT_NBR                                          05019400
050195*                   INTO :XLT00004-STYL-ID                        05019500
050196*                       ,:XLT00004-DEPT-NBR                       05019600
050197*        FROM XLT_VND_STYL                                        05019700
050198*            WHERE STYL_ID = :XLT00003-STYL-ID                    05019800
050199*    WITH UR                                                      05019900
050200*    END-EXEC.                                                    05020000
050201*                                                                 05020100
050202*    EVALUATE TRUE                                                05020200
050203*        WHEN SQLCODE = 0                                         05020300
050204*            CONTINUE                                             05020400
050205*        WHEN SQLCODE  NOT = +0                                   05020500
050206*            MOVE '7450-LOOKUP-DEPT' TO PV-ABEND-PARAGRAPH        05020600
050207*            MOVE 'SELECT DEPT'      TO PV-ABEND-OPERATION        05020700
050208*            PERFORM 9900-DB2-ABEND                               05020800
050209*    END-EVALUATE.                                                05020900
050210                                                                  05021000
050211 7700-UPDATE-TCEPLIT.                                             05021100
050212                                                                  05021200
050213     PERFORM                                                      05021300
050214         WITH TEST AFTER                                          05021400
050215         VARYING PV-RETRY-COUNT                                   05021500
050216         FROM 1 BY 1                                              05021600
050217         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 05021700
050218            OR  (SQLCODE = +0))                                   05021800
050219                                                                  05021900
050220         EXEC SQL                                                 05022000
050230             UPDATE TCEPLIT                                       05023000
050240                SET DWNLD_RDM_STAT_CDE = :PV-STAT-CDE             05024000
050250             WHERE                                                05025000
050260                 CNSTK_REQ_PL_NBR = :CEPLIT-CNSTK-REQ-PL-NBR      05026000
050270             AND PL_LNE_NBR       = :CEPLIT-PL-LNE-NBR            05027000
050280         END-EXEC                                                 05028000
050290                                                                  05029000
050300         EVALUATE TRUE                                            05030000
050400             WHEN SQLCODE = +0                                    05040000
050500             WHEN SQLCODE = -904                                  05050000
050600             WHEN SQLCODE = -911                                  05060000
050700             WHEN SQLCODE = -913                                  05070000
050800                  CONTINUE                                        05080000
050900             WHEN SQLWARN0 NOT = SPACE                            05090000
051000             WHEN SQLCODE  NOT = +0                               05100000
051100                  MOVE '7700-UPDATE-TCEPLIT'                      05110000
051200                                 TO PV-ABEND-PARAGRAPH            05120000
051300                  MOVE 'UPDATE DWNLD_RDM_STAT_CDE'                05130000
051400                                 TO PV-ABEND-OPERATION            05140000
051500                  MOVE 'TCEPLIT' TO PV-ABEND-STRUCTURE-1          05150000
051600                  MOVE SPACES    TO PV-ABEND-STRUCTURE-2          05160000
051700                  PERFORM 9900-DB2-ABEND                          05170000
051800         END-EVALUATE                                             05180000
051900     END-PERFORM.                                                 05190000
052000                                                                  05200000
052100     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          05210000
052200                AND SQLCODE NOT = ZERO                            05220000
052300         MOVE '7700-UPDATE-TCEPLIT'                               05230000
052400                                 TO PV-ABEND-PARAGRAPH            05240000
052500         MOVE 'MAX RETRIES EXCEEDED'                              05250000
052600                                 TO PV-ABEND-OPERATION            05260000
052700         PERFORM 9900-DB2-ABEND                                   05270000
052800     END-IF.                                                      05280000
052900                                                                  05290000
053000 8000-OPEN-STOCK-ORDER-CURSOR.                                    05300000
053100     PERFORM                                                      05310000
053200         WITH TEST AFTER                                          05320000
053300         VARYING PV-RETRY-COUNT                                   05330000
053400         FROM 1 BY 1                                              05340000
053500         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 05350000
053600            OR  (SQLCODE = +0))                                   05360000
053700                                                                  05370000
053800         EXEC SQL                                                 05380000
053900             OPEN STOCK-ORDER-CSR                                 05390000
054000         END-EXEC                                                 05400000
054100                                                                  05410000
054200         EVALUATE TRUE                                            05420000
054300             WHEN SQLCODE = +0                                    05430000
054400             WHEN SQLCODE = -904                                  05440000
054500             WHEN SQLCODE = -911                                  05450000
054600             WHEN SQLCODE = -913                                  05460000
054700                  CONTINUE                                        05470000
054800             WHEN SQLWARN0 NOT = SPACE                            05480000
054900             WHEN SQLCODE  NOT = +0                               05490000
055000                  MOVE '8000-OPEN-STOCK-ORDER-CURSOR'             05500000
055100                                 TO PV-ABEND-PARAGRAPH            05510000
055200                  MOVE 'OPEN STOCK-ORDER'                         05520000
055300                                 TO PV-ABEND-OPERATION            05530000
055400                  MOVE 'TCEPLIT' TO PV-ABEND-STRUCTURE-1          05540000
055500                  MOVE 'TCEPLRQ' TO PV-ABEND-STRUCTURE-2          05550000
055600                  PERFORM 9900-DB2-ABEND                          05560000
055700         END-EVALUATE                                             05570000
055800     END-PERFORM.                                                 05580000
055900                                                                  05590000
056000     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          05600000
056100         MOVE '8000-OPEN-STOCK-ORDER-CURSOR'                      05610000
056200                                 TO PV-ABEND-PARAGRAPH            05620000
056300         MOVE 'MAX RETRIES EXCEEDED'                              05630000
056400                                 TO PV-ABEND-OPERATION            05640000
056500         PERFORM 9900-DB2-ABEND                                   05650000
056600     END-IF.                                                      05660000
056700                                                                  05670000
056800 8100-FETCH-STOCK-ORDER-CURSOR.                                   05680000
056900                                                                  05690000
057000     INITIALIZE DCLTCEPLDS.                                       05700000
057100     EXEC SQL                                                     05710000
057200          FETCH STOCK-ORDER-CSR                                   05720000
057300           INTO   :CEPLDS-REQ-ORD-QTY                             05730000
057400                 ,:CEPLDS-STR-NBR                                 05740000
057500     END-EXEC.                                                    05750000
057600                                                                  05760000
057700     EVALUATE TRUE                                                05770000
057800         WHEN SQLCODE = +0                                        05780000
057900              CONTINUE                                            05790000
058000         WHEN SQLCODE = +100                                      05800000
058100              SET PS-END-STOCK-ORDER TO TRUE                      05810000
058200         WHEN SQLWARN0 NOT = SPACE                                05820000
058300         WHEN SQLCODE  NOT = +0                                   05830000
058400              MOVE '8100-FETCH-STOCK-ORDER-CURSOR'                05840000
058500                                   TO PV-ABEND-PARAGRAPH          05850000
058600              MOVE 'FETCH STOCK-ORDER CURSOR'                     05860000
058700                                   TO PV-ABEND-OPERATION          05870000
058800              MOVE 'TCEPLDS'       TO PV-ABEND-STRUCTURE-1        05880000
058900              PERFORM 9900-DB2-ABEND                              05890000
059000     END-EVALUATE.                                                05900000
059100     IF PS-END-STOCK-ORDER                                        05910000
059200        CONTINUE                                                  05920000
059300     ELSE                                                         05930000
059400        INITIALIZE CE021-SODTL-DOWNLOAD-REC                       05940000
059500        PERFORM 8300-PROCESS-STOCK-ORDER                          05950000
059600     END-IF.                                                      05960000
059700                                                                  05970000
059800 8200-CLOSE-STOCK-ORDER-CURSOR.                                   05980000
059900                                                                  05990000
060000     PERFORM                                                      06000000
060100         WITH TEST AFTER                                          06010000
060200         VARYING PV-RETRY-COUNT                                   06020000
060300         FROM 1 BY 1                                              06030000
060400         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 06040000
060500            OR  (SQLCODE = +0))                                   06050000
060600                                                                  06060000
060700            EXEC SQL                                              06070000
060800                CLOSE STOCK-ORDER-CSR                             06080000
060900            END-EXEC                                              06090000
061000                                                                  06100000
061100            EVALUATE TRUE                                         06110000
061200                WHEN SQLCODE = 0                                  06120000
061300                    CONTINUE                                      06130000
061400                WHEN SQLCODE = -911                               06140000
061500                WHEN SQLCODE = -913                               06150000
061600                WHEN SQLCODE = -904                               06160000
061700                    CONTINUE                                      06170000
061800                WHEN SQLCODE  NOT = +0                            06180000
061900                     MOVE '8200-CLOSE-STOCK-ORDER-CURSOR'         06190000
062000                                  TO PV-ABEND-PARAGRAPH           06200000
062100                     MOVE 'CLOSE STOCK-ORDER'                     06210000
062200                                  TO PV-ABEND-OPERATION           06220000
062300                     MOVE 'TCEPLDS'   TO PV-ABEND-STRUCTURE-1     06230000
062400                     PERFORM 9900-DB2-ABEND                       06240000
062500            END-EVALUATE                                          06250000
062600                                                                  06260000
062700     END-PERFORM.                                                 06270000
062800                                                                  06280000
062900     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          06290000
063000         MOVE '8200-CLOSE-STOCK-ORDER-CURSOR'                     06300000
063100                                 TO PV-ABEND-PARAGRAPH            06310000
063200         MOVE 'MAX RETRIES EXCEEDED'                              06320000
063300                                 TO PV-ABEND-OPERATION            06330000
063400         PERFORM 9900-DB2-ABEND                                   06340000
063500     END-IF.                                                      06350000
063600                                                                  06360000
063700 8300-PROCESS-STOCK-ORDER.                                        06370000
063800**CHANGED LOCATION SOURCE (WR38216)                               06380000
063900                                                                  06390000
064000     EVALUATE TRUE                                                06400000
064100     WHEN CEPLIT-STAT-CDE = 'CA'                                  06410000
064200         CONTINUE                                                 06420000
064300     WHEN CEPLIT-STAT-CDE = 'NW' OR 'IP'                          06430000
064400         MOVE 'A'                  TO CE021-ACTION-TYPE           06440000
064500******   MOVE CEPLRQ-CNSTK-LOC-ID  TO CE021-LOCATION              06450000
064600         MOVE PV-USED-LOC-ID       TO CE021-LOCATION              06460000
064700         MOVE PV-REFORMAT-TMST     TO CE021-TRANS-DATE-TIME       06470000
064800         MOVE CEPLDS-REQ-ORD-QTY   TO CE021-RQST-UNIT-QTY         06480000
064900         MOVE CEPLDS-STR-NBR       TO CE021-DEST-ID               06490000
065000         MOVE CEPLIT-CNSTK-REQ-PL-NBR TO PV-CNSTK-REQ-PL-NBR      06500000
065100         MOVE CEPLIT-PL-LNE-NBR       TO PV-CEPLIT-PL-LNE-NBR     06510000
065200         IF  XL071-E-BUS-IND = 'Y'                                06520000
065300             IF  XL071-LOC-TYP-CDE = 'DS'                         06530000
065400             OR  XL071-LOC-TYP-CDE = 'CS'                         06540000
065500                 MOVE PV-CNSTK-REQ-PL-NBR(5:5)                    06550000
065600                                       TO CE021-DISTRO-NUMBER(2:5)06560000
065700                 MOVE PV-CEPLIT-PL-LNE-NBR(2:3)                   06570000
065800                                       TO CE021-DISTRO-NUMBER(7:3)06580000
065900                 IF  CEPLRQ-SRC-TYP-CDE = PC-XF                   06590000
066000                     MOVE PC-X         TO CE021-DISTRO-NUMBER(1:1)06600000
066100                 ELSE                                             06610000
066200                     MOVE PC-C         TO CE021-DISTRO-NUMBER(1:1)06620000
066300                 END-IF                                           06630000
066400             ELSE                                                 06640000
066500                 MOVE PV-CNSTK-REQ-PL-NBR(5:5)                    06650000
066600                                       TO CE021-DISTRO-NUMBER(1:5)06660000
066700                 MOVE PV-CEPLIT-PL-LNE-NBR                        06670000
066800                                       TO CE021-DISTRO-NUMBER(6:4)06680000
066900             END-IF                                               06690000
067000         ELSE                                                     06700000
067100             MOVE PV-CNSTK-REQ-PL-NBR(5:5)                        06710000
067200                                       TO CE021-DISTRO-NUMBER(1:5)06720000
067300             MOVE PV-CEPLIT-PL-LNE-NBR TO CE021-DISTRO-NUMBER(6:4)06730000
067400         END-IF                                                   06740000
067500                                                                  06750000
067600         MOVE SPACES               TO CE021-SKU-NBR               06760000
067700         MOVE XLT00003-SKU-NBR     TO CE021-SKU                   06770000
067800         MOVE CEPLIT-UNT-RTL-AMT   TO CE021-RETAIL-PRICE          06780000
067900         MOVE ZERO                 TO CE021-PRIORITY              06790000
068000         MOVE 'N'                  TO CE021-EXPEDITE-FLAG         06800000
068100         MOVE 'NONE'               TO CE021-TICKET-TYPE           06810000
068200         MOVE 'N'                  TO CE021-PRT-UPC-FLAG          06820000
068300         ADD 1                     TO PV-COUNT2                   06830000
068400                                      PV-DETAIL-COUNT             06840000
068500                                                                  06850000
068600         WRITE CE021-DOWNLOAD-RECORD FROM                         06860000
068700            CE021-SODTL-DOWNLOAD-REC                              06870000
068800     END-EVALUATE.                                                06880000
068900                                                                  06890000
069000 8500-GET-TIMESTAMP.                                              06900000
069100***************************************************************** 06910000
069200*  FORMAT EXAMPLE 2000-01-01-00.00.00.000000                      06920000
069300***************************************************************** 06930000
069400     EXEC SQL                                                     06940000
069500         SET :PV-TMST = CURRENT TIMESTAMP                         06950000
069600     END-EXEC.                                                    06960000
069700                                                                  06970000
069800     EVALUATE TRUE                                                06980000
069900         WHEN SQLCODE = +0                                        06990000
070000              CONTINUE                                            07000000
070100         WHEN SQLWARN0 NOT = SPACE                                07010000
070200         WHEN SQLCODE  NOT = +0                                   07020000
070300              MOVE '8500-GET-TIMESTAMP'                           07030000
070400                             TO PV-ABEND-PARAGRAPH                07040000
070500              MOVE 'GET TIMESTAMP'                                07050000
070600                             TO PV-ABEND-OPERATION                07060000
070700              MOVE 'TIMESTAMP' TO PV-ABEND-STRUCTURE-1            07070000
070800              MOVE SPACES      TO PV-ABEND-STRUCTURE-2            07080000
070900              PERFORM 9900-DB2-ABEND                              07090000
071000     END-EVALUATE.                                                07100000
071100                                                                  07110000
071200     IF SQLCODE = 0                                               07120000
071300        MOVE PV-TMST(1:4)     TO PV-REFORMAT-TMST-DTE-CY          07130000
071400        MOVE PV-TMST(6:2)     TO PV-REFORMAT-TMST-DTE-MM          07140000
071500        MOVE PV-TMST(9:2)     TO PV-REFORMAT-TMST-DTE-DD          07150000
071600        MOVE PV-TMST(12:2)    TO PV-REFORMAT-TMST-TM-HH           07160000
071700        MOVE PV-TMST(15:2)    TO PV-REFORMAT-TMST-TM-MM           07170000
071800     END-IF.                                                      07180000
071900                                                                  07190000
072000                                                                  07200000
072010 8600-GET-OFFSET-MINUTES.                                         07201002
072020                                                                  07202002
072023                                                                  07202302
072024     PERFORM                                                      07202402
072025         WITH TEST AFTER                                          07202502
072026         VARYING PV-RETRY-COUNT                                   07202602
072027         FROM 1 BY 1                                              07202702
072028         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 07202802
072029            OR  (SQLCODE = +0 OR SQLCODE = +100))                 07202902
072030                                                                  07203002
072031         EXEC SQL                                                 07203102
072032             SELECT FUNC_QTY                                      07203202
072033             INTO :PV-OFFSET-MINUTES                              07203302
072034             FROM TKRPRPM                                         07203402
072035         WHERE                                                    07203502
072036             LOC_ID = 90                                          07203602
072037         AND INTFC_SYS_CDE = 'KHL'                                07203702
072038         AND FUNC_PRC_STAT_CDE = 'AC'                             07203802
072040         AND SYS_PRC_FUNC_CDE = 'CEPLDY'                          07204002
072043         END-EXEC                                                 07204302
072044                                                                  07204402
072045         EVALUATE TRUE                                            07204502
072046             WHEN SQLCODE = +0                                    07204602
072047                 CONTINUE                                         07204702
072049             WHEN SQLCODE = +100                                  07204902
072050                 MOVE ZERO TO PV-OFFSET-MINUTES                   07205002
072052             WHEN SQLCODE = -904                                  07205202
072053             WHEN SQLCODE = -911                                  07205302
072054             WHEN SQLCODE = -913                                  07205402
072055                  CONTINUE                                        07205502
072056             WHEN SQLWARN0 NOT = SPACE                            07205602
072057             WHEN SQLCODE  NOT = +0                               07205702
072058                  MOVE '8600-GET-OFFSET-MINUTES'                  07205802
072059                                 TO PV-ABEND-PARAGRAPH            07205902
072060                  MOVE 'SELECT TKRPRPM - CEPLDY'                  07206002
072061                                 TO PV-ABEND-OPERATION            07206102
072062                  MOVE 'TKRPRPM'   TO PV-ABEND-STRUCTURE-1        07206202
072063                  PERFORM 9900-DB2-ABEND                          07206302
072064         END-EVALUATE                                             07206402
072065     END-PERFORM.                                                 07206502
072066                                                                  07206602
072067     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          07206702
072068            AND NOT (SQLCODE = +0 OR SQLCODE = +100)              07206802
072069         MOVE '8600-GET-OFFSET-MINUTES'                           07206902
072070                                 TO PV-ABEND-PARAGRAPH            07207002
072071         MOVE 'MAX RETRIES EXCEEDED'                              07207102
072072                                 TO PV-ABEND-OPERATION            07207202
072073         PERFORM 9900-DB2-ABEND                                   07207302
072074     END-IF.                                                      07207402
072075                                                                  07207502
072076                                                                  07207602
072080                                                                  07208002
072100 9000-TERMINATE.                                                  07210000
072200                                                                  07220000
072300     CLOSE CE009-DOWNLOAD-FILE.                                   07230000
072400     CLOSE CE021-DOWNLOAD-FILE.                                   07240000
072500                                                                  07250000
072600     DISPLAY '************************'.                          07260000
072700     DISPLAY '******* CEKUT017 *******'.                          07270000
072800     DISPLAY '************************'.                          07280000
072900     DISPLAY ' '                                                  07290000
073000     DISPLAY 'STOCK PULL DOWNLOAD COUNT = ' PV-COUNT1.            07300000
073100     DISPLAY 'STOCK ORDER DOWNLOAD COUNT = ' PV-COUNT2.           07310000
073200     DISPLAY ' '                                                  07320000
073300     DISPLAY '************************'.                          07330000
073400                                                                  07340000
073500 9900-DB2-ABEND.                                                  07350000
073600                                                                  07360000
073700     MOVE SQLCODE TO PV-SQLCODE.                                  07370000
073800     DISPLAY '*** DB2 ERROR '.                                    07380000
073900     DISPLAY '*** SQLCODE   = ' PV-SQLCODE.                       07390000
074000     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                 07400000
074100     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               07410000
074200     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               07420000
074300     DISPLAY '*** MESSAGE   = ' PV-DB2-OPERATION-MESSAGE-1.       07430000
074400     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-2.       07440000
074500     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-3.       07450000
074600     DISPLAY '*** TABLE 1   = ' PV-ABEND-STRUCTURE-1.             07460000
074700                                                                  07470000
074800     IF PV-ABEND-STRUCTURE-2 > SPACES                             07480000
074900         DISPLAY '*** TABLE 2   = ' PV-ABEND-STRUCTURE-2          07490000
075000     END-IF.                                                      07500000
075100                                                                  07510000
075200                                                                  07520000
075300     COPY DPPD004.                                                07530000
075400                                                                  07540000
075500     IF SQLCODE NOT = -911                                        07550000
075600         EXEC SQL                                                 07560000
075700              ROLLBACK                                            07570000
075800         END-EXEC                                                 07580000
075900     END-IF.                                                      07590000
076000                                                                  07600000
076100     MOVE +4013                  TO PV-ABEND-CODE.                07610000
076200     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         07620000
076300                                                                  07630000
076400 9200-ABEND.                                                      07640000
076500******************************************************************07650000
076600*  PERFORMS A NON-SQL ABEND FOR THE PROGRAM                       07660000
076700******************************************************************07670000
076800     DISPLAY '***************************'.                       07680000
076900     DISPLAY '**       ABEND           **'.                       07690000
077000     DISPLAY '**  IN PROGRAM CEKUT017  **'.                       07700000
077100     DISPLAY '***************************'.                       07710000
077200     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        07720000
077300     DISPLAY '**                 ** = ' PV-ERROR-MESSAGE-1.       07730000
077400     DISPLAY '**                 ** = ' PV-ERROR-MESSAGE-2.       07740000
077500     DISPLAY '**                 ** = ' PV-ERROR-MESSAGE-3.       07750000
077600                                                                  07760000
077700     MOVE +4014                  TO PV-ABEND-CODE.                07770000
077800     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         07780000
077900*                                                                 07790000
